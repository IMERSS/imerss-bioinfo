!function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery"],factory):factory(jQuery)}((function($){"use strict";return $.ui=$.ui||{},$.ui.version="1.13.0"})),
/*!
 * jQuery UI Keycode 1.13.0
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery","./version"],factory):factory(jQuery)}((function($){"use strict";return $.ui.keyCode={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}})),function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery","./version"],factory):factory(jQuery)}((function($){"use strict";return $.ui.safeActiveElement=function(document){var activeElement;try{activeElement=document.activeElement}catch(error){activeElement=document.body}return activeElement||(activeElement=document.body),activeElement.nodeName||(activeElement=document.body),activeElement}})),
/*!
 * jQuery UI Widget 1.13.2
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery","./version"],factory):factory(jQuery)}((function($){"use strict";var orig,widgetUuid=0,widgetHasOwnProperty=Array.prototype.hasOwnProperty,widgetSlice=Array.prototype.slice;return $.cleanData=(orig=$.cleanData,function(elems){var events,elem,i;for(i=0;null!=(elem=elems[i]);i++)(events=$._data(elem,"events"))&&events.remove&&$(elem).triggerHandler("remove");orig(elems)}),$.widget=function(name,base,prototype){var existingConstructor,constructor,basePrototype,proxiedPrototype={},namespace=name.split(".")[0],fullName=namespace+"-"+(name=name.split(".")[1]);return prototype||(prototype=base,base=$.Widget),Array.isArray(prototype)&&(prototype=$.extend.apply(null,[{}].concat(prototype))),$.expr.pseudos[fullName.toLowerCase()]=function(elem){return!!$.data(elem,fullName)},$[namespace]=$[namespace]||{},existingConstructor=$[namespace][name],constructor=$[namespace][name]=function(options,element){if(!this||!this._createWidget)return new constructor(options,element);arguments.length&&this._createWidget(options,element)},$.extend(constructor,existingConstructor,{version:prototype.version,_proto:$.extend({},prototype),_childConstructors:[]}),(basePrototype=new base).options=$.widget.extend({},basePrototype.options),$.each(prototype,(function(prop,value){proxiedPrototype[prop]="function"==typeof value?function(){function _super(){return base.prototype[prop].apply(this,arguments)}function _superApply(args){return base.prototype[prop].apply(this,args)}return function(){var returnValue,__super=this._super,__superApply=this._superApply;return this._super=_super,this._superApply=_superApply,returnValue=value.apply(this,arguments),this._super=__super,this._superApply=__superApply,returnValue}}():value})),constructor.prototype=$.widget.extend(basePrototype,{widgetEventPrefix:existingConstructor&&basePrototype.widgetEventPrefix||name},proxiedPrototype,{constructor:constructor,namespace:namespace,widgetName:name,widgetFullName:fullName}),existingConstructor?($.each(existingConstructor._childConstructors,(function(i,child){var childPrototype=child.prototype;$.widget(childPrototype.namespace+"."+childPrototype.widgetName,constructor,child._proto)})),delete existingConstructor._childConstructors):base._childConstructors.push(constructor),$.widget.bridge(name,constructor),constructor},$.widget.extend=function(target){for(var key,value,input=widgetSlice.call(arguments,1),inputIndex=0,inputLength=input.length;inputIndex<inputLength;inputIndex++)for(key in input[inputIndex])value=input[inputIndex][key],widgetHasOwnProperty.call(input[inputIndex],key)&&void 0!==value&&($.isPlainObject(value)?target[key]=$.isPlainObject(target[key])?$.widget.extend({},target[key],value):$.widget.extend({},value):target[key]=value);return target},$.widget.bridge=function(name,object){var fullName=object.prototype.widgetFullName||name;$.fn[name]=function(options){var isMethodCall="string"==typeof options,args=widgetSlice.call(arguments,1),returnValue=this;return isMethodCall?this.length||"instance"!==options?this.each((function(){var methodValue,instance=$.data(this,fullName);return"instance"===options?(returnValue=instance,!1):instance?"function"!=typeof instance[options]||"_"===options.charAt(0)?$.error("no such method '"+options+"' for "+name+" widget instance"):(methodValue=instance[options].apply(instance,args))!==instance&&void 0!==methodValue?(returnValue=methodValue&&methodValue.jquery?returnValue.pushStack(methodValue.get()):methodValue,!1):void 0:$.error("cannot call methods on "+name+" prior to initialization; attempted to call method '"+options+"'")})):returnValue=void 0:(args.length&&(options=$.widget.extend.apply(null,[options].concat(args))),this.each((function(){var instance=$.data(this,fullName);instance?(instance.option(options||{}),instance._init&&instance._init()):$.data(this,fullName,new object(options,this))}))),returnValue}},$.Widget=function(){},$.Widget._childConstructors=[],$.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{classes:{},disabled:!1,create:null},_createWidget:function(options,element){element=$(element||this.defaultElement||this)[0],this.element=$(element),this.uuid=widgetUuid++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=$(),this.hoverable=$(),this.focusable=$(),this.classesElementLookup={},element!==this&&($.data(element,this.widgetFullName,this),this._on(!0,this.element,{remove:function(event){event.target===element&&this.destroy()}}),this.document=$(element.style?element.ownerDocument:element.document||element),this.window=$(this.document[0].defaultView||this.document[0].parentWindow)),this.options=$.widget.extend({},this.options,this._getCreateOptions(),options),this._create(),this.options.disabled&&this._setOptionDisabled(this.options.disabled),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:function(){return{}},_getCreateEventData:$.noop,_create:$.noop,_init:$.noop,destroy:function(){var that=this;this._destroy(),$.each(this.classesElementLookup,(function(key,value){that._removeClass(value,key)})),this.element.off(this.eventNamespace).removeData(this.widgetFullName),this.widget().off(this.eventNamespace).removeAttr("aria-disabled"),this.bindings.off(this.eventNamespace)},_destroy:$.noop,widget:function(){return this.element},option:function(key,value){var parts,curOption,i,options=key;if(0===arguments.length)return $.widget.extend({},this.options);if("string"==typeof key)if(options={},parts=key.split("."),key=parts.shift(),parts.length){for(curOption=options[key]=$.widget.extend({},this.options[key]),i=0;i<parts.length-1;i++)curOption[parts[i]]=curOption[parts[i]]||{},curOption=curOption[parts[i]];if(key=parts.pop(),1===arguments.length)return void 0===curOption[key]?null:curOption[key];curOption[key]=value}else{if(1===arguments.length)return void 0===this.options[key]?null:this.options[key];options[key]=value}return this._setOptions(options),this},_setOptions:function(options){var key;for(key in options)this._setOption(key,options[key]);return this},_setOption:function(key,value){return"classes"===key&&this._setOptionClasses(value),this.options[key]=value,"disabled"===key&&this._setOptionDisabled(value),this},_setOptionClasses:function(value){var classKey,elements,currentElements;for(classKey in value)currentElements=this.classesElementLookup[classKey],value[classKey]!==this.options.classes[classKey]&&currentElements&&currentElements.length&&(elements=$(currentElements.get()),this._removeClass(currentElements,classKey),elements.addClass(this._classes({element:elements,keys:classKey,classes:value,add:!0})))},_setOptionDisabled:function(value){this._toggleClass(this.widget(),this.widgetFullName+"-disabled",null,!!value),value&&(this._removeClass(this.hoverable,null,"ui-state-hover"),this._removeClass(this.focusable,null,"ui-state-focus"))},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_classes:function(options){var full=[],that=this;function bindRemoveEvent(){var nodesToBind=[];options.element.each((function(_,element){$.map(that.classesElementLookup,(function(elements){return elements})).some((function(elements){return elements.is(element)}))||nodesToBind.push(element)})),that._on($(nodesToBind),{remove:"_untrackClassesElement"})}function processClassString(classes,checkOption){var current,i;for(i=0;i<classes.length;i++)current=that.classesElementLookup[classes[i]]||$(),options.add?(bindRemoveEvent(),current=$($.uniqueSort(current.get().concat(options.element.get())))):current=$(current.not(options.element).get()),that.classesElementLookup[classes[i]]=current,full.push(classes[i]),checkOption&&options.classes[classes[i]]&&full.push(options.classes[classes[i]])}return(options=$.extend({element:this.element,classes:this.options.classes||{}},options)).keys&&processClassString(options.keys.match(/\S+/g)||[],!0),options.extra&&processClassString(options.extra.match(/\S+/g)||[]),full.join(" ")},_untrackClassesElement:function(event){var that=this;$.each(that.classesElementLookup,(function(key,value){-1!==$.inArray(event.target,value)&&(that.classesElementLookup[key]=$(value.not(event.target).get()))})),this._off($(event.target))},_removeClass:function(element,keys,extra){return this._toggleClass(element,keys,extra,!1)},_addClass:function(element,keys,extra){return this._toggleClass(element,keys,extra,!0)},_toggleClass:function(element,keys,extra,add){add="boolean"==typeof add?add:extra;var shift="string"==typeof element||null===element,options={extra:shift?keys:extra,keys:shift?element:keys,element:shift?this.element:element,add:add};return options.element.toggleClass(this._classes(options),add),this},_on:function(suppressDisabledCheck,element,handlers){var delegateElement,instance=this;"boolean"!=typeof suppressDisabledCheck&&(handlers=element,element=suppressDisabledCheck,suppressDisabledCheck=!1),handlers?(element=delegateElement=$(element),this.bindings=this.bindings.add(element)):(handlers=element,element=this.element,delegateElement=this.widget()),$.each(handlers,(function(event,handler){function handlerProxy(){if(suppressDisabledCheck||!0!==instance.options.disabled&&!$(this).hasClass("ui-state-disabled"))return("string"==typeof handler?instance[handler]:handler).apply(instance,arguments)}"string"!=typeof handler&&(handlerProxy.guid=handler.guid=handler.guid||handlerProxy.guid||$.guid++);var match=event.match(/^([\w:-]*)\s*(.*)$/),eventName=match[1]+instance.eventNamespace,selector=match[2];selector?delegateElement.on(eventName,selector,handlerProxy):element.on(eventName,handlerProxy)}))},_off:function(element,eventName){eventName=(eventName||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,element.off(eventName),this.bindings=$(this.bindings.not(element).get()),this.focusable=$(this.focusable.not(element).get()),this.hoverable=$(this.hoverable.not(element).get())},_delay:function(handler,delay){var instance=this;return setTimeout((function(){return("string"==typeof handler?instance[handler]:handler).apply(instance,arguments)}),delay||0)},_hoverable:function(element){this.hoverable=this.hoverable.add(element),this._on(element,{mouseenter:function(event){this._addClass($(event.currentTarget),null,"ui-state-hover")},mouseleave:function(event){this._removeClass($(event.currentTarget),null,"ui-state-hover")}})},_focusable:function(element){this.focusable=this.focusable.add(element),this._on(element,{focusin:function(event){this._addClass($(event.currentTarget),null,"ui-state-focus")},focusout:function(event){this._removeClass($(event.currentTarget),null,"ui-state-focus")}})},_trigger:function(type,event,data){var prop,orig,callback=this.options[type];if(data=data||{},(event=$.Event(event)).type=(type===this.widgetEventPrefix?type:this.widgetEventPrefix+type).toLowerCase(),event.target=this.element[0],orig=event.originalEvent)for(prop in orig)prop in event||(event[prop]=orig[prop]);return this.element.trigger(event,data),!("function"==typeof callback&&!1===callback.apply(this.element[0],[event].concat(data))||event.isDefaultPrevented())}},$.each({show:"fadeIn",hide:"fadeOut"},(function(method,defaultEffect){$.Widget.prototype["_"+method]=function(element,options,callback){var hasOptions;"string"==typeof options&&(options={effect:options});var effectName=options?!0===options||"number"==typeof options?defaultEffect:options.effect||defaultEffect:method;"number"==typeof(options=options||{})?options={duration:options}:!0===options&&(options={}),hasOptions=!$.isEmptyObject(options),options.complete=callback,options.delay&&element.delay(options.delay),hasOptions&&$.effects&&$.effects.effect[effectName]?element[method](options):effectName!==method&&element[effectName]?element[effectName](options.duration,options.easing,callback):element.queue((function(next){$(this)[method](),callback&&callback.call(element[0]),next()}))}})),$.widget})),
/*!
 * jQuery UI Unique ID 1.13.2
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery","./version"],factory):factory(jQuery)}((function($){"use strict";return $.fn.extend({uniqueId:(uuid=0,function(){return this.each((function(){this.id||(this.id="ui-id-"+ ++uuid)}))}),removeUniqueId:function(){return this.each((function(){/^ui-id-\d+$/.test(this.id)&&$(this).removeAttr("id")}))}});var uuid})),
/*!
 * jQuery UI Position 1.13.2
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/position/
 */
function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery","./version"],factory):factory(jQuery)}((function($){"use strict";return function(){var cachedScrollbarWidth,max=Math.max,abs=Math.abs,rhorizontal=/left|center|right/,rvertical=/top|center|bottom/,roffset=/[\+\-]\d+(\.[\d]+)?%?/,rposition=/^\w+/,rpercent=/%$/,_position=$.fn.position;function getOffsets(offsets,width,height){return[parseFloat(offsets[0])*(rpercent.test(offsets[0])?width/100:1),parseFloat(offsets[1])*(rpercent.test(offsets[1])?height/100:1)]}function parseCss(element,property){return parseInt($.css(element,property),10)||0}function isWindow(obj){return null!=obj&&obj===obj.window}$.position={scrollbarWidth:function(){if(void 0!==cachedScrollbarWidth)return cachedScrollbarWidth;var w1,w2,div=$("<div style='display:block;position:absolute;width:200px;height:200px;overflow:hidden;'><div style='height:300px;width:auto;'></div></div>"),innerDiv=div.children()[0];return $("body").append(div),w1=innerDiv.offsetWidth,div.css("overflow","scroll"),w1===(w2=innerDiv.offsetWidth)&&(w2=div[0].clientWidth),div.remove(),cachedScrollbarWidth=w1-w2},getScrollInfo:function(within){var overflowX=within.isWindow||within.isDocument?"":within.element.css("overflow-x"),overflowY=within.isWindow||within.isDocument?"":within.element.css("overflow-y"),hasOverflowX="scroll"===overflowX||"auto"===overflowX&&within.width<within.element[0].scrollWidth;return{width:"scroll"===overflowY||"auto"===overflowY&&within.height<within.element[0].scrollHeight?$.position.scrollbarWidth():0,height:hasOverflowX?$.position.scrollbarWidth():0}},getWithinInfo:function(element){var withinElement=$(element||window),isElemWindow=isWindow(withinElement[0]),isDocument=!!withinElement[0]&&9===withinElement[0].nodeType;return{element:withinElement,isWindow:isElemWindow,isDocument:isDocument,offset:!isElemWindow&&!isDocument?$(element).offset():{left:0,top:0},scrollLeft:withinElement.scrollLeft(),scrollTop:withinElement.scrollTop(),width:withinElement.outerWidth(),height:withinElement.outerHeight()}}},$.fn.position=function(options){if(!options||!options.of)return _position.apply(this,arguments);var atOffset,targetWidth,targetHeight,targetOffset,basePosition,dimensions,elem,raw,target="string"==typeof(options=$.extend({},options)).of?$(document).find(options.of):$(options.of),within=$.position.getWithinInfo(options.within),scrollInfo=$.position.getScrollInfo(within),collision=(options.collision||"flip").split(" "),offsets={};return dimensions=9===(raw=(elem=target)[0]).nodeType?{width:elem.width(),height:elem.height(),offset:{top:0,left:0}}:isWindow(raw)?{width:elem.width(),height:elem.height(),offset:{top:elem.scrollTop(),left:elem.scrollLeft()}}:raw.preventDefault?{width:0,height:0,offset:{top:raw.pageY,left:raw.pageX}}:{width:elem.outerWidth(),height:elem.outerHeight(),offset:elem.offset()},target[0].preventDefault&&(options.at="left top"),targetWidth=dimensions.width,targetHeight=dimensions.height,targetOffset=dimensions.offset,basePosition=$.extend({},targetOffset),$.each(["my","at"],(function(){var horizontalOffset,verticalOffset,pos=(options[this]||"").split(" ");1===pos.length&&(pos=rhorizontal.test(pos[0])?pos.concat(["center"]):rvertical.test(pos[0])?["center"].concat(pos):["center","center"]),pos[0]=rhorizontal.test(pos[0])?pos[0]:"center",pos[1]=rvertical.test(pos[1])?pos[1]:"center",horizontalOffset=roffset.exec(pos[0]),verticalOffset=roffset.exec(pos[1]),offsets[this]=[horizontalOffset?horizontalOffset[0]:0,verticalOffset?verticalOffset[0]:0],options[this]=[rposition.exec(pos[0])[0],rposition.exec(pos[1])[0]]})),1===collision.length&&(collision[1]=collision[0]),"right"===options.at[0]?basePosition.left+=targetWidth:"center"===options.at[0]&&(basePosition.left+=targetWidth/2),"bottom"===options.at[1]?basePosition.top+=targetHeight:"center"===options.at[1]&&(basePosition.top+=targetHeight/2),atOffset=getOffsets(offsets.at,targetWidth,targetHeight),basePosition.left+=atOffset[0],basePosition.top+=atOffset[1],this.each((function(){var collisionPosition,using,elem=$(this),elemWidth=elem.outerWidth(),elemHeight=elem.outerHeight(),marginLeft=parseCss(this,"marginLeft"),marginTop=parseCss(this,"marginTop"),collisionWidth=elemWidth+marginLeft+parseCss(this,"marginRight")+scrollInfo.width,collisionHeight=elemHeight+marginTop+parseCss(this,"marginBottom")+scrollInfo.height,position=$.extend({},basePosition),myOffset=getOffsets(offsets.my,elem.outerWidth(),elem.outerHeight());"right"===options.my[0]?position.left-=elemWidth:"center"===options.my[0]&&(position.left-=elemWidth/2),"bottom"===options.my[1]?position.top-=elemHeight:"center"===options.my[1]&&(position.top-=elemHeight/2),position.left+=myOffset[0],position.top+=myOffset[1],collisionPosition={marginLeft:marginLeft,marginTop:marginTop},$.each(["left","top"],(function(i,dir){$.ui.position[collision[i]]&&$.ui.position[collision[i]][dir](position,{targetWidth:targetWidth,targetHeight:targetHeight,elemWidth:elemWidth,elemHeight:elemHeight,collisionPosition:collisionPosition,collisionWidth:collisionWidth,collisionHeight:collisionHeight,offset:[atOffset[0]+myOffset[0],atOffset[1]+myOffset[1]],my:options.my,at:options.at,within:within,elem:elem})})),options.using&&(using=function(props){var left=targetOffset.left-position.left,right=left+targetWidth-elemWidth,top=targetOffset.top-position.top,bottom=top+targetHeight-elemHeight,feedback={target:{element:target,left:targetOffset.left,top:targetOffset.top,width:targetWidth,height:targetHeight},element:{element:elem,left:position.left,top:position.top,width:elemWidth,height:elemHeight},horizontal:right<0?"left":left>0?"right":"center",vertical:bottom<0?"top":top>0?"bottom":"middle"};targetWidth<elemWidth&&abs(left+right)<targetWidth&&(feedback.horizontal="center"),targetHeight<elemHeight&&abs(top+bottom)<targetHeight&&(feedback.vertical="middle"),max(abs(left),abs(right))>max(abs(top),abs(bottom))?feedback.important="horizontal":feedback.important="vertical",options.using.call(this,props,feedback)}),elem.offset($.extend(position,{using:using}))}))},$.ui.position={fit:{left:function(position,data){var newOverRight,within=data.within,withinOffset=within.isWindow?within.scrollLeft:within.offset.left,outerWidth=within.width,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=withinOffset-collisionPosLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-withinOffset;data.collisionWidth>outerWidth?overLeft>0&&overRight<=0?(newOverRight=position.left+overLeft+data.collisionWidth-outerWidth-withinOffset,position.left+=overLeft-newOverRight):position.left=overRight>0&&overLeft<=0?withinOffset:overLeft>overRight?withinOffset+outerWidth-data.collisionWidth:withinOffset:overLeft>0?position.left+=overLeft:overRight>0?position.left-=overRight:position.left=max(position.left-collisionPosLeft,position.left)},top:function(position,data){var newOverBottom,within=data.within,withinOffset=within.isWindow?within.scrollTop:within.offset.top,outerHeight=data.within.height,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=withinOffset-collisionPosTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-withinOffset;data.collisionHeight>outerHeight?overTop>0&&overBottom<=0?(newOverBottom=position.top+overTop+data.collisionHeight-outerHeight-withinOffset,position.top+=overTop-newOverBottom):position.top=overBottom>0&&overTop<=0?withinOffset:overTop>overBottom?withinOffset+outerHeight-data.collisionHeight:withinOffset:overTop>0?position.top+=overTop:overBottom>0?position.top-=overBottom:position.top=max(position.top-collisionPosTop,position.top)}},flip:{left:function(position,data){var newOverRight,newOverLeft,within=data.within,withinOffset=within.offset.left+within.scrollLeft,outerWidth=within.width,offsetLeft=within.isWindow?within.scrollLeft:within.offset.left,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=collisionPosLeft-offsetLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-offsetLeft,myOffset="left"===data.my[0]?-data.elemWidth:"right"===data.my[0]?data.elemWidth:0,atOffset="left"===data.at[0]?data.targetWidth:"right"===data.at[0]?-data.targetWidth:0,offset=-2*data.offset[0];overLeft<0?((newOverRight=position.left+myOffset+atOffset+offset+data.collisionWidth-outerWidth-withinOffset)<0||newOverRight<abs(overLeft))&&(position.left+=myOffset+atOffset+offset):overRight>0&&((newOverLeft=position.left-data.collisionPosition.marginLeft+myOffset+atOffset+offset-offsetLeft)>0||abs(newOverLeft)<overRight)&&(position.left+=myOffset+atOffset+offset)},top:function(position,data){var newOverTop,newOverBottom,within=data.within,withinOffset=within.offset.top+within.scrollTop,outerHeight=within.height,offsetTop=within.isWindow?within.scrollTop:within.offset.top,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=collisionPosTop-offsetTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-offsetTop,myOffset="top"===data.my[1]?-data.elemHeight:"bottom"===data.my[1]?data.elemHeight:0,atOffset="top"===data.at[1]?data.targetHeight:"bottom"===data.at[1]?-data.targetHeight:0,offset=-2*data.offset[1];overTop<0?((newOverBottom=position.top+myOffset+atOffset+offset+data.collisionHeight-outerHeight-withinOffset)<0||newOverBottom<abs(overTop))&&(position.top+=myOffset+atOffset+offset):overBottom>0&&((newOverTop=position.top-data.collisionPosition.marginTop+myOffset+atOffset+offset-offsetTop)>0||abs(newOverTop)<overBottom)&&(position.top+=myOffset+atOffset+offset)}},flipfit:{left:function(){$.ui.position.flip.left.apply(this,arguments),$.ui.position.fit.left.apply(this,arguments)},top:function(){$.ui.position.flip.top.apply(this,arguments),$.ui.position.fit.top.apply(this,arguments)}}}}(),$.ui.position})),
/*!
 * jQuery UI Tooltip 1.13.2
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery","../keycode","../position","../unique-id","../version","../widget"],factory):factory(jQuery)}((function($){"use strict";return $.widget("ui.tooltip",{version:"1.13.2",options:{classes:{"ui-tooltip":"ui-corner-all ui-widget-shadow"},content:function(){var title=$(this).attr("title");return $("<a>").text(title).html()},hide:!0,items:"[title]:not([disabled])",position:{my:"left top+15",at:"left bottom",collision:"flipfit flip"},show:!0,track:!1,close:null,open:null},_addDescribedBy:function(elem,id){var describedby=(elem.attr("aria-describedby")||"").split(/\s+/);describedby.push(id),elem.data("ui-tooltip-id",id).attr("aria-describedby",String.prototype.trim.call(describedby.join(" ")))},_removeDescribedBy:function(elem){var id=elem.data("ui-tooltip-id"),describedby=(elem.attr("aria-describedby")||"").split(/\s+/),index=$.inArray(id,describedby);-1!==index&&describedby.splice(index,1),elem.removeData("ui-tooltip-id"),(describedby=String.prototype.trim.call(describedby.join(" ")))?elem.attr("aria-describedby",describedby):elem.removeAttr("aria-describedby")},_create:function(){this._on({mouseover:"open",focusin:"open"}),this.tooltips={},this.parents={},this.liveRegion=$("<div>").attr({role:"log","aria-live":"assertive","aria-relevant":"additions"}).appendTo(this.document[0].body),this._addClass(this.liveRegion,null,"ui-helper-hidden-accessible"),this.disabledTitles=$([])},_setOption:function(key,value){var that=this;this._super(key,value),"content"===key&&$.each(this.tooltips,(function(id,tooltipData){that._updateContent(tooltipData.element)}))},_setOptionDisabled:function(value){this[value?"_disable":"_enable"]()},_disable:function(){var that=this;$.each(this.tooltips,(function(id,tooltipData){var event=$.Event("blur");event.target=event.currentTarget=tooltipData.element[0],that.close(event,!0)})),this.disabledTitles=this.disabledTitles.add(this.element.find(this.options.items).addBack().filter((function(){var element=$(this);if(element.is("[title]"))return element.data("ui-tooltip-title",element.attr("title")).removeAttr("title")})))},_enable:function(){this.disabledTitles.each((function(){var element=$(this);element.data("ui-tooltip-title")&&element.attr("title",element.data("ui-tooltip-title"))})),this.disabledTitles=$([])},open:function(event){var that=this,target=$(event?event.target:this.element).closest(this.options.items);target.length&&!target.data("ui-tooltip-id")&&(target.attr("title")&&target.data("ui-tooltip-title",target.attr("title")),target.data("ui-tooltip-open",!0),event&&"mouseover"===event.type&&target.parents().each((function(){var blurEvent,parent=$(this);parent.data("ui-tooltip-open")&&((blurEvent=$.Event("blur")).target=blurEvent.currentTarget=this,that.close(blurEvent,!0)),parent.attr("title")&&(parent.uniqueId(),that.parents[this.id]={element:this,title:parent.attr("title")},parent.attr("title",""))})),this._registerCloseHandlers(event,target),this._updateContent(target,event))},_updateContent:function(target,event){var content,contentOption=this.options.content,that=this,eventType=event?event.type:null;if("string"==typeof contentOption||contentOption.nodeType||contentOption.jquery)return this._open(event,target,contentOption);(content=contentOption.call(target[0],(function(response){that._delay((function(){target.data("ui-tooltip-open")&&(event&&(event.type=eventType),this._open(event,target,response))}))})))&&this._open(event,target,content)},_open:function(event,target,content){var tooltipData,tooltip,delayedShow,a11yContent,positionOption=$.extend({},this.options.position);function position(event){positionOption.of=event,tooltip.is(":hidden")||tooltip.position(positionOption)}content&&((tooltipData=this._find(target))?tooltipData.tooltip.find(".ui-tooltip-content").html(content):(target.is("[title]")&&(event&&"mouseover"===event.type?target.attr("title",""):target.removeAttr("title")),tooltipData=this._tooltip(target),tooltip=tooltipData.tooltip,this._addDescribedBy(target,tooltip.attr("id")),tooltip.find(".ui-tooltip-content").html(content),this.liveRegion.children().hide(),(a11yContent=$("<div>").html(tooltip.find(".ui-tooltip-content").html())).removeAttr("name").find("[name]").removeAttr("name"),a11yContent.removeAttr("id").find("[id]").removeAttr("id"),a11yContent.appendTo(this.liveRegion),this.options.track&&event&&/^mouse/.test(event.type)?(this._on(this.document,{mousemove:position}),position(event)):tooltip.position($.extend({of:target},this.options.position)),tooltip.hide(),this._show(tooltip,this.options.show),this.options.track&&this.options.show&&this.options.show.delay&&(delayedShow=this.delayedShow=setInterval((function(){tooltip.is(":visible")&&(position(positionOption.of),clearInterval(delayedShow))}),13)),this._trigger("open",event,{tooltip:tooltip})))},_registerCloseHandlers:function(event,target){var events={keyup:function(event){if(event.keyCode===$.ui.keyCode.ESCAPE){var fakeEvent=$.Event(event);fakeEvent.currentTarget=target[0],this.close(fakeEvent,!0)}}};target[0]!==this.element[0]&&(events.remove=function(){var targetElement=this._find(target);targetElement&&this._removeTooltip(targetElement.tooltip)}),event&&"mouseover"!==event.type||(events.mouseleave="close"),event&&"focusin"!==event.type||(events.focusout="close"),this._on(!0,target,events)},close:function(event){var tooltip,that=this,target=$(event?event.currentTarget:this.element),tooltipData=this._find(target);tooltipData?(tooltip=tooltipData.tooltip,tooltipData.closing||(clearInterval(this.delayedShow),target.data("ui-tooltip-title")&&!target.attr("title")&&target.attr("title",target.data("ui-tooltip-title")),this._removeDescribedBy(target),tooltipData.hiding=!0,tooltip.stop(!0),this._hide(tooltip,this.options.hide,(function(){that._removeTooltip($(this))})),target.removeData("ui-tooltip-open"),this._off(target,"mouseleave focusout keyup"),target[0]!==this.element[0]&&this._off(target,"remove"),this._off(this.document,"mousemove"),event&&"mouseleave"===event.type&&$.each(this.parents,(function(id,parent){$(parent.element).attr("title",parent.title),delete that.parents[id]})),tooltipData.closing=!0,this._trigger("close",event,{tooltip:tooltip}),tooltipData.hiding||(tooltipData.closing=!1))):target.removeData("ui-tooltip-open")},_tooltip:function(element){var tooltip=$("<div>").attr("role","tooltip"),content=$("<div>").appendTo(tooltip),id=tooltip.uniqueId().attr("id");return this._addClass(content,"ui-tooltip-content"),this._addClass(tooltip,"ui-tooltip","ui-widget ui-widget-content"),tooltip.appendTo(this._appendTo(element)),this.tooltips[id]={element:element,tooltip:tooltip}},_find:function(target){var id=target.data("ui-tooltip-id");return id?this.tooltips[id]:null},_removeTooltip:function(tooltip){clearInterval(this.delayedShow),tooltip.remove(),delete this.tooltips[tooltip.attr("id")]},_appendTo:function(target){var element=target.closest(".ui-front, dialog");return element.length||(element=this.document[0].body),element},_destroy:function(){var that=this;$.each(this.tooltips,(function(id,tooltipData){var event=$.Event("blur"),element=tooltipData.element;event.target=event.currentTarget=element[0],that.close(event,!0),$("#"+id).remove(),element.data("ui-tooltip-title")&&(element.attr("title")||element.attr("title",element.data("ui-tooltip-title")),element.removeData("ui-tooltip-title"))})),this.liveRegion.remove()}}),!1!==$.uiBackCompat&&$.widget("ui.tooltip",$.ui.tooltip,{options:{tooltipClass:null},_tooltip:function(){var tooltipData=this._superApply(arguments);return this.options.tooltipClass&&tooltipData.tooltip.addClass(this.options.tooltipClass),tooltipData}}),$.ui.tooltip}));"use strict";var fluid=fluid||{};!function($){fluid.thatistBridge=function(name,peer){var togo=function(funcname){for(var segs=funcname.split("."),move=peer,i=0;i<segs.length;++i)move=move[segs[i]];var args=[this];2===arguments.length&&(args=args.concat($.makeArray(arguments[1])));var ret=move.apply(null,args);return this.that=function(){return ret},ret&&ret.constructor&&"fluid.componentConstructor"===ret.constructor.name?this:ret};return $.fn[name]=togo,togo},fluid.thatistBridge("fluid",fluid);var canHaveDefaultTabindex=function(elements){return!(elements.length<=0)&&$(elements[0]).is("a, input, button, select, area, textarea, object")};fluid.tabindex=function(target,toIndex){return target=$(target),null!=toIndex?function(elements,toIndex){return elements.each((function(i,item){$(item).attr("tabindex",toIndex)}))}(target,toIndex):function(elements){if(!(elements.length<=0)){if(!fluid.tabindex.hasAttr(elements))return canHaveDefaultTabindex(elements)?Number(0):void 0;var value=elements.attr("tabindex");return Number(value)}}(target)},fluid.tabindex.remove=function(target){return(target=$(target)).each((function(i,item){$(item).removeAttr("tabindex")}))},fluid.tabindex.hasAttr=function(target){if((target=$(target)).length<=0)return!1;var togo=target.map((function(){var attributeNode=this.getAttributeNode("tabindex");return!!attributeNode&&attributeNode.specified}));return 1===togo.length?togo[0]:togo},fluid.tabindex.has=function(target){return target=$(target),fluid.tabindex.hasAttr(target)||canHaveDefaultTabindex(target)},fluid.a11y=$.a11y||{},fluid.a11y.orientation={HORIZONTAL:0,VERTICAL:1,BOTH:2};var UP_DOWN_KEYMAP={next:$.ui.keyCode.DOWN,previous:$.ui.keyCode.UP},LEFT_RIGHT_KEYMAP={next:$.ui.keyCode.RIGHT,previous:$.ui.keyCode.LEFT};fluid.tabbable=function(target){target=$(target),target.each((function(idx,item){(!(item=$(item)).fluid("tabindex.has")||item.fluid("tabindex")<0)&&item.fluid("tabindex",0)}))};var CONTEXT_KEY="selectionContext",unselectElement=function(selectedElement,selectionContext){!function(selectedElement,handler){handler&&selectedElement&&handler(selectedElement)}(selectedElement,selectionContext.options.onUnselect)},selectElement=function(elementToSelect,selectionContext){var element;unselectElement(selectionContext.selectedElement(),selectionContext),elementToSelect=(element=elementToSelect).jquery?element[0]:element;var newIndex=selectionContext.selectables.index(elementToSelect);-1!==newIndex&&(selectionContext.activeItemIndex=newIndex,function(elementToSelect,handler){handler&&handler(elementToSelect)}(elementToSelect,selectionContext.options.onSelect))},reifyIndex=async function(sc_that){var elements=sc_that.selectables;if(sc_that.activeItemIndex>=elements.length&&(sc_that.activeItemIndex=sc_that.options.noWrap?elements.length-1:0),sc_that.activeItemIndex<0&&-32768!==sc_that.activeItemIndex&&(sc_that.activeItemIndex=sc_that.options.noWrap?0:elements.length-1),sc_that.activeItemIndex>=0)return fluid.focus(elements[sc_that.activeItemIndex])},prepareShift=async function(selectionContext){var selElm=selectionContext.selectedElement();selElm&&await fluid.blur(selElm),unselectElement(selectionContext.selectedElement(),selectionContext),-32768===selectionContext.activeItemIndex&&(selectionContext.activeItemIndex=-1)},focusNextElement=async function(selectionContext){return await prepareShift(selectionContext),++selectionContext.activeItemIndex,reifyIndex(selectionContext)},focusPreviousElement=async function(selectionContext){return await prepareShift(selectionContext),--selectionContext.activeItemIndex,reifyIndex(selectionContext)},arrowKeyHandler=function(selectionContext,keyMap){return async function(evt){evt.which===keyMap.next?(await focusNextElement(selectionContext),evt.preventDefault()):evt.which===keyMap.previous&&(await focusPreviousElement(selectionContext),evt.preventDefault())}},makeElementsSelectable=function(container,defaults,userOptions){var selectionContext,options=$.extend(!0,{},defaults,userOptions),keyMap=function(direction){var keyMap;return direction===fluid.a11y.orientation.HORIZONTAL?keyMap=LEFT_RIGHT_KEYMAP:direction===fluid.a11y.orientation.VERTICAL&&(keyMap=UP_DOWN_KEYMAP),keyMap}(options.direction),selectableElements=options.selectableElements?options.selectableElements:container.find(options.selectableSelector),that={container:container,activeItemIndex:-32768,selectables:selectableElements,focusIsLeavingContainer:!1,options:options};return that.selectablesUpdated=async function(focusedItem){var selectionContext;if("number"==typeof that.options.selectablesTabindex&&that.selectables.fluid("tabindex",that.options.selectablesTabindex),that.selectables.off("focus."+CONTEXT_KEY),that.selectables.off("blur."+CONTEXT_KEY),that.selectables.on("focus."+CONTEXT_KEY,(selectionContext=that,function(evt){return $(evt.target).fluid("tabindex",0),selectElement(evt.target,selectionContext),evt.stopPropagation()})),that.selectables.on("blur."+CONTEXT_KEY,function(selectionContext){return function(evt){return $(evt.target).fluid("tabindex",selectionContext.options.selectablesTabindex),unselectElement(evt.target,selectionContext),evt.stopPropagation()}}(that)),keyMap&&that.options.noBubbleListeners&&(that.selectables.off("keydown."+CONTEXT_KEY),that.selectables.on("keydown."+CONTEXT_KEY,arrowKeyHandler(that,keyMap))),!focusedItem)return reifyIndex(that);selectElement(focusedItem,that)},that.refresh=async function(){return that.options.selectableSelector||fluid.fail("Cannot refresh selectable context which was not initialised by a selector"),that.selectables=container.find(options.selectableSelector),that.selectablesUpdated()},that.selectedElement=function(){return that.activeItemIndex<0?null:that.selectables[that.activeItemIndex]},keyMap&&!that.options.noBubbleListeners&&container.on("keydown",arrowKeyHandler(that,keyMap)),container.on("keydown",(selectionContext=that,function(evt){evt.which===$.ui.keyCode.TAB&&(function(selectionContext){-32768!==selectionContext.activeItemIndex&&(selectionContext.options.onLeaveContainer?selectionContext.options.onLeaveContainer(selectionContext.selectables[selectionContext.activeItemIndex]):selectionContext.options.onUnselect&&selectionContext.options.onUnselect(selectionContext.selectables[selectionContext.activeItemIndex])),selectionContext.options.rememberSelectionState||(selectionContext.activeItemIndex=-32768)}(selectionContext),evt.shiftKey&&(selectionContext.focusIsLeavingContainer=!0))})),container.on("focus",function(selectionContext){return async function(evt){var shouldOrig=selectionContext.options.autoSelectFirstItem,shouldSelect="function"==typeof shouldOrig?shouldOrig():shouldOrig;return selectionContext.focusIsLeavingContainer&&(shouldSelect=!1),shouldSelect&&evt.target===selectionContext.container.get(0)&&(-32768===selectionContext.activeItemIndex&&(selectionContext.activeItemIndex=0),await fluid.focus(selectionContext.selectables[selectionContext.activeItemIndex])),evt.stopPropagation()}}(that)),container.on("blur",function(selectionContext){return function(evt){return selectionContext.focusIsLeavingContainer=!1,evt.stopPropagation()}}(that)),that.promise=that.selectablesUpdated(),that};fluid.selectable=function(target,options){target=$(target);var that=makeElementsSelectable(target,fluid.selectable.defaults,options);return fluid.setScopedData(target,CONTEXT_KEY,that),that},fluid.selectable.select=async function(target,toSelect){return fluid.focus(toSelect)},fluid.selectable.selectNext=async function(target){return target=$(target),focusNextElement(fluid.getScopedData(target,CONTEXT_KEY))},fluid.selectable.selectPrevious=async function(target){return target=$(target),focusPreviousElement(fluid.getScopedData(target,CONTEXT_KEY))},fluid.selectable.currentSelection=function(target){target=$(target);var that=fluid.getScopedData(target,CONTEXT_KEY);return $(that.selectedElement())},fluid.selectable.defaults={direction:fluid.a11y.orientation.VERTICAL,selectablesTabindex:-1,autoSelectFirstItem:!0,rememberSelectionState:!0,selectableSelector:".selectable",selectableElements:null,onSelect:null,onUnselect:null,onLeaveContainer:null,noWrap:!1};var makeActivationHandler=function(binding){return function(evt){var target=evt.target;if(fluid.enabled(target)&&((evt.which?evt.which:evt.keyCode)===binding.key&&binding.activateHandler&&function(binding,evt){if(!binding.modifier)return!0;var modifierKey=binding.modifier,isCtrlKeyPresent=modifierKey&&evt.ctrlKey,isAltKeyPresent=modifierKey&&evt.altKey,isShiftKeyPresent=modifierKey&&evt.shiftKey;return isCtrlKeyPresent||isAltKeyPresent||isShiftKeyPresent}(binding,evt))){var event=$.Event("fluid-activate");$(target).trigger(event,[binding.activateHandler]),event.isDefaultPrevented()&&evt.preventDefault()}}};fluid.activatable=function(target,fn,options){!function(elements,onActivateHandler,defaultKeys,options){var bindings=[];$(defaultKeys).each((function(index,key){bindings.push({modifier:null,key:key,activateHandler:onActivateHandler})})),options&&options.additionalBindings&&(bindings=bindings.concat(options.additionalBindings)),fluid.initEnablement(elements);for(var i=0;i<bindings.length;++i){var binding=bindings[i];elements.on("keydown",makeActivationHandler(binding))}elements.on("fluid-activate",(function(evt,handler){return(handler=handler||onActivateHandler)?handler(evt):null}))}(target=$(target),fn,fluid.activatable.defaults.keys,options)},fluid.activate=function(target){$(target).trigger("fluid-activate")},fluid.activatable.defaults={keys:[$.ui.keyCode.ENTER,$.ui.keyCode.SPACE]}}(jQuery);var fluid=fluid||{};fluid.version="Infusion 4.6.0",fluid.Error=Error,fluid.environment={fluid:fluid},fluid.global=fluid.global||"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},fluid.invokeLater=function(func){return setTimeout(func,0)},fluid.defeatLogging=!0,fluid.activityTracing=!1,fluid.activityTrace=[];var activityParser=/(%\w+)/g;function transformInternal(source,togo,key,transformations){for(var transit=source[key],j=0;j<transformations.length;++j)transit=transformations[j](transit,key);transit!==fluid.NO_VALUE&&(togo[key]=transit)}fluid.renderActivityArgument=function(arg){return fluid.isComponent(arg)?fluid.dumpComponentAndPath(arg):arg},fluid.renderOneActivity=function(activity,nowhile){for(var togo=!0===nowhile?[]:["    while "],message=activity.message,index=activityParser.lastIndex=0;;){var match=activityParser.exec(message);if(!match)break;var key=match[1].substring(1);togo.push(message.substring(index,match.index)),togo.push(fluid.renderActivityArgument(activity.args[key])),index=activityParser.lastIndex}return index<message.length&&togo.push(message.substring(index)),togo},fluid.renderActivity=function(activityStack,renderer){return renderer=renderer||fluid.renderOneActivity,fluid.transform(activityStack,renderer)},fluid.singleThreadLocal=function(initFunc){var value=initFunc();return function(newValue){return void 0===newValue?value:value=newValue}},fluid.threadLocal=fluid.singleThreadLocal,fluid.globalThreadLocal=fluid.threadLocal((function(){return{}})),fluid.getActivityStack=function(){var root=fluid.globalThreadLocal();return root.activityStack||(root.activityStack=[]),root.activityStack},fluid.describeActivity=fluid.getActivityStack,fluid.logActivity=function(activity){activity=activity||fluid.describeActivity();var rendered=fluid.renderActivity(activity).reverse();rendered.length>0&&(fluid.log("Current activity: "),fluid.each(rendered,(function(args){fluid.log.apply(null,args)})))},fluid.pushActivity=function(type,message,args){var record={type:type,message:message,args:args,time:(new Date).getTime()};fluid.activityTracing&&fluid.activityTrace.push(record),fluid.passLogLevel(fluid.logLevel.TRACE)&&fluid.log.apply(null,fluid.renderOneActivity(record,!0)),fluid.getActivityStack().push(record)},fluid.popActivity=function(popframes){popframes=popframes||1,fluid.activityTracing&&fluid.activityTrace.push({pop:popframes});var activityStack=fluid.getActivityStack(),popped=activityStack.length-popframes;activityStack.length=popped<0?0:popped},fluid.FluidError=function(){var togo=Error.apply(this,arguments);this.message=togo.message;try{throw togo}catch(togo){this.stack=togo.stack}return this},fluid.FluidError.prototype=Object.create(Error.prototype),fluid.logFailure=function(args,activity){fluid.log.apply(null,[fluid.logLevel.FAIL,"ASSERTION FAILED: "].concat(args)),fluid.logActivity(activity)},fluid.renderLoggingArg=function(arg){return void 0===arg?"undefined":fluid.isPrimitive(arg)||!fluid.isPlainObject(arg)?arg:JSON.stringify(arg)},fluid.builtinFail=function(args){var message=fluid.transform(args,fluid.renderLoggingArg).join("");throw new fluid.FluidError("Assertion failure - check console for more details: "+message)},fluid.fail=function(...messages){var activity=fluid.makeArray(fluid.describeActivity());fluid.popActivity(activity.length),fluid.failureEvent?fluid.failureEvent.fire(messages,activity):(fluid.logFailure(messages,activity),fluid.builtinFail(messages,activity))},fluid.notrycatch=!1,fluid.tryCatch=function(tryfun,catchfun,finallyfun){if(finallyfun=finallyfun||fluid.identity,fluid.notrycatch){var togo=tryfun();return finallyfun(),togo}try{return tryfun()}catch(e){if(!catchfun)throw e;catchfun(e)}finally{finallyfun()}},fluid.expect=function(name,target,members){fluid.transform(fluid.makeArray(members),(function(key){void 0===target[key]&&fluid.fail(name+" missing required member "+key)}))},fluid.isLogging=function(){return logLevelStack[0].priority>fluid.logLevel.IMPORTANT.priority},fluid.isLogLevel=function(arg){return fluid.isMarker(arg)&&void 0!==arg.priority},fluid.passLogLevel=function(testLogLevel){return testLogLevel.priority<=logLevelStack[0].priority},fluid.setLogging=function(enabled){var logLevel;"boolean"==typeof enabled?logLevel=fluid.logLevel[enabled?"INFO":"IMPORTANT"]:fluid.isLogLevel(enabled)?logLevel=enabled:fluid.fail("Unrecognised fluid logging level ",enabled),logLevelStack.unshift(logLevel),fluid.defeatLogging=!fluid.isLogging()},fluid.setLogLevel=fluid.setLogging,fluid.popLogging=function(){var togo=1===logLevelStack.length?logLevelStack[0]:logLevelStack.shift();return fluid.defeatLogging=!fluid.isLogging(),togo},fluid.doBrowserLog=function(args){"undefined"!=typeof console&&(console.debug?console.debug.apply(console,args):"function"==typeof console.log&&console.log.apply(console,args))},fluid.log=function(){var directArgs=fluid.makeArray(arguments),userLogLevel=fluid.logLevel.INFO;fluid.isLogLevel(directArgs[0])&&(userLogLevel=directArgs.shift()),fluid.passLogLevel(userLogLevel)&&fluid.loggingEvent.fire(directArgs)},fluid.isValue=function(value){return null!=value},fluid.isPrimitive=function(value){var valueType=typeof value;return!value||"string"===valueType||"boolean"===valueType||"number"===valueType||"function"===valueType},fluid.isJQuery=function(totest){return Boolean(totest&&totest.jquery&&totest.constructor&&totest.constructor.prototype&&totest.constructor.prototype.jquery)},fluid.isArrayable=function(totest){return Boolean(totest)&&("[object Array]"===Object.prototype.toString.call(totest)||fluid.isJQuery(totest))},fluid.isPlainObject=function(totest,strict){var string=Object.prototype.toString.call(totest);return"[object Array]"===string?!strict:"[object Object]"===string&&(!totest.constructor||!totest.constructor.prototype||Object.prototype.hasOwnProperty.call(totest.constructor.prototype,"isPrototypeOf"))},fluid.typeCode=function(totest){return fluid.isPrimitive(totest)||!fluid.isPlainObject(totest)?"primitive":fluid.isArrayable(totest)?"array":"object"},fluid.isIoCReference=function(ref){return"string"==typeof ref&&"{"===ref.charAt(0)},fluid.isReferenceOrExpander=function(ref){return ref&&(fluid.isIoCReference(ref)||ref.expander)},fluid.isDOMNode=function(obj){return obj&&"number"==typeof obj.nodeType},fluid.isComponent=function(obj){return obj&&obj.constructor===fluid.componentConstructor},fluid.isUncopyable=function(totest){return fluid.isPrimitive(totest)||!fluid.isPlainObject(totest)},fluid.isApplicable=function(totest){return totest.apply&&"function"==typeof totest.apply},fluid.identity=function(arg){return arg},fluid.notImplemented=function(){fluid.fail("This operation is not implemented")},fluid.firstDefined=function(a,b){return void 0===a?b:a},fluid.freshContainer=function(tocopy){return fluid.isArrayable(tocopy)?[]:{}},fluid.testStrategyRecursion=function(funcName,segs){segs.length>fluid.strategyRecursionBailout&&fluid.fail("Runaway recursion encountered in "+funcName+" - reached path depth of "+fluid.strategyRecursionBailout+" via path of "+segs.join(".")+"this object is probably circularly connected. Either adjust your object structure to remove the circularity or increase fluid.strategyRecursionBailout")},fluid.copyRecurse=function(tocopy,segs){return fluid.testStrategyRecursion("fluid.copy",segs),fluid.isUncopyable(tocopy)?tocopy:fluid.transform(tocopy,(function(value,key){segs.push(key);var togo=fluid.copyRecurse(value,segs);return segs.pop(),togo}))},fluid.copy=function(tocopy){return fluid.copyRecurse(tocopy,[])},fluid.extend=$.extend,fluid.makeArray=function(arg){var togo=[];if(null!=arg)if(fluid.isPrimitive(arg)||fluid.isPlainObject(arg,!0)||"number"!=typeof arg.length)togo.push(arg);else for(var i=0;i<arg.length;++i)togo[i]=arg[i];return togo},fluid.pushArray=function(holder,member,topush){var array=holder[member]?holder[member]:holder[member]=[];Array.isArray(topush)?array.push.apply(array,topush):array.push(topush)},fluid.transform=function(source,...transformations){if(fluid.isPrimitive(source))return source;var togo=fluid.freshContainer(source);if(fluid.isArrayable(source))for(var i=0;i<source.length;++i)transformInternal(source,togo,i,transformations);else for(var key in source)transformInternal(source,togo,key,transformations);return togo},fluid.forEachInRange=function(array,start,end,func){for(var i=start;i<end;++i)func(array[i],i)},fluid.peek=function(array){return 0===array.length?void 0:array[array.length-1]},fluid.each=function(source,func){if(fluid.isArrayable(source))for(var i=0;i<source.length;++i)func(source[i],i);else for(var key in source)func(source[key],key)},fluid.make_find=function(find_if){var target=!find_if&&void 0;return function(source,func,deffolt){var disp;if(fluid.isArrayable(source)){for(var i=0;i<source.length;++i)if((disp=func(source[i],i))!==target)return find_if?source[i]:disp}else for(var key in source)if((disp=func(source[key],key))!==target)return find_if?source[key]:disp;return deffolt}},fluid.find=fluid.make_find(!1),fluid.find_if=fluid.make_find(!0),fluid.remove_if=function(source,fn,target){if(fluid.isArrayable(source))for(var i=source.length-1;i>=0;--i)fn(source[i],i)&&(target&&target.unshift(source[i]),source.splice(i,1));else for(var key in source)fn(source[key],key)&&(target&&(target[key]=source[key]),delete source[key]);return target||source},fluid.generate=function(n,generator,applyFunc){for(var togo=[],i=0;i<n;++i)togo[i]=applyFunc?generator(i):generator;return togo},fluid.iota=function(count,first){first=first||0;for(var togo=[],i=0;i<count;++i)togo[togo.length]=first++;return togo},fluid.getMembers=function(holder,name){return fluid.transform(holder,(function(member){return fluid.get(member,name)}))},fluid.filterKeys=function(toFilter,keys,exclude){return fluid.remove_if($.extend({},toFilter),(function(value,key){return exclude^-1===keys.indexOf(key)}))},fluid.censorKeys=function(toCensor,keys){return fluid.filterKeys(toCensor,keys,!0)},fluid.keys=function(obj){var togo=[];for(var key in obj)togo.push(key);return togo},fluid.values=function(obj){var togo=[];for(var key in obj)togo.push(obj[key]);return togo},fluid.keyForValue=function(obj,value){return fluid.find(obj,(function(thisValue,key){if(value===thisValue)return key}))},fluid.arrayToHash=function(array){var togo={};return fluid.each(array,(function(el){togo[el]=!0})),togo},fluid.hashToArray=function(hash,keyName,func){var togo=[];return fluid.each(hash,(function(el,key){var newEl=el;void 0!==keyName&&((newEl={})[keyName]=key),func?newEl=func(newEl,el,key)||newEl:newEl!==el&&$.extend(!0,newEl,el),togo.push(newEl)})),togo},fluid.flatten=function(array){var togo=[];return fluid.each(array,(function(element){fluid.isArrayable(element)?togo=togo.concat(element):togo.push(element)})),togo},fluid.clear=function(target){if(fluid.isArrayable(target))target.length=0;else for(var i in target)delete target[i]},fluid.compareStringLength=function(ascending){return ascending?function(a,b){return a.length-b.length}:function(a,b){return b.length-a.length}},fluid.parseInteger=function(string){return isFinite(string)&&string%1==0?Number(string):NaN},fluid.roundToDecimal=function(num,scale,method){return scale=scale&&scale>=0?Math.round(scale):0,Number("ceil"===method||"floor"===method?Math[method](num+"e"+scale)+"e-"+scale:(num>=0?1:-1)*(Math.round(Math.abs(num)+"e"+scale)+"e-"+scale))},fluid.debounce=function(func,wait,immediate){var timeout,result;return function(){var context=this,args=arguments,callNow=immediate&&!timeout;return clearTimeout(timeout),timeout=setTimeout((function(){timeout=null,immediate||(result=func.apply(context,args))}),wait),callNow&&(result=func.apply(context,args)),result}},fluid.freezeRecursive=function(tofreeze,segs){return segs=segs||[],fluid.testStrategyRecursion("fluid.freezeRecursive",segs),fluid.isPlainObject(tofreeze)?(fluid.each(tofreeze,(function(value,key){segs.push(key),fluid.freezeRecursive(value,segs),segs.pop()})),Object.freeze(tofreeze)):tofreeze},fluid.marker=function(){},fluid.makeMarker=function(value,extra){var togo=Object.create(fluid.marker.prototype);return togo.value=value,fluid.extend(togo,extra),Object.freeze(togo)},fluid.NO_VALUE=fluid.makeMarker("NO_VALUE"),fluid.EXPAND=fluid.makeMarker("EXPAND"),fluid.isMarker=function(totest,type){return totest instanceof fluid.marker&&(!type||totest.value===type.value)},fluid.logLevelsSpec={FATAL:0,FAIL:5,WARN:10,IMPORTANT:12,INFO:15,TRACE:20},fluid.logLevel=fluid.transform(fluid.logLevelsSpec,(function(value,key){return fluid.makeMarker(key,{priority:value})}));var logLevelStack=[fluid.logLevel.IMPORTANT];fluid.model={},fluid.model.copyModel=function(target,source){fluid.clear(target),$.extend(!0,target,source)},fluid.model.parseEL=function(EL){return""===EL?[]:String(EL).split(".")},fluid.model.composePath=function(prefix,suffix){return""===prefix?suffix:""===suffix?prefix:prefix+"."+suffix},fluid.model.composeSegments=function(){return fluid.makeArray(arguments).join(".")},fluid.lastDotIndex=function(path){return path.lastIndexOf(".")},fluid.model.getToTailPath=function(path){var lastdot=fluid.lastDotIndex(path);return-1===lastdot?"":path.substring(0,lastdot)},fluid.model.getTailPath=function(path){var lastdot=fluid.lastDotIndex(path);return path.substring(lastdot+1)},fluid.path=fluid.model.composeSegments,fluid.composePath=fluid.model.composePath,fluid.requireDataBinding=function(){fluid.fail("Please include DataBinding.js in order to operate complex model accessor configuration")},fluid.model.setWithStrategy=fluid.model.getWithStrategy=fluid.requireDataBinding,fluid.model.resolvePathSegment=function(root,segment,create,origEnv){if(!origEnv&&root.resolvePathSegment){var togo=root.resolvePathSegment(segment);if(void 0!==togo)return togo}return create&&void 0===root[segment]?root[segment]={}:root[segment]},fluid.model.parseToSegments=function(EL,parseEL,copy){return"number"==typeof EL||"string"==typeof EL?parseEL(EL):copy?fluid.makeArray(EL):EL},fluid.model.pathToSegments=function(EL,config){var parser=config&&config.parser?config.parser.parse:fluid.model.parseEL;return fluid.model.parseToSegments(EL,parser)},fluid.model.accessImpl=function(root,EL,newValue,config,initSegs,returnSegs,traverser){var segs=fluid.model.pathToSegments(EL,config),initPos=0;if(initSegs&&(initPos=initSegs.length,segs=initSegs.concat(segs)),root=traverser(root,segs,initPos,config,newValue===fluid.NO_VALUE?0:1),newValue===fluid.NO_VALUE)return returnSegs?{root:root,segs:segs}:root;root[fluid.peek(segs)]=newValue},fluid.model.accessSimple=function(root,EL,newValue,environment,initSegs,returnSegs){return fluid.model.accessImpl(root,EL,newValue,environment,initSegs,returnSegs,fluid.model.traverseSimple)},fluid.model.traverseSimple=function(root,segs,initPos,environment,uncess){for(var origEnv=environment,limit=segs.length-uncess,i=0;i<limit;++i){if(!root)return;var segment=segs[i];root=environment&&environment[segment]?environment[segment]:fluid.model.resolvePathSegment(root,segment,1===uncess,origEnv),environment=null}return root},fluid.model.setSimple=function(root,EL,newValue,environment,initSegs){fluid.model.accessSimple(root,EL,newValue,environment,initSegs,!1)},fluid.model.getSimple=function(root,EL,environment,initSegs){return null==EL||0===EL.length?root:fluid.model.accessSimple(root,EL,fluid.NO_VALUE,environment,initSegs,!1)},fluid.getImmediate=function(root,segs,i){for(var limit=void 0===i?segs.length:i+1,j=0;j<limit;++j)root=root?root[segs[j]]:void 0;return root},fluid.decodeAccessorArg=function(arg3){return arg3&&arg3!==fluid.model.defaultGetConfig&&arg3!==fluid.model.defaultSetConfig?"environment"===arg3.type?arg3.value:void 0:null},fluid.set=function(root,EL,newValue,config,initSegs){var env=fluid.decodeAccessorArg(config);void 0===env?fluid.model.setWithStrategy(root,EL,newValue,config,initSegs):fluid.model.setSimple(root,EL,newValue,env,initSegs)},fluid.get=function(root,EL,config,initSegs){var env=fluid.decodeAccessorArg(config);return void 0===env?fluid.model.getWithStrategy(root,EL,config,initSegs):fluid.model.accessImpl(root,EL,fluid.NO_VALUE,env,null,!1,fluid.model.traverseSimple)},fluid.getGlobalValue=function(path,env){if(path)return env=env||fluid.environment,fluid.get(fluid.global,path,{type:"environment",value:env})},fluid.bind=function(obj,fnName,args){return obj[fnName].apply(obj,fluid.makeArray(args))},fluid.proxyComponentArgs=fluid.identity,fluid.invokeGlobalFunction=function(functionPath,args,environment){var func=fluid.getGlobalValue(functionPath,environment);if(func){var argsArray=fluid.isArrayable(args)?args:fluid.makeArray(args);return fluid.proxyComponentArgs(argsArray),func.apply(null,argsArray)}fluid.fail("Error invoking global function: "+functionPath+" could not be located")},fluid.registerGlobalFunction=function(functionPath,func,env){env=env||fluid.environment,fluid.set(fluid.global,functionPath,func,{type:"environment",value:env})},fluid.setGlobalValue=fluid.registerGlobalFunction,fluid.registerNamespace=function(path,env){env=env||fluid.environment;var existing=fluid.getGlobalValue(path,env);return existing||(existing={},fluid.setGlobalValue(path,existing,env)),existing},fluid.dumpEl=fluid.identity,fluid.renderTimestamp=fluid.identity,fluid.generateUniquePrefix=function(){return Math.floor(1e12*Math.random()).toString(36)+"-"};var fluid_prefix=fluid.generateUniquePrefix();fluid.fluidInstance=fluid_prefix;var fluid_guid=1;fluid.allocateGuid=function(){return fluid_prefix+fluid_guid++},fluid.registerNamespace("fluid.event"),fluid.extremePriority=4e9,fluid.priorityTypes={first:-1,last:1,before:0,after:0},fluid.extremalPriorities={none:0,transaction:10,testing:20,authoring:30},fluid.parsePriorityConstraint=function(constraint,fixedOnly,site){var segs=constraint.split(":"),type=segs[0],lookup=fluid.priorityTypes[type];return void 0===lookup&&fluid.fail("Invalid constraint type in priority field "+constraint+": the only supported values are "+fluid.keys(fluid.priorityTypes).join(", ")+" or numeric"),fixedOnly&&0===lookup&&fluid.fail("Constraint type in priority field "+constraint+" is not supported in a "+site+" record - you must use either a numeric value or first, last"),{type:segs[0],target:segs[1]}},fluid.parsePriority=function(priority,count,fixedOnly,site){var togo={count:count||0,fixed:null,constraint:null,site:site};"number"==typeof(priority=priority||0)?togo.fixed=-priority:togo.constraint=fluid.parsePriorityConstraint(priority,fixedOnly,site);var multiplier=togo.constraint?fluid.priorityTypes[togo.constraint.type]:0;if(0!==multiplier){var target=togo.constraint.target||"none",extremal=fluid.extremalPriorities[target];void 0===extremal&&fluid.fail("Unrecognised extremal priority target "+target+": the currently supported values are "+fluid.keys(fluid.extremalPriorities).join(", ")+": register your value in fluid.extremalPriorities"),togo.fixed=multiplier*(fluid.extremePriority+extremal)}return null!==togo.fixed&&(togo.fixed+=togo.count/1024),togo},fluid.renderPriority=function(parsed){return parsed.constraint?parsed.constraint.target?parsed.constraint.type+":"+parsed.constraint.target:parsed.constraint.type:Math.floor(parsed.fixed)},fluid.compareByPriority=function(recA,recB){return null!==recA.priority.fixed&&null!==recB.priority.fixed?recA.priority.fixed-recB.priority.fixed:(null===recA.priority.fixed)-(null===recB.priority.fixed)},fluid.honourConstraint=function(array,firstConstraint,c){var constraint=array[c].priority.constraint,matchIndex=fluid.find(array,(function(element,index){return element.namespace===constraint.target?index:void 0}),-1);if(-1===matchIndex)return!0;if(matchIndex>=firstConstraint)return!1;for(var target=matchIndex+("after"===constraint.type?1:0),temp=array[c],shift=c;shift>=target;--shift)array[shift]=array[shift-1];return array[target]=temp,!0},fluid.sortByPriority=function(array){array.sort(fluid.compareByPriority);for(var firstConstraint=fluid.find(array,(function(element,index){return element.priority.constraint&&0===fluid.priorityTypes[element.priority.constraint.type]?index:void 0}),array.length);;){if(firstConstraint===array.length)return array;for(var oldFirstConstraint=firstConstraint,c=firstConstraint;c<array.length;++c){fluid.honourConstraint(array,firstConstraint,c)&&++firstConstraint}if(firstConstraint===oldFirstConstraint){var holders=array.slice(firstConstraint);fluid.fail("Could not find targets for any constraints in "+holders[0].priority.site+" ",holders,": none of the targets ("+fluid.getMembers(holders,"priority.constraint.target").join(", ")+") matched any namespaces of the elements in (",array.slice(0,firstConstraint),") - this is caused by either an invalid or circular reference")}}},fluid.parsePriorityRecords=function(records,name){var array=fluid.hashToArray(records,"namespace",(function(newElement,oldElement){$.extend(newElement,oldElement),newElement.priority=fluid.parsePriority(oldElement.priority,0,!1,name)}));return fluid.sortByPriority(array),array},fluid.event.identifyListener=function(listener,soft){return"string"==typeof listener||listener.$$fluid_guid||soft||(listener.$$fluid_guid=fluid.allocateGuid()),listener.$$fluid_guid},fluid.event.impersonateListener=function(origListener,newListener){fluid.event.identifyListener(origListener),newListener.$$fluid_guid=origListener.$$fluid_guid},fluid.event.sortListeners=function(listeners){var togo=[];return fluid.each(listeners,(function(oneNamespace){for(var headHard,i=0;i<oneNamespace.length;++i){var thisListener=oneNamespace[i];thisListener.softNamespace||headHard||(headHard=thisListener)}headHard?togo.push(headHard):togo=togo.concat(oneNamespace)})),fluid.sortByPriority(togo)},fluid.event.resolveListener=function(listener){var listenerName=listener.globalName||("string"==typeof listener?listener:null);if(listenerName){var listenerFunc=fluid.getGlobalValue(listenerName);listenerFunc?listener=listenerFunc:fluid.fail("Unable to look up name "+listenerName+" as a global function")}return listener},fluid.nameComponent=function(that){return that?fluid.dumpComponentAndPath(that):"[unknown component]"},fluid.event.nameEvent=function(that,eventName){return eventName+" of "+fluid.nameComponent(that)},fluid.event.firer=function(){},fluid.makeEventFirer=function(options){var that,name=(options=options||{}).name||"<anonymous>",lazyInit=function(){that.listeners={},that.byId={},that.sortedListeners=[],that.onDestroy=null,that.addListener=function(listener,namespace,priority,softNamespace,listenerId){var record;if(that.destroyed&&fluid.fail("Cannot add listener to destroyed event firer "+that.name),listener){fluid.isPlainObject(listener,!0)&&!fluid.isApplicable(listener)&&(listener=(record=listener).listener,namespace=record.namespace,priority=record.priority,softNamespace=record.softNamespace,listenerId=record.listenerId),"string"==typeof listener&&(listener={globalName:listener});var id=listenerId||fluid.event.identifyListener(listener);namespace=namespace||id,record=$.extend(record||{},{namespace:namespace,listener:listener,softNamespace:softNamespace,listenerId:listenerId,priority:fluid.parsePriority(priority,that.sortedListeners.length,!1,"listeners")}),that.byId[id]=record,(that.listeners[namespace]=fluid.makeArray(that.listeners[namespace]))[softNamespace?"push":"unshift"](record),that.sortedListeners=fluid.event.sortListeners(that.listeners)}},that.addListener.apply(null,arguments)};return that=Object.create(fluid.event.firer.prototype),fluid.extend(that,{eventId:fluid.allocateGuid(),name:name,ownerId:options.ownerId,typeName:"fluid.event.firer",destroy:function(){that.destroyed=!0,fluid.each(that.onDestroy,(function(func){func()}))},addListener:function(){lazyInit.apply(null,arguments)},removeListener:function(listener){if(that.listeners){var namespace,id,record;"string"==typeof listener?(namespace=listener,(record=that.listeners[namespace])||(id=namespace,namespace=null)):"function"==typeof listener&&((id=fluid.event.identifyListener(listener,!0))||fluid.fail("Cannot remove unregistered listener function ",listener," from event "+that.name));var rec=that.byId[id],softNamespace=rec&&rec.softNamespace;namespace=namespace||rec&&rec.namespace||id,delete that.byId[id],(record=that.listeners[namespace])&&(softNamespace?fluid.remove_if(record,(function(thisLis){return thisLis.listener.$$fluid_guid===id||thisLis.listenerId===id})):record.shift(),0===record.length&&delete that.listeners[namespace]),that.sortedListeners=fluid.event.sortListeners(that.listeners)}},fire:function(){var listeners=that.sortedListeners;if(options.promise&&(that.promisePayload=arguments[0]),listeners&&!that.destroyed)for(var i=0;i<listeners.length;++i){var lisrec=listeners[i];"function"!=typeof lisrec.listener&&(lisrec.listener=fluid.event.resolveListener(lisrec.listener));var value,ret=lisrec.listener.apply(null,arguments);if((options.preventable&&!1===ret||that.destroyed)&&(value=!1),void 0!==value)return value}}}),options.promise&&(that.then=function(func){"promisePayload"in that?func(that.promisePayload):that.addListener(func)}),that},fluid.event.addPrimitiveListener=function(holder,name,func){var existing=holder[name];existing||(existing=holder[name]=[]),existing.push(func)},fluid.fireEvent=function(component,eventName,args){var firer=component.events&&component.events[eventName];firer&&firer.fire.apply(null,fluid.makeArray(args))},fluid.event.addListenerToFirer=function(firer,value,namespace,wrapper){if(wrapper=wrapper||fluid.identity,fluid.isArrayable(value))for(var i=0;i<value.length;++i)fluid.event.addListenerToFirer(firer,value[i],namespace,wrapper);else"function"==typeof value||"string"==typeof value?wrapper(firer).addListener(value,namespace):value&&"object"==typeof value&&wrapper(firer).addListener(value.listener,namespace||value.namespace,value.priority,value.softNamespace,value.listenerId)},fluid.event.resolveListenerRecord=function(records){return{records:records}},fluid.expandImmediate=function(material){fluid.fail("fluid.expandImmediate could not be loaded - please include FluidIoC.js in order to operate IoC-driven event with descriptor "+material)},fluid.mergeListeners=function(that,events,listeners){fluid.each(listeners,(function(value,key){var firer,namespace;if(fluid.isIoCReference(key))(firer=fluid.expandImmediate(key,that))||fluid.fail("Error in listener record: key "+key+' could not be looked up to an event firer - did you miss out "events." when referring to an event firer?');else{var keydot=key.indexOf(".");-1!==keydot&&(namespace=key.substring(keydot+1),key=key.substring(0,keydot)),events[key]||fluid.fail("Listener registered for event "+key+" which is not defined for this component"),firer=events[key]}var record=fluid.event.resolveListenerRecord(value,that,key,namespace,!0);fluid.event.addListenerToFirer(firer,record.records,namespace,record.adderWrapper)}))},fluid.eventFromRecord=function(eventSpec,eventKey,that){var event;return eventSpec&&("string"!=typeof eventSpec||fluid.isIoCReference(eventSpec))?fluid.event.resolveEvent?event=fluid.event.resolveEvent(that,eventKey,eventSpec):fluid.fail("fluid.event.resolveEvent could not be loaded - please include FluidIoC.js in order to operate IoC-driven event with descriptor ",eventSpec):event=fluid.makeEventFirer({name:fluid.event.nameEvent(that,eventKey),preventable:"preventable"===eventSpec,promise:"promise"===eventSpec,ownerId:that.id}),event},fluid.mergeListenerPolicy=function(target,source,key){return"string"!=typeof key&&fluid.fail("Error in listeners declaration - the keys in this structure must resolve to event names - got "+key+" from ",source),!fluid.isIoCReference(key)&&-1!==key.indexOf(".")?source||target:fluid.arrayConcatPolicy(target,source)},fluid.makeMergeListenersPolicy=function(merger,modelRelay){return function(target,source){return target=target||{},modelRelay&&(fluid.isArrayable(source)||"target"in source&&("string"==typeof source.target||source.target.segs))?target[""]=merger(target[""],source,""):fluid.each(source,(function(listeners,key){target[key]=merger(target[key],listeners,key)})),target}},fluid.validateListenersImplemented=function(that){var errors=[];return fluid.each(that.events,(function(event,name){fluid.each(event.sortedListeners,(function(lisrec){lisrec.listener!==fluid.notImplemented&&"fluid.notImplemented"!==lisrec.listener.globalName||errors.push({name:name,namespace:lisrec.namespace,componentSource:fluid.model.getSimple(that.options.listeners,[name+"."+lisrec.namespace,0,"componentSource"])})}))})),errors},fluid.arrayConcatPolicy=function(target,source){return fluid.makeArray(target).concat(fluid.makeArray(source))},fluid.loggingEvent=fluid.makeEventFirer({name:"logging event"}),fluid.addTimestampArg=function(args){var arg0=fluid.renderTimestamp(new Date)+":  ";args.unshift(arg0)},fluid.loggingEvent.addListener(fluid.doBrowserLog,"log"),fluid.loggingEvent.addListener(fluid.identity,"filterArgs","before:log"),fluid.loggingEvent.addListener(fluid.addTimestampArg,"addTimestampArg","after:filterArgs"),fluid.upgradeError=function(originError,whileMsg){var error=originError instanceof Error?originError:fluid.isPrimitive(originError)?{message:originError}:fluid.extend({},originError);return error.message=error.message+whileMsg,error},fluid.failureEvent=fluid.makeEventFirer({name:"failure event"}),fluid.failureEvent.addListener(fluid.builtinFail,"fail"),fluid.failureEvent.addListener(fluid.logFailure,"log","before:fail"),fluid.componentConstructor=function(){},Object.defineProperty(fluid.componentConstructor,"name",{value:"fluid.componentConstructor"}),fluid.typeTag=function(type,id){var that=Object.create(fluid.componentConstructor.prototype);return that.typeName=type,that.id=id||fluid.allocateGuid(),that};var gradeTick=1,gradeTickStore={};fluid.defaultsStore={},fluid.flattenGradeName=function(gradeName){return"string"==typeof gradeName?gradeName:JSON.stringify(gradeName)},fluid.resolveGradesImpl=function(gs,gradeNames){for(var i=(gradeNames=fluid.makeArray(gradeNames)).length-1;i>=0;--i){var gradeName=gradeNames[i],flatGradeName=fluid.flattenGradeName(gradeName);if(gradeName&&!gs.gradeHash[flatGradeName]){var options=(fluid.isReferenceOrExpander(gradeName)?null:fluid.rawDefaults(gradeName))||{},thisTick=gradeTickStore[gradeName]||gradeTick-1;gs.lastTick=Math.max(gs.lastTick,thisTick),gs.gradeHash[flatGradeName]=!0,gs.gradeChain.push(gradeName);for(var oGradeNames=fluid.makeArray(options.gradeNames),j=oGradeNames.length-1;j>=0;--j)fluid.resolveGradesImpl(gs,oGradeNames[j])}}return gs},fluid.resolveGradeStructure=function(defaultName,gradeNames){var gradeStruct={lastTick:0,gradeChain:[],gradeHash:{}};return fluid.resolveGradesImpl(gradeStruct,[defaultName].concat(fluid.makeArray(gradeNames))),gradeStruct.gradeChain.reverse(),gradeStruct},fluid.hasGrade=function(options,gradeName){return!(!options||!options.gradeNames)&&options.gradeNames.includes(gradeName)},fluid.resolveGrade=function(defaults,defaultName,gradeNames){var gradeStruct=fluid.resolveGradeStructure(defaultName,gradeNames),mergeArgs=fluid.transform(gradeStruct.gradeChain,fluid.rawDefaults,fluid.copy);fluid.remove_if(mergeArgs,(function(options){return!options}));for(var mergePolicy={},i=0;i<mergeArgs.length;++i)mergeArgs[i]&&mergeArgs[i].mergePolicy&&(mergePolicy=$.extend(!0,mergePolicy,mergeArgs[i].mergePolicy));mergeArgs=[mergePolicy,{}].concat(mergeArgs);var mergedDefaults=fluid.merge.apply(null,mergeArgs);return mergedDefaults.gradeNames=gradeStruct.gradeChain,fluid.freezeRecursive(mergedDefaults),{defaults:mergedDefaults,lastTick:gradeStruct.lastTick}},fluid.mergedDefaultsCache={},fluid.gradeNamesToKey=function(defaultName,gradeNames){return defaultName+"|"+gradeNames.join("|")},fluid.getMergedDefaults=function(defaultName,gradeNames){gradeNames=fluid.makeArray(gradeNames);var key=fluid.gradeNamesToKey(defaultName,gradeNames),mergedDefaults=fluid.mergedDefaultsCache[key];if(mergedDefaults){for(var lastTick=0,searchGrades=mergedDefaults.defaults.gradeNames,i=0;i<searchGrades.length;++i)lastTick=Math.max(lastTick,gradeTickStore[searchGrades[i]]||0);lastTick>mergedDefaults.lastTick&&(fluid.passLogLevel(fluid.logLevel.TRACE)&&fluid.log(fluid.logLevel.TRACE,"Clearing cache for component "+defaultName+" with gradeNames ",searchGrades),mergedDefaults=null)}if(!mergedDefaults){var defaults=fluid.rawDefaults(defaultName);if(!defaults)return defaults;mergedDefaults=fluid.mergedDefaultsCache[key]=fluid.resolveGrade(defaults,defaultName,gradeNames)}return mergedDefaults.defaults},fluid.NO_ARGUMENTS=fluid.makeMarker("NO_ARGUMENTS"),fluid.upgradePrimitiveFunc=function(rec,key){if(rec&&fluid.isPrimitive(rec)){var togo={};return togo[key||("string"==typeof rec&&"{"!==rec.charAt(0)?"funcName":"func")]=rec,togo.args=fluid.NO_ARGUMENTS,togo}return rec},fluid.annotateListeners=function(componentName,options){options.listeners=fluid.transform(options.listeners,(function(record){var togo=fluid.makeArray(record);return fluid.transform(togo,(function(onerec){return(onerec=fluid.upgradePrimitiveFunc(onerec,"listener")).componentSource=componentName,onerec}))})),options.invokers=fluid.transform(options.invokers,(function(record){return(record=fluid.upgradePrimitiveFunc(record))&&(record.componentSource=componentName),record}))},fluid.workflowCache={},fluid.workflowCacheSorted=[],fluid.resortWorkflows=function(workflowType,baseIndex){var thisCache=fluid.workflowCache[workflowType],parsed=fluid.parsePriorityRecords(thisCache,workflowType+" workflows");return parsed.forEach((function(oneParsed,index){thisCache[oneParsed.namespace].index=index+baseIndex})),parsed},fluid.indexOneWorkflows=function(gradeName,workflowType,workflows,baseIndex){return fluid.each(workflows,(function(oneWorkflow,workflowKey){fluid.model.setSimple(fluid.workflowCache,[workflowType,workflowKey],{workflowType:workflowType,workflowName:workflowKey,priority:oneWorkflow.priority,gradeName:gradeName,workflowOptions:oneWorkflow})})),fluid.resortWorkflows(workflowType,baseIndex)},fluid.clearGradeWorkflows=function(gradeName,workflowType){var cacheForType=fluid.workflowCache[workflowType];fluid.each(cacheForType,(function(oneWorkflow,workflowKey){oneWorkflow.gradeName===gradeName&&delete cacheForType[workflowKey]}))},fluid.indexGradeWorkflows=function(gradeName,options){fluid.clearGradeWorkflows(gradeName,"global"),fluid.clearGradeWorkflows(gradeName,"local");var sortedGlobal=fluid.indexOneWorkflows(gradeName,"global",fluid.getImmediate(options,["workflows","global"]),0),globalWorkflowCount=sortedGlobal.length,sortedLocal=fluid.indexOneWorkflows(gradeName,"local",fluid.getImmediate(options,["workflows","local"]),globalWorkflowCount);fluid.workflowCacheSorted=sortedGlobal.concat(sortedLocal)},fluid.rawDefaults=function(componentName){var entry=fluid.defaultsStore[componentName];return entry&&entry.options},fluid.registerRawDefaults=function(componentName,options){fluid.pushActivity("registerRawDefaults","registering defaults for grade %componentName with options %options",{componentName:componentName,options:options});var optionsCopy=fluid.expandCompact?fluid.expandCompact(options):fluid.copy(options);fluid.annotateListeners(componentName,optionsCopy),fluid.indexGradeWorkflows(componentName,optionsCopy),delete optionsCopy.workflows;var callerInfo=fluid.getCallerInfo&&fluid.getCallerInfo(6);fluid.freezeRecursive(optionsCopy),fluid.defaultsStore[componentName]={options:optionsCopy,callerInfo:callerInfo},gradeTickStore[componentName]=gradeTick++,fluid.popActivity()},fluid.doIndexDefaults=function(defaultName,defaults,index,indexSpec){for(var requiredGrades=fluid.makeArray(indexSpec.gradeNames),i=0;i<requiredGrades.length;++i)if(!fluid.hasGrade(defaults,requiredGrades[i]))return;for(var keys=("function"==typeof indexSpec.indexFunc?indexSpec.indexFunc:fluid.getGlobalValue(indexSpec.indexFunc))(defaults)||[],j=0;j<keys.length;++j)fluid.pushArray(index,keys[j],defaultName)},fluid.indexDefaults=function(indexName,indexSpec){var index={};for(var defaultName in fluid.defaultsStore){var defaults=fluid.getMergedDefaults(defaultName);fluid.doIndexDefaults(defaultName,defaults,index,indexSpec)}return index},fluid.defaults=function(componentName,options){if(void 0===options)return fluid.getMergedDefaults(componentName);options&&options.options&&fluid.fail("Probable error in options structure for "+componentName+' with option named "options" - perhaps you meant to write these options at top level in fluid.defaults? - ',options),fluid.registerRawDefaults(componentName,options);var gradedDefaults=fluid.getMergedDefaults(componentName);fluid.hasGrade(gradedDefaults,"fluid.function")||fluid.makeComponentCreator(componentName)},fluid.validateCreatorGrade=function(message,componentName){var defaults=fluid.getMergedDefaults(componentName);if(defaults&&defaults.gradeNames&&0!==defaults.gradeNames.length){if(!defaults.argumentMap){for(var blankGrades=[],i=0;i<defaults.gradeNames.length;++i){var gradeName=defaults.gradeNames[i];fluid.rawDefaults(gradeName)||blankGrades.push(gradeName)}0===blankGrades.length?fluid.fail(message+" type "+componentName+" which is not derived from fluid.component"):fluid.fail("The grade hierarchy of component with type "+componentName+" is incomplete - it inherits from the following grade(s): "+blankGrades.join(", ")+" for which the grade definitions are corrupt or missing. Please check the files which might include these grades and ensure they are readable and have been loaded by this instance of Infusion")}}else fluid.fail(message+" type "+componentName+" which does not have any gradeNames defined")},fluid.makeComponentCreator=function(componentName){var creator=function(){return fluid.validateCreatorGrade("Cannot make component creator for",componentName),fluid.initFreeComponent(componentName,arguments)},existing=fluid.getGlobalValue(componentName);existing&&$.extend(creator,existing),fluid.setGlobalValue(componentName,creator)},fluid.emptyPolicy=fluid.freezeRecursive({}),fluid.derefMergePolicy=function(policy){return(policy?policy["*"]:fluid.emptyPolicy)||fluid.emptyPolicy},fluid.compileMergePolicy=function(mergePolicy){var builtins={},defaultValues={},togo={builtins:builtins,defaultValues:defaultValues};return mergePolicy?(fluid.each(mergePolicy,(function(value,key){var parsed={},builtin=!0;if("function"==typeof value)parsed.func=value;else if("object"==typeof value)parsed=value;else if(fluid.isDefaultValueMergePolicy(value))fluid.set(defaultValues,key,"{that}.options."+value),togo.hasDefaults=!0,builtin=!1;else for(var split=value.split(/\s*,\s*/),i=0;i<split.length;++i)parsed[split[i]]=!0;builtin&&fluid.set(builtins,fluid.composePath(key,"*"),parsed)})),togo):togo},fluid.isDefaultValueMergePolicy=function(policy){return"string"==typeof policy&&-1===policy.indexOf(",")&&!/replace|nomerge|noexpand/.test(policy)},fluid.mergeOneImpl=function(thisTarget,thisSource,j,sources,newPolicy,newPolicyHolder,i,segs){var togo=thisTarget,primitiveTarget=fluid.isPrimitive(thisTarget);return void 0!==thisSource&&(newPolicy.func||null===thisSource||!fluid.isPlainObject(thisSource)||newPolicy.nomerge?(sources[j]=void 0,togo=newPolicy.func?newPolicy.func.call(null,thisTarget,thisSource,newPolicyHolder,segs,i):thisSource):primitiveTarget&&(togo=thisTarget=fluid.freshContainer(thisSource))),togo},fluid.regenerateCursor=function(source,segs,limit,sourceStrategy){for(var i=0;i<limit;++i)source=sourceStrategy(source,segs[i],i,fluid.makeArray(segs));return source},fluid.regenerateSources=function(sources,segs,limit,sourceStrategies){for(var togo=[],i=0;i<sources.length;++i){var thisSource=fluid.regenerateCursor(sources[i],segs,limit,sourceStrategies[i]);togo.push(thisSource)}return togo},fluid.fetchMergeChildren=function(target,i,segs,sources,mergePolicy,options){for(var thisPolicy=fluid.derefMergePolicy(mergePolicy),j=sources.length-1;j>=0;--j){var source=sources[j];if(void 0!==source&&(fluid.each(source,(function(newSource,name){var childPolicy=fluid.concreteTrundler(mergePolicy,name);(!(name in target)||options.evaluateFully&&void 0===childPolicy&&!fluid.isPrimitive(target[name]))&&(segs[i]=name,options.strategy(target,name,i+1,segs,sources,mergePolicy))})),thisPolicy.replace))break}return target},fluid.inEvaluationMarker=Object.freeze({__CURRENTLY_IN_EVALUATION__:!0}),fluid.strategyRecursionBailout=50,fluid.makeMergeStrategy=function(options){var strategy=function(target,name,i,segs,sources,policy){if(i>fluid.strategyRecursionBailout&&fluid.fail("Overflow/circularity in options merging, current path is ",segs," at depth ",i,' - please protect components from merging using the "nomerge" merge policy'),!fluid.isPrimitive(target)){var oldTarget;if(fluid.isTracing&&fluid.tracing.pathCount.push(fluid.path(segs.slice(0,i))),(name in target||options.fullyEvaluated)&&(oldTarget=target[name],!options.evaluateFully))return oldTarget;void 0===sources&&(segs=fluid.makeArray(segs),sources=fluid.regenerateSources(options.sources,segs,i-1,options.sourceStrategies),policy=fluid.regenerateCursor(options.mergePolicy,segs,i-1,fluid.concreteTrundler));var start,limit,mul,newPolicyHolder=fluid.concreteTrundler(policy,name),newPolicy=fluid.derefMergePolicy(newPolicyHolder);newPolicy.replace?(start=1-sources.length,limit=0,mul=-1):(start=0,limit=sources.length-1,mul=1);for(var thisTarget,newSources=[],j=start;j<=limit;++j){var k=mul*j,thisSource=options.sourceStrategies[k](sources[k],name,i,segs);if(void 0!==thisSource&&(fluid.isPrimitive(thisSource)||(newSources[k]=thisSource),void 0===oldTarget)){if(-1===mul){thisTarget=target[name]=thisSource;break}thisTarget=fluid.mergeOneImpl(thisTarget,thisSource,j,newSources,newPolicy,newPolicyHolder,i,segs,options),target[name]=thisTarget}}return void 0!==oldTarget&&(thisTarget=oldTarget),newSources.length>0&&fluid.isPlainObject(thisTarget)&&fluid.fetchMergeChildren(thisTarget,i,segs,newSources,newPolicyHolder,options),thisTarget}};return options.strategy=strategy,strategy},fluid.driveStrategy=function(root,pathSegs,strategy){pathSegs=fluid.makeArray(pathSegs);for(var i=0;i<pathSegs.length;++i){if(!root)return;root=strategy(root,pathSegs[i],i+1,pathSegs)}return root},fluid.concreteTrundler=function(source,seg){return source?source[seg]:void 0},fluid.merge=function(policy,...sources){var compiled=fluid.compileMergePolicy(policy).builtins,options=fluid.makeMergeOptions(compiled,sources,{});return options.initter(),options.target},fluid.makeMergeOptions=function(policy,sources,userOptions){var options={mergePolicy:policy,sources:sources};return(options=$.extend(options,userOptions)).target=options.target||fluid.freshContainer(options.sources[0]),options.sourceStrategies=options.sourceStrategies||fluid.generate(options.sources.length,fluid.concreteTrundler),options.initter=function(){options.evaluateFully=!0,fluid.fetchMergeChildren(options.target,0,[],options.sources,options.mergePolicy,options),options.fullyEvaluated=!0},fluid.makeMergeStrategy(options),options},fluid.transformOptions=function(options,transRec){return fluid.expect("Options transformation record",transRec,["transformer","config"]),fluid.getGlobalValue(transRec.transformer).call(null,options,transRec.config)},fluid.findMergeBlocks=function(mergeBlocks,recordType){return fluid.remove_if(fluid.makeArray(mergeBlocks),(function(block){return block.recordType!==recordType}))},fluid.transformOptionsBlocks=function(mergeBlocks,transformOptions,recordTypes){fluid.each(recordTypes,(function(recordType){var blocks=fluid.findMergeBlocks(mergeBlocks,recordType);fluid.each(blocks,(function(block){var source=block.source?"source":"target";block[block.simple||"target"===source?"target":"source"]=fluid.transformOptions(block[source],transformOptions)}))}))},fluid.dedupeDistributionNamespaces=function(mergeBlocks){var byNamespace={};fluid.remove_if(mergeBlocks,(function(mergeBlock){var ns=mergeBlock.namespace;if(ns){if(byNamespace[ns]&&byNamespace[ns]!==mergeBlock.contextThat.id)return!0;byNamespace[ns]=mergeBlock.contextThat.id}}))},fluid.mergeRecordTypes={defaults:1e3,defaultValueMerge:900,lensedComponents:800,subcomponentRecord:700,user:600,distribution:100},fluid.model.applyChangeRequest=function(model,request){var segs=request.segs;if(0===segs.length)"ADD"===request.type?$.extend(!0,model,request.value):fluid.clear(model);else if("ADD"===request.type)fluid.model.setSimple(model,request.segs,request.value);else{for(var i=0;i<segs.length-1;++i)if(!(model=model[segs[i]]))return;delete model[fluid.peek(segs)]}},fluid.destroyValue=function(target,segs){target&&fluid.model.applyChangeRequest(target,{type:"DELETE",segs:segs})},fluid.mergeComponentOptions=function(that,potentia,lightMerge){fluid.validateCreatorGrade("Cannot construct component of",lightMerge.type);var sharedMergePolicy={},mergeBlocks=fluid.expandComponentOptions(sharedMergePolicy,potentia,lightMerge,that),options={},sourceStrategies=[],sources=[],baseMergeOptions={target:options,sourceStrategies:sourceStrategies},updateBlocks=function(){fluid.each(mergeBlocks,(function(block){fluid.isPrimitive(block.priority)&&(block.priority=fluid.parsePriority(block.priority,0,!1,block.recordType))})),fluid.sortByPriority(mergeBlocks),fluid.dedupeDistributionNamespaces(mergeBlocks),sourceStrategies.length=0,sources.length=0,fluid.each(mergeBlocks,(function(block){sourceStrategies.push(block.strategy),sources.push(block.target)}))};updateBlocks();var compiledPolicy,mergePolicy,mergeOptions=fluid.makeMergeOptions(sharedMergePolicy,sources,baseMergeOptions);function computeMergePolicy(){mergePolicy=fluid.driveStrategy(options,"mergePolicy",mergeOptions.strategy),mergePolicy=$.extend({},fluid.rootMergePolicy,mergePolicy),compiledPolicy=fluid.compileMergePolicy(mergePolicy),$.extend(!0,sharedMergePolicy,compiledPolicy.builtins)}mergeOptions.mergeBlocks=mergeBlocks,mergeOptions.updateBlocks=updateBlocks,mergeOptions.destroyValue=function(segs){for(var i=0;i<mergeBlocks.length;++i)mergeBlocks[i].immutableTarget||fluid.destroyValue(mergeBlocks[i].target,segs);fluid.destroyValue(baseMergeOptions.target,segs)},computeMergePolicy(),mergeOptions.computeMergePolicy=computeMergePolicy,compiledPolicy.hasDefaults&&(mergeBlocks.push(fluid.generateExpandBlock({options:compiledPolicy.defaultValues,recordType:"defaultValueMerge",priority:fluid.mergeRecordTypes.defaultValueMerge},that,{})),updateBlocks()),that.options=options,fluid.driveStrategy(options,"gradeNames",mergeOptions.strategy),fluid.deliverOptionsStrategy(that,options,mergeOptions),fluid.computeComponentAccessor(that,potentia.localRecord);var transformOptions=fluid.driveStrategy(options,"transformOptions",mergeOptions.strategy);return transformOptions&&(fluid.transformOptionsBlocks(mergeBlocks,transformOptions,["user","subcomponentRecord"]),updateBlocks()),baseMergeOptions.target.mergePolicy||computeMergePolicy(),mergeOptions},fluid.defaults("fluid.function",{}),fluid.invokeGradedFunction=function(name,spec){var defaults=fluid.defaults(name);defaults&&defaults.argumentMap&&fluid.hasGrade(defaults,"fluid.function")||fluid.fail("Cannot look up name "+name+" to a function with registered argumentMap - got defaults ",defaults);var args=[];return fluid.each(defaults.argumentMap,(function(value,key){args[value]=spec[key]})),fluid.invokeGlobalFunction(name,args)},fluid.noNamespaceDistributionPrefix="no-namespace-distribution-",fluid.mergeOneDistribution=function(target,source,key){var namespace=source.namespace||key||fluid.noNamespaceDistributionPrefix+fluid.allocateGuid();source.namespace=namespace,target[namespace]=$.extend(!0,{},target[namespace],source)},fluid.distributeOptionsPolicy=function(target,source){if(target=target||{},fluid.isArrayable(source))for(var i=0;i<source.length;++i)fluid.mergeOneDistribution(target,source[i]);else"string"==typeof source.target?fluid.mergeOneDistribution(target,source):fluid.each(source,(function(oneSource,key){fluid.mergeOneDistribution(target,oneSource,key)}));return target},fluid.mergingArray=function(){},fluid.mergingArray.prototype=[],fluid.deferringMergePolicy=function(target,source,mergePolicyHolder){return target=target||{},fluid.each(source,(function(oneSource,key){target[key]||(target[key]=new fluid.mergingArray),fluid.derefMergePolicy(mergePolicyHolder[key]).replace&&void 0!==oneSource&&(target[key].length=0),oneSource instanceof fluid.mergingArray?target[key].push.apply(target[key],oneSource):void 0!==oneSource&&target[key].push(oneSource)})),target},fluid.invokerStrategies=fluid.arrayToHash(["func","funcName","listener","this","method","changePath","value"]),fluid.invokersMergePolicy=function(target,source){return target=target||{},fluid.each(source,(function(oneInvoker,name){if(oneInvoker){oneInvoker=fluid.upgradePrimitiveFunc(oneInvoker);var oneT=target[name];for(var key in oneT||(oneT=target[name]={}),fluid.invokerStrategies)if(key in oneInvoker)for(var key2 in fluid.invokerStrategies)oneT[key2]=void 0;$.extend(oneT,oneInvoker)}else target[name]=oneInvoker})),target},fluid.rootMergePolicy=fluid.freezeRecursive({gradeNames:fluid.arrayConcatPolicy,distributeOptions:fluid.distributeOptionsPolicy,members:{noexpand:!0,func:fluid.deferringMergePolicy},invokers:{noexpand:!0,func:fluid.invokersMergePolicy},components:{noexpand:!0,func:fluid.deferringMergePolicy},dynamicComponents:{noexpand:!0,func:fluid.deferringMergePolicy},transformOptions:"replace",listeners:fluid.makeMergeListenersPolicy(fluid.mergeListenerPolicy)}),fluid.defaults("fluid.component",{mergePolicy:fluid.rootMergePolicy,argumentMap:{options:0},workflows:{local:{concludeComponentObservation:{funcName:"fluid.concludeComponentObservation",priority:"first"},concludeComponentInit:{funcName:"fluid.concludeComponentInit",waitIO:!0,priority:"last"}}},events:{onCreate:"promise",onDestroy:"promise",afterDestroy:"promise"}}),fluid.computeNickName=function(typeName){var segs=fluid.model.parseEL(typeName);return fluid.peek(segs)},fluid.isDestroyed=function(that,strict){return"destroyed"===that.lifecycleStatus||!strict&&"destroying"===that.lifecycleStatus},fluid.computeGlobalMemberName=function(type,id){return fluid.computeNickName(type)+"-"+id},fluid.adaptTransactionFailure=function(transRec){var returned=!1;transRec.promise.then(null,(function(e){if(!returned)throw e;0===transRec.promise.onReject.length&&fluid.fireUnhandledRejection(transRec.promise,e)})),returned=!0},fluid.initFreeComponent=function(type,initArgs){var id=fluid.allocateGuid(),path=[fluid.computeGlobalMemberName(type,id)],userRecord={recordType:"user",type:type},upDefaults=fluid.defaults(type),argMap=fluid.defaults(void 0!==upDefaults.argumentMap.container?"fluid.viewComponent":"fluid.component").argumentMap;fluid.each(argMap,(function(index,name){var arg=initArgs[index];userRecord[name]="options"===name?fluid.expandCompact(arg,!0):arg}));var potentia={type:"create",path:path,componentId:id,records:[userRecord]},transRec=fluid.registerPotentia(potentia),shadow=fluid.commitPotentiae(transRec.transactionId);return fluid.adaptTransactionFailure(transRec),shadow&&shadow.that};var charStart="(?:[\\w\\u00c0-\\uFFFF*_-";fluid.simpleCSSMatcher={regexp:new RegExp("([#.]?)("+charStart+"]|\\\\.)+)","g"),charToTag:{"":"tag","#":"id",".":"clazz"}},fluid.IoCSSMatcher={regexp:new RegExp("([&#]?)("+charStart+"]|\\.|\\/)+)","g"),charToTag:{"":"context","&":"context","#":"id"}};var childSeg=new RegExp("\\s*(>)?\\s*","g");fluid.parseSelector=function(selstring,strategy){var togo=[];selstring=selstring.trim();var regexp=strategy.regexp;regexp.lastIndex=0;for(var lastIndex=0;;){for(var atNode=[],first=!0;;){var segMatch=regexp.exec(selstring);if(!segMatch)break;if(segMatch.index!==lastIndex){if(!first)break;fluid.fail("Error in selector string - cannot match child selector expression starting at "+selstring.substring(lastIndex))}var thisNode={},text=segMatch[2],targetTag=strategy.charToTag[segMatch[1]];targetTag&&(thisNode[targetTag]=text),atNode[atNode.length]=thisNode,lastIndex=regexp.lastIndex,first=!1}childSeg.lastIndex=lastIndex;var fullAtNode={predList:atNode},childMatch=childSeg.exec(selstring);if(childMatch&&childMatch.index===lastIndex||fluid.fail("Error in selector string - can not match child selector expression at "+selstring.substring(lastIndex)),">"===childMatch[1]&&(fullAtNode.child=!0),togo[togo.length]=fullAtNode,childSeg.lastIndex>=selstring.length)break;lastIndex=childSeg.lastIndex,regexp.lastIndex=childSeg.lastIndex}return togo},fluid.flattenObjectPaths=function(originalObject){var flattenedObject={};return fluid.each(originalObject,(function(value,key){if(null!==value&&"object"==typeof value){var flattenedSubObject=fluid.flattenObjectPaths(value);fluid.each(flattenedSubObject,(function(subValue,subKey){flattenedObject[key+"."+subKey]=subValue})),"function"==typeof fluid.get(value,"toString")&&(flattenedObject[key]=value.toString())}else flattenedObject[key]=value})),flattenedObject},fluid.stringTemplate=function(template,values){var flattenedValues=fluid.flattenObjectPaths(values),keys=fluid.keys(flattenedValues);keys=keys.sort(fluid.compareStringLength());for(var i=0;i<keys.length;++i)for(var key=keys[i],templatePlaceholder="%"+key,replacementValue=flattenedValues[key],indexOfPlaceHolder=-1;-1!==(indexOfPlaceHolder=template.indexOf(templatePlaceholder));)template=template.slice(0,indexOfPlaceHolder)+replacementValue+template.slice(indexOfPlaceHolder+templatePlaceholder.length);return template},fluid.promise=function(){var that={onResolve:[],onReject:[],onCancel:[],then:function(onResolve,onReject,onCancel){return fluid.promise.pushHandler(that,onResolve,"onResolve","resolve"),fluid.promise.pushHandler(that,onReject,"onReject","reject"),fluid.promise.pushHandler(that,onCancel,"onCancel","cancel"),that},resolve:function(value){return that.disposition?"cancel"!==that.disposition&&fluid.fail("Error: resolving promise ",that,' which has already received "'+that.disposition+'"'):that.complete("resolve",that.onResolve,value),that},reject:function(reason){return that.disposition?"cancel"!==that.disposition&&fluid.fail("Error: rejecting promise ",that,'which has already received "'+that.disposition+'"'):(0===that.onReject.length&&fluid.armUnhandledRejection(that,reason),that.complete("reject",that.onReject,reason)),that},cancel:function(reason){that.disposition||that.complete("cancel",that.onCancel,reason)},complete:function(which,queue,arg){that.disposition=which,that.value=arg;for(var i=0;i<queue.length;++i)queue[i](arg);delete that.onResolve,delete that.onReject,delete that.onCancel}};return that},fluid.promise.pushHandler=function(promise,handler,eventName,disposition){handler&&(promise.disposition?promise.disposition===disposition&&(handler(promise.value),promise.directHandle=disposition):promise[eventName].push(handler))},fluid.armUnhandledRejection=function(promise,reason){fluid.invokeLater((function(){"reject"!==promise.directHandle&&fluid.fireUnhandledRejection(promise,reason)}))},fluid.fireUnhandledRejection=function(promise,reason){fluid.unhandledRejectionEvent.fire(reason,promise)},fluid.unhandledRejectionEvent=fluid.makeEventFirer({name:"Global unhandled rejection handler"}),fluid.logUnhandledRejection=function(reason){fluid.log(fluid.logLevel.WARN,"Unhandled promise rejection: ",reason)},fluid.unhandledRejectionEvent.addListener(fluid.logUnhandledRejection,"log"),fluid.isPromise=function(totest){return totest&&"function"==typeof totest.then},fluid.toPromise=function(promiseOrValue){if(fluid.isPromise(promiseOrValue))return promiseOrValue;var togo=fluid.promise();return togo.resolve(promiseOrValue),togo},fluid.promise.follow=function(source,target){source.then(target.resolve,target.reject),target.then(null,null,source.cancel)},fluid.promise.map=function(source,func){var promise=fluid.toPromise(source),togo=fluid.promise();return promise.then((function(value){var mapped=func(value);fluid.isPromise(mapped)?fluid.promise.follow(mapped,togo):togo.resolve(mapped)}),(function(error){togo.reject(error)})),togo},fluid.promise.makeSequencer=function(sources,options,strategy){fluid.isArrayable(sources)||fluid.fail("fluid.promise sequence algorithms must be supplied an array as source");var sequencer={sources:sources,resolvedSources:[],index:0,strategy:strategy,options:options,returns:[],sequenceStarted:!1,sequenceCancelled:!1,promise:fluid.promise()};return sequencer.promise.then(null,null,(function(){fluid.promise.cancelSequencer(sequencer)})),sequencer.promise.sequencer=sequencer,sequencer},fluid.promise.cancelSequencer=function(sequencer){sequencer.sequenceCancelled=!0,sequencer.resolvedSources.forEach((function(source){fluid.isPromise(source)&&source.cancel()}))},fluid.promise.progressSequence=function(that,retValue){that.returns.push(retValue),that.index++,fluid.promise.resumeSequence(that)},fluid.promise.processSequenceReject=function(that,error){for(var i=that.index-1;i>=0;--i){var resolved=that.resolvedSources[i];error=(fluid.isPromise(resolved)&&"function"==typeof resolved.accumulateRejectionReason?resolved.accumulateRejectionReason:fluid.identity)(error)}that.promise.reject(error)},fluid.promise.resumeSequence=function(that){if(that.sequenceStarted=!0,!that.sequenceCancelled)if(that.index===that.sources.length)that.promise.resolve(that.strategy.resolveResult(that));else{var value=that.strategy.invokeNext(that);that.resolvedSources[that.index]=value,fluid.isPromise(value)?value.then((function(retValue){fluid.promise.progressSequence(that,retValue)}),(function(error){fluid.promise.processSequenceReject(that,error)})):fluid.promise.progressSequence(that,value)}},fluid.promise.makeSequenceStrategy=function(){return{invokeNext:function(that){var source=that.sources[that.index];return"function"==typeof source?source(that.options):source},resolveResult:function(that){return that.returns}}},fluid.promise.sequence=function(sources,options){var sequencer=fluid.promise.makeSequencer(sources,options,fluid.promise.makeSequenceStrategy());return fluid.promise.resumeSequence(sequencer),sequencer.promise},fluid.promise.makeTransformerStrategy=function(){return{invokeNext:function(that){var lisrec=that.sources[that.index];return lisrec.listener=fluid.event.resolveListener(lisrec.listener),lisrec.listener.apply(null,[that.returns[that.index],that.options])},resolveResult:function(that){return that.returns[that.index]}}},fluid.promise.makeTransformer=function(listeners,payload,options){listeners.unshift({listener:function(){return payload}});var sequencer=fluid.promise.makeSequencer(listeners,options,fluid.promise.makeTransformerStrategy());return sequencer.returns.push(null),sequencer},fluid.promise.filterNamespaces=function(listeners,namespaces){return namespaces?fluid.remove_if(fluid.makeArray(listeners),(function(element){return element.namespace&&!element.softNamespace&&!namespaces.includes(element.namespace)})):listeners},fluid.promise.fireTransformEvent=function(event,payload,options){var listeners=(options=options||{}).reverse?fluid.makeArray(event.sortedListeners).reverse():fluid.makeArray(event.sortedListeners);listeners=fluid.promise.filterNamespaces(listeners,options.filterNamespaces);var sequencer=fluid.promise.makeTransformer(listeners,payload,options),canceller=sequencer.promise.cancel,remover=function(){fluid.remove_if(event.onDestroy,(function(func){return func===canceller}))};return fluid.event.addPrimitiveListener(event,"onDestroy",canceller),sequencer.promise.then(remover,remover,remover),fluid.promise.resumeSequence(sequencer),sequencer.promise},fluid.renderTimestamp=function(date){var zeropad=function(num,width){width||(width=2);var numstr=void 0===num?"":num.toString();return"00000".substring(5-width+numstr.length)+numstr};return zeropad(date.getHours())+":"+zeropad(date.getMinutes())+":"+zeropad(date.getSeconds())+"."+zeropad(date.getMilliseconds(),3)},fluid.isTracing=!1,fluid.registerNamespace("fluid.tracing"),fluid.tracing.pathCount=[],fluid.tracing.summarisePathCount=function(pathCount){pathCount=pathCount||fluid.tracing.pathCount;for(var togo={},i=0;i<pathCount.length;++i){var path=pathCount[i];togo[path]?++togo[path]:togo[path]=1}var toReallyGo=[];return fluid.each(togo,(function(el,path){toReallyGo.push({path:path,count:el})})),toReallyGo.sort((function(a,b){return b.count-a.count})),toReallyGo},fluid.tracing.condensePathCount=function(prefixes,pathCount){prefixes=fluid.makeArray(prefixes);var prefixCount={};fluid.each(prefixes,(function(prefix){prefixCount[prefix]=0}));var togo=[];return fluid.each(pathCount,(function(el){var path=el.path;fluid.find(prefixes,(function(prefix){if(0===path.indexOf(prefix))return prefixCount[prefix]+=el.count,!0}))||togo.push(el)})),fluid.each(prefixCount,(function(count,path){togo.unshift({path:path,count:count})})),togo},fluid.obtainException=function(){return new Error("Trace exception")},fluid.registerNamespace("fluid.exceptionDecoders"),fluid.decodeStack=function(){var e=fluid.obtainException();return fluid.exceptionDecoders.standard(e)},fluid.exceptionDecoders.standard=function(e){var lines=e.stack.replace(/(?:\n@:0)?\s+$/m,"").replace(/^\(/gm,"{anonymous}(").split("\n");return fluid.transform(lines,(function(line){var atind=(line=line.replace(/\)/g,"")).indexOf("at ");return-1===atind?[line]:[line.substring(atind+3),line.substring(0,atind)]}))},fluid.getCallerInfo=function(atDepth){atDepth=atDepth||3;var stack=fluid.decodeStack(),element=stack&&stack[atDepth]&&stack[atDepth][0];if(element){var lastslash=element.lastIndexOf("/");-1===lastslash&&(lastslash=0);var nextColon=element.indexOf(":",lastslash);return{path:element.substring(0,lastslash),filename:element.substring(lastslash+1,nextColon),index:element.substring(nextColon+1)}}return null},fluid.generatePadding=function(c,count){for(var togo="",i=0;i<count;++i)togo+=c;return togo},fluid.SYNTHETIC_PROPERTY=Object.freeze({}),fluid.getSafeProperty=function(obj,key){var desc=Object.getOwnPropertyDescriptor(obj,key);return desc&&!desc.get?obj[key]:fluid.SYNTHETIC_PROPERTY},fluid.prettyPrintJSONImpl=function(obj,small,options){function out(str){options.output+=str}var big=small+options.indentChars,isFunction="function"==typeof obj;if(void 0!==options.maxRenderChars&&options.output.length>options.maxRenderChars)return!0;if(null===obj)out("null");else if(void 0===obj)out("undefined");else if(obj===fluid.SYNTHETIC_PROPERTY)out("[Synthetic property]");else if(fluid.isPrimitive(obj)&&!isFunction)out(JSON.stringify(obj));else{if(-1!==options.stack.indexOf(obj))return void out("(CIRCULAR)");var i;if(options.stack.push(obj),fluid.isArrayable(obj))if(0===obj.length)out("[]");else{for(out("[\n"+big),i=0;i<obj.length;++i){if(fluid.prettyPrintJSONImpl(obj[i],big,options))return!0;i!==obj.length-1&&out(",\n"+big)}out("\n"+small+"]")}else{out("{"+(isFunction?" Function":"")+"\n"+big);var keys=fluid.keys(obj);for(i=0;i<keys.length;++i){var key=keys[i],value=fluid.getSafeProperty(obj,key);if(out(JSON.stringify(key)+": "),fluid.prettyPrintJSONImpl(value,big,options))return!0;i!==keys.length-1&&out(",\n"+big)}out("\n"+small+"}")}options.stack.pop()}},fluid.prettyPrintJSON=function(obj,options){return(options=$.extend({indent:4,stack:[],output:""},options)).indentChars=fluid.generatePadding(" ",options.indent),fluid.prettyPrintJSONImpl(obj,"",options),options.output},fluid.dumpEl=function(element){var togo;if(!element)return"null";if(3===element.nodeType||8===element.nodeType)return"[data: "+element.data+"]";if(9===element.nodeType)return"[document: location "+element.location+"]";if(!element.nodeType&&fluid.isArrayable(element)){togo="[";for(var i=0;i<element.length;++i)togo+=fluid.dumpEl(element[i]),i<element.length-1&&(togo+=", ");return togo+"]"}return togo=(element=$(element)).get(0).tagName,element.id&&(togo+="#"+element.id),element.attr("class")&&(togo+="."+element.attr("class")),togo},fluid.debugger=function(){},fluid.defaults("fluid.debuggingProbe",{gradeNames:["fluid.component"]}),fluid.probeToDistribution=function(probe){var instantiator=fluid.globalInstantiator,parsed=fluid.parseContextReference(probe.target),segs=fluid.model.parseToSegments(parsed.path,instantiator.parseEL,!0);"options"!==segs[0]&&segs.unshift("options");var parsedPriority=fluid.parsePriority(probe.priority);return parsedPriority.constraint&&!parsedPriority.constraint.target&&(parsedPriority.constraint.target="authoring"),{target:"{/ "+parsed.context+"}."+instantiator.composeSegments.apply(null,segs),record:{func:probe.func,funcName:probe.funcName,args:probe.args,priority:fluid.renderPriority(parsedPriority)}}},fluid.registerProbes=function(probes){var probeDistribution=fluid.transform(probes,fluid.probeToDistribution),memberName="fluid_debuggingProbe_"+fluid.allocateGuid();return fluid.construct([memberName],{type:"fluid.debuggingProbe",distributeOptions:probeDistribution}),memberName},fluid.deregisterProbes=function(probeName){fluid.destroy([probeName])};var fluid=fluid||{};async function applyOp(node,func){if(node=$(node)[0]){var promise=new Promise((function(resolve){node.addEventListener(func,resolve,{once:!0})}));return node[func](),promise}}fluid.uaMatch=function(ua){ua=ua.toLowerCase();var match=/(chrome)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[];return{browser:match[1]||"",version:match[2]||"0"}},fluid.assignJQueryBrowser=function($){if(!$.browser){var matched=fluid.uaMatch(navigator.userAgent),browser={};matched.browser&&(browser[matched.browser]=!0,browser.version=matched.version),browser.chrome?browser.webkit=!0:browser.webkit&&(browser.safari=!0),$.browser=browser}},fluid.assignJQueryBrowser(jQuery),fluid.getScopedData=function(target,key){var data=$(target).data("fluid-scoped-data");return data?data[key]:void 0},fluid.setScopedData=function(target,key,value){$(target).each((function(){var data=$.data(this,"fluid-scoped-data")||{};data[key]=value,$.data(this,"fluid-scoped-data",data)}))},fluid.lastFocusedElement=null,$(document).on("focusin",(function(event){fluid.lastFocusedElement=event.target})),fluid.enabled=function(target,state){if(target=$(target),void 0===state)return!1!==fluid.getScopedData(target,"enablement");$("*",target).add(target).each((function(){void 0!==fluid.getScopedData(this,"enablement")?fluid.setScopedData(this,"enablement",state):/select|textarea|input/i.test(this.nodeName)&&$(this).prop("disabled",!state)})),fluid.setScopedData(target,"enablement",state)},fluid.initEnablement=function(target){fluid.setScopedData(target,"enablement",!0)},fluid.resolveEventTarget=function(event){for(;event.originalEvent&&event.originalEvent.target;)event=event.originalEvent;return event.target},$.each(["focus","blur"],(function(i,name){fluid[name]=function(elem){return applyOp(elem,name)}})),fluid.visitComponentChildren=function(that,visitor,options,segs){segs=segs||[];var shadow=fluid.shadowForComponent(that);for(var name in shadow.childComponents){var component=shadow.childComponents[name];if(!options.visited||!options.visited[component.id]){if(segs.push(name),options.visited&&(options.visited[component.id]=!0),visitor(component,name,segs,segs.length-1))return!0;options.flat||fluid.visitComponentChildren(component,visitor,options,segs),segs.pop()}}},fluid.getContextHash=function(instantiator,that){var shadow=instantiator.idToShadow[that.id];return shadow&&shadow.contextHash},fluid.componentHasGrade=function(that,gradeName){var contextHash=fluid.getContextHash(fluid.globalInstantiator,that);return!(!contextHash||!contextHash[gradeName])},fluid.visitComponentsForMatching=function(that,options,visitor){var instantiator=fluid.getInstantiator(that);options=$.extend({visited:{},instantiator:instantiator},options);var thatStack=[that],contextHashes=[fluid.getContextHash(instantiator,that)];fluid.visitComponentChildren(that,(function(component,name,segs){thatStack.length=1,contextHashes.length=1;for(var i=0;i<segs.length;++i){var child=thatStack[i][segs[i]];thatStack[i+1]=child,contextHashes[i+1]=fluid.getContextHash(instantiator,child)||{}}return visitor(component,thatStack,contextHashes,segs,segs.length)}),options,[])},fluid.getMemberNames=function(instantiator,thatStack){if(0===thatStack.length)return[];var path=instantiator.idToPath(fluid.peek(thatStack).id),segs=instantiator.parseEL(path);return segs.unshift.apply(segs,fluid.generate(thatStack.length-segs.length,"")),segs},fluid.visitComponentsForVisibility=function(instantiator,thatStack,visitor,options){options=options||{visited:{},flat:!0,instantiator:instantiator};for(var memberNames=fluid.getMemberNames(instantiator,thatStack),i=thatStack.length-1;i>=0;--i){var that=thatStack[i];if(options.visited[that.id]=!0,visitor(that,memberNames[i],memberNames,i))return;if(fluid.visitComponentChildren(that,visitor,options,memberNames))return;memberNames.pop()}},fluid.mountStrategy=function(prefix,root,toMount){var offset=prefix.length;return function(target,name,i,segs){if(!(i<=prefix.length)){for(var j=0;j<prefix.length;++j)if(segs[j]!==prefix[j])return;return toMount(target,name,i-prefix.length,segs.slice(offset))}}},fluid.invokerFromRecord=function(invokerec,name,that){fluid.pushActivity("makeInvoker","beginning instantiation of invoker with name %name and record %record as child of %that",{name:name,record:invokerec,that:that});var invoker=invokerec?fluid.makeInvoker(that,invokerec,name):void 0;return fluid.popActivity(),invoker},fluid.memberFromRecord=function(memberrecs,name,that){for(var togo,shadow=fluid.shadowForComponent(that),i=0;i<memberrecs.length;++i){var expanded=fluid.expandImmediate(memberrecs[i],that,shadow.localRecord);togo=fluid.isPlainObject(togo)?$.extend(!0,togo,expanded):expanded}return togo},fluid.resourceFromRecord=function(resourceRec,name,that){var resourceFetcher=fluid.getForComponent(that,"resourceFetcher"),resourceSpec=resourceFetcher.resourceSpecs[name],oneFetcher=new fluid.fetchResources.FetchOne(resourceSpec,resourceFetcher),existing=that.resources[name];if(existing&&existing!==fluid.inEvaluationMarker)return existing;var promise=oneFetcher.resourceSpec.promise;return promise.disposition||fluid.currentTreeTransaction().pendingIO.push(promise),oneFetcher},fluid.recordStrategy=function(that,options,optionsStrategy,recordPath,recordMaker,prefix,exceptions){prefix=prefix||[];var fullyEvaluated=!1;return{strategy:function(target,name,i){if(1===i&&!fullyEvaluated){var record=fluid.driveStrategy(options,[recordPath,name],optionsStrategy);if(void 0===record){if(!(prefix.length>0))return;fluid.fail("Reference to "+recordPath+" record with name "+name+" which is not registered for component "+fluid.dumpComponentAndPath(that))}fluid.set(target,[name],fluid.inEvaluationMarker);var member=recordMaker(record,name,that);return fluid.set(target,[name],member),member}},initter:function(){var records=fluid.driveStrategy(options,recordPath,optionsStrategy)||{};for(var name in records)exceptions&&exceptions[name]||fluid.getForComponent(that,prefix.concat([name]));fullyEvaluated=!0}}},fluid.makeDistributionRecord=function(contextThat,sourceRecord,sourcePath,targetSegs,exclusions,sourceType){sourceType=sourceType||"distribution",fluid.pushActivity("makeDistributionRecord","Making distribution record from source record %sourceRecord path %sourcePath to target path %targetSegs",{sourceRecord:sourceRecord,sourcePath:sourcePath,targetSegs:targetSegs});var source=fluid.copy(fluid.get(sourceRecord,sourcePath));fluid.each(exclusions,(function(exclusion){fluid.model.applyChangeRequest(source,{segs:exclusion,type:"DELETE"})}));var record={options:{}};return fluid.model.applyChangeRequest(record,{segs:targetSegs,type:"ADD",value:source}),fluid.checkComponentRecord(record,fluid.componentRecordExpected),fluid.popActivity(),$.extend(record,{contextThat:contextThat,recordType:sourceType})},fluid.filterBlocks=function(contextThat,sourceBlocks,sourceSegs,targetSegs,exclusions,removeSource){var togo=[];return fluid.each(sourceBlocks,(function(block){var source=fluid.get(block.source,sourceSegs);if(void 0!==source){togo.push(fluid.makeDistributionRecord(contextThat,block.source,sourceSegs,targetSegs,exclusions,"distribution"));var rescued=$.extend({},source);removeSource&&fluid.model.applyChangeRequest(block.source,{segs:sourceSegs,type:"DELETE"}),fluid.each(exclusions,(function(exclusion){var orig=fluid.get(rescued,exclusion);fluid.set(block.source,sourceSegs.concat(exclusion),orig)}))}})),togo},fluid.noteCollectedDistribution=function(parentShadow,memberName,distribution){fluid.model.setSimple(parentShadow,["collectedDistributions",memberName,distribution.id],!0)},fluid.isCollectedDistribution=function(parentShadow,memberName,distribution){return fluid.model.getSimple(parentShadow,["collectedDistributions",memberName,distribution.id])},fluid.clearCollectedDistributions=function(parentShadow,memberName){fluid.model.applyChangeRequest(parentShadow,{segs:["collectedDistributions",memberName],type:"DELETE"})},fluid.collectDistributions=function(distributedBlocks,parentShadow,distribution,thatStack,contextHashes,memberNames,i){var lastMember=fluid.peek(memberNames);!fluid.isCollectedDistribution(parentShadow,lastMember,distribution)&&fluid.matchIoCSelector(distribution.selector,thatStack,contextHashes,memberNames,i)&&(distributedBlocks.push.apply(distributedBlocks,fluid.copy(distribution.blocks)),fluid.noteCollectedDistribution(parentShadow,lastMember,distribution))},fluid.registerCollectedClearer=function(shadow,parentShadow,memberName){!shadow.collectedClearer&&parentShadow&&(shadow.collectedClearer=function(){fluid.clearCollectedDistributions(parentShadow,memberName)})},fluid.receiveDistributions=function(parentThat,gradeNames,memberName,that){var instantiator=fluid.getInstantiator(parentThat||that),thatStack=instantiator.getThatStack(parentThat||that);thatStack.unshift(fluid.rootComponent);var memberNames=fluid.getMemberNames(instantiator,thatStack),shadows=fluid.transform(thatStack,(function(thisThat){return instantiator.idToShadow[thisThat.id]})),parentShadow=shadows[shadows.length-(parentThat?1:2)],contextHashes=fluid.getMembers(shadows,"contextHash");parentThat?(memberNames.push(memberName),contextHashes.push(fluid.gradeNamesToHash(gradeNames)),thatStack.push(that)):fluid.registerCollectedClearer(fluid.peek(shadows),parentShadow,fluid.peek(memberNames));for(var distributedBlocks=[],i=0;i<thatStack.length-1;++i)fluid.each(shadows[i].distributions,(function(distribution){fluid.collectDistributions(distributedBlocks,parentShadow,distribution,thatStack,contextHashes,memberNames,i)}));return distributedBlocks},fluid.computeTreeDistance=function(path1,path2){for(var i=0;i<path1.length&&i<path2.length&&path1[i]===path2[i];)++i;return path1.length+path2.length-2*i},fluid.computeDistributionPriority=function(targetThat,distributedBlock){if(!distributedBlock.priority){var instantiator=fluid.getInstantiator(targetThat),targetStack=instantiator.getThatStack(targetThat),targetPath=fluid.getMemberNames(instantiator,targetStack),sourceStack=instantiator.getThatStack(distributedBlock.contextThat),sourcePath=fluid.getMemberNames(instantiator,sourceStack),distance=fluid.computeTreeDistance(targetPath,sourcePath);distributedBlock.priority=fluid.mergeRecordTypes.distribution-distance}return distributedBlock},fluid.applyDistributions=function(that,preBlocks,targetShadow){var distributedBlocks=fluid.transform(preBlocks,(function(preBlock){return fluid.generateExpandBlock(preBlock,that,targetShadow.mergePolicy)}),(function(distributedBlock){return fluid.computeDistributionPriority(that,distributedBlock)})),mergeOptions=targetShadow.mergeOptions;return mergeOptions.mergeBlocks.push.apply(mergeOptions.mergeBlocks,distributedBlocks),mergeOptions.updateBlocks(),distributedBlocks},fluid.matchIoCSelector=function(selector,thatStack,contextHashes,memberNames,i){for(var thatpos=thatStack.length-1,selpos=selector.length-1;;){for(var isChild=selector[selpos].child,mustMatchHere=thatpos===thatStack.length-1||isChild,that=thatStack[thatpos],selel=selector[selpos],match=!0,j=0;j<selel.predList.length;++j){var pred=selel.predList[j],context=pred.context;if(context&&"*"!==context&&!contextHashes[thatpos][context]&&memberNames[thatpos]!==context){match=!1;break}if(pred.id&&that.id!==pred.id){match=!1;break}}if(0===selpos&&thatpos>i&&mustMatchHere&&isChild&&(match=!1),match){if(0===selpos)return!0;--thatpos,--selpos}else{if(mustMatchHere)return!1;--thatpos}if(thatpos<i)return!1}return!1},fluid.queryIoCSelector=function(root,selector,flat){var parsed=fluid.parseSelector(selector,fluid.IoCSSMatcher),togo=[];return fluid.visitComponentsForMatching(root,{flat:flat},(function(that,thatStack,contextHashes){fluid.matchIoCSelector(parsed,thatStack,contextHashes,[],1)&&togo.push(that)})),togo},fluid.isIoCSSSelector=function(context){return-1!==context.indexOf(" ")},fluid.pushDistributions=function(targetHead,selector,target,blocks){var targetShadow=fluid.shadowForComponent(targetHead),id=fluid.allocateGuid(),distribution={id:id,target:target,selector:selector,blocks:blocks};return Object.freeze(distribution),Object.freeze(distribution.blocks),distribution.blocks.forEach((function(block){fluid.freezeRecursive(block.options)})),fluid.pushArray(targetShadow,"distributions",distribution),id},fluid.clearDistribution=function(targetHeadId,id){var targetHeadShadow=fluid.globalInstantiator.idToShadow[targetHeadId];targetHeadShadow&&fluid.remove_if(targetHeadShadow.distributions,(function(distribution){return distribution.id===id}))},fluid.clearDistributions=function(shadow){fluid.each(shadow.outDistributions,(function(outDist){fluid.clearDistribution(outDist.targetHeadId,outDist.distributionId)}))},fluid.extractSelectorHead=function(parsedSelector){var predList=parsedSelector[0].predList,context=predList[0].context;return predList.length=0,context},fluid.parseExpectedOptionsPath=function(path,role){var segs=fluid.model.parseEL(path);return"options"!==segs[0]&&fluid.fail("Error in options distribution path ",path," - only "+role+' paths beginning with "options" are supported'),segs.slice(1)},fluid.replicateProperty=function(source,property,targets){void 0!==source[property]&&fluid.each(targets,(function(target){target[property]=source[property]}))},fluid.undistributableOptions=["gradeNames","distributeOptions","argumentMap","mergePolicy"],fluid.distributeOptionsOne=function(that,record,targetRef,selector,context){fluid.pushActivity("distributeOptions","parsing distributeOptions block %record %that ",{that:that,record:record});var targetHead=fluid.resolveContext(context,that);targetHead||fluid.fail("Error in options distribution record ",record," - could not resolve context {"+context+"} to a head component");var preBlocks,thatShadow=fluid.shadowForComponent(that),targetSegs=fluid.model.parseEL(targetRef.path);if(void 0!==record.record)preBlocks=[fluid.makeDistributionRecord(that,record.record,[],targetSegs,[])];else{var source=fluid.parseContextReference(record.source);"that"!==source.context&&fluid.fail("Error in options distribution record ",record," only a source context of {that} is supported");var sourceSegs=fluid.parseExpectedOptionsPath(source.path,"source"),fullExclusions=fluid.makeArray(record.exclusions).concat(0===sourceSegs.length?fluid.undistributableOptions:[]),exclusions=fluid.transform(fullExclusions,(function(exclusion){return fluid.model.parseEL(exclusion)}));preBlocks=fluid.filterBlocks(that,thatShadow.mergeOptions.mergeBlocks,sourceSegs,targetSegs,exclusions,record.removeSource),thatShadow.mergeOptions.updateBlocks()}if(fluid.replicateProperty(record,"priority",preBlocks),fluid.replicateProperty(record,"namespace",preBlocks),selector){var distributionId=fluid.pushDistributions(targetHead,selector,record.target,preBlocks);thatShadow.outDistributions=thatShadow.outDistributions||[],thatShadow.outDistributions.push({targetHeadId:targetHead.id,distributionId:distributionId})}else{var targetShadow=fluid.shadowForComponent(targetHead);fluid.applyDistributions(that,preBlocks,targetShadow)}fluid.popActivity()},fluid.distributeOptions=function(that,optionsStrategy){var records=fluid.driveStrategy(that.options,"distributeOptions",optionsStrategy);fluid.each(records,(function(record){"string"!=typeof record.target&&fluid.fail("Error in options distribution record ",record,' a member named "target" must be supplied holding an IoC reference'),"string"==typeof record.source^void 0===record.record&&fluid.fail("Error in options distribution record ",record,': must supply either a member "source" holding an IoC reference or a member "record" holding a literal record');var selector,context,targetRef=fluid.parseContextReference(record.target);(fluid.isIoCSSSelector(targetRef.context)?(selector=fluid.parseSelector(targetRef.context,fluid.IoCSSMatcher),context=fluid.extractSelectorHead(selector)):context=targetRef.context,"/"===context||"that"===context)?fluid.distributeOptionsOne(that,record,targetRef,selector,context):fluid.currentTreeTransaction().deferredDistributions.push({that:that,record:record,targetRef:targetRef,selector:selector,context:context})}))},fluid.contextName=1,fluid.memberName=2,fluid.gradeNamesToHash=function(gradeNames){var contextHash={};return fluid.each(gradeNames,(function(gradeName){fluid.isReferenceOrExpander(gradeName)||(contextHash[gradeName]=fluid.contextName,contextHash[fluid.computeNickName(gradeName)]=fluid.contextName)})),contextHash},fluid.applyToContexts=function(hash,key,disposition){var existing=hash[key];hash[key]=(existing||0)|disposition},fluid.applyToScope=function(scope,key,value,disposition){(!scope[key]||disposition&fluid.memberName)&&(scope[key]=value)},fluid.cacheShadowGrades=function(that,shadow){var contextHash=fluid.gradeNamesToHash(that.options&&that.options.gradeNames||[that.typeName]);fluid.applyToContexts(contextHash,shadow.memberName,fluid.memberName),shadow.contextHash=contextHash,fluid.each(contextHash,(function(disposition,context){shadow.ownScope[context]=that,shadow.parentShadow&&"fluid.rootComponent"!==shadow.parentShadow.that.typeName&&fluid.applyToScope(shadow.parentShadow.childrenScope,context,that,disposition)}))},fluid.deliverOptionsStrategy=function(that,target,mergeOptions){var shadow=fluid.shadowForComponent(that,shadow);fluid.cacheShadowGrades(that,shadow),shadow.mergeOptions=mergeOptions},fluid.collectDistributedGrades=function(rec){var distributedBlocks=fluid.receiveDistributions(null,null,null,rec.that);if(distributedBlocks.length>0){var readyBlocks=fluid.applyDistributions(rec.that,distributedBlocks,rec.shadow),gradeNamesList=fluid.transform(fluid.getMembers(readyBlocks,["source","gradeNames"]),fluid.makeArray);fluid.accumulateDynamicGrades(rec,fluid.flatten(gradeNamesList))}},fluid.applyDynamicGrades=function(rec){rec.oldGradeNames=fluid.makeArray(rec.gradeNames);var newDefaults=fluid.copy(fluid.getMergedDefaults(rec.that.typeName,rec.gradeNames));rec.gradeNames.length=0,rec.gradeNames.push.apply(rec.gradeNames,newDefaults.gradeNames),fluid.each(rec.gradeNames,(function(gradeName){fluid.isReferenceOrExpander(gradeName)||(rec.seenGrades[gradeName]=!0)}));var shadow=rec.shadow;fluid.cacheShadowGrades(rec.that,shadow),shadow.mergeOptions.destroyValue(["mergePolicy"]),shadow.mergeOptions.destroyValue(["components"]),shadow.mergeOptions.destroyValue(["invokers"]),rec.defaultsBlock.source=newDefaults,shadow.mergeOptions.updateBlocks(),shadow.mergeOptions.computeMergePolicy(),fluid.accumulateDynamicGrades(rec,newDefaults.gradeNames)},fluid.accumulateDynamicGrades=function(rec,newGradeNames){fluid.each(newGradeNames,(function(gradeName){var flatGradeName=fluid.flattenGradeName(gradeName);rec.seenGrades[flatGradeName]||(fluid.isReferenceOrExpander(gradeName)?(rec.rawDynamic.push(gradeName),rec.seenGrades[flatGradeName]=!0):rec.oldGradeNames.includes(gradeName)||rec.plainDynamic.push(gradeName))}))},fluid.accumulateContextAwareGrades=function(that,rec){var newContextAware=[];if(rec.gradeNames.includes("fluid.contextAware")){var contextAwarenessOptions=fluid.getForComponent(that,["options","contextAwareness"]);newContextAware=fluid.contextAware.check(that,contextAwarenessOptions);var lostGrade=fluid.find_if(rec.contextAware,(function(gradeName){return!newContextAware.includes(gradeName)}));lostGrade&&fluid.fail("Failure operating contextAwareness definition ",contextAwarenessOptions," for component "+fluid.dumpComponentAndPath(that)+": grade name "+lostGrade+" returned by an earlier round of checks was lost through a context change caused by a raw dynamic grade"),rec.contextAware=newContextAware}return newContextAware},fluid.computeDynamicGrades=function(that,shadow,strategy){delete that.options.gradeNames;var gradeNames=fluid.driveStrategy(that.options,"gradeNames",strategy);gradeNames.length=0;var rec={that:that,shadow:shadow,defaultsBlock:fluid.findMergeBlocks(shadow.mergeOptions.mergeBlocks,"defaults")[0],gradeNames:gradeNames,seenGrades:{},plainDynamic:[],contextAware:[],rawDynamic:[]};fluid.each(shadow.mergeOptions.mergeBlocks,(function(block){gradeNames.push.apply(gradeNames,fluid.makeArray(block.target&&block.target.gradeNames)),fluid.applyDynamicGrades(rec)})),fluid.collectDistributedGrades(rec);for(var checkContextAware=!0;;){for(;rec.plainDynamic.length>0;)gradeNames.push.apply(gradeNames,rec.plainDynamic),rec.plainDynamic.length=0,fluid.applyDynamicGrades(rec),fluid.collectDistributedGrades(rec);if(checkContextAware){var newContextAware=fluid.accumulateContextAwareGrades(that,rec);rec.plainDynamic=rec.plainDynamic.concat(newContextAware),checkContextAware=!1}else{if(!(rec.rawDynamic.length>0))break;var toexpand=rec.rawDynamic.shift(),expanded=fluid.expandImmediate(toexpand,that,shadow.localRecord);"function"==typeof expanded&&(expanded=expanded()),expanded&&(rec.plainDynamic=rec.plainDynamic.concat(expanded)),checkContextAware=!0}}fluid.remove_if(gradeNames,fluid.isReferenceOrExpander),shadow.collectedClearer&&(shadow.collectedClearer(),delete shadow.collectedClearer)},fluid.computeComponentAccessor=function(that,localRecord){var instantiator=fluid.globalInstantiator,shadow=fluid.shadowForComponent(that);shadow.localRecord=localRecord;var options=that.options,strategy=shadow.mergeOptions.strategy,optionsStrategy=fluid.mountStrategy(["options"],options,strategy);shadow.invokerStrategy=fluid.recordStrategy(that,options,strategy,"invokers",fluid.invokerFromRecord),shadow.eventStrategyBlock=fluid.recordStrategy(that,options,strategy,"events",fluid.eventFromRecord,["events"]);var eventStrategy=fluid.mountStrategy(["events"],that,shadow.eventStrategyBlock.strategy);if(shadow.memberStrategy=fluid.recordStrategy(that,options,strategy,"members",fluid.memberFromRecord,null,{model:!0,modelRelay:!0}),shadow.getConfig={strategies:[fluid.concreteStrategy,fluid.model.funcResolverStrategy,optionsStrategy,shadow.invokerStrategy.strategy,shadow.memberStrategy.strategy,eventStrategy]},fluid.computeDynamicGrades(that,shadow,strategy,shadow.mergeOptions.mergeBlocks),shadow.contextHash["fluid.resourceLoader"]){shadow.resourceStrategyBlock=fluid.recordStrategy(that,options,strategy,"resources",fluid.resourceFromRecord,["resources"]);var resourceStrategy=fluid.mountStrategy(["resources"],that,shadow.resourceStrategyBlock.strategy);shadow.getConfig.strategies.push(resourceStrategy),that.resources={}}if(fluid.distributeOptions(that,strategy),shadow.contextHash["fluid.resolveRoot"]){var memberName;if(shadow.contextHash["fluid.resolveRootSingle"]){var singleRootType=fluid.getForComponent(that,["options","singleRootType"]);singleRootType||fluid.fail("Cannot register object with grades "+Object.keys(shadow.contextHash).join(", ")+" as fluid.resolveRootSingle since it has not defined option singleRootType"),memberName=fluid.typeNameToMemberName(singleRootType)}else memberName=fluid.computeGlobalMemberName(that.typeName,that.id);var parent=fluid.resolveRootComponent;parent[memberName]&&instantiator.clearComponent(parent,memberName),instantiator.recordKnownComponent(parent,that,memberName,!1)}return shadow.getConfig},fluid.shadowForComponent=function(component){var instantiator=fluid.getInstantiator(component);return instantiator&&component?instantiator.idToShadow[component.id]:null},fluid.pathInEvaluation=function(path,paths){var index=paths.indexOf(path);return-1!==index&&index!==paths.length-1},fluid.getForComponent=function(component,path){var segs=fluid.model.pathToSegments(path);if(0===segs.length)return component;var instantiator=fluid.globalInstantiator,shadow=fluid.shadowForComponent(component);if(!shadow)return fluid.get(component,path);var next=fluid.get(component,segs[0],shadow.getConfig);if(fluid.isComponent(next))return fluid.getForComponent(next,segs.slice(1));var inEvaluationPaths=instantiator.inEvaluationPaths,inEvaluationPath=component.id+":"+path;if(!fluid.pathInEvaluation(inEvaluationPath,inEvaluationPaths)){inEvaluationPaths.push(inEvaluationPath);var togo=fluid.get(component,path,shadow.getConfig);return inEvaluationPaths.pop(),togo}fluid.fail("Error in component configuration - a circular reference was found during evaluation of path "+path+" for component "+fluid.dumpComponentAndPath(component)+": a circular set of references was found - for more details, see the activity records following this message in the console")},fluid.concreteStrategy=function(component,thisSeg,index,segs){var atval=component[thisSeg];return atval===fluid.inEvaluationMarker&&fluid.fail('Error in component configuration - a circular reference was found during evaluation of path segment "'+thisSeg+" of path ",segs,'": for more details, see the activity records following this message in the console, or issue fluid.setLogging(fluid.logLevel.TRACE) when running your application'),index>1?atval:void 0===atval&&component.hasOwnProperty(thisSeg)?fluid.NO_VALUE:atval},fluid.frameworkGrades=["fluid.component","fluid.modelComponent","fluid.viewComponent","fluid.rendererComponent"],fluid.filterBuiltinGrades=function(gradeNames){return fluid.remove_if(fluid.makeArray(gradeNames),(function(gradeName){return-1!==fluid.frameworkGrades.indexOf(gradeName)}))},fluid.dumpGradeNames=function(that){return that.options&&that.options.gradeNames?" gradeNames: "+JSON.stringify(fluid.filterBuiltinGrades(that.options.gradeNames)):""},fluid.dumpThat=function(that){return'{ typeName: "'+that.typeName+" id: "+that.id+'"'+fluid.dumpGradeNames(that)+"}"},fluid.dumpThatStack=function(thatStack,instantiator){return fluid.transform(thatStack,(function(that){var path=instantiator.idToPath(that.id);return fluid.dumpThat(that)+(path?" - path: "+path:"")})).join("\n")},fluid.dumpComponentPath=function(that){var path=fluid.pathForComponent(that);return path?fluid.pathUtil.composeSegments.apply(null,path):"** no path registered for component **"},fluid.dumpComponentAndPath=function(that){return"component "+fluid.dumpThat(that)+" at path "+fluid.dumpComponentPath(that)},fluid.resolveContext=function(context,that,fast){if("that"===context)return that;if("/"===context)return fluid.rootComponent;if("object"==typeof context){var innerContext=fluid.resolveContext(context.context,that,fast);fluid.isComponent(innerContext)||fluid.triggerMismatchedPathError(context.context,that);var rawValue=fluid.getForComponent(innerContext,context.path),expanded=fluid.expandOptions(rawValue,that);return fluid.isComponent(expanded)||fluid.fail("Unable to resolve recursive context expression "+fluid.renderContextReference(context)+": the directly resolved value of "+rawValue+" did not resolve to a component in the scope of "+fluid.dumpComponentAndPath(that)+": got ",expanded),expanded}var foundComponent,instantiator=fluid.globalInstantiator;if(fast)return instantiator.idToShadow[that.id].ownScope[context];var thatStack=instantiator.getFullStack(that);return fluid.visitComponentsForVisibility(instantiator,thatStack,(function(component,memberName){var scopeValue=fluid.shadowForComponent(component).contextHash[context];if(scopeValue&&scopeValue!==fluid.memberName||context===memberName)return foundComponent=component,!0})),foundComponent},fluid.triggerMismatchedPathError=function(parsed,parentThat){var ref=fluid.renderContextReference(parsed);fluid.fail("Failed to resolve reference "+ref+" - could not match context with name "+parsed.context+" from "+fluid.dumpComponentAndPath(parentThat))},fluid.makeStackFetcher=function(parentThat,localRecord,fast){return function(parsed){parentThat&&"destroyed"===parentThat.lifecycleStatus&&fluid.fail("Cannot resolve reference "+fluid.renderContextReference(parsed)+" from component "+fluid.dumpComponentAndPath(parentThat)+" which has been destroyed");var context=parsed.context;if(localRecord&&context in localRecord)return fluid.get(localRecord[context],parsed.path);var foundComponent=fluid.resolveContext(context,parentThat,fast);return foundComponent||""===parsed.path||fluid.triggerMismatchedPathError(parsed,parentThat),fluid.getForComponent(foundComponent,parsed.path)}},fluid.makeStackResolverOptions=function(parentThat,localRecord,fast){return $.extend(fluid.copy(fluid.rawDefaults("fluid.makeExpandOptions")),{ELstyle:"{}",localRecord:localRecord||{},fetcher:fluid.makeStackFetcher(parentThat,localRecord,fast),contextThat:parentThat,exceptions:{members:{model:!0,modelRelay:!0}}})},fluid.clearListeners=function(shadow){fluid.each(shadow.listeners,(function(rec){rec.event.removeListener(rec.listenerId||rec.listener)})),delete shadow.listeners},fluid.recordListener=function(event,listener,shadow,listenerId){event.ownerId!==shadow.that.id&&fluid.pushArray(shadow,"listeners",{event:event,listener:listener,listenerId:listenerId})},fluid.constructScopeObjects=function(instantiator,parent,child,childShadow){var parentShadow=parent?instantiator.idToShadow[parent.id]:null;childShadow.childrenScope=parentShadow?Object.create(parentShadow.ownScope):{},childShadow.ownScope=Object.create(childShadow.childrenScope),childShadow.parentShadow=parentShadow,childShadow.childComponents={},fluid.cacheShadowGrades(child,childShadow)},fluid.clearChildrenScope=function(parentShadow,child,childShadow,memberName){var keys=fluid.keys(childShadow.contextHash);keys.push(memberName),keys.forEach((function(context){parentShadow.childrenScope[context]===child&&delete parentShadow.childrenScope[context]}))},fluid.clearComponentIndexes=function(instantiator,destroyRec){var shadow=destroyRec.shadow;fluid.clearChildrenScope(shadow,destroyRec.child,destroyRec.childShadow,destroyRec.name),delete instantiator.pathToComponent[destroyRec.childPath],delete shadow.childComponents[destroyRec.name]},fluid.doDestroy=function(instantiator,destroyRec){var shadow=destroyRec.childShadow,that=destroyRec.child;for(var key in fluid.each(shadow.injectedPaths,(function(troo,injectedPath){var parentPath=fluid.model.getToTailPath(injectedPath),otherParent=instantiator.pathToComponent[parentPath];instantiator.clearComponent(otherParent,fluid.model.getTailPath(injectedPath),that)})),fluid.clearComponentIndexes(instantiator,destroyRec),fluid.clearDistributions(shadow),fluid.clearListeners(shadow),that.events)"afterDestroy"!==key&&"function"==typeof that.events[key].destroy&&that.events[key].destroy();that.applier&&that.applier.destroy(),that.lifecycleStatus="destroyed",fluid.fireEvent(destroyRec.child,"afterDestroy",[destroyRec.child,destroyRec.name,destroyRec.component]),delete instantiator.idToShadow[destroyRec.child.id]},fluid.instantiator=function(){var that=fluid.typeTag("instantiator");function recordComponent(parent,component,path,name,created){var shadow;if(created)(shadow=that.idToShadow[component.id]={}).that=component,shadow.path=path,shadow.memberName=name,fluid.constructScopeObjects(that,parent,component,shadow);else{(shadow=that.idToShadow[component.id]).injectedPaths=shadow.injectedPaths||{},shadow.injectedPaths[path]=!0;var parentShadow=that.idToShadow[parent.id],keys=fluid.keys(shadow.contextHash);fluid.remove_if(keys,(function(key){return shadow.contextHash&&shadow.contextHash[key]===fluid.memberName})),keys.push(name),keys.forEach((function(context){parentShadow.childrenScope.hasOwnProperty(context)||(parentShadow.childrenScope[context]=component)}))}that.pathToComponent[path]&&fluid.fail("Error during instantiation - path "+path+" which has just created component "+fluid.dumpThat(component)+" has already been used for component "+fluid.dumpThat(that.pathToComponent[path])+" - this is a circular instantiation or other oversight. Please clear the component using instantiator.clearComponent() before reusing the path."),that.pathToComponent[path]=component}return $.extend(that,{lifecycleStatus:"constructed",pathToComponent:{},idToShadow:{},modelTransactions:{},treeTransactions:{},inEvaluationPaths:[],currentTreeTransactionId:null,composePath:fluid.model.composePath,composeSegments:fluid.model.composeSegments,parseEL:fluid.model.parseEL,events:{onComponentAttach:fluid.makeEventFirer({name:"instantiator's onComponentAttach event"}),onComponentClear:fluid.makeEventFirer({name:"instantiator's onComponentClear event"}),onBeginTreeTransaction:fluid.makeEventFirer({name:"instantiator's onBeginTransaction event"}),onEndTreeTransaction:fluid.makeEventFirer({name:"instantiator's onEndTransaction event"})}}),that.parseToSegments=function(path){return fluid.model.parseToSegments(path,that.parseEL,!0)},that.idToPath=function(id){var shadow=that.idToShadow[id];return shadow?shadow.path:""},that.getThatStack=function(component){var shadow=that.idToShadow[component.id];if(shadow){for(var path=shadow.path,parsed=that.parseEL(path),root=that.pathToComponent[""],togo=[],i=0;i<parsed.length;++i)root=root[parsed[i]],togo.push(root);return togo}return[]},that.getFullStack=function(component){var thatStack=component?that.getThatStack(component):[];return thatStack.unshift(fluid.resolveRootComponent),thatStack},that.recordRoot=function(component){recordComponent(null,component,"","",!0)},that.recordKnownComponent=function(parent,component,name,created){if(parent[name]=component,fluid.isComponent(component)||"instantiator"===component.type){var parentShadow=that.idToShadow[parent.id];parentShadow.childComponents[name]=component;var path=that.composePath(parentShadow.path,name);recordComponent(parent,component,path,name,created),that.events.onComponentAttach.fire(component,path,that,created)}else fluid.fail("Cannot record non-component with value ",component,' at path "'+name+'" of parent ',parent)},that.clearComponent=function(component,name,child,options,nested,path){var shadow=that.idToShadow[component.id];options=options||{flat:!0,destroyRecs:[]},child=child||component[name],void 0===(path=path||shadow.path)&&fluid.fail("Cannot clear component "+name+" from component ",component," which was not created by this instantiator");var childPath=that.composePath(path,name),childShadow=that.idToShadow[child.id];if(childShadow){var created=childShadow.path===childPath;that.events.onComponentClear.fire(child,childPath,component,created);var destroyRec={child:child,childShadow:childShadow,name:name,component:component,shadow:shadow,childPath:childPath};created?(fluid.isDestroyed(child)&&fluid.fail('Cannot destroy component which is already in status "'+child.lifecycleStatus+'"'),child.lifecycleStatus="destroying",fluid.visitComponentChildren(child,(function(gchild,gchildname,segs,i){var parentPath=that.composeSegments.apply(null,segs.slice(0,i));that.clearComponent(child,gchildname,null,options,!0,parentPath)}),options,that.parseEL(childPath)),fluid.fireEvent(child,"onDestroy",[child,name||"",component]),options.destroyRecs.push(destroyRec)):(fluid.remove_if(childShadow.injectedPaths,(function(troo,path){return path===childPath})),fluid.clearComponentIndexes(that,destroyRec)),nested||(delete component[name],options.destroyRecs.forEach((function(destroyRec){fluid.doDestroy(that,destroyRec)})))}},that},fluid.globalInstantiator=fluid.instantiator(),fluid.getInstantiator=function(component){var instantiator=fluid.globalInstantiator;return component&&instantiator.idToShadow[component.id]?instantiator:null},fluid.defaults("fluid.resolveRoot"),fluid.defaults("fluid.resolveRootSingle",{gradeNames:"fluid.resolveRoot"}),fluid.constructRootComponents=function(instantiator){fluid.rootComponent=instantiator.rootComponent=fluid.typeTag("fluid.rootComponent"),instantiator.recordRoot(fluid.rootComponent),fluid.resolveRootComponent=instantiator.resolveRootComponent=fluid.typeTag("fluid.resolveRootComponent"),instantiator.recordKnownComponent(fluid.rootComponent,fluid.resolveRootComponent,"resolveRootComponent",!0);var rootShadow=instantiator.idToShadow[fluid.rootComponent.id];rootShadow.contextHash={};var resolveRootShadow=instantiator.idToShadow[fluid.resolveRootComponent.id];resolveRootShadow.ownScope=rootShadow.ownScope,resolveRootShadow.childrenScope=rootShadow.childrenScope,instantiator.recordKnownComponent(fluid.resolveRootComponent,instantiator,"instantiator",!0),resolveRootShadow.childrenScope.instantiator=instantiator},fluid.constructRootComponents(fluid.globalInstantiator),fluid.expandOptions=function(args,that,mergePolicy,localRecord,outerExpandOptions){if(!args)return args;fluid.pushActivity("expandOptions","expanding options %args for component %that ",{that:that,args:args});var expandOptions=fluid.makeStackResolverOptions(that,localRecord);expandOptions.mergePolicy=mergePolicy,expandOptions.defer=outerExpandOptions&&outerExpandOptions.defer;var expanded=expandOptions.defer?fluid.makeExpandOptions(args,expandOptions):fluid.expand(args,expandOptions);return fluid.popActivity(),expanded},fluid.computeMergeListPriority=function(toMerge){toMerge.forEach((function(record){var recordType=record.recordType;"distribution"!==recordType&&(record.priority=fluid.mergeRecordTypes[recordType]+(record.priorityDelta||0),Number.isInteger(record.priority)||fluid.fail("Merge record with unrecognised type "+recordType+": ",record))}))};var addPolicyBuiltins=function(policy){return fluid.each(["gradeNames","mergePolicy","argumentMap","components","dynamicComponents","events","listeners","modelListeners","modelRelay","distributeOptions","transformOptions"],(function(key){fluid.set(policy,[key,"*","noexpand"],!0)})),policy};fluid.generateExpandBlock=function(record,that,mergePolicy,localRecord){var expanded=fluid.expandOptions(record.options||{},record.contextThat||that,mergePolicy,localRecord,{defer:!0});return expanded.priority=record.priority,expanded.namespace=record.namespace,expanded.recordType=record.recordType,expanded},fluid.fabricateDestroyMethod=function(that){return function(){var currentTrans=fluid.currentTreeTransaction(),shadow=fluid.shadowForComponent(that),transRec=fluid.destroy(shadow.path);currentTrans||transRec.promise.then(null,(function(e){throw e}))}},fluid.typeNameToMemberName=function(typeName){return typeName.replace(/\./g,"_")},fluid.expandComponentOptions=function(mergePolicy,potentia,lightMerge,that){var toMerge=lightMerge.toMerge,container=fluid.lightMergeValue(toMerge,"container");return container&&toMerge.push({recordType:"distribution",priority:fluid.mergeRecordTypes.distribution,options:{container:container},contextThat:potentia.parentThat}),that.destroy=fluid.fabricateDestroyMethod(that),addPolicyBuiltins(mergePolicy),fluid.shadowForComponent(that).mergePolicy=mergePolicy,fluid.computeMergeListPriority(toMerge),fluid.transform(toMerge,(function(value){return fluid.generateExpandBlock(value,that,mergePolicy,potentia.localRecord)}))},fluid.computeDynamicComponentKey=function(recordKey,sourceKey){return recordKey+(0===sourceKey||"0"===sourceKey?"":"-"+sourceKey)},fluid.concludeAnyTreeTransaction=function(){var errorOut,instantiator=fluid.globalInstantiator,transactionId=instantiator.currentTreeTransactionId;if(transactionId&&(instantiator.treeTransactions[transactionId].promise.then(null,(function(e){errorOut=e})),fluid.commitPotentiae(transactionId),errorOut))throw errorOut},fluid.bindDeferredComponent=function(that,componentName,lightMerge,dynamicComponent){var eventName=lightMerge.createOnEvent,event=fluid.isIoCReference(eventName)?fluid.expandOptions(eventName,that):that.events[eventName];event&&event.addListener||fluid.fail("Error instantiating createOnEvent component with name "+componentName+" of parent "+fluid.dumpComponentAndPath(that)+" since event specification "+eventName+" could not be expanded to an event - got ",event);var shadow=fluid.shadowForComponent(that);dynamicComponent&&fluid.set(shadow,["dynamicComponentCount",componentName],0);var constructListener=function(){var key=dynamicComponent?fluid.computeDynamicComponentKey(componentName,shadow.dynamicComponentCount[componentName]++):componentName,localRecord={arguments:fluid.makeArray(arguments)};fluid.pushActivity("initDeferred","instantiating deferred component %componentName of parent %that due to event %eventName",{componentName:componentName,that:that,eventName:eventName});var freshLightMerge=fluid.copy(lightMerge);delete freshLightMerge.createOnEvent,fluid.registerConcreteSubPotentia(freshLightMerge,key,0,that,localRecord),fluid.popActivity()};event.addListener(constructListener),fluid.recordListener(event,constructListener,shadow),event.addListener(fluid.concludeAnyTreeTransaction,"fluid-componentConstruction","last:transaction"),fluid.recordListener(event,fluid.concludeAnyTreeTransaction,shadow)},fluid.markSubtree=function(instantiator,that,path,state){that.lifecycleStatus=state,fluid.visitComponentChildren(that,(function(child,name){var childPath=instantiator.composePath(path,name),childShadow=instantiator.idToShadow[child.id];childShadow&&childShadow.path===childPath&&fluid.markSubtree(instantiator,child,childPath,state)}),{flat:!0})},fluid.assessTreeConstruction=function(that,shadow){var instantiator=fluid.globalInstantiator,thatStack=instantiator.getThatStack(that),unstableUp=fluid.find_if(thatStack,(function(that){return"constructing"===that.lifecycleStatus}));unstableUp?that.lifecycleStatus="constructed":fluid.markSubtree(instantiator,that,shadow.path,"treeConstructed")},fluid.concludeComponentObservation=function(shadow){var that=shadow.that,mergeOptions=shadow.mergeOptions;fluid.pushActivity("concludeComponentObservation","constructing component of type %componentName at path %path",{componentName:that.typeName,path:shadow.path}),mergeOptions.evaluateFully=!0;for(var i=0;i<mergeOptions.mergeBlocks.length;++i)mergeOptions.mergeBlocks[i].initter();mergeOptions.initter(),delete that.options.mergePolicy,shadow.memberStrategy.initter(),shadow.invokerStrategy.initter(),fluid.freezeRecursive(that.options),fluid.each(shadow.lightMergeComponents,(function(lightMerge,key){lightMerge.createOnEvent&&fluid.bindDeferredComponent(that,key,lightMerge)})),fluid.each(shadow.lightMergeDynamicComponents,(function(lightMerge,key){lightMerge.createOnEvent&&fluid.bindDeferredComponent(that,key,lightMerge,!0)})),fluid.popActivity()},fluid.concludeComponentInit=function(shadow){var that=shadow.that;if(!fluid.isDestroyed(that))return that.lifecycleStatus="constructed",fluid.assessTreeConstruction(that,shadow),that.events.onCreate.fire(that),fluid.popActivity(),that},fluid.pushCreatePotentia=function(potentiaList,path,topush){var existing=potentiaList.pathToPotentia[path];if(!existing||existing.applied)return potentiaList.pathToPotentia[path]=topush,topush.records&&(topush.lightMerge=fluid.lightMergeRecords(topush.records),delete topush.records),topush;fluid.lightMergeRecords.pushRecords(existing,topush.records||topush.lightMerge.toMerge)},fluid.blankPotentiaList=function(){return{destroys:[],creates:[],activeCount:0,pathToPotentia:{}}},fluid.isInjectedComponentRecord=function(record){return"string"==typeof record||fluid.isPlainObject(record,!0)&&record.expander},fluid.lightMergeValue=function(records,member){var value;return records.forEach((function(record){var recValue=record[member];value=void 0===recValue?value:recValue})),value},fluid.lightMergeRecords=function(records){var togo={toMerge:[],isInjected:!1};return fluid.lightMergeRecords.pushRecords(togo,records),togo},fluid.lightMergeRecords.pushRecord=function(lightMerge,record){fluid.isInjectedComponentRecord(record)?(lightMerge.toMerge=[{injected:record}],lightMerge.isInjected=!0):(lightMerge.type=record.type||lightMerge.type,lightMerge.createOnEvent=record.createOnEvent||lightMerge.createOnEvent,lightMerge.source=record.source||lightMerge.source,lightMerge.sources=record.sources||lightMerge.sources,lightMerge.isInjected?lightMerge.toMerge=[record]:lightMerge.toMerge.push(record),lightMerge.isInjected=!1)},fluid.lightMergeRecords.pushRecords=function(lightMerge,records){records.forEach((function(record){fluid.lightMergeRecords.pushRecord(lightMerge,record)}))},fluid.instantiateEvents=function(shadow){var that=shadow.that;shadow.eventStrategyBlock.initter();var listeners=fluid.getForComponent(that,["options","listeners"]);fluid.mergeListeners(that,that.events,listeners);var errors=fluid.validateListenersImplemented(that);errors.length>0&&fluid.fail(fluid.transform(errors,(function(error){return["Error constructing component "+fluid.dumpComponentAndPath(that)+" - the listener for event "+error.name+" with namespace "+error.namespace+(error.componentSource?" which was defined in grade "+error.componentSource:"")+" needs to be overridden with a concrete implementation"]}))).join("\n")},fluid.initComponentShell=function(potentia,lightMerge){var instantiator=fluid.globalInstantiator,upDefaults=fluid.defaults(lightMerge.type),parentThat=potentia.parentThat,memberName=potentia.memberName,distributions=fluid.receiveDistributions(parentThat,upDefaults&&upDefaults.gradeNames,memberName,{});fluid.each(distributions,(function(distribution){fluid.computeDistributionPriority(parentThat,distribution),fluid.isPrimitive(distribution.priority)&&(distribution.priority=fluid.parsePriority(distribution.priority,0,!1,"options distribution"))})),fluid.sortByPriority(distributions),fluid.lightMergeRecords.pushRecords(lightMerge,distributions),upDefaults=fluid.defaults(lightMerge.type);var defaultCopy=fluid.copy(upDefaults);lightMerge.toMerge.unshift({options:defaultCopy,recordType:"defaults"});var that="fluid.emptySubcomponent"===lightMerge.type?null:fluid.typeTag(lightMerge.type,potentia.componentId);that&&(that.lifecycleStatus="constructing",instantiator.recordKnownComponent(parentThat,that,memberName,!0),fluid.mergeComponentOptions(that,potentia,lightMerge).exceptions={members:{model:!0,modelRelay:!0}},that.events={});return that},fluid.registerConcreteSubPotentia=function(lightMerge,key,componentDepth,parentShell,localRecord,transactionId){componentDepth=componentDepth||0;var newSegs=fluid.pathForComponent(parentShell).concat([key]);parentShell[key]&&fluid.registerPotentia({segs:newSegs,type:"destroy"},transactionId),lightMerge.toMerge=fluid.transform(lightMerge.toMerge,(function(toMerge){return $.extend({componentDepth:componentDepth+1,sourceComponentId:parentShell.id,recordType:"subcomponentRecord"},toMerge)})),lightMerge.type=fluid.expandImmediate(lightMerge.type,parentShell,localRecord);var subPotentia={type:"create",segs:newSegs,lightMerge:lightMerge,localRecord:localRecord};fluid.registerPotentia(subPotentia,transactionId)},fluid.lightMergeComponentRecord=function(shadow,shadowKey,key,mergingArray){var lightMerge=fluid.lightMergeRecords(mergingArray);return fluid.set(shadow,[shadowKey,key],lightMerge),lightMerge},fluid.componentRecordExpected=fluid.arrayToHash(["type","options","container","createOnEvent"]),fluid.dynamicComponentRecordExpected=$.extend({},fluid.componentRecordExpected,fluid.arrayToHash(["source","sources"])),fluid.checkComponentRecord=function(localRecord,expected){fluid.isInjectedComponentRecord(localRecord)||(fluid.isPlainObject(localRecord,!0)?fluid.each(localRecord,(function(value,key){expected[key]||fluid.fail("Error in subcomponent record "+JSON.stringify(localRecord)+' - key "'+key+'" found, where the only legal options are '+fluid.keys(expected).join(", "))})):fluid.fail("Error in subcomponent record "+JSON.stringify(localRecord)+' - this should either be an object with member "type" or else a reference to another component'))},fluid.checkSubcomponentRecords=function(subcomponentRecords,expected){subcomponentRecords.forEach((function(oneRecord){fluid.checkComponentRecord(oneRecord,expected)}))},fluid.registerSourcedDynamicComponent=function(potentia,shell,source,sourceKey,lightMerge,key,localRecordContributor){var localRecord=$.extend({},potentia.localRecord,{source:source,sourcePath:sourceKey});(localRecordContributor||fluid.identity)(localRecord,source,sourceKey);var dynamicKey=fluid.computeDynamicComponentKey(key,sourceKey),freshLightMerge=fluid.copy(lightMerge);fluid.registerConcreteSubPotentia(freshLightMerge,dynamicKey,potentia.componentDepth,shell,localRecord)},fluid.registerSourcedDynamicComponents=function(potentia,shell,sources,lightMerge,key,localRecordContributor){fluid.each(sources,(function(source,sourceKey){fluid.registerSourcedDynamicComponent(potentia,shell,source,sourceKey,lightMerge,key,localRecordContributor)}))},fluid.lensedComponentModelListener=function(that,key,segs,value,isBoolean){var isEmptyValue=function(value){return isBoolean?!value:void 0===value},shadow=fluid.shadowForComponent(that),sourceKey=isBoolean?0:fluid.peek(segs),currentComponent=that[fluid.computeDynamicComponentKey(key,sourceKey)];if(isEmptyValue(value)||currentComponent)isEmptyValue(value)&&currentComponent&&currentComponent.destroy();else{var lightMerge=shadow.lightMergeDynamicComponents[key],parentRecord=shadow.modelSourcedDynamicComponents[key];fluid.registerSourcedDynamicComponent(shadow.potentia,that,value,sourceKey,lightMerge,key,parentRecord.localRecordContributor)}},fluid.lensedComponentDefToBlock=function(key,sourcesParsed,isBoolean){var fromModelPath=sourcesParsed.segs.slice(1),modelListener={path:{context:sourcesParsed.context,segs:fromModelPath.concat(isBoolean?[]:["*"])},excludeSource:"init",transactional:!0,funcName:"fluid.lensedComponentModelListener",args:["{that}",key,"{change}.path","{change}.value",isBoolean]},modelListeners={};return modelListeners["lensedComponents-"+key]=modelListener,{modelListeners:modelListeners}},fluid.addLensedComponentBlocks=function(lensedComponentBlocks,potentia,shadow){var merged=fluid.extend.apply(null,[!0,{}].concat(lensedComponentBlocks));shadow.mergeOptions.mergeBlocks.push(fluid.generateExpandBlock({options:merged,recordType:"lensedComponents",priority:fluid.mergeRecordTypes.lensedComponents},shadow.that,shadow.mergePolicy,potentia.localRecord)),shadow.mergeOptions.updateBlocks()},fluid.pushMarkupSourcedDynamicComponentListener=function(shell,key,sourcesParsed,registerDynamicComponents){var namespace=shell.id+"-markupDynamicComponents-"+key,context=fluid.resolveContext(sourcesParsed.context,shell);if(context.events.onDomBind)context.events.onDomBind.addListener(registerDynamicComponents,namespace);else{var targetShadow=fluid.shadowForComponent(context);fluid.addLensedComponentBlocks([{listeners:{onDomBind:{namespace:namespace,listener:registerDynamicComponents}}}],{},targetShadow)}},fluid.expectExactlyOne=function(failStart,target,members){var found=0;members.forEach((function(member){void 0!==target[member]&&++found})),1!==found&&fluid.fail.apply(null,failStart.concat([" must contain exactly one member out of "+members.join(", ")]))},fluid.registerSourcedDynamicComponentsTriage=function(potentia,shell,sourceOrSources,lightMerge,key,isBoolean,localRecordContributor){isBoolean&&sourceOrSources?fluid.registerSourcedDynamicComponent(potentia,shell,sourceOrSources,0,lightMerge,key,localRecordContributor):fluid.registerSourcedDynamicComponents(potentia,shell,sourceOrSources,lightMerge,key,localRecordContributor)},fluid.processComponentShell=function(potentia,shell,transRec){var shadow=fluid.globalInstantiator.idToShadow[shell.id];shadow.potentia=potentia,shadow.createdTransactionId=transRec.transactionId;var mergeOptions=shadow.mergeOptions,components=fluid.driveStrategy(shell.options,"components",mergeOptions.strategy);fluid.each(components,(function(subcomponentRecords,key){fluid.checkSubcomponentRecords(subcomponentRecords,fluid.componentRecordExpected);var lightMerge=fluid.lightMergeComponentRecord(shadow,"lightMergeComponents",key,subcomponentRecords);lightMerge.createOnEvent||fluid.registerConcreteSubPotentia(lightMerge,key,potentia.componentDepth,shell,potentia.localRecord)}));var dynamicComponents=fluid.driveStrategy(shell.options,"dynamicComponents",mergeOptions.strategy),lensedComponentBlocks=[];fluid.each(dynamicComponents,(function(subcomponentRecords,key){fluid.checkSubcomponentRecords(subcomponentRecords,fluid.dynamicComponentRecordExpected);var lightMerge=fluid.lightMergeComponentRecord(shadow,"lightMergeDynamicComponents",key,subcomponentRecords);if(fluid.expectExactlyOne(["dynamicComponents records ",subcomponentRecords],lightMerge,["source","sources","createOnEvent"]),void 0!==lightMerge.sources||void 0!==lightMerge.source){var recordSources=lightMerge.sources,isBoolean=!1;if(void 0!==lightMerge.source&&(recordSources=lightMerge.source,isBoolean=!0),fluid.isIoCReference(recordSources)){var sourcesParsed=fluid.parseValidModelReference(shell,"dynamicComponents source",recordSources,!0),registerDynamicComponents=function(){var sources=fluid.getForComponent(sourcesParsed.that,sourcesParsed.segs);fluid.registerSourcedDynamicComponentsTriage(potentia,shell,sources,lightMerge,key,null,isBoolean)};sourcesParsed.nonModel?"dom"===sourcesParsed.segs[0]?fluid.pushMarkupSourcedDynamicComponentListener(shell,key,sourcesParsed,registerDynamicComponents):registerDynamicComponents():(fluid.set(shadow,["modelSourcedDynamicComponents",key],{sourcesParsed:sourcesParsed,isBoolean:isBoolean}),lensedComponentBlocks.push(fluid.lensedComponentDefToBlock(key,sourcesParsed,isBoolean)))}else{var sources=fluid.expandImmediate(recordSources,shell,potentia.localRecord);fluid.registerSourcedDynamicComponentsTriage(potentia,shell,sources,lightMerge,key,null,isBoolean)}}})),lensedComponentBlocks.length&&fluid.addLensedComponentBlocks(lensedComponentBlocks,potentia,shadow),transRec.deferredDistributions.length&&(transRec.pendingPotentiae.creates.push({type:"distributeOptions",distributions:transRec.deferredDistributions}),++transRec.pendingPotentiae.activeCount,transRec.deferredDistributions=[])},fluid.preparePathedPotentia=function(potentia,instantiator){var segs=potentia.segs||instantiator.parseToSegments(potentia.path);potentia.segs=segs,potentia.memberName=fluid.peek(segs),potentia.parentThat=fluid.getImmediate(fluid.rootComponent,segs.slice(0,-1)),"create"!==potentia.type||potentia.parentThat||fluid.fail("Cannot construct component at path ",segs," whose parent does not exist")},fluid.fetchNestedInjectedComponentReference=function(transRec,potentiaList,injected,head,parentPath,segs){for(var instantiator=fluid.globalInstantiator,path=parentPath,current=head,i=0;i<segs.length;++i){if(path=fluid.composePath(path,segs[i]),!(current=instantiator.pathToComponent[path])){var upcoming=potentiaList.pathToPotentia[path];upcoming&&(upcoming.applied?fluid.fail("Circular reference found when resolving injected component reference ",injected," - the target of the reference is still in construction"):(current=fluid.operateCreatePotentia(transRec,upcoming))&&(path=instantiator.idToShadow[current.id].path))}current||i===segs.length-1||fluid.fail("Failed to resolved injected component reference ",injected," - component at segment "+segs[i]+" was not found")}return current},fluid.fetchInjectedComponentReference=function(transRec,potentiaList,injected,parentThat){var instantiator=fluid.globalInstantiator;if(injected.expander)return fluid.expandImmediate(injected,parentThat,null,!0);var parsed=fluid.parseContextReference(injected),head=fluid.resolveContext(parsed.context,parentThat);if(head){var parentPath=instantiator.idToShadow[head.id].path,segs=fluid.model.parseEL(parsed.path);return fluid.fetchNestedInjectedComponentReference(transRec,potentiaList,injected,head,parentPath,segs)}if(""===parsed.path)return head;fluid.fail("Error in injected component reference ",injected," - could not resolve context {"+parsed.context+"} to a head component")},fluid.operateCreatePotentia=function(transRec,potentia){var instantiator=fluid.globalInstantiator,potentiaList=transRec.pendingPotentiae;fluid.preparePathedPotentia(potentia,instantiator);var shell,memberName=potentia.memberName,parentThat=potentia.parentThat;fluid.pushActivity("operateCreatePotentia",'operating create potentia for path "%path" with records %records',{path:potentia.path,records:potentia.records}),potentia.applied=!0,--potentiaList.activeCount;var lightMerge=potentia.lightMerge;if(lightMerge.isInjected)parentThat[memberName]=fluid.inEvaluationMarker,(shell=fluid.fetchInjectedComponentReference(transRec,potentiaList,lightMerge.toMerge[0].injected,parentThat))?instantiator.recordKnownComponent(parentThat,shell,memberName,!1):delete parentThat[memberName];else if(lightMerge.type){if(shell=fluid.initComponentShell(potentia,lightMerge)){fluid.processComponentShell(potentia,shell,transRec);var shadow=instantiator.idToShadow[shell.id];transRec.outputShadows.push(shadow)}}else fluid.fail("Unrecognised material in place of subcomponent "+memberName+" - could not recognise the records ",potentia.records," as designating either an injected or concrete component");return fluid.pushPotentia(transRec.restoreRecords,instantiator,{type:"destroy",segs:potentia.segs}),fluid.popActivity(),shell},fluid.operateDestroyPotentia=function(transRec,potentia,instantiator){instantiator=instantiator||fluid.globalInstantiator,fluid.preparePathedPotentia(potentia,instantiator);var that=fluid.getImmediate(fluid.rootComponent,potentia.segs);that&&instantiator.clearComponent(potentia.parentThat,potentia.memberName,that)},fluid.lookupWorkflowStage=function(workflowName){if(!workflowName)return fluid.workflowCacheSorted.length;if("shells"===workflowName)return 0;var found=fluid.find_if(fluid.workflowCacheSorted,(function(workflowEntry){return workflowEntry.workflowName===workflowName}));if(found)return found.index+1;fluid.fail("Unknown workflow name "+workflowName+' supplied as "breakAt" for tree transaction: : valid names are '+fluid.getMembers(fluid.workflowCacheSorted,"workflowName").join(", "))},fluid.evaluateWorkflows=function(shadows,workflowType){var togo=[];return fluid.workflowCacheSorted[workflowType].forEach((function(workflowRecord){shadows.filter((function(oneShadow){return fluid.componentHasGrade(oneShadow.that,workflowRecord.gradeName)})).length>0&&togo.push({shadows:shadows,workflowIndex:workflowRecord.index,workflowOptions:workflowRecord.workflowOptions})})),togo},fluid.findWorkflowShadows=function(shadows,blockStart,blockEnd,workflowRecord){for(var workflowShadows=[],i=blockStart;i<blockEnd;++i)fluid.componentHasGrade(shadows[i].that,workflowRecord.gradeName)&&("global"===workflowRecord.workflowType?workflowShadows.push(shadows[i]):workflowShadows.unshift(shadows[i]));return workflowShadows},fluid.waitPendingIOTask=function(transRec){var sequence,waitIOTask=function(){return transRec.pendingIO.length?sequence=fluid.promise.sequence(transRec.pendingIO):null};return waitIOTask.taskName="waitIO",waitIOTask.sequence=sequence,waitIOTask},fluid.enqueueWorkflowBlock=function(transRec,shadows,workflowStart,workflowEnd,blockStart,blockEnd,sequencer){var workQueued=!1,instantiator=fluid.globalInstantiator,resumeCurrentTransaction=function(){instantiator.currentTreeTransactionId=transRec.transactionId};return transRec.lastWorkflowShadow=Math.max(transRec.lastWorkflowShadow,blockEnd),fluid.forEachInRange(fluid.workflowCacheSorted,workflowStart,workflowEnd,(function(workflowRecord,workflowIndex){if(0===workflowIndex)for(var i=blockStart;i<blockEnd;++i)fluid.instantiateEvents(shadows[i]);var workflowShadows=fluid.findWorkflowShadows(shadows,blockStart,blockEnd,workflowRecord);if(transRec.maximumWorkflowStage=Math.max(transRec.maximumWorkflowStage,workflowIndex+1),workflowShadows.length>0){var workflow=workflowRecord.workflowOptions,workflowFunc=fluid.getGlobalValue(workflow.funcName),sequence=sequencer.sources;if(workflow.waitIO&&sequence.push(fluid.waitPendingIOTask(transRec)),"global"===workflowRecord.workflowType){var globalWorkflowTask=function(){resumeCurrentTransaction(),workflowFunc(workflowShadows,transRec)};globalWorkflowTask.taskName=workflowRecord.namespace,sequence.push(globalWorkflowTask)}else{var localWorkflowTask=function(){resumeCurrentTransaction(),"concludeComponentInit"===workflowRecord.namespace&&(sequencer.hasStartedConcludeInit=!0),workflowShadows.forEach((function(shadow){workflowFunc(shadow,transRec)}))};localWorkflowTask.taskName=workflowRecord.namespace,sequence.push(localWorkflowTask)}workQueued=!0}})),transRec.maximumWorkflowStage===transRec.workflowStageBreak&&(transRec.maximumWorkflowStage=0,transRec.restartLastWorkflowShadow=transRec.lastWorkflowShadow),workQueued},fluid.applyWorkflowPhase=function(transRec,sequencer){var shadows=transRec.outputShadows;if(shadows.length>transRec.lastWorkflowShadow&&transRec.maximumWorkflowStage>0)return fluid.enqueueWorkflowBlock(transRec,shadows,0,transRec.maximumWorkflowStage,transRec.lastWorkflowShadow,shadows.length,sequencer),!0;if(transRec.maximumWorkflowStage<transRec.workflowStageBreak)for(var workflowStage=transRec.maximumWorkflowStage;workflowStage<transRec.workflowStageBreak;++workflowStage){var workQueued=fluid.enqueueWorkflowBlock(transRec,shadows,workflowStage,workflowStage+1,transRec.restartLastWorkflowShadow,shadows.length,sequencer);if(workQueued)return workQueued}return!1},fluid.commitPotentiaePhase=function(transRec){var pendingPotentiae=transRec.pendingPotentiae;pendingPotentiae.destroys.forEach((function(potentia){potentia.applied||(potentia.applied=!0,--pendingPotentiae.activeCount,fluid.operateDestroyPotentia(transRec,potentia))}));for(var i=0;i<pendingPotentiae.creates.length;++i){var potentia=pendingPotentiae.creates[i];potentia.applied||("create"===potentia.type?fluid.operateCreatePotentia(transRec,potentia):"distributeOptions"===potentia.type?(potentia.distributions.forEach((function(distro){fluid.distributeOptionsOne(distro.that,distro.record,distro.targetRef,distro.selector,distro.context)})),potentia.applied=!0,--pendingPotentiae.activeCount):fluid.fail("Unrecognised potentia type "+potentia.type))}},fluid.isPopulatedPotentiaList=function(potentiaList){return potentiaList.activeCount>0},fluid.commitPotentiae=function(transactionId,resumeSequencer){var instantiator=fluid.globalInstantiator,transRec=instantiator.treeTransactions[transactionId];++transRec.commitDepth;var lastWorkflowShadow=transRec.lastWorkflowShadow,rootSequencer=transRec.rootSequencer,sequencer=resumeSequencer;if(!sequencer){var topSequencer=fluid.getImmediate(fluid.peek(rootSequencer.sources),["sequencer"]);!topSequencer||topSequencer.hasStartedConcludeInit||topSequencer.promise.disposition?((sequencer=fluid.promise.makeSequencer([],{},fluid.promise.makeSequenceStrategy())).promise.sequencer=sequencer,rootSequencer.sources.push(sequencer.promise)):sequencer=topSequencer}return fluid.tryCatch((function(){fluid.isPopulatedPotentiaList(transRec.pendingPotentiae)&&fluid.commitPotentiaePhase(transRec),fluid.applyWorkflowPhase(transRec,sequencer)&&sequencer.sources.push((function(){sequencer.hasStartedConcludeInit?sequencer===fluid.peek(rootSequencer.sources).sequencer&&fluid.commitPotentiae(transactionId,null):fluid.commitPotentiae(transactionId,sequencer)})),sequencer.sequenceStarted||fluid.promise.resumeSequence(sequencer),rootSequencer.sequenceStarted||fluid.promise.resumeSequence(rootSequencer)}),(function(e){transRec.promise.disposition||transRec.promise.reject(e)})),--transRec.commitDepth,0!==transRec.commitDepth||resumeSequencer||(instantiator.currentTreeTransactionId=null),transRec.outputShadows[lastWorkflowShadow]},fluid.pushPotentia=function(potentiaList,instantiator,potentia){var segs=potentia.segs=potentia.segs||instantiator.parseToSegments(potentia.path),path=potentia.path=instantiator.composeSegments.apply(null,segs);if("destroy"===potentia.type)potentiaList.destroys.push(potentia),potentiaList.activeCount++,fluid.remove_if(potentiaList.creates,(function(create){if(!create.applied&&create.path.startsWith(potentia.path))return potentiaList.activeCount--,!0}));else{var newPotentia=potentia;"create"===potentia.type&&(newPotentia=fluid.pushCreatePotentia(potentiaList,path,potentia)),newPotentia&&(potentiaList.creates.push(potentia),potentiaList.activeCount++)}},fluid.pathForComponent=function(component,instantiator){var shadow=(instantiator=instantiator||fluid.getInstantiator(component)||fluid.globalInstantiator).idToShadow[component.id];return shadow?instantiator.parseEL(shadow.path):null},fluid.currentTreeTransaction=function(){var instantiator=fluid.globalInstantiator;return instantiator.treeTransactions[instantiator.currentTreeTransactionId]},fluid.clearTreeTransaction=function(transRec){transRec.rootSequencer=fluid.promise.makeSequencer([],{},fluid.promise.makeSequenceStrategy()),transRec.restoreRecords=fluid.blankPotentiaList(),transRec.initModelTransaction={},transRec.outputShadows=[],transRec.lastWorkflowShadow=0,transRec.maximumWorkflowStage=0,transRec.restartLastWorkflowShadow=0,transRec.deferredDistributions=[]},fluid.beginTreeTransaction=function(transactionOptions){var instantiator=fluid.globalInstantiator;instantiator.currentTreeTransactionId&&fluid.fail("Attempt to start new tree transaction when transaction "+instantiator.currentTreeTransactionId+" is already active");var transactionId=instantiator.currentTreeTransactionId=fluid.allocateGuid(),transRec=$.extend({transactionId:transactionId,workflowStageBreak:void 0,pendingPotentiae:fluid.blankPotentiaList(),commitDepth:0,cancelled:!1,cancellationError:null,pendingIO:[]},transactionOptions);fluid.clearTreeTransaction(transRec),transRec.promise=transRec.rootSequencer.promise;var onConclude=function(){instantiator.events.onEndTreeTransaction.fire(transRec),transRec.rootSequencer.promise.disposition&&(instantiator.currentTreeTransactionId=null,delete instantiator.treeTransactions[transactionId])};transRec.promise.then(onConclude,(function(err){transRec.cancelled||(delete transRec.rootSequencer,instantiator.inEvaluationPaths.length=0,fluid.cancelTreeTransaction(transactionId,instantiator,err),onConclude())})),instantiator.treeTransactions[transactionId]=transRec;try{transRec.workflowStageBreak=fluid.lookupWorkflowStage(transRec.breakAt)}catch(e){transRec.promise.reject(e)}return instantiator.events.onBeginTreeTransaction.fire(transRec),transRec},fluid.registerPotentia=function(potentia,transactionId){var instantiator=fluid.globalInstantiator;(transactionId=transactionId||instantiator.currentTreeTransactionId)||(transactionId=fluid.beginTreeTransaction().transactionId);var transRec=instantiator.treeTransactions[transactionId];return fluid.pushPotentia(transRec.pendingPotentiae,instantiator,potentia),transRec},fluid.cancelTreeTransaction=function(transactionId,instantiator){var transRec=instantiator.treeTransactions[transactionId];if(transRec)try{transRec.pendingPotentiae=transRec.restoreRecords,transRec.cancelled=!0,fluid.clearTreeTransaction(transRec),fluid.commitPotentiae(transactionId)}catch(e){throw fluid.log(fluid.logLevel.FAIL,"Fatal error cancelling transaction "+transactionId+": destroying all affected paths"),transRec.restoreRecords.creates.forEach((function(potentia){instantiator.clearComponent(potentia.parentThat,potentia.memberName,potentia.parentThat[potentia.memberName])})),e}},fluid.constructChild=function(parent,memberName,options){var path=fluid.pathForComponent(parent).concat([memberName]);return fluid.construct(path,options)},fluid.construct=function(path,componentOptions,constructOptions){constructOptions=constructOptions||{};var transRec=fluid.registerPotentia({path:path,type:"destroy"},constructOptions.transactionId),record={recordType:"user"};fluid.each(fluid.componentRecordExpected,(function(troo,key){void 0!==componentOptions[key]&&(record[key]=componentOptions[key])})),record.options=componentOptions;var potentia={path:path,type:"create",localRecord:constructOptions.localRecord,records:[record]};return fluid.registerPotentia(potentia,transRec.transactionId),constructOptions.transactionId||fluid.commitPotentiae(transRec.transactionId),fluid.adaptTransactionFailure(transRec),constructOptions.returnTransaction?transRec:fluid.getImmediate(fluid.rootComponent,potentia.segs)},fluid.destroy=function(path,instantiator){0===(instantiator=instantiator||fluid.globalInstantiator).parseToSegments(path).length&&fluid.fail("Cannot destroy the root component");var transRec=fluid.registerPotentia({path:path,type:"destroy"});return fluid.commitPotentiae(transRec.transactionId),transRec},fluid.constructSingle=function(parentPath,options,instantiator){instantiator=instantiator||fluid.globalInstantiator,parentPath=parentPath||"";var segs=fluid.model.parseToSegments(parentPath,instantiator.parseEL,!0);"string"==typeof options&&(options={type:options});var type=options.type;type||fluid.fail("Cannot construct singleton object without a type entry");var gradeNames=(options=$.extend({},options)).gradeNames=fluid.makeArray(options.gradeNames);gradeNames.unshift(type),options.type="fluid.component",0===segs.length&&gradeNames.push("fluid.resolveRoot");var memberName=fluid.typeNameToMemberName(options.singleRootType||type);return segs.push(memberName),fluid.construct(segs,options)},fluid.destroySingle=function(parentPath,typeName,instantiator){instantiator=instantiator||fluid.globalInstantiator;var segs=fluid.model.parseToSegments(parentPath,instantiator.parseEL,!0),memberName=fluid.typeNameToMemberName(typeName);segs.push(memberName),fluid.destroy(segs,instantiator)},fluid.makeGradeLinkage=function(linkageName,inputNames,outputNames){fluid.defaults(linkageName,{gradeNames:"fluid.component",distributeOptions:{record:outputNames,target:"{/ "+inputNames.join("&")+"}.options.gradeNames"}}),fluid.constructSingle([],linkageName)},fluid.componentForPath=function(path){return fluid.globalInstantiator.pathToComponent[fluid.isArrayable(path)?path.join("."):path]},fluid.thisistToApplicable=function(record,recthis,that){return{apply:function(noThis,args){var resolvedThis=fluid.expandImmediate(recthis,that);"string"==typeof resolvedThis&&(resolvedThis=fluid.getGlobalValue(resolvedThis)),resolvedThis||fluid.fail("Could not resolve reference "+recthis+" to a value");var resolvedFunc=resolvedThis[record.method];return"function"!=typeof resolvedFunc&&fluid.fail("Object ",resolvedThis," at reference "+recthis+" has no member named "+record.method+" which is a function "),fluid.passLogLevel(fluid.logLevel.TRACE)&&fluid.log(fluid.logLevel.TRACE,"Applying arguments ",args," to method "+record.method+" of instance ",resolvedThis),resolvedFunc.apply(resolvedThis,args)}}},fluid.changeToApplicable=function(record,that){fluid.getForComponent(that,"applier");var parsed=fluid.parseValidModelReference(that,"changePath listener record",record.changePath);return fluid.materialiseModelPath(parsed.that,parsed.modelSegs),{apply:function(noThis,args,localRecord,mergeRecord){var value;record.func||record.funcName?value=fluid.makeInvoker(that,fluid.filterKeys(record,["func","funcName","args"]),"changePath listener record",localRecord)():value=fluid.expandImmediate(record.value,that,fluid.extend(localRecord,{arguments:args}));var sources=mergeRecord&&mergeRecord.source&&mergeRecord.source.length?fluid.makeArray(record.source).concat(mergeRecord.source):record.source;parsed.applier.change(parsed.modelSegs,value,record.type,sources)}}},fluid.recordToApplicable=function(record,that,standard){if(void 0!==record.changePath)return fluid.changeToApplicable(record,that,standard);var recthis=record.this;return record.method^recthis&&fluid.fail("Record ",that,' must contain both entries "method" and "this" if it contains either'),record.method?fluid.thisistToApplicable(record,recthis,that):null},fluid.getGlobalValueNonComponent=function(funcName,context){var defaults=fluid.defaults(funcName);return defaults&&fluid.hasGrade(defaults,"fluid.component")&&fluid.fail("Error in function specification - cannot invoke function "+funcName+" in the context of "+context+": component creator functions can only be used as subcomponents"),fluid.getGlobalValue(funcName)},fluid.makeInvoker=function(that,invokerec,name,localRecord){void 0===(invokerec=fluid.upgradePrimitiveFunc(invokerec)).args||invokerec.args===fluid.NO_ARGUMENTS||fluid.isArrayable(invokerec.args)||(invokerec.args=fluid.makeArray(invokerec.args));var func=fluid.recordToApplicable(invokerec,that),invokePre=fluid.preExpand(invokerec.args);localRecord=localRecord||{};var expandOptions=fluid.makeStackResolverOptions(that,localRecord,!0);return(func=func||(invokerec.funcName?fluid.getGlobalValueNonComponent(invokerec.funcName,"an invoker"):fluid.expandImmediate(invokerec.func,that)))&&func.apply?func===fluid.notImplemented&&fluid.fail("Error constructing component "+fluid.dumpComponentAndPath(that)+" - the invoker named "+name+" which was defined in grade "+invokerec.componentSource+" needs to be overridden with a concrete implementation"):fluid.fail("Error in invoker record: could not resolve members func, funcName or method to a function implementation - got "+func+" from ",invokerec),function(){var togo,finalArgs;return!1===fluid.defeatLogging&&fluid.pushActivity("invokeInvoker","invoking invoker with name %name and record %record holding component %that",{name:name,record:invokerec,that:that}),"destroyed"===that.lifecycleStatus?fluid.log(fluid.logLevel.WARN,"Ignoring call to invoker "+name+" of component "+fluid.dumpComponentAndPath(that)+" which has been destroyed"):(localRecord.arguments=arguments,void 0===invokerec.args||invokerec.args===fluid.NO_ARGUMENTS?finalArgs=arguments:(fluid.expandImmediateImpl(invokePre,expandOptions),finalArgs=invokePre.source),togo=func.apply(null,finalArgs)),!1===fluid.defeatLogging&&fluid.popActivity(),togo}},fluid.event.makeTrackedListenerAdder=function(source){var shadow=fluid.shadowForComponent(source);return function(event){return{addListener:function(listener,namespace,priority,softNamespace,listenerId){fluid.recordListener(event,listener,shadow,listenerId),event.addListener.apply(null,arguments)}}}},fluid.event.listenerEngine=function(eventSpec,callback,adder){var argstruc={};fluid.each(eventSpec,(function(event,eventName){adder(event).addListener((function(){argstruc[eventName]=fluid.makeArray(arguments),function(){if(!fluid.find(eventSpec,(function(value,key){if(void 0===argstruc[key])return!0}))){var oldstruc=argstruc;argstruc={},callback(oldstruc)}}()}))}))},fluid.event.dispatchListener=function(that,listener,eventName,eventSpec,wrappedArgs){void 0===eventSpec.args||eventSpec.args===fluid.NO_ARGUMENTS||fluid.isArrayable(eventSpec.args)||(eventSpec.args=fluid.makeArray(eventSpec.args)),listener=fluid.event.resolveListener(listener);var dispatchPre=fluid.preExpand(eventSpec.args),localRecord={},expandOptions=fluid.makeStackResolverOptions(that,localRecord,!0),togo=function(){!1===fluid.defeatLogging&&fluid.pushActivity("dispatchListener","firing to listener to event named %eventName of component %that",{eventName:eventName,that:that});var finalArgs,args=wrappedArgs?arguments[0]:arguments;localRecord.arguments=args,void 0!==eventSpec.args&&eventSpec.args!==fluid.NO_ARGUMENTS?(fluid.expandImmediateImpl(dispatchPre,expandOptions),finalArgs=dispatchPre.source):finalArgs=args;var togo=listener.apply(null,finalArgs);return!1===fluid.defeatLogging&&fluid.popActivity(),togo};return fluid.event.impersonateListener(listener,togo),togo},fluid.event.resolveSoftNamespace=function(key){if("string"!=typeof key)return null;var lastpos=Math.max(key.lastIndexOf("."),key.lastIndexOf("}"));return key.substring(lastpos+1)},fluid.event.resolveListenerRecord=function(lisrec,that,eventName,namespace,standard){var badRec=function(record,extra){fluid.fail("Error in listener record - could not resolve reference ",record,' to a listener or firer. Did you miss out "events." when referring to an event firer?'+extra)};fluid.pushActivity("resolveListenerRecord","resolving listener record for event named %eventName for component %that",{eventName:eventName,that:that});var records=fluid.makeArray(lisrec),togo={records:fluid.transform(records,(function(record){var expanded=fluid.isPrimitive(record)||record.expander?{listener:record}:fluid.copy(record),methodist=fluid.recordToApplicable(record,that,standard);expanded.listener=methodist||(expanded.listener||expanded.func||expanded.funcName),expanded.listener||badRec(record,' Listener record must contain a member named "listener", "func", "funcName" or "method"');var softNamespace=record.method?fluid.event.resolveSoftNamespace(record.this)+"."+record.method:fluid.event.resolveSoftNamespace(expanded.listener);expanded.namespace||namespace||!softNamespace||(expanded.softNamespace=!0,expanded.namespace=(record.componentSource?record.componentSource:that.typeName)+"."+softNamespace);var listener=expanded.listener=fluid.expandOptions(expanded.listener,that);listener||badRec(record,"");var firer=!1;return"fluid.event.firer"===listener.typeName&&(listener=listener.fire,firer=!0),expanded.listener=standard&&(expanded.args&&"fluid.notImplemented"!==listener||firer)?fluid.event.dispatchListener(that,listener,eventName,expanded):listener,expanded.listenerId=fluid.allocateGuid(),expanded})),adderWrapper:standard?fluid.event.makeTrackedListenerAdder(that):null};return fluid.popActivity(),togo},fluid.event.expandOneEvent=function(that,event){var origin;return(origin="string"==typeof event&&"{"!==event.charAt(0)?fluid.getForComponent(that,["events",event]):fluid.expandOptions(event,that))&&"fluid.event.firer"===origin.typeName||fluid.fail("Error in event specification - could not resolve base event reference ",event," to an event firer: got ",origin),origin},fluid.event.expandEvents=function(that,event){return"string"==typeof event?fluid.event.expandOneEvent(that,event):fluid.transform(event,(function(oneEvent){return fluid.event.expandOneEvent(that,oneEvent)}))},fluid.event.resolveEvent=function(that,eventName,eventSpec){fluid.pushActivity("resolveEvent","resolving event with name %eventName attached to component %that",{eventName:eventName,that:that});var adder=fluid.event.makeTrackedListenerAdder(that);"string"==typeof eventSpec&&(eventSpec={event:eventSpec});var event="fluid.event.firer"===eventSpec.typeName?eventSpec:eventSpec.event||eventSpec.events;event||fluid.fail("Event specification for event with name "+eventName+" does not include a base event specification: ",eventSpec);var firer,origin="fluid.event.firer"===event.typeName?event:fluid.event.expandEvents(that,event),isMultiple="fluid.event.firer"!==origin.typeName;if(eventSpec.args||isMultiple){firer=fluid.makeEventFirer({name:" [composite] "+fluid.event.nameEvent(that,eventName)});var dispatcher=fluid.event.dispatchListener(that,firer.fire,eventName,eventSpec,isMultiple);isMultiple?fluid.event.listenerEngine(origin,dispatcher,adder):adder(origin).addListener(dispatcher)}else(firer={typeName:"fluid.event.firer"}).fire=function(){var outerArgs=fluid.makeArray(arguments);fluid.pushActivity("fireSynthetic","firing synthetic event %eventName ",{eventName:eventName});var togo=origin.fire.apply(null,outerArgs);return fluid.popActivity(),togo},firer.addListener=function(listener,namespace,priority,softNamespace,listenerId){var dispatcher=fluid.event.dispatchListener(that,listener,eventName,eventSpec);adder(origin).addListener(dispatcher,namespace,priority,softNamespace,listenerId)},firer.removeListener=function(listener){origin.removeListener(listener)},firer.originEvent=origin;return fluid.popActivity(),firer},fluid.coerceToPrimitive=function(string){return"false"!==string&&("true"===string||(isFinite(string)?Number(string):string))},fluid.compactStringToRec=function(string,type){var openPos=string.indexOf("("),closePos=string.indexOf(")");if((-1===openPos^-1===closePos||openPos>closePos)&&fluid.fail("Badly-formed compact "+type+" record without matching parentheses: "+string),-1!==openPos&&-1!==closePos){var trail=string.substring(closePos+1);""!==trail.trim()&&fluid.fail("Badly-formed compact "+type+" record "+string+" - unexpected material following close parenthesis: "+trail);var prefix=string.substring(0,openPos),body=string.substring(openPos+1,closePos).trim(),args=""===body?[]:fluid.transform(body.split(","),(function(str){return str.trim()}),fluid.coerceToPrimitive),togo=fluid.upgradePrimitiveFunc(prefix,null);return togo.args=args,togo}return"expander"===type&&fluid.fail("Badly-formed compact expander record without parentheses: "+string),string},fluid.expandPrefix="@expand:",fluid.expandCompactString=function(string,active){var rec=string;if(0===string.indexOf(fluid.expandPrefix)){var rem=string.substring(fluid.expandPrefix.length);rec={expander:fluid.compactStringToRec(rem,"expander")}}else active&&(rec=fluid.compactStringToRec(string,active));return rec};var singularPenRecord={listeners:"listener",modelListeners:"modelListener"},singularRecord=$.extend({invokers:"invoker"},singularPenRecord);fluid.expandCompactRec=function(segs,target,source){fluid.guardCircularExpansion(segs,segs.length);var pen=fluid.peek(segs),active=singularRecord[pen];!active&&segs.length>1&&(active=singularPenRecord[segs[segs.length-2]]),fluid.each(source,(function(value,key){if(fluid.isPlainObject(value))return target[key]=fluid.freshContainer(value),segs.push(key),fluid.expandCompactRec(segs,target[key],value),void segs.pop();"string"==typeof value&&(value=fluid.expandCompactString(value,active)),target[key]=value}))},fluid.expandCompact=function(options){var togo={};return fluid.expandCompactRec([],togo,options),togo},fluid.extractEL=function(string,options){if("ALL"===options.ELstyle||"{}"===options.ELstyle)return string;if(1===options.ELstyle.length){if(string.charAt(0)===options.ELstyle)return string.substring(1)}else if("${}"===options.ELstyle){var i1=string.indexOf("${"),i2=string.lastIndexOf("}");if(0===i1&&-1!==i2)return string.substring(2,i2)}},fluid.extractELWithContext=function(string,options){var EL=fluid.extractEL(string,options);return fluid.isIoCReference(EL)?fluid.parseContextReference(EL):"{}"===options.ELstyle?null:EL?{path:EL}:EL},fluid.parseContextReference=function(reference,index,delimiter){index=index||0;var endcpos,context,nested,isNested="{"===reference.charAt(index+1);-1===(endcpos=isNested?(nested=fluid.parseContextReference(reference,index+1,"}")).endpos:reference.indexOf("}",index+1))&&fluid.fail('Cannot parse context reference "'+reference+'": Malformed context reference without }'),context=isNested?nested:reference.substring(index+1,endcpos);var endpos=delimiter?reference.indexOf(delimiter,endcpos+1):reference.length,path=reference.substring(endcpos+1,endpos);return"."===path.charAt(0)&&(path=path.substring(1)),{context:context,path:path,endpos:endpos}},fluid.renderContextReference=function(parsed){var context=parsed.context;return"{"+(fluid.isPrimitive(context)?context:fluid.renderContextReference(context))+"}"+(parsed.path?"."+parsed.path:"")},fluid.resolveContextValue=function(string,options){function fetch(parsed){fluid.pushActivity("resolveContextValue","resolving context value %parsed",{parsed:parsed});var togo=options.fetcher(parsed);return fluid.pushActivity("resolvedContextValue","resolved value %parsed to value %value",{parsed:parsed,value:togo}),fluid.popActivity(2),togo}var parsed;if(options.bareContextRefs&&fluid.isIoCReference(string))return fetch(parsed=fluid.parseContextReference(string));if(options.ELstyle&&"${}"!==options.ELstyle&&(parsed=fluid.extractELWithContext(string,options)))return fetch(parsed);if("${}"===options.ELstyle)for(;"string"==typeof string;){var i1=string.indexOf("${"),i2=string.indexOf("}",i1+2);if(-1===i1||-1===i2)break;"{"===string.charAt(i1+2)?i2=(parsed=fluid.parseContextReference(string,i1+2,"}")).endpos:parsed={path:string.substring(i1+2,i2)};var subs=fetch(parsed),all=0===i1&&i2===string.length-1;if(null==subs)return subs;string=all?subs:string.substring(0,i1)+subs+string.substring(i2+1)}return string},fluid.fetchExpandChildren=function(target,i,segs,source,mergePolicy,options){if(source.expander){var expanded=fluid.expandExpander(target,source,options);if(fluid.isPrimitive(expanded)||!fluid.isPlainObject(expanded)||fluid.isArrayable(expanded)^fluid.isArrayable(target))return expanded;$.extend(!0,target,expanded)}return fluid.each(source,(function(newSource,key){void 0===newSource?target[key]=void 0:"expander"!==key&&(segs[i]=key,!0!==fluid.getImmediate(options.exceptions,segs,i)&&options.strategy(target,key,i+1,segs,source,mergePolicy))})),target},fluid.isUnexpandable=function(source){return fluid.isPrimitive(source)||!fluid.isPlainObject(source)},fluid.expandSource=function(options,target,i,segs,deliverer,source,policy,recurse){var expanded,isTrunk,thisPolicy=fluid.derefMergePolicy(policy);return"string"!=typeof source||thisPolicy.noexpand?thisPolicy.noexpand||fluid.isUnexpandable(source)?expanded=fluid.copy(source):source.expander?expanded=fluid.expandExpander(deliverer,source,options):(expanded=fluid.freshContainer(source),isTrunk=!0):options.defaultEL&&"{"!==source.charAt(0)?expanded=source:(fluid.pushActivity("expandContextValue","expanding context value %source held at path %path",{source:source,path:fluid.path.apply(null,segs.slice(0,i))}),expanded=fluid.copy(fluid.resolveContextValue(source,options)),fluid.popActivity(1)),expanded!==fluid.NO_VALUE&&deliverer(expanded),isTrunk&&recurse(expanded,source,i,segs,policy),expanded},fluid.guardCircularExpansion=function(segs,i){i>fluid.strategyRecursionBailout&&fluid.fail("Overflow/circularity in options expansion, current path is ",segs," at depth ",i,' - please ensure options are not circularly connected, or protect from expansion using the "noexpand" policy or expander')},fluid.makeExpandStrategy=function(options){var recurse=function(target,source,i,segs,policy){return fluid.fetchExpandChildren(target,i||0,segs||[],source,policy,options)},strategy=function(target,name,i,segs,source,policy){if(fluid.guardCircularExpansion(segs,i),target){if(target.hasOwnProperty(name))return target[name];void 0===source&&(source=fluid.regenerateCursor(options.source,segs,i-1,options.sourceStrategy),policy=fluid.regenerateCursor(options.mergePolicy,segs,i-1,fluid.concreteTrundler));var thisSource=options.sourceStrategy(source,name,i,segs),thisPolicy=fluid.concreteTrundler(policy,name);return fluid.expandSource(options,target,i,segs,(function(value){target[name]=value}),thisSource,thisPolicy,recurse)}};return options.recurse=recurse,options.strategy=strategy,strategy},fluid.defaults("fluid.makeExpandOptions",{ELstyle:"${}",bareContextRefs:!0,target:fluid.inCreationMarker}),fluid.makeExpandOptions=function(source,options){return(options=$.extend({},fluid.rawDefaults("fluid.makeExpandOptions"),options)).defaultEL="${}"===options.ELStyle&&options.bareContextRefs,options.expandSource=function(source){return fluid.expandSource(options,null,0,[],fluid.identity,source,options.mergePolicy,!1)},fluid.isUnexpandable(source)?(options.strategy=fluid.concreteTrundler,options.initter=fluid.identity,options.target="string"==typeof source?(options.defer?fluid.copy:fluid.identity)(options.expandSource(source)):source,options.immutableTarget=!0):(options.source=source,options.target=fluid.freshContainer(source),options.sourceStrategy=options.sourceStrategy||fluid.concreteTrundler,fluid.makeExpandStrategy(options),options.initter=function(){options.target=fluid.fetchExpandChildren(options.target,0,[],options.source,options.mergePolicy,options)}),options},fluid.expand=function(source,options){var expandOptions=fluid.makeExpandOptions(source,options);return expandOptions.initter(),expandOptions.target},fluid.preExpandRecurse=function(root,source,holder,member,rootSegs){function pushExpander(expander){root.expanders.push({expander:expander,holder:holder,member:member}),delete holder[member]}if(fluid.guardCircularExpansion(rootSegs,rootSegs.length),fluid.isIoCReference(source)){var parsed=fluid.parseContextReference(source),segs=fluid.model.parseEL(parsed.path);pushExpander({typeFunc:fluid.expander.fetch,context:parsed.context,segs:segs})}else fluid.isPlainObject(source)&&(source.expander?(source.expander.typeFunc=fluid.getGlobalValue(source.expander.type||"fluid.expander.invokeFunc"),pushExpander(source.expander)):fluid.each(source,(function(value,key){rootSegs.push(key),fluid.preExpandRecurse(root,value,source,key,rootSegs),rootSegs.pop()})))},fluid.preExpand=function(source){var root={expanders:[],source:fluid.isUnexpandable(source)?source:fluid.copy(source)};return fluid.preExpandRecurse(root,root.source,root,"source",[]),root},fluid.expandImmediate=function(source,that,localRecord,noproxy){var options=fluid.makeStackResolverOptions(that,localRecord,!0);options.noproxy=!!noproxy;var root=fluid.preExpand(source);return fluid.expandImmediateImpl(root,options),root.source},fluid.expandImmediateImpl=function(root,options){for(var expanders=root.expanders,i=0;i<expanders.length;++i){var expander=expanders[i];expander.holder[expander.member]=expander.expander.typeFunc(null,expander,options)}},fluid.expandExpander=function(deliverer,source,options){var expander=fluid.getGlobalValue(source.expander.type||"fluid.expander.invokeFunc");return expander||fluid.fail("Unknown expander with type "+source.expander.type),expander(deliverer,source,options)},fluid.proxyComponentHandler=function(target,prop){return prop===Symbol.toStringTag?Object.prototype.toString.call(target):prop in target?target[prop]:fluid.getForComponent(target,prop)},fluid.proxyComponent=function(component){var shadow=fluid.shadowForComponent(component);return shadow.proxy||(shadow.proxy=new Proxy(component,{get:fluid.proxyComponentHandler})),shadow.proxy},fluid.possiblyProxyComponent=function(value){return fluid.isComponent(value)&&"treeConstructed"!==value.lifecycleStatus?fluid.proxyComponent(value):value},fluid.proxyComponentArgs=function(args){args.forEach((function(arg,i){args[i]=fluid.possiblyProxyComponent(arg)}))},fluid.registerNamespace("fluid.expander"),fluid.expander.fetch=function(deliverer,source,options){var localRecord=options.localRecord,context=source.expander.context,segs=source.expander.segs,inLocal=void 0!==localRecord[context],contextStatus=options.contextThat.lifecycleStatus,fast="treeConstructed"===contextStatus||"destroyed"===contextStatus,component=inLocal?localRecord[context]:fluid.resolveContext(context,options.contextThat,fast);if(void 0!==component){var root=component;if(inLocal||"constructing"!==component.lifecycleStatus)for(var i=0;i<segs.length;++i)root=root?root[segs[i]]:void 0;else root=fluid.getForComponent(component,segs);return void 0!==root||inLocal||(root=fluid.getForComponent(component,segs)),fast||options.noproxy||!fluid.isComponent(root)?root:fluid.proxyComponent(root)}segs.length>0&&fluid.triggerMismatchedPathError(source.expander,options.contextThat)},fluid.expander.invokeFunc=function(deliverer,source,options){var expander=source.expander,args=fluid.makeArray(expander.args),whichFuncEntry=expander.func?"func":expander.funcName?"funcName":null;expander.args=args,args=options.recurse?options.recurse([],args):(expander=fluid.expandImmediate(expander,options.contextThat,options.localRecord,expander.noproxy)).args,expander.noproxy||fluid.proxyComponentArgs(args);var funcEntry=expander[whichFuncEntry],func=(options.expandSource?options.expandSource(funcEntry):funcEntry)||fluid.recordToApplicable(expander,options.contextThat);return"string"==typeof func&&(func=fluid.getGlobalValue(func)),func||fluid.fail("Error in expander record ",source.expander,": "+source.expander[whichFuncEntry]+" could not be resolved to a function for component ",options.contextThat),func.apply(null,args)},fluid.expander.noexpand=function(deliverer,source){return source.expander.value?source.expander.value:source.expander.tree},fluid.noexpand=fluid.expander.noexpand,fluid.model.makeEnvironmentStrategy=function(environment){return function(root,segment,index){return 0===index&&environment[segment]?environment[segment]:void 0}},fluid.model.defaultCreatorStrategy=function(root,segment){if(void 0===root[segment])return root[segment]={},root[segment]},fluid.model.defaultFetchStrategy=function(root,segment){return root[segment]},fluid.model.funcResolverStrategy=function(root,segment){if(root.resolvePathSegment)return root.resolvePathSegment(segment)},fluid.model.traverseWithStrategy=function(root,segs,initPos,config,uncess){for(var strategies=config.strategies,limit=segs.length-uncess,i=initPos;i<limit;++i){if(!root)return root;for(var accepted,j=0;j<strategies.length&&void 0===(accepted=strategies[j](root,segs[i],i+1,segs));++j);accepted===fluid.NO_VALUE&&(accepted=void 0),root=accepted}return root},fluid.model.getValueAndSegments=function(root,EL,config,initSegs){return fluid.model.accessWithStrategy(root,EL,fluid.NO_VALUE,config,initSegs,!0)},fluid.model.makeTrundler=function(config){return function(valueSeg,EL){return fluid.model.getValueAndSegments(valueSeg.root,EL,config,valueSeg.segs)}},fluid.model.getWithStrategy=function(root,EL,config,initSegs){return fluid.model.accessWithStrategy(root,EL,fluid.NO_VALUE,config,initSegs)},fluid.model.setWithStrategy=function(root,EL,newValue,config,initSegs){fluid.model.accessWithStrategy(root,EL,newValue,config,initSegs)},fluid.model.accessWithStrategy=function(root,EL,newValue,config,initSegs,returnSegs){if(fluid.isPrimitive(EL)||fluid.isArrayable(EL))return fluid.model.accessImpl(root,EL,newValue,config,initSegs,returnSegs,fluid.model.traverseWithStrategy);var key=EL.type||"default",resolver=config.resolvers[key];resolver||fluid.fail("Unable to find resolver of type "+key);var trundler=fluid.model.makeTrundler(config),valueSeg={root:root,segs:initSegs};return valueSeg=resolver(valueSeg,EL,trundler),EL.path&&valueSeg&&(valueSeg=trundler(valueSeg,EL.path)),returnSegs?valueSeg:valueSeg?valueSeg.root:void 0},fluid.registerNamespace("fluid.pathUtil"),fluid.pathUtil.getPathSegmentImpl=function(accept,path,i){var segment=null;accept&&(segment="");for(var escaped=!1,limit=path.length;i<limit;++i){var c=path.charAt(i);if(escaped)escaped=!1,null!==segment&&(segment+=c);else{if("."===c)break;"\\"===c?escaped=!0:null!==segment&&(segment+=c)}}return null!==segment&&(accept[0]=segment),i};var globalAccept=[];fluid.pathUtil.parseEL=function(path){for(var togo=[],index=0,limit=path.length;index<limit;){var firstdot=fluid.pathUtil.getPathSegmentImpl(globalAccept,path,index);togo.push(globalAccept[0]),index=firstdot+1}return togo},fluid.pathUtil.composeSegment=function(prefix,toappend){toappend=toappend.toString();for(var i=0;i<toappend.length;++i){var c=toappend.charAt(i);"."!==c&&"\\"!==c&&"}"!==c||(prefix+="\\"),prefix+=c}return prefix},fluid.pathUtil.escapeSegment=function(segment){return fluid.pathUtil.composeSegment("",segment)},fluid.pathUtil.composePath=function(prefix,suffix){return 0!==prefix.length&&(prefix+="."),fluid.pathUtil.composeSegment(prefix,suffix)},fluid.pathUtil.composeSegments=function(){for(var path="",i=0;i<arguments.length;++i)path=fluid.pathUtil.composePath(path,arguments[i]);return path},fluid.pathUtil.matchSegments=function(toMatch,segs,start,end){if(end-start!==toMatch.length)return!1;for(var i=start;i<end;++i)if(segs[i]!==toMatch[i-start])return!1;return!0},fluid.model.unescapedParser={parse:fluid.model.parseEL,compose:fluid.model.composeSegments},fluid.model.defaultGetConfig={parser:fluid.model.unescapedParser,strategies:[fluid.model.funcResolverStrategy,fluid.model.defaultFetchStrategy]},fluid.model.defaultSetConfig={parser:fluid.model.unescapedParser,strategies:[fluid.model.funcResolverStrategy,fluid.model.defaultFetchStrategy,fluid.model.defaultCreatorStrategy]},fluid.model.escapedParser={parse:fluid.pathUtil.parseEL,compose:fluid.pathUtil.composeSegments},fluid.model.escapedGetConfig={parser:fluid.model.escapedParser,strategies:[fluid.model.defaultFetchStrategy]},fluid.model.escapedSetConfig={parser:fluid.model.escapedParser,strategies:[fluid.model.defaultFetchStrategy,fluid.model.defaultCreatorStrategy]},fluid.stronglyConnected=function(vertices,accessor){var that={stack:[],accessor:accessor,components:[],index:0};return vertices.forEach((function(vertex){delete vertex.lowIndex,delete vertex.tarjanIndex,delete vertex.onStack})),vertices.forEach((function(vertex){void 0===vertex.tarjanIndex&&fluid.stronglyConnectedOne(vertex,that)})),that.components},fluid.stronglyConnectedOne=function(vertex,that){if(vertex.tarjanIndex=that.index,vertex.lowIndex=that.index,++that.index,that.stack.push(vertex),vertex.onStack=!0,that.accessor(vertex).forEach((function(outVertex){void 0===outVertex.tarjanIndex?(fluid.stronglyConnectedOne(outVertex,that),vertex.lowIndex=Math.min(vertex.lowIndex,outVertex.lowIndex)):outVertex.onStack&&(vertex.lowIndex=Math.min(vertex.lowIndex,outVertex.tarjanIndex))})),vertex.lowIndex===vertex.tarjanIndex){var outVertex,component=[];do{(outVertex=that.stack.pop()).onStack=!1,component.push(outVertex)}while(outVertex!==vertex);that.components.push(component)}},fluid.initRelayModel=function(that){return that.model},fluid.findInitModelTransaction=function(that){var transRec=fluid.currentTreeTransaction();if(transRec&&fluid.isComponent(that))return transRec.initModelTransaction[that.id]},fluid.enlistModelComponent=function(that){var treeTransaction=fluid.currentTreeTransaction(),transId=treeTransaction.initModelTransactionId,initModelTransaction=treeTransaction.initModelTransaction,enlist=initModelTransaction[that.id];if(!enlist){var shadow=fluid.shadowForComponent(that);enlist={that:that,applier:fluid.getForComponent(that,"applier"),initModels:[],completeOnInit:!!shadow.initTransactionId,transaction:that.applier.initiate(null,"init",transId)},initModelTransaction[that.id]=enlist,fluid.getModelTransactionRec(fluid.rootComponent,transId)[that.applier.applierId]={transaction:enlist.transaction},fluid.registerMaterialisationListener(that,that.applier)}return enlist},fluid.clearTransactions=function(){var instantiator=fluid.globalInstantiator;fluid.clear(instantiator.modelTransactions)},fluid.failureEvent.addListener(fluid.clearTransactions,"clearTransactions","before:fail"),fluid.clearLinkCounts=function(transRec,relaysAlso){fluid.each(transRec,(function(value,key){"number"==typeof value?transRec[key]=0:relaysAlso&&value.options&&"number"==typeof value.relayCount&&(value.relayCount=0)}))},fluid.computeInitialOutArcs=function(transacs,initModelTransaction){return fluid.transform(initModelTransaction,(function(recel,id){var oneOutArcs={},listeners=recel.that.applier.listeners.sortedListeners;fluid.each(listeners,(function(listener){if(listener.isRelay&&!fluid.isExcludedChangeSource(transacs[id],listener.cond)){var targetId=listener.targetId;targetId!==id&&(oneOutArcs[targetId]=!0)}}));var togo=Object.keys(oneOutArcs).map((function(id){return initModelTransaction[id]}));return fluid.remove_if(togo,(function(rec){return void 0===rec})),togo}))},fluid.sortCompleteLast=function(reca,recb){return(reca.completeOnInit?1:0)-(recb.completeOnInit?1:0)},fluid.subscribeResourceModelUpdates=function(that,resourceMapEntry){var treeTransaction=fluid.currentTreeTransaction(),resourceSpec=resourceMapEntry.resourceSpec,resourceUpdateListener=function(){var initTransaction=fluid.getImmediate(treeTransaction,["initModelTransaction",that.id]),trans=initTransaction?initTransaction.transaction:that.applier.initiate();if(resourceMapEntry.listeners.forEach((function(oneListener){var innerValue=fluid.getImmediate(resourceSpec,oneListener.resourceSegs),segs=oneListener.segs;trans.change(segs,null,"DELETE"),trans.change(segs,innerValue)})),initTransaction){var transRec=fluid.getModelTransactionRec(fluid.rootComponent,trans.id);fluid.clearLinkCounts(transRec,!0),that.applier.preCommit.fire(trans,that)}else trans.commit()};resourceSpec.onFetched.addListener(resourceUpdateListener),fluid.recordListener(resourceSpec.onFetched,resourceUpdateListener,fluid.shadowForComponent(that))},fluid.resolveResourceModelWorkflow=function(shadows,treeTransaction){var initModelTransaction=treeTransaction.initModelTransaction;shadows.forEach((function(shadow){var that=shadow.that;fluid.registerMergedModelListeners(that,that.options.modelListeners),fluid.each(shadow.modelSourcedDynamicComponents,(function(componentRecord,key){fluid.constructLensedComponents(shadow,initModelTransaction[that.id],componentRecord.sourcesParsed,key)}))}))},fluid.condenseResourceMap=function(resourceMap){var byId={};return resourceMap.forEach((function(resourceMapEntry){var resourceSpec=resourceMapEntry.fetchOne.resourceSpec,id=resourceSpec.transformEvent.eventId,existing=byId[id];existing||(existing=byId[id]={resourceSpec:resourceSpec,listeners:[]}),existing.listeners.push({resourceSegs:resourceMapEntry.fetchOne.segs,segs:resourceMapEntry.segs})})),byId},fluid.operateInitialTransaction=function(initModelTransaction,transId){var transacs=fluid.transform(initModelTransaction,(function(recel){return recel.transaction})),outArcs=fluid.computeInitialOutArcs(transacs,initModelTransaction),recs=fluid.values(initModelTransaction),components=fluid.stronglyConnected(recs,(function(initTransactionRecord){return outArcs[initTransactionRecord.that.id]})),priorityIndex=0;components.forEach((function(component){component.forEach((function(recel){recel.initPriority=recel.completeOnInit?1/0:priorityIndex++}))})),recs.sort((function(reca,recb){return reca.initPriority-recb.initPriority}));var transRec=fluid.getModelTransactionRec(fluid.rootComponent,transId);recs.forEach((function(recel){var that=recel.that,applier=recel.that.applier,transac=transacs[that.id];recel.completeOnInit?fluid.notifyModelChanges(applier.listeners.sortedListeners,"ADD",transac.oldHolder,fluid.emptyHolder,null,transac,applier,that):fluid.each(recel.initModels,(function(oneInitModel){void 0!==oneInitModel&&transac.fireChangeRequest({type:"ADD",segs:[],value:oneInitModel}),fluid.clearLinkCounts(transRec,!0)}))})),recs.forEach((function(recel){var that=recel.that,applier=recel.that.applier,transac=transacs[that.id];if(applier.preCommit.fire(transac,that),!recel.completeOnInit){var resourceMapById=fluid.condenseResourceMap(applier.resourceMap);fluid.each(resourceMapById,(function(resourceMapEntry){fluid.subscribeResourceModelUpdates(that,resourceMapEntry)})),applier.earlyModelResolved.fire(that.model),applier.preCommit.fire(transac,that),recel.completeOnInit=!0;var shadow=fluid.shadowForComponent(that);shadow&&!shadow.initTransactionId&&(shadow.initTransactionId=transId)}}))},fluid.parseModelReference=function(that,ref){var parsed=fluid.parseContextReference(ref);return parsed.segs=fluid.pathUtil.parseEL(parsed.path),parsed},fluid.parseValidModelReference=function(that,name,ref,permitNonModel){var parsed,contextTarget,target,localRecord=fluid.shadowForComponent(that).localRecord,reject=function(){var failArgs=["Error in "+name+": ",ref].concat(fluid.makeArray(arguments));fluid.fail.apply(null,failArgs)},rejectNonModel=function(value){reject(" must be a reference to a component with a ChangeApplier (descended from fluid.modelComponent), instead got ",value)};if("string"==typeof ref)if(fluid.isIoCReference(ref)){var modelPoint=(parsed=fluid.parseModelReference(that,ref)).segs.indexOf("model");-1===modelPoint?permitNonModel?parsed.nonModel=!0:reject(' must be a reference into a component model via a path including the segment "model"'):(parsed.modelSegs=parsed.segs.slice(modelPoint+1),parsed.contextSegs=parsed.segs.slice(0,modelPoint),delete parsed.path)}else parsed={path:ref,modelSegs:that.applier.parseEL(ref)};else fluid.isArrayable(ref.segs)||reject(' must contain an entry "segs" holding path segments referring a model path within a component'),parsed={context:ref.context,modelSegs:fluid.expandImmediate(ref.segs,that,localRecord)},fluid.each(parsed.modelSegs,(function(seg,index){fluid.isValue(seg)||reject(" did not resolve path segment reference "+ref.segs[index]+" at index "+index)}));return parsed.context?localRecord&&parsed.context in localRecord?"source"===parsed.context&&localRecord.sourceModelReference?(target=localRecord.sourceModelReference.that,parsed.modelSegs=localRecord.sourceModelReference.modelSegs.concat(parsed.segs),parsed.nonModel=!1):target=localRecord[parsed.context]:((contextTarget=fluid.resolveContext(parsed.context,that))||reject(" context must be a reference to an existing component"),target=parsed.contextSegs?fluid.getForComponent(contextTarget,parsed.contextSegs):contextTarget):target=that,parsed.nonModel||(fluid.isComponent(target)||rejectNonModel(target),target.applier||fluid.getForComponent(target,["applier"]),target.applier||rejectNonModel(target)),parsed.that=target,parsed.applier=target&&target.applier,!parsed.path&&parsed.applier&&(parsed.path=target&&parsed.applier.composeSegments.apply(null,parsed.modelSegs)),parsed},fluid.registerNamespace("fluid.materialiserRegistry"),fluid.matchMaterialiserSpec=function(record,segs){for(var trundle=record,routedPath=null,i=0;i<segs.length;++i){var seg=segs[i],wildcard=trundle["*"];if(wildcard&&(routedPath=wildcard),!(trundle=trundle[seg]||wildcard))break;if(trundle.materialiser)return trundle}return routedPath&&fluid.fail("Materialised DOM path ",segs," did not match any registered materialiser - available paths are "+Object.keys(routedPath).join(", ")),null},fluid.materialiseModelPath=function(that,segs){var shadow=fluid.shadowForComponent(that),materialisedPath=["materialisedPaths"].concat(segs);fluid.getImmediate(shadow,materialisedPath)||fluid.each(fluid.materialiserRegistry,(function(gradeRecord,grade){if(fluid.componentHasGrade(that,grade)){var record=fluid.matchMaterialiserSpec(gradeRecord,segs);if(record&&record.materialiser){fluid.model.setSimple(shadow,materialisedPath,{});var args=fluid.makeArray(record.args);fluid.invokeGlobalFunction(record.materialiser,[that,fluid.makeArray(segs)].concat(args))}}}))},fluid.materialiseAgainstValue=function(that,newValue,segs){fluid.isPlainObject(newValue)?fluid.each(newValue,(function(inner,seg){segs.push(seg),fluid.materialiseAgainstValue(that,inner,segs),segs.pop()})):fluid.materialiseModelPath(that,segs)},fluid.registerMaterialisationListener=function(that,applier){fluid.each(fluid.materialiserRegistry,(function(gradeRecord,grade){fluid.componentHasGrade(that,grade)&&fluid.each(gradeRecord,(function(rest,root){applier.modelChanged.addListener({transactional:!1,path:root},(function(newValue){var segs=[root];fluid.materialiseAgainstValue(that,newValue,segs)}))}))}))},fluid.getModelTransactionRec=function(that,transId){transId||fluid.fail("Cannot get transaction record without transaction id");var instantiator=fluid.isComponent(that)&&!fluid.isDestroyed(that,!0)?fluid.globalInstantiator:null;if(!instantiator)return null;var transRec=instantiator.modelTransactions[transId];return transRec||(transRec=instantiator.modelTransactions[transId]={relays:[],sources:{},externalChanges:{}}),transRec},fluid.recordChangeListener=function(component,applier,sourceListener,listenerId){var shadow=fluid.shadowForComponent(component);fluid.recordListener(applier.modelChanged,sourceListener,shadow,listenerId)},fluid.registerRelayTransaction=function(transRec,targetApplier,transId,options,npOptions){var newTrans=targetApplier.initiate("relay",null,transId),transEl=transRec[targetApplier.applierId]={transaction:newTrans,relayCount:0,namespace:npOptions.namespace,priority:npOptions.priority,options:options};return transEl.priority=fluid.parsePriority(transEl.priority,transRec.relays.length,!1,"model relay"),transRec.relays.push(transEl),transEl},fluid.relayRecursionBailout=100,fluid.registerDirectChangeRelay=function(target,targetSegs,source,sourceSegs,linkId,transducer,options,npOptions){var targetApplier=options.targetApplier||target.applier,sourceApplier=options.sourceApplier||source.applier;options.targetApplier||fluid.materialiseModelPath(target,targetSegs),options.sourceApplier||fluid.materialiseModelPath(source,sourceSegs);var applierId=targetApplier.applierId;targetSegs=fluid.makeArray(targetSegs),sourceSegs=fluid.makeArray(sourceSegs);var sourceListener=function(newValue,oldValue,path,changeRequest,trans,applier){var transId=trans.id,transRec=fluid.getModelTransactionRec(target,transId);applier&&trans&&!transRec[applier.applierId]&&(transRec[applier.applierId]={transaction:trans});var transEl=transRec[applierId];transRec[linkId]=transRec[linkId]||0;if(++transRec[linkId],transRec[linkId]>fluid.relayRecursionBailout&&fluid.fail("Error in model relay specification at component ",target," - operated more than "+fluid.relayRecursionBailout+" relays without model value settling - current model contents are ",trans.newHolder.model),transEl||(transEl=fluid.registerRelayTransaction(transRec,targetApplier,transId,options,npOptions)),transducer&&!options.targetApplier)fluid.pushActivity("relayTransducer",'computing modelRelay output for rule with target path "%targetSegs" and namespace "%namespace"',{targetSegs:targetSegs,namespace:npOptions.namespace}),transducer(transEl.transaction,options.sourceApplier?void 0:newValue,source,sourceSegs,targetSegs,changeRequest),fluid.popActivity();else if(changeRequest&&"DELETE"===changeRequest.type){var deleteSegs=targetSegs.concat(changeRequest.segs.slice(sourceSegs.length));transEl.transaction.fireChangeRequest({type:"DELETE",segs:deleteSegs})}else void 0!==newValue&&transEl.transaction.fireChangeRequest({type:"ADD",segs:targetSegs,value:newValue})},spec=sourceApplier.modelChanged.addListener({isRelay:!0,cond:transducer&&transducer.cond,targetId:target.id,targetApplierId:targetApplier.id,segs:sourceSegs,transactional:options.transactional},sourceListener);fluid.passLogLevel(fluid.logLevel.TRACE)&&fluid.log(fluid.logLevel.TRACE,"Adding relay listener with listenerId "+spec.listenerId+" to source applier with id "+sourceApplier.applierId+" from target applier with id "+applierId+" for target component with id "+target.id),source&&(fluid.recordChangeListener(source,sourceApplier,sourceListener,spec.listenerId),target!==source&&fluid.recordChangeListener(target,sourceApplier,sourceListener,spec.listenerId))},fluid.connectModelRelay=function(source,sourceSegs,target,targetSegs,options){var linkId=fluid.allocateGuid();fluid.enlistModelComponent(target),fluid.enlistModelComponent(source);var npOptions=fluid.filterKeys(options,["namespace","priority"]);options.update?options.targetApplier?fluid.registerDirectChangeRelay(source,sourceSegs,target,targetSegs,linkId,null,{transactional:!1,targetApplier:options.targetApplier,refCount:options.refCount,update:options.update},npOptions):fluid.registerDirectChangeRelay(target,targetSegs,source,[],linkId+"-transform",options.forwardAdapter,{transactional:!0,sourceApplier:options.forwardApplier},npOptions):(fluid.registerDirectChangeRelay(target,targetSegs,source,sourceSegs,linkId,options.forwardAdapter,{transactional:!1},npOptions),fluid.registerDirectChangeRelay(source,sourceSegs,target,targetSegs,linkId,options.backwardAdapter,{transactional:!1},npOptions))},fluid.parseSourceExclusionSpec=function(targetSpec,sourceSpec){return targetSpec.excludeSource=fluid.arrayToHash(fluid.makeArray(sourceSpec.excludeSource||(sourceSpec.includeSource?"*":void 0))),targetSpec.includeSource=fluid.arrayToHash(fluid.makeArray(sourceSpec.includeSource)),targetSpec},fluid.isExcludedChangeSource=function(transaction,spec){if(!spec||!spec.excludeSource)return!1;var excluded=spec.excludeSource["*"];for(var source in transaction.fullSources)spec.excludeSource[source]&&(excluded=!0),spec.includeSource[source]&&(excluded=!1);return excluded},fluid.model.guardedAdapter=function(transaction,cond,func,args){fluid.isExcludedChangeSource(transaction,cond)||func===fluid.model.transform.uninvertibleTransform||func.apply(null,args)},fluid.transformToAdapter=function(transform,targetPath){var basedTransform={};return basedTransform[targetPath]=transform,function(trans,newValue,source,sourceSegs,targetSegs,changeRequest){changeRequest&&"DELETE"===changeRequest.type&&trans.fireChangeRequest({type:"DELETE",path:targetPath});var oldTarget=fluid.getImmediate(trans.oldHolder.model,targetSegs),oldSource=fluid.getImmediate(source.model,sourceSegs);fluid.model.transformWithRules(newValue,basedTransform,{finalApplier:trans,oldTarget:oldTarget,oldSource:oldSource})}},fluid.makeTransformPackage=function(componentThat,transform,sourcePath,targetPath,forwardCond,backwardCond,namespace,priority){var that={forwardHolder:{model:transform},backwardHolder:{model:null},generateAdapters:function(trans){if(that.forwardAdapterImpl=fluid.transformToAdapter(trans?trans.newHolder.model:that.forwardHolder.model,targetPath),null!==sourcePath){var inverted=fluid.model.transform.invertConfiguration(transform);inverted!==fluid.model.transform.uninvertibleTransform?(that.backwardHolder.model=inverted,that.backwardAdapterImpl=fluid.transformToAdapter(that.backwardHolder.model,sourcePath)):that.backwardAdapterImpl=inverted}},forwardAdapter:function(transaction,newValue){void 0===newValue&&that.generateAdapters(),fluid.model.guardedAdapter(transaction,forwardCond,that.forwardAdapterImpl,arguments)}};that.forwardAdapter.cond=forwardCond,that.runTransform=function(trans){trans.commit(),trans.reset()},that.forwardApplier=fluid.makeHolderChangeApplier(that.forwardHolder),that.forwardApplier.isRelayApplier=!0,that.invalidator=fluid.makeEventFirer({name:"Invalidator for model relay with applier "+that.forwardApplier.applierId}),null!==sourcePath&&(that.backwardApplier=fluid.makeHolderChangeApplier(that.backwardHolder),that.backwardAdapter=function(transaction){fluid.model.guardedAdapter(transaction,backwardCond,that.backwardAdapterImpl,arguments)},that.backwardAdapter.cond=backwardCond),that.update=that.invalidator.fire;var implicitOptions={targetApplier:that.forwardApplier,update:that.update,namespace:namespace,priority:priority,refCount:0};return that.forwardHolder.model=fluid.parseImplicitRelay(componentThat,transform,[],implicitOptions),that.refCount=implicitOptions.refCount,that.namespace=namespace,that.priority=priority,that.generateAdapters(),that.invalidator.addListener(that.generateAdapters),that.invalidator.addListener(that.runTransform),that},fluid.singleTransformToFull=function(singleTransform){var expanded="string"==typeof singleTransform?{type:singleTransform}:singleTransform;return{"":{transform:$.extend(!0,{inputPath:""},expanded)}}},fluid.funcToSingleTransform=function(that,mrrec){return mrrec.func?((void 0!==mrrec.args)+(void 0!==mrrec.source)+(void 0!==mrrec.value)!==1&&fluid.fail("Error in model relay definition: short-form relay must specify just one out of (args, source, value)"),{type:"fluid.transforms.free",func:mrrec.func,args:mrrec.args?mrrec.args:[fluid.isIoCReference(mrrec.source)?mrrec.source:"{that}.model."+mrrec.source]}):null},fluid.model.relayConditions={initOnly:{includeSource:"init"},liveOnly:{excludeSource:"init"},never:{includeSource:[]},always:{}},fluid.model.expandRelayCondition=function(condition){var exclusionRec;return"initOnly"===condition?fluid.log(fluid.logLevel.WARN,'The relay condition "initOnly" is deprecated: Please use the form \'includeSource: "init"\' instead'):"liveOnly"===condition&&fluid.log(fluid.logLevel.WARN,'The relay condition "liveOnly" is deprecated: Please use the form \'excludeSource: "init"\' instead'),condition?"string"==typeof condition?(exclusionRec=fluid.model.relayConditions[condition])||fluid.fail('Unrecognised model relay condition string "'+condition+'": the supported values are "never" or a record with members "includeSource" and/or "excludeSource"'):exclusionRec=condition:exclusionRec={},exclusionRec},fluid.model.parseRelayConditions=function(conditions){var expanded=conditions.map(fluid.model.expandRelayCondition),mergeArgs=[!0,{}].concat(expanded),merged=fluid.extend.apply(null,mergeArgs);return fluid.parseSourceExclusionSpec({},merged)},fluid.parseModelRelay=function(that,mrrec,key){fluid.pushActivity("parseModelRelay",'parsing modelRelay definition with key "%key" and body "%body" attached to component "%that"',{key:key,body:mrrec,that:that}),"string"==typeof mrrec.target||fluid.isPlainObject(mrrec.target,!0)&&mrrec.target.segs||fluid.fail('Error parsing model relay definition: model reference must be specified for "target"');var parsedSource=void 0!==mrrec.source?fluid.parseValidModelReference(that,'modelRelay record member "source"',mrrec.source,!0):void 0!==mrrec.value?{nonModel:!0}:{path:null,modelSegs:null},parsedTarget=fluid.parseValidModelReference(that,'modelRelay record member "target"',mrrec.target),namespace=mrrec.namespace||key,singleTransform="string"==typeof mrrec.singleTransform?{type:mrrec.singleTransform}:mrrec.singleTransform,shortSingleTransform=fluid.funcToSingleTransform(that,mrrec),transform=mrrec.transform||fluid.singleTransformToFull(singleTransform||shortSingleTransform||{type:"fluid.transforms.identity"}),upDefaults=singleTransform?fluid.defaults(singleTransform.type):null,relayOptions=upDefaults&&upDefaults.relayOptions||{},forwardCond=fluid.model.parseRelayConditions([relayOptions.forward,mrrec.forward]),backwardCond=fluid.model.parseRelayConditions([relayOptions.backward,mrrec.backward]),transformPackage=fluid.makeTransformPackage(that,transform,parsedSource.path,parsedTarget.path,forwardCond,backwardCond,namespace,mrrec.priority);if(parsedSource.nonModel){var transformed,initValue=fluid.parseImplicitRelay(that,fluid.firstDefined(mrrec.source,mrrec.value),parsedTarget.modelSegs);if("fluid.transforms.identity"!==transform[""].transform.type){var localTransform=fluid.copy(transform);localTransform[""].transform.args=[initValue],transformed=fluid.model.transformWithRules(initValue,localTransform)}else transformed=initValue;var enlist=fluid.enlistModelComponent(parsedTarget.that),initModel={};fluid.model.setSimple(initModel,parsedTarget.modelSegs,transformed),enlist.initModels.push(initModel)}else 0===transformPackage.refCount?fluid.connectModelRelay(parsedSource.that||that,parsedSource.modelSegs,parsedTarget.that,parsedTarget.modelSegs,fluid.filterKeys(transformPackage,["forwardAdapter","backwardAdapter","namespace","priority"])):(parsedSource.modelSegs&&!shortSingleTransform&&fluid.fail('Error in model relay definition: If a relay transform has a model dependency, you can not specify a "source" entry - please instead enter this as "input" in the transform specification. Definition was ',mrrec," for component ",that),fluid.connectModelRelay(that,null,parsedTarget.that,parsedTarget.modelSegs,transformPackage));fluid.popActivity()},fluid.parseImplicitRelay=function(that,modelRec,segs,options){var value;if(fluid.isIoCReference(modelRec)){var parsed=fluid.parseValidModelReference(that,"model reference from model (implicit relay)",modelRec,!0);if(parsed.nonModel){if((value=fluid.isComponent(parsed.that)?fluid.possiblyProxyComponent(fluid.getForComponent(parsed.that,parsed.segs)):fluid.getImmediate(parsed.that,parsed.segs))instanceof fluid.fetchResources.FetchOne)return void that.applier.resourceMap.push({segs:fluid.makeArray(segs),fetchOne:value})}else++options.refCount,fluid.connectModelRelay(that,segs,parsed.that,parsed.modelSegs,options)}else fluid.isPrimitive(modelRec)||!fluid.isPlainObject(modelRec)?value=modelRec:modelRec.expander&&fluid.isPlainObject(modelRec.expander)?value=fluid.expandOptions(modelRec,that):(value=fluid.freshContainer(modelRec),fluid.each(modelRec,(function(innerValue,key){segs.push(key);var innerTrans=fluid.parseImplicitRelay(that,innerValue,segs,options);void 0!==innerTrans&&(value[key]=innerTrans),segs.pop()})));return value},fluid.model.notifyExternal=function(transRec){var allChanges=transRec?fluid.values(transRec.externalChanges):[];fluid.sortByPriority(allChanges);for(var i=0;i<allChanges.length;++i){var change=allChanges[i];change.args[5].destroyed||change.listener.apply(null,change.args)}fluid.clearLinkCounts(transRec,!0)},fluid.model.commitRelays=function(instantiator,transactionId){var transRec=instantiator.modelTransactions[transactionId];fluid.each(transRec,(function(transEl){transEl.transaction&&(transEl.transaction.commit("relay"),transEl.transaction.reset())}))},fluid.model.updateRelays=function(instantiator,transactionId){var transRec=instantiator.modelTransactions[transactionId],updates=0;return fluid.sortByPriority(transRec.relays),fluid.each(transRec.relays,(function(transEl){var maxRelay=transEl.options.refCount?4*transEl.options.refCount:4;transEl.transaction.changeRecord.changes>0&&transEl.relayCount<maxRelay&&transEl.options.update&&(transEl.relayCount++,fluid.clearLinkCounts(transRec),transEl.options.update(transEl.transaction,transRec),++updates)})),updates},fluid.concludeModelTransaction=function(transaction){var instantiator=fluid.globalInstantiator;fluid.model.notifyExternal(instantiator.modelTransactions[transaction.id]),delete instantiator.modelTransactions[transaction.id]},fluid.establishModelRelay=function(that,optionsModel,optionsML,optionsMR,applier){var shadow=fluid.shadowForComponent(that);shadow.modelRelayEstablished?fluid.fail("FLUID-5887 failure: Model relay initialised twice on component",that):shadow.modelRelayEstablished=!0;var enlist=fluid.enlistModelComponent(that),initModels=(optionsModel||[]).map((function(modelRec){return fluid.parseImplicitRelay(that,modelRec,[],{refCount:0,priority:"first"})}));Array.prototype.push.apply(enlist.initModels,initModels),fluid.each(optionsMR,(function(mrrec,key){if(""===key)for(var i=0;i<mrrec.length;++i)fluid.parseModelRelay(that,mrrec[i],key);else{var lightMerge=fluid.extend.apply(null,[!0,{}].concat(mrrec));fluid.parseModelRelay(that,lightMerge,key)}}));var instantiator=fluid.getInstantiator(that);return applier.preCommit.addListener((function(transaction){for(;fluid.model.updateRelays(instantiator,transaction.id)>0;);})),applier.preCommit.addListener((function(transaction){fluid.model.commitRelays(instantiator,transaction.id)})),applier.postCommit.addListener(fluid.concludeModelTransaction),applier.postCommit.addListener(fluid.concludeAnyTreeTransaction),null},fluid.destroyLensedComponentSource=function(that,isBoolean){var sourceModelReference=fluid.shadowForComponent(that).localRecord.sourceModelReference;sourceModelReference&&!fluid.isDestroyed(sourceModelReference.that,!0)&&sourceModelReference.that.applier.change(sourceModelReference.modelSegs,!1,isBoolean?"ADD":"DELETE")},fluid.constructLensedComponents=function(shadow,initTransRec,sourcesParsed,dynamicComponentKey){var lightMerge=shadow.lightMergeDynamicComponents[dynamicComponentKey],sources=fluid.getImmediate(shadow.that.model,sourcesParsed.modelSegs),shadowRecord=shadow.modelSourcedDynamicComponents[dynamicComponentKey],localRecordContributor=shadowRecord.localRecordContributor=function(localRecord,source,sourceKey){localRecord.sourceModelReference={that:sourcesParsed.that,modelSegs:sourcesParsed.modelSegs.concat(shadowRecord.isBoolean?[]:[sourceKey])}};fluid.lightMergeRecords.pushRecord(lightMerge,{options:{listeners:{afterDestroy:{funcName:"fluid.destroyLensedComponentSource",args:["{that}",shadowRecord.isBoolean]}}}}),fluid.registerSourcedDynamicComponentsTriage(shadow.potentia,shadow.that,sources,lightMerge,dynamicComponentKey,shadowRecord.isBoolean,localRecordContributor)},fluid.operateInitialTransactionWorkflow=function(shadows,treeTransaction){fluid.tryCatch((function(){var initModelTransaction=treeTransaction.initModelTransaction,transId=treeTransaction.initModelTransactionId;fluid.operateInitialTransaction(initModelTransaction,transId)}),(function(e){throw treeTransaction.initModelTransaction={},treeTransaction.initModelTransactionId=null,fluid.clearTransactions(),e}),fluid.identity)},fluid.enlistModelWorkflow=function(shadows,treeTransaction){var transId=treeTransaction.initModelTransactionId;transId||(transId=fluid.allocateGuid(),treeTransaction.initModelTransactionId=transId),shadows.forEach((function(shadow){fluid.getForComponent(shadow.that,"modelRelay")})),fluid.operateInitialTransactionWorkflow(shadows,treeTransaction)},fluid.notifyInitModelWorkflow=function(shadow,treeTransaction){if(!shadow.modelComplete){var initModelTransaction=treeTransaction.initModelTransaction,transRec=fluid.getModelTransactionRec(fluid.rootComponent,shadow.initTransactionId),trans=fluid.values(initModelTransaction)[0].transaction;treeTransaction.initModelTransaction={},treeTransaction.initModelTransactionId=null,trans.commit(),fluid.each(initModelTransaction,(function(oneRec){var that=oneRec.that,applier=that.applier;trans=transRec[applier.applierId].transaction;var listeners=applier.transListeners.sortedListeners,initShadow=fluid.shadowForComponent(that);initShadow.modelComplete=!0,initShadow.initTransactionId===shadow.initTransactionId&&fluid.notifyModelChanges(listeners,"ADD",trans.oldHolder,fluid.emptyHolder,null,trans,applier,that)})),fluid.concludeModelTransaction(trans)}},fluid.defaults("fluid.modelComponent",{gradeNames:["fluid.component"],workflows:{global:{enlistModel:{funcName:"fluid.enlistModelWorkflow"},resolveResourceModel:{funcName:"fluid.resolveResourceModelWorkflow",priority:"after:enlistModel",waitIO:!0}},local:{notifyInitModelWorkflow:{funcName:"fluid.notifyInitModelWorkflow",priority:"before:concludeComponentInit"}}},members:{model:{expander:{funcName:"fluid.initRelayModel",args:["{that}","{that}.modelRelay"],noproxy:!0}},applier:{expander:{funcName:"fluid.makeHolderChangeApplier",args:["{that}","{that}.options.changeApplierOptions"],noproxy:!0}},modelRelay:{expander:{funcName:"fluid.establishModelRelay",args:["{that}","{that}.options.model","{that}.options.modelListeners","{that}.options.modelRelay","{that}.applier"],noproxy:!0}}},mergePolicy:{model:{noexpand:!0,func:fluid.arrayConcatPolicy},modelListeners:fluid.makeMergeListenersPolicy(fluid.arrayConcatPolicy),modelRelay:fluid.makeMergeListenersPolicy(fluid.arrayConcatPolicy,!0)}}),fluid.modelChangedToChange=function(args){return{value:args[0],oldValue:args[1],path:args[2],transaction:args[4]}},fluid.event.invokeListener=function(listener,args,localRecord,mergeRecord){return"string"==typeof listener&&(listener=fluid.event.resolveListener(listener)),listener.apply(null,args,localRecord,mergeRecord)},fluid.resolveModelListener=function(that,record){var togo=function(){if(!fluid.isDestroyed(that,!0)){var change=fluid.modelChangedToChange(arguments),args=arguments,localRecord={change:change,arguments:args},mergeRecord={source:Object.keys(change.transaction.sources)};record.args&&(args=fluid.expandImmediate(record.args,that,localRecord)),fluid.event.invokeListener(record.listener,fluid.makeArray(args),localRecord,mergeRecord)}};return fluid.event.impersonateListener(record.listener,togo),togo},fluid.registerModelListeners=function(that,record,paths,namespace){var func=fluid.resolveModelListener(that,record);fluid.each(record.byTarget,(function(parsedArray){var parsed=parsedArray[0],spec={listener:func,listenerId:fluid.allocateGuid(),segsArray:fluid.getMembers(parsedArray,"modelSegs"),includeSource:record.includeSource,excludeSource:record.excludeSource,priority:fluid.expandOptions(record.priority,that),transactional:!0};(spec=parsed.applier.modelChanged.addListener(spec,func,namespace,record.softNamespace)).segsArray.forEach((function(segs){fluid.materialiseModelPath(that,segs)})),fluid.recordChangeListener(that,parsed.applier,func,spec.listenerId)}))},fluid.registerMergedModelListeners=function(that,listeners){fluid.each(listeners,(function(value,key){"string"==typeof value&&(value={funcName:value});var records=fluid.event.resolveListenerRecord(value,that,"modelListeners",null,!1).records;fluid.each(records,(function(record){record.byTarget={};var paths=fluid.makeArray(void 0===record.path?key:record.path);fluid.each(paths,(function(path){var parsed=fluid.parseValidModelReference(that,"modelListeners entry",path);fluid.pushArray(record.byTarget,parsed.that.id,parsed)}));var namespace=(record.namespace&&!record.softNamespace?record.namespace:null)||(void 0!==record.path?key:null);fluid.registerModelListeners(that,record,paths,namespace)}))}))},fluid.replaceModelValue=function(applier,path,newValue){var transaction=applier.initiate();return transaction.fireChangeRequest({path:path,type:"DELETE"}),transaction.fireChangeRequest({path:path,value:newValue}),transaction.commit(),applier.holder.model},fluid.fireChanges=function(applier,changes){for(var i=0;i<changes.length;++i)applier.fireChangeRequest(changes[i])},fluid.model.isChangedPath=function(changeMap,segs){for(var i=0;i<=segs.length;++i){if("string"==typeof changeMap)return changeMap;i<segs.length&&changeMap&&(changeMap=changeMap[segs[i]])}return null},fluid.model.setChangedPath=function(options,segs,value){var notePath=function(record){var root=options;segs.unshift(record);for(var i=0;i<segs.length-1;++i){var seg=segs[i];void 0===root[seg]&&(root[seg]={}),root=root[seg]}fluid.isPlainObject(root)&&(root[fluid.peek(segs)]=value),segs.shift()};fluid.model.isChangedPath(options.changeMap,segs)!==value&&(++options.changes,notePath("changeMap")),fluid.model.isChangedPath(options.deltaMap,segs)!==value&&(++options.deltas,notePath("deltaMap"))},fluid.model.fetchChangeChildren=function(target,i,segs,source,options){fluid.each(source,(function(value,key){segs[i]=key,fluid.model.applyChangeStrategy(target,key,i,segs,value,options),segs.length=i}))},fluid.model.isSameValue=function(a,b){return"number"!=typeof a||"number"!=typeof b?a===b:a===b||a!=a&&b!=b||Math.abs((a-b)/b)<1e-12},fluid.model.applyChangeStrategy=function(target,name,i,segs,source,options){var targetSlot=target[name],sourceCode=fluid.typeCode(source),targetCode=fluid.typeCode(targetSlot),changedValue=fluid.NO_VALUE;"primitive"===sourceCode?fluid.model.isSameValue(targetSlot,source)||(changedValue=source,++options.unchanged):(targetCode!==sourceCode||"array"===sourceCode&&source.length!==targetSlot.length)&&(changedValue=fluid.freshContainer(source)),changedValue!==fluid.NO_VALUE&&(target[name]=changedValue,options.changeMap&&fluid.model.setChangedPath(options,segs,options.inverse?"DELETE":"ADD")),"primitive"!==sourceCode&&fluid.model.fetchChangeChildren(target[name],i+1,segs,source,options)},fluid.model.stepTargetAccess=function(target,type,segs,startpos,endpos,options){for(var i=startpos;i<endpos;++i){if(target)target[segs[i]]!==(target=fluid.model.traverseWithStrategy(target,segs,i,options["ADD"===type?"resolverSetConfig":"resolverGetConfig"],segs.length-i-1))&&options.changeMap&&fluid.model.setChangedPath(options,segs.slice(0,i+1),"ADD")}return{root:target,last:segs[endpos]}},fluid.model.defaultAccessorConfig=function(options){return(options=options||{}).resolverSetConfig=options.resolverSetConfig||fluid.model.escapedSetConfig,options.resolverGetConfig=options.resolverGetConfig||fluid.model.escapedGetConfig,options},fluid.model.applyHolderChangeRequest=function(holder,request,options){(options=fluid.model.defaultAccessorConfig(options)).deltaMap=options.changeMap?{}:null,options.deltas=0;var pen,length=request.segs.length,atRoot=0===length;if(atRoot?pen={root:holder,last:"model"}:(holder.model||"DELETE"===request.type||(holder.model={},fluid.model.setChangedPath(options,[],options.inverse?"DELETE":"ADD")),pen=fluid.model.stepTargetAccess(holder.model,request.type,request.segs,0,length-1,options)),"ADD"===request.type){var value=request.value,segs=fluid.makeArray(request.segs);fluid.model.applyChangeStrategy(pen.root,pen.last,length-1,segs,value,options,atRoot)}else"DELETE"===request.type?pen.root&&void 0!==pen.root[pen.last]&&(delete pen.root[pen.last],options.changeMap&&fluid.model.setChangedPath(options,request.segs,"DELETE")):fluid.fail("Unrecognised change type of "+request.type);return options.deltas?options.deltaMap:null},fluid.model.diff=function(modela,modelb,options){options=options||{changes:0,unchanged:0,changeMap:{}};var togo,typea=fluid.typeCode(modela),typeb=fluid.typeCode(modelb);if("primitive"===typea&&"primitive"===typeb)togo=fluid.model.isSameValue(modela,modelb);else if("primitive"===typea^"primitive"===typeb)togo=!1;else{var holderb={model:fluid.copy(modelb)};options.inverse=!0,fluid.model.applyHolderChangeRequest(holderb,{value:modela,segs:[],type:"ADD"},options);var holdera={model:fluid.copy(modela)};options.inverse=!1,fluid.model.applyHolderChangeRequest(holdera,{value:modelb,segs:[],type:"ADD"},options),togo=0===options.changes}return!1===togo&&0===options.changes?(options.changes=1,options.changeMap=void 0===modelb?"DELETE":"ADD"):!0===togo&&0===options.unchanged&&(options.unchanged=1),togo},fluid.outputWildcardMatches=function(matches,outSegs,root){fluid.each(root,(function(value,key){matches.push(outSegs.concat(key))}))},fluid.matchChanges=function(changeMap,specSegs,newHolder,oldHolder){for(var newRoot=newHolder.model,oldRoot=oldHolder.model,map=changeMap,outSegs=["model"],wildcard=!1,togo=[],i=0;i<specSegs.length;++i){var seg=specSegs[i];"*"===seg?i===specSegs.length-1?wildcard=!0:fluid.fail("Wildcard specification in modelChanged listener is only supported for the final path segment: "+specSegs.join(".")):(outSegs.push(seg),map=fluid.isPrimitive(map)?map:map[seg],newRoot=newRoot?newRoot[seg]:void 0,oldRoot=oldRoot?oldRoot[seg]:void 0)}if(map)if(wildcard)if("string"==typeof map){var allKeys=fluid.extend({},oldRoot,newRoot);fluid.outputWildcardMatches(togo,outSegs,allKeys)}else fluid.outputWildcardMatches(togo,outSegs,map);else togo.push(outSegs);return togo},fluid.storeExternalChange=function(transRec,applier,invalidPath,spec,args){var pathString=applier.composeSegments.apply(null,invalidPath),keyString=[applier.holder.id,spec.listenerId,spec.wildcard?pathString:""].join("|");transRec.externalChanges[keyString]={listener:spec.listener,namespace:spec.namespace,priority:spec.priority,args:args}},fluid.notifyModelChanges=function(listeners,changeMap,newHolder,oldHolder,changeRequest,transaction,applier,that){if(listeners)for(var transRec=fluid.getModelTransactionRec(that,transaction.id),i=0;i<listeners.length;++i)for(var spec=listeners[i],multiplePaths=spec.segsArray.length>1,j=0;j<spec.segsArray.length;++j)for(var invalidPaths=fluid.matchChanges(changeMap,spec.segsArray[j],newHolder,oldHolder),k=0;k<invalidPaths.length;++k){if(applier.destroyed)return;var invalidPath=invalidPaths[k];spec.listener=fluid.event.resolveListener(spec.listener);var args=[multiplePaths?newHolder.model:fluid.model.getSimple(newHolder,invalidPath),multiplePaths?oldHolder.model:fluid.model.getSimple(oldHolder,invalidPath),multiplePaths?[]:invalidPath.slice(1),changeRequest,transaction,applier];if(!spec.isRelay){if(fluid.model.diff(args[0],args[1]))continue;if(fluid.isExcludedChangeSource(transaction,spec))continue}transRec&&!spec.isRelay&&spec.transactional?fluid.storeExternalChange(transRec,applier,invalidPath,spec,args):spec.listener.apply(null,args)}},fluid.bindELMethods=function(applier){applier.parseEL=function(EL){return fluid.model.pathToSegments(EL,applier.options.resolverSetConfig)},applier.composeSegments=function(){return applier.options.resolverSetConfig.parser.compose.apply(null,arguments)}},fluid.emptyHolder=fluid.freezeRecursive({model:void 0}),fluid.preFireChangeRequest=function(applier,changeRequest){changeRequest.type||(changeRequest.type="ADD"),changeRequest.segs=changeRequest.segs||applier.parseEL(changeRequest.path)},fluid.bindRequestChange=function(that){that.change=function(path,value,type,source){var changeRequest={path:path,value:value,type:type,source:source};that.fireChangeRequest(changeRequest)}},fluid.mergeChangeSources=function(target,globalSources){fluid.isPlainObject(globalSources,!0)?fluid.extend(target,globalSources):fluid.each(fluid.makeArray(globalSources),(function(globalSource){target[globalSource]=!0}))},fluid.ChangeApplier=function(){},fluid.makeHolderChangeApplier=function(holder,options){options=fluid.model.defaultAccessorConfig(options);var applierId=fluid.allocateGuid(),that=new fluid.ChangeApplier,name=fluid.isComponent(holder)?"ChangeApplier for component "+fluid.dumpThat(holder):"ChangeApplier with id "+applierId;return $.extend(that,{applierId:applierId,holder:holder,listeners:fluid.makeEventFirer({name:"Internal change listeners for "+name}),transListeners:fluid.makeEventFirer({name:"External change listeners for "+name}),options:options,modelChanged:{},resourceMap:[],earlyModelResolved:fluid.makeEventFirer({name:"earlyModelResolved event for "+name}),preCommit:fluid.makeEventFirer({name:"preCommit event for "+name}),postCommit:fluid.makeEventFirer({name:"postCommit event for "+name})}),that.destroy=function(){that.preCommit.destroy(),that.postCommit.destroy(),that.destroyed=!0},that.modelChanged.addListener=function(spec,listener,namespace,softNamespace){return(spec="string"==typeof spec?{path:spec}:fluid.copy(spec)).listenerId=spec.listenerId||fluid.allocateGuid(),spec.namespace=namespace,spec.softNamespace=softNamespace,"string"==typeof listener&&(listener={globalName:listener}),spec.listener=listener,!1!==spec.transactional&&(spec.transactional=!0),spec.segsArray||(void 0!==spec.path&&(spec.segs=spec.segs||that.parseEL(spec.path)),spec.segsArray=[spec.segs]),spec.isRelay||(fluid.parseSourceExclusionSpec(spec,spec),spec.wildcard=spec.segsArray.some((function(segs){return segs.includes("*")})),spec.wildcard&&spec.segsArray.length>1&&fluid.fail("Error in model listener specification ",spec," - you may not supply a wildcard pattern as one of a set of multiple paths to be matched")),that[spec.transactional?"transListeners":"listeners"].addListener(spec),spec},that.modelChanged.removeListener=function(listener){that.listeners.removeListener(listener),that.transListeners.removeListener(listener)},that.fireChangeRequest=function(changeRequest){var initTransaction=fluid.findInitModelTransaction(holder);if(initTransaction)initTransaction.transaction.fireChangeRequest(changeRequest);else{var ation=that.initiate("local",changeRequest.source);ation.fireChangeRequest(changeRequest),ation.commit()}},that.initiate=function(localSource,globalSources,transactionId){var defeatPost="relay"===(localSource="init"===globalSources?null:localSource||"local")||"init"===globalSources,trans={instanceId:fluid.allocateGuid(),id:transactionId||fluid.allocateGuid(),changeRecord:{resolverSetConfig:options.resolverSetConfig,resolverGetConfig:options.resolverGetConfig},reset:function(){trans.oldHolder=holder,trans.newHolder={model:fluid.copy(holder.model)},trans.changeRecord.changes=0,trans.changeRecord.unchanged=0,trans.changeRecord.changeMap={}},commit:function(code){if("relay"!==code&&that.preCommit.fire(trans,that,code),trans.changeRecord.changes>0){var oldHolder={model:holder.model};holder.model=trans.newHolder.model,fluid.notifyModelChanges(that.transListeners.sortedListeners,trans.changeRecord.changeMap,holder,oldHolder,null,trans,that,holder)}defeatPost||"relay"===code||that.postCommit.fire(trans,that,code)},fireChangeRequest:function(changeRequest){fluid.preFireChangeRequest(that,changeRequest),changeRequest.transactionId=trans.id;var deltaMap=fluid.model.applyHolderChangeRequest(trans.newHolder,changeRequest,trans.changeRecord);fluid.notifyModelChanges(that.listeners.sortedListeners,deltaMap,trans.newHolder,holder,changeRequest,trans,that,holder)},hasChangeSource:function(source){return trans.fullSources[source]}},transRec=fluid.getModelTransactionRec(holder,trans.id);return transRec&&(fluid.mergeChangeSources(transRec.sources,globalSources),trans.sources=transRec.sources,trans.fullSources=Object.create(transRec.sources),localSource&&(trans.fullSources[localSource]=!0)),trans.reset(),fluid.bindRequestChange(trans),trans},fluid.bindRequestChange(that),fluid.bindELMethods(that),that},fluid.modelPairToChanges=function(value,oldValue,changePathPrefix){changePathPrefix=changePathPrefix||"";var diffOptions={changes:0,unchanged:0,changeMap:{}};fluid.model.diff(oldValue,value,diffOptions);var changes=[];return fluid.modelPairToChangesImpl(value,fluid.pathUtil.parseEL(changePathPrefix),diffOptions.changeMap,[],changes),changes},fluid.modelPairToChangesImpl=function(value,changePathPrefixSegs,changeMap,changeSegs,changes){"ADD"===changeMap?changes.push({path:changePathPrefixSegs,value:value,type:"ADD"}):"DELETE"===changeMap?changes.push({path:changePathPrefixSegs,value:null,type:"DELETE"}):fluid.isPlainObject(changeMap,!0)&&fluid.each(changeMap,(function(change,seg){var currentChangeSegs=changeSegs.concat([seg]);"ADD"===change?changes.push({path:changePathPrefixSegs.concat(currentChangeSegs),value:fluid.get(value,currentChangeSegs),type:"ADD"}):"DELETE"===change?changes.push({path:changePathPrefixSegs.concat(currentChangeSegs),value:null,type:"DELETE"}):fluid.isPlainObject(change,!0)&&fluid.modelPairToChangesImpl(value,changePathPrefixSegs,change,currentChangeSegs,changes)}))},fluid.registerNamespace("fluid.model.transform"),fluid.defaults("fluid.transformFunction",{gradeNames:"fluid.function"}),fluid.defaults("fluid.standardInputTransformFunction",{gradeNames:"fluid.transformFunction"}),fluid.defaults("fluid.standardOutputTransformFunction",{gradeNames:"fluid.transformFunction"}),fluid.defaults("fluid.multiInputTransformFunction",{gradeNames:"fluid.transformFunction"}),fluid.defaults("fluid.standardTransformFunction",{gradeNames:["fluid.standardInputTransformFunction","fluid.standardOutputTransformFunction"]}),fluid.defaults("fluid.lens",{gradeNames:"fluid.transformFunction",invertConfiguration:null}),fluid.model.transform.pathToRule=function(inputPath){return{transform:{type:"fluid.transforms.value",inputPath:inputPath}}},fluid.model.transform.literalValueToRule=function(input){return{transform:{type:"fluid.transforms.literalValue",input:input}}},fluid.model.composePaths=function(prefix,suffix){return suffix=0===suffix?"0":suffix||"",(prefix=0===prefix?"0":prefix||"")?suffix?prefix+"."+suffix:prefix:suffix},fluid.model.transform.accumulateInputPath=function(inputPath,transformer,paths){void 0!==inputPath&&paths.push(fluid.model.composePaths(transformer.inputPrefix,inputPath))},fluid.model.transform.accumulateStandardInputPath=function(input,transformSpec,transformer,paths){fluid.model.transform.getValue(void 0,transformSpec[input],transformer),fluid.model.transform.accumulateInputPath(transformSpec[input+"Path"],transformer,paths)},fluid.model.transform.accumulateMultiInputPaths=function(inputVariables,transformSpec,transformer,paths){fluid.each(inputVariables,(function(v,k){fluid.model.transform.accumulateStandardInputPath(k,transformSpec,transformer,paths)}))},fluid.model.transform.getValue=function(inputPath,value,transformer){var togo;return void 0!==inputPath&&(togo=fluid.get(transformer.source,fluid.model.composePaths(transformer.inputPrefix,inputPath),transformer.resolverGetConfig)),void 0===togo&&(togo=fluid.isPrimitive(value)?value:"literalValue"in value?value.literalValue:void 0===value.transform?value:transformer.expand(value)),togo},fluid.model.transform.NONDEFAULT_OUTPUT_PATH_RETURN={},fluid.model.transform.setValue=function(userOutputPath,value,transformer){var toset=fluid.copy(value),outputPath=fluid.model.composePaths(transformer.outputPrefix,userOutputPath);return void 0!==toset&&transformer.applier.change(outputPath,toset),userOutputPath?fluid.model.transform.NONDEFAULT_OUTPUT_PATH_RETURN:toset},fluid.model.transform.resolveParam=function(transformSpec,transformer,key,def){var val=fluid.model.transform.getValue(transformSpec[key+"Path"],transformSpec[key],transformer);return void 0!==val?val:def},fluid.model.transform.matchValue=function(expected,actual,partialMatches){var stats={changes:0,unchanged:0,changeMap:{}};return fluid.model.diff(expected,actual,stats),0===stats.unchanged?0:partialMatches?0xffffff000000-16777216*stats.changes+stats.unchanged:stats.changes?0:0xffffff000000+stats.unchanged},fluid.model.transform.invertPaths=function(transformSpec,transformer){var oldOutput=fluid.model.composePaths(transformer.outputPrefix,transformSpec.outputPath);return transformSpec.outputPath=fluid.model.composePaths(transformer.inputPrefix,transformSpec.inputPath),transformSpec.inputPath=oldOutput,transformSpec},fluid.model.transform.prefixApplier=function(transformSpec,transformer){transformSpec.inputPrefix&&transformer.inputPrefixOp.push(transformSpec.inputPrefix),transformSpec.outputPrefix&&transformer.outputPrefixOp.push(transformSpec.outputPrefix),transformer.expand(transformSpec.input),transformSpec.inputPrefix&&transformer.inputPrefixOp.pop(),transformSpec.outputPrefix&&transformer.outputPrefixOp.pop()},fluid.defaults("fluid.model.transform.prefixApplier",{gradeNames:["fluid.transformFunction"]}),fluid.model.makePathStack=function(transform,prefixName){var stack=transform[prefixName+"Stack"]=[];return transform[prefixName]="",{push:function(prefix){var newPath=fluid.model.composePaths(transform[prefixName],prefix);stack.push(transform[prefixName]),transform[prefixName]=newPath},pop:function(){transform[prefixName]=stack.pop()}}},fluid.model.transform.doTransform=function(transformSpec,transformer,transformOpts){var expdef=transformOpts.defaults,transformFn=fluid.getGlobalValue(transformOpts.typeName);"function"!=typeof transformFn&&fluid.fail("Transformation record specifies transformation function with name "+transformSpec.type+" which is not a function - ",transformFn),fluid.hasGrade(expdef,"fluid.transformFunction")||(expdef=fluid.defaults("fluid.standardTransformFunction"));var transformArgs=[transformSpec,transformer];if(fluid.hasGrade(expdef,"fluid.multiInputTransformFunction")){var inputs={};fluid.each(expdef.inputVariables,(function(v,k){inputs[k]=function(){var input=fluid.model.transform.getValue(transformSpec[k+"Path"],transformSpec[k],transformer);return input=void 0===input&&null!==v?v:input}})),transformArgs.unshift(inputs)}if(fluid.hasGrade(expdef,"fluid.standardInputTransformFunction")){"input"in transformSpec||"inputPath"in transformSpec||fluid.fail('Error in transform specification. Either "input" or "inputPath" must be specified for a standardInputTransformFunction: received ',transformSpec);var expanded=fluid.model.transform.getValue(transformSpec.inputPath,transformSpec.input,transformer);if(transformArgs.unshift(expanded),void 0===expanded)return}var transformed=transformFn.apply(null,transformArgs);fluid.hasGrade(expdef,"fluid.standardOutputTransformFunction")&&(void 0!==(void 0!==transformSpec.outputPath?transformSpec.outputPath:transformOpts.doOutput?"":void 0)&&void 0!==transformed&&(fluid.model.transform.setValue(transformSpec.outputPath,transformed,transformer),transformed=void 0));return transformed};var globalAccept=[];fluid.registerNamespace("fluid.pathUtil"),fluid.pathUtil.getPathSegment=function(path,i){return fluid.pathUtil.getPathSegmentImpl(globalAccept,path,i),globalAccept[0]},fluid.pathUtil.getHeadPath=function(path){return fluid.pathUtil.getPathSegment(path,0)},fluid.pathUtil.getFromHeadPath=function(path){var firstdot=fluid.pathUtil.getPathSegmentImpl(null,path,0);return firstdot===path.length?"":path.substring(firstdot+1)},fluid.pathUtil.matchPath=function(spec,path,exact){for(var togo=[];;){if(""===path^""===spec&&exact)return null;if(!spec||!path)break;var spechead=fluid.pathUtil.getHeadPath(spec),pathhead=fluid.pathUtil.getHeadPath(path);if("*"!==spechead&&spechead!==pathhead)return null;togo.push(pathhead),spec=fluid.pathUtil.getFromHeadPath(spec),path=fluid.pathUtil.getFromHeadPath(path)}return togo},fluid.model.transform.expandWildcards=function(transformer,source){fluid.each(source,(function(value,key){var q=transformer.queuedTransforms;transformer.pathOp.push(fluid.pathUtil.escapeSegment(key.toString()));for(var i=0;i<q.length;++i)if(fluid.pathUtil.matchPath(q[i].matchPath,transformer.path,!0)){var esCopy=fluid.copy(q[i].transformSpec);(void 0===esCopy.inputPath||fluid.model.transform.hasWildcard(esCopy.inputPath))&&(esCopy.inputPath=""),transformer.inputPrefixOp.push(transformer.path),transformer.outputPrefixOp.push(transformer.path);var transformOpts=fluid.model.transform.lookupType(esCopy.type),result=fluid.model.transform.doTransform(esCopy,transformer,transformOpts);void 0!==result&&fluid.model.transform.setValue(null,result,transformer),transformer.outputPrefixOp.pop(),transformer.inputPrefixOp.pop()}fluid.isPrimitive(value)||fluid.model.transform.expandWildcards(transformer,value),transformer.pathOp.pop()}))},fluid.model.transform.hasWildcard=function(path){return"string"==typeof path&&-1!==path.indexOf("*")},fluid.model.transform.maybePushWildcard=function(transformSpec,transformer){var matchPath,hw=fluid.model.transform.hasWildcard;return hw(transformSpec.inputPath)?matchPath=fluid.model.composePaths(transformer.inputPrefix,transformSpec.inputPath):(hw(transformer.outputPrefix)||hw(transformSpec.outputPath))&&(matchPath=fluid.model.composePaths(transformer.outputPrefix,transformSpec.outputPath)),!!matchPath&&(transformer.queuedTransforms.push({transformSpec:transformSpec,outputPrefix:transformer.outputPrefix,inputPrefix:transformer.inputPrefix,matchPath:matchPath}),!0)},fluid.model.sortByKeyLength=function(inObject){return fluid.keys(inObject).sort(fluid.compareStringLength(!0))},fluid.model.transform.handleTransformStrategy=function(transformSpec,transformer,transformOpts){return fluid.model.transform.maybePushWildcard(transformSpec,transformer)?void 0:fluid.model.transform.doTransform(transformSpec,transformer,transformOpts)},fluid.model.transform.handleInvertStrategy=function(transformSpec,transformer,transformOpts){transformSpec=fluid.copy(transformSpec),fluid.hasGrade(transformOpts.defaults,"fluid.standardTransformFunction")&&(transformSpec=fluid.model.transform.invertPaths(transformSpec,transformer));var invertor=transformOpts.defaults&&transformOpts.defaults.invertConfiguration;if(invertor){var inverted=fluid.invokeGlobalFunction(invertor,[transformSpec,transformer]);transformer.inverted.push(inverted)}else transformer.inverted.push(fluid.model.transform.uninvertibleTransform)},fluid.model.transform.handleCollectStrategy=function(transformSpec,transformer,transformOpts){var defaults=transformOpts.defaults,standardInput=fluid.hasGrade(defaults,"fluid.standardInputTransformFunction"),multiInput=fluid.hasGrade(defaults,"fluid.multiInputTransformFunction");standardInput&&fluid.model.transform.accumulateStandardInputPath("input",transformSpec,transformer,transformer.inputPaths),multiInput&&fluid.model.transform.accumulateMultiInputPaths(defaults.inputVariables,transformSpec,transformer,transformer.inputPaths);var collector=defaults.collectInputPaths;if(collector){var collected=fluid.makeArray(fluid.invokeGlobalFunction(collector,[transformSpec,transformer]));Array.prototype.push.apply(transformer.inputPaths,collected)}},fluid.model.transform.lookupType=function(typeName,transformSpec){return typeName||fluid.fail("Transformation record is missing a type name: ",transformSpec),-1===typeName.indexOf(".")&&(typeName="fluid.transforms."+typeName),{defaults:fluid.defaults(typeName),typeName:typeName}},fluid.model.transform.processRule=function(rule,transformer){var togo,transformSpec,transformOpts;if("string"==typeof rule?rule=fluid.model.transform.pathToRule(rule):void 0!==rule.literalValue&&(rule=fluid.model.transform.literalValueToRule(rule.literalValue)),rule.transform)if(fluid.isArrayable(rule.transform)){var transforms=rule.transform;togo=void 0;for(var i=0;i<transforms.length;++i)transformSpec=transforms[i],transformOpts=fluid.model.transform.lookupType(transformSpec.type),transformer.transformHandler(transformSpec,transformer,transformOpts)}else transformSpec=rule.transform,transformOpts=fluid.model.transform.lookupType(transformSpec.type),togo=transformer.transformHandler(transformSpec,transformer,transformOpts);return fluid.isArrayable(rule)&&(transformer.collectedFlatSchemaOpts=transformer.collectedFlatSchemaOpts||{},transformer.collectedFlatSchemaOpts[transformer.outputPrefix]="array"),fluid.each(rule,(function(value,key){if("transform"!==key){transformer.outputPrefixOp.push(key);var togo=transformer.expand(value,transformer);void 0!==togo&&(fluid.model.transform.setValue(null,togo,transformer),togo=void 0),transformer.outputPrefixOp.pop()}})),togo},fluid.model.transform.makeStrategy=function(transformer,handleFn,transformFn){transformFn=transformFn||fluid.model.transform.processRule,transformer.expand=function(rules){return transformFn(rules,transformer)},transformer.outputPrefixOp=fluid.model.makePathStack(transformer,"outputPrefix"),transformer.inputPrefixOp=fluid.model.makePathStack(transformer,"inputPrefix"),transformer.transformHandler=handleFn},fluid.model.transform.uninvertibleTransform=Object.freeze({}),fluid.model.transform.invertConfiguration=function(rules){var transformer={inverted:[]};return fluid.model.transform.makeStrategy(transformer,fluid.model.transform.handleInvertStrategy),transformer.expand(rules),-1===transformer.inverted.indexOf(fluid.model.transform.uninvertibleTransform)?{transform:transformer.inverted}:fluid.model.transform.uninvertibleTransform},fluid.model.transform.collectInputPaths=function(rules){var transformer={inputPaths:[]};fluid.model.transform.makeStrategy(transformer,fluid.model.transform.handleCollectStrategy),transformer.expand(rules);var inputPathHash=fluid.arrayToHash(transformer.inputPaths);return Object.keys(inputPathHash)},fluid.model.transform.flatSchemaStrategy=function(flatSchema,getConfig){var keys=fluid.model.sortByKeyLength(flatSchema);return function(root,segment,index,segs){for(var path=getConfig.parser.compose.apply(null,segs.slice(0,index)),i=0;i<keys.length;++i){var key=keys[i];if(null!==fluid.pathUtil.matchPath(key,path,!0))return flatSchema[key]}}},fluid.model.transform.defaultSchemaValue=function(schemaValue){return"array"===(fluid.isPrimitive(schemaValue)?schemaValue:schemaValue.type)?[]:{}},fluid.model.transform.isomorphicSchemaStrategy=function(source,getConfig){return function(root,segment,index,segs){var existing=fluid.get(source,segs.slice(0,index),getConfig);return fluid.isArrayable(existing)?"array":"object"}},fluid.model.transform.decodeStrategy=function(source,options,getConfig){return options.isomorphic?fluid.model.transform.isomorphicSchemaStrategy(source,getConfig):options.flatSchema?fluid.model.transform.flatSchemaStrategy(options.flatSchema,getConfig):void 0},fluid.model.transform.schemaToCreatorStrategy=function(strategy){return function(root,segment,index,segs){if(void 0===root[segment]){var schemaValue=strategy(root,segment,index,segs);return root[segment]=fluid.model.transform.defaultSchemaValue(schemaValue),root[segment]}}},fluid.model.transform.sequence=function(source,rules,options){for(var i=0;i<rules.length;++i)source=fluid.model.transform(source,rules[i],options);return source},fluid.model.compareByPathLength=function(changea,changeb){var pdiff=changea.path.length-changeb.path.length;return 0===pdiff?changea.sequence-changeb.sequence:pdiff},fluid.model.fireSortedChanges=function(changes,applier){changes.sort(fluid.model.compareByPathLength),fluid.fireChanges(applier,changes)},fluid.model.transformWithRules=function(source,rules,options){options=options||{};var getConfig=fluid.model.escapedGetConfig,setConfig=fluid.model.escapedSetConfig,schemaStrategy=fluid.model.transform.decodeStrategy(source,options,getConfig),transformer={source:source,target:{model:schemaStrategy?fluid.model.transform.defaultSchemaValue(schemaStrategy(null,"",0,[""])):{}},oldSource:options.oldSource,oldTarget:options.oldTarget,resolverGetConfig:getConfig,resolverSetConfig:setConfig,collectedFlatSchemaOpts:void 0,queuedChanges:[],queuedTransforms:[]};fluid.model.transform.makeStrategy(transformer,fluid.model.transform.handleTransformStrategy),transformer.applier={fireChangeRequest:function(changeRequest){changeRequest.sequence=transformer.queuedChanges.length,transformer.queuedChanges.push(changeRequest)}},fluid.bindRequestChange(transformer.applier),transformer.expand(rules);var rootSetConfig=fluid.copy(setConfig);return void 0!==transformer.collectedFlatSchemaOpts&&($.extend(transformer.collectedFlatSchemaOpts,options.flatSchema),schemaStrategy=fluid.model.transform.flatSchemaStrategy(transformer.collectedFlatSchemaOpts,getConfig)),rootSetConfig.strategies=[fluid.model.defaultFetchStrategy,schemaStrategy?fluid.model.transform.schemaToCreatorStrategy(schemaStrategy):fluid.model.defaultCreatorStrategy],transformer.finalApplier=options.finalApplier||fluid.makeHolderChangeApplier(transformer.target,{resolverSetConfig:rootSetConfig}),transformer.queuedTransforms.length>0&&(transformer.typeStack=[],transformer.pathOp=fluid.model.makePathStack(transformer,"path"),fluid.model.transform.expandWildcards(transformer,source)),fluid.model.fireSortedChanges(transformer.queuedChanges,transformer.finalApplier),transformer.target.model},$.extend(fluid.model.transformWithRules,fluid.model.transform),fluid.model.transform=fluid.model.transformWithRules,fluid.transformOne=function(rules){return{transformOptions:{transformer:"fluid.model.transformWithRules",config:rules}}},fluid.transformMany=function(rules){return{transformOptions:{transformer:"fluid.model.transform.sequence",config:rules}}},fluid.registerNamespace("fluid.model.transform"),fluid.registerNamespace("fluid.transforms"),fluid.defaults("fluid.transforms.value",{gradeNames:"fluid.standardTransformFunction",invertConfiguration:"fluid.identity"}),fluid.transforms.value=fluid.identity,fluid.transforms.identity=fluid.transforms.value,fluid.defaults("fluid.transforms.identity",{gradeNames:"fluid.transforms.value"}),fluid.transforms.invertToIdentity=function(transformSpec){return transformSpec.type="fluid.transforms.identity",transformSpec},fluid.defaults("fluid.transforms.literalValue",{gradeNames:"fluid.standardOutputTransformFunction"}),fluid.transforms.literalValue=function(transformSpec){return transformSpec.input},fluid.defaults("fluid.transforms.stringToNumber",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.stringToNumber.invert"}),fluid.transforms.stringToNumber=function(value){var newValue=Number(value);return isNaN(newValue)?void 0:newValue},fluid.transforms.stringToNumber.invert=function(transformSpec){return transformSpec.type="fluid.transforms.numberToString",transformSpec},fluid.defaults("fluid.transforms.numberToString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.numberToString.invert"}),fluid.transforms.numberToString=function(value,transformSpec){if("number"==typeof value)return"number"!=typeof transformSpec.scale||isNaN(transformSpec.scale)?value.toString():fluid.roundToDecimal(value,transformSpec.scale,transformSpec.method).toString()},fluid.transforms.numberToString.invert=function(transformSpec){return transformSpec.type="fluid.transforms.stringToNumber",transformSpec},fluid.defaults("fluid.transforms.count",{gradeNames:"fluid.standardTransformFunction"}),fluid.transforms.count=function(value){return fluid.makeArray(value).length},fluid.defaults("fluid.transforms.round",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.invertToIdentity"}),fluid.transforms.round=function(value,transformSpec){return fluid.roundToDecimal(value,transformSpec.scale,transformSpec.method)},fluid.defaults("fluid.transforms.delete",{gradeNames:"fluid.transformFunction"}),fluid.transforms.delete=function(transformSpec,transformer){var outputPath=fluid.model.composePaths(transformer.outputPrefix,transformSpec.outputPath);transformer.applier.change(outputPath,null,"DELETE")},fluid.defaults("fluid.transforms.firstValue",{gradeNames:"fluid.standardOutputTransformFunction"}),fluid.transforms.firstValue=function(transformSpec,transformer){transformSpec.values&&transformSpec.values.length||fluid.fail('firstValue transformer requires an array of values at path named "values", supplied',transformSpec);for(var i=0;i<transformSpec.values.length;i++){var value=transformSpec.values[i],expanded=transformer.expand(value);if(void 0!==expanded)return expanded}},fluid.defaults("fluid.transforms.linearScale",{gradeNames:["fluid.multiInputTransformFunction","fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.linearScale.invert",inputVariables:{factor:1,offset:0}}),fluid.transforms.linearScale=function(input,extraInputs){var factor=extraInputs.factor(),offset=extraInputs.offset();if("number"==typeof input&&"number"==typeof factor&&"number"==typeof offset)return input*factor+offset},fluid.transforms.linearScale.invert=function(transformSpec){return delete transformSpec.factorPath,delete transformSpec.offsetPath,void 0!==transformSpec.factor&&(transformSpec.factor=0===transformSpec.factor?0:1/transformSpec.factor),void 0!==transformSpec.offset&&(transformSpec.offset=-transformSpec.offset*(void 0!==transformSpec.factor?transformSpec.factor:1)),transformSpec},fluid.defaults("fluid.transforms.binaryOp",{gradeNames:["fluid.multiInputTransformFunction","fluid.standardOutputTransformFunction"],inputVariables:{left:null,right:null}}),fluid.transforms.binaryLookup={"===":function(a,b){return fluid.model.isSameValue(a,b)},"!==":function(a,b){return!fluid.model.isSameValue(a,b)},"<=":function(a,b){return a<=b},"<":function(a,b){return a<b},">=":function(a,b){return a>=b},">":function(a,b){return a>b},"+":function(a,b){return a+b},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"%":function(a,b){return a%b},"&&":function(a,b){return a&&b},"||":function(a,b){return a||b}},fluid.transforms.binaryOp=function(inputs,transformSpec,transformer){var left=inputs.left(),right=inputs.right(),operator=fluid.model.transform.getValue(void 0,transformSpec.operator,transformer),fun=fluid.transforms.binaryLookup[operator];return void 0===fun||void 0===left||void 0===right?void 0:fun(left,right)},fluid.defaults("fluid.transforms.condition",{gradeNames:["fluid.multiInputTransformFunction","fluid.standardOutputTransformFunction"],inputVariables:{true:null,false:null,condition:null}}),fluid.transforms.condition=function(inputs){var condition=inputs.condition();if(null!==condition)return inputs[condition?"true":"false"]()},fluid.defaults("fluid.transforms.valueMapper",{gradeNames:["fluid.lens"],invertConfiguration:"fluid.transforms.valueMapper.invert",collectInputPaths:"fluid.transforms.valueMapper.collect"}),fluid.model.transform.compareMatches=function(speca,specb){var matchDiff=specb.matchValue-speca.matchValue;return 0===matchDiff?speca.index-specb.index:matchDiff},fluid.transforms.valueMapper=function(transformSpec,transformer){transformSpec.match||fluid.fail('valueMapper requires an array or hash of matches at path named "match", supplied ',transformSpec);var value=fluid.model.transform.getValue(transformSpec.defaultInputPath,transformSpec.defaultInput,transformer),matchedEntry=fluid.isArrayable(transformSpec.match)?fluid.transforms.valueMapper.longFormMatch(value,transformSpec,transformer):transformSpec.match[value];if(void 0===matchedEntry&&(matchedEntry=transformSpec.noMatch),void 0!==matchedEntry){var outputValue,outputPath=void 0===matchedEntry.outputPath?transformSpec.defaultOutputPath:matchedEntry.outputPath;return transformer.outputPrefixOp.push(outputPath),outputValue=fluid.isPrimitive(matchedEntry)?matchedEntry:matchedEntry.outputUndefinedValue?void 0:void 0===(outputValue=fluid.model.transform.resolveParam(matchedEntry,transformer,"outputValue",void 0))?transformSpec.defaultOutputValue:outputValue,"string"==typeof outputPath&&void 0!==outputValue&&(fluid.model.transform.setValue(void 0,outputValue,transformer,transformSpec.merge),outputValue=void 0),transformer.outputPrefixOp.pop(),outputValue}},fluid.transforms.valueMapper.longFormMatch=function(valueFromDefaultPath,transformSpec,transformer){var o=transformSpec.match;0===o.length&&fluid.fail("valueMapper supplied empty list of matches: ",transformSpec);for(var matchPower=[],i=0;i<o.length;++i){var option=o[i],value=option.inputPath?fluid.model.transform.getValue(option.inputPath,void 0,transformer):valueFromDefaultPath,matchValue=fluid.model.transform.matchValue(option.inputValue,value,option.partialMatches);matchPower[i]={index:i,matchValue:matchValue}}return matchPower.sort(fluid.model.transform.compareMatches),matchPower[0].matchValue<=0?void 0:o[matchPower[0].index]},fluid.transforms.valueMapper.invert=function(transformSpec,transformer){var match=[],togo={type:"fluid.transforms.valueMapper",match:match},isArray=fluid.isArrayable(transformSpec.match);togo.defaultInputPath=fluid.model.composePaths(transformer.outputPrefix,transformSpec.defaultOutputPath),togo.defaultOutputPath=fluid.model.composePaths(transformer.inputPrefix,transformSpec.defaultInputPath);var def=fluid.firstDefined;return fluid.each(transformSpec.match,(function(option,key){if(!0!==option.outputUndefinedValue){var outOption={},origInputValue=def(isArray?option.inputValue:key,transformSpec.defaultInputValue);void 0===origInputValue&&fluid.fail("Failure inverting configuration for valueMapper - inputValue could not be resolved for record "+key+": ",transformSpec),outOption.outputValue=origInputValue,outOption.inputValue=!isArray&&fluid.isPrimitive(option)?option:def(option.outputValue,transformSpec.defaultOutputValue),option.outputPath&&(outOption.inputPath=fluid.model.composePaths(transformer.outputPrefix,def(option.outputPath,transformSpec.outputPath))),option.inputPath&&(outOption.outputPath=fluid.model.composePaths(transformer.inputPrefix,def(option.inputPath,transformSpec.inputPath))),match.push(outOption)}})),togo},fluid.transforms.valueMapper.collect=function(transformSpec,transformer){var togo=[];return fluid.model.transform.accumulateStandardInputPath("defaultInput",transformSpec,transformer,togo),fluid.each(transformSpec.match,(function(option){fluid.model.transform.accumulateInputPath(option.inputPath,transformer,togo)})),togo},fluid.defaults("fluid.transforms.arrayToSetMembership",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.arrayToSetMembership.invert"}),fluid.transforms.arrayToSetMembership=function(value,transformSpec){value&&fluid.isArrayable(value)||fluid.fail("arrayToSetMembership didn't find array at inputPath nor passed as value.");var output=(transformSpec=transformSpec||{}).arrayValue?[]:{},presentValue=void 0===transformSpec.presentValue||transformSpec.presentValue,missingValue=void 0!==transformSpec.missingValue&&transformSpec.missingValue,options=transformSpec.options;return void 0===options?fluid.each(value,(function(outPath){output[outPath]=presentValue})):fluid.each(options,(function(outPath,key){var outVal=-1!==value.indexOf(key)?presentValue:missingValue;output[outPath]=outVal})),output},fluid.transforms.arrayToSetMembership.invert=function(transformSpec){return fluid.transforms.arrayToSetMembership.invertWithType(transformSpec,"fluid.transforms.setMembershipToArray")},fluid.transforms.arrayToSetMembership.invertWithType=function(transformSpec,newType){transformSpec.type=newType;var newOptions={};return fluid.each(transformSpec.options,(function(path,oldKey){newOptions[path]=oldKey})),$.isEmptyObject(newOptions)||(transformSpec.options=newOptions),transformSpec},fluid.defaults("fluid.transforms.setMembershipToArray",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.setMembershipToArray.invert"}),fluid.transforms.setMembershipToArray=function(input,transformSpec){fluid.isPlainObject(input)||fluid.fail("setMembershipToArray didn't find object at inputPath nor passed as value.");var outputArr=[],presentValue=void 0===(transformSpec=transformSpec||{}).presentValue||transformSpec.presentValue,options=transformSpec.options;return void 0===options?fluid.each(input,(function(keyValue,outputVal){keyValue===presentValue&&outputArr.push(outputVal)})):fluid.each(options,(function(outputVal,key){input[key]===presentValue&&outputArr.push(outputVal)})),outputArr},fluid.transforms.setMembershipToArray.invert=function(transformSpec){return fluid.transforms.arrayToSetMembership.invertWithType(transformSpec,"fluid.transforms.arrayToSetMembership")},fluid.model.transform.applyPaths=function(operation,pathOp,paths){for(var i=0;i<paths.length;++i)"push"===operation?pathOp.push(paths[i]):pathOp.pop()},fluid.model.transform.expandInnerValues=function(inputPath,outputPath,transformer,innerValues){var inputPrefixOp=transformer.inputPrefixOp,outputPrefixOp=transformer.outputPrefixOp,apply=fluid.model.transform.applyPaths;apply("push",inputPrefixOp,inputPath),apply("push",outputPrefixOp,outputPath);var expanded={};return fluid.each(innerValues,(function(innerValue){var expandedInner=transformer.expand(innerValue);fluid.isPrimitive(expandedInner)?expanded=expandedInner:$.extend(!0,expanded,expandedInner)})),apply("pop",outputPrefixOp,outputPath),apply("pop",inputPrefixOp,inputPath),expanded},fluid.defaults("fluid.transforms.indexArrayByKey",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.indexArrayByKey.invert"}),fluid.transforms.indexArrayByKey=function(arr,transformSpec,transformer){void 0===transformSpec.key&&fluid.fail("indexArrayByKey requires a 'key' option.",transformSpec),fluid.isArrayable(arr)||fluid.fail("indexArrayByKey didn't find array at inputPath.",transformSpec);var newHash={},pivot=transformSpec.key;return fluid.each(arr,(function(v,k){var newKey=v[pivot],keyType=typeof newKey;"string"!==keyType&&"boolean"!==keyType&&"number"!==keyType&&fluid.fail("indexArrayByKey encountered untransformable array due to missing or invalid key",v);var content=fluid.copy(v);delete content[pivot],transformSpec.innerValue&&(content=fluid.model.transform.expandInnerValues([transformer.inputPrefix,transformSpec.inputPath,k.toString()],[transformSpec.outputPath,newKey],transformer,transformSpec.innerValue)),newHash[newKey]=content})),newHash},fluid.transforms.indexArrayByKey.invert=function(transformSpec){if(transformSpec.type="fluid.transforms.deindexIntoArrayByKey",transformSpec.innerValue)for(var innerValue=transformSpec.innerValue,i=0;i<innerValue.length;++i){var inverted=fluid.model.transform.invertConfiguration(innerValue[i]);if(inverted===fluid.model.transform.uninvertibleTransform)return inverted;innerValue[i]=inverted}return transformSpec},fluid.defaults("fluid.transforms.deindexIntoArrayByKey",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.deindexIntoArrayByKey.invert"}),fluid.transforms.deindexIntoArrayByKey=function(hash,transformSpec,transformer){void 0===transformSpec.key&&fluid.fail('deindexIntoArrayByKey requires a "key" option.',transformSpec);var newArray=[],pivot=transformSpec.key;return fluid.each(hash,(function(v,k){var content={};content[pivot]=k,transformSpec.innerValue&&(v=fluid.model.transform.expandInnerValues([transformSpec.inputPath,k],[transformSpec.outputPath,newArray.length.toString()],transformer,transformSpec.innerValue)),$.extend(!0,content,v),newArray.push(content)})),newArray},fluid.transforms.deindexIntoArrayByKey.invert=function(transformSpec){if(transformSpec.type="fluid.transforms.indexArrayByKey",transformSpec.innerValue)for(var innerValue=transformSpec.innerValue,i=0;i<innerValue.length;++i)innerValue[i]=fluid.model.transform.invertConfiguration(innerValue[i]);return transformSpec},fluid.defaults("fluid.transforms.limitRange",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.invertToIdentity"}),fluid.transforms.limitRange=function(value,transformSpec){var min=transformSpec.min;void 0!==min&&(value<(min+=transformSpec.excludeMin||0)&&(value=min));var max=transformSpec.max;void 0!==max&&(value>(max-=transformSpec.excludeMax||0)&&(value=max));return value},fluid.defaults("fluid.transforms.indexOf",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.indexOf.invert"}),fluid.transforms.indexOf=function(value,transformSpec){"number"==typeof transformSpec.notFound&&transformSpec.notFound>=0&&fluid.fail("A positive number is not allowed as 'notFound' value for indexOf");var offset=fluid.transforms.parseIndexationOffset(transformSpec.offset,"indexOf"),originalIndex=fluid.makeArray(transformSpec.array).indexOf(value);return-1===originalIndex&&transformSpec.notFound?transformSpec.notFound:originalIndex+offset},fluid.transforms.indexOf.invert=function(transformSpec,transformer){var togo=fluid.transforms.invertArrayIndexation(transformSpec,transformer);return togo.type="fluid.transforms.dereference",togo},fluid.defaults("fluid.transforms.dereference",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.dereference.invert"}),fluid.transforms.dereference=function(value,transformSpec){if("number"==typeof value){var offset=fluid.transforms.parseIndexationOffset(transformSpec.offset,"dereference");return fluid.makeArray(transformSpec.array)[value+offset]}},fluid.transforms.dereference.invert=function(transformSpec,transformer){var togo=fluid.transforms.invertArrayIndexation(transformSpec,transformer);return togo.type="fluid.transforms.indexOf",togo},fluid.transforms.parseIndexationOffset=function(offset,transformName){var parsedOffset=0;return void 0!==offset&&(parsedOffset=fluid.parseInteger(offset),isNaN(parsedOffset)&&fluid.fail(transformName+' requires the value of "offset" to be an integer or a string that can be converted to an integer. '+offset+" is invalid.")),parsedOffset},fluid.transforms.invertArrayIndexation=function(transformSpec){return isNaN(Number(transformSpec.offset))||(transformSpec.offset=-1*Number(transformSpec.offset)),transformSpec},fluid.defaults("fluid.transforms.stringTemplate",{gradeNames:"fluid.standardOutputTransformFunction"}),fluid.transforms.stringTemplate=function(transformSpec){return fluid.stringTemplate(transformSpec.template,transformSpec.terms)},fluid.defaults("fluid.transforms.free",{gradeNames:"fluid.transformFunction"}),fluid.transforms.free=function(transformSpec){var args=fluid.makeArray(transformSpec.args);return transformSpec.func||fluid.fail("Error in transform specification ",transformSpec,' required member "func" was not set'),fluid.event.invokeListener(transformSpec.func,args)},fluid.defaults("fluid.transforms.quantize",{gradeNames:"fluid.standardTransformFunction",collectInputPaths:"fluid.transforms.quantize.collect"}),fluid.transforms.quantize=function(value,transformSpec,transformer){transformSpec.ranges&&transformSpec.ranges.length||fluid.fail("fluid.transforms.quantize should have a key called ranges containing an array defining ranges to quantize");for(var i=0;i<transformSpec.ranges.length;i++){var rangeSpec=transformSpec.ranges[i];if(value<=rangeSpec.upperBound||void 0===rangeSpec.upperBound&&value>=Number.NEGATIVE_INFINITY)return fluid.isPrimitive(rangeSpec.output)?rangeSpec.output:transformer.expand(rangeSpec.output)}},fluid.transforms.quantize.collect=function(transformSpec,transformer){transformSpec.ranges.forEach((function(rangeSpec){fluid.isPrimitive(rangeSpec.output)||transformer.expand(rangeSpec.output)}))},fluid.defaults("fluid.transforms.inRange",{gradeNames:"fluid.standardTransformFunction"}),fluid.transforms.inRange=function(value,transformSpec){return(void 0===transformSpec.min||transformSpec.min<=value)&&(void 0===transformSpec.max||transformSpec.max>=value)},fluid.defaults("fluid.transforms.toggle",{gradeNames:["fluid.standardTransformFunction"],invertConfiguration:"fluid.transforms.toggle.invert",relayOptions:{forward:{excludeSource:"init"},backward:{includeSource:"init"}}}),fluid.transforms.toggle=function(source,transformSpec,transformer){var oldSource=transformer.oldSource,oldTarget=transformer.oldTarget,phase=(oldSource||0)-fluid.transforms.inverseToggle.base(oldTarget);return fluid.transforms.toggle.base(source+phase)},fluid.transforms.toggle.base=function(source){return(source||0)%2==1},fluid.transforms.toggle.invert=function(transformSpec){return transformSpec.type="fluid.transforms.inverseToggle",transformSpec},fluid.defaults("fluid.transforms.inverseToggle",{gradeNames:["fluid.standardTransformFunction"]}),fluid.transforms.inverseToggle=function(source,transformSpec,transformer){return transformer.originalTarget||void 0},fluid.transforms.inverseToggle.base=function(source){return source?1:0},fluid.transforms.parseClasses=function(classes){var classList=classes.match(fluid.transforms.parseClasses.rnothtmlwhite)||[];return fluid.arrayToHash(classList)},fluid.transforms.parseClasses.rnothtmlwhite=/[^\x20\t\r\n\f]+/g,fluid.transforms.stringToBoolean=function(value){return!!value&&!("0"===value||"false"===value)},fluid.transforms.stringToBoolean.invert=function(transformSpec){return transformSpec.type="fluid.transforms.booleanToString",transformSpec},fluid.defaults("fluid.transforms.stringToBoolean",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.stringToBoolean.invert"}),fluid.transforms.booleanToString=function(value){return value?"true":"false"},fluid.transforms.booleanToString.invert=function(transformSpec){return transformSpec.type="fluid.transforms.stringToBoolean",transformSpec},fluid.defaults("fluid.transforms.booleanToString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.booleanToString.invert"}),fluid.transforms.JSONstringToObject=function(value){try{return JSON.parse(value)}catch(e){return}},fluid.transforms.JSONstringToObject.invert=function(transformSpec){return transformSpec.type="fluid.transforms.objectToJSONString",transformSpec},fluid.defaults("fluid.transforms.JSONstringToObject",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.JSONstringToObject.invert"}),fluid.transforms.objectToJSONString=function(value,transformSpec){var space=transformSpec.space||0;return JSON.stringify(value,null,space)},fluid.transforms.objectToJSONString.invert=function(transformSpec){return transformSpec.type="fluid.transforms.JSONstringToObject",transformSpec},fluid.defaults("fluid.transforms.objectToJSONString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.objectToJSONString.invert"}),fluid.transforms.stringToDate=function(value){var date=new Date(value);return isNaN(date.getTime())?void 0:date},fluid.transforms.stringToDate.invert=function(transformSpec){return transformSpec.type="fluid.transforms.dateToString",transformSpec},fluid.defaults("fluid.transforms.stringToDate",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.stringToDate.invert"}),fluid.transforms.dateToString=function(value){if(value instanceof Date){var isoString=value.toISOString();return isoString.substring(0,isoString.indexOf("T"))}},fluid.transforms.dateToString.invert=function(transformSpec){return transformSpec.type="fluid.transforms.stringToDate",transformSpec},fluid.defaults("fluid.transforms.dateToString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.dateToString.invert"}),fluid.transforms.dateTimeToString=function(value){return value instanceof Date?value.toISOString():void 0},fluid.defaults("fluid.transforms.dateTimeToString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.dateToString.invert"}),fluid.registerNamespace("fluid.contextAware"),fluid.defaults("fluid.contextAware.marker",{gradeNames:["fluid.component"]}),fluid.contextAware.makeCheckMarkers=function(checks,path,instantiator){fluid.each(checks,(function(value,markerTypeName){fluid.constructSingle(path,{type:markerTypeName,gradeNames:"fluid.contextAware.marker",value:value},instantiator)}))},fluid.contextAware.performChecks=function(checkHash){return fluid.transform(checkHash,(function(checkRecord){return"function"==typeof checkRecord?checkRecord={func:checkRecord}:"string"==typeof checkRecord&&(checkRecord={funcName:checkRecord}),fluid.isPrimitive(checkRecord)?checkRecord:"value"in checkRecord?checkRecord.value:"func"in checkRecord?checkRecord.func():"funcName"in checkRecord?fluid.invokeGlobalFunction(checkRecord.funcName):void fluid.fail("Error in contextAwareness check record ",checkRecord," - must contain an entry with name value, func, or funcName")}))},fluid.contextAware.makeChecks=function(checkHash,path,instantiator){var checkOptions=fluid.contextAware.performChecks(checkHash);fluid.contextAware.makeCheckMarkers(checkOptions,path,instantiator)},fluid.contextAware.forgetChecks=function(markerNames,path,instantiator){instantiator=instantiator||fluid.globalInstantiator,path=path||[];var markerArray=fluid.makeArray(markerNames);fluid.each(markerArray,(function(markerName){var memberName=fluid.typeNameToMemberName(markerName),segs=fluid.model.parseToSegments(path,instantiator.parseEL,!0);segs.push(memberName),fluid.destroy(segs,instantiator)}))},fluid.defaults("fluid.contextAware",{mergePolicy:{contextAwareness:"noexpand"},contextAwareness:{}}),fluid.contextAware.getCheckValue=function(that,reference){var targetRef=fluid.parseContextReference(reference),targetComponent=fluid.resolveContext(targetRef.context,that),path=targetRef.path||(fluid.isComponent(targetComponent)&&fluid.componentHasGrade(targetComponent,"fluid.contextAware.marker")?["options","value"]:[]);return fluid.getForComponent(targetComponent,path)},fluid.contextAware.checkOne=function(that,contextAwareRecord){contextAwareRecord.checks&&contextAwareRecord.checks.contextValue&&fluid.fail("Nesting error in contextAwareness record ",contextAwareRecord,' - the "checks" entry must contain a hash and not a contextValue/gradeNames record at top level');var checkList=fluid.parsePriorityRecords(contextAwareRecord.checks,"contextAwareness checkRecord");return fluid.find(checkList,(function(check){check.contextValue||fluid.fail("Cannot perform check for contextAwareness record ",check,' without a valid field named "contextValue"');var value=fluid.contextAware.getCheckValue(that,check.contextValue);if(void 0===check.equals?value:value===check.equals)return check.gradeNames}),contextAwareRecord.defaultGradeNames)},fluid.contextAware.check=function(that,contextAwarenessOptions){var gradeNames=[],contextAwareList=fluid.parsePriorityRecords(contextAwarenessOptions,"contextAwareness adaptationRecord");return fluid.each(contextAwareList,(function(record){var matched=fluid.contextAware.checkOne(that,record);gradeNames=gradeNames.concat(fluid.makeArray(matched))})),gradeNames},fluid.contextAware.makeAdaptation=function(options){fluid.expect("fluid.contextAware.makeAdaptation",options,["distributionName","targetName","adaptationName","checkName","record"]),fluid.defaults(options.distributionName,{gradeNames:["fluid.component"],distributeOptions:{target:"{/ "+options.targetName+"}.options.contextAwareness."+options.adaptationName+".checks."+options.checkName,record:options.record}}),fluid.constructSingle([],options.distributionName)},fluid.contextAware.isBrowser=function(){return"undefined"!=typeof window&&!!window.document},fluid.contextAware.isNode=function(){return"undefined"!=typeof process&&process.versions&&process.versions.node},fluid.contextAware.makeChecks({"fluid.browser":{funcName:"fluid.contextAware.isBrowser"},"fluid.node":{funcName:"fluid.contextAware.isNode"}}),fluid.registerNamespace("fluid.contextAware.browser"),fluid.contextAware.browser.getPlatformName=function(){return"undefined"!=typeof navigator&&navigator.platform?navigator.platform:void 0},fluid.contextAware.browser.getUserAgent=function(){return"undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent:void 0},fluid.contextAware.makeChecks({"fluid.browser.platformName":{funcName:"fluid.contextAware.browser.getPlatformName"},"fluid.browser.userAgent":{funcName:"fluid.contextAware.browser.getUserAgent"}}),fluid.contextAware.isBrowser()&&$.fn&&$("head").append("<style type='text/css'>.fl-progEnhance-basic, .fl-ProgEnhance-basic { display: none; } .fl-progEnhance-enhanced, .fl-ProgEnhance-enhanced { display: block; }</style>"),fluid.apply=function(options){return options.func.apply(null,options.args)},fluid.defaults("fluid.baseViewComponent",{gradeNames:"fluid.component",argumentMap:{container:0,options:1},events:{onDomBind:"promise"},listeners:{"onCreate.onDomBind":"{that}.events.onDomBind"},selectors:{},members:{dom:"@expand:fluid.createDomBinder({that}.container, {that}.options.selectors)",locate:"{that}.dom.locate"},mergePolicy:{"members.dom":"replace","members.container":"replace"}}),fluid.defaults("fluid.viewComponent",{gradeNames:["fluid.modelComponent","fluid.baseViewComponent"],members:{container:"@expand:fluid.containerForViewComponent({that}, {that}.options.container)"}}),fluid.dumpSelector=function(selectable){return"string"==typeof selectable?selectable:selectable.selector?selectable.selector:""},fluid.checkTryCatchParameter=function(){var GETparams=(window.location||{search:"",protocol:"file:"}).search.slice(1).split("&");return!0===fluid.find(GETparams,(function(param){if(0===param.indexOf("notrycatch"))return!0}))},fluid.notrycatch=fluid.checkTryCatchParameter(),fluid.wrap=function(obj,userJQuery){return userJQuery=userJQuery||$,!obj||obj.jquery?obj:userJQuery(obj)},fluid.unwrap=function(obj){return obj&&obj.jquery?obj[0]:obj},fluid.container=function(containerSpec,fallible,userJQuery){containerSpec||fluid.fail("fluid.container argument is empty");var selector=containerSpec.selector||containerSpec;userJQuery&&(containerSpec=fluid.unwrap(containerSpec));var container=fluid.wrap(containerSpec,userJQuery);if(fallible&&(!container||0===container.length))return null;if(!container||!container.jquery||1!==container.length){"string"!=typeof containerSpec&&(containerSpec=container.selector);var count=void 0!==container.length?container.length:0,extraMessage=container.selectorName?" with selector name "+container.selectorName+" in context "+fluid.dumpEl(containerSpec.context):"";fluid.fail((count>1?"More than one ("+count+") container elements were":"No container element was")+" found for selector "+containerSpec+extraMessage)}return fluid.isDOMNode(container[0])||fluid.fail("fluid.container was supplied a non-jQueryable element"),container.selector=selector,container.context=container.context||containerSpec.ownerDocument||document,container},fluid.createDomBinder=function(container,selectors){var userJQuery=container.constructor,that={container:container,id:fluid.allocateGuid(),doQuery:function(selector){return userJQuery(selector,that.container)},cache:{},locate:function(selectorName){var togo,selector="container"===selectorName?"":selectors[selectorName];return void 0===selector&&fluid.fail("DOM binder request for selector "+selectorName+" which is not registered"),(togo=""===selector?that.container:that.doQuery(selector,selectorName)).selector=selector,togo.context=that.container,togo.selectorName=selectorName,that.cache[selectorName]=togo,togo},fastLocate:function(selectorName){return that.cache[selectorName]||that.locate(selectorName)},resetContainer:function(container){that.container=container,that.clear()},clear:function(){that.cache={}}};return that.resolvePathSegment=that.locate,that},fluid.createLocalContainerDomBinder=function(container,selectors){var that={container:container,id:fluid.allocateGuid(),cache:{}},userJQuery=container.constructor;function cacheKey(name,thisContainer){return fluid.allocateSimpleId(thisContainer)+"-"+name}return that.locate=function(name,localContainer){var selector,thisContainer,togo;return void 0===(selector=selectors[name])&&("container"===name?selector="":fluid.fail("DOM binder request for selector "+name+" which is not registered")),(thisContainer=localContainer||that.container)||fluid.fail("DOM binder invoked for selector "+name+" without container"),(togo=""===selector?userJQuery(thisContainer):"function"==typeof selector?userJQuery(selector.call(null,fluid.unwrap(thisContainer))):userJQuery(selector,thisContainer)).selector||(togo.selector=selector,togo.context=thisContainer),togo.selectorName=name,function(name,thisContainer,result){that.cache[cacheKey(name,thisContainer)]=result}(name,thisContainer,togo),togo},that.fastLocate=function(name,localContainer){var key=cacheKey(name,localContainer||that.container),togo=that.cache[key];return togo||that.locate(name,localContainer)},that.resetContainer=function(container){that.container=container,that.clear()},that.clear=function(){that.cache={}},that.refresh=function(names,localContainer){var thisContainer=localContainer||that.container;"string"==typeof names&&(names=[names]),void 0===thisContainer.length&&(thisContainer=[thisContainer]);for(var i=0;i<names.length;++i)for(var j=0;j<thisContainer.length;++j)that.locate(names[i],thisContainer[j])},that.resolvePathSegment=that.locate,that},fluid.expectFilledSelector=function(result,message){result&&0===result.length&&result.jquery&&fluid.fail(message+': selector "'+result.selector+'" with name '+result.selectorName+" returned no results in context "+fluid.dumpEl(result.context))},fluid.containerForViewComponent=function(that,containerSpec){var container=fluid.container(containerSpec);return fluid.expectFilledSelector(container,'Error instantiating viewComponent at path "'+fluid.pathForComponent(that)),container},fluid.getId=function(element){return fluid.unwrap(element).id},fluid.allocateSimpleId=function(element){if(!(element=fluid.unwrap(element))||fluid.isPrimitive(element))return null;if(!element.id){var simpleId="fluid-id-"+fluid.allocateGuid();element.id=simpleId}return element.id},fluid.registerNamespace("fluid.materialisers"),fluid.makeDomMaterialiserManager=function(){return{idToModelListeners:{}}},fluid.checkMaterialisedElement=function(element,selectorName,that){element&&element.length||fluid.fail("Could not locate element for selector "+selectorName+" for component "+fluid.dumpComponentAndPath(that))},fluid.domMaterialiserManager=fluid.makeDomMaterialiserManager(),fluid.materialisers.domOutput=function(that,segs,type,options){fluid.freezeRecursive(segs);var selectorName=segs[1],listener=function(value){if(that.dom){var element=that.dom.locate(selectorName);if(fluid.checkMaterialisedElement(element,selectorName,that),"jQuery"===type){var model={value:value,segs:segs},args=options.makeArgs?options.makeArgs(model):[model.value];element[options.method].apply(element,args)}else if("booleanAttr"===type)if(void 0===value){var markupValue=!!element.attr(options.attr);that.applier.change(segs,options.negate?!markupValue:markupValue)}else{(options.negate?!value:value)?element.attr(options.attr,options.attr):element.removeAttr(options.attr)}}};that.applier.modelChanged.addListener({segs:segs},listener),that.events.onDomBind.addListener((function(){var modelValue=fluid.getImmediate(that.model,segs);listener(modelValue)}))},fluid.incrementModel=function(that,segs){var oldValue=fluid.getImmediate(that.model,segs)||0;that.applier.change(segs,oldValue+1)},fluid.materialisers.domClick=function(that,segs){var listener=function(){fluid.incrementModel(that,segs)};that.events.onDomBind.addListener((function(){that.dom.locate(segs[1]).click(listener)}))},fluid.materialisers.hover=function(that,segs){var makeListener=function(state){return function(){that.applier.change(segs,state)}};that.events.onDomBind.addListener((function(){that.dom.locate(segs[1]).hover(makeListener(!0),makeListener(!1))}))},fluid.materialisers.focusin=function(that,segs){var makeListener=function(state){return function(){that.applier.change(segs,state)}};that.events.onDomBind.addListener((function(){that.dom.locate(segs[1]).focusin(makeListener(!0)).focusout(makeListener(!1))}))},fluid.materialisers.id=function(that,segs){that.events.onDomBind.addListener((function(){var element=that.dom.locate(segs[1])[0],modelValue=fluid.getImmediate(that.model,segs);if(void 0===modelValue){var id=fluid.allocateSimpleId(element);that.applier.change(segs,id,"ADD","DOM")}else element.id=modelValue;that.applier.modelChanged.addListener({segs:segs},(function(value){void 0!==value&&(element.id=value)}))}))},fluid.materialisers.domValue=function(that,segs){that.events.onDomBind.addListener((function(){var element=that.dom.locate(segs[1]),modelListener=function(value){void 0!==value&&fluid.value(element,value)};that.applier.modelChanged.addListener({segs:segs},modelListener);var options=fluid.getImmediate(that,["options","bindingOptions",fluid.model.composeSegments.apply(null,segs)]),changeEvent=options&&options.changeEvent||"change";element.on(changeEvent,(function(){var val=fluid.value(element);that.applier.change(segs,val,"ADD","DOM")})),modelListener(fluid.getImmediate(that.model,segs))}))},fluid.materialisers.style=function(that,segs){var selectorName=segs[1];that.events.onDomBind.addListener((function(){var element=that.dom.locate(selectorName);fluid.checkMaterialisedElement(element,selectorName,that);var modelValue=fluid.getImmediate(that.model,segs);element[0].style[segs[3]]=modelValue}))},fluid.registerNamespace("fluid.materialiserRegistry"),fluid.materialiserRegistry["fluid.viewComponent"]={dom:{"*":{text:{materialiser:"fluid.materialisers.domOutput",args:["jQuery",{method:"text"}]},attr:{materialiser:"fluid.materialisers.domOutput",args:["jQuery",{method:"attr",makeArgs:function(model){return[model.segs[3],model.value]}}]},visible:{materialiser:"fluid.materialisers.domOutput",args:["jQuery",{method:"toggle"}]},enabled:{materialiser:"fluid.materialisers.domOutput",args:["booleanAttr",{attr:"disabled",negate:!0}]},click:{materialiser:"fluid.materialisers.domClick"},hover:{materialiser:"fluid.materialisers.hover"},focusin:{materialiser:"fluid.materialisers.focusin"},value:{materialiser:"fluid.materialisers.domValue"},class:{materialiser:"fluid.materialisers.domOutput",args:["jQuery",{method:"toggleClass",makeArgs:function(model){return[model.segs[3],!!model.value]}}]},style:{materialiser:"fluid.materialisers.style"},id:{materialiser:"fluid.materialisers.id"}}}},fluid.value=function(nodeIn,newValue){var node=fluid.unwrap(nodeIn),isMultiple=!1;if(void 0===node.nodeType&&node.length>1&&(node=node[0],isMultiple=!0),"input"!==node.nodeName.toLowerCase()||!/radio|checkbox/.test(node.type))return void 0===newValue?$(node).val():$(node).val(newValue);var elements,name=node.name;if(isMultiple||""===name)elements=nodeIn;else{elements=node.ownerDocument.getElementsByName(name);var scope=fluid.findForm(node);isMultiple=(elements=$.grep(elements,(function(element){return element.name===name&&(!scope||scope.contains(element))}))).length>1}if(void 0===newValue){var checked=$.map(elements,(function(element){return element.checked?element.value:null}));return"radio"===node.type?checked[0]:isMultiple?checked:!!checked[0]}"boolean"==typeof newValue&&(newValue=newValue?"true":"false"),$.each(elements,(function(){this.checked=newValue instanceof Array?-1!==newValue.indexOf(this.value):newValue===this.value}))},fluid.defaults("fluid.ariaLabeller",{gradeNames:"fluid.viewComponent"}),fluid.changeElementValue=function(node,value){node=$(node),fluid.value(node,value),node.change()},fluid.findAncestor=function(element,test){for(element=fluid.unwrap(element);element;){if(test(element))return element;element=element.parentNode}},fluid.findForm=function(node){return fluid.findAncestor(node,(function(element){return"form"===element.nodeName.toLowerCase()}))},fluid.each(["text","html"],(function(method){fluid[method]=function(node,newValue){return node=$(node),void 0===newValue?node[method]():node[method](newValue)}})),fluid.BINDING_ROOT_KEY="fluid-binding-root",fluid.findData=function(elem,name){for(;elem;){var data=$.data(elem,name);if(data)return data;elem=elem.parentNode}},fluid.bindFossils=function(node,data,fossils){$.data(node,fluid.BINDING_ROOT_KEY,{data:data,fossils:fossils})},fluid.boundPathForNode=function(node,fossils){var record=fossils[(node=fluid.unwrap(node)).name||node.id];return record?record.EL:null},fluid.applyBoundChange=function(node,newValue,applier){node=fluid.unwrap(node),void 0===newValue&&(newValue=fluid.value(node)),void 0===node.nodeType&&node.length>0&&(node=node[0]);var root=fluid.findData(node,fluid.BINDING_ROOT_KEY);root||fluid.fail("Bound data could not be discovered in any node above "+fluid.dumpEl(node));var name=node.name;root.fossils[name]||fluid.fail("No fossil discovered for name "+name+" in fossil record above "+fluid.dumpEl(node));var EL=root.fossils[name].EL;applier?applier.fireChangeRequest({path:EL,value:newValue,source:"DOM:"+node.id}):fluid.set(root.data,EL,newValue)},fluid.jById=function(id,dokkument){dokkument=dokkument&&9===dokkument.nodeType?dokkument:document;var element=fluid.byId(id,dokkument),togo=element?$(element):[];return togo.selector="#"+id,togo.context=dokkument,togo},fluid.byId=function(id,dokkument){var el=(dokkument=dokkument&&9===dokkument.nodeType?dokkument:document).getElementById(id);return el?(el.id!==id&&fluid.fail("Problem in document structure - picked up element "+fluid.dumpEl(el)+" for id "+id+" without this id - most likely the element has a name which conflicts with this id"),el):null},fluid.getDocument=function(element){var node=fluid.unwrap(element);return 9===node.nodeType?node:node.ownerDocument},fluid.defaults("fluid.ariaLabeller",{gradeNames:["fluid.viewComponent"],labelAttribute:"aria-label",liveRegionMarkup:'<div class="liveRegion fl-hidden-accessible" aria-live="polite"></div>',liveRegionId:"fluid-ariaLabeller-liveRegion",invokers:{generateLiveElement:{funcName:"fluid.ariaLabeller.generateLiveElement",args:"{that}"},update:{funcName:"fluid.ariaLabeller.update",args:["{that}","{arguments}.0"]}},listeners:{onCreate:{func:"{that}.update",args:[null]}}}),fluid.ariaLabeller.update=function(that,newOptions){if(newOptions=newOptions||that.options,that.container.attr(that.options.labelAttribute,newOptions.text),newOptions.dynamicLabel){var live=fluid.jById(that.options.liveRegionId);0===live.length&&(live=that.generateLiveElement()),live.text(newOptions.text)}},fluid.ariaLabeller.generateLiveElement=function(that){var liveEl=$(that.options.liveRegionMarkup);return liveEl.prop("id",that.options.liveRegionId),$("body").append(liveEl),liveEl};var LABEL_KEY="aria-labelling";fluid.getAriaLabeller=function(element){return element=$(element),fluid.getScopedData(element,LABEL_KEY)},fluid.updateAriaLabel=function(element,text,options){options=$.extend({},options||{},{text:text});var that=fluid.getAriaLabeller(element);return that?that.update(options):(that=fluid.ariaLabeller(element,options),fluid.setScopedData(element,LABEL_KEY,that)),that},fluid.dismissList={},$(document).click((function(event){for(var target=fluid.resolveEventTarget(event);target;){if(fluid.dismissList[target.id])return;target=target.parentNode}fluid.each(fluid.dismissList,(function(dismissFunc,key){dismissFunc(event),delete fluid.dismissList[key]}))})),fluid.globalDismissal=function(nodes,dismissFunc){fluid.each(nodes,(function(node){var id=fluid.unwrap(node).ownerDocument===document?fluid.allocateSimpleId(node):fluid.allocateGuid();dismissFunc?fluid.dismissList[id]=dismissFunc:delete fluid.dismissList[id]}))},fluid.deadMansBlur=function(control,options){var that={options:$.extend(!0,{},fluid.defaults("fluid.deadMansBlur"),options),blurPending:!1,lastCancel:0,canceller:function(event){fluid.log("Cancellation through "+event.type+" on "+fluid.dumpEl(event.target)),that.lastCancel=Date.now(),that.blurPending=!1},noteProceeded:function(){fluid.globalDismissal(that.options.exclusions)},reArm:function(){fluid.globalDismissal(that.options.exclusions,that.proceed)},addExclusion:function(exclusions){fluid.globalDismissal(exclusions,that.proceed)},proceed:function(event){fluid.log("Direct proceed through "+event.type+" on "+fluid.dumpEl(event.target)),that.blurPending=!1,that.options.handler(control)}};return fluid.each(that.options.exclusions,(function(exclusion){exclusion=$(exclusion),fluid.each(exclusion,(function(excludeEl){$(excludeEl).on("focusin",that.canceller).on("fluid-focus",that.canceller).click(that.canceller).mousedown(that.canceller)}))})),that.options.cancelByDefault?that.reArm():$(control).on("focusout",(function(event){fluid.log("Starting blur timer for element "+fluid.dumpEl(event.target));var now=Date.now();fluid.log("back delay: "+(now-that.lastCancel)),now-that.lastCancel>that.options.backDelay&&(that.blurPending=!0),setTimeout((function(){that.blurPending&&that.options.handler(control)}),that.options.delay)})),that},fluid.defaults("fluid.deadMansBlur",{gradeNames:"fluid.function",delay:150,backDelay:100}),fluid.defaults("fluid.newViewComponent",{gradeNames:"fluid.viewComponent",listeners:{"onCreate.onDomBind":null}}),fluid.defaults("fluid.containerRenderingView",{gradeNames:["fluid.newViewComponent"],members:{container:"@expand:{that}.renderContainer()"},parentContainer:"{that}.options.container",injectionType:"append",invokers:{renderMarkup:"fluid.identity({that}.options.markup.container)",renderContainer:"fluid.containerRenderingView.renderContainer({that}, {that}.renderMarkup, {that}.addToParent)",addToParent:{funcName:"fluid.containerRenderingView.addToParent",args:["{that}.options.parentContainer","{arguments}.0","{that}.options.injectionType"]}},workflows:{global:{evaluateContainers:{funcName:"fluid.renderer.evaluateContainers",priority:"last",waitIO:!0}}},listeners:{"onDestroy.clearInjectedMarkup":{this:"{that}.container",method:"remove",args:[]}}}),fluid.registerNamespace("fluid.renderer"),fluid.defaults("fluid.templateResourceFetcher",{gradeNames:"fluid.resourceLoader",rendererTemplateResources:{template:!0},skipTemplateFetch:!1,workflows:{global:{fetchTemplates:{funcName:"fluid.renderer.fetchTemplates",priority:"after:resolveResourceModel"}}}}),fluid.renderer.fetchTemplates=function(shadows){shadows.forEach((function(shadow){var that=shadow.that;if(fluid.componentHasGrade(that,"fluid.templateResourceFetcher")&&!fluid.getForComponent(that,["options","skipTemplateFetch"])){var rendererTemplateResources=fluid.getForComponent(that,["options","rendererTemplateResources"]);fluid.each(rendererTemplateResources,(function(value,key){value&&fluid.getForComponent(that,["resources",key])}))}}))},fluid.containerRenderingView.addToParent=function(parentContainer,elm,method){parentContainer||fluid.fail('fluid.containerRenderingView needs to have "parentContainer" or "container" option supplied'),method=method||"append",$(parentContainer)[method](elm)},fluid.renderer.evaluateContainers=function(shadows){shadows.forEach((function(shadow){fluid.getForComponent(shadow.that,"container")})),shadows.forEach((function(shadow){shadow.that.events.onDomBind.fire(shadow.that)}))},fluid.containerRenderingView.renderContainer=function(that,renderMarkup,addToParent){fluid.log("Rendering container for "+that.id);var containerMarkup=renderMarkup(),container=$(containerMarkup);return addToParent(container),container},fluid.defaults("fluid.templateRenderingView",{gradeNames:["fluid.containerRenderingView","fluid.templateResourceFetcher"],invokers:{renderMarkup:"fluid.identity({that}.resources.template.parsed)"},distributeOptions:{mapTemplateUrl:{source:"{that}.options.templateUrl",target:"{that}.options.resources.template.url"}}}),fluid.defaults("fluid.dataSource.encoding.JSON",{gradeNames:"fluid.component",invokers:{parse:"fluid.dataSource.parseJSON",render:"fluid.dataSource.stringifyJSON"},contentType:"application/json"}),fluid.defaults("fluid.dataSource.encoding.none",{gradeNames:"fluid.component",invokers:{parse:"fluid.identity",render:"fluid.identity"},contentType:"text/plain"}),fluid.dataSource.parseJSON=function(string){var togo=fluid.promise();if(string)try{togo.resolve(JSON.parse(string))}catch(err){togo.reject(err)}else togo.resolve(void 0);return togo},fluid.dataSource.stringifyJSON=function(obj){return void 0===obj?"":JSON.stringify(obj,null,4)},fluid.defaults("fluid.dataSource",{gradeNames:["fluid.component","fluid.contextAware"],contextAwareness:{writable:{checks:{writableValue:{contextValue:"{fluid.dataSource}.options.writable",gradeNames:"{fluid.dataSource}.options.writableGrade"}}}},writable:!1,events:{onRead:null,onError:null},components:{encoding:{type:"fluid.dataSource.encoding.JSON"}},listeners:{"onRead.impl":{func:"fluid.notImplemented",priority:"first"},"onRead.encoding":{func:"{encoding}.parse",priority:"after:impl"}},invokers:{get:{funcName:"fluid.dataSource.get",args:["{that}","{arguments}.0","{arguments}.1"]}}}),fluid.defaults("fluid.dataSource.writable",{gradeNames:["fluid.component"],events:{onWrite:null,onWriteResponse:null},listeners:{"onWrite.encoding":{func:"{encoding}.render"},"onWrite.impl":{func:"fluid.notImplemented",priority:"after:encoding"},"onWriteResponse.encoding":{func:"{encoding}.parse"}},invokers:{set:{funcName:"fluid.dataSource.set",args:["{that}","{arguments}.0","{arguments}.1","{arguments}.2"]}}}),fluid.dataSource.registerStandardPromiseHandlers=function(that,promise,requestOptions){promise.then(requestOptions.callback,requestOptions.onError?requestOptions.onError:that.events.onError.fire)},fluid.dataSource.defaultiseOptions=function(componentOptions,directOptions,directModel,isSet){var options="function"==typeof directOptions?{callback:directOptions}:fluid.copy(directOptions)||{};return options.directModel=directModel,options.operation=isSet?"set":"get",options.notFoundIsEmpty=options.notFoundIsEmpty||componentOptions.notFoundIsEmpty,options},fluid.dataSource.get=function(that,directModel,directOptions){var requestOptions=fluid.dataSource.defaultiseOptions(that.options,directOptions,directModel),promise=fluid.promise.fireTransformEvent(that.events.onRead,void 0,requestOptions);return fluid.dataSource.registerStandardPromiseHandlers(that,promise,requestOptions),promise},fluid.dataSource.set=function(that,directModel,model,directOptions){var requestOptions=fluid.dataSource.defaultiseOptions(that.options,directOptions,directModel,!0),transformPromise=fluid.promise.fireTransformEvent(that.events.onWrite,model,requestOptions),togo=fluid.promise();return transformPromise.then((function(setResponse){var options2=fluid.dataSource.defaultiseOptions(that.options,fluid.copy(requestOptions),directModel),retransformed=fluid.promise.fireTransformEvent(that.events.onWriteResponse,setResponse,options2);fluid.promise.follow(retransformed,togo)}),(function(error){togo.reject(error)})),fluid.dataSource.registerStandardPromiseHandlers(that,togo,requestOptions),togo},fluid.defaults("fluid.dataSource.URL",{gradeNames:["fluid.dataSource"],writableGrade:"fluid.dataSource.URL.writable",invokers:{resolveUrl:"fluid.dataSource.URL.resolveUrl",handleHttp:"fluid.dataSource.URL.handleHttp"},listeners:{"onRead.impl":{funcName:"fluid.dataSource.URL.handle",args:["{that}","{that}.options.permittedRequestOptions","{arguments}.0","{arguments}.1"]}},permittedRequestOptions:"fluid.dataSource.URL.requestOptions",components:{cookieJar:"{cookieJar}"},termMap:{}}),fluid.defaults("fluid.dataSource.URL.writable",{gradeNames:["fluid.dataSource.writable"],listeners:{"onWrite.impl":{funcName:"fluid.dataSource.URL.handle",args:["{that}","{that}.options.permittedRequestOptions","{arguments}.0","{arguments}.1"]}}}),fluid.dataSource.URL.resolveUrl=function(url,termMap,directModel,noencode){var map=fluid.transform(termMap,(function(entry){entry=String(entry);var encode=!noencode;0===entry.indexOf("noencode:")&&(encode=!1,entry=entry.substring(9));var value="%"===entry.charAt(0)?fluid.get(directModel,entry.substring(1)):entry;return encode&&(value=encodeURIComponent(value)),value}));return fluid.stringTemplate(url,map)},fluid.dataSource.URL.urlFields=fluid.freezeRecursive(["protocol","username","password","hostname","port","pathname","search"]),fluid.dataSource.URL.condenseUrl=function(requestOptions){var togo=new fluid.resourceLoader.UrlClass("http://localhost/");return fluid.dataSource.URL.urlFields.forEach((function(field){requestOptions[field]&&(togo[field]=requestOptions[field])})),togo},fluid.dataSource.URL.requestOptions=fluid.dataSource.URL.urlFields.concat(["url","method","headers","termMap"]),fluid.dataSource.URL.prepareRequestOptions=function(componentOptions,cookieJar,userOptions,permittedOptions,directModel,userStaticOptions){var staticOptions=fluid.filterKeys(componentOptions,permittedOptions),requestOptions=fluid.extend(!0,{headers:{}},userStaticOptions,staticOptions,userOptions);return fluid.contextAware.isNode()&&"localhost"===requestOptions.hostname&&(requestOptions.hostname="127.0.0.1"),requestOptions.writeMethod=requestOptions.writeMethod||componentOptions.writeMethod||"PUT",requestOptions.pathname=fluid.dataSource.URL.resolveUrl(requestOptions.pathname,requestOptions.termMap,directModel),cookieJar&&cookieJar.cookie&&componentOptions.storeCookies&&(requestOptions.headers.Cookie=cookieJar.cookie),requestOptions},fluid.dataSource.URL.parse=function(url,permittedOptions){var parsed=fluid.filterKeys(new fluid.resourceLoader.UrlClass(url,"undefined"!=typeof window&&window.location||void 0),fluid.dataSource.URL.urlFields);return permittedOptions.forEach((function(oneOption){parsed[oneOption]||delete parsed[oneOption]})),parsed},fluid.dataSource.URL.isErrorStatus=function(statusCode){return statusCode<200||statusCode>=300},fluid.dataSource.URL.handle=function(that,permittedRequestOptions,model,userOptions){var permittedOptions=fluid.getGlobalValue(permittedRequestOptions);permittedOptions.forEach((function(oneOption){fluid.getForComponent(that,["options",oneOption])}));var directModel=userOptions.directModel,url=that.resolveUrl(that.options.url,that.options.termMap,directModel),parsed=fluid.dataSource.URL.parse(url,permittedOptions),finalRequestOptions=fluid.dataSource.URL.prepareRequestOptions(that.options,that.cookieJar,userOptions,permittedOptions,directModel,parsed);return that.handleHttp(that,finalRequestOptions,model)},fluid.extractHtmlError=function(received){var matches=/<pre>(.*)<\/pre>/gm.exec(received);return matches?matches[1]:received},fluid.dataSource.URL.relayError=function(statusCode,received,whileMsg){var rejectPayload;try{rejectPayload=JSON.parse(received)}catch(e){rejectPayload={message:"string"==typeof received&&-1!==received.indexOf("<html")?fluid.extractHtmlError(received):received}}return rejectPayload.message=rejectPayload.message||rejectPayload.error,delete rejectPayload.error,rejectPayload.isError=!0,rejectPayload.statusCode=statusCode,fluid.upgradeError(rejectPayload,whileMsg)},fluid.explodeLocalisedName=function(fileName,locale,defaultLocale){var lastDot=fileName.lastIndexOf(".");-1!==lastDot&&0!==lastDot||(lastDot=fileName.length);var baseName=fileName.substring(0,lastDot),extension=fileName.substring(lastDot),segs=locale?locale.split("_"):[],exploded=fluid.transform(segs,(function(seg,index){var shortSegs=segs.slice(0,index+1);return baseName+"_"+shortSegs.join("_")+extension}));return defaultLocale&&exploded.unshift(baseName+"_"+defaultLocale+extension),exploded.unshift(fileName),exploded},fluid.fetchResources=function(resourceSpecs,callback,options){var that=fluid.makeResourceFetcher(resourceSpecs,callback,options,fluid.identity);return that.optionsReady.resolve(),that.fetchAll(),that},fluid.fetchResources.explodeForLocales=function(resourceFetcher){fluid.each(resourceFetcher.resourceSpecs,(function(resourceSpec){if(resourceSpec.resolvedDefaultLocale=resourceSpec.defaultLocale||resourceFetcher.options.defaultLocale,resourceSpec.resolvedLocale=resourceFetcher.options.locale||resourceSpec.locale||resourceSpec.resolvedDefaultLocale,!resourceSpec.loader.loader.noPath){var pathKey=resourceSpec.loader.pathKey,path=resourceSpec[pathKey],resolvedPath=resourceSpec[pathKey]=resourceFetcher.transformResourceURL(path);resourceSpec.localeExploded=fluid.explodeLocalisedName(resolvedPath,resourceSpec.resolvedLocale,resourceSpec.resolvedDefaultLocale),resourceSpec.localeExplodedSpecs=fluid.transform(resourceSpec.localeExploded,(function(oneExploded){var togo={loader:resourceSpec.loader,options:resourceSpec.options};return togo[pathKey]=oneExploded,togo}),fluid.fetchResources.prepareRequestOptions)}}))},fluid.fetchResources.launchExplodedLocales=function(localeExplodedSpecs,loader){var promiseArray=fluid.transform(localeExplodedSpecs,loader,(function(promise){var promiseToGo=fluid.promise();return promise.then((function(resolve){promiseToGo.resolve({resolved:resolve})}),(function(error){promiseToGo.resolve({rejected:error})})),promiseToGo}));return fluid.promise.sequence(promiseArray)},fluid.fetchResources.condenseExplodedLocales=function(resourceSpec,settledArray){var togo=fluid.promise();settledArray.reverse();var lastNonError=fluid.find(settledArray,(function(settled){return settled.resolved}));return lastNonError?togo.resolve(lastNonError):togo.reject({isError:!0,message:"No localised variants of the resource could be found at any of the paths "+resourceSpec.localeExploded.join(", ")}),togo},fluid.fetchResources.resolveLoaderTask=function(resourceSpec,loader){return resourceSpec.localeExplodedSpecs?function(){var togo=fluid.promise();return fluid.fetchResources.launchExplodedLocales(resourceSpec.localeExplodedSpecs,loader).then((function(settledArray){var condensed=fluid.fetchResources.condenseExplodedLocales(resourceSpec,settledArray);fluid.promise.follow(condensed,togo)})),togo}:function(){return loader(resourceSpec)}},fluid.fetchResources.checkCompletion=function(resourceSpecs,resourceFetcher){if(!fluid.find_if(resourceSpecs,(function(resourceSpec){return!resourceSpec.promise.disposition}))){var completionPromise=resourceFetcher.completionPromise;fluid.invokeLater((function(){completionPromise.disposition||completionPromise.resolve(resourceSpecs)}))}},fluid.fetchResources.noteResourceText=function(resourceText,options){return options.resourceSpec.resourceText=resourceText,resourceText},fluid.fetchResources.noteParsed=function(parsed,options){return options.resourceSpec.parsed=parsed,parsed},fluid.fetchResources.fireFetched=function(parsed,options){return options.resourceSpec.onFetched.fire(parsed),parsed},fluid.fetchResources.prepareRequestOptions=function(resourceSpec){var pathKey=resourceSpec.loader.pathKey,requestOptions={};return requestOptions[pathKey]=resourceSpec[pathKey],resourceSpec.options=$.extend(!0,{},resourceSpec.options,requestOptions),resourceSpec},fluid.fetchResources.initOneResource=function(resourceSpec){resourceSpec.promise=fluid.promise(),resourceSpec.launched=!1},fluid.fetchResources.subscribeOneResource=function(resourceSpec,key,ownerComponentId){resourceSpec.transformEvent&&fluid.fail("Cannot subscribe resource ",resourceSpec," which has already been subscribed for I/O"),resourceSpec.key=key,resourceSpec.transformEvent=fluid.makeEventFirer({name:'Transform chain for resource "'+key+'"',ownerId:ownerComponentId}),resourceSpec.transformEvent.addListener(fluid.fetchResources.noteParsed,"noteParsed","last");var parser=fluid.resourceLoader.resolveResourceParser(resourceSpec);resourceSpec.transformEvent.addListener(parser,"parser","before:noteParsed"),resourceSpec.transformEvent.addListener((function(parsed){return fluid.resourceLoader.renderImmutable(parsed,resourceSpec)}),"renderImmutable","after:parser"),resourceSpec.transformEvent.addListener(fluid.fetchResources.noteResourceText,"resourceText","before:parser"),resourceSpec.transformEvent.addListener(fluid.fetchResources.resolveLoaderTask(resourceSpec,resourceSpec.loader.loader),"loader","before:resourceText"),resourceSpec.onFetched=fluid.makeEventFirer({name:'onFetched event for resources "'+key+'"',ownerId:ownerComponentId}),resourceSpec.onError=fluid.makeEventFirer({name:'onError event for resources "'+key+'"',ownerId:ownerComponentId}),resourceSpec.transformEvent.addListener(fluid.fetchResources.fireFetched,"fireFetched","last"),fluid.fetchResources.prepareRequestOptions(resourceSpec),fluid.fetchResources.initOneResource(resourceSpec)},fluid.fetchResources.FetchOne=function(resourceSpec,resourceFetcher,segs){var FetchOne=this;FetchOne.resourceFetcher=resourceFetcher,FetchOne.resourceSpec=resourceSpec,FetchOne.segs=segs||[];var thisPromise=FetchOne.promise=fluid.promise();fluid.fetchResources.fetchOneResource(resourceSpec,resourceFetcher).then((function(){thisPromise.resolve(fluid.fetchResources.resolveFetchOne(FetchOne))}))},fluid.fetchResources.resolveFetchOne=function(FetchOne){return fluid.getImmediate(FetchOne.resourceSpec,FetchOne.segs)},fluid.fetchResources.FetchOne.prototype.resolvePathSegment=function(seg){return new fluid.fetchResources.FetchOne(this.resourceSpec,this.resourceFetcher,this.segs.concat(fluid.makeArray(seg)))},fluid.initResourceFetcher=function(resourceFetcher){resourceFetcher.completionPromise=fluid.promise(),fluid.fetchResources.explodeForLocales(resourceFetcher),resourceFetcher.onInit.fire(resourceFetcher.completionPromise)},fluid.resourceFetcher=function(){},fluid.makeResourceFetcher=function(sourceResourceSpecs,callback,options,transformResourceURL){options=options||{};var that=Object.create(fluid.resourceFetcher.prototype);return fluid.extend(that,{sourceResourceSpecs:sourceResourceSpecs,options:fluid.copy(options),optionsReady:fluid.promise(),onInit:fluid.makeEventFirer({name:"onInit for resourceFetcher",ownerId:options.ownerComponentId}),transformResourceURL:transformResourceURL}),that.fetchAll=function(){return fluid.fetchResources.fetchAll(that)},that.refetchAll=function(){return fluid.fetchResources.refetchAll(that)},that.fetchOneResource=function(key){return fluid.fetchResources.fetchOneResource(that.resourceSpecs[key],that)},that.refetchOneResource=function(key){return fluid.fetchResources.refetchOneResource(that.resourceSpecs[key],that)},that.resourceSpecs=fluid.copy(that.sourceResourceSpecs),that.onInit.addListener((function(completionPromise){completionPromise.then(callback,callback)})),fluid.each(options.onInitListeners,(function(args){that.onInit.addListener.apply(null,args)})),fluid.each(that.resourceSpecs,(function(resourceSpec){resourceSpec.dataType=resourceSpec.dataType||that.options.dataType,resourceSpec.loader=fluid.resourceLoader.resolveResourceLoader(resourceSpec)})),fluid.initResourceFetcher(that),fluid.each(that.resourceSpecs,(function(resourceSpec,key){fluid.fetchResources.subscribeOneResource(resourceSpec,key,that.options.ownerComponentId)})),that},fluid.fetchResources.fetchAll=function(resourceFetcher){return fluid.each(resourceFetcher.resourceSpecs,(function(resourceSpec){fluid.fetchResources.fetchOneResource(resourceSpec,resourceFetcher)})),fluid.fetchResources.checkCompletion(resourceFetcher.resourceSpecs,resourceFetcher),resourceFetcher.completionPromise},fluid.fetchResources.mutableResourceSpecFields=["promise","resourceText","parsed","locale","defaultLocale"],fluid.fetchResources.refetchOneResource=function(resourceSpec,resourceFetcher,defeatInitiate){return resourceSpec.promise.cancel(),fluid.fetchResources.mutableResourceSpecFields.forEach((function(field){delete resourceSpec[field]})),fluid.fetchResources.initOneResource(resourceSpec),defeatInitiate||fluid.fetchResources.initiateRefetch(resourceFetcher),resourceSpec.promise},fluid.fetchResources.initiateRefetch=function(resourceFetcher){resourceFetcher.completionPromise.cancel(),delete resourceFetcher.completionPromise,fluid.initResourceFetcher(resourceFetcher,!0),fluid.fetchResources.fetchAll(resourceFetcher),resourceFetcher.fetchAll()},fluid.fetchResources.refetchAll=function(resourceFetcher){var anyLaunched=!1;return fluid.each(resourceFetcher.resourceSpecs,(function(resourceSpec){resourceSpec.resolvedLocale&&(anyLaunched=!0,fluid.fetchResources.refetchOneResource(resourceSpec,resourceFetcher,!0))})),anyLaunched&&fluid.fetchResources.initiateRefetch(resourceFetcher),resourceFetcher.completionPromise},fluid.fetchResources.fireTransformEvent=function(resourceSpec,resourceFetcher){return fluid.promise.fireTransformEvent(resourceSpec.transformEvent,null,{resourceSpec:resourceSpec,resourceFetcher:resourceFetcher})},fluid.fetchResources.fetchOneResource=function(resourceSpec,resourceFetcher){return resourceSpec.launched||(resourceSpec.launched=!0,resourceFetcher.optionsReady.then((function(){var transformPromise=fluid.fetchResources.fireTransformEvent(resourceSpec,resourceFetcher);fluid.promise.follow(transformPromise,resourceSpec.promise),resourceSpec.promise.then((function(){fluid.fetchResources.checkCompletion(resourceFetcher.resourceSpecs,resourceFetcher)}),(function(error){resourceSpec.fetchError=error,resourceSpec.onError.fire(error),resourceFetcher.completionPromise.reject(error)}))}))),resourceSpec.promise},fluid.registerNamespace("fluid.resourceLoader.loaders"),fluid.resourceLoader.modelUpdated=function(resourceFetcher,modelOptions,early){resourceFetcher.options=$.extend(!0,{},resourceFetcher.options,modelOptions),early?(fluid.fetchResources.explodeForLocales(resourceFetcher),resourceFetcher.optionsReady.resolve()):resourceFetcher.refetchAll()},fluid.resourceLoader.sanitizeResourceSpec=function(resourceSpec){return fluid.transform(resourceSpec,(function(value){return fluid.isPrimitive(value)||fluid.isPlainObject(value)&&!fluid.isPromise(value)?value:fluid.NO_VALUE}))},fluid.ImmutableArray=function(){},fluid.ImmutableArray.prototype=[],fluid.ImmutableObject=function(){},fluid.copyImmutableResource=function(tocopy){var newContainer=fluid.isArrayable(tocopy)?new fluid.ImmutableArray:new fluid.ImmutableObject;return fluid.each(tocopy,(function(value,key){newContainer[key]=value})),newContainer},fluid.resourceLoader.renderImmutable=function(parsed,resourceSpec){return resourceSpec.immutableModelResource?fluid.copyImmutableResource(parsed):parsed},fluid.resourceLoader.resolveResourceLoader=function(resourceSpec){var loaders=[];return fluid.each(fluid.resourceLoader.loaders,(function(loader,key){fluid.isValue(resourceSpec[key])&&loaders.push({loader:loader,pathKey:key})})),0===loaders.length?loaders.push({loader:fluid.resourceLoader.loaders.noLoader}):loaders.length>1&&fluid.fail("Resource spec ",fluid.resourceLoader.sanitizeResourceSpec(resourceSpec)," is ambiguous because it has fields for multiple resource loaders filled out: at most one of the fields ",fluid.getMembers(loaders,"pathKey")," can be used"),loaders[0]},fluid.resourceLoader.loaders.resourceText=function(resourceSpec){return resourceSpec.resourceText},fluid.resourceLoader.loaders.resourceText.noPath=!0,fluid.resourceLoader.loaders.promiseFunc=function(resourceSpec){return fluid.event.resolveListener(resourceSpec.promiseFunc).apply(null,fluid.makeArray(resourceSpec.promiseArgs))},fluid.resourceLoader.loaders.promiseFunc.noPath=!0,fluid.resourceLoader.loaders.dataSource=function(resourceSpec){return fluid.getForComponent(resourceSpec.dataSource,"get"),resourceSpec.dataSource.get(resourceSpec.directModel,resourceSpec.options)},fluid.resourceLoader.loaders.dataSource.noPath=!0,fluid.resourceLoader.loaders.dataSource.parsed=!0,fluid.resourceLoader.loaders.noLoader=function(resourceSpec){return fluid.promise().resolve({noResource:!0,message:["No resource was configured for resource spec ",fluid.resourceLoader.sanitizeResourceSpec(resourceSpec),"; since it had none of the fields fields ",Object.keys(fluid.resourceLoader.loaders)+" filled out"]})},fluid.resourceLoader.loaders.noLoader.noPath=!0,fluid.resourceLoader.loaders.noLoader.parsed=!0,fluid.registerNamespace("fluid.resourceLoader.parsers"),fluid.resourceLoader.resolveResourceParser=function(resourceSpec){return!resourceSpec.loader.loader.parsed&&fluid.resourceLoader.parsers[resourceSpec.dataType]||fluid.identity},fluid.resourceLoader.parsers.json=function(resourceText){return fluid.dataSource.parseJSON(resourceText)},fluid.resourcesMergePolicy=function(target,source){return target=target||{},fluid.each(source,(function(oneResource,name){if(oneResource){fluid.isPrimitive(oneResource)&&(oneResource={url:oneResource});var oneR=target[name];for(var key in oneR||(oneR=target[name]={}),fluid.resourceLoader.loaders)if(key in oneResource)for(var key2 in fluid.resourceLoader.loaders)delete oneR[key2];$.extend(oneR,oneResource)}else target[name]=oneResource})),target},fluid.defaults("fluid.resourceLoader",{gradeNames:["fluid.modelComponent"],listeners:{"onCreate.loadResources":"{that}.resourceFetcher.fetchAll","onDestroy.destroyResourceEvents":"fluid.resourceLoader.destroyResourceEvents({that}.resourceFetcher)","{that}.resourceFetcher.onInit":{namespace:"resourceLoaderCompletion",funcName:"fluid.resourceLoader.subscribeCompletion",args:["{arguments}.0","{that}"]},"{that}.applier.earlyModelResolved":{funcName:"fluid.resourceLoader.modelUpdated",args:["{that}.resourceFetcher","{arguments}.0.resourceLoader",!0]}},modelListeners:{resourceLoader:{namespace:"resourceLoader",funcName:"fluid.resourceLoader.modelUpdated",excludeSource:"init",args:["{that}.resourceFetcher","{change}.value"]}},mergePolicy:{resources:fluid.resourcesMergePolicy},members:{resourceFetcher:{expander:{funcName:"fluid.resourceLoader.makeResourceFetcher",args:["{that}","{that}.options.resources","{that}.options.resourceOptions","{that}.transformResourceURL"]}}},resourceOptions:{terms:{}},resources:{},invokers:{transformResourceURL:{funcName:"fluid.stringTemplate",args:["{arguments}.0","{that}.options.resourceOptions.terms"]}},events:{onResourcesLoaded:null,onResourceError:null}}),fluid.resourceLoader.makeResourceFetcher=function(that,resourceSpecs,userResourceOptions,transformResourceURL){var resourceOptions=$.extend({ownerComponentId:that.id,ownerComponentPath:fluid.pathForComponent(that),onInitListeners:[[function(completionPromise){fluid.resourceLoader.subscribeCompletion(completionPromise,that)},"resourceLoaderCompletion"]]},userResourceOptions),fetcher=fluid.makeResourceFetcher(resourceSpecs,null,resourceOptions,transformResourceURL);return fluid.each(fetcher.resourceSpecs,(function(resourceSpec,key){resourceSpec.transformEvent.addListener((function(parsed){return that.resources[key]=resourceSpec,parsed}),"noteComponentResource","after:parsed"),resourceSpec.onError.addListener(that.events.onResourceError.fire)})),fetcher},fluid.resourceLoader.subscribeCompletion=function(completionPromise,resourceLoader){var fire=function(){resourceLoader.events.onResourcesLoaded.fire(resourceLoader.resourceFetcher.resourceSpecs)};completionPromise.then((function(){"constructed"===resourceLoader.lifecycleStatus||"treeConstructed"===resourceLoader.lifecycleStatus?fire():"destroyed"!==resourceLoader.lifecycleStatus&&resourceLoader.events.onCreate.addListener(fire,"fireOnResourcesLoaded")}),(function(error){fluid.log("Failure loading resources for component at path "+fluid.dumpComponentPath(resourceLoader)+": ",error)}))},fluid.resourceLoader.destroyResourceEvents=function(resourceFetcher){fluid.each(resourceFetcher.resourceSpecs,(function(resourceSpec){resourceSpec.transformEvent.destroy(),resourceSpec.onFetched.destroy()}))},fluid.resourceLoader.UrlClass=URL,fluid.resourceLoader.configureXHR=function(xhr,options){fluid.resourceLoader.loaders.XHR.copyProps.forEach((function(prop){fluid.isValue(options[prop])&&(xhr[prop]=options[prop])})),fluid.each(options.headers,(function(value,key){fluid.makeArray(value).forEach((function(oneValue){xhr.setRequestHeader(key,oneValue)}))}))},fluid.resourceLoader.loaders.XHR=function(resourceSpec){var togo=fluid.promise(),xhr=resourceSpec.xhr=new XMLHttpRequest;togo.then(null,null,(function(){xhr.abort()}));var sendError=function(){fluid.invokeLater((function(){togo.reject({isError:!0,status:xhr.status,textStatus:xhr.statusText})}))};xhr.addEventListener("load",(function(){fluid.dataSource.URL.isErrorStatus(xhr.status)?sendError():fluid.invokeLater((function(){var response=xhr.responseType&&"text"!==xhr.responseType?xhr.response:xhr.responseText;togo.resolve(response)}))})),xhr.addEventListener("error",sendError);var options=$.extend({async:!0},resourceSpec.options);return xhr.open(options.method||"GET",resourceSpec.url,options.async,options.username,options.password),fluid.resourceLoader.configureXHR(xhr,options),xhr.send(),togo},fluid.resourceLoader.loaders.XHR.copyProps=["contentType","responseType","timeout"],fluid.resourceLoader.loaders.url=fluid.resourceLoader.loaders.XHR,fluid.dataSource.URL.handleHttp=function(that,baseOptions,data){var promise=fluid.promise(),defaultOptions={method:"GET",async:!0};"set"===baseOptions.operation&&(defaultOptions.headers={"Content-Type":that.encoding.options.contentType},defaultOptions.method=baseOptions.writeMethod);var requestOptions=fluid.extend(!0,defaultOptions,baseOptions),whileMsg=" while executing HTTP "+requestOptions.method+" on url "+requestOptions.url;promise.accumulateRejectionReason=function(originError){return fluid.upgradeError(originError,whileMsg)};var xhr=promise.xhr=new XMLHttpRequest,sendError=function(){var relayed=fluid.dataSource.URL.relayError(xhr.status,xhr.statusText,whileMsg);requestOptions.notFoundIsEmpty&&404===relayed.statusCode?promise.resolve(void 0):promise.reject(relayed)};xhr.addEventListener("load",(function(){if(fluid.dataSource.URL.isErrorStatus(xhr.status))sendError();else{var response=xhr.responseType&&"text"!==xhr.responseType?xhr.response:xhr.responseText;promise.resolve(response)}})),xhr.addEventListener("error",sendError);var url=fluid.dataSource.URL.condenseUrl(requestOptions);return requestOptions.url=url,fluid.log("DataSource Issuing "+requestOptions.protocol.toUpperCase().slice(0,-1)+" request with options ",requestOptions),xhr.open(requestOptions.method||"GET",url.toString(),requestOptions.async),fluid.resourceLoader.configureXHR(xhr,requestOptions),xhr.send(data),promise},function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.accessibleAutocomplete=t():e.accessibleAutocomplete=t()}(window,(function(){return function(n){var r={};function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}return o.m=n,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(n,r,function(e){return t[e]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=37)}([function(e,t,n){var m=n(1),v=n(6),y=n(7),g=n(16),_=n(18),b="prototype",w=function(e,t,n){var r,o,i,u,a=e&w.F,s=e&w.G,l=e&w.S,c=e&w.P,p=e&w.B,f=s?m:l?m[t]||(m[t]={}):(m[t]||{})[b],d=s?v:v[t]||(v[t]={}),h=d[b]||(d[b]={});for(r in s&&(n=t),n)i=((o=!a&&f&&void 0!==f[r])?f:n)[r],u=p&&o?_(i,m):c&&"function"==typeof i?_(Function.call,i):i,f&&g(f,r,i,e&w.U),d[r]!=i&&y(d,r,u),c&&h[r]!=i&&(h[r]=i)};m.core=v,w.F=1,w.G=2,w.S=4,w.P=8,w.B=16,w.W=32,w.U=64,w.R=128,e.exports=w},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,n){e.exports=!n(4)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t){e.exports=function(e){try{return!!e()}catch(t){return!0}}},function(e,t,n){n.r(t),n.d(t,"h",(function(){return r})),n.d(t,"createElement",(function(){return r})),n.d(t,"cloneElement",(function(){return i})),n.d(t,"Component",(function(){return g})),n.d(t,"render",(function(){return _})),n.d(t,"rerender",(function(){return f})),n.d(t,"options",(function(){return E}));var s=function(){},E={},l=[],c=[];function r(e,t){var n,r,o,i,u=c;for(i=arguments.length;2<i--;)l.push(arguments[i]);for(t&&null!=t.children&&(l.length||l.push(t.children),delete t.children);l.length;)if((r=l.pop())&&void 0!==r.pop)for(i=r.length;i--;)l.push(r[i]);else"boolean"==typeof r&&(r=null),(o="function"!=typeof e)&&(null==r?r="":"number"==typeof r?r=String(r):"string"!=typeof r&&(o=!1)),o&&n?u[u.length-1]+=r:u===c?u=[r]:u.push(r),n=o;var a=new s;return a.nodeName=e,a.children=u,a.attributes=null==t?void 0:t,a.key=null==t?void 0:t.key,void 0!==E.vnode&&E.vnode(a),a}function M(e,t){for(var n in t)e[n]=t[n];return e}var o="function"==typeof Promise?Promise.resolve().then.bind(Promise.resolve()):setTimeout;function i(e,t){return r(e.nodeName,M(M({},e.attributes),t),2<arguments.length?[].slice.call(arguments,2):e.children)}var p=/acit|ex(?:s|g|n|p|$)|rph|ows|mnc|ntw|ine[ch]|zoo|^ord/i,u=[];function a(e){!e._dirty&&(e._dirty=!0)&&1==u.push(e)&&(E.debounceRendering||o)(f)}function f(){var e,t=u;for(u=[];e=t.pop();)e._dirty&&V(e)}function N(e,t){return e.normalizedNodeName===t||e.nodeName.toLowerCase()===t.toLowerCase()}function I(e){var t=M({},e.attributes);t.children=e.children;var n=e.nodeName.defaultProps;if(void 0!==n)for(var r in n)void 0===t[r]&&(t[r]=n[r]);return t}function k(e){var t=e.parentNode;t&&t.removeChild(e)}function v(e,t,n,r,o){if("className"===t&&(t="class"),"key"===t);else if("ref"===t)n&&n(null),r&&r(e);else if("class"!==t||o)if("style"===t){if(r&&"string"!=typeof r&&"string"!=typeof n||(e.style.cssText=r||""),r&&"object"==typeof r){if("string"!=typeof n)for(var i in n)i in r||(e.style[i]="");for(var i in r)e.style[i]="number"==typeof r[i]&&!1===p.test(i)?r[i]+"px":r[i]}}else if("dangerouslySetInnerHTML"===t)r&&(e.innerHTML=r.__html||"");else if("o"==t[0]&&"n"==t[1]){var u=t!==(t=t.replace(/Capture$/,""));t=t.toLowerCase().substring(2),r?n||e.addEventListener(t,d,u):e.removeEventListener(t,d,u),(e._listeners||(e._listeners={}))[t]=r}else if("list"!==t&&"type"!==t&&!o&&t in e){try{e[t]=null==r?"":r}catch(s){}null!=r&&!1!==r||"spellcheck"==t||e.removeAttribute(t)}else{var a=o&&t!==(t=t.replace(/^xlink:?/,""));null==r||!1===r?a?e.removeAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase()):e.removeAttribute(t):"function"!=typeof r&&(a?e.setAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase(),r):e.setAttribute(t,r))}else e.className=r||""}function d(e){return this._listeners[e.type](E.event&&E.event(e)||e)}var A=[],P=0,j=!1,L=!1;function T(){for(var e;e=A.pop();)E.afterMount&&E.afterMount(e),e.componentDidMount&&e.componentDidMount()}function D(e,t,n,r,o){var i=e,u=j;if(null!=t&&"boolean"!=typeof t||(t=""),"string"==typeof t||"number"==typeof t)return e&&void 0!==e.splitText&&e.parentNode&&(!e._component||o)?e.nodeValue!=t&&(e.nodeValue=t):(i=document.createTextNode(t),e&&(e.parentNode&&e.parentNode.replaceChild(i,e),F(e,!0))),i.__preactattr_=!0,i;var a=t.nodeName;if("function"==typeof a)return function(e,t,n,r){for(var o=e&&e._component,i=o,u=e,a=o&&e._componentConstructor===t.nodeName,s=a,l=I(t);o&&!s&&(o=o._parentComponent);)s=o.constructor===t.nodeName;return o&&s&&(!r||o._component)?(U(o,l,3,n,r),e=o.base):(i&&!a&&(q(i),e=u=null),o=R(t.nodeName,l,n),e&&!o.nextBase&&(o.nextBase=e,u=null),U(o,l,1,n,r),e=o.base,u&&e!==u&&(u._component=null,F(u,!1))),e}(e,t,n,r);if(j="svg"===a||"foreignObject"!==a&&j,a=String(a),(!e||!N(e,a))&&(i=function(e,t){var n=t?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);return n.normalizedNodeName=e,n}(a,j),e)){for(;e.firstChild;)i.appendChild(e.firstChild);e.parentNode&&e.parentNode.replaceChild(i,e),F(e,!0)}var s=i.firstChild,l=i.__preactattr_,c=t.children;if(null==l){l=i.__preactattr_={};for(var p=i.attributes,f=p.length;f--;)l[p[f].name]=p[f].value}return!L&&c&&1===c.length&&"string"==typeof c[0]&&null!=s&&void 0!==s.splitText&&null==s.nextSibling?s.nodeValue!=c[0]&&(s.nodeValue=c[0]):(c&&c.length||null!=s)&&function(e,t,n,r,o){var i,u,a,s,l,x,O,C,c=e.childNodes,p=[],f={},d=0,h=0,m=c.length,v=0,y=t?t.length:0;if(0!==m)for(var g=0;g<m;g++){var _=c[g],b=_.__preactattr_;null!=(w=y&&b?_._component?_._component.__key:b.key:null)?(d++,f[w]=_):(b||(void 0!==_.splitText?!o||_.nodeValue.trim():o))&&(p[v++]=_)}if(0!==y)for(g=0;g<y;g++){var w;if(l=null,null!=(w=(s=t[g]).key))d&&void 0!==f[w]&&(l=f[w],f[w]=void 0,d--);else if(h<v)for(i=h;i<v;i++)if(void 0!==p[i]&&(x=u=p[i],C=o,"string"==typeof(O=s)||"number"==typeof O?void 0!==x.splitText:"string"==typeof O.nodeName?!x._componentConstructor&&N(x,O.nodeName):C||x._componentConstructor===O.nodeName)){l=u,p[i]=void 0,i===v-1&&v--,i===h&&h++;break}l=D(l,s,n,r),a=c[g],l&&l!==e&&l!==a&&(null==a?e.appendChild(l):l===a.nextSibling?k(a):e.insertBefore(l,a))}if(d)for(var g in f)void 0!==f[g]&&F(f[g],!1);for(;h<=v;)void 0!==(l=p[v--])&&F(l,!1)}(i,c,n,r,L||null!=l.dangerouslySetInnerHTML),function(e,t,n){var r;for(r in n)t&&null!=t[r]||null==n[r]||v(e,r,n[r],n[r]=void 0,j);for(r in t)"children"===r||"innerHTML"===r||r in n&&t[r]===("value"===r||"checked"===r?e[r]:n[r])||v(e,r,n[r],n[r]=t[r],j)}(i,t.attributes,l),j=u,i}function F(e,t){var n=e._component;n?q(n):(null!=e.__preactattr_&&e.__preactattr_.ref&&e.__preactattr_.ref(null),!1!==t&&null!=e.__preactattr_||k(e),h(e))}function h(e){for(e=e.lastChild;e;){var t=e.previousSibling;F(e,!0),e=t}}var m=[];function R(e,t,n){var r,o=m.length;for(e.prototype&&e.prototype.render?(r=new e(t,n),g.call(r,t,n)):((r=new g(t,n)).constructor=e,r.render=y);o--;)if(m[o].constructor===e)return r.nextBase=m[o].nextBase,m.splice(o,1),r;return r}function y(e,t,n){return this.constructor(e,n)}function U(e,t,n,r,o){e._disable||(e._disable=!0,e.__ref=t.ref,e.__key=t.key,delete t.ref,delete t.key,void 0===e.constructor.getDerivedStateFromProps&&(!e.base||o?e.componentWillMount&&e.componentWillMount():e.componentWillReceiveProps&&e.componentWillReceiveProps(t,r)),r&&r!==e.context&&(e.prevContext||(e.prevContext=e.context),e.context=r),e.prevProps||(e.prevProps=e.props),e.props=t,e._disable=!1,0!==n&&(1!==n&&!1===E.syncComponentUpdates&&e.base?a(e):V(e,1,o)),e.__ref&&e.__ref(e))}function V(e,t,n,r){if(!e._disable){var o,i,u,a=e.props,s=e.state,l=e.context,c=e.prevProps||a,p=e.prevState||s,f=e.prevContext||l,d=e.base,h=e.nextBase,m=d||h,v=e._component,y=!1,g=f;if(e.constructor.getDerivedStateFromProps&&(s=M(M({},s),e.constructor.getDerivedStateFromProps(a,s)),e.state=s),d&&(e.props=c,e.state=p,e.context=f,2!==t&&e.shouldComponentUpdate&&!1===e.shouldComponentUpdate(a,s,l)?y=!0:e.componentWillUpdate&&e.componentWillUpdate(a,s,l),e.props=a,e.state=s,e.context=l),e.prevProps=e.prevState=e.prevContext=e.nextBase=null,e._dirty=!1,!y){o=e.render(a,s,l),e.getChildContext&&(l=M(M({},l),e.getChildContext())),d&&e.getSnapshotBeforeUpdate&&(g=e.getSnapshotBeforeUpdate(c,p));var _,b,w=o&&o.nodeName;if("function"==typeof w){var x=I(o);(i=v)&&i.constructor===w&&x.key==i.__key?U(i,x,1,l,!1):(_=i,e._component=i=R(w,x,l),i.nextBase=i.nextBase||h,i._parentComponent=e,U(i,x,0,l,!1),V(i,1,n,!0)),b=i.base}else u=m,(_=v)&&(u=e._component=null),(m||1===t)&&(u&&(u._component=null),b=function(t,n,r,o,i,u){P++||(j=null!=i&&void 0!==i.ownerSVGElement,L=null!=t&&!("__preactattr_"in t));var a=D(t,n,r,o,u);return i&&a.parentNode!==i&&i.appendChild(a),--P||(L=!1,u||T()),a}(u,o,l,n||!d,m&&m.parentNode,!0));if(m&&b!==m&&i!==v){var O=m.parentNode;O&&b!==O&&(O.replaceChild(b,m),_||(m._component=null,F(m,!1)))}if(_&&q(_),(e.base=b)&&!r){for(var C=e,S=e;S=S._parentComponent;)(C=S).base=b;b._component=C,b._componentConstructor=C.constructor}}for(!d||n?A.unshift(e):y||(e.componentDidUpdate&&e.componentDidUpdate(c,p,g),E.afterUpdate&&E.afterUpdate(e));e._renderCallbacks.length;)e._renderCallbacks.pop().call(e);P||r||T()}}function q(e){E.beforeUnmount&&E.beforeUnmount(e);var t=e.base;e._disable=!0,e.componentWillUnmount&&e.componentWillUnmount(),e.base=null;var n=e._component;n?q(n):t&&(t.__preactattr_&&t.__preactattr_.ref&&t.__preactattr_.ref(null),k(e.nextBase=t),m.push(e),h(t)),e.__ref&&e.__ref(null)}function g(e,t){this._dirty=!0,this.context=t,this.props=e,this.state=this.state||{},this._renderCallbacks=[]}function _(e,t,n){return function(e,t,n,r,o,i){P++||(j=null!=o&&void 0!==o.ownerSVGElement,L=null!=e&&!("__preactattr_"in e));var u=D(e,t,n,r,i);return o&&u.parentNode!==o&&o.appendChild(u),--P||(L=!1,i||T()),u}(n,e,{},!1,t,!1)}M(g.prototype,{setState:function(e,t){this.prevState||(this.prevState=this.state),this.state=M(M({},this.state),"function"==typeof e?e(this.state,this.props):e),t&&this._renderCallbacks.push(t),a(this)},forceUpdate:function(e){e&&this._renderCallbacks.push(e),V(this,2)},render:function(){}});var b={h:r,createElement:r,cloneElement:i,Component:g,render:_,rerender:f,options:E};t.default=b},function(e,t){var n=e.exports={version:"2.5.7"};"number"==typeof __e&&(__e=n)},function(e,t,n){var r=n(8),o=n(40);e.exports=n(3)?function(e,t,n){return r.f(e,t,o(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var o=n(9),i=n(38),u=n(39),a=Object.defineProperty;t.f=n(3)?Object.defineProperty:function(e,t,n){if(o(e),t=u(t,!0),o(n),i)try{return a(e,t,n)}catch(r){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t,n){var r=n(2);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t){var n=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+r).toString(36))}},function(e,t,n){var r=n(22);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){var r=n(4);e.exports=function(e,t){return!!e&&r((function(){t?e.call(null,(function(){}),1):e.call(null)}))}},function(e,t,n){var r=n(0);r(r.S+r.F,"Object",{assign:n(41)})},function(e,t,n){var r=n(2),o=n(1).document,i=r(o)&&r(o.createElement);e.exports=function(e){return i?o.createElement(e):{}}},function(e,t,n){var i=n(1),u=n(7),a=n(17),s=n(10)("src"),r="toString",o=Function[r],l=(""+o).split(r);n(6).inspectSource=function(e){return o.call(e)},(e.exports=function(e,t,n,r){var o="function"==typeof n;o&&(a(n,"name")||u(n,"name",t)),e[t]!==n&&(o&&(a(n,s)||u(n,s,e[t]?""+e[t]:l.join(String(t)))),e===i?e[t]=n:r?e[t]?e[t]=n:u(e,t,n):(delete e[t],u(e,t,n)))})(Function.prototype,r,(function(){return"function"==typeof this&&this[s]||o.call(this)}))},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){var i=n(19);e.exports=function(r,o,e){if(i(r),void 0===o)return r;switch(e){case 1:return function(e){return r.call(o,e)};case 2:return function(e,t){return r.call(o,e,t)};case 3:return function(e,t,n){return r.call(o,e,t,n)}}return function(){return r.apply(o,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){var r=n(42),o=n(28);e.exports=Object.keys||function(e){return r(e,o)}},function(e,t,n){var r=n(11),o=n(12);e.exports=function(e){return r(o(e))}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t,n){var s=n(21),l=n(24),c=n(43);e.exports=function(a){return function(e,t,n){var r,o=s(e),i=l(o.length),u=c(n,i);if(a&&t!=t){for(;u<i;)if((r=o[u++])!=r)return!0}else for(;u<i;u++)if((a||u in o)&&o[u]===t)return a||u||0;return!a&&-1}}},function(e,t,n){var r=n(25),o=Math.min;e.exports=function(e){return 0<e?o(r(e),9007199254740991):0}},function(e,t){var n=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(0<e?r:n)(e)}},function(e,t,n){var r=n(27)("keys"),o=n(10);e.exports=function(e){return r[e]||(r[e]=o(e))}},function(e,t,n){var r=n(6),o=n(1),i="__core-js_shared__",u=o[i]||(o[i]={});(e.exports=function(e,t){return u[e]||(u[e]=void 0!==t?t:{})})("versions",[]).push({version:r.version,mode:n(44)?"pure":"global",copyright:" 2018 Denis Pushkarev (zloirock.ru)"})},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,n){var r=n(12);e.exports=function(e){return Object(r(e))}},function(e,t,n){var r=n(8).f,o=Function.prototype,i=/^\s*function ([^ (]*)/;"name"in o||n(3)&&r(o,"name",{configurable:!0,get:function(){try{return(""+this).match(i)[1]}catch(e){return""}}})},function(e,t,n){var r=n(0),o=n(32)(1);r(r.P+r.F*!n(13)([].map,!0),"Array",{map:function(e){return o(this,e,arguments[1])}})},function(e,t,n){var _=n(18),b=n(11),w=n(29),x=n(24),r=n(47);e.exports=function(p,e){var f=1==p,d=2==p,h=3==p,m=4==p,v=6==p,y=5==p||v,g=e||r;return function(e,t,n){for(var r,o,i=w(e),u=b(i),a=_(t,n,3),s=x(u.length),l=0,c=f?g(e,s):d?g(e,0):void 0;l<s;l++)if((y||l in u)&&(o=a(r=u[l],l,i),p))if(f)c[l]=o;else if(o)switch(p){case 3:return!0;case 5:return r;case 6:return l;case 2:c.push(r)}else if(m)return!1;return v?-1:h||m?m:c}}},function(e,t,n){var r=n(22);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,n){var r=n(27)("wks"),o=n(10),i=n(1).Symbol,u="function"==typeof i;(e.exports=function(e){return r[e]||(r[e]=u&&i[e]||(u?i:o)("Symbol."+e))}).store=r},function(e,t,n){var r=n(0),o=n(23)(!1),i=[].indexOf,u=!!i&&1/[1].indexOf(1,-0)<0;r(r.P+r.F*(u||!n(13)(i)),"Array",{indexOf:function(e){return u?i.apply(this,arguments)||0:o(this,e,arguments[1])}})},function(e,t,n){var r=n(0);r(r.S,"Object",{create:n(52)})},function(e,t,n){t.__esModule=!0,t.default=void 0,n(14),n(30),n(31),n(35),n(49),n(50);var r=n(5),o=function(e){return e&&e.__esModule?e:{default:e}}(n(51));function i(e){if(!e.element)throw new Error("element is not defined");if(!e.id)throw new Error("id is not defined");if(!e.source)throw new Error("source is not defined");Array.isArray(e.source)&&(e.source=u(e.source)),(0,r.render)((0,r.createElement)(o.default,e),e.element)}var u=function(n){return function(t,e){e(n.filter((function(e){return-1!==e.toLowerCase().indexOf(t.toLowerCase())})))}};i.enhanceSelectElement=function(n){if(!n.selectElement)throw new Error("selectElement is not defined");if(!n.source){var e=[].filter.call(n.selectElement.options,(function(e){return e.value||n.preserveNullOptions}));n.source=e.map((function(e){return e.textContent||e.innerText}))}if(n.onConfirm=n.onConfirm||function(t){var e=[].filter.call(n.selectElement.options,(function(e){return(e.textContent||e.innerText)===t}))[0];e&&(e.selected=!0)},n.selectElement.value||void 0===n.defaultValue){var t=n.selectElement.options[n.selectElement.options.selectedIndex];n.defaultValue=t.textContent||t.innerText}void 0===n.name&&(n.name=""),void 0===n.id&&(void 0===n.selectElement.id?n.id="":n.id=n.selectElement.id),void 0===n.autoselect&&(n.autoselect=!0);var r=document.createElement("div");n.selectElement.parentNode.insertBefore(r,n.selectElement),i(Object.assign({},n,{element:r})),n.selectElement.style.display="none",n.selectElement.id=n.selectElement.id+"-select"};var a=i;t.default=a},function(e,t,n){e.exports=!n(3)&&!n(4)((function(){return 7!=Object.defineProperty(n(15)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,n){var o=n(2);e.exports=function(e,t){if(!o(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!o(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!o(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!o(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){var f=n(20),d=n(45),h=n(46),m=n(29),v=n(11),o=Object.assign;e.exports=!o||n(4)((function(){var e={},t={},n=Symbol(),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach((function(e){t[e]=e})),7!=o({},e)[n]||Object.keys(o({},t)).join("")!=r}))?function(e,t){for(var n=m(e),r=arguments.length,o=1,i=d.f,u=h.f;o<r;)for(var a,s=v(arguments[o++]),l=i?f(s).concat(i(s)):f(s),c=l.length,p=0;p<c;)u.call(s,a=l[p++])&&(n[a]=s[a]);return n}:o},function(e,t,n){var u=n(17),a=n(21),s=n(23)(!1),l=n(26)("IE_PROTO");e.exports=function(e,t){var n,r=a(e),o=0,i=[];for(n in r)n!=l&&u(r,n)&&i.push(n);for(;t.length>o;)u(r,n=t[o++])&&(~s(i,n)||i.push(n));return i}},function(e,t,n){var r=n(25),o=Math.max,i=Math.min;e.exports=function(e,t){return(e=r(e))<0?o(e+t,0):i(e,t)}},function(e,t){e.exports=!1},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,n){var r=n(48);e.exports=function(e,t){return new(r(e))(t)}},function(e,t,n){var r=n(2),o=n(33),i=n(34)("species");e.exports=function(e){var t;return o(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!o(t.prototype)||(t=void 0),r(t)&&null===(t=t[i])&&(t=void 0)),void 0===t?Array:t}},function(e,t,n){var r=n(0),o=n(32)(2);r(r.P+r.F*!n(13)([].filter,!0),"Array",{filter:function(e){return o(this,e,arguments[1])}})},function(e,t,n){var r=n(0);r(r.S,"Array",{isArray:n(33)})},function(e,t,n){t.__esModule=!0,t.default=void 0,n(14),n(36),n(30),n(31),n(35),n(55),n(58);var $=n(5),J=o(n(60)),r=o(n(61));function o(e){return e&&e.__esModule?e:{default:e}}function X(){return(X=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function i(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var u={13:"enter",27:"escape",32:"space",38:"up",40:"down"};function Y(){return"undefined"!=typeof navigator&&!(!navigator.userAgent.match(/(iPod|iPhone|iPad)/g)||!navigator.userAgent.match(/AppleWebKit/g))}var a=function(n){function e(e){var t;return(t=n.call(this,e)||this).elementReferences={},t.state={focused:null,hovered:null,menuOpen:!1,options:e.defaultValue?[e.defaultValue]:[],query:e.defaultValue,validChoiceMade:!1,selected:null,ariaHint:!0},t.handleComponentBlur=t.handleComponentBlur.bind(i(i(t))),t.handleKeyDown=t.handleKeyDown.bind(i(i(t))),t.handleUpArrow=t.handleUpArrow.bind(i(i(t))),t.handleDownArrow=t.handleDownArrow.bind(i(i(t))),t.handleEnter=t.handleEnter.bind(i(i(t))),t.handlePrintableKey=t.handlePrintableKey.bind(i(i(t))),t.handleListMouseLeave=t.handleListMouseLeave.bind(i(i(t))),t.handleOptionBlur=t.handleOptionBlur.bind(i(i(t))),t.handleOptionClick=t.handleOptionClick.bind(i(i(t))),t.handleOptionFocus=t.handleOptionFocus.bind(i(i(t))),t.handleOptionMouseDown=t.handleOptionMouseDown.bind(i(i(t))),t.handleOptionMouseEnter=t.handleOptionMouseEnter.bind(i(i(t))),t.handleInputBlur=t.handleInputBlur.bind(i(i(t))),t.handleInputChange=t.handleInputChange.bind(i(i(t))),t.handleInputFocus=t.handleInputFocus.bind(i(i(t))),t.pollInputElement=t.pollInputElement.bind(i(i(t))),t.getDirectInputChanges=t.getDirectInputChanges.bind(i(i(t))),t}!function(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t}(e,n);var t=e.prototype;return t.isQueryAnOption=function(e,t){var n=this;return-1!==t.map((function(e){return n.templateInputValue(e).toLowerCase()})).indexOf(e.toLowerCase())},t.componentDidMount=function(){this.pollInputElement()},t.componentWillUnmount=function(){clearTimeout(this.$pollInput)},t.pollInputElement=function(){var e=this;this.getDirectInputChanges(),this.$pollInput=setTimeout((function(){e.pollInputElement()}),100)},t.getDirectInputChanges=function(){var e=this.elementReferences[-1];e&&e.value!==this.state.query&&this.handleInputChange({target:{value:e.value}})},t.componentDidUpdate=function(e,t){var n=this.state.focused,r=null===n,o=t.focused!==n;o&&!r&&this.elementReferences[n].focus();var i=-1===n,u=o&&null===t.focused;if(i&&u){var a=this.elementReferences[n];a.setSelectionRange(0,a.value.length)}},t.hasAutoselect=function(){return!Y()&&this.props.autoselect},t.templateInputValue=function(e){var t=this.props.templates&&this.props.templates.inputValue;return t?t(e):e},t.templateSuggestion=function(e){var t=this.props.templates&&this.props.templates.suggestion;return t?t(e):e},t.handleComponentBlur=function(e){var t,n=this.state,r=n.options,o=n.query,i=n.selected;this.props.confirmOnBlur?(t=e.query||o,this.props.onConfirm(r[i])):t=o,this.setState({focused:null,menuOpen:e.menuOpen||!1,query:t,selected:null,validChoiceMade:this.isQueryAnOption(t,r)})},t.handleListMouseLeave=function(e){this.setState({hovered:null})},t.handleOptionBlur=function(e,t){var n=this.state,r=n.focused,o=n.menuOpen,i=n.options,u=n.selected,a=null===e.relatedTarget,s=e.relatedTarget===this.elementReferences[-1],l=r!==t&&-1!==r;if(!l&&a||!l&&!s){var c=o&&Y();this.handleComponentBlur({menuOpen:c,query:this.templateInputValue(i[u])})}},t.handleInputBlur=function(e){var t=this.state,n=t.focused,r=t.menuOpen,o=t.options,i=t.query,u=t.selected;if(-1===n){var a=r&&Y(),s=Y()?i:this.templateInputValue(o[u]);this.handleComponentBlur({menuOpen:a,query:s})}},t.handleInputChange=function(e){var n=this,t=this.props,r=t.minLength,o=t.source,i=t.showAllValues,u=this.hasAutoselect(),a=e.target.value,s=0===a.length,l=this.state.query.length!==a.length,c=a.length>=r;this.setState({query:a,ariaHint:s}),i||!s&&l&&c?o(a,(function(e){var t=0<e.length;n.setState({menuOpen:t,options:e,selected:u&&t?0:-1,validChoiceMade:!1})})):!s&&c||this.setState({menuOpen:!1,options:[]})},t.handleInputClick=function(e){this.handleInputChange(e)},t.handleInputFocus=function(e){var t=this.state,n=t.query,r=t.validChoiceMade,o=t.options,i=this.props.minLength,u=!r&&n.length>=i&&0<o.length;u?this.setState((function(e){var t=e.menuOpen;return{focused:-1,menuOpen:u||t,selected:-1}})):this.setState({focused:-1})},t.handleOptionFocus=function(e){this.setState({focused:e,hovered:null,selected:e})},t.handleOptionMouseEnter=function(e,t){Y()||this.setState({hovered:t})},t.handleOptionClick=function(e,t){var n=this.state.options[t],r=this.templateInputValue(n);this.props.onConfirm(n),this.setState({focused:-1,hovered:null,menuOpen:!1,query:r,selected:-1,validChoiceMade:!0}),this.forceUpdate()},t.handleOptionMouseDown=function(e){e.preventDefault()},t.handleUpArrow=function(e){e.preventDefault();var t=this.state,n=t.menuOpen,r=t.selected;-1!==r&&n&&this.handleOptionFocus(r-1)},t.handleDownArrow=function(e){var t=this;if(e.preventDefault(),this.props.showAllValues&&!1===this.state.menuOpen)e.preventDefault(),this.props.source("",(function(e){t.setState({menuOpen:!0,options:e,selected:0,focused:0,hovered:null})}));else if(!0===this.state.menuOpen){var n=this.state,r=n.menuOpen,o=n.options,i=n.selected;i!==o.length-1&&r&&this.handleOptionFocus(i+1)}},t.handleSpace=function(e){var t=this;this.props.showAllValues&&!1===this.state.menuOpen&&""===this.state.query&&(e.preventDefault(),this.props.source("",(function(e){t.setState({menuOpen:!0,options:e})}))),-1!==this.state.focused&&(e.preventDefault(),this.handleOptionClick(e,this.state.focused))},t.handleEnter=function(e){this.state.menuOpen&&(e.preventDefault(),0<=this.state.selected&&this.handleOptionClick(e,this.state.selected))},t.handlePrintableKey=function(e){var t=this.elementReferences[-1];e.target===t||t.focus()},t.handleKeyDown=function(e){switch(u[e.keyCode]){case"up":this.handleUpArrow(e);break;case"down":this.handleDownArrow(e);break;case"space":this.handleSpace(e);break;case"enter":this.handleEnter(e);break;case"escape":this.handleComponentBlur({query:this.state.query});break;default:(function(e){return 47<e&&e<58||32===e||8===e||64<e&&e<91||95<e&&e<112||185<e&&e<193||218<e&&e<223})(e.keyCode)&&this.handlePrintableKey(e)}},t.render=function(){var e,i=this,t=this.props,n=t.cssNamespace,r=t.displayMenu,u=t.id,o=t.minLength,a=t.name,s=t.placeholder,l=t.required,c=t.showAllValues,p=t.tNoResults,f=t.tStatusQueryTooShort,d=t.tStatusNoResults,h=t.tStatusSelectedOption,m=t.tStatusResults,v=t.tAssistiveHint,y=t.dropdownArrow,g=this.state,_=g.focused,b=g.hovered,w=g.menuOpen,x=g.options,O=g.query,C=g.selected,S=g.ariaHint,E=g.validChoiceMade,M=this.hasAutoselect(),N=-1===_,I=0===x.length,k=0!==O.length,A=O.length>=o,P=this.props.showNoOptionsFound&&N&&I&&k&&A,j=n+"__wrapper",L=n+"__input",T=null!==_?" "+L+"--focused":"",B=this.props.showAllValues?" "+L+"--show-all-values":" "+L+"--default",D=n+"__dropdown-arrow-down",F=-1!==_&&null!==_,R=n+"__menu",U=R+"--"+r,V=R+"--"+(w||P?"visible":"hidden"),q=n+"__option",W=n+"__hint",H=this.templateInputValue(x[C]),K=H&&0===H.toLowerCase().indexOf(O.toLowerCase())&&M?O+H.substr(O.length):"",Q=u+"__assistiveHint",z=S?{"aria-describedby":Q}:null;return c&&"string"==typeof(e=y({className:D}))&&(e=(0,$.createElement)("div",{className:n+"__dropdown-arrow-down-wrapper",dangerouslySetInnerHTML:{__html:e}})),(0,$.createElement)("div",{className:j,onKeyDown:this.handleKeyDown},(0,$.createElement)(J.default,{id:u,length:x.length,queryLength:O.length,minQueryLength:o,selectedOption:this.templateInputValue(x[C]),selectedOptionIndex:C,validChoiceMade:E,isInFocus:null!==this.state.focused,tQueryTooShort:f,tNoResults:d,tSelectedOption:h,tResults:m}),K&&(0,$.createElement)("span",null,(0,$.createElement)("input",{className:W,readonly:!0,tabIndex:"-1",value:K})),(0,$.createElement)("input",X({"aria-expanded":w?"true":"false","aria-activedescendant":!!F&&u+"__option--"+_,"aria-owns":u+"__listbox","aria-autocomplete":this.hasAutoselect()?"both":"list"},z,{autoComplete:"off",className:""+L+T+B,id:u,onClick:function(e){return i.handleInputClick(e)},onBlur:this.handleInputBlur},function(e){return{onInput:e}}(this.handleInputChange),{onFocus:this.handleInputFocus,name:a,placeholder:s,ref:function(e){i.elementReferences[-1]=e},type:"text",role:"combobox",required:l,value:O})),e,(0,$.createElement)("ul",{className:R+" "+U+" "+V,onMouseLeave:function(e){return i.handleListMouseLeave(e)},id:u+"__listbox",role:"listbox"},x.map((function(e,t){var n=(-1===_?C===t:_===t)&&null===b?" "+q+"--focused":"",r=t%2?" "+q+"--odd":"",o=Y()?"<span id="+u+"__option-suffix--"+t+' style="border:0;clip:rect(0 0 0 0);height:1px;marginBottom:-1px;marginRight:-1px;overflow:hidden;padding:0;position:absolute;whiteSpace:nowrap;width:1px"> '+(t+1)+" of "+x.length+"</span>":"";return(0,$.createElement)("li",{"aria-selected":_===t?"true":"false",className:""+q+n+r,dangerouslySetInnerHTML:{__html:i.templateSuggestion(e)+o},id:u+"__option--"+t,key:t,onBlur:function(e){return i.handleOptionBlur(e,t)},onClick:function(e){return i.handleOptionClick(e,t)},onMouseDown:i.handleOptionMouseDown,onMouseEnter:function(e){return i.handleOptionMouseEnter(e,t)},ref:function(e){i.elementReferences[t]=e},role:"option",tabIndex:"-1","aria-posinset":t+1,"aria-setsize":x.length})})),P&&(0,$.createElement)("li",{className:q+" "+q+"--no-results"},p())),(0,$.createElement)("span",{id:Q,style:{display:"none"}},v()))},e}($.Component);(t.default=a).defaultProps={autoselect:!1,cssNamespace:"autocomplete",defaultValue:"",displayMenu:"inline",minLength:0,name:"input-autocomplete",placeholder:"",onConfirm:function(){},confirmOnBlur:!0,showNoOptionsFound:!0,showAllValues:!1,required:!1,tNoResults:function(){return"No results found"},tAssistiveHint:function(){return"When autocomplete results are available use up and down arrows to review and enter to select.  Touch device users, explore by touch or with swipe gestures."},dropdownArrow:r.default}},function(e,t,r){var o=r(9),i=r(53),u=r(28),a=r(26)("IE_PROTO"),s=function(){},l="prototype",c=function(){var e,t=r(15)("iframe"),n=u.length;for(t.style.display="none",r(54).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),c=e.F;n--;)delete c[l][u[n]];return c()};e.exports=Object.create||function(e,t){var n;return null!==e?(s[l]=o(e),n=new s,s[l]=null,n[a]=e):n=c(),void 0===t?n:i(n,t)}},function(e,t,n){var u=n(8),a=n(9),s=n(20);e.exports=n(3)?Object.defineProperties:function(e,t){a(e);for(var n,r=s(t),o=r.length,i=0;i<o;)u.f(e,n=r[i++],t[n]);return e}},function(e,t,n){var r=n(1).document;e.exports=r&&r.documentElement},function(e,t,n){var r=n(0);r(r.P,"Function",{bind:n(56)})},function(e,t,n){var i=n(19),u=n(2),a=n(57),s=[].slice,l={};e.exports=Function.bind||function(t){var n=i(this),r=s.call(arguments,1),o=function(){var e=r.concat(s.call(arguments));return this instanceof o?function(e,t,n){if(!(t in l)){for(var r=[],o=0;o<t;o++)r[o]="a["+o+"]";l[t]=Function("F,a","return new F("+r.join(",")+")")}return l[t](e,n)}(n,e.length,e):a(n,e,t)};return u(n.prototype)&&(o.prototype=n.prototype),o}},function(e,t){e.exports=function(e,t,n){var r=void 0===n;switch(t.length){case 0:return r?e():e.call(n);case 1:return r?e(t[0]):e.call(n,t[0]);case 2:return r?e(t[0],t[1]):e.call(n,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(n,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(n,t[0],t[1],t[2],t[3])}return e.apply(n,t)}},function(e,t,n){n(59)("match",1,(function(r,o,e){return[function(e){var t=r(this),n=null==e?void 0:e[o];return void 0!==n?n.call(e,t):new RegExp(e)[o](String(t))},e]}))},function(e,t,n){var a=n(7),s=n(16),l=n(4),c=n(12),p=n(34);e.exports=function(t,e,n){var r=p(t),o=n(c,r,""[t]),i=o[0],u=o[1];l((function(){var e={};return e[r]=function(){return 7},7!=""[t](e)}))&&(s(String.prototype,t,i),a(RegExp.prototype,r,2==e?function(e,t){return u.call(e,this,t)}:function(e){return u.call(e,this)}))}},function(e,t,n){t.__esModule=!0,t.default=void 0,n(36);var _=n(5),o=function(o){function e(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=o.call.apply(o,[this].concat(n))||this).state={bump:!1,debounced:!1},e}!function(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t}(e,o);var t=e.prototype;return t.componentWillMount=function(){var e=this;this.debounceStatusUpdate=function(o,i,u){var a;return function(){var e=this,t=arguments,r=u&&!a;clearTimeout(a),a=setTimeout((function(){a=null,u||o.apply(e,t)}),i),r&&o.apply(e,t)}}((function(){if(!e.state.debounced){var t=!e.props.isInFocus||e.props.validChoiceMade;e.setState((function(e){return{bump:!e.bump,debounced:!0,silenced:t}}))}}),1400)},t.componentWillReceiveProps=function(e){e.queryLength,this.setState({debounced:!1})},t.render=function(){var g,e=this.props,t=e.id,n=e.length,r=e.queryLength,o=e.minQueryLength,i=e.selectedOption,u=e.selectedOptionIndex,a=e.tQueryTooShort,s=e.tNoResults,l=e.tSelectedOption,c=e.tResults,p=this.state,f=p.bump,d=p.debounced,h=p.silenced,m=r<o,v=0===n,y=i?l(i,n,u):"";return g=m?a(o):v?s():c(n,y),this.debounceStatusUpdate(),(0,_.createElement)("div",{style:{border:"0",clip:"rect(0 0 0 0)",height:"1px",marginBottom:"-1px",marginRight:"-1px",overflow:"hidden",padding:"0",position:"absolute",whiteSpace:"nowrap",width:"1px"}},(0,_.createElement)("div",{id:t+"__status--A",role:"status","aria-atomic":"true","aria-live":"polite"},!h&&d&&f?g:""),(0,_.createElement)("div",{id:t+"__status--B",role:"status","aria-atomic":"true","aria-live":"polite"},h||!d||f?"":g))},e}(_.Component);(t.default=o).defaultProps={tQueryTooShort:function(e){return"Type in "+e+" or more characters for results"},tNoResults:function(){return"No search results"},tSelectedOption:function(e,t,n){return e+" "+(n+1)+" of "+t+" is highlighted"},tResults:function(e,t){return e+" "+(1===e?"result":"results")+" "+(1===e?"is":"are")+" available. "+t}}},function(e,t,n){t.__esModule=!0,t.default=void 0;var r=n(5);t.default=function(e){var t=e.className;return(0,r.createElement)("svg",{version:"1.1",xmlns:"http://www.w3.org/2000/svg",className:t,focusable:"false"},(0,r.createElement)("g",{stroke:"none",fill:"none","fill-rule":"evenodd"},(0,r.createElement)("polygon",{fill:"#000000",points:"0 0 22 0 11 17"})))}}]).default})),
/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v4.0.2/LICENSE.txt
 */
function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):(global="undefined"!=typeof globalThis?globalThis:global||self).maplibregl=factory()}(this,(function(){var maplibregl={},modules={};function define(moduleName,_dependencies,moduleFactory){if(modules[moduleName]=moduleFactory,"index"===moduleName){var workerBundleString="var sharedModule = {}; ("+modules.shared+")(sharedModule); ("+modules.worker+")(sharedModule);",sharedModule={};return modules.shared(sharedModule),modules.index(maplibregl,sharedModule),"undefined"!=typeof window&&maplibregl.setWorkerUrl(window.URL.createObjectURL(new Blob([workerBundleString],{type:"text/javascript"}))),maplibregl}}return define("shared",0,(function(exports){function __awaiter(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))}Object.create;Object.create;"function"==typeof SuppressedError&&SuppressedError;"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function getDefaultExportFromCjs$1(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x.default:x}var pointGeometry=Point$1;function Point$1(x,y){this.x=x,this.y=y}Point$1.prototype={clone:function(){return new Point$1(this.x,this.y)},add:function(p){return this.clone()._add(p)},sub:function(p){return this.clone()._sub(p)},multByPoint:function(p){return this.clone()._multByPoint(p)},divByPoint:function(p){return this.clone()._divByPoint(p)},mult:function(k){return this.clone()._mult(k)},div:function(k){return this.clone()._div(k)},rotate:function(a){return this.clone()._rotate(a)},rotateAround:function(a,p){return this.clone()._rotateAround(a,p)},matMult:function(m){return this.clone()._matMult(m)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(other){return this.x===other.x&&this.y===other.y},dist:function(p){return Math.sqrt(this.distSqr(p))},distSqr:function(p){var dx=p.x-this.x,dy=p.y-this.y;return dx*dx+dy*dy},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(b){return Math.atan2(this.y-b.y,this.x-b.x)},angleWith:function(b){return this.angleWithSep(b.x,b.y)},angleWithSep:function(x,y){return Math.atan2(this.x*y-this.y*x,this.x*x+this.y*y)},_matMult:function(m){var x=m[0]*this.x+m[1]*this.y,y=m[2]*this.x+m[3]*this.y;return this.x=x,this.y=y,this},_add:function(p){return this.x+=p.x,this.y+=p.y,this},_sub:function(p){return this.x-=p.x,this.y-=p.y,this},_mult:function(k){return this.x*=k,this.y*=k,this},_div:function(k){return this.x/=k,this.y/=k,this},_multByPoint:function(p){return this.x*=p.x,this.y*=p.y,this},_divByPoint:function(p){return this.x/=p.x,this.y/=p.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var y=this.y;return this.y=this.x,this.x=-y,this},_rotate:function(angle){var cos=Math.cos(angle),sin=Math.sin(angle),x=cos*this.x-sin*this.y,y=sin*this.x+cos*this.y;return this.x=x,this.y=y,this},_rotateAround:function(angle,p){var cos=Math.cos(angle),sin=Math.sin(angle),x=p.x+cos*(this.x-p.x)-sin*(this.y-p.y),y=p.y+sin*(this.x-p.x)+cos*(this.y-p.y);return this.x=x,this.y=y,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Point$1.convert=function(a){return a instanceof Point$1?a:Array.isArray(a)?new Point$1(a[0],a[1]):a};var Point$2=getDefaultExportFromCjs$1(pointGeometry),unitbezier$1=UnitBezier$2;function UnitBezier$2(p1x,p1y,p2x,p2y){this.cx=3*p1x,this.bx=3*(p2x-p1x)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*p1y,this.by=3*(p2y-p1y)-this.cy,this.ay=1-this.cy-this.by,this.p1x=p1x,this.p1y=p1y,this.p2x=p2x,this.p2y=p2y}UnitBezier$2.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(x,epsilon){if(void 0===epsilon&&(epsilon=1e-6),x<0)return 0;if(x>1)return 1;for(var t=x,i=0;i<8;i++){var x2=this.sampleCurveX(t)-x;if(Math.abs(x2)<epsilon)return t;var d2=this.sampleCurveDerivativeX(t);if(Math.abs(d2)<1e-6)break;t-=x2/d2}var t0=0,t1=1;for(t=x,i=0;i<20&&(x2=this.sampleCurveX(t),!(Math.abs(x2-x)<epsilon));i++)x>x2?t0=t:t1=t,t=.5*(t1-t0)+t0;return t},solve:function(x,epsilon){return this.sampleCurveY(this.solveCurveX(x,epsilon))}};var UnitBezier$3=getDefaultExportFromCjs$1(unitbezier$1);let supportsOffscreenCanvas,offscreenCanvasDistorted;function offscreenCanvasSupported(){return null==supportsOffscreenCanvas&&(supportsOffscreenCanvas="undefined"!=typeof OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof createImageBitmap),supportsOffscreenCanvas}function isOffscreenCanvasDistorted(){if(null==offscreenCanvasDistorted&&(offscreenCanvasDistorted=!1,offscreenCanvasSupported())){const size=5,context=new OffscreenCanvas(size,size).getContext("2d",{willReadFrequently:!0});if(context){for(let i=0;i<size*size;i++){const base=4*i;context.fillStyle=`rgb(${base},${base+1},${base+2})`,context.fillRect(i%size,Math.floor(i/size),1,1)}const data=context.getImageData(0,0,size,size).data;for(let i=0;i<size*size*4;i++)if(i%4!=3&&data[i]!==i){offscreenCanvasDistorted=!0;break}}}return offscreenCanvasDistorted||!1}function bezier$1(p1x,p1y,p2x,p2y){const bezier=new UnitBezier$3(p1x,p1y,p2x,p2y);return function(t){return bezier.solve(t)}}const defaultEasing=bezier$1(.25,.1,.25,1);function clamp$1(n,min,max){return Math.min(max,Math.max(min,n))}function wrap(n,min,max){const d=max-min,w=((n-min)%d+d)%d+min;return w===min?max:w}function extend(dest,...sources){for(const src of sources)for(const k in src)dest[k]=src[k];return dest}let id=1;function mapObject(input,iterator,context){const output={};for(const key in input)output[key]=iterator.call(context||this,input[key],key,input);return output}function filterObject(input,iterator,context){const output={};for(const key in input)iterator.call(context||this,input[key],key,input)&&(output[key]=input[key]);return output}function clone$9(input){return Array.isArray(input)?input.map(clone$9):"object"==typeof input&&input?mapObject(input,clone$9):input}const warnOnceHistory={};function warnOnce(message){warnOnceHistory[message]||("undefined"!=typeof console&&console.warn(message),warnOnceHistory[message]=!0)}function isCounterClockwise(a,b,c){return(c.y-a.y)*(b.x-a.x)>(b.y-a.y)*(c.x-a.x)}function calculateSignedArea(ring){let sum=0;for(let p1,p2,i=0,len=ring.length,j=len-1;i<len;j=i++)p1=ring[i],p2=ring[j],sum+=(p2.x-p1.x)*(p1.y+p2.y);return sum}function isWorker(self){return"undefined"!=typeof WorkerGlobalScope&&void 0!==self&&self instanceof WorkerGlobalScope}let _isSafari=null;function isImageBitmap(image){return"undefined"!=typeof ImageBitmap&&image instanceof ImageBitmap}const transparentPngUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function readImageUsingVideoFrame(image,x,y,width,height){return __awaiter(this,void 0,void 0,(function*(){if("undefined"==typeof VideoFrame)throw new Error("VideoFrame not supported");const frame=new VideoFrame(image,{timestamp:0});try{const format=null==frame?void 0:frame.format;if(!format||!format.startsWith("BGR")&&!format.startsWith("RGB"))throw new Error(`Unrecognized format ${format}`);const swapBR=format.startsWith("BGR"),result=new Uint8ClampedArray(width*height*4);if(yield frame.copyTo(result,function(image,x,y,width,height){const destRowOffset=4*Math.max(-x,0),offset=(Math.max(0,y)-y)*width*4+destRowOffset,stride=4*width,sourceLeft=Math.max(0,x),sourceTop=Math.max(0,y);return{rect:{x:sourceLeft,y:sourceTop,width:Math.min(image.width,x+width)-sourceLeft,height:Math.min(image.height,y+height)-sourceTop},layout:[{offset:offset,stride:stride}]}}(image,x,y,width,height)),swapBR)for(let i=0;i<result.length;i+=4){const tmp=result[i];result[i]=result[i+2],result[i+2]=tmp}return result}finally{frame.close()}}))}let offscreenCanvas,offscreenCanvasContext;const ABORT_ERROR="AbortError";function createAbortError(){return new Error(ABORT_ERROR)}const config={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function getProtocol(url){return config.REGISTERED_PROTOCOLS[url.substring(0,url.indexOf("://"))]}class AJAXError extends Error{constructor(status,statusText,url,body){super(`AJAXError: ${statusText} (${status}): ${url}`),this.status=status,this.statusText=statusText,this.url=url,this.body=body}}const getReferrer=()=>isWorker(self)?self.worker&&self.worker.referrer:("blob:"===window.location.protocol?window.parent:window).location.href;const makeRequest=function(requestParameters,abortController){if(/:\/\//.test(requestParameters.url)&&!/^https?:|^file:/.test(requestParameters.url)){const protocolLoadFn=getProtocol(requestParameters.url);if(protocolLoadFn)return protocolLoadFn(requestParameters,abortController);if(isWorker(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"getResource",data:requestParameters,targetMapId:"global-dispatcher"},abortController)}if(url=requestParameters.url,!(/^file:/.test(url)||/^file:/.test(getReferrer())&&!/^\w+:/.test(url))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(requestParameters,abortController){return __awaiter(this,void 0,void 0,(function*(){const request=new Request(requestParameters.url,{method:requestParameters.method||"GET",body:requestParameters.body,credentials:requestParameters.credentials,headers:requestParameters.headers,cache:requestParameters.cache,referrer:getReferrer(),signal:abortController.signal});"json"===requestParameters.type&&request.headers.set("Accept","application/json");const response=yield fetch(request);if(!response.ok){const body=yield response.blob();throw new AJAXError(response.status,response.statusText,requestParameters.url,body)}const parsePromise="arrayBuffer"===requestParameters.type||"image"===requestParameters.type?response.arrayBuffer():"json"===requestParameters.type?response.json():response.text(),result=yield parsePromise;if(abortController.signal.aborted)throw createAbortError();return{data:result,cacheControl:response.headers.get("Cache-Control"),expires:response.headers.get("Expires")}}))}(requestParameters,abortController);if(isWorker(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"getResource",data:requestParameters,mustQueue:!0,targetMapId:"global-dispatcher"},abortController)}var url;return function(requestParameters,abortController){return new Promise(((resolve,reject)=>{const xhr=new XMLHttpRequest;xhr.open(requestParameters.method||"GET",requestParameters.url,!0),"arrayBuffer"!==requestParameters.type&&"image"!==requestParameters.type||(xhr.responseType="arraybuffer");for(const k in requestParameters.headers)xhr.setRequestHeader(k,requestParameters.headers[k]);"json"===requestParameters.type&&(xhr.responseType="text",xhr.setRequestHeader("Accept","application/json")),xhr.withCredentials="include"===requestParameters.credentials,xhr.onerror=()=>{reject(new Error(xhr.statusText))},xhr.onload=()=>{if(!abortController.signal.aborted)if((xhr.status>=200&&xhr.status<300||0===xhr.status)&&null!==xhr.response){let data=xhr.response;if("json"===requestParameters.type)try{data=JSON.parse(xhr.response)}catch(err){return void reject(err)}resolve({data:data,cacheControl:xhr.getResponseHeader("Cache-Control"),expires:xhr.getResponseHeader("Expires")})}else{const body=new Blob([xhr.response],{type:xhr.getResponseHeader("Content-Type")});reject(new AJAXError(xhr.status,xhr.statusText,requestParameters.url,body))}},abortController.signal.addEventListener("abort",(()=>{xhr.abort(),reject(createAbortError())})),xhr.send(requestParameters.body)}))}(requestParameters,abortController)};function sameOrigin(inComingUrl){if(!inComingUrl||inComingUrl.indexOf("://")<=0||0===inComingUrl.indexOf("data:image/")||0===inComingUrl.indexOf("blob:"))return!0;const urlObj=new URL(inComingUrl),locationObj=window.location;return urlObj.protocol===locationObj.protocol&&urlObj.host===locationObj.host}function _addEventListener(type,listener,listenerList){listenerList[type]&&-1!==listenerList[type].indexOf(listener)||(listenerList[type]=listenerList[type]||[],listenerList[type].push(listener))}function _removeEventListener(type,listener,listenerList){if(listenerList&&listenerList[type]){const index=listenerList[type].indexOf(listener);-1!==index&&listenerList[type].splice(index,1)}}class Event{constructor(type,data={}){extend(this,data),this.type=type}}class ErrorEvent extends Event{constructor(error,data={}){super("error",extend({error:error},data))}}class Evented{on(type,listener){return this._listeners=this._listeners||{},_addEventListener(type,listener,this._listeners),this}off(type,listener){return _removeEventListener(type,listener,this._listeners),_removeEventListener(type,listener,this._oneTimeListeners),this}once(type,listener){return listener?(this._oneTimeListeners=this._oneTimeListeners||{},_addEventListener(type,listener,this._oneTimeListeners),this):new Promise((resolve=>this.once(type,resolve)))}fire(event,properties){"string"==typeof event&&(event=new Event(event,properties||{}));const type=event.type;if(this.listens(type)){event.target=this;const listeners=this._listeners&&this._listeners[type]?this._listeners[type].slice():[];for(const listener of listeners)listener.call(this,event);const oneTimeListeners=this._oneTimeListeners&&this._oneTimeListeners[type]?this._oneTimeListeners[type].slice():[];for(const listener of oneTimeListeners)_removeEventListener(type,listener,this._oneTimeListeners),listener.call(this,event);const parent=this._eventedParent;parent&&(extend(event,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),parent.fire(event))}else event instanceof ErrorEvent&&console.error(event.error);return this}listens(type){return this._listeners&&this._listeners[type]&&this._listeners[type].length>0||this._oneTimeListeners&&this._oneTimeListeners[type]&&this._oneTimeListeners[type].length>0||this._eventedParent&&this._eventedParent.listens(type)}setEventedParent(parent,data){return this._eventedParent=parent,this._eventedParentData=data,this}}var v8Spec={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{},within:{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function deref(layer,parent){const result={};for(const k in layer)"ref"!==k&&(result[k]=layer[k]);return refProperties.forEach((k=>{k in parent&&(result[k]=parent[k])})),result}function deepEqual(a,b){if(Array.isArray(a)){if(!Array.isArray(b)||a.length!==b.length)return!1;for(let i=0;i<a.length;i++)if(!deepEqual(a[i],b[i]))return!1;return!0}if("object"==typeof a&&null!==a&&null!==b){if("object"!=typeof b)return!1;if(Object.keys(a).length!==Object.keys(b).length)return!1;for(const key in a)if(!deepEqual(a[key],b[key]))return!1;return!0}return a===b}function addCommand(commands,command){commands.push(command)}function addSource(sourceId,after,commands){addCommand(commands,{command:"addSource",args:[sourceId,after[sourceId]]})}function removeSource(sourceId,commands,sourcesRemoved){addCommand(commands,{command:"removeSource",args:[sourceId]}),sourcesRemoved[sourceId]=!0}function updateSource(sourceId,after,commands,sourcesRemoved){removeSource(sourceId,commands,sourcesRemoved),addSource(sourceId,after,commands)}function canUpdateGeoJSON(before,after,sourceId){let prop;for(prop in before[sourceId])if(Object.prototype.hasOwnProperty.call(before[sourceId],prop)&&"data"!==prop&&!deepEqual(before[sourceId][prop],after[sourceId][prop]))return!1;for(prop in after[sourceId])if(Object.prototype.hasOwnProperty.call(after[sourceId],prop)&&"data"!==prop&&!deepEqual(before[sourceId][prop],after[sourceId][prop]))return!1;return!0}function diffLayerPropertyChanges(before,after,commands,layerId,klass,command){before=before||{},after=after||{};for(const prop in before)Object.prototype.hasOwnProperty.call(before,prop)&&(deepEqual(before[prop],after[prop])||commands.push({command:command,args:[layerId,prop,after[prop],klass]}));for(const prop in after)Object.prototype.hasOwnProperty.call(after,prop)&&!Object.prototype.hasOwnProperty.call(before,prop)&&(deepEqual(before[prop],after[prop])||commands.push({command:command,args:[layerId,prop,after[prop],klass]}))}function pluckId(layer){return layer.id}function indexById(group,layer){return group[layer.id]=layer,group}class ValidationError{constructor(key,value,message,identifier){this.message=(key?`${key}: `:"")+message,identifier&&(this.identifier=identifier),null!=value&&value.__line__&&(this.line=value.__line__)}}function extendBy(output,...inputs){for(const input of inputs)for(const k in input)output[k]=input[k];return output}class ExpressionParsingError extends Error{constructor(key,message){super(message),this.message=message,this.key=key}}class Scope{constructor(parent,bindings=[]){this.parent=parent,this.bindings={};for(const[name,expression]of bindings)this.bindings[name]=expression}concat(bindings){return new Scope(this,bindings)}get(name){if(this.bindings[name])return this.bindings[name];if(this.parent)return this.parent.get(name);throw new Error(`${name} not found in scope.`)}has(name){return!!this.bindings[name]||!!this.parent&&this.parent.has(name)}}const NullType={kind:"null"},NumberType={kind:"number"},StringType={kind:"string"},BooleanType={kind:"boolean"},ColorType={kind:"color"},ObjectType={kind:"object"},ValueType={kind:"value"},CollatorType={kind:"collator"},FormattedType={kind:"formatted"},PaddingType={kind:"padding"},ResolvedImageType={kind:"resolvedImage"},VariableAnchorOffsetCollectionType={kind:"variableAnchorOffsetCollection"};function array$1(itemType,N){return{kind:"array",itemType:itemType,N:N}}function toString$1(type){if("array"===type.kind){const itemType=toString$1(type.itemType);return"number"==typeof type.N?`array<${itemType}, ${type.N}>`:"value"===type.itemType.kind?"array":`array<${itemType}>`}return type.kind}const valueMemberTypes=[NullType,NumberType,StringType,BooleanType,ColorType,FormattedType,ObjectType,array$1(ValueType),PaddingType,ResolvedImageType,VariableAnchorOffsetCollectionType];function checkSubtype(expected,t){if("error"===t.kind)return null;if("array"===expected.kind){if("array"===t.kind&&(0===t.N&&"value"===t.itemType.kind||!checkSubtype(expected.itemType,t.itemType))&&("number"!=typeof expected.N||expected.N===t.N))return null}else{if(expected.kind===t.kind)return null;if("value"===expected.kind)for(const memberType of valueMemberTypes)if(!checkSubtype(memberType,t))return null}return`Expected ${toString$1(expected)} but found ${toString$1(t)} instead.`}function isValidType(provided,allowedTypes){return allowedTypes.some((t=>t.kind===provided.kind))}function isValidNativeType(provided,allowedTypes){return allowedTypes.some((t=>"null"===t?null===provided:"array"===t?Array.isArray(provided):"object"===t?provided&&!Array.isArray(provided)&&"object"==typeof provided:t===typeof provided))}function verifyType(provided,sample){return"array"===provided.kind&&"array"===sample.kind?provided.itemType.kind===sample.itemType.kind&&"number"==typeof provided.N:provided.kind===sample.kind}const Xn=.96422,Yn=1,Zn=.82521,t0=4/29,t1=6/29,t2=3*t1*t1,t3=t1*t1*t1,deg2rad=Math.PI/180,rad2deg=180/Math.PI;function constrainAngle(angle){return(angle%=360)<0&&(angle+=360),angle}function rgbToLab([r,g,b,alpha]){let x,z;const y=xyz2lab((.2225045*(r=rgb2xyz(r))+.7168786*(g=rgb2xyz(g))+.0606169*(b=rgb2xyz(b)))/Yn);r===g&&g===b?x=z=y:(x=xyz2lab((.4360747*r+.3850649*g+.1430804*b)/Xn),z=xyz2lab((.0139322*r+.0971045*g+.7141733*b)/Zn));const l=116*y-16;return[l<0?0:l,500*(x-y),200*(y-z),alpha]}function rgb2xyz(x){return x<=.04045?x/12.92:Math.pow((x+.055)/1.055,2.4)}function xyz2lab(t){return t>t3?Math.pow(t,1/3):t/t2+t0}function labToRgb([l,a,b,alpha]){let y=(l+16)/116,x=isNaN(a)?y:y+a/500,z=isNaN(b)?y:y-b/200;return y=Yn*lab2xyz(y),x=Xn*lab2xyz(x),z=Zn*lab2xyz(z),[xyz2rgb(3.1338561*x-1.6168667*y-.4906146*z),xyz2rgb(-.9787684*x+1.9161415*y+.033454*z),xyz2rgb(.0719453*x-.2289914*y+1.4052427*z),alpha]}function xyz2rgb(x){return(x=x<=.00304?12.92*x:1.055*Math.pow(x,1/2.4)-.055)<0?0:x>1?1:x}function lab2xyz(t){return t>t1?t*t*t:t2*(t-t0)}function parseCssColor(input){if("transparent"===(input=input.toLowerCase().trim()))return[0,0,0,0];const namedColorsMatch=namedColors[input];if(namedColorsMatch){const[r,g,b]=namedColorsMatch;return[r/255,g/255,b/255,1]}if(input.startsWith("#")){if(/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(input)){const step=input.length<6?1:2;let i=1;return[parseHex(input.slice(i,i+=step)),parseHex(input.slice(i,i+=step)),parseHex(input.slice(i,i+=step)),parseHex(input.slice(i,i+step)||"ff")]}}if(input.startsWith("rgb")){const rgbRegExp=/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/,rgbMatch=input.match(rgbRegExp);if(rgbMatch){const[_,r,rp,f1,g,gp,f2,b,bp,f3,a,ap]=rgbMatch,argFormat=[f1||" ",f2||" ",f3].join("");if("  "===argFormat||"  /"===argFormat||",,"===argFormat||",,,"===argFormat){const valFormat=[rp,gp,bp].join(""),maxValue="%%%"===valFormat?100:""===valFormat?255:0;if(maxValue){const rgba=[clamp(+r/maxValue,0,1),clamp(+g/maxValue,0,1),clamp(+b/maxValue,0,1),a?parseAlpha(+a,ap):1];if(validateNumbers(rgba))return rgba}}return}}const hslMatch=input.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(hslMatch){const[_,h,f1,s,f2,l,f3,a,ap]=hslMatch,argFormat=[f1||" ",f2||" ",f3].join("");if("  "===argFormat||"  /"===argFormat||",,"===argFormat||",,,"===argFormat){const hsla=[+h,clamp(+s,0,100),clamp(+l,0,100),a?parseAlpha(+a,ap):1];if(validateNumbers(hsla))return function([h,s,l,alpha]){function f(n){const k=(n+h/30)%12,a=s*Math.min(l,1-l);return l-a*Math.max(-1,Math.min(k-3,9-k,1))}return h=constrainAngle(h),s/=100,l/=100,[f(0),f(8),f(4),alpha]}(hsla)}}}function parseHex(hex){return parseInt(hex.padEnd(2,hex),16)/255}function parseAlpha(a,asPercentage){return clamp(asPercentage?a/100:a,0,1)}function clamp(n,min,max){return Math.min(Math.max(min,n),max)}function validateNumbers(array){return!array.some(Number.isNaN)}const namedColors={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};class Color{constructor(r,g,b,alpha=1,premultiplied=!0){this.r=r,this.g=g,this.b=b,this.a=alpha,premultiplied||(this.r*=alpha,this.g*=alpha,this.b*=alpha,alpha||this.overwriteGetter("rgb",[r,g,b,alpha]))}static parse(input){if(input instanceof Color)return input;if("string"!=typeof input)return;const rgba=parseCssColor(input);return rgba?new Color(...rgba,!1):void 0}get rgb(){const{r:r,g:g,b:b,a:a}=this,f=a||1/0;return this.overwriteGetter("rgb",[r/f,g/f,b/f,a])}get hcl(){return this.overwriteGetter("hcl",function(rgbColor){const[l,a,b,alpha]=rgbToLab(rgbColor),c=Math.sqrt(a*a+b*b);return[Math.round(1e4*c)?constrainAngle(Math.atan2(b,a)*rad2deg):NaN,c,l,alpha]}(this.rgb))}get lab(){return this.overwriteGetter("lab",rgbToLab(this.rgb))}overwriteGetter(getterKey,lazyValue){return Object.defineProperty(this,getterKey,{value:lazyValue}),lazyValue}toString(){const[r,g,b,a]=this.rgb;return`rgba(${[r,g,b].map((n=>Math.round(255*n))).join(",")},${a})`}}Color.black=new Color(0,0,0,1),Color.white=new Color(1,1,1,1),Color.transparent=new Color(0,0,0,0),Color.red=new Color(1,0,0,1);class Collator{constructor(caseSensitive,diacriticSensitive,locale){this.sensitivity=caseSensitive?diacriticSensitive?"variant":"case":diacriticSensitive?"accent":"base",this.locale=locale,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(lhs,rhs){return this.collator.compare(lhs,rhs)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class FormattedSection{constructor(text,image,scale,fontStack,textColor){this.text=text,this.image=image,this.scale=scale,this.fontStack=fontStack,this.textColor=textColor}}class Formatted{constructor(sections){this.sections=sections}static fromString(unformatted){return new Formatted([new FormattedSection(unformatted,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((section=>0!==section.text.length||section.image&&0!==section.image.name.length))}static factory(text){return text instanceof Formatted?text:Formatted.fromString(text)}toString(){return 0===this.sections.length?"":this.sections.map((section=>section.text)).join("")}}class Padding{constructor(values){this.values=values.slice()}static parse(input){if(input instanceof Padding)return input;if("number"==typeof input)return new Padding([input,input,input,input]);if(Array.isArray(input)&&!(input.length<1||input.length>4)){for(const val of input)if("number"!=typeof val)return;switch(input.length){case 1:input=[input[0],input[0],input[0],input[0]];break;case 2:input=[input[0],input[1],input[0],input[1]];break;case 3:input=[input[0],input[1],input[2],input[1]]}return new Padding(input)}}toString(){return JSON.stringify(this.values)}}const anchors=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class VariableAnchorOffsetCollection{constructor(values){this.values=values.slice()}static parse(input){if(input instanceof VariableAnchorOffsetCollection)return input;if(Array.isArray(input)&&!(input.length<1)&&input.length%2==0){for(let i=0;i<input.length;i+=2){const anchorValue=input[i],offsetValue=input[i+1];if("string"!=typeof anchorValue||!anchors.has(anchorValue))return;if(!Array.isArray(offsetValue)||2!==offsetValue.length||"number"!=typeof offsetValue[0]||"number"!=typeof offsetValue[1])return}return new VariableAnchorOffsetCollection(input)}}toString(){return JSON.stringify(this.values)}}class ResolvedImage{constructor(options){this.name=options.name,this.available=options.available}toString(){return this.name}static fromString(name){return name?new ResolvedImage({name:name,available:!1}):null}}function validateRGBA(r,g,b,a){if(!("number"==typeof r&&r>=0&&r<=255&&"number"==typeof g&&g>=0&&g<=255&&"number"==typeof b&&b>=0&&b<=255)){return`Invalid rgba value [${("number"==typeof a?[r,g,b,a]:[r,g,b]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}return void 0===a||"number"==typeof a&&a>=0&&a<=1?null:`Invalid rgba value [${[r,g,b,a].join(", ")}]: 'a' must be between 0 and 1.`}function isValue(mixed){if(null===mixed||"string"==typeof mixed||"boolean"==typeof mixed||"number"==typeof mixed||mixed instanceof Color||mixed instanceof Collator||mixed instanceof Formatted||mixed instanceof Padding||mixed instanceof VariableAnchorOffsetCollection||mixed instanceof ResolvedImage)return!0;if(Array.isArray(mixed)){for(const item of mixed)if(!isValue(item))return!1;return!0}if("object"==typeof mixed){for(const key in mixed)if(!isValue(mixed[key]))return!1;return!0}return!1}function typeOf(value){if(null===value)return NullType;if("string"==typeof value)return StringType;if("boolean"==typeof value)return BooleanType;if("number"==typeof value)return NumberType;if(value instanceof Color)return ColorType;if(value instanceof Collator)return CollatorType;if(value instanceof Formatted)return FormattedType;if(value instanceof Padding)return PaddingType;if(value instanceof VariableAnchorOffsetCollection)return VariableAnchorOffsetCollectionType;if(value instanceof ResolvedImage)return ResolvedImageType;if(Array.isArray(value)){const length=value.length;let itemType;for(const item of value){const t=typeOf(item);if(itemType){if(itemType===t)continue;itemType=ValueType;break}itemType=t}return array$1(itemType||ValueType,length)}return ObjectType}function toString(value){const type=typeof value;return null===value?"":"string"===type||"number"===type||"boolean"===type?String(value):value instanceof Color||value instanceof Formatted||value instanceof Padding||value instanceof VariableAnchorOffsetCollection||value instanceof ResolvedImage?value.toString():JSON.stringify(value)}class Literal{constructor(type,value){this.type=type,this.value=value}static parse(args,context){if(2!==args.length)return context.error(`'literal' expression requires exactly one argument, but found ${args.length-1} instead.`);if(!isValue(args[1]))return context.error("invalid value");const value=args[1];let type=typeOf(value);const expected=context.expectedType;return"array"!==type.kind||0!==type.N||!expected||"array"!==expected.kind||"number"==typeof expected.N&&0!==expected.N||(type=expected),new Literal(type,value)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}class RuntimeError{constructor(message){this.name="ExpressionEvaluationError",this.message=message}toJSON(){return this.message}}const types$1={string:StringType,number:NumberType,boolean:BooleanType,object:ObjectType};class Assertion{constructor(type,args){this.type=type,this.args=args}static parse(args,context){if(args.length<2)return context.error("Expected at least one argument.");let type,i=1;const name=args[0];if("array"===name){let itemType,N;if(args.length>2){const type=args[1];if("string"!=typeof type||!(type in types$1)||"object"===type)return context.error('The item type argument of "array" must be one of string, number, boolean',1);itemType=types$1[type],i++}else itemType=ValueType;if(args.length>3){if(null!==args[2]&&("number"!=typeof args[2]||args[2]<0||args[2]!==Math.floor(args[2])))return context.error('The length argument to "array" must be a positive integer literal',2);N=args[2],i++}type=array$1(itemType,N)}else{if(!types$1[name])throw new Error(`Types doesn't contain name = ${name}`);type=types$1[name]}const parsed=[];for(;i<args.length;i++){const input=context.parse(args[i],i,ValueType);if(!input)return null;parsed.push(input)}return new Assertion(type,parsed)}evaluate(ctx){for(let i=0;i<this.args.length;i++){const value=this.args[i].evaluate(ctx);if(!checkSubtype(this.type,typeOf(value)))return value;if(i===this.args.length-1)throw new RuntimeError(`Expected value to be of type ${toString$1(this.type)}, but found ${toString$1(typeOf(value))} instead.`)}throw new Error}eachChild(fn){this.args.forEach(fn)}outputDefined(){return this.args.every((arg=>arg.outputDefined()))}}const types={"to-boolean":BooleanType,"to-color":ColorType,"to-number":NumberType,"to-string":StringType};class Coercion{constructor(type,args){this.type=type,this.args=args}static parse(args,context){if(args.length<2)return context.error("Expected at least one argument.");const name=args[0];if(!types[name])throw new Error(`Can't parse ${name} as it is not part of the known types`);if(("to-boolean"===name||"to-string"===name)&&2!==args.length)return context.error("Expected one argument.");const type=types[name],parsed=[];for(let i=1;i<args.length;i++){const input=context.parse(args[i],i,ValueType);if(!input)return null;parsed.push(input)}return new Coercion(type,parsed)}evaluate(ctx){switch(this.type.kind){case"boolean":return Boolean(this.args[0].evaluate(ctx));case"color":{let input,error;for(const arg of this.args){if(input=arg.evaluate(ctx),error=null,input instanceof Color)return input;if("string"==typeof input){const c=ctx.parseColor(input);if(c)return c}else if(Array.isArray(input)&&(error=input.length<3||input.length>4?`Invalid rbga value ${JSON.stringify(input)}: expected an array containing either three or four numeric values.`:validateRGBA(input[0],input[1],input[2],input[3]),!error))return new Color(input[0]/255,input[1]/255,input[2]/255,input[3])}throw new RuntimeError(error||`Could not parse color from value '${"string"==typeof input?input:JSON.stringify(input)}'`)}case"padding":{let input;for(const arg of this.args){input=arg.evaluate(ctx);const pad=Padding.parse(input);if(pad)return pad}throw new RuntimeError(`Could not parse padding from value '${"string"==typeof input?input:JSON.stringify(input)}'`)}case"variableAnchorOffsetCollection":{let input;for(const arg of this.args){input=arg.evaluate(ctx);const coll=VariableAnchorOffsetCollection.parse(input);if(coll)return coll}throw new RuntimeError(`Could not parse variableAnchorOffsetCollection from value '${"string"==typeof input?input:JSON.stringify(input)}'`)}case"number":{let value=null;for(const arg of this.args){if(value=arg.evaluate(ctx),null===value)return 0;const num=Number(value);if(!isNaN(num))return num}throw new RuntimeError(`Could not convert ${JSON.stringify(value)} to number.`)}case"formatted":return Formatted.fromString(toString(this.args[0].evaluate(ctx)));case"resolvedImage":return ResolvedImage.fromString(toString(this.args[0].evaluate(ctx)));default:return toString(this.args[0].evaluate(ctx))}}eachChild(fn){this.args.forEach(fn)}outputDefined(){return this.args.every((arg=>arg.outputDefined()))}}const geometryTypes=["Unknown","Point","LineString","Polygon"];class EvaluationContext{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?geometryTypes[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(input){let cached=this._parseColorCache[input];return cached||(cached=this._parseColorCache[input]=Color.parse(input)),cached}}class ParsingContext{constructor(registry,isConstantFunc,path=[],expectedType,scope=new Scope,errors=[]){this.registry=registry,this.path=path,this.key=path.map((part=>`[${part}]`)).join(""),this.scope=scope,this.errors=errors,this.expectedType=expectedType,this._isConstant=isConstantFunc}parse(expr,index,expectedType,bindings,options={}){return index?this.concat(index,expectedType,bindings)._parse(expr,options):this._parse(expr,options)}_parse(expr,options){function annotate(parsed,type,typeAnnotation){return"assert"===typeAnnotation?new Assertion(type,[parsed]):"coerce"===typeAnnotation?new Coercion(type,[parsed]):parsed}if(null!==expr&&"string"!=typeof expr&&"boolean"!=typeof expr&&"number"!=typeof expr||(expr=["literal",expr]),Array.isArray(expr)){if(0===expr.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const op=expr[0];if("string"!=typeof op)return this.error(`Expression name must be a string, but found ${typeof op} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const Expr=this.registry[op];if(Expr){let parsed=Expr.parse(expr,this);if(!parsed)return null;if(this.expectedType){const expected=this.expectedType,actual=parsed.type;if("string"!==expected.kind&&"number"!==expected.kind&&"boolean"!==expected.kind&&"object"!==expected.kind&&"array"!==expected.kind||"value"!==actual.kind)if("color"!==expected.kind&&"formatted"!==expected.kind&&"resolvedImage"!==expected.kind||"value"!==actual.kind&&"string"!==actual.kind)if("padding"!==expected.kind||"value"!==actual.kind&&"number"!==actual.kind&&"array"!==actual.kind)if("variableAnchorOffsetCollection"!==expected.kind||"value"!==actual.kind&&"array"!==actual.kind){if(this.checkSubtype(expected,actual))return null}else parsed=annotate(parsed,expected,options.typeAnnotation||"coerce");else parsed=annotate(parsed,expected,options.typeAnnotation||"coerce");else parsed=annotate(parsed,expected,options.typeAnnotation||"coerce");else parsed=annotate(parsed,expected,options.typeAnnotation||"assert")}if(!(parsed instanceof Literal)&&"resolvedImage"!==parsed.type.kind&&this._isConstant(parsed)){const ec=new EvaluationContext;try{parsed=new Literal(parsed.type,parsed.evaluate(ec))}catch(e){return this.error(e.message),null}}return parsed}return this.error(`Unknown expression "${op}". If you wanted a literal array, use ["literal", [...]].`,0)}return void 0===expr?this.error("'undefined' value invalid. Use null instead."):"object"==typeof expr?this.error('Bare objects invalid. Use ["literal", {...}] instead.'):this.error(`Expected an array, but found ${typeof expr} instead.`)}concat(index,expectedType,bindings){const path="number"==typeof index?this.path.concat(index):this.path,scope=bindings?this.scope.concat(bindings):this.scope;return new ParsingContext(this.registry,this._isConstant,path,expectedType||null,scope,this.errors)}error(error,...keys){const key=`${this.key}${keys.map((k=>`[${k}]`)).join("")}`;this.errors.push(new ExpressionParsingError(key,error))}checkSubtype(expected,t){const error=checkSubtype(expected,t);return error&&this.error(error),error}}class CollatorExpression{constructor(caseSensitive,diacriticSensitive,locale){this.type=CollatorType,this.locale=locale,this.caseSensitive=caseSensitive,this.diacriticSensitive=diacriticSensitive}static parse(args,context){if(2!==args.length)return context.error("Expected one argument.");const options=args[1];if("object"!=typeof options||Array.isArray(options))return context.error("Collator options argument must be an object.");const caseSensitive=context.parse(void 0!==options["case-sensitive"]&&options["case-sensitive"],1,BooleanType);if(!caseSensitive)return null;const diacriticSensitive=context.parse(void 0!==options["diacritic-sensitive"]&&options["diacritic-sensitive"],1,BooleanType);if(!diacriticSensitive)return null;let locale=null;return options.locale&&(locale=context.parse(options.locale,1,StringType),!locale)?null:new CollatorExpression(caseSensitive,diacriticSensitive,locale)}evaluate(ctx){return new Collator(this.caseSensitive.evaluate(ctx),this.diacriticSensitive.evaluate(ctx),this.locale?this.locale.evaluate(ctx):null)}eachChild(fn){fn(this.caseSensitive),fn(this.diacriticSensitive),this.locale&&fn(this.locale)}outputDefined(){return!1}}const EXTENT$1=8192;function updateBBox(bbox,coord){bbox[0]=Math.min(bbox[0],coord[0]),bbox[1]=Math.min(bbox[1],coord[1]),bbox[2]=Math.max(bbox[2],coord[0]),bbox[3]=Math.max(bbox[3],coord[1])}function boxWithinBox(bbox1,bbox2){return!(bbox1[0]<=bbox2[0])&&(!(bbox1[2]>=bbox2[2])&&(!(bbox1[1]<=bbox2[1])&&!(bbox1[3]>=bbox2[3])))}function getTileCoordinates(p,canonical){const x=(180+p[0])/360;const y=(lat=p[1],(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+lat*Math.PI/360)))/360);var lat;const tilesAtZoom=Math.pow(2,canonical.z);return[Math.round(x*tilesAtZoom*EXTENT$1),Math.round(y*tilesAtZoom*EXTENT$1)]}function onBoundary(p,p1,p2){const x1=p[0]-p1[0],y1=p[1]-p1[1],x2=p[0]-p2[0],y2=p[1]-p2[1];return x1*y2-x2*y1==0&&x1*x2<=0&&y1*y2<=0}function pointWithinPolygon(point,rings){let inside=!1;for(let i=0,len=rings.length;i<len;i++){const ring=rings[i];for(let j=0,len2=ring.length;j<len2-1;j++){if(onBoundary(point,ring[j],ring[j+1]))return!1;p=point,p1=ring[j],p2=ring[j+1],p1[1]>p[1]!=p2[1]>p[1]&&p[0]<(p2[0]-p1[0])*(p[1]-p1[1])/(p2[1]-p1[1])+p1[0]&&(inside=!inside)}}var p,p1,p2;return inside}function pointWithinPolygons(point,polygons){for(let i=0;i<polygons.length;i++)if(pointWithinPolygon(point,polygons[i]))return!0;return!1}function twoSided(p1,p2,q1,q2){const x1=p1[0]-q1[0],y1=p1[1]-q1[1],x2=p2[0]-q1[0],y2=p2[1]-q1[1],x3=q2[0]-q1[0],y3=q2[1]-q1[1],det1=x1*y3-x3*y1,det2=x2*y3-x3*y2;return det1>0&&det2<0||det1<0&&det2>0}function lineIntersectLine(a,b,c,d){const vectorP=[b[0]-a[0],b[1]-a[1]],vectorQ=[d[0]-c[0],d[1]-c[1]];return 0!=(v1=vectorQ)[0]*(v2=vectorP)[1]-v1[1]*v2[0]&&!(!twoSided(a,b,c,d)||!twoSided(c,d,a,b));var v1,v2}function lineIntersectPolygon(p1,p2,polygon){for(const ring of polygon)for(let j=0;j<ring.length-1;++j)if(lineIntersectLine(p1,p2,ring[j],ring[j+1]))return!0;return!1}function lineStringWithinPolygon(line,polygon){for(let i=0;i<line.length;++i)if(!pointWithinPolygon(line[i],polygon))return!1;for(let i=0;i<line.length-1;++i)if(lineIntersectPolygon(line[i],line[i+1],polygon))return!1;return!0}function lineStringWithinPolygons(line,polygons){for(let i=0;i<polygons.length;i++)if(lineStringWithinPolygon(line,polygons[i]))return!0;return!1}function getTilePolygon(coordinates,bbox,canonical){const polygon=[];for(let i=0;i<coordinates.length;i++){const ring=[];for(let j=0;j<coordinates[i].length;j++){const coord=getTileCoordinates(coordinates[i][j],canonical);updateBBox(bbox,coord),ring.push(coord)}polygon.push(ring)}return polygon}function getTilePolygons(coordinates,bbox,canonical){const polygons=[];for(let i=0;i<coordinates.length;i++){const polygon=getTilePolygon(coordinates[i],bbox,canonical);polygons.push(polygon)}return polygons}function updatePoint(p,bbox,polyBBox,worldSize){if(p[0]<polyBBox[0]||p[0]>polyBBox[2]){const halfWorldSize=.5*worldSize;let shift=p[0]-polyBBox[0]>halfWorldSize?-worldSize:polyBBox[0]-p[0]>halfWorldSize?worldSize:0;0===shift&&(shift=p[0]-polyBBox[2]>halfWorldSize?-worldSize:polyBBox[2]-p[0]>halfWorldSize?worldSize:0),p[0]+=shift}updateBBox(bbox,p)}function getTilePoints(geometry,pointBBox,polyBBox,canonical){const worldSize=Math.pow(2,canonical.z)*EXTENT$1,shifts=[canonical.x*EXTENT$1,canonical.y*EXTENT$1],tilePoints=[];for(const points of geometry)for(const point of points){const p=[point.x+shifts[0],point.y+shifts[1]];updatePoint(p,pointBBox,polyBBox,worldSize),tilePoints.push(p)}return tilePoints}function getTileLines(geometry,lineBBox,polyBBox,canonical){const worldSize=Math.pow(2,canonical.z)*EXTENT$1,shifts=[canonical.x*EXTENT$1,canonical.y*EXTENT$1],tileLines=[];for(const line of geometry){const tileLine=[];for(const point of line){const p=[point.x+shifts[0],point.y+shifts[1]];updateBBox(lineBBox,p),tileLine.push(p)}tileLines.push(tileLine)}if(lineBBox[2]-lineBBox[0]<=worldSize/2){(bbox=lineBBox)[0]=bbox[1]=1/0,bbox[2]=bbox[3]=-1/0;for(const line of tileLines)for(const p of line)updatePoint(p,lineBBox,polyBBox,worldSize)}var bbox;return tileLines}class Within{constructor(geojson,geometries){this.type=BooleanType,this.geojson=geojson,this.geometries=geometries}static parse(args,context){if(2!==args.length)return context.error(`'within' expression requires exactly one argument, but found ${args.length-1} instead.`);if(isValue(args[1])){const geojson=args[1];if("FeatureCollection"===geojson.type){const polygonsCoords=[];for(const polygon of geojson.features){const{type:type,coordinates:coordinates}=polygon.geometry;"Polygon"===type&&polygonsCoords.push(coordinates),"MultiPolygon"===type&&polygonsCoords.push(...coordinates)}if(polygonsCoords.length){return new Within(geojson,{type:"MultiPolygon",coordinates:polygonsCoords})}}else if("Feature"===geojson.type){const type=geojson.geometry.type;if("Polygon"===type||"MultiPolygon"===type)return new Within(geojson,geojson.geometry)}else if("Polygon"===geojson.type||"MultiPolygon"===geojson.type)return new Within(geojson,geojson)}return context.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(ctx){if(null!=ctx.geometry()&&null!=ctx.canonicalID()){if("Point"===ctx.geometryType())return function(ctx,polygonGeometry){const pointBBox=[1/0,1/0,-1/0,-1/0],polyBBox=[1/0,1/0,-1/0,-1/0],canonical=ctx.canonicalID();if("Polygon"===polygonGeometry.type){const tilePolygon=getTilePolygon(polygonGeometry.coordinates,polyBBox,canonical),tilePoints=getTilePoints(ctx.geometry(),pointBBox,polyBBox,canonical);if(!boxWithinBox(pointBBox,polyBBox))return!1;for(const point of tilePoints)if(!pointWithinPolygon(point,tilePolygon))return!1}if("MultiPolygon"===polygonGeometry.type){const tilePolygons=getTilePolygons(polygonGeometry.coordinates,polyBBox,canonical),tilePoints=getTilePoints(ctx.geometry(),pointBBox,polyBBox,canonical);if(!boxWithinBox(pointBBox,polyBBox))return!1;for(const point of tilePoints)if(!pointWithinPolygons(point,tilePolygons))return!1}return!0}(ctx,this.geometries);if("LineString"===ctx.geometryType())return function(ctx,polygonGeometry){const lineBBox=[1/0,1/0,-1/0,-1/0],polyBBox=[1/0,1/0,-1/0,-1/0],canonical=ctx.canonicalID();if("Polygon"===polygonGeometry.type){const tilePolygon=getTilePolygon(polygonGeometry.coordinates,polyBBox,canonical),tileLines=getTileLines(ctx.geometry(),lineBBox,polyBBox,canonical);if(!boxWithinBox(lineBBox,polyBBox))return!1;for(const line of tileLines)if(!lineStringWithinPolygon(line,tilePolygon))return!1}if("MultiPolygon"===polygonGeometry.type){const tilePolygons=getTilePolygons(polygonGeometry.coordinates,polyBBox,canonical),tileLines=getTileLines(ctx.geometry(),lineBBox,polyBBox,canonical);if(!boxWithinBox(lineBBox,polyBBox))return!1;for(const line of tileLines)if(!lineStringWithinPolygons(line,tilePolygons))return!1}return!0}(ctx,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}class Var{constructor(name,boundExpression){this.type=boundExpression.type,this.name=name,this.boundExpression=boundExpression}static parse(args,context){if(2!==args.length||"string"!=typeof args[1])return context.error("'var' expression requires exactly one string literal argument.");const name=args[1];return context.scope.has(name)?new Var(name,context.scope.get(name)):context.error(`Unknown variable "${name}". Make sure "${name}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(ctx){return this.boundExpression.evaluate(ctx)}eachChild(){}outputDefined(){return!1}}class CompoundExpression{constructor(name,type,evaluate,args){this.name=name,this.type=type,this._evaluate=evaluate,this.args=args}evaluate(ctx){return this._evaluate(ctx,this.args)}eachChild(fn){this.args.forEach(fn)}outputDefined(){return!1}static parse(args,context){const op=args[0],definition=CompoundExpression.definitions[op];if(!definition)return context.error(`Unknown expression "${op}". If you wanted a literal array, use ["literal", [...]].`,0);const type=Array.isArray(definition)?definition[0]:definition.type,availableOverloads=Array.isArray(definition)?[[definition[1],definition[2]]]:definition.overloads,overloads=availableOverloads.filter((([signature])=>!Array.isArray(signature)||signature.length===args.length-1));let signatureContext=null;for(const[params,evaluate]of overloads){signatureContext=new ParsingContext(context.registry,isExpressionConstant,context.path,null,context.scope);const parsedArgs=[];let argParseFailed=!1;for(let i=1;i<args.length;i++){const arg=args[i],expectedType=Array.isArray(params)?params[i-1]:params.type,parsed=signatureContext.parse(arg,1+parsedArgs.length,expectedType);if(!parsed){argParseFailed=!0;break}parsedArgs.push(parsed)}if(!argParseFailed)if(Array.isArray(params)&&params.length!==parsedArgs.length)signatureContext.error(`Expected ${params.length} arguments, but found ${parsedArgs.length} instead.`);else{for(let i=0;i<parsedArgs.length;i++){const expected=Array.isArray(params)?params[i]:params.type,arg=parsedArgs[i];signatureContext.concat(i+1).checkSubtype(expected,arg.type)}if(0===signatureContext.errors.length)return new CompoundExpression(op,type,evaluate,parsedArgs)}}if(1===overloads.length)context.errors.push(...signatureContext.errors);else{const signatures=(overloads.length?overloads:availableOverloads).map((([params])=>{return signature=params,Array.isArray(signature)?`(${signature.map(toString$1).join(", ")})`:`(${toString$1(signature.type)}...)`;var signature})).join(" | "),actualTypes=[];for(let i=1;i<args.length;i++){const parsed=context.parse(args[i],1+actualTypes.length);if(!parsed)return null;actualTypes.push(toString$1(parsed.type))}context.error(`Expected arguments of type ${signatures}, but found (${actualTypes.join(", ")}) instead.`)}return null}static register(registry,definitions){CompoundExpression.definitions=definitions;for(const name in definitions)registry[name]=CompoundExpression}}function isExpressionConstant(expression){if(expression instanceof Var)return isExpressionConstant(expression.boundExpression);if(expression instanceof CompoundExpression&&"error"===expression.name)return!1;if(expression instanceof CollatorExpression)return!1;if(expression instanceof Within)return!1;const isTypeAnnotation=expression instanceof Coercion||expression instanceof Assertion;let childrenConstant=!0;return expression.eachChild((child=>{childrenConstant=isTypeAnnotation?childrenConstant&&isExpressionConstant(child):childrenConstant&&child instanceof Literal})),!!childrenConstant&&(isFeatureConstant(expression)&&isGlobalPropertyConstant(expression,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"]))}function isFeatureConstant(e){if(e instanceof CompoundExpression){if("get"===e.name&&1===e.args.length)return!1;if("feature-state"===e.name)return!1;if("has"===e.name&&1===e.args.length)return!1;if("properties"===e.name||"geometry-type"===e.name||"id"===e.name)return!1;if(/^filter-/.test(e.name))return!1}if(e instanceof Within)return!1;let result=!0;return e.eachChild((arg=>{result&&!isFeatureConstant(arg)&&(result=!1)})),result}function isStateConstant(e){if(e instanceof CompoundExpression&&"feature-state"===e.name)return!1;let result=!0;return e.eachChild((arg=>{result&&!isStateConstant(arg)&&(result=!1)})),result}function isGlobalPropertyConstant(e,properties){if(e instanceof CompoundExpression&&properties.indexOf(e.name)>=0)return!1;let result=!0;return e.eachChild((arg=>{result&&!isGlobalPropertyConstant(arg,properties)&&(result=!1)})),result}function findStopLessThanOrEqualTo(stops,input){const lastIndex=stops.length-1;let currentValue,nextValue,lowerIndex=0,upperIndex=lastIndex,currentIndex=0;for(;lowerIndex<=upperIndex;)if(currentIndex=Math.floor((lowerIndex+upperIndex)/2),currentValue=stops[currentIndex],nextValue=stops[currentIndex+1],currentValue<=input){if(currentIndex===lastIndex||input<nextValue)return currentIndex;lowerIndex=currentIndex+1}else{if(!(currentValue>input))throw new RuntimeError("Input is not a number.");upperIndex=currentIndex-1}return 0}class Step{constructor(type,input,stops){this.type=type,this.input=input,this.labels=[],this.outputs=[];for(const[label,expression]of stops)this.labels.push(label),this.outputs.push(expression)}static parse(args,context){if(args.length-1<4)return context.error(`Expected at least 4 arguments, but found only ${args.length-1}.`);if((args.length-1)%2!=0)return context.error("Expected an even number of arguments.");const input=context.parse(args[1],1,NumberType);if(!input)return null;const stops=[];let outputType=null;context.expectedType&&"value"!==context.expectedType.kind&&(outputType=context.expectedType);for(let i=1;i<args.length;i+=2){const label=1===i?-1/0:args[i],value=args[i+1],labelKey=i,valueKey=i+1;if("number"!=typeof label)return context.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',labelKey);if(stops.length&&stops[stops.length-1][0]>=label)return context.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',labelKey);const parsed=context.parse(value,valueKey,outputType);if(!parsed)return null;outputType=outputType||parsed.type,stops.push([label,parsed])}return new Step(outputType,input,stops)}evaluate(ctx){const labels=this.labels,outputs=this.outputs;if(1===labels.length)return outputs[0].evaluate(ctx);const value=this.input.evaluate(ctx);if(value<=labels[0])return outputs[0].evaluate(ctx);const stopCount=labels.length;if(value>=labels[stopCount-1])return outputs[stopCount-1].evaluate(ctx);return outputs[findStopLessThanOrEqualTo(labels,value)].evaluate(ctx)}eachChild(fn){fn(this.input);for(const expression of this.outputs)fn(expression)}outputDefined(){return this.outputs.every((out=>out.outputDefined()))}}function getDefaultExportFromCjs(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x.default:x}var unitbezier=UnitBezier;function UnitBezier(p1x,p1y,p2x,p2y){this.cx=3*p1x,this.bx=3*(p2x-p1x)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*p1y,this.by=3*(p2y-p1y)-this.cy,this.ay=1-this.cy-this.by,this.p1x=p1x,this.p1y=p1y,this.p2x=p2x,this.p2y=p2y}UnitBezier.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(x,epsilon){if(void 0===epsilon&&(epsilon=1e-6),x<0)return 0;if(x>1)return 1;for(var t=x,i=0;i<8;i++){var x2=this.sampleCurveX(t)-x;if(Math.abs(x2)<epsilon)return t;var d2=this.sampleCurveDerivativeX(t);if(Math.abs(d2)<1e-6)break;t-=x2/d2}var t0=0,t1=1;for(t=x,i=0;i<20&&(x2=this.sampleCurveX(t),!(Math.abs(x2-x)<epsilon));i++)x>x2?t0=t:t1=t,t=.5*(t1-t0)+t0;return t},solve:function(x,epsilon){return this.sampleCurveY(this.solveCurveX(x,epsilon))}};var UnitBezier$1=getDefaultExportFromCjs(unitbezier);function number(from,to,t){return from+t*(to-from)}function color(from,to,t,spaceKey="rgb"){switch(spaceKey){case"rgb":{const[r,g,b,alpha]=array(from.rgb,to.rgb,t);return new Color(r,g,b,alpha,!1)}case"hcl":{const[hue0,chroma0,light0,alphaF]=from.hcl,[hue1,chroma1,light1,alphaT]=to.hcl;let hue,chroma;if(isNaN(hue0)||isNaN(hue1))isNaN(hue0)?isNaN(hue1)?hue=NaN:(hue=hue1,1!==light0&&0!==light0||(chroma=chroma1)):(hue=hue0,1!==light1&&0!==light1||(chroma=chroma0));else{let dh=hue1-hue0;hue1>hue0&&dh>180?dh-=360:hue1<hue0&&hue0-hue1>180&&(dh+=360),hue=hue0+t*dh}const[r,g,b,alpha]=function([h,c,l,alpha]){return h=isNaN(h)?0:h*deg2rad,labToRgb([l,Math.cos(h)*c,Math.sin(h)*c,alpha])}([hue,null!=chroma?chroma:number(chroma0,chroma1,t),number(light0,light1,t),number(alphaF,alphaT,t)]);return new Color(r,g,b,alpha,!1)}case"lab":{const[r,g,b,alpha]=labToRgb(array(from.lab,to.lab,t));return new Color(r,g,b,alpha,!1)}}}function array(from,to,t){return from.map(((d,i)=>number(d,to[i],t)))}function padding(from,to,t){return new Padding(array(from.values,to.values,t))}function variableAnchorOffsetCollection(from,to,t){const fromValues=from.values,toValues=to.values;if(fromValues.length!==toValues.length)throw new RuntimeError(`Cannot interpolate values of different length. from: ${from.toString()}, to: ${to.toString()}`);const output=[];for(let i=0;i<fromValues.length;i+=2){if(fromValues[i]!==toValues[i])throw new RuntimeError(`Cannot interpolate values containing mismatched anchors. from[${i}]: ${fromValues[i]}, to[${i}]: ${toValues[i]}`);output.push(fromValues[i]);const[fx,fy]=fromValues[i+1],[tx,ty]=toValues[i+1];output.push([number(fx,tx,t),number(fy,ty,t)])}return new VariableAnchorOffsetCollection(output)}const interpolate={number:number,color:color,array:array,padding:padding,variableAnchorOffsetCollection:variableAnchorOffsetCollection};class Interpolate{constructor(type,operator,interpolation,input,stops){this.type=type,this.operator=operator,this.interpolation=interpolation,this.input=input,this.labels=[],this.outputs=[];for(const[label,expression]of stops)this.labels.push(label),this.outputs.push(expression)}static interpolationFactor(interpolation,input,lower,upper){let t=0;if("exponential"===interpolation.name)t=exponentialInterpolation(input,interpolation.base,lower,upper);else if("linear"===interpolation.name)t=exponentialInterpolation(input,1,lower,upper);else if("cubic-bezier"===interpolation.name){const c=interpolation.controlPoints;t=new UnitBezier$1(c[0],c[1],c[2],c[3]).solve(exponentialInterpolation(input,1,lower,upper))}return t}static parse(args,context){let[operator,interpolation,input,...rest]=args;if(!Array.isArray(interpolation)||0===interpolation.length)return context.error("Expected an interpolation type expression.",1);if("linear"===interpolation[0])interpolation={name:"linear"};else if("exponential"===interpolation[0]){const base=interpolation[1];if("number"!=typeof base)return context.error("Exponential interpolation requires a numeric base.",1,1);interpolation={name:"exponential",base:base}}else{if("cubic-bezier"!==interpolation[0])return context.error(`Unknown interpolation type ${String(interpolation[0])}`,1,0);{const controlPoints=interpolation.slice(1);if(4!==controlPoints.length||controlPoints.some((t=>"number"!=typeof t||t<0||t>1)))return context.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);interpolation={name:"cubic-bezier",controlPoints:controlPoints}}}if(args.length-1<4)return context.error(`Expected at least 4 arguments, but found only ${args.length-1}.`);if((args.length-1)%2!=0)return context.error("Expected an even number of arguments.");if(input=context.parse(input,2,NumberType),!input)return null;const stops=[];let outputType=null;"interpolate-hcl"===operator||"interpolate-lab"===operator?outputType=ColorType:context.expectedType&&"value"!==context.expectedType.kind&&(outputType=context.expectedType);for(let i=0;i<rest.length;i+=2){const label=rest[i],value=rest[i+1],labelKey=i+3,valueKey=i+4;if("number"!=typeof label)return context.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',labelKey);if(stops.length&&stops[stops.length-1][0]>=label)return context.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',labelKey);const parsed=context.parse(value,valueKey,outputType);if(!parsed)return null;outputType=outputType||parsed.type,stops.push([label,parsed])}return verifyType(outputType,NumberType)||verifyType(outputType,ColorType)||verifyType(outputType,PaddingType)||verifyType(outputType,VariableAnchorOffsetCollectionType)||verifyType(outputType,array$1(NumberType))?new Interpolate(outputType,operator,interpolation,input,stops):context.error(`Type ${toString$1(outputType)} is not interpolatable.`)}evaluate(ctx){const labels=this.labels,outputs=this.outputs;if(1===labels.length)return outputs[0].evaluate(ctx);const value=this.input.evaluate(ctx);if(value<=labels[0])return outputs[0].evaluate(ctx);const stopCount=labels.length;if(value>=labels[stopCount-1])return outputs[stopCount-1].evaluate(ctx);const index=findStopLessThanOrEqualTo(labels,value),lower=labels[index],upper=labels[index+1],t=Interpolate.interpolationFactor(this.interpolation,value,lower,upper),outputLower=outputs[index].evaluate(ctx),outputUpper=outputs[index+1].evaluate(ctx);switch(this.operator){case"interpolate":return interpolate[this.type.kind](outputLower,outputUpper,t);case"interpolate-hcl":return interpolate.color(outputLower,outputUpper,t,"hcl");case"interpolate-lab":return interpolate.color(outputLower,outputUpper,t,"lab")}}eachChild(fn){fn(this.input);for(const expression of this.outputs)fn(expression)}outputDefined(){return this.outputs.every((out=>out.outputDefined()))}}function exponentialInterpolation(input,base,lowerValue,upperValue){const difference=upperValue-lowerValue,progress=input-lowerValue;return 0===difference?0:1===base?progress/difference:(Math.pow(base,progress)-1)/(Math.pow(base,difference)-1)}class Coalesce{constructor(type,args){this.type=type,this.args=args}static parse(args,context){if(args.length<2)return context.error("Expectected at least one argument.");let outputType=null;const expectedType=context.expectedType;expectedType&&"value"!==expectedType.kind&&(outputType=expectedType);const parsedArgs=[];for(const arg of args.slice(1)){const parsed=context.parse(arg,1+parsedArgs.length,outputType,void 0,{typeAnnotation:"omit"});if(!parsed)return null;outputType=outputType||parsed.type,parsedArgs.push(parsed)}if(!outputType)throw new Error("No output type");const needsAnnotation=expectedType&&parsedArgs.some((arg=>checkSubtype(expectedType,arg.type)));return new Coalesce(needsAnnotation?ValueType:outputType,parsedArgs)}evaluate(ctx){let requestedImageName,result=null,argCount=0;for(const arg of this.args)if(argCount++,result=arg.evaluate(ctx),result&&result instanceof ResolvedImage&&!result.available&&(requestedImageName||(requestedImageName=result.name),result=null,argCount===this.args.length&&(result=requestedImageName)),null!==result)break;return result}eachChild(fn){this.args.forEach(fn)}outputDefined(){return this.args.every((arg=>arg.outputDefined()))}}class Let{constructor(bindings,result){this.type=result.type,this.bindings=[].concat(bindings),this.result=result}evaluate(ctx){return this.result.evaluate(ctx)}eachChild(fn){for(const binding of this.bindings)fn(binding[1]);fn(this.result)}static parse(args,context){if(args.length<4)return context.error(`Expected at least 3 arguments, but found ${args.length-1} instead.`);const bindings=[];for(let i=1;i<args.length-1;i+=2){const name=args[i];if("string"!=typeof name)return context.error(`Expected string, but found ${typeof name} instead.`,i);if(/[^a-zA-Z0-9_]/.test(name))return context.error("Variable names must contain only alphanumeric characters or '_'.",i);const value=context.parse(args[i+1],i+1);if(!value)return null;bindings.push([name,value])}const result=context.parse(args[args.length-1],args.length-1,context.expectedType,bindings);return result?new Let(bindings,result):null}outputDefined(){return this.result.outputDefined()}}class At{constructor(type,index,input){this.type=type,this.index=index,this.input=input}static parse(args,context){if(3!==args.length)return context.error(`Expected 2 arguments, but found ${args.length-1} instead.`);const index=context.parse(args[1],1,NumberType),input=context.parse(args[2],2,array$1(context.expectedType||ValueType));if(!index||!input)return null;const t=input.type;return new At(t.itemType,index,input)}evaluate(ctx){const index=this.index.evaluate(ctx),array=this.input.evaluate(ctx);if(index<0)throw new RuntimeError(`Array index out of bounds: ${index} < 0.`);if(index>=array.length)throw new RuntimeError(`Array index out of bounds: ${index} > ${array.length-1}.`);if(index!==Math.floor(index))throw new RuntimeError(`Array index must be an integer, but found ${index} instead.`);return array[index]}eachChild(fn){fn(this.index),fn(this.input)}outputDefined(){return!1}}class In{constructor(needle,haystack){this.type=BooleanType,this.needle=needle,this.haystack=haystack}static parse(args,context){if(3!==args.length)return context.error(`Expected 2 arguments, but found ${args.length-1} instead.`);const needle=context.parse(args[1],1,ValueType),haystack=context.parse(args[2],2,ValueType);return needle&&haystack?isValidType(needle.type,[BooleanType,StringType,NumberType,NullType,ValueType])?new In(needle,haystack):context.error(`Expected first argument to be of type boolean, string, number or null, but found ${toString$1(needle.type)} instead`):null}evaluate(ctx){const needle=this.needle.evaluate(ctx),haystack=this.haystack.evaluate(ctx);if(!haystack)return!1;if(!isValidNativeType(needle,["boolean","string","number","null"]))throw new RuntimeError(`Expected first argument to be of type boolean, string, number or null, but found ${toString$1(typeOf(needle))} instead.`);if(!isValidNativeType(haystack,["string","array"]))throw new RuntimeError(`Expected second argument to be of type array or string, but found ${toString$1(typeOf(haystack))} instead.`);return haystack.indexOf(needle)>=0}eachChild(fn){fn(this.needle),fn(this.haystack)}outputDefined(){return!0}}class IndexOf{constructor(needle,haystack,fromIndex){this.type=NumberType,this.needle=needle,this.haystack=haystack,this.fromIndex=fromIndex}static parse(args,context){if(args.length<=2||args.length>=5)return context.error(`Expected 3 or 4 arguments, but found ${args.length-1} instead.`);const needle=context.parse(args[1],1,ValueType),haystack=context.parse(args[2],2,ValueType);if(!needle||!haystack)return null;if(!isValidType(needle.type,[BooleanType,StringType,NumberType,NullType,ValueType]))return context.error(`Expected first argument to be of type boolean, string, number or null, but found ${toString$1(needle.type)} instead`);if(4===args.length){const fromIndex=context.parse(args[3],3,NumberType);return fromIndex?new IndexOf(needle,haystack,fromIndex):null}return new IndexOf(needle,haystack)}evaluate(ctx){const needle=this.needle.evaluate(ctx),haystack=this.haystack.evaluate(ctx);if(!isValidNativeType(needle,["boolean","string","number","null"]))throw new RuntimeError(`Expected first argument to be of type boolean, string, number or null, but found ${toString$1(typeOf(needle))} instead.`);if(!isValidNativeType(haystack,["string","array"]))throw new RuntimeError(`Expected second argument to be of type array or string, but found ${toString$1(typeOf(haystack))} instead.`);if(this.fromIndex){const fromIndex=this.fromIndex.evaluate(ctx);return haystack.indexOf(needle,fromIndex)}return haystack.indexOf(needle)}eachChild(fn){fn(this.needle),fn(this.haystack),this.fromIndex&&fn(this.fromIndex)}outputDefined(){return!1}}class Match{constructor(inputType,outputType,input,cases,outputs,otherwise){this.inputType=inputType,this.type=outputType,this.input=input,this.cases=cases,this.outputs=outputs,this.otherwise=otherwise}static parse(args,context){if(args.length<5)return context.error(`Expected at least 4 arguments, but found only ${args.length-1}.`);if(args.length%2!=1)return context.error("Expected an even number of arguments.");let inputType,outputType;context.expectedType&&"value"!==context.expectedType.kind&&(outputType=context.expectedType);const cases={},outputs=[];for(let i=2;i<args.length-1;i+=2){let labels=args[i];const value=args[i+1];Array.isArray(labels)||(labels=[labels]);const labelContext=context.concat(i);if(0===labels.length)return labelContext.error("Expected at least one branch label.");for(const label of labels){if("number"!=typeof label&&"string"!=typeof label)return labelContext.error("Branch labels must be numbers or strings.");if("number"==typeof label&&Math.abs(label)>Number.MAX_SAFE_INTEGER)return labelContext.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof label&&Math.floor(label)!==label)return labelContext.error("Numeric branch labels must be integer values.");if(inputType){if(labelContext.checkSubtype(inputType,typeOf(label)))return null}else inputType=typeOf(label);if(void 0!==cases[String(label)])return labelContext.error("Branch labels must be unique.");cases[String(label)]=outputs.length}const result=context.parse(value,i,outputType);if(!result)return null;outputType=outputType||result.type,outputs.push(result)}const input=context.parse(args[1],1,ValueType);if(!input)return null;const otherwise=context.parse(args[args.length-1],args.length-1,outputType);return otherwise?"value"!==input.type.kind&&context.concat(1).checkSubtype(inputType,input.type)?null:new Match(inputType,outputType,input,cases,outputs,otherwise):null}evaluate(ctx){const input=this.input.evaluate(ctx);return(typeOf(input)===this.inputType&&this.outputs[this.cases[input]]||this.otherwise).evaluate(ctx)}eachChild(fn){fn(this.input),this.outputs.forEach(fn),fn(this.otherwise)}outputDefined(){return this.outputs.every((out=>out.outputDefined()))&&this.otherwise.outputDefined()}}class Case{constructor(type,branches,otherwise){this.type=type,this.branches=branches,this.otherwise=otherwise}static parse(args,context){if(args.length<4)return context.error(`Expected at least 3 arguments, but found only ${args.length-1}.`);if(args.length%2!=0)return context.error("Expected an odd number of arguments.");let outputType;context.expectedType&&"value"!==context.expectedType.kind&&(outputType=context.expectedType);const branches=[];for(let i=1;i<args.length-1;i+=2){const test=context.parse(args[i],i,BooleanType);if(!test)return null;const result=context.parse(args[i+1],i+1,outputType);if(!result)return null;branches.push([test,result]),outputType=outputType||result.type}const otherwise=context.parse(args[args.length-1],args.length-1,outputType);if(!otherwise)return null;if(!outputType)throw new Error("Can't infer output type");return new Case(outputType,branches,otherwise)}evaluate(ctx){for(const[test,expression]of this.branches)if(test.evaluate(ctx))return expression.evaluate(ctx);return this.otherwise.evaluate(ctx)}eachChild(fn){for(const[test,expression]of this.branches)fn(test),fn(expression);fn(this.otherwise)}outputDefined(){return this.branches.every((([_,out])=>out.outputDefined()))&&this.otherwise.outputDefined()}}class Slice{constructor(type,input,beginIndex,endIndex){this.type=type,this.input=input,this.beginIndex=beginIndex,this.endIndex=endIndex}static parse(args,context){if(args.length<=2||args.length>=5)return context.error(`Expected 3 or 4 arguments, but found ${args.length-1} instead.`);const input=context.parse(args[1],1,ValueType),beginIndex=context.parse(args[2],2,NumberType);if(!input||!beginIndex)return null;if(!isValidType(input.type,[array$1(ValueType),StringType,ValueType]))return context.error(`Expected first argument to be of type array or string, but found ${toString$1(input.type)} instead`);if(4===args.length){const endIndex=context.parse(args[3],3,NumberType);return endIndex?new Slice(input.type,input,beginIndex,endIndex):null}return new Slice(input.type,input,beginIndex)}evaluate(ctx){const input=this.input.evaluate(ctx),beginIndex=this.beginIndex.evaluate(ctx);if(!isValidNativeType(input,["string","array"]))throw new RuntimeError(`Expected first argument to be of type array or string, but found ${toString$1(typeOf(input))} instead.`);if(this.endIndex){const endIndex=this.endIndex.evaluate(ctx);return input.slice(beginIndex,endIndex)}return input.slice(beginIndex)}eachChild(fn){fn(this.input),fn(this.beginIndex),this.endIndex&&fn(this.endIndex)}outputDefined(){return!1}}function isComparableType(op,type){return"=="===op||"!="===op?"boolean"===type.kind||"string"===type.kind||"number"===type.kind||"null"===type.kind||"value"===type.kind:"string"===type.kind||"number"===type.kind||"value"===type.kind}function eqCollate(ctx,a,b,c){return 0===c.compare(a,b)}function makeComparison(op,compareBasic,compareWithCollator){const isOrderComparison="=="!==op&&"!="!==op;return class Comparison{constructor(lhs,rhs,collator){this.type=BooleanType,this.lhs=lhs,this.rhs=rhs,this.collator=collator,this.hasUntypedArgument="value"===lhs.type.kind||"value"===rhs.type.kind}static parse(args,context){if(3!==args.length&&4!==args.length)return context.error("Expected two or three arguments.");const op=args[0];let lhs=context.parse(args[1],1,ValueType);if(!lhs)return null;if(!isComparableType(op,lhs.type))return context.concat(1).error(`"${op}" comparisons are not supported for type '${toString$1(lhs.type)}'.`);let rhs=context.parse(args[2],2,ValueType);if(!rhs)return null;if(!isComparableType(op,rhs.type))return context.concat(2).error(`"${op}" comparisons are not supported for type '${toString$1(rhs.type)}'.`);if(lhs.type.kind!==rhs.type.kind&&"value"!==lhs.type.kind&&"value"!==rhs.type.kind)return context.error(`Cannot compare types '${toString$1(lhs.type)}' and '${toString$1(rhs.type)}'.`);isOrderComparison&&("value"===lhs.type.kind&&"value"!==rhs.type.kind?lhs=new Assertion(rhs.type,[lhs]):"value"!==lhs.type.kind&&"value"===rhs.type.kind&&(rhs=new Assertion(lhs.type,[rhs])));let collator=null;if(4===args.length){if("string"!==lhs.type.kind&&"string"!==rhs.type.kind&&"value"!==lhs.type.kind&&"value"!==rhs.type.kind)return context.error("Cannot use collator to compare non-string types.");if(collator=context.parse(args[3],3,CollatorType),!collator)return null}return new Comparison(lhs,rhs,collator)}evaluate(ctx){const lhs=this.lhs.evaluate(ctx),rhs=this.rhs.evaluate(ctx);if(isOrderComparison&&this.hasUntypedArgument){const lt=typeOf(lhs),rt=typeOf(rhs);if(lt.kind!==rt.kind||"string"!==lt.kind&&"number"!==lt.kind)throw new RuntimeError(`Expected arguments for "${op}" to be (string, string) or (number, number), but found (${lt.kind}, ${rt.kind}) instead.`)}if(this.collator&&!isOrderComparison&&this.hasUntypedArgument){const lt=typeOf(lhs),rt=typeOf(rhs);if("string"!==lt.kind||"string"!==rt.kind)return compareBasic(ctx,lhs,rhs)}return this.collator?compareWithCollator(ctx,lhs,rhs,this.collator.evaluate(ctx)):compareBasic(ctx,lhs,rhs)}eachChild(fn){fn(this.lhs),fn(this.rhs),this.collator&&fn(this.collator)}outputDefined(){return!0}}}const Equals=makeComparison("==",(function(ctx,a,b){return a===b}),eqCollate),NotEquals=makeComparison("!=",(function(ctx,a,b){return a!==b}),(function(ctx,a,b,c){return!eqCollate(0,a,b,c)})),LessThan=makeComparison("<",(function(ctx,a,b){return a<b}),(function(ctx,a,b,c){return c.compare(a,b)<0})),GreaterThan=makeComparison(">",(function(ctx,a,b){return a>b}),(function(ctx,a,b,c){return c.compare(a,b)>0})),LessThanOrEqual=makeComparison("<=",(function(ctx,a,b){return a<=b}),(function(ctx,a,b,c){return c.compare(a,b)<=0})),GreaterThanOrEqual=makeComparison(">=",(function(ctx,a,b){return a>=b}),(function(ctx,a,b,c){return c.compare(a,b)>=0}));class NumberFormat{constructor(number,locale,currency,minFractionDigits,maxFractionDigits){this.type=StringType,this.number=number,this.locale=locale,this.currency=currency,this.minFractionDigits=minFractionDigits,this.maxFractionDigits=maxFractionDigits}static parse(args,context){if(3!==args.length)return context.error("Expected two arguments.");const number=context.parse(args[1],1,NumberType);if(!number)return null;const options=args[2];if("object"!=typeof options||Array.isArray(options))return context.error("NumberFormat options argument must be an object.");let locale=null;if(options.locale&&(locale=context.parse(options.locale,1,StringType),!locale))return null;let currency=null;if(options.currency&&(currency=context.parse(options.currency,1,StringType),!currency))return null;let minFractionDigits=null;if(options["min-fraction-digits"]&&(minFractionDigits=context.parse(options["min-fraction-digits"],1,NumberType),!minFractionDigits))return null;let maxFractionDigits=null;return options["max-fraction-digits"]&&(maxFractionDigits=context.parse(options["max-fraction-digits"],1,NumberType),!maxFractionDigits)?null:new NumberFormat(number,locale,currency,minFractionDigits,maxFractionDigits)}evaluate(ctx){return new Intl.NumberFormat(this.locale?this.locale.evaluate(ctx):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(ctx):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(ctx):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(ctx):void 0}).format(this.number.evaluate(ctx))}eachChild(fn){fn(this.number),this.locale&&fn(this.locale),this.currency&&fn(this.currency),this.minFractionDigits&&fn(this.minFractionDigits),this.maxFractionDigits&&fn(this.maxFractionDigits)}outputDefined(){return!1}}class FormatExpression{constructor(sections){this.type=FormattedType,this.sections=sections}static parse(args,context){if(args.length<2)return context.error("Expected at least one argument.");const firstArg=args[1];if(!Array.isArray(firstArg)&&"object"==typeof firstArg)return context.error("First argument must be an image or text section.");const sections=[];let nextTokenMayBeObject=!1;for(let i=1;i<=args.length-1;++i){const arg=args[i];if(nextTokenMayBeObject&&"object"==typeof arg&&!Array.isArray(arg)){nextTokenMayBeObject=!1;let scale=null;if(arg["font-scale"]&&(scale=context.parse(arg["font-scale"],1,NumberType),!scale))return null;let font=null;if(arg["text-font"]&&(font=context.parse(arg["text-font"],1,array$1(StringType)),!font))return null;let textColor=null;if(arg["text-color"]&&(textColor=context.parse(arg["text-color"],1,ColorType),!textColor))return null;const lastExpression=sections[sections.length-1];lastExpression.scale=scale,lastExpression.font=font,lastExpression.textColor=textColor}else{const content=context.parse(args[i],1,ValueType);if(!content)return null;const kind=content.type.kind;if("string"!==kind&&"value"!==kind&&"null"!==kind&&"resolvedImage"!==kind)return context.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");nextTokenMayBeObject=!0,sections.push({content:content,scale:null,font:null,textColor:null})}}return new FormatExpression(sections)}evaluate(ctx){return new Formatted(this.sections.map((section=>{const evaluatedContent=section.content.evaluate(ctx);return typeOf(evaluatedContent)===ResolvedImageType?new FormattedSection("",evaluatedContent,null,null,null):new FormattedSection(toString(evaluatedContent),null,section.scale?section.scale.evaluate(ctx):null,section.font?section.font.evaluate(ctx).join(","):null,section.textColor?section.textColor.evaluate(ctx):null)})))}eachChild(fn){for(const section of this.sections)fn(section.content),section.scale&&fn(section.scale),section.font&&fn(section.font),section.textColor&&fn(section.textColor)}outputDefined(){return!1}}class ImageExpression{constructor(input){this.type=ResolvedImageType,this.input=input}static parse(args,context){if(2!==args.length)return context.error("Expected two arguments.");const name=context.parse(args[1],1,StringType);return name?new ImageExpression(name):context.error("No image name provided.")}evaluate(ctx){const evaluatedImageName=this.input.evaluate(ctx),value=ResolvedImage.fromString(evaluatedImageName);return value&&ctx.availableImages&&(value.available=ctx.availableImages.indexOf(evaluatedImageName)>-1),value}eachChild(fn){fn(this.input)}outputDefined(){return!1}}class Length{constructor(input){this.type=NumberType,this.input=input}static parse(args,context){if(2!==args.length)return context.error(`Expected 1 argument, but found ${args.length-1} instead.`);const input=context.parse(args[1],1);return input?"array"!==input.type.kind&&"string"!==input.type.kind&&"value"!==input.type.kind?context.error(`Expected argument of type string or array, but found ${toString$1(input.type)} instead.`):new Length(input):null}evaluate(ctx){const input=this.input.evaluate(ctx);if("string"==typeof input)return input.length;if(Array.isArray(input))return input.length;throw new RuntimeError(`Expected value to be of type string or array, but found ${toString$1(typeOf(input))} instead.`)}eachChild(fn){fn(this.input)}outputDefined(){return!1}}const expressions$1={"==":Equals,"!=":NotEquals,">":GreaterThan,"<":LessThan,">=":GreaterThanOrEqual,"<=":LessThanOrEqual,array:Assertion,at:At,boolean:Assertion,case:Case,coalesce:Coalesce,collator:CollatorExpression,format:FormatExpression,image:ImageExpression,in:In,"index-of":IndexOf,interpolate:Interpolate,"interpolate-hcl":Interpolate,"interpolate-lab":Interpolate,length:Length,let:Let,literal:Literal,match:Match,number:Assertion,"number-format":NumberFormat,object:Assertion,slice:Slice,step:Step,string:Assertion,"to-boolean":Coercion,"to-color":Coercion,"to-number":Coercion,"to-string":Coercion,var:Var,within:Within};function rgba(ctx,[r,g,b,a]){r=r.evaluate(ctx),g=g.evaluate(ctx),b=b.evaluate(ctx);const alpha=a?a.evaluate(ctx):1,error=validateRGBA(r,g,b,alpha);if(error)throw new RuntimeError(error);return new Color(r/255,g/255,b/255,alpha,!1)}function has(key,obj){return key in obj}function get(key,obj){const v=obj[key];return void 0===v?null:v}function varargs(type){return{type:type}}function success(value){return{result:"success",value:value}}function error(value){return{result:"error",value:value}}function supportsPropertyExpression(spec){return"data-driven"===spec["property-type"]||"cross-faded-data-driven"===spec["property-type"]}function supportsZoomExpression(spec){return!!spec.expression&&spec.expression.parameters.indexOf("zoom")>-1}function supportsInterpolation(spec){return!!spec.expression&&spec.expression.interpolated}function getType(val){return val instanceof Number?"number":val instanceof String?"string":val instanceof Boolean?"boolean":Array.isArray(val)?"array":null===val?"null":typeof val}function isFunction$1(value){return"object"==typeof value&&null!==value&&!Array.isArray(value)}function identityFunction(x){return x}function createFunction(parameters,propertySpec){const isColor="color"===propertySpec.type,zoomAndFeatureDependent=parameters.stops&&"object"==typeof parameters.stops[0][0],featureDependent=zoomAndFeatureDependent||void 0!==parameters.property,zoomDependent=zoomAndFeatureDependent||!featureDependent,type=parameters.type||(supportsInterpolation(propertySpec)?"exponential":"interval");if(isColor||"padding"===propertySpec.type){const parseFn=isColor?Color.parse:Padding.parse;(parameters=extendBy({},parameters)).stops&&(parameters.stops=parameters.stops.map((stop=>[stop[0],parseFn(stop[1])]))),parameters.default?parameters.default=parseFn(parameters.default):parameters.default=parseFn(propertySpec.default)}if(parameters.colorSpace&&("rgb"!==(colorSpace=parameters.colorSpace)&&"hcl"!==colorSpace&&"lab"!==colorSpace))throw new Error(`Unknown color space: "${parameters.colorSpace}"`);var colorSpace;let innerFun,hashedStops,categoricalKeyType;if("exponential"===type)innerFun=evaluateExponentialFunction;else if("interval"===type)innerFun=evaluateIntervalFunction;else if("categorical"===type){innerFun=evaluateCategoricalFunction,hashedStops=Object.create(null);for(const stop of parameters.stops)hashedStops[stop[0]]=stop[1];categoricalKeyType=typeof parameters.stops[0][0]}else{if("identity"!==type)throw new Error(`Unknown function type "${type}"`);innerFun=evaluateIdentityFunction}if(zoomAndFeatureDependent){const featureFunctions={},zoomStops=[];for(let s=0;s<parameters.stops.length;s++){const stop=parameters.stops[s],zoom=stop[0].zoom;void 0===featureFunctions[zoom]&&(featureFunctions[zoom]={zoom:zoom,type:parameters.type,property:parameters.property,default:parameters.default,stops:[]},zoomStops.push(zoom)),featureFunctions[zoom].stops.push([stop[0].value,stop[1]])}const featureFunctionStops=[];for(const z of zoomStops)featureFunctionStops.push([featureFunctions[z].zoom,createFunction(featureFunctions[z],propertySpec)]);const interpolationType={name:"linear"};return{kind:"composite",interpolationType:interpolationType,interpolationFactor:Interpolate.interpolationFactor.bind(void 0,interpolationType),zoomStops:featureFunctionStops.map((s=>s[0])),evaluate:({zoom:zoom},properties)=>evaluateExponentialFunction({stops:featureFunctionStops,base:parameters.base},propertySpec,zoom).evaluate(zoom,properties)}}if(zoomDependent){const interpolationType="exponential"===type?{name:"exponential",base:void 0!==parameters.base?parameters.base:1}:null;return{kind:"camera",interpolationType:interpolationType,interpolationFactor:Interpolate.interpolationFactor.bind(void 0,interpolationType),zoomStops:parameters.stops.map((s=>s[0])),evaluate:({zoom:zoom})=>innerFun(parameters,propertySpec,zoom,hashedStops,categoricalKeyType)}}return{kind:"source",evaluate(_,feature){const value=feature&&feature.properties?feature.properties[parameters.property]:void 0;return void 0===value?coalesce$1(parameters.default,propertySpec.default):innerFun(parameters,propertySpec,value,hashedStops,categoricalKeyType)}}}function coalesce$1(a,b,c){return void 0!==a?a:void 0!==b?b:void 0!==c?c:void 0}function evaluateCategoricalFunction(parameters,propertySpec,input,hashedStops,keyType){return coalesce$1(typeof input===keyType?hashedStops[input]:void 0,parameters.default,propertySpec.default)}function evaluateIntervalFunction(parameters,propertySpec,input){if("number"!==getType(input))return coalesce$1(parameters.default,propertySpec.default);const n=parameters.stops.length;if(1===n)return parameters.stops[0][1];if(input<=parameters.stops[0][0])return parameters.stops[0][1];if(input>=parameters.stops[n-1][0])return parameters.stops[n-1][1];const index=findStopLessThanOrEqualTo(parameters.stops.map((stop=>stop[0])),input);return parameters.stops[index][1]}function evaluateExponentialFunction(parameters,propertySpec,input){const base=void 0!==parameters.base?parameters.base:1;if("number"!==getType(input))return coalesce$1(parameters.default,propertySpec.default);const n=parameters.stops.length;if(1===n)return parameters.stops[0][1];if(input<=parameters.stops[0][0])return parameters.stops[0][1];if(input>=parameters.stops[n-1][0])return parameters.stops[n-1][1];const index=findStopLessThanOrEqualTo(parameters.stops.map((stop=>stop[0])),input),t=function(input,base,lowerValue,upperValue){const difference=upperValue-lowerValue,progress=input-lowerValue;return 0===difference?0:1===base?progress/difference:(Math.pow(base,progress)-1)/(Math.pow(base,difference)-1)}(input,base,parameters.stops[index][0],parameters.stops[index+1][0]),outputLower=parameters.stops[index][1],outputUpper=parameters.stops[index+1][1],interp=interpolate[propertySpec.type]||identityFunction;return"function"==typeof outputLower.evaluate?{evaluate(...args){const evaluatedLower=outputLower.evaluate.apply(void 0,args),evaluatedUpper=outputUpper.evaluate.apply(void 0,args);if(void 0!==evaluatedLower&&void 0!==evaluatedUpper)return interp(evaluatedLower,evaluatedUpper,t,parameters.colorSpace)}}:interp(outputLower,outputUpper,t,parameters.colorSpace)}function evaluateIdentityFunction(parameters,propertySpec,input){switch(propertySpec.type){case"color":input=Color.parse(input);break;case"formatted":input=Formatted.fromString(input.toString());break;case"resolvedImage":input=ResolvedImage.fromString(input.toString());break;case"padding":input=Padding.parse(input);break;default:getType(input)===propertySpec.type||"enum"===propertySpec.type&&propertySpec.values[input]||(input=void 0)}return coalesce$1(input,parameters.default,propertySpec.default)}CompoundExpression.register(expressions$1,{error:[{kind:"error"},[StringType],(ctx,[v])=>{throw new RuntimeError(v.evaluate(ctx))}],typeof:[StringType,[ValueType],(ctx,[v])=>toString$1(typeOf(v.evaluate(ctx)))],"to-rgba":[array$1(NumberType,4),[ColorType],(ctx,[v])=>{const[r,g,b,a]=v.evaluate(ctx).rgb;return[255*r,255*g,255*b,a]}],rgb:[ColorType,[NumberType,NumberType,NumberType],rgba],rgba:[ColorType,[NumberType,NumberType,NumberType,NumberType],rgba],has:{type:BooleanType,overloads:[[[StringType],(ctx,[key])=>has(key.evaluate(ctx),ctx.properties())],[[StringType,ObjectType],(ctx,[key,obj])=>has(key.evaluate(ctx),obj.evaluate(ctx))]]},get:{type:ValueType,overloads:[[[StringType],(ctx,[key])=>get(key.evaluate(ctx),ctx.properties())],[[StringType,ObjectType],(ctx,[key,obj])=>get(key.evaluate(ctx),obj.evaluate(ctx))]]},"feature-state":[ValueType,[StringType],(ctx,[key])=>get(key.evaluate(ctx),ctx.featureState||{})],properties:[ObjectType,[],ctx=>ctx.properties()],"geometry-type":[StringType,[],ctx=>ctx.geometryType()],id:[ValueType,[],ctx=>ctx.id()],zoom:[NumberType,[],ctx=>ctx.globals.zoom],"heatmap-density":[NumberType,[],ctx=>ctx.globals.heatmapDensity||0],"line-progress":[NumberType,[],ctx=>ctx.globals.lineProgress||0],accumulated:[ValueType,[],ctx=>void 0===ctx.globals.accumulated?null:ctx.globals.accumulated],"+":[NumberType,varargs(NumberType),(ctx,args)=>{let result=0;for(const arg of args)result+=arg.evaluate(ctx);return result}],"*":[NumberType,varargs(NumberType),(ctx,args)=>{let result=1;for(const arg of args)result*=arg.evaluate(ctx);return result}],"-":{type:NumberType,overloads:[[[NumberType,NumberType],(ctx,[a,b])=>a.evaluate(ctx)-b.evaluate(ctx)],[[NumberType],(ctx,[a])=>-a.evaluate(ctx)]]},"/":[NumberType,[NumberType,NumberType],(ctx,[a,b])=>a.evaluate(ctx)/b.evaluate(ctx)],"%":[NumberType,[NumberType,NumberType],(ctx,[a,b])=>a.evaluate(ctx)%b.evaluate(ctx)],ln2:[NumberType,[],()=>Math.LN2],pi:[NumberType,[],()=>Math.PI],e:[NumberType,[],()=>Math.E],"^":[NumberType,[NumberType,NumberType],(ctx,[b,e])=>Math.pow(b.evaluate(ctx),e.evaluate(ctx))],sqrt:[NumberType,[NumberType],(ctx,[x])=>Math.sqrt(x.evaluate(ctx))],log10:[NumberType,[NumberType],(ctx,[n])=>Math.log(n.evaluate(ctx))/Math.LN10],ln:[NumberType,[NumberType],(ctx,[n])=>Math.log(n.evaluate(ctx))],log2:[NumberType,[NumberType],(ctx,[n])=>Math.log(n.evaluate(ctx))/Math.LN2],sin:[NumberType,[NumberType],(ctx,[n])=>Math.sin(n.evaluate(ctx))],cos:[NumberType,[NumberType],(ctx,[n])=>Math.cos(n.evaluate(ctx))],tan:[NumberType,[NumberType],(ctx,[n])=>Math.tan(n.evaluate(ctx))],asin:[NumberType,[NumberType],(ctx,[n])=>Math.asin(n.evaluate(ctx))],acos:[NumberType,[NumberType],(ctx,[n])=>Math.acos(n.evaluate(ctx))],atan:[NumberType,[NumberType],(ctx,[n])=>Math.atan(n.evaluate(ctx))],min:[NumberType,varargs(NumberType),(ctx,args)=>Math.min(...args.map((arg=>arg.evaluate(ctx))))],max:[NumberType,varargs(NumberType),(ctx,args)=>Math.max(...args.map((arg=>arg.evaluate(ctx))))],abs:[NumberType,[NumberType],(ctx,[n])=>Math.abs(n.evaluate(ctx))],round:[NumberType,[NumberType],(ctx,[n])=>{const v=n.evaluate(ctx);return v<0?-Math.round(-v):Math.round(v)}],floor:[NumberType,[NumberType],(ctx,[n])=>Math.floor(n.evaluate(ctx))],ceil:[NumberType,[NumberType],(ctx,[n])=>Math.ceil(n.evaluate(ctx))],"filter-==":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>ctx.properties()[k.value]===v.value],"filter-id-==":[BooleanType,[ValueType],(ctx,[v])=>ctx.id()===v.value],"filter-type-==":[BooleanType,[StringType],(ctx,[v])=>ctx.geometryType()===v.value],"filter-<":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>{const a=ctx.properties()[k.value],b=v.value;return typeof a==typeof b&&a<b}],"filter-id-<":[BooleanType,[ValueType],(ctx,[v])=>{const a=ctx.id(),b=v.value;return typeof a==typeof b&&a<b}],"filter->":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>{const a=ctx.properties()[k.value],b=v.value;return typeof a==typeof b&&a>b}],"filter-id->":[BooleanType,[ValueType],(ctx,[v])=>{const a=ctx.id(),b=v.value;return typeof a==typeof b&&a>b}],"filter-<=":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>{const a=ctx.properties()[k.value],b=v.value;return typeof a==typeof b&&a<=b}],"filter-id-<=":[BooleanType,[ValueType],(ctx,[v])=>{const a=ctx.id(),b=v.value;return typeof a==typeof b&&a<=b}],"filter->=":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>{const a=ctx.properties()[k.value],b=v.value;return typeof a==typeof b&&a>=b}],"filter-id->=":[BooleanType,[ValueType],(ctx,[v])=>{const a=ctx.id(),b=v.value;return typeof a==typeof b&&a>=b}],"filter-has":[BooleanType,[ValueType],(ctx,[k])=>k.value in ctx.properties()],"filter-has-id":[BooleanType,[],ctx=>null!==ctx.id()&&void 0!==ctx.id()],"filter-type-in":[BooleanType,[array$1(StringType)],(ctx,[v])=>v.value.indexOf(ctx.geometryType())>=0],"filter-id-in":[BooleanType,[array$1(ValueType)],(ctx,[v])=>v.value.indexOf(ctx.id())>=0],"filter-in-small":[BooleanType,[StringType,array$1(ValueType)],(ctx,[k,v])=>v.value.indexOf(ctx.properties()[k.value])>=0],"filter-in-large":[BooleanType,[StringType,array$1(ValueType)],(ctx,[k,v])=>function(v,a,i,j){for(;i<=j;){const m=i+j>>1;if(a[m]===v)return!0;a[m]>v?j=m-1:i=m+1}return!1}(ctx.properties()[k.value],v.value,0,v.value.length-1)],all:{type:BooleanType,overloads:[[[BooleanType,BooleanType],(ctx,[a,b])=>a.evaluate(ctx)&&b.evaluate(ctx)],[varargs(BooleanType),(ctx,args)=>{for(const arg of args)if(!arg.evaluate(ctx))return!1;return!0}]]},any:{type:BooleanType,overloads:[[[BooleanType,BooleanType],(ctx,[a,b])=>a.evaluate(ctx)||b.evaluate(ctx)],[varargs(BooleanType),(ctx,args)=>{for(const arg of args)if(arg.evaluate(ctx))return!0;return!1}]]},"!":[BooleanType,[BooleanType],(ctx,[b])=>!b.evaluate(ctx)],"is-supported-script":[BooleanType,[StringType],(ctx,[s])=>{const isSupportedScript=ctx.globals&&ctx.globals.isSupportedScript;return!isSupportedScript||isSupportedScript(s.evaluate(ctx))}],upcase:[StringType,[StringType],(ctx,[s])=>s.evaluate(ctx).toUpperCase()],downcase:[StringType,[StringType],(ctx,[s])=>s.evaluate(ctx).toLowerCase()],concat:[StringType,varargs(ValueType),(ctx,args)=>args.map((arg=>toString(arg.evaluate(ctx)))).join("")],"resolved-locale":[StringType,[CollatorType],(ctx,[collator])=>collator.evaluate(ctx).resolvedLocale()]});class StyleExpression{constructor(expression,propertySpec){var spec;this.expression=expression,this._warningHistory={},this._evaluator=new EvaluationContext,this._defaultValue=propertySpec?"color"===(spec=propertySpec).type&&isFunction$1(spec.default)?new Color(0,0,0,0):"color"===spec.type?Color.parse(spec.default)||null:"padding"===spec.type?Padding.parse(spec.default)||null:"variableAnchorOffsetCollection"===spec.type?VariableAnchorOffsetCollection.parse(spec.default)||null:void 0===spec.default?null:spec.default:null,this._enumValues=propertySpec&&"enum"===propertySpec.type?propertySpec.values:null}evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection){return this._evaluator.globals=globals,this._evaluator.feature=feature,this._evaluator.featureState=featureState,this._evaluator.canonical=canonical,this._evaluator.availableImages=availableImages||null,this._evaluator.formattedSection=formattedSection,this.expression.evaluate(this._evaluator)}evaluate(globals,feature,featureState,canonical,availableImages,formattedSection){this._evaluator.globals=globals,this._evaluator.feature=feature||null,this._evaluator.featureState=featureState||null,this._evaluator.canonical=canonical,this._evaluator.availableImages=availableImages||null,this._evaluator.formattedSection=formattedSection||null;try{const val=this.expression.evaluate(this._evaluator);if(null==val||"number"==typeof val&&val!=val)return this._defaultValue;if(this._enumValues&&!(val in this._enumValues))throw new RuntimeError(`Expected value to be one of ${Object.keys(this._enumValues).map((v=>JSON.stringify(v))).join(", ")}, but found ${JSON.stringify(val)} instead.`);return val}catch(e){return this._warningHistory[e.message]||(this._warningHistory[e.message]=!0,"undefined"!=typeof console&&console.warn(e.message)),this._defaultValue}}}function isExpression(expression){return Array.isArray(expression)&&expression.length>0&&"string"==typeof expression[0]&&expression[0]in expressions$1}function createExpression(expression,propertySpec){const parser=new ParsingContext(expressions$1,isExpressionConstant,[],propertySpec?function(spec){const types={color:ColorType,string:StringType,number:NumberType,enum:StringType,boolean:BooleanType,formatted:FormattedType,padding:PaddingType,resolvedImage:ResolvedImageType,variableAnchorOffsetCollection:VariableAnchorOffsetCollectionType};if("array"===spec.type)return array$1(types[spec.value]||ValueType,spec.length);return types[spec.type]}(propertySpec):void 0),parsed=parser.parse(expression,void 0,void 0,void 0,propertySpec&&"string"===propertySpec.type?{typeAnnotation:"coerce"}:void 0);return parsed?success(new StyleExpression(parsed,propertySpec)):error(parser.errors)}class ZoomConstantExpression{constructor(kind,expression){this.kind=kind,this._styleExpression=expression,this.isStateDependent="constant"!==kind&&!isStateConstant(expression.expression)}evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection){return this._styleExpression.evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection)}evaluate(globals,feature,featureState,canonical,availableImages,formattedSection){return this._styleExpression.evaluate(globals,feature,featureState,canonical,availableImages,formattedSection)}}class ZoomDependentExpression{constructor(kind,expression,zoomStops,interpolationType){this.kind=kind,this.zoomStops=zoomStops,this._styleExpression=expression,this.isStateDependent="camera"!==kind&&!isStateConstant(expression.expression),this.interpolationType=interpolationType}evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection){return this._styleExpression.evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection)}evaluate(globals,feature,featureState,canonical,availableImages,formattedSection){return this._styleExpression.evaluate(globals,feature,featureState,canonical,availableImages,formattedSection)}interpolationFactor(input,lower,upper){return this.interpolationType?Interpolate.interpolationFactor(this.interpolationType,input,lower,upper):0}}function isZoomExpression(expression){return void 0!==expression._styleExpression}function createPropertyExpression(expressionInput,propertySpec){const expression=createExpression(expressionInput,propertySpec);if("error"===expression.result)return expression;const parsed=expression.value.expression,isFeatureConstantResult=isFeatureConstant(parsed);if(!isFeatureConstantResult&&!supportsPropertyExpression(propertySpec))return error([new ExpressionParsingError("","data expressions not supported")]);const isZoomConstant=isGlobalPropertyConstant(parsed,["zoom"]);if(!isZoomConstant&&!supportsZoomExpression(propertySpec))return error([new ExpressionParsingError("","zoom expressions not supported")]);const zoomCurve=findZoomCurve(parsed);if(!zoomCurve&&!isZoomConstant)return error([new ExpressionParsingError("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(zoomCurve instanceof ExpressionParsingError)return error([zoomCurve]);if(zoomCurve instanceof Interpolate&&!supportsInterpolation(propertySpec))return error([new ExpressionParsingError("",'"interpolate" expressions cannot be used with this property')]);if(!zoomCurve)return success(new ZoomConstantExpression(isFeatureConstantResult?"constant":"source",expression.value));const interpolationType=zoomCurve instanceof Interpolate?zoomCurve.interpolation:void 0;return success(new ZoomDependentExpression(isFeatureConstantResult?"camera":"composite",expression.value,zoomCurve.labels,interpolationType))}class StylePropertyFunction{constructor(parameters,specification){this._parameters=parameters,this._specification=specification,extendBy(this,createFunction(this._parameters,this._specification))}static deserialize(serialized){return new StylePropertyFunction(serialized._parameters,serialized._specification)}static serialize(input){return{_parameters:input._parameters,_specification:input._specification}}}function normalizePropertyExpression(value,specification){if(isFunction$1(value))return new StylePropertyFunction(value,specification);if(isExpression(value)){const expression=createPropertyExpression(value,specification);if("error"===expression.result)throw new Error(expression.value.map((err=>`${err.key}: ${err.message}`)).join(", "));return expression.value}{let constant=value;return"color"===specification.type&&"string"==typeof value?constant=Color.parse(value):"padding"!==specification.type||"number"!=typeof value&&!Array.isArray(value)?"variableAnchorOffsetCollection"===specification.type&&Array.isArray(value)&&(constant=VariableAnchorOffsetCollection.parse(value)):constant=Padding.parse(value),{kind:"constant",evaluate:()=>constant}}}function findZoomCurve(expression){let result=null;if(expression instanceof Let)result=findZoomCurve(expression.result);else if(expression instanceof Coalesce){for(const arg of expression.args)if(result=findZoomCurve(arg),result)break}else(expression instanceof Step||expression instanceof Interpolate)&&expression.input instanceof CompoundExpression&&"zoom"===expression.input.name&&(result=expression);return result instanceof ExpressionParsingError||expression.eachChild((child=>{const childResult=findZoomCurve(child);childResult instanceof ExpressionParsingError?result=childResult:!result&&childResult?result=new ExpressionParsingError("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):result&&childResult&&result!==childResult&&(result=new ExpressionParsingError("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),result}function isExpressionFilter(filter){if(!0===filter||!1===filter)return!0;if(!Array.isArray(filter)||0===filter.length)return!1;switch(filter[0]){case"has":return filter.length>=2&&"$id"!==filter[1]&&"$type"!==filter[1];case"in":return filter.length>=3&&("string"!=typeof filter[1]||Array.isArray(filter[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==filter.length||Array.isArray(filter[1])||Array.isArray(filter[2]);case"any":case"all":for(const f of filter.slice(1))if(!isExpressionFilter(f)&&"boolean"!=typeof f)return!1;return!0;default:return!0}}const filterSpec={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function createFilter(filter){if(null==filter)return{filter:()=>!0,needGeometry:!1};isExpressionFilter(filter)||(filter=convertFilter$1(filter));const compiled=createExpression(filter,filterSpec);if("error"===compiled.result)throw new Error(compiled.value.map((err=>`${err.key}: ${err.message}`)).join(", "));return{filter:(globalProperties,feature,canonical)=>compiled.value.evaluate(globalProperties,feature,{},canonical),needGeometry:geometryNeeded(filter)}}function compare(a,b){return a<b?-1:a>b?1:0}function geometryNeeded(filter){if(!Array.isArray(filter))return!1;if("within"===filter[0])return!0;for(let index=1;index<filter.length;index++)if(geometryNeeded(filter[index]))return!0;return!1}function convertFilter$1(filter){if(!filter)return!0;const op=filter[0];if(filter.length<=1)return"any"!==op;var filters;return"=="===op?convertComparisonOp$1(filter[1],filter[2],"=="):"!="===op?convertNegation(convertComparisonOp$1(filter[1],filter[2],"==")):"<"===op||">"===op||"<="===op||">="===op?convertComparisonOp$1(filter[1],filter[2],op):"any"===op?(filters=filter.slice(1),["any"].concat(filters.map(convertFilter$1))):"all"===op?["all"].concat(filter.slice(1).map(convertFilter$1)):"none"===op?["all"].concat(filter.slice(1).map(convertFilter$1).map(convertNegation)):"in"===op?convertInOp$1(filter[1],filter.slice(2)):"!in"===op?convertNegation(convertInOp$1(filter[1],filter.slice(2))):"has"===op?convertHasOp$1(filter[1]):"!has"===op?convertNegation(convertHasOp$1(filter[1])):"within"!==op||filter}function convertComparisonOp$1(property,value,op){switch(property){case"$type":return[`filter-type-${op}`,value];case"$id":return[`filter-id-${op}`,value];default:return[`filter-${op}`,property,value]}}function convertInOp$1(property,values){if(0===values.length)return!1;switch(property){case"$type":return["filter-type-in",["literal",values]];case"$id":return["filter-id-in",["literal",values]];default:return values.length>200&&!values.some((v=>typeof v!=typeof values[0]))?["filter-in-large",property,["literal",values.sort(compare)]]:["filter-in-small",property,["literal",values]]}}function convertHasOp$1(property){switch(property){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",property]}}function convertNegation(filter){return["!",filter]}function stringify$1(obj){const type=typeof obj;if("number"===type||"boolean"===type||"string"===type||null==obj)return JSON.stringify(obj);if(Array.isArray(obj)){let str="[";for(const val of obj)str+=`${stringify$1(val)},`;return`${str}]`}const keys=Object.keys(obj).sort();let str="{";for(let i=0;i<keys.length;i++)str+=`${JSON.stringify(keys[i])}:${stringify$1(obj[keys[i]])},`;return`${str}}`}function getKey(layer){let key="";for(const k of refProperties)key+=`/${stringify$1(layer[k])}`;return key}function validateConstants(options){const key=options.key,constants=options.value;return constants?[new ValidationError(key,constants,"constants have been deprecated as of v8")]:[]}function unbundle(value){return value instanceof Number||value instanceof String||value instanceof Boolean?value.valueOf():value}function deepUnbundle(value){if(Array.isArray(value))return value.map(deepUnbundle);if(value instanceof Object&&!(value instanceof Number||value instanceof String||value instanceof Boolean)){const unbundledValue={};for(const key in value)unbundledValue[key]=deepUnbundle(value[key]);return unbundledValue}return unbundle(value)}function validateObject(options){const key=options.key,object=options.value,elementSpecs=options.valueSpec||{},elementValidators=options.objectElementValidators||{},style=options.style,styleSpec=options.styleSpec,validateSpec=options.validateSpec;let errors=[];const type=getType(object);if("object"!==type)return[new ValidationError(key,object,`object expected, ${type} found`)];for(const objectKey in object){const elementSpecKey=objectKey.split(".")[0],elementSpec=elementSpecs[elementSpecKey]||elementSpecs["*"];let validateElement;if(elementValidators[elementSpecKey])validateElement=elementValidators[elementSpecKey];else if(elementSpecs[elementSpecKey])validateElement=validateSpec;else if(elementValidators["*"])validateElement=elementValidators["*"];else{if(!elementSpecs["*"]){errors.push(new ValidationError(key,object[objectKey],`unknown property "${objectKey}"`));continue}validateElement=validateSpec}errors=errors.concat(validateElement({key:(key?`${key}.`:key)+objectKey,value:object[objectKey],valueSpec:elementSpec,style:style,styleSpec:styleSpec,object:object,objectKey:objectKey,validateSpec:validateSpec},object))}for(const elementSpecKey in elementSpecs)elementValidators[elementSpecKey]||elementSpecs[elementSpecKey].required&&void 0===elementSpecs[elementSpecKey].default&&void 0===object[elementSpecKey]&&errors.push(new ValidationError(key,object,`missing required property "${elementSpecKey}"`));return errors}function validateArray(options){const array=options.value,arraySpec=options.valueSpec,validateSpec=options.validateSpec,style=options.style,styleSpec=options.styleSpec,key=options.key,validateArrayElement=options.arrayElementValidator||validateSpec;if("array"!==getType(array))return[new ValidationError(key,array,`array expected, ${getType(array)} found`)];if(arraySpec.length&&array.length!==arraySpec.length)return[new ValidationError(key,array,`array length ${arraySpec.length} expected, length ${array.length} found`)];if(arraySpec["min-length"]&&array.length<arraySpec["min-length"])return[new ValidationError(key,array,`array length at least ${arraySpec["min-length"]} expected, length ${array.length} found`)];let arrayElementSpec={type:arraySpec.value,values:arraySpec.values};styleSpec.$version<7&&(arrayElementSpec.function=arraySpec.function),"object"===getType(arraySpec.value)&&(arrayElementSpec=arraySpec.value);let errors=[];for(let i=0;i<array.length;i++)errors=errors.concat(validateArrayElement({array:array,arrayIndex:i,value:array[i],valueSpec:arrayElementSpec,validateSpec:options.validateSpec,style:style,styleSpec:styleSpec,key:`${key}[${i}]`}));return errors}function validateNumber(options){const key=options.key,value=options.value,valueSpec=options.valueSpec;let type=getType(value);return"number"===type&&value!=value&&(type="NaN"),"number"!==type?[new ValidationError(key,value,`number expected, ${type} found`)]:"minimum"in valueSpec&&value<valueSpec.minimum?[new ValidationError(key,value,`${value} is less than the minimum value ${valueSpec.minimum}`)]:"maximum"in valueSpec&&value>valueSpec.maximum?[new ValidationError(key,value,`${value} is greater than the maximum value ${valueSpec.maximum}`)]:[]}function validateFunction(options){const functionValueSpec=options.valueSpec,functionType=unbundle(options.value.type);let stopKeyType,previousStopDomainValue,previousStopDomainZoom,stopDomainValues={};const isZoomFunction="categorical"!==functionType&&void 0===options.value.property,isPropertyFunction=!isZoomFunction,isZoomAndPropertyFunction="array"===getType(options.value.stops)&&"array"===getType(options.value.stops[0])&&"object"===getType(options.value.stops[0][0]),errors=validateObject({key:options.key,value:options.value,valueSpec:options.styleSpec.function,validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec,objectElementValidators:{stops:function(options){if("identity"===functionType)return[new ValidationError(options.key,options.value,'identity function may not have a "stops" property')];let errors=[];const value=options.value;errors=errors.concat(validateArray({key:options.key,value:value,valueSpec:options.valueSpec,validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec,arrayElementValidator:validateFunctionStop})),"array"===getType(value)&&0===value.length&&errors.push(new ValidationError(options.key,value,"array must have at least one stop"));return errors},default:function(options){return options.validateSpec({key:options.key,value:options.value,valueSpec:functionValueSpec,validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec})}}});return"identity"===functionType&&isZoomFunction&&errors.push(new ValidationError(options.key,options.value,'missing required property "property"')),"identity"===functionType||options.value.stops||errors.push(new ValidationError(options.key,options.value,'missing required property "stops"')),"exponential"===functionType&&options.valueSpec.expression&&!supportsInterpolation(options.valueSpec)&&errors.push(new ValidationError(options.key,options.value,"exponential functions not supported")),options.styleSpec.$version>=8&&(isPropertyFunction&&!supportsPropertyExpression(options.valueSpec)?errors.push(new ValidationError(options.key,options.value,"property functions not supported")):isZoomFunction&&!supportsZoomExpression(options.valueSpec)&&errors.push(new ValidationError(options.key,options.value,"zoom functions not supported"))),"categorical"!==functionType&&!isZoomAndPropertyFunction||void 0!==options.value.property||errors.push(new ValidationError(options.key,options.value,'"property" property is required')),errors;function validateFunctionStop(options){let errors=[];const value=options.value,key=options.key;if("array"!==getType(value))return[new ValidationError(key,value,`array expected, ${getType(value)} found`)];if(2!==value.length)return[new ValidationError(key,value,`array length 2 expected, length ${value.length} found`)];if(isZoomAndPropertyFunction){if("object"!==getType(value[0]))return[new ValidationError(key,value,`object expected, ${getType(value[0])} found`)];if(void 0===value[0].zoom)return[new ValidationError(key,value,"object stop key must have zoom")];if(void 0===value[0].value)return[new ValidationError(key,value,"object stop key must have value")];if(previousStopDomainZoom&&previousStopDomainZoom>unbundle(value[0].zoom))return[new ValidationError(key,value[0].zoom,"stop zoom values must appear in ascending order")];unbundle(value[0].zoom)!==previousStopDomainZoom&&(previousStopDomainZoom=unbundle(value[0].zoom),previousStopDomainValue=void 0,stopDomainValues={}),errors=errors.concat(validateObject({key:`${key}[0]`,value:value[0],valueSpec:{zoom:{}},validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec,objectElementValidators:{zoom:validateNumber,value:validateStopDomainValue}}))}else errors=errors.concat(validateStopDomainValue({key:`${key}[0]`,value:value[0],valueSpec:{},validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec},value));return isExpression(deepUnbundle(value[1]))?errors.concat([new ValidationError(`${key}[1]`,value[1],"expressions are not allowed in function stops.")]):errors.concat(options.validateSpec({key:`${key}[1]`,value:value[1],valueSpec:functionValueSpec,validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec}))}function validateStopDomainValue(options,stop){const type=getType(options.value),value=unbundle(options.value),reportValue=null!==options.value?options.value:stop;if(stopKeyType){if(type!==stopKeyType)return[new ValidationError(options.key,reportValue,`${type} stop domain type must match previous stop domain type ${stopKeyType}`)]}else stopKeyType=type;if("number"!==type&&"string"!==type&&"boolean"!==type)return[new ValidationError(options.key,reportValue,"stop domain value must be a number, string, or boolean")];if("number"!==type&&"categorical"!==functionType){let message=`number expected, ${type} found`;return supportsPropertyExpression(functionValueSpec)&&void 0===functionType&&(message+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ValidationError(options.key,reportValue,message)]}return"categorical"!==functionType||"number"!==type||isFinite(value)&&Math.floor(value)===value?"categorical"!==functionType&&"number"===type&&void 0!==previousStopDomainValue&&value<previousStopDomainValue?[new ValidationError(options.key,reportValue,"stop domain values must appear in ascending order")]:(previousStopDomainValue=value,"categorical"===functionType&&value in stopDomainValues?[new ValidationError(options.key,reportValue,"stop domain values must be unique")]:(stopDomainValues[value]=!0,[])):[new ValidationError(options.key,reportValue,`integer expected, found ${value}`)]}}function validateExpression(options){const expression=("property"===options.expressionContext?createPropertyExpression:createExpression)(deepUnbundle(options.value),options.valueSpec);if("error"===expression.result)return expression.value.map((error=>new ValidationError(`${options.key}${error.key}`,options.value,error.message)));const expressionObj=expression.value.expression||expression.value._styleExpression.expression;if("property"===options.expressionContext&&"text-font"===options.propertyKey&&!expressionObj.outputDefined())return[new ValidationError(options.key,options.value,`Invalid data expression for "${options.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===options.expressionContext&&"layout"===options.propertyType&&!isStateConstant(expressionObj))return[new ValidationError(options.key,options.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===options.expressionContext&&!isStateConstant(expressionObj))return[new ValidationError(options.key,options.value,'"feature-state" data expressions are not supported with filters.')];if(options.expressionContext&&0===options.expressionContext.indexOf("cluster")){if(!isGlobalPropertyConstant(expressionObj,["zoom","feature-state"]))return[new ValidationError(options.key,options.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===options.expressionContext&&!isFeatureConstant(expressionObj))return[new ValidationError(options.key,options.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function validateEnum(options){const key=options.key,value=options.value,valueSpec=options.valueSpec,errors=[];return Array.isArray(valueSpec.values)?-1===valueSpec.values.indexOf(unbundle(value))&&errors.push(new ValidationError(key,value,`expected one of [${valueSpec.values.join(", ")}], ${JSON.stringify(value)} found`)):-1===Object.keys(valueSpec.values).indexOf(unbundle(value))&&errors.push(new ValidationError(key,value,`expected one of [${Object.keys(valueSpec.values).join(", ")}], ${JSON.stringify(value)} found`)),errors}function validateFilter$1(options){return isExpressionFilter(deepUnbundle(options.value))?validateExpression(extendBy({},options,{expressionContext:"filter",valueSpec:{value:"boolean"}})):validateNonExpressionFilter(options)}function validateNonExpressionFilter(options){const value=options.value,key=options.key;if("array"!==getType(value))return[new ValidationError(key,value,`array expected, ${getType(value)} found`)];const styleSpec=options.styleSpec;let type,errors=[];if(value.length<1)return[new ValidationError(key,value,"filter array must have at least 1 element")];switch(errors=errors.concat(validateEnum({key:`${key}[0]`,value:value[0],valueSpec:styleSpec.filter_operator,style:options.style,styleSpec:options.styleSpec})),unbundle(value[0])){case"<":case"<=":case">":case">=":value.length>=2&&"$type"===unbundle(value[1])&&errors.push(new ValidationError(key,value,`"$type" cannot be use with operator "${value[0]}"`));case"==":case"!=":3!==value.length&&errors.push(new ValidationError(key,value,`filter array for operator "${value[0]}" must have 3 elements`));case"in":case"!in":value.length>=2&&(type=getType(value[1]),"string"!==type&&errors.push(new ValidationError(`${key}[1]`,value[1],`string expected, ${type} found`)));for(let i=2;i<value.length;i++)type=getType(value[i]),"$type"===unbundle(value[1])?errors=errors.concat(validateEnum({key:`${key}[${i}]`,value:value[i],valueSpec:styleSpec.geometry_type,style:options.style,styleSpec:options.styleSpec})):"string"!==type&&"number"!==type&&"boolean"!==type&&errors.push(new ValidationError(`${key}[${i}]`,value[i],`string, number, or boolean expected, ${type} found`));break;case"any":case"all":case"none":for(let i=1;i<value.length;i++)errors=errors.concat(validateNonExpressionFilter({key:`${key}[${i}]`,value:value[i],style:options.style,styleSpec:options.styleSpec}));break;case"has":case"!has":type=getType(value[1]),2!==value.length?errors.push(new ValidationError(key,value,`filter array for "${value[0]}" operator must have 2 elements`)):"string"!==type&&errors.push(new ValidationError(`${key}[1]`,value[1],`string expected, ${type} found`));break;case"within":type=getType(value[1]),2!==value.length?errors.push(new ValidationError(key,value,`filter array for "${value[0]}" operator must have 2 elements`)):"object"!==type&&errors.push(new ValidationError(`${key}[1]`,value[1],`object expected, ${type} found`))}return errors}function validateProperty(options,propertyType){const key=options.key,validateSpec=options.validateSpec,style=options.style,styleSpec=options.styleSpec,value=options.value,propertyKey=options.objectKey,layerSpec=styleSpec[`${propertyType}_${options.layerType}`];if(!layerSpec)return[];const transitionMatch=propertyKey.match(/^(.*)-transition$/);if("paint"===propertyType&&transitionMatch&&layerSpec[transitionMatch[1]]&&layerSpec[transitionMatch[1]].transition)return validateSpec({key:key,value:value,valueSpec:styleSpec.transition,style:style,styleSpec:styleSpec});const valueSpec=options.valueSpec||layerSpec[propertyKey];if(!valueSpec)return[new ValidationError(key,value,`unknown property "${propertyKey}"`)];let tokenMatch;if("string"===getType(value)&&supportsPropertyExpression(valueSpec)&&!valueSpec.tokens&&(tokenMatch=/^{([^}]+)}$/.exec(value)))return[new ValidationError(key,value,`"${propertyKey}" does not support interpolation syntax\nUse an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(tokenMatch[1])} }\`.`)];const errors=[];return"symbol"===options.layerType&&("text-field"===propertyKey&&style&&!style.glyphs&&errors.push(new ValidationError(key,value,'use of "text-field" requires a style "glyphs" property')),"text-font"===propertyKey&&isFunction$1(deepUnbundle(value))&&"identity"===unbundle(value.type)&&errors.push(new ValidationError(key,value,'"text-font" does not support identity functions'))),errors.concat(validateSpec({key:options.key,value:value,valueSpec:valueSpec,style:style,styleSpec:styleSpec,expressionContext:"property",propertyType:propertyType,propertyKey:propertyKey}))}function validatePaintProperty$1(options){return validateProperty(options,"paint")}function validateLayoutProperty$1(options){return validateProperty(options,"layout")}function validateLayer(options){let errors=[];const layer=options.value,key=options.key,style=options.style,styleSpec=options.styleSpec;layer.type||layer.ref||errors.push(new ValidationError(key,layer,'either "type" or "ref" is required'));let type=unbundle(layer.type);const ref=unbundle(layer.ref);if(layer.id){const layerId=unbundle(layer.id);for(let i=0;i<options.arrayIndex;i++){const otherLayer=style.layers[i];unbundle(otherLayer.id)===layerId&&errors.push(new ValidationError(key,layer.id,`duplicate layer id "${layer.id}", previously used at line ${otherLayer.id.__line__}`))}}if("ref"in layer){let parent;["type","source","source-layer","filter","layout"].forEach((p=>{p in layer&&errors.push(new ValidationError(key,layer[p],`"${p}" is prohibited for ref layers`))})),style.layers.forEach((layer=>{unbundle(layer.id)===ref&&(parent=layer)})),parent?parent.ref?errors.push(new ValidationError(key,layer.ref,"ref cannot reference another ref layer")):type=unbundle(parent.type):errors.push(new ValidationError(key,layer.ref,`ref layer "${ref}" not found`))}else if("background"!==type)if(layer.source){const source=style.sources&&style.sources[layer.source],sourceType=source&&unbundle(source.type);source?"vector"===sourceType&&"raster"===type?errors.push(new ValidationError(key,layer.source,`layer "${layer.id}" requires a raster source`)):"raster-dem"!==sourceType&&"hillshade"===type?errors.push(new ValidationError(key,layer.source,`layer "${layer.id}" requires a raster-dem source`)):"raster"===sourceType&&"raster"!==type?errors.push(new ValidationError(key,layer.source,`layer "${layer.id}" requires a vector source`)):"vector"!==sourceType||layer["source-layer"]?"raster-dem"===sourceType&&"hillshade"!==type?errors.push(new ValidationError(key,layer.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==type||!layer.paint||!layer.paint["line-gradient"]||"geojson"===sourceType&&source.lineMetrics||errors.push(new ValidationError(key,layer,`layer "${layer.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):errors.push(new ValidationError(key,layer,`layer "${layer.id}" must specify a "source-layer"`)):errors.push(new ValidationError(key,layer.source,`source "${layer.source}" not found`))}else errors.push(new ValidationError(key,layer,'missing required property "source"'));return errors=errors.concat(validateObject({key:key,value:layer,valueSpec:styleSpec.layer,style:options.style,styleSpec:options.styleSpec,validateSpec:options.validateSpec,objectElementValidators:{"*":()=>[],type:()=>options.validateSpec({key:`${key}.type`,value:layer.type,valueSpec:styleSpec.layer.type,style:options.style,styleSpec:options.styleSpec,validateSpec:options.validateSpec,object:layer,objectKey:"type"}),filter:validateFilter$1,layout:options=>validateObject({layer:layer,key:options.key,value:options.value,style:options.style,styleSpec:options.styleSpec,validateSpec:options.validateSpec,objectElementValidators:{"*":options=>validateLayoutProperty$1(extendBy({layerType:type},options))}}),paint:options=>validateObject({layer:layer,key:options.key,value:options.value,style:options.style,styleSpec:options.styleSpec,validateSpec:options.validateSpec,objectElementValidators:{"*":options=>validatePaintProperty$1(extendBy({layerType:type},options))}})}})),errors}function validateString(options){const value=options.value,key=options.key,type=getType(value);return"string"!==type?[new ValidationError(key,value,`string expected, ${type} found`)]:[]}const objectElementValidators={promoteId:function({key:key,value:value}){if("string"===getType(value))return validateString({key:key,value:value});{const errors=[];for(const prop in value)errors.push(...validateString({key:`${key}.${prop}`,value:value[prop]}));return errors}}};function validateSource$1(options){const value=options.value,key=options.key,styleSpec=options.styleSpec,style=options.style,validateSpec=options.validateSpec;if(!value.type)return[new ValidationError(key,value,'"type" is required')];const type=unbundle(value.type);let errors;switch(type){case"vector":case"raster":return errors=validateObject({key:key,value:value,valueSpec:styleSpec[`source_${type.replace("-","_")}`],style:options.style,styleSpec:styleSpec,objectElementValidators:objectElementValidators,validateSpec:validateSpec}),errors;case"raster-dem":return errors=function(options){var _a;const sourceName=null!==(_a=options.sourceName)&&void 0!==_a?_a:"",rasterDEM=options.value,styleSpec=options.styleSpec,rasterDEMSpec=styleSpec.source_raster_dem,style=options.style;let errors=[];const rootType=getType(rasterDEM);if(void 0===rasterDEM)return errors;if("object"!==rootType)return errors.push(new ValidationError("source_raster_dem",rasterDEM,`object expected, ${rootType} found`)),errors;const isCustomEncoding="custom"===unbundle(rasterDEM.encoding),customEncodingKeys=["redFactor","greenFactor","blueFactor","baseShift"],encodingName=options.value.encoding?`"${options.value.encoding}"`:"Default";for(const key in rasterDEM)!isCustomEncoding&&customEncodingKeys.includes(key)?errors.push(new ValidationError(key,rasterDEM[key],`In "${sourceName}": "${key}" is only valid when "encoding" is set to "custom". ${encodingName} encoding found`)):rasterDEMSpec[key]?errors=errors.concat(options.validateSpec({key:key,value:rasterDEM[key],valueSpec:rasterDEMSpec[key],validateSpec:options.validateSpec,style:style,styleSpec:styleSpec})):errors.push(new ValidationError(key,rasterDEM[key],`unknown property "${key}"`));return errors}({sourceName:key,value:value,style:options.style,styleSpec:styleSpec,validateSpec:validateSpec}),errors;case"geojson":if(errors=validateObject({key:key,value:value,valueSpec:styleSpec.source_geojson,style:style,styleSpec:styleSpec,validateSpec:validateSpec,objectElementValidators:objectElementValidators}),value.cluster)for(const prop in value.clusterProperties){const[operator,mapExpr]=value.clusterProperties[prop],reduceExpr="string"==typeof operator?[operator,["accumulated"],["get",prop]]:operator;errors.push(...validateExpression({key:`${key}.${prop}.map`,value:mapExpr,validateSpec:validateSpec,expressionContext:"cluster-map"})),errors.push(...validateExpression({key:`${key}.${prop}.reduce`,value:reduceExpr,validateSpec:validateSpec,expressionContext:"cluster-reduce"}))}return errors;case"video":return validateObject({key:key,value:value,valueSpec:styleSpec.source_video,style:style,validateSpec:validateSpec,styleSpec:styleSpec});case"image":return validateObject({key:key,value:value,valueSpec:styleSpec.source_image,style:style,validateSpec:validateSpec,styleSpec:styleSpec});case"canvas":return[new ValidationError(key,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return validateEnum({key:`${key}.type`,value:value.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:style,validateSpec:validateSpec,styleSpec:styleSpec})}}function validateLight$1(options){const light=options.value,styleSpec=options.styleSpec,lightSpec=styleSpec.light,style=options.style;let errors=[];const rootType=getType(light);if(void 0===light)return errors;if("object"!==rootType)return errors=errors.concat([new ValidationError("light",light,`object expected, ${rootType} found`)]),errors;for(const key in light){const transitionMatch=key.match(/^(.*)-transition$/);errors=transitionMatch&&lightSpec[transitionMatch[1]]&&lightSpec[transitionMatch[1]].transition?errors.concat(options.validateSpec({key:key,value:light[key],valueSpec:styleSpec.transition,validateSpec:options.validateSpec,style:style,styleSpec:styleSpec})):lightSpec[key]?errors.concat(options.validateSpec({key:key,value:light[key],valueSpec:lightSpec[key],validateSpec:options.validateSpec,style:style,styleSpec:styleSpec})):errors.concat([new ValidationError(key,light[key],`unknown property "${key}"`)])}return errors}function validateSky(options){const sky=options.value,styleSpec=options.styleSpec,skySpec=styleSpec.sky,style=options.style,rootType=getType(sky);if(void 0===sky)return[];if("object"!==rootType)return[new ValidationError("sky",sky,`object expected, ${rootType} found`)];let errors=[];for(const key in sky)errors=skySpec[key]?errors.concat(validate({key:key,value:sky[key],valueSpec:skySpec[key],style:style,styleSpec:styleSpec})):errors.concat([new ValidationError(key,sky[key],`unknown property "${key}"`)]);return errors}function validateTerrain$1(options){const terrain=options.value,styleSpec=options.styleSpec,terrainSpec=styleSpec.terrain,style=options.style;let errors=[];const rootType=getType(terrain);if(void 0===terrain)return errors;if("object"!==rootType)return errors=errors.concat([new ValidationError("terrain",terrain,`object expected, ${rootType} found`)]),errors;for(const key in terrain)errors=terrainSpec[key]?errors.concat(options.validateSpec({key:key,value:terrain[key],valueSpec:terrainSpec[key],validateSpec:options.validateSpec,style:style,styleSpec:styleSpec})):errors.concat([new ValidationError(key,terrain[key],`unknown property "${key}"`)]);return errors}function validateSprite(options){let errors=[];const sprite=options.value,key=options.key;if(Array.isArray(sprite)){const allSpriteIds=[],allSpriteURLs=[];for(const i in sprite){sprite[i].id&&allSpriteIds.includes(sprite[i].id)&&errors.push(new ValidationError(key,sprite,`all the sprites' ids must be unique, but ${sprite[i].id} is duplicated`)),allSpriteIds.push(sprite[i].id),sprite[i].url&&allSpriteURLs.includes(sprite[i].url)&&errors.push(new ValidationError(key,sprite,`all the sprites' URLs must be unique, but ${sprite[i].url} is duplicated`)),allSpriteURLs.push(sprite[i].url);const pairSpec={id:{type:"string",required:!0},url:{type:"string",required:!0}};errors=errors.concat(validateObject({key:`${key}[${i}]`,value:sprite[i],valueSpec:pairSpec,validateSpec:options.validateSpec}))}return errors}return validateString({key:key,value:sprite})}const VALIDATORS={"*":()=>[],array:validateArray,boolean:function(options){const value=options.value,key=options.key,type=getType(value);return"boolean"!==type?[new ValidationError(key,value,`boolean expected, ${type} found`)]:[]},number:validateNumber,color:function(options){const key=options.key,value=options.value,type=getType(value);return"string"!==type?[new ValidationError(key,value,`color expected, ${type} found`)]:Color.parse(String(value))?[]:[new ValidationError(key,value,`color expected, "${value}" found`)]},constants:validateConstants,enum:validateEnum,filter:validateFilter$1,function:validateFunction,layer:validateLayer,object:validateObject,source:validateSource$1,light:validateLight$1,sky:validateSky,terrain:validateTerrain$1,string:validateString,formatted:function(options){return 0===validateString(options).length?[]:validateExpression(options)},resolvedImage:function(options){return 0===validateString(options).length?[]:validateExpression(options)},padding:function(options){const key=options.key,value=options.value;if("array"===getType(value)){if(value.length<1||value.length>4)return[new ValidationError(key,value,`padding requires 1 to 4 values; ${value.length} values found`)];const arrayElementSpec={type:"number"};let errors=[];for(let i=0;i<value.length;i++)errors=errors.concat(options.validateSpec({key:`${key}[${i}]`,value:value[i],validateSpec:options.validateSpec,valueSpec:arrayElementSpec}));return errors}return validateNumber({key:key,value:value,valueSpec:{}})},variableAnchorOffsetCollection:function(options){const key=options.key,value=options.value,type=getType(value),styleSpec=options.styleSpec;if("array"!==type||value.length<1||value.length%2!=0)return[new ValidationError(key,value,"variableAnchorOffsetCollection requires a non-empty array of even length")];let errors=[];for(let i=0;i<value.length;i+=2)errors=errors.concat(validateEnum({key:`${key}[${i}]`,value:value[i],valueSpec:styleSpec.layout_symbol["text-anchor"]})),errors=errors.concat(validateArray({key:`${key}[${i+1}]`,value:value[i+1],valueSpec:{length:2,value:"number"},validateSpec:options.validateSpec,style:options.style,styleSpec:styleSpec}));return errors},sprite:validateSprite};function validate(options){const value=options.value,valueSpec=options.valueSpec,styleSpec=options.styleSpec;if(options.validateSpec=validate,valueSpec.expression&&isFunction$1(unbundle(value)))return validateFunction(options);if(valueSpec.expression&&isExpression(deepUnbundle(value)))return validateExpression(options);if(valueSpec.type&&VALIDATORS[valueSpec.type])return VALIDATORS[valueSpec.type](options);return validateObject(extendBy({},options,{valueSpec:valueSpec.type?styleSpec[valueSpec.type]:valueSpec}))}function validateGlyphsUrl(options){const value=options.value,key=options.key,errors=validateString(options);return errors.length||(-1===value.indexOf("{fontstack}")&&errors.push(new ValidationError(key,value,'"glyphs" url must include a "{fontstack}" token')),-1===value.indexOf("{range}")&&errors.push(new ValidationError(key,value,'"glyphs" url must include a "{range}" token'))),errors}function validateStyleMin(style,styleSpec=v8Spec){let errors=[];return errors=errors.concat(validate({key:"",value:style,valueSpec:styleSpec.$root,styleSpec:styleSpec,style:style,validateSpec:validate,objectElementValidators:{glyphs:validateGlyphsUrl,"*":()=>[]}})),style.constants&&(errors=errors.concat(validateConstants({key:"constants",value:style.constants,style:style,styleSpec:styleSpec,validateSpec:validate}))),sortErrors(errors)}function injectValidateSpec(validator){return function(options){return validator({...options,validateSpec:validate})}}function sortErrors(errors){return[].concat(errors).sort(((a,b)=>a.line-b.line))}function wrapCleanErrors(inner){return function(...args){return sortErrors(inner.apply(this,args))}}validateStyleMin.source=wrapCleanErrors(injectValidateSpec(validateSource$1)),validateStyleMin.sprite=wrapCleanErrors(injectValidateSpec(validateSprite)),validateStyleMin.glyphs=wrapCleanErrors(injectValidateSpec(validateGlyphsUrl)),validateStyleMin.light=wrapCleanErrors(injectValidateSpec(validateLight$1)),validateStyleMin.sky=wrapCleanErrors(injectValidateSpec(validateSky)),validateStyleMin.terrain=wrapCleanErrors(injectValidateSpec(validateTerrain$1)),validateStyleMin.layer=wrapCleanErrors(injectValidateSpec(validateLayer)),validateStyleMin.filter=wrapCleanErrors(injectValidateSpec(validateFilter$1)),validateStyleMin.paintProperty=wrapCleanErrors(injectValidateSpec(validatePaintProperty$1)),validateStyleMin.layoutProperty=wrapCleanErrors(injectValidateSpec(validateLayoutProperty$1));const validateStyle=validateStyleMin,validateLight=(validateStyle.source,validateStyle.light),validatePaintProperty=(validateStyle.terrain,validateStyle.filter,validateStyle.paintProperty),validateLayoutProperty=validateStyle.layoutProperty;function emitValidationErrors(emitter,errors){let hasErrors=!1;if(errors&&errors.length)for(const error of errors)emitter.fire(new ErrorEvent(new Error(error.message))),hasErrors=!0;return hasErrors}class TransferableGridIndex{constructor(extent,n,padding){const cells=this.cells=[];if(extent instanceof ArrayBuffer){this.arrayBuffer=extent;const array=new Int32Array(this.arrayBuffer);extent=array[0],n=array[1],padding=array[2],this.d=n+2*padding;for(let k=0;k<this.d*this.d;k++){const start=array[3+k],end=array[3+k+1];cells.push(start===end?null:array.subarray(start,end))}const keysOffset=array[3+cells.length],bboxesOffset=array[3+cells.length+1];this.keys=array.subarray(keysOffset,bboxesOffset),this.bboxes=array.subarray(bboxesOffset),this.insert=this._insertReadonly}else{this.d=n+2*padding;for(let i=0;i<this.d*this.d;i++)cells.push([]);this.keys=[],this.bboxes=[]}this.n=n,this.extent=extent,this.padding=padding,this.scale=n/extent,this.uid=0;const p=padding/n*extent;this.min=-p,this.max=extent+p}insert(key,x1,y1,x2,y2){this._forEachCell(x1,y1,x2,y2,this._insertCell,this.uid++,void 0,void 0),this.keys.push(key),this.bboxes.push(x1),this.bboxes.push(y1),this.bboxes.push(x2),this.bboxes.push(y2)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(x1,y1,x2,y2,cellIndex,uid){this.cells[cellIndex].push(uid)}query(x1,y1,x2,y2,intersectionTest){const min=this.min,max=this.max;if(x1<=min&&y1<=min&&max<=x2&&max<=y2&&!intersectionTest)return Array.prototype.slice.call(this.keys);{const result=[],seenUids={};return this._forEachCell(x1,y1,x2,y2,this._queryCell,result,seenUids,intersectionTest),result}}_queryCell(x1,y1,x2,y2,cellIndex,result,seenUids,intersectionTest){const cell=this.cells[cellIndex];if(null!==cell){const keys=this.keys,bboxes=this.bboxes;for(let u=0;u<cell.length;u++){const uid=cell[u];if(void 0===seenUids[uid]){const offset=4*uid;(intersectionTest?intersectionTest(bboxes[offset+0],bboxes[offset+1],bboxes[offset+2],bboxes[offset+3]):x1<=bboxes[offset+2]&&y1<=bboxes[offset+3]&&x2>=bboxes[offset+0]&&y2>=bboxes[offset+1])?(seenUids[uid]=!0,result.push(keys[uid])):seenUids[uid]=!1}}}}_forEachCell(x1,y1,x2,y2,fn,arg1,arg2,intersectionTest){const cx1=this._convertToCellCoord(x1),cy1=this._convertToCellCoord(y1),cx2=this._convertToCellCoord(x2),cy2=this._convertToCellCoord(y2);for(let x=cx1;x<=cx2;x++)for(let y=cy1;y<=cy2;y++){const cellIndex=this.d*y+x;if((!intersectionTest||intersectionTest(this._convertFromCellCoord(x),this._convertFromCellCoord(y),this._convertFromCellCoord(x+1),this._convertFromCellCoord(y+1)))&&fn.call(this,x1,y1,x2,y2,cellIndex,arg1,arg2,intersectionTest))return}}_convertFromCellCoord(x){return(x-this.padding)/this.scale}_convertToCellCoord(x){return Math.max(0,Math.min(this.d-1,Math.floor(x*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const cells=this.cells,metadataLength=3+this.cells.length+1+1;let totalCellLength=0;for(let i=0;i<this.cells.length;i++)totalCellLength+=this.cells[i].length;const array=new Int32Array(metadataLength+totalCellLength+this.keys.length+this.bboxes.length);array[0]=this.extent,array[1]=this.n,array[2]=this.padding;let offset=metadataLength;for(let k=0;k<cells.length;k++){const cell=cells[k];array[3+k]=offset,array.set(cell,offset),offset+=cell.length}return array[3+cells.length]=offset,array.set(this.keys,offset),offset+=this.keys.length,array[3+cells.length+1]=offset,array.set(this.bboxes,offset),offset+=this.bboxes.length,array.buffer}static serialize(grid,transferables){const buffer=grid.toArrayBuffer();return transferables&&transferables.push(buffer),{buffer:buffer}}static deserialize(serialized){return new TransferableGridIndex(serialized.buffer)}}const registry={};function register(name,klass,options={}){if(registry[name])throw new Error(`${name} is already registered.`);Object.defineProperty(klass,"_classRegistryKey",{value:name,writeable:!1}),registry[name]={klass:klass,omit:options.omit||[],shallow:options.shallow||[]}}register("Object",Object),register("TransferableGridIndex",TransferableGridIndex),register("Color",Color),register("Error",Error),register("AJAXError",AJAXError),register("ResolvedImage",ResolvedImage),register("StylePropertyFunction",StylePropertyFunction),register("StyleExpression",StyleExpression,{omit:["_evaluator"]}),register("ZoomDependentExpression",ZoomDependentExpression),register("ZoomConstantExpression",ZoomConstantExpression),register("CompoundExpression",CompoundExpression,{omit:["_evaluate"]});for(const name in expressions$1)expressions$1[name]._classRegistryKey||register(`Expression_${name}`,expressions$1[name]);function isArrayBuffer(value){return value&&"undefined"!=typeof ArrayBuffer&&(value instanceof ArrayBuffer||value.constructor&&"ArrayBuffer"===value.constructor.name)}function serialize(input,transferables){if(null==input||"boolean"==typeof input||"number"==typeof input||"string"==typeof input||input instanceof Boolean||input instanceof Number||input instanceof String||input instanceof Date||input instanceof RegExp||input instanceof Blob||input instanceof Error)return input;if(isArrayBuffer(input))return transferables&&transferables.push(input),input;if(isImageBitmap(input))return transferables&&transferables.push(input),input;if(ArrayBuffer.isView(input)){const view=input;return transferables&&transferables.push(view.buffer),view}if(input instanceof ImageData)return transferables&&transferables.push(input.data.buffer),input;if(Array.isArray(input)){const serialized=[];for(const item of input)serialized.push(serialize(item,transferables));return serialized}if("object"==typeof input){const klass=input.constructor,name=klass._classRegistryKey;if(!name)throw new Error(`can't serialize object of unregistered class ${klass.name}`);if(!registry[name])throw new Error(`${name} is not registered.`);const properties=klass.serialize?klass.serialize(input,transferables):{};if(klass.serialize){if(transferables&&properties===transferables[transferables.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const key in input){if(!input.hasOwnProperty(key))continue;if(registry[name].omit.indexOf(key)>=0)continue;const property=input[key];properties[key]=registry[name].shallow.indexOf(key)>=0?property:serialize(property,transferables)}input instanceof Error&&(properties.message=input.message)}if(properties.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==name&&(properties.$name=name),properties}throw new Error("can't serialize object of type "+typeof input)}function deserialize(input){if(null==input||"boolean"==typeof input||"number"==typeof input||"string"==typeof input||input instanceof Boolean||input instanceof Number||input instanceof String||input instanceof Date||input instanceof RegExp||input instanceof Blob||input instanceof Error||isArrayBuffer(input)||isImageBitmap(input)||ArrayBuffer.isView(input)||input instanceof ImageData)return input;if(Array.isArray(input))return input.map(deserialize);if("object"==typeof input){const name=input.$name||"Object";if(!registry[name])throw new Error(`can't deserialize unregistered class ${name}`);const{klass:klass}=registry[name];if(!klass)throw new Error(`can't deserialize unregistered class ${name}`);if(klass.deserialize)return klass.deserialize(input);const result=Object.create(klass.prototype);for(const key of Object.keys(input)){if("$name"===key)continue;const value=input[key];result[key]=registry[name].shallow.indexOf(key)>=0?value:deserialize(value)}return result}throw new Error("can't deserialize object of type "+typeof input)}class ZoomHistory{constructor(){this.first=!0}update(z,now){const floorZ=Math.floor(z);return this.first?(this.first=!1,this.lastIntegerZoom=floorZ,this.lastIntegerZoomTime=0,this.lastZoom=z,this.lastFloorZoom=floorZ,!0):(this.lastFloorZoom>floorZ?(this.lastIntegerZoom=floorZ+1,this.lastIntegerZoomTime=now):this.lastFloorZoom<floorZ&&(this.lastIntegerZoom=floorZ,this.lastIntegerZoomTime=now),z!==this.lastZoom&&(this.lastZoom=z,this.lastFloorZoom=floorZ,!0))}}const unicodeBlockLookup={"Latin-1 Supplement":char=>char>=128&&char<=255,Arabic:char=>char>=1536&&char<=1791,"Arabic Supplement":char=>char>=1872&&char<=1919,"Arabic Extended-A":char=>char>=2208&&char<=2303,"Hangul Jamo":char=>char>=4352&&char<=4607,"Unified Canadian Aboriginal Syllabics":char=>char>=5120&&char<=5759,Khmer:char=>char>=6016&&char<=6143,"Unified Canadian Aboriginal Syllabics Extended":char=>char>=6320&&char<=6399,"General Punctuation":char=>char>=8192&&char<=8303,"Letterlike Symbols":char=>char>=8448&&char<=8527,"Number Forms":char=>char>=8528&&char<=8591,"Miscellaneous Technical":char=>char>=8960&&char<=9215,"Control Pictures":char=>char>=9216&&char<=9279,"Optical Character Recognition":char=>char>=9280&&char<=9311,"Enclosed Alphanumerics":char=>char>=9312&&char<=9471,"Geometric Shapes":char=>char>=9632&&char<=9727,"Miscellaneous Symbols":char=>char>=9728&&char<=9983,"Miscellaneous Symbols and Arrows":char=>char>=11008&&char<=11263,"CJK Radicals Supplement":char=>char>=11904&&char<=12031,"Kangxi Radicals":char=>char>=12032&&char<=12255,"Ideographic Description Characters":char=>char>=12272&&char<=12287,"CJK Symbols and Punctuation":char=>char>=12288&&char<=12351,Hiragana:char=>char>=12352&&char<=12447,Katakana:char=>char>=12448&&char<=12543,Bopomofo:char=>char>=12544&&char<=12591,"Hangul Compatibility Jamo":char=>char>=12592&&char<=12687,Kanbun:char=>char>=12688&&char<=12703,"Bopomofo Extended":char=>char>=12704&&char<=12735,"CJK Strokes":char=>char>=12736&&char<=12783,"Katakana Phonetic Extensions":char=>char>=12784&&char<=12799,"Enclosed CJK Letters and Months":char=>char>=12800&&char<=13055,"CJK Compatibility":char=>char>=13056&&char<=13311,"CJK Unified Ideographs Extension A":char=>char>=13312&&char<=19903,"Yijing Hexagram Symbols":char=>char>=19904&&char<=19967,"CJK Unified Ideographs":char=>char>=19968&&char<=40959,"Yi Syllables":char=>char>=40960&&char<=42127,"Yi Radicals":char=>char>=42128&&char<=42191,"Hangul Jamo Extended-A":char=>char>=43360&&char<=43391,"Hangul Syllables":char=>char>=44032&&char<=55215,"Hangul Jamo Extended-B":char=>char>=55216&&char<=55295,"Private Use Area":char=>char>=57344&&char<=63743,"CJK Compatibility Ideographs":char=>char>=63744&&char<=64255,"Arabic Presentation Forms-A":char=>char>=64336&&char<=65023,"Vertical Forms":char=>char>=65040&&char<=65055,"CJK Compatibility Forms":char=>char>=65072&&char<=65103,"Small Form Variants":char=>char>=65104&&char<=65135,"Arabic Presentation Forms-B":char=>char>=65136&&char<=65279,"Halfwidth and Fullwidth Forms":char=>char>=65280&&char<=65519};function allowsVerticalWritingMode(chars){for(const char of chars)if(charHasUprightVerticalOrientation(char.charCodeAt(0)))return!0;return!1}function allowsLetterSpacing(chars){for(const char of chars)if(!charAllowsLetterSpacing(char.charCodeAt(0)))return!1;return!0}function charAllowsLetterSpacing(char){return!unicodeBlockLookup.Arabic(char)&&(!unicodeBlockLookup["Arabic Supplement"](char)&&(!unicodeBlockLookup["Arabic Extended-A"](char)&&(!unicodeBlockLookup["Arabic Presentation Forms-A"](char)&&!unicodeBlockLookup["Arabic Presentation Forms-B"](char))))}function charAllowsIdeographicBreaking(char){return!(char<11904)&&(!!unicodeBlockLookup["Bopomofo Extended"](char)||(!!unicodeBlockLookup.Bopomofo(char)||(!!unicodeBlockLookup["CJK Compatibility Forms"](char)||(!!unicodeBlockLookup["CJK Compatibility Ideographs"](char)||(!!unicodeBlockLookup["CJK Compatibility"](char)||(!!unicodeBlockLookup["CJK Radicals Supplement"](char)||(!!unicodeBlockLookup["CJK Strokes"](char)||(!!unicodeBlockLookup["CJK Symbols and Punctuation"](char)||(!!unicodeBlockLookup["CJK Unified Ideographs Extension A"](char)||(!!unicodeBlockLookup["CJK Unified Ideographs"](char)||(!!unicodeBlockLookup["Enclosed CJK Letters and Months"](char)||(!!unicodeBlockLookup["Halfwidth and Fullwidth Forms"](char)||(!!unicodeBlockLookup.Hiragana(char)||(!!unicodeBlockLookup["Ideographic Description Characters"](char)||(!!unicodeBlockLookup["Kangxi Radicals"](char)||(!!unicodeBlockLookup["Katakana Phonetic Extensions"](char)||(!!unicodeBlockLookup.Katakana(char)||(!!unicodeBlockLookup["Vertical Forms"](char)||(!!unicodeBlockLookup["Yi Radicals"](char)||!!unicodeBlockLookup["Yi Syllables"](char))))))))))))))))))))}function charHasUprightVerticalOrientation(char){return 746===char||747===char||!(char<4352)&&(!!unicodeBlockLookup["Bopomofo Extended"](char)||(!!unicodeBlockLookup.Bopomofo(char)||(!(!unicodeBlockLookup["CJK Compatibility Forms"](char)||char>=65097&&char<=65103)||(!!unicodeBlockLookup["CJK Compatibility Ideographs"](char)||(!!unicodeBlockLookup["CJK Compatibility"](char)||(!!unicodeBlockLookup["CJK Radicals Supplement"](char)||(!!unicodeBlockLookup["CJK Strokes"](char)||(!(!unicodeBlockLookup["CJK Symbols and Punctuation"](char)||char>=12296&&char<=12305||char>=12308&&char<=12319||12336===char)||(!!unicodeBlockLookup["CJK Unified Ideographs Extension A"](char)||(!!unicodeBlockLookup["CJK Unified Ideographs"](char)||(!!unicodeBlockLookup["Enclosed CJK Letters and Months"](char)||(!!unicodeBlockLookup["Hangul Compatibility Jamo"](char)||(!!unicodeBlockLookup["Hangul Jamo Extended-A"](char)||(!!unicodeBlockLookup["Hangul Jamo Extended-B"](char)||(!!unicodeBlockLookup["Hangul Jamo"](char)||(!!unicodeBlockLookup["Hangul Syllables"](char)||(!!unicodeBlockLookup.Hiragana(char)||(!!unicodeBlockLookup["Ideographic Description Characters"](char)||(!!unicodeBlockLookup.Kanbun(char)||(!!unicodeBlockLookup["Kangxi Radicals"](char)||(!!unicodeBlockLookup["Katakana Phonetic Extensions"](char)||(!(!unicodeBlockLookup.Katakana(char)||12540===char)||(!(!unicodeBlockLookup["Halfwidth and Fullwidth Forms"](char)||65288===char||65289===char||65293===char||char>=65306&&char<=65310||65339===char||65341===char||65343===char||char>=65371&&char<=65503||65507===char||char>=65512&&char<=65519)||(!(!unicodeBlockLookup["Small Form Variants"](char)||char>=65112&&char<=65118||char>=65123&&char<=65126)||(!!unicodeBlockLookup["Unified Canadian Aboriginal Syllabics"](char)||(!!unicodeBlockLookup["Unified Canadian Aboriginal Syllabics Extended"](char)||(!!unicodeBlockLookup["Vertical Forms"](char)||(!!unicodeBlockLookup["Yijing Hexagram Symbols"](char)||(!!unicodeBlockLookup["Yi Syllables"](char)||!!unicodeBlockLookup["Yi Radicals"](char))))))))))))))))))))))))))))))}function charHasRotatedVerticalOrientation(char){return!(charHasUprightVerticalOrientation(char)||function(char){return!!(unicodeBlockLookup["Latin-1 Supplement"](char)&&(167===char||169===char||174===char||177===char||188===char||189===char||190===char||215===char||247===char)||unicodeBlockLookup["General Punctuation"](char)&&(8214===char||8224===char||8225===char||8240===char||8241===char||8251===char||8252===char||8258===char||8263===char||8264===char||8265===char||8273===char)||unicodeBlockLookup["Letterlike Symbols"](char)||unicodeBlockLookup["Number Forms"](char)||unicodeBlockLookup["Miscellaneous Technical"](char)&&(char>=8960&&char<=8967||char>=8972&&char<=8991||char>=8996&&char<=9e3||9003===char||char>=9085&&char<=9114||char>=9150&&char<=9165||9167===char||char>=9169&&char<=9179||char>=9186&&char<=9215)||unicodeBlockLookup["Control Pictures"](char)&&9251!==char||unicodeBlockLookup["Optical Character Recognition"](char)||unicodeBlockLookup["Enclosed Alphanumerics"](char)||unicodeBlockLookup["Geometric Shapes"](char)||unicodeBlockLookup["Miscellaneous Symbols"](char)&&!(char>=9754&&char<=9759)||unicodeBlockLookup["Miscellaneous Symbols and Arrows"](char)&&(char>=11026&&char<=11055||char>=11088&&char<=11097||char>=11192&&char<=11243)||unicodeBlockLookup["CJK Symbols and Punctuation"](char)||unicodeBlockLookup.Katakana(char)||unicodeBlockLookup["Private Use Area"](char)||unicodeBlockLookup["CJK Compatibility Forms"](char)||unicodeBlockLookup["Small Form Variants"](char)||unicodeBlockLookup["Halfwidth and Fullwidth Forms"](char)||8734===char||8756===char||8757===char||char>=9984&&char<=10087||char>=10102&&char<=10131||65532===char||65533===char)}(char))}function charInComplexShapingScript(char){return unicodeBlockLookup.Arabic(char)||unicodeBlockLookup["Arabic Supplement"](char)||unicodeBlockLookup["Arabic Extended-A"](char)||unicodeBlockLookup["Arabic Presentation Forms-A"](char)||unicodeBlockLookup["Arabic Presentation Forms-B"](char)}function charInRTLScript(char){return char>=1424&&char<=2303||unicodeBlockLookup["Arabic Presentation Forms-A"](char)||unicodeBlockLookup["Arabic Presentation Forms-B"](char)}function charInSupportedScript(char,canRenderRTL){return!(!canRenderRTL&&charInRTLScript(char))&&!(char>=2304&&char<=3583||char>=3840&&char<=4255||unicodeBlockLookup.Khmer(char))}function stringContainsRTLText(chars){for(const char of chars)if(charInRTLScript(char.charCodeAt(0)))return!0;return!1}const rtlWorkerPlugin=new class{constructor(){this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null}setState(state){this.pluginStatus=state.pluginStatus,this.pluginURL=state.pluginURL}setMethods(rtlTextPlugin){this.applyArabicShaping=rtlTextPlugin.applyArabicShaping,this.processBidirectionalText=rtlTextPlugin.processBidirectionalText,this.processStyledBidirectionalText=rtlTextPlugin.processStyledBidirectionalText}isParsed(){return null!=this.applyArabicShaping&&null!=this.processBidirectionalText&&null!=this.processStyledBidirectionalText}getPluginURL(){return this.pluginURL}getRTLTextPluginStatus(){return this.pluginStatus}};class EvaluationParameters{constructor(zoom,options){this.zoom=zoom,options?(this.now=options.now,this.fadeDuration=options.fadeDuration,this.zoomHistory=options.zoomHistory,this.transition=options.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new ZoomHistory,this.transition={})}isSupportedScript(str){return function(chars,canRenderRTL){for(const char of chars)if(!charInSupportedScript(char.charCodeAt(0),canRenderRTL))return!1;return!0}(str,"loaded"===rtlWorkerPlugin.getRTLTextPluginStatus())}crossFadingFactor(){return 0===this.fadeDuration?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const z=this.zoom,fraction=z-Math.floor(z),t=this.crossFadingFactor();return z>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:fraction+(1-fraction)*t}:{fromScale:.5,toScale:1,t:1-(1-t)*fraction}}}class PropertyValue{constructor(property,value){this.property=property,this.value=value,this.expression=normalizePropertyExpression(void 0===value?property.specification.default:value,property.specification)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(parameters,canonical,availableImages){return this.property.possiblyEvaluate(this,parameters,canonical,availableImages)}}class TransitionablePropertyValue{constructor(property){this.property=property,this.value=new PropertyValue(property,void 0)}transitioned(parameters,prior){return new TransitioningPropertyValue(this.property,this.value,prior,extend({},parameters.transition,this.transition),parameters.now)}untransitioned(){return new TransitioningPropertyValue(this.property,this.value,null,{},0)}}class Transitionable{constructor(properties){this._properties=properties,this._values=Object.create(properties.defaultTransitionablePropertyValues)}getValue(name){return clone$9(this._values[name].value.value)}setValue(name,value){Object.prototype.hasOwnProperty.call(this._values,name)||(this._values[name]=new TransitionablePropertyValue(this._values[name].property)),this._values[name].value=new PropertyValue(this._values[name].property,null===value?void 0:clone$9(value))}getTransition(name){return clone$9(this._values[name].transition)}setTransition(name,value){Object.prototype.hasOwnProperty.call(this._values,name)||(this._values[name]=new TransitionablePropertyValue(this._values[name].property)),this._values[name].transition=clone$9(value)||void 0}serialize(){const result={};for(const property of Object.keys(this._values)){const value=this.getValue(property);void 0!==value&&(result[property]=value);const transition=this.getTransition(property);void 0!==transition&&(result[`${property}-transition`]=transition)}return result}transitioned(parameters,prior){const result=new Transitioning(this._properties);for(const property of Object.keys(this._values))result._values[property]=this._values[property].transitioned(parameters,prior._values[property]);return result}untransitioned(){const result=new Transitioning(this._properties);for(const property of Object.keys(this._values))result._values[property]=this._values[property].untransitioned();return result}}class TransitioningPropertyValue{constructor(property,value,prior,transition,now){this.property=property,this.value=value,this.begin=now+transition.delay||0,this.end=this.begin+transition.duration||0,property.specification.transition&&(transition.delay||transition.duration)&&(this.prior=prior)}possiblyEvaluate(parameters,canonical,availableImages){const now=parameters.now||0,finalValue=this.value.possiblyEvaluate(parameters,canonical,availableImages),prior=this.prior;if(prior){if(now>this.end)return this.prior=null,finalValue;if(this.value.isDataDriven())return this.prior=null,finalValue;if(now<this.begin)return prior.possiblyEvaluate(parameters,canonical,availableImages);{const t=(now-this.begin)/(this.end-this.begin);return this.property.interpolate(prior.possiblyEvaluate(parameters,canonical,availableImages),finalValue,function(t){if(t<=0)return 0;if(t>=1)return 1;const t2=t*t,t3=t2*t;return 4*(t<.5?t3:3*(t-t2)+t3-.75)}(t))}}return finalValue}}class Transitioning{constructor(properties){this._properties=properties,this._values=Object.create(properties.defaultTransitioningPropertyValues)}possiblyEvaluate(parameters,canonical,availableImages){const result=new PossiblyEvaluated(this._properties);for(const property of Object.keys(this._values))result._values[property]=this._values[property].possiblyEvaluate(parameters,canonical,availableImages);return result}hasTransition(){for(const property of Object.keys(this._values))if(this._values[property].prior)return!0;return!1}}class Layout{constructor(properties){this._properties=properties,this._values=Object.create(properties.defaultPropertyValues)}hasValue(name){return void 0!==this._values[name].value}getValue(name){return clone$9(this._values[name].value)}setValue(name,value){this._values[name]=new PropertyValue(this._values[name].property,null===value?void 0:clone$9(value))}serialize(){const result={};for(const property of Object.keys(this._values)){const value=this.getValue(property);void 0!==value&&(result[property]=value)}return result}possiblyEvaluate(parameters,canonical,availableImages){const result=new PossiblyEvaluated(this._properties);for(const property of Object.keys(this._values))result._values[property]=this._values[property].possiblyEvaluate(parameters,canonical,availableImages);return result}}class PossiblyEvaluatedPropertyValue{constructor(property,value,parameters){this.property=property,this.value=value,this.parameters=parameters}isConstant(){return"constant"===this.value.kind}constantOr(value){return"constant"===this.value.kind?this.value.value:value}evaluate(feature,featureState,canonical,availableImages){return this.property.evaluate(this.value,this.parameters,feature,featureState,canonical,availableImages)}}class PossiblyEvaluated{constructor(properties){this._properties=properties,this._values=Object.create(properties.defaultPossiblyEvaluatedValues)}get(name){return this._values[name]}}class DataConstantProperty{constructor(specification){this.specification=specification}possiblyEvaluate(value,parameters){if(value.isDataDriven())throw new Error("Value should not be data driven");return value.expression.evaluate(parameters)}interpolate(a,b,t){const interpolationType=this.specification.type,interpolationFn=interpolate[interpolationType];return interpolationFn?interpolationFn(a,b,t):a}}class DataDrivenProperty{constructor(specification,overrides){this.specification=specification,this.overrides=overrides}possiblyEvaluate(value,parameters,canonical,availableImages){return"constant"===value.expression.kind||"camera"===value.expression.kind?new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:value.expression.evaluate(parameters,null,{},canonical,availableImages)},parameters):new PossiblyEvaluatedPropertyValue(this,value.expression,parameters)}interpolate(a,b,t){if("constant"!==a.value.kind||"constant"!==b.value.kind)return a;if(void 0===a.value.value||void 0===b.value.value)return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:void 0},a.parameters);const interpolationType=this.specification.type,interpolationFn=interpolate[interpolationType];if(interpolationFn){const interpolatedValue=interpolationFn(a.value.value,b.value.value,t);return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:interpolatedValue},a.parameters)}return a}evaluate(value,parameters,feature,featureState,canonical,availableImages){return"constant"===value.kind?value.value:value.evaluate(parameters,feature,featureState,canonical,availableImages)}}class CrossFadedDataDrivenProperty extends DataDrivenProperty{possiblyEvaluate(value,parameters,canonical,availableImages){if(void 0===value.value)return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:void 0},parameters);if("constant"===value.expression.kind){const evaluatedValue=value.expression.evaluate(parameters,null,{},canonical,availableImages),constantValue="resolvedImage"===value.property.specification.type&&"string"!=typeof evaluatedValue?evaluatedValue.name:evaluatedValue,constant=this._calculate(constantValue,constantValue,constantValue,parameters);return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:constant},parameters)}if("camera"===value.expression.kind){const cameraVal=this._calculate(value.expression.evaluate({zoom:parameters.zoom-1}),value.expression.evaluate({zoom:parameters.zoom}),value.expression.evaluate({zoom:parameters.zoom+1}),parameters);return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:cameraVal},parameters)}return new PossiblyEvaluatedPropertyValue(this,value.expression,parameters)}evaluate(value,globals,feature,featureState,canonical,availableImages){if("source"===value.kind){const constant=value.evaluate(globals,feature,featureState,canonical,availableImages);return this._calculate(constant,constant,constant,globals)}return"composite"===value.kind?this._calculate(value.evaluate({zoom:Math.floor(globals.zoom)-1},feature,featureState),value.evaluate({zoom:Math.floor(globals.zoom)},feature,featureState),value.evaluate({zoom:Math.floor(globals.zoom)+1},feature,featureState),globals):value.value}_calculate(min,mid,max,parameters){return parameters.zoom>parameters.zoomHistory.lastIntegerZoom?{from:min,to:mid}:{from:max,to:mid}}interpolate(a){return a}}class CrossFadedProperty{constructor(specification){this.specification=specification}possiblyEvaluate(value,parameters,canonical,availableImages){if(void 0!==value.value){if("constant"===value.expression.kind){const constant=value.expression.evaluate(parameters,null,{},canonical,availableImages);return this._calculate(constant,constant,constant,parameters)}return this._calculate(value.expression.evaluate(new EvaluationParameters(Math.floor(parameters.zoom-1),parameters)),value.expression.evaluate(new EvaluationParameters(Math.floor(parameters.zoom),parameters)),value.expression.evaluate(new EvaluationParameters(Math.floor(parameters.zoom+1),parameters)),parameters)}}_calculate(min,mid,max,parameters){return parameters.zoom>parameters.zoomHistory.lastIntegerZoom?{from:min,to:mid}:{from:max,to:mid}}interpolate(a){return a}}class ColorRampProperty{constructor(specification){this.specification=specification}possiblyEvaluate(value,parameters,canonical,availableImages){return!!value.expression.evaluate(parameters,null,{},canonical,availableImages)}interpolate(){return!1}}class Properties{constructor(properties){this.properties=properties,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const property in properties){const prop=properties[property];prop.specification.overridable&&this.overridableProperties.push(property);const defaultPropertyValue=this.defaultPropertyValues[property]=new PropertyValue(prop,void 0),defaultTransitionablePropertyValue=this.defaultTransitionablePropertyValues[property]=new TransitionablePropertyValue(prop);this.defaultTransitioningPropertyValues[property]=defaultTransitionablePropertyValue.untransitioned(),this.defaultPossiblyEvaluatedValues[property]=defaultPropertyValue.possiblyEvaluate({})}}}register("DataDrivenProperty",DataDrivenProperty),register("DataConstantProperty",DataConstantProperty),register("CrossFadedDataDrivenProperty",CrossFadedDataDrivenProperty),register("CrossFadedProperty",CrossFadedProperty),register("ColorRampProperty",ColorRampProperty);class StyleLayer extends Evented{constructor(layer,properties){if(super(),this.id=layer.id,this.type=layer.type,this._featureFilter={filter:()=>!0,needGeometry:!1},"custom"!==layer.type&&(this.metadata=layer.metadata,this.minzoom=layer.minzoom,this.maxzoom=layer.maxzoom,"background"!==layer.type&&(this.source=layer.source,this.sourceLayer=layer["source-layer"],this.filter=layer.filter),properties.layout&&(this._unevaluatedLayout=new Layout(properties.layout)),properties.paint)){this._transitionablePaint=new Transitionable(properties.paint);for(const property in layer.paint)this.setPaintProperty(property,layer.paint[property],{validate:!1});for(const property in layer.layout)this.setLayoutProperty(property,layer.layout[property],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new PossiblyEvaluated(properties.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(name){return"visibility"===name?this.visibility:this._unevaluatedLayout.getValue(name)}setLayoutProperty(name,value,options={}){if(null!=value){const key=`layers.${this.id}.layout.${name}`;if(this._validate(validateLayoutProperty,key,name,value,options))return}"visibility"!==name?this._unevaluatedLayout.setValue(name,value):this.visibility=value}getPaintProperty(name){return name.endsWith("-transition")?this._transitionablePaint.getTransition(name.slice(0,-11)):this._transitionablePaint.getValue(name)}setPaintProperty(name,value,options={}){if(null!=value){const key=`layers.${this.id}.paint.${name}`;if(this._validate(validatePaintProperty,key,name,value,options))return!1}if(name.endsWith("-transition"))return this._transitionablePaint.setTransition(name.slice(0,-11),value||void 0),!1;{const transitionable=this._transitionablePaint._values[name],isCrossFadedProperty="cross-faded-data-driven"===transitionable.property.specification["property-type"],wasDataDriven=transitionable.value.isDataDriven(),oldValue=transitionable.value;this._transitionablePaint.setValue(name,value),this._handleSpecialPaintPropertyUpdate(name);const newValue=this._transitionablePaint._values[name].value;return newValue.isDataDriven()||wasDataDriven||isCrossFadedProperty||this._handleOverridablePaintPropertyUpdate(name,oldValue,newValue)}}_handleSpecialPaintPropertyUpdate(_){}_handleOverridablePaintPropertyUpdate(name,oldValue,newValue){return!1}isHidden(zoom){return!!(this.minzoom&&zoom<this.minzoom)||(!!(this.maxzoom&&zoom>=this.maxzoom)||"none"===this.visibility)}updateTransitions(parameters){this._transitioningPaint=this._transitionablePaint.transitioned(parameters,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(parameters,availableImages){parameters.getCrossfadeParameters&&(this._crossfadeParameters=parameters.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(parameters,void 0,availableImages)),this.paint=this._transitioningPaint.possiblyEvaluate(parameters,void 0,availableImages)}serialize(){const output={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(output.layout=output.layout||{},output.layout.visibility=this.visibility),filterObject(output,((value,key)=>!(void 0===value||"layout"===key&&!Object.keys(value).length||"paint"===key&&!Object.keys(value).length)))}_validate(validate,key,name,value,options={}){return(!options||!1!==options.validate)&&emitValidationErrors(this,validate.call(validateStyle,{key:key,layerType:this.type,objectKey:name,value:value,styleSpec:v8Spec,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const property in this.paint._values){const value=this.paint.get(property);if(value instanceof PossiblyEvaluatedPropertyValue&&supportsPropertyExpression(value.property.specification)&&(("source"===value.value.kind||"composite"===value.value.kind)&&value.value.isStateDependent))return!0}return!1}}const viewTypes={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Struct{constructor(structArray,index){this._structArray=structArray,this._pos1=index*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class StructArray{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(array,transferables){return array._trim(),transferables&&(array.isTransferred=!0,transferables.push(array.arrayBuffer)),{length:array.length,arrayBuffer:array.arrayBuffer}}static deserialize(input){const structArray=Object.create(this.prototype);return structArray.arrayBuffer=input.arrayBuffer,structArray.length=input.length,structArray.capacity=input.arrayBuffer.byteLength/structArray.bytesPerElement,structArray._refreshViews(),structArray}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(n){this.reserve(n),this.length=n}reserve(n){if(n>this.capacity){this.capacity=Math.max(n,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const oldUint8Array=this.uint8;this._refreshViews(),oldUint8Array&&this.uint8.set(oldUint8Array)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function createLayout(members,alignment=1){let offset=0,maxSize=0;return{members:members.map((member=>{const typeSize=(type=member.type,viewTypes[type].BYTES_PER_ELEMENT);var type;const memberOffset=offset=align$1(offset,Math.max(alignment,typeSize)),components=member.components||1;return maxSize=Math.max(maxSize,typeSize),offset+=typeSize*components,{name:member.name,type:member.type,components:components,offset:memberOffset}})),size:align$1(offset,Math.max(maxSize,alignment)),alignment:alignment}}function align$1(offset,size){return Math.ceil(offset/size)*size}class StructArrayLayout2i4 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1)}emplace(i,v0,v1){const o2=2*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,i}}StructArrayLayout2i4.prototype.bytesPerElement=4,register("StructArrayLayout2i4",StructArrayLayout2i4);class StructArrayLayout3i6 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o2=3*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,this.int16[o2+2]=v2,i}}StructArrayLayout3i6.prototype.bytesPerElement=6,register("StructArrayLayout3i6",StructArrayLayout3i6);class StructArrayLayout4i8 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3)}emplace(i,v0,v1,v2,v3){const o2=4*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,this.int16[o2+2]=v2,this.int16[o2+3]=v3,i}}StructArrayLayout4i8.prototype.bytesPerElement=8,register("StructArrayLayout4i8",StructArrayLayout4i8);class StructArrayLayout2i4i12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3,v4,v5)}emplace(i,v0,v1,v2,v3,v4,v5){const o2=6*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,this.int16[o2+2]=v2,this.int16[o2+3]=v3,this.int16[o2+4]=v4,this.int16[o2+5]=v5,i}}StructArrayLayout2i4i12.prototype.bytesPerElement=12,register("StructArrayLayout2i4i12",StructArrayLayout2i4i12);class StructArrayLayout2i4ub8 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3,v4,v5)}emplace(i,v0,v1,v2,v3,v4,v5){const o2=4*i,o1=8*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,this.uint8[o1+4]=v2,this.uint8[o1+5]=v3,this.uint8[o1+6]=v4,this.uint8[o1+7]=v5,i}}StructArrayLayout2i4ub8.prototype.bytesPerElement=8,register("StructArrayLayout2i4ub8",StructArrayLayout2i4ub8);class StructArrayLayout2f8 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1)}emplace(i,v0,v1){const o4=2*i;return this.float32[o4+0]=v0,this.float32[o4+1]=v1,i}}StructArrayLayout2f8.prototype.bytesPerElement=8,register("StructArrayLayout2f8",StructArrayLayout2f8);class StructArrayLayout10ui20 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8,v9){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9){const o2=10*i;return this.uint16[o2+0]=v0,this.uint16[o2+1]=v1,this.uint16[o2+2]=v2,this.uint16[o2+3]=v3,this.uint16[o2+4]=v4,this.uint16[o2+5]=v5,this.uint16[o2+6]=v6,this.uint16[o2+7]=v7,this.uint16[o2+8]=v8,this.uint16[o2+9]=v9,i}}StructArrayLayout10ui20.prototype.bytesPerElement=20,register("StructArrayLayout10ui20",StructArrayLayout10ui20);class StructArrayLayout4i4ui4i24 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11){const o2=12*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,this.int16[o2+2]=v2,this.int16[o2+3]=v3,this.uint16[o2+4]=v4,this.uint16[o2+5]=v5,this.uint16[o2+6]=v6,this.uint16[o2+7]=v7,this.int16[o2+8]=v8,this.int16[o2+9]=v9,this.int16[o2+10]=v10,this.int16[o2+11]=v11,i}}StructArrayLayout4i4ui4i24.prototype.bytesPerElement=24,register("StructArrayLayout4i4ui4i24",StructArrayLayout4i4ui4i24);class StructArrayLayout3f12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o4=3*i;return this.float32[o4+0]=v0,this.float32[o4+1]=v1,this.float32[o4+2]=v2,i}}StructArrayLayout3f12.prototype.bytesPerElement=12,register("StructArrayLayout3f12",StructArrayLayout3f12);class StructArrayLayout1ul4 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(v0){const i=this.length;return this.resize(i+1),this.emplace(i,v0)}emplace(i,v0){const o4=1*i;return this.uint32[o4+0]=v0,i}}StructArrayLayout1ul4.prototype.bytesPerElement=4,register("StructArrayLayout1ul4",StructArrayLayout1ul4);class StructArrayLayout6i1ul2ui20 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8){const o2=10*i,o4=5*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,this.int16[o2+2]=v2,this.int16[o2+3]=v3,this.int16[o2+4]=v4,this.int16[o2+5]=v5,this.uint32[o4+3]=v6,this.uint16[o2+8]=v7,this.uint16[o2+9]=v8,i}}StructArrayLayout6i1ul2ui20.prototype.bytesPerElement=20,register("StructArrayLayout6i1ul2ui20",StructArrayLayout6i1ul2ui20);class StructArrayLayout2i2i2i12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3,v4,v5)}emplace(i,v0,v1,v2,v3,v4,v5){const o2=6*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,this.int16[o2+2]=v2,this.int16[o2+3]=v3,this.int16[o2+4]=v4,this.int16[o2+5]=v5,i}}StructArrayLayout2i2i2i12.prototype.bytesPerElement=12,register("StructArrayLayout2i2i2i12",StructArrayLayout2i2i2i12);class StructArrayLayout2f1f2i16 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3,v4)}emplace(i,v0,v1,v2,v3,v4){const o4=4*i,o2=8*i;return this.float32[o4+0]=v0,this.float32[o4+1]=v1,this.float32[o4+2]=v2,this.int16[o2+6]=v3,this.int16[o2+7]=v4,i}}StructArrayLayout2f1f2i16.prototype.bytesPerElement=16,register("StructArrayLayout2f1f2i16",StructArrayLayout2f1f2i16);class StructArrayLayout2ub2f12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3)}emplace(i,v0,v1,v2,v3){const o1=12*i,o4=3*i;return this.uint8[o1+0]=v0,this.uint8[o1+1]=v1,this.float32[o4+1]=v2,this.float32[o4+2]=v3,i}}StructArrayLayout2ub2f12.prototype.bytesPerElement=12,register("StructArrayLayout2ub2f12",StructArrayLayout2ub2f12);class StructArrayLayout3ui6 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o2=3*i;return this.uint16[o2+0]=v0,this.uint16[o2+1]=v1,this.uint16[o2+2]=v2,i}}StructArrayLayout3ui6.prototype.bytesPerElement=6,register("StructArrayLayout3ui6",StructArrayLayout3ui6);class StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16){const o2=24*i,o4=12*i,o1=48*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,this.uint16[o2+2]=v2,this.uint16[o2+3]=v3,this.uint32[o4+2]=v4,this.uint32[o4+3]=v5,this.uint32[o4+4]=v6,this.uint16[o2+10]=v7,this.uint16[o2+11]=v8,this.uint16[o2+12]=v9,this.float32[o4+7]=v10,this.float32[o4+8]=v11,this.uint8[o1+36]=v12,this.uint8[o1+37]=v13,this.uint8[o1+38]=v14,this.uint32[o4+10]=v15,this.int16[o2+22]=v16,i}}StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48.prototype.bytesPerElement=48,register("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48);class StructArrayLayout8i15ui1ul2f2ui64 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18,v19,v20,v21,v22,v23,v24,v25,v26,v27){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18,v19,v20,v21,v22,v23,v24,v25,v26,v27)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18,v19,v20,v21,v22,v23,v24,v25,v26,v27){const o2=32*i,o4=16*i;return this.int16[o2+0]=v0,this.int16[o2+1]=v1,this.int16[o2+2]=v2,this.int16[o2+3]=v3,this.int16[o2+4]=v4,this.int16[o2+5]=v5,this.int16[o2+6]=v6,this.int16[o2+7]=v7,this.uint16[o2+8]=v8,this.uint16[o2+9]=v9,this.uint16[o2+10]=v10,this.uint16[o2+11]=v11,this.uint16[o2+12]=v12,this.uint16[o2+13]=v13,this.uint16[o2+14]=v14,this.uint16[o2+15]=v15,this.uint16[o2+16]=v16,this.uint16[o2+17]=v17,this.uint16[o2+18]=v18,this.uint16[o2+19]=v19,this.uint16[o2+20]=v20,this.uint16[o2+21]=v21,this.uint16[o2+22]=v22,this.uint32[o4+12]=v23,this.float32[o4+13]=v24,this.float32[o4+14]=v25,this.uint16[o2+30]=v26,this.uint16[o2+31]=v27,i}}StructArrayLayout8i15ui1ul2f2ui64.prototype.bytesPerElement=64,register("StructArrayLayout8i15ui1ul2f2ui64",StructArrayLayout8i15ui1ul2f2ui64);class StructArrayLayout1f4 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0){const i=this.length;return this.resize(i+1),this.emplace(i,v0)}emplace(i,v0){const o4=1*i;return this.float32[o4+0]=v0,i}}StructArrayLayout1f4.prototype.bytesPerElement=4,register("StructArrayLayout1f4",StructArrayLayout1f4);class StructArrayLayout1ui2f12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o2=6*i,o4=3*i;return this.uint16[o2+0]=v0,this.float32[o4+1]=v1,this.float32[o4+2]=v2,i}}StructArrayLayout1ui2f12.prototype.bytesPerElement=12,register("StructArrayLayout1ui2f12",StructArrayLayout1ui2f12);class StructArrayLayout1ul2ui8 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o4=2*i,o2=4*i;return this.uint32[o4+0]=v0,this.uint16[o2+2]=v1,this.uint16[o2+3]=v2,i}}StructArrayLayout1ul2ui8.prototype.bytesPerElement=8,register("StructArrayLayout1ul2ui8",StructArrayLayout1ul2ui8);class StructArrayLayout2ui4 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1)}emplace(i,v0,v1){const o2=2*i;return this.uint16[o2+0]=v0,this.uint16[o2+1]=v1,i}}StructArrayLayout2ui4.prototype.bytesPerElement=4,register("StructArrayLayout2ui4",StructArrayLayout2ui4);class StructArrayLayout1ui2 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0){const i=this.length;return this.resize(i+1),this.emplace(i,v0)}emplace(i,v0){const o2=1*i;return this.uint16[o2+0]=v0,i}}StructArrayLayout1ui2.prototype.bytesPerElement=2,register("StructArrayLayout1ui2",StructArrayLayout1ui2);class StructArrayLayout4f16 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3){const i=this.length;return this.resize(i+1),this.emplace(i,v0,v1,v2,v3)}emplace(i,v0,v1,v2,v3){const o4=4*i;return this.float32[o4+0]=v0,this.float32[o4+1]=v1,this.float32[o4+2]=v2,this.float32[o4+3]=v3,i}}StructArrayLayout4f16.prototype.bytesPerElement=16,register("StructArrayLayout4f16",StructArrayLayout4f16);class CollisionBoxStruct extends Struct{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new Point$2(this.anchorPointX,this.anchorPointY)}}CollisionBoxStruct.prototype.size=20;class CollisionBoxArray extends StructArrayLayout6i1ul2ui20{get(index){return new CollisionBoxStruct(this,index)}}register("CollisionBoxArray",CollisionBoxArray);class PlacedSymbolStruct extends Struct{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(x){this._structArray.uint8[this._pos1+37]=x}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(x){this._structArray.uint8[this._pos1+38]=x}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(x){this._structArray.uint32[this._pos4+10]=x}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}PlacedSymbolStruct.prototype.size=48;class PlacedSymbolArray extends StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48{get(index){return new PlacedSymbolStruct(this,index)}}register("PlacedSymbolArray",PlacedSymbolArray);class SymbolInstanceStruct extends Struct{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(x){this._structArray.uint32[this._pos4+12]=x}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}SymbolInstanceStruct.prototype.size=64;class SymbolInstanceArray extends StructArrayLayout8i15ui1ul2f2ui64{get(index){return new SymbolInstanceStruct(this,index)}}register("SymbolInstanceArray",SymbolInstanceArray);class GlyphOffsetArray extends StructArrayLayout1f4{getoffsetX(index){return this.float32[1*index+0]}}register("GlyphOffsetArray",GlyphOffsetArray);class SymbolLineVertexArray extends StructArrayLayout3i6{getx(index){return this.int16[3*index+0]}gety(index){return this.int16[3*index+1]}gettileUnitDistanceFromAnchor(index){return this.int16[3*index+2]}}register("SymbolLineVertexArray",SymbolLineVertexArray);class TextAnchorOffsetStruct extends Struct{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}TextAnchorOffsetStruct.prototype.size=12;class TextAnchorOffsetArray extends StructArrayLayout1ui2f12{get(index){return new TextAnchorOffsetStruct(this,index)}}register("TextAnchorOffsetArray",TextAnchorOffsetArray);class FeatureIndexStruct extends Struct{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}FeatureIndexStruct.prototype.size=8;class FeatureIndexArray extends StructArrayLayout1ul2ui8{get(index){return new FeatureIndexStruct(this,index)}}register("FeatureIndexArray",FeatureIndexArray);class PosArray extends StructArrayLayout2i4{}class CircleLayoutArray extends StructArrayLayout2i4{}class FillLayoutArray extends StructArrayLayout2i4{}class FillExtrusionLayoutArray extends StructArrayLayout2i4i12{}class LineLayoutArray extends StructArrayLayout2i4ub8{}class LineExtLayoutArray extends StructArrayLayout2f8{}class PatternLayoutArray extends StructArrayLayout10ui20{}class SymbolLayoutArray extends StructArrayLayout4i4ui4i24{}class SymbolDynamicLayoutArray extends StructArrayLayout3f12{}class SymbolOpacityArray extends StructArrayLayout1ul4{}class CollisionBoxLayoutArray extends StructArrayLayout2i2i2i12{}class CollisionVertexArray extends StructArrayLayout2ub2f12{}class TriangleIndexArray extends StructArrayLayout3ui6{}class LineIndexArray extends StructArrayLayout2ui4{}const layout$6=createLayout([{name:"a_pos",components:2,type:"Int16"}],4),{members:members$4,size:size$4,alignment:alignment$4}=layout$6;class SegmentVector{constructor(segments=[]){this.segments=segments}prepareSegment(numVertices,layoutVertexArray,indexArray,sortKey){let segment=this.segments[this.segments.length-1];return numVertices>SegmentVector.MAX_VERTEX_ARRAY_LENGTH&&warnOnce(`Max vertices per segment is ${SegmentVector.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${numVertices}`),(!segment||segment.vertexLength+numVertices>SegmentVector.MAX_VERTEX_ARRAY_LENGTH||segment.sortKey!==sortKey)&&(segment={vertexOffset:layoutVertexArray.length,primitiveOffset:indexArray.length,vertexLength:0,primitiveLength:0},void 0!==sortKey&&(segment.sortKey=sortKey),this.segments.push(segment)),segment}get(){return this.segments}destroy(){for(const segment of this.segments)for(const k in segment.vaos)segment.vaos[k].destroy()}static simpleSegment(vertexOffset,primitiveOffset,vertexLength,primitiveLength){return new SegmentVector([{vertexOffset:vertexOffset,primitiveOffset:primitiveOffset,vertexLength:vertexLength,primitiveLength:primitiveLength,vaos:{},sortKey:0}])}}function packUint8ToFloat(a,b){return 256*(a=clamp$1(Math.floor(a),0,255))+(b=clamp$1(Math.floor(b),0,255))}SegmentVector.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,register("SegmentVector",SegmentVector);const patternAttributes=createLayout([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var murmurhashJs$1={exports:{}},murmurhash3_gc$2={exports:{}};!function(module){module.exports=function(key,seed){var remainder,bytes,h1,h1b,c1,c2,k1,i;for(remainder=3&key.length,bytes=key.length-remainder,h1=seed,c1=3432918353,c2=461845907,i=0;i<bytes;)k1=255&key.charCodeAt(i)|(255&key.charCodeAt(++i))<<8|(255&key.charCodeAt(++i))<<16|(255&key.charCodeAt(++i))<<24,++i,h1=27492+(65535&(h1b=5*(65535&(h1=(h1^=k1=(65535&(k1=(k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295)<<15|k1>>>17))*c2+(((k1>>>16)*c2&65535)<<16)&4294967295)<<13|h1>>>19))+((5*(h1>>>16)&65535)<<16)&4294967295))+((58964+(h1b>>>16)&65535)<<16);switch(k1=0,remainder){case 3:k1^=(255&key.charCodeAt(i+2))<<16;case 2:k1^=(255&key.charCodeAt(i+1))<<8;case 1:h1^=k1=(65535&(k1=(k1=(65535&(k1^=255&key.charCodeAt(i)))*c1+(((k1>>>16)*c1&65535)<<16)&4294967295)<<15|k1>>>17))*c2+(((k1>>>16)*c2&65535)<<16)&4294967295}return h1^=key.length,h1=2246822507*(65535&(h1^=h1>>>16))+((2246822507*(h1>>>16)&65535)<<16)&4294967295,h1=3266489909*(65535&(h1^=h1>>>13))+((3266489909*(h1>>>16)&65535)<<16)&4294967295,(h1^=h1>>>16)>>>0}}(murmurhash3_gc$2);var murmurhash3_gcExports=murmurhash3_gc$2.exports,murmurhash2_gc$2={exports:{}};!function(module){module.exports=function(str,seed){for(var k,l=str.length,h=seed^l,i=0;l>=4;)k=1540483477*(65535&(k=255&str.charCodeAt(i)|(255&str.charCodeAt(++i))<<8|(255&str.charCodeAt(++i))<<16|(255&str.charCodeAt(++i))<<24))+((1540483477*(k>>>16)&65535)<<16),h=1540483477*(65535&h)+((1540483477*(h>>>16)&65535)<<16)^(k=1540483477*(65535&(k^=k>>>24))+((1540483477*(k>>>16)&65535)<<16)),l-=4,++i;switch(l){case 3:h^=(255&str.charCodeAt(i+2))<<16;case 2:h^=(255&str.charCodeAt(i+1))<<8;case 1:h=1540483477*(65535&(h^=255&str.charCodeAt(i)))+((1540483477*(h>>>16)&65535)<<16)}return h=1540483477*(65535&(h^=h>>>13))+((1540483477*(h>>>16)&65535)<<16),(h^=h>>>15)>>>0}}(murmurhash2_gc$2);var murmurhash2_gcExports=murmurhash2_gc$2.exports,murmur3=(murmurhashJs$1.exports,murmurhash3_gcExports),murmur2=murmurhash2_gcExports;murmurhashJs$1.exports=murmur3;murmurhashJs$1.exports.murmur3=murmur3,murmurhashJs$1.exports.murmur2=murmur2;var murmur3$1=getDefaultExportFromCjs$1(murmurhashJs$1.exports);class FeaturePositionMap{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(id,index,start,end){this.ids.push(getNumericId(id)),this.positions.push(index,start,end)}getPositions(id){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const intId=getNumericId(id);let i=0,j=this.ids.length-1;for(;i<j;){const m=i+j>>1;this.ids[m]>=intId?j=m:i=m+1}const positions=[];for(;this.ids[i]===intId;){const index=this.positions[3*i],start=this.positions[3*i+1],end=this.positions[3*i+2];positions.push({index:index,start:start,end:end}),i++}return positions}static serialize(map,transferables){const ids=new Float64Array(map.ids),positions=new Uint32Array(map.positions);return sort$1(ids,positions,0,ids.length-1),transferables&&transferables.push(ids.buffer,positions.buffer),{ids:ids,positions:positions}}static deserialize(obj){const map=new FeaturePositionMap;return map.ids=obj.ids,map.positions=obj.positions,map.indexed=!0,map}}function getNumericId(value){const numValue=+value;return!isNaN(numValue)&&numValue<=Number.MAX_SAFE_INTEGER?numValue:murmur3$1(String(value))}function sort$1(ids,positions,left,right){for(;left<right;){const pivot=ids[left+right>>1];let i=left-1,j=right+1;for(;;){do{i++}while(ids[i]<pivot);do{j--}while(ids[j]>pivot);if(i>=j)break;swap$2(ids,i,j),swap$2(positions,3*i,3*j),swap$2(positions,3*i+1,3*j+1),swap$2(positions,3*i+2,3*j+2)}j-left<right-j?(sort$1(ids,positions,left,j),left=j+1):(sort$1(ids,positions,j+1,right),right=j)}}function swap$2(arr,i,j){const tmp=arr[i];arr[i]=arr[j],arr[j]=tmp}register("FeaturePositionMap",FeaturePositionMap);class Uniform{constructor(context,location){this.gl=context.gl,this.location=location}}class Uniform1f extends Uniform{constructor(context,location){super(context,location),this.current=0}set(v){this.current!==v&&(this.current=v,this.gl.uniform1f(this.location,v))}}class Uniform4f extends Uniform{constructor(context,location){super(context,location),this.current=[0,0,0,0]}set(v){v[0]===this.current[0]&&v[1]===this.current[1]&&v[2]===this.current[2]&&v[3]===this.current[3]||(this.current=v,this.gl.uniform4f(this.location,v[0],v[1],v[2],v[3]))}}class UniformColor extends Uniform{constructor(context,location){super(context,location),this.current=Color.transparent}set(v){v.r===this.current.r&&v.g===this.current.g&&v.b===this.current.b&&v.a===this.current.a||(this.current=v,this.gl.uniform4f(this.location,v.r,v.g,v.b,v.a))}}const emptyMat4=new Float32Array(16);function packColor(color){return[packUint8ToFloat(255*color.r,255*color.g),packUint8ToFloat(255*color.b,255*color.a)]}class ConstantBinder{constructor(value,names,type){this.value=value,this.uniformNames=names.map((name=>`u_${name}`)),this.type=type}setUniform(uniform,globals,currentValue){uniform.set(currentValue.constantOr(this.value))}getBinding(context,location,_){return"color"===this.type?new UniformColor(context,location):new Uniform1f(context,location)}}class CrossFadedConstantBinder{constructor(value,names){this.uniformNames=names.map((name=>`u_${name}`)),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(posTo,posFrom){this.pixelRatioFrom=posFrom.pixelRatio,this.pixelRatioTo=posTo.pixelRatio,this.patternFrom=posFrom.tlbr,this.patternTo=posTo.tlbr}setUniform(uniform,globals,currentValue,uniformName){const pos="u_pattern_to"===uniformName?this.patternTo:"u_pattern_from"===uniformName?this.patternFrom:"u_pixel_ratio_to"===uniformName?this.pixelRatioTo:"u_pixel_ratio_from"===uniformName?this.pixelRatioFrom:null;pos&&uniform.set(pos)}getBinding(context,location,name){return"u_pattern"===name.substr(0,9)?new Uniform4f(context,location):new Uniform1f(context,location)}}class SourceExpressionBinder{constructor(expression,names,type,PaintVertexArray){this.expression=expression,this.type=type,this.maxValue=0,this.paintVertexAttributes=names.map((name=>({name:`a_${name}`,type:"Float32",components:"color"===type?2:1,offset:0}))),this.paintVertexArray=new PaintVertexArray}populatePaintArray(newLength,feature,imagePositions,canonical,formattedSection){const start=this.paintVertexArray.length,value=this.expression.evaluate(new EvaluationParameters(0),feature,{},canonical,[],formattedSection);this.paintVertexArray.resize(newLength),this._setPaintValue(start,newLength,value)}updatePaintArray(start,end,feature,featureState){const value=this.expression.evaluate({zoom:0},feature,featureState);this._setPaintValue(start,end,value)}_setPaintValue(start,end,value){if("color"===this.type){const color=packColor(value);for(let i=start;i<end;i++)this.paintVertexArray.emplace(i,color[0],color[1])}else{for(let i=start;i<end;i++)this.paintVertexArray.emplace(i,value);this.maxValue=Math.max(this.maxValue,Math.abs(value))}}upload(context){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=context.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class CompositeExpressionBinder{constructor(expression,names,type,useIntegerZoom,zoom,PaintVertexArray){this.expression=expression,this.uniformNames=names.map((name=>`u_${name}_t`)),this.type=type,this.useIntegerZoom=useIntegerZoom,this.zoom=zoom,this.maxValue=0,this.paintVertexAttributes=names.map((name=>({name:`a_${name}`,type:"Float32",components:"color"===type?4:2,offset:0}))),this.paintVertexArray=new PaintVertexArray}populatePaintArray(newLength,feature,imagePositions,canonical,formattedSection){const min=this.expression.evaluate(new EvaluationParameters(this.zoom),feature,{},canonical,[],formattedSection),max=this.expression.evaluate(new EvaluationParameters(this.zoom+1),feature,{},canonical,[],formattedSection),start=this.paintVertexArray.length;this.paintVertexArray.resize(newLength),this._setPaintValue(start,newLength,min,max)}updatePaintArray(start,end,feature,featureState){const min=this.expression.evaluate({zoom:this.zoom},feature,featureState),max=this.expression.evaluate({zoom:this.zoom+1},feature,featureState);this._setPaintValue(start,end,min,max)}_setPaintValue(start,end,min,max){if("color"===this.type){const minColor=packColor(min),maxColor=packColor(max);for(let i=start;i<end;i++)this.paintVertexArray.emplace(i,minColor[0],minColor[1],maxColor[0],maxColor[1])}else{for(let i=start;i<end;i++)this.paintVertexArray.emplace(i,min,max);this.maxValue=Math.max(this.maxValue,Math.abs(min),Math.abs(max))}}upload(context){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=context.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(uniform,globals){const currentZoom=this.useIntegerZoom?Math.floor(globals.zoom):globals.zoom,factor=clamp$1(this.expression.interpolationFactor(currentZoom,this.zoom,this.zoom+1),0,1);uniform.set(factor)}getBinding(context,location,_){return new Uniform1f(context,location)}}class CrossFadedCompositeBinder{constructor(expression,type,useIntegerZoom,zoom,PaintVertexArray,layerId){this.expression=expression,this.type=type,this.useIntegerZoom=useIntegerZoom,this.zoom=zoom,this.layerId=layerId,this.zoomInPaintVertexArray=new PaintVertexArray,this.zoomOutPaintVertexArray=new PaintVertexArray}populatePaintArray(length,feature,imagePositions){const start=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(length),this.zoomOutPaintVertexArray.resize(length),this._setPaintValues(start,length,feature.patterns&&feature.patterns[this.layerId],imagePositions)}updatePaintArray(start,end,feature,featureState,imagePositions){this._setPaintValues(start,end,feature.patterns&&feature.patterns[this.layerId],imagePositions)}_setPaintValues(start,end,patterns,positions){if(!positions||!patterns)return;const{min:min,mid:mid,max:max}=patterns,imageMin=positions[min],imageMid=positions[mid],imageMax=positions[max];if(imageMin&&imageMid&&imageMax)for(let i=start;i<end;i++)this.zoomInPaintVertexArray.emplace(i,imageMid.tl[0],imageMid.tl[1],imageMid.br[0],imageMid.br[1],imageMin.tl[0],imageMin.tl[1],imageMin.br[0],imageMin.br[1],imageMid.pixelRatio,imageMin.pixelRatio),this.zoomOutPaintVertexArray.emplace(i,imageMid.tl[0],imageMid.tl[1],imageMid.br[0],imageMid.br[1],imageMax.tl[0],imageMax.tl[1],imageMax.br[0],imageMax.br[1],imageMid.pixelRatio,imageMax.pixelRatio)}upload(context){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=context.createVertexBuffer(this.zoomInPaintVertexArray,patternAttributes.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=context.createVertexBuffer(this.zoomOutPaintVertexArray,patternAttributes.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class ProgramConfiguration{constructor(layer,zoom,filterProperties){this.binders={},this._buffers=[];const keys=[];for(const property in layer.paint._values){if(!filterProperties(property))continue;const value=layer.paint.get(property);if(!(value instanceof PossiblyEvaluatedPropertyValue&&supportsPropertyExpression(value.property.specification)))continue;const names=paintAttributeNames(property,layer.type),expression=value.value,type=value.property.specification.type,useIntegerZoom=value.property.useIntegerZoom,propType=value.property.specification["property-type"],isCrossFaded="cross-faded"===propType||"cross-faded-data-driven"===propType;if("constant"===expression.kind)this.binders[property]=isCrossFaded?new CrossFadedConstantBinder(expression.value,names):new ConstantBinder(expression.value,names,type),keys.push(`/u_${property}`);else if("source"===expression.kind||isCrossFaded){const StructArrayLayout=layoutType(property,type,"source");this.binders[property]=isCrossFaded?new CrossFadedCompositeBinder(expression,type,useIntegerZoom,zoom,StructArrayLayout,layer.id):new SourceExpressionBinder(expression,names,type,StructArrayLayout),keys.push(`/a_${property}`)}else{const StructArrayLayout=layoutType(property,type,"composite");this.binders[property]=new CompositeExpressionBinder(expression,names,type,useIntegerZoom,zoom,StructArrayLayout),keys.push(`/z_${property}`)}}this.cacheKey=keys.sort().join("")}getMaxValue(property){const binder=this.binders[property];return binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder?binder.maxValue:0}populatePaintArrays(newLength,feature,imagePositions,canonical,formattedSection){for(const property in this.binders){const binder=this.binders[property];(binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder||binder instanceof CrossFadedCompositeBinder)&&binder.populatePaintArray(newLength,feature,imagePositions,canonical,formattedSection)}}setConstantPatternPositions(posTo,posFrom){for(const property in this.binders){const binder=this.binders[property];binder instanceof CrossFadedConstantBinder&&binder.setConstantPatternPositions(posTo,posFrom)}}updatePaintArrays(featureStates,featureMap,vtLayer,layer,imagePositions){let dirty=!1;for(const id in featureStates){const positions=featureMap.getPositions(id);for(const pos of positions){const feature=vtLayer.feature(pos.index);for(const property in this.binders){const binder=this.binders[property];if((binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder||binder instanceof CrossFadedCompositeBinder)&&!0===binder.expression.isStateDependent){const value=layer.paint.get(property);binder.expression=value.value,binder.updatePaintArray(pos.start,pos.end,feature,featureStates[id],imagePositions),dirty=!0}}}}return dirty}defines(){const result=[];for(const property in this.binders){const binder=this.binders[property];(binder instanceof ConstantBinder||binder instanceof CrossFadedConstantBinder)&&result.push(...binder.uniformNames.map((name=>`#define HAS_UNIFORM_${name}`)))}return result}getBinderAttributes(){const result=[];for(const property in this.binders){const binder=this.binders[property];if(binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder)for(let i=0;i<binder.paintVertexAttributes.length;i++)result.push(binder.paintVertexAttributes[i].name);else if(binder instanceof CrossFadedCompositeBinder)for(let i=0;i<patternAttributes.members.length;i++)result.push(patternAttributes.members[i].name)}return result}getBinderUniforms(){const uniforms=[];for(const property in this.binders){const binder=this.binders[property];if(binder instanceof ConstantBinder||binder instanceof CrossFadedConstantBinder||binder instanceof CompositeExpressionBinder)for(const uniformName of binder.uniformNames)uniforms.push(uniformName)}return uniforms}getPaintVertexBuffers(){return this._buffers}getUniforms(context,locations){const uniforms=[];for(const property in this.binders){const binder=this.binders[property];if(binder instanceof ConstantBinder||binder instanceof CrossFadedConstantBinder||binder instanceof CompositeExpressionBinder)for(const name of binder.uniformNames)if(locations[name]){const binding=binder.getBinding(context,locations[name],name);uniforms.push({name:name,property:property,binding:binding})}}return uniforms}setUniforms(context,binderUniforms,properties,globals){for(const{name:name,property:property,binding:binding}of binderUniforms)this.binders[property].setUniform(binding,globals,properties.get(property),name)}updatePaintBuffers(crossfade){this._buffers=[];for(const property in this.binders){const binder=this.binders[property];if(crossfade&&binder instanceof CrossFadedCompositeBinder){const patternVertexBuffer=2===crossfade.fromScale?binder.zoomInPaintVertexBuffer:binder.zoomOutPaintVertexBuffer;patternVertexBuffer&&this._buffers.push(patternVertexBuffer)}else(binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder)&&binder.paintVertexBuffer&&this._buffers.push(binder.paintVertexBuffer)}}upload(context){for(const property in this.binders){const binder=this.binders[property];(binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder||binder instanceof CrossFadedCompositeBinder)&&binder.upload(context)}this.updatePaintBuffers()}destroy(){for(const property in this.binders){const binder=this.binders[property];(binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder||binder instanceof CrossFadedCompositeBinder)&&binder.destroy()}}}class ProgramConfigurationSet{constructor(layers,zoom,filterProperties=(()=>!0)){this.programConfigurations={};for(const layer of layers)this.programConfigurations[layer.id]=new ProgramConfiguration(layer,zoom,filterProperties);this.needsUpload=!1,this._featureMap=new FeaturePositionMap,this._bufferOffset=0}populatePaintArrays(length,feature,index,imagePositions,canonical,formattedSection){for(const key in this.programConfigurations)this.programConfigurations[key].populatePaintArrays(length,feature,imagePositions,canonical,formattedSection);void 0!==feature.id&&this._featureMap.add(feature.id,index,this._bufferOffset,length),this._bufferOffset=length,this.needsUpload=!0}updatePaintArrays(featureStates,vtLayer,layers,imagePositions){for(const layer of layers)this.needsUpload=this.programConfigurations[layer.id].updatePaintArrays(featureStates,this._featureMap,vtLayer,layer,imagePositions)||this.needsUpload}get(layerId){return this.programConfigurations[layerId]}upload(context){if(this.needsUpload){for(const layerId in this.programConfigurations)this.programConfigurations[layerId].upload(context);this.needsUpload=!1}}destroy(){for(const layerId in this.programConfigurations)this.programConfigurations[layerId].destroy()}}function paintAttributeNames(property,type){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[property]||[property.replace(`${type}-`,"").replace(/-/g,"_")]}function layoutType(property,type,binderType){const defaultLayouts={color:{source:StructArrayLayout2f8,composite:StructArrayLayout4f16},number:{source:StructArrayLayout1f4,composite:StructArrayLayout2f8}},layoutException=function(property){return{"line-pattern":{source:PatternLayoutArray,composite:PatternLayoutArray},"fill-pattern":{source:PatternLayoutArray,composite:PatternLayoutArray},"fill-extrusion-pattern":{source:PatternLayoutArray,composite:PatternLayoutArray}}[property]}(property);return layoutException&&layoutException[binderType]||defaultLayouts[type][binderType]}register("ConstantBinder",ConstantBinder),register("CrossFadedConstantBinder",CrossFadedConstantBinder),register("SourceExpressionBinder",SourceExpressionBinder),register("CrossFadedCompositeBinder",CrossFadedCompositeBinder),register("CompositeExpressionBinder",CompositeExpressionBinder),register("ProgramConfiguration",ProgramConfiguration,{omit:["_buffers"]}),register("ProgramConfigurationSet",ProgramConfigurationSet);const EXTENT=8192,MAX=Math.pow(2,14)-1,MIN=-MAX-1;function loadGeometry(feature){const scale=EXTENT/feature.extent,geometry=feature.loadGeometry();for(let r=0;r<geometry.length;r++){const ring=geometry[r];for(let p=0;p<ring.length;p++){const point=ring[p],x=Math.round(point.x*scale),y=Math.round(point.y*scale);point.x=clamp$1(x,MIN,MAX),point.y=clamp$1(y,MIN,MAX),(x<point.x||x>point.x+1||y<point.y||y>point.y+1)&&warnOnce("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return geometry}function toEvaluationFeature(feature,needGeometry){return{type:feature.type,id:feature.id,properties:feature.properties,geometry:needGeometry?loadGeometry(feature):[]}}function addCircleVertex(layoutVertexArray,x,y,extrudeX,extrudeY){layoutVertexArray.emplaceBack(2*x+(extrudeX+1)/2,2*y+(extrudeY+1)/2)}class CircleBucket{constructor(options){this.zoom=options.zoom,this.overscaling=options.overscaling,this.layers=options.layers,this.layerIds=this.layers.map((layer=>layer.id)),this.index=options.index,this.hasPattern=!1,this.layoutVertexArray=new CircleLayoutArray,this.indexArray=new TriangleIndexArray,this.segments=new SegmentVector,this.programConfigurations=new ProgramConfigurationSet(options.layers,options.zoom),this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id))}populate(features,options,canonical){const styleLayer=this.layers[0],bucketFeatures=[];let circleSortKey=null,sortFeaturesByKey=!1;"circle"===styleLayer.type&&(circleSortKey=styleLayer.layout.get("circle-sort-key"),sortFeaturesByKey=!circleSortKey.isConstant());for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=this.layers[0]._featureFilter.needGeometry,evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!this.layers[0]._featureFilter.filter(new EvaluationParameters(this.zoom),evaluationFeature,canonical))continue;const sortKey=sortFeaturesByKey?circleSortKey.evaluate(evaluationFeature,{},canonical):void 0,bucketFeature={id:id,properties:feature.properties,type:feature.type,sourceLayerIndex:sourceLayerIndex,index:index,geometry:needGeometry?evaluationFeature.geometry:loadGeometry(feature),patterns:{},sortKey:sortKey};bucketFeatures.push(bucketFeature)}sortFeaturesByKey&&bucketFeatures.sort(((a,b)=>a.sortKey-b.sortKey));for(const bucketFeature of bucketFeatures){const{geometry:geometry,index:index,sourceLayerIndex:sourceLayerIndex}=bucketFeature,feature=features[index].feature;this.addFeature(bucketFeature,geometry,index,canonical),options.featureIndex.insert(feature,geometry,index,sourceLayerIndex,this.index)}}update(states,vtLayer,imagePositions){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(states,vtLayer,this.stateDependentLayers,imagePositions)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(context){this.uploaded||(this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,members$4),this.indexBuffer=context.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(context),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(feature,geometry,index,canonical){for(const ring of geometry)for(const point of ring){const x=point.x,y=point.y;if(x<0||x>=EXTENT||y<0||y>=EXTENT)continue;const segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,feature.sortKey),index=segment.vertexLength;addCircleVertex(this.layoutVertexArray,x,y,-1,-1),addCircleVertex(this.layoutVertexArray,x,y,1,-1),addCircleVertex(this.layoutVertexArray,x,y,1,1),addCircleVertex(this.layoutVertexArray,x,y,-1,1),this.indexArray.emplaceBack(index,index+1,index+2),this.indexArray.emplaceBack(index,index+3,index+2),segment.vertexLength+=4,segment.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,feature,index,{},canonical)}}function polygonIntersectsPolygon(polygonA,polygonB){for(let i=0;i<polygonA.length;i++)if(polygonContainsPoint(polygonB,polygonA[i]))return!0;for(let i=0;i<polygonB.length;i++)if(polygonContainsPoint(polygonA,polygonB[i]))return!0;return!!lineIntersectsLine(polygonA,polygonB)}function polygonIntersectsBufferedPoint(polygon,point,radius){return!!polygonContainsPoint(polygon,point)||!!pointIntersectsBufferedLine(point,polygon,radius)}function polygonIntersectsMultiPolygon(polygon,multiPolygon){if(1===polygon.length)return multiPolygonContainsPoint(multiPolygon,polygon[0]);for(let m=0;m<multiPolygon.length;m++){const ring=multiPolygon[m];for(let n=0;n<ring.length;n++)if(polygonContainsPoint(polygon,ring[n]))return!0}for(let i=0;i<polygon.length;i++)if(multiPolygonContainsPoint(multiPolygon,polygon[i]))return!0;for(let k=0;k<multiPolygon.length;k++)if(lineIntersectsLine(polygon,multiPolygon[k]))return!0;return!1}function lineIntersectsBufferedLine(lineA,lineB,radius){if(lineA.length>1){if(lineIntersectsLine(lineA,lineB))return!0;for(let j=0;j<lineB.length;j++)if(pointIntersectsBufferedLine(lineB[j],lineA,radius))return!0}for(let k=0;k<lineA.length;k++)if(pointIntersectsBufferedLine(lineA[k],lineB,radius))return!0;return!1}function lineIntersectsLine(lineA,lineB){if(0===lineA.length||0===lineB.length)return!1;for(let i=0;i<lineA.length-1;i++){const a0=lineA[i],a1=lineA[i+1];for(let j=0;j<lineB.length-1;j++){if(lineSegmentIntersectsLineSegment(a0,a1,lineB[j],lineB[j+1]))return!0}}return!1}function lineSegmentIntersectsLineSegment(a0,a1,b0,b1){return isCounterClockwise(a0,b0,b1)!==isCounterClockwise(a1,b0,b1)&&isCounterClockwise(a0,a1,b0)!==isCounterClockwise(a0,a1,b1)}function pointIntersectsBufferedLine(p,line,radius){const radiusSquared=radius*radius;if(1===line.length)return p.distSqr(line[0])<radiusSquared;for(let i=1;i<line.length;i++){if(distToSegmentSquared(p,line[i-1],line[i])<radiusSquared)return!0}return!1}function distToSegmentSquared(p,v,w){const l2=v.distSqr(w);if(0===l2)return p.distSqr(v);const t=((p.x-v.x)*(w.x-v.x)+(p.y-v.y)*(w.y-v.y))/l2;return t<0?p.distSqr(v):t>1?p.distSqr(w):p.distSqr(w.sub(v)._mult(t)._add(v))}function multiPolygonContainsPoint(rings,p){let ring,p1,p2,c=!1;for(let k=0;k<rings.length;k++){ring=rings[k];for(let i=0,j=ring.length-1;i<ring.length;j=i++)p1=ring[i],p2=ring[j],p1.y>p.y!=p2.y>p.y&&p.x<(p2.x-p1.x)*(p.y-p1.y)/(p2.y-p1.y)+p1.x&&(c=!c)}return c}function polygonContainsPoint(ring,p){let c=!1;for(let i=0,j=ring.length-1;i<ring.length;j=i++){const p1=ring[i],p2=ring[j];p1.y>p.y!=p2.y>p.y&&p.x<(p2.x-p1.x)*(p.y-p1.y)/(p2.y-p1.y)+p1.x&&(c=!c)}return c}function edgeIntersectsBox(e1,e2,corners){const tl=corners[0],br=corners[2];if(e1.x<tl.x&&e2.x<tl.x||e1.x>br.x&&e2.x>br.x||e1.y<tl.y&&e2.y<tl.y||e1.y>br.y&&e2.y>br.y)return!1;const dir=isCounterClockwise(e1,e2,corners[0]);return dir!==isCounterClockwise(e1,e2,corners[1])||dir!==isCounterClockwise(e1,e2,corners[2])||dir!==isCounterClockwise(e1,e2,corners[3])}function getMaximumPaintValue(property,layer,bucket){const value=layer.paint.get(property).value;return"constant"===value.kind?value.value:bucket.programConfigurations.get(layer.id).getMaxValue(property)}function translateDistance(translate){return Math.sqrt(translate[0]*translate[0]+translate[1]*translate[1])}function translate$4(queryGeometry,translate,translateAnchor,bearing,pixelsToTileUnits){if(!translate[0]&&!translate[1])return queryGeometry;const pt=Point$2.convert(translate)._mult(pixelsToTileUnits);"viewport"===translateAnchor&&pt._rotate(-bearing);const translated=[];for(let i=0;i<queryGeometry.length;i++){const point=queryGeometry[i];translated.push(point.sub(pt))}return translated}let layout$5;register("CircleBucket",CircleBucket,{omit:["layers"]});let paint$8;var properties$8={get paint(){return paint$8=paint$8||new Properties({"circle-radius":new DataDrivenProperty(v8Spec.paint_circle["circle-radius"]),"circle-color":new DataDrivenProperty(v8Spec.paint_circle["circle-color"]),"circle-blur":new DataDrivenProperty(v8Spec.paint_circle["circle-blur"]),"circle-opacity":new DataDrivenProperty(v8Spec.paint_circle["circle-opacity"]),"circle-translate":new DataConstantProperty(v8Spec.paint_circle["circle-translate"]),"circle-translate-anchor":new DataConstantProperty(v8Spec.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new DataConstantProperty(v8Spec.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new DataConstantProperty(v8Spec.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new DataDrivenProperty(v8Spec.paint_circle["circle-stroke-width"]),"circle-stroke-color":new DataDrivenProperty(v8Spec.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new DataDrivenProperty(v8Spec.paint_circle["circle-stroke-opacity"])})},get layout(){return layout$5=layout$5||new Properties({"circle-sort-key":new DataDrivenProperty(v8Spec.layout_circle["circle-sort-key"])})}},EPSILON=1e-6,ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array;Math.random;Math.PI;Math.hypot||(Math.hypot=function(){for(var y=0,i=arguments.length;i--;)y+=arguments[i]*arguments[i];return Math.sqrt(y)});function create$8(){var out=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(out[1]=0,out[2]=0),out[0]=1,out[3]=1,out}function rotate$4(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],s=Math.sin(rad),c=Math.cos(rad);return out[0]=a0*c+a2*s,out[1]=a1*c+a3*s,out[2]=a0*-s+a2*c,out[3]=a1*-s+a3*c,out}function create$6(){var out=new ARRAY_TYPE(9);return ARRAY_TYPE!=Float32Array&&(out[1]=0,out[2]=0,out[3]=0,out[5]=0,out[6]=0,out[7]=0),out[0]=1,out[4]=1,out[8]=1,out}function fromRotation$2(out,rad){var s=Math.sin(rad),c=Math.cos(rad);return out[0]=c,out[1]=s,out[2]=0,out[3]=-s,out[4]=c,out[5]=0,out[6]=0,out[7]=0,out[8]=1,out}function create$5(){var out=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[11]=0,out[12]=0,out[13]=0,out[14]=0),out[0]=1,out[5]=1,out[10]=1,out[15]=1,out}function clone$5(a){var out=new ARRAY_TYPE(16);return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out[4]=a[4],out[5]=a[5],out[6]=a[6],out[7]=a[7],out[8]=a[8],out[9]=a[9],out[10]=a[10],out[11]=a[11],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15],out}function copy$5(out,a){return out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out[4]=a[4],out[5]=a[5],out[6]=a[6],out[7]=a[7],out[8]=a[8],out[9]=a[9],out[10]=a[10],out[11]=a[11],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15],out}function identity$2(out){return out[0]=1,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=1,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=1,out[11]=0,out[12]=0,out[13]=0,out[14]=0,out[15]=1,out}function invert$2(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;return det?(det=1/det,out[0]=(a11*b11-a12*b10+a13*b09)*det,out[1]=(a02*b10-a01*b11-a03*b09)*det,out[2]=(a31*b05-a32*b04+a33*b03)*det,out[3]=(a22*b04-a21*b05-a23*b03)*det,out[4]=(a12*b08-a10*b11-a13*b07)*det,out[5]=(a00*b11-a02*b08+a03*b07)*det,out[6]=(a32*b02-a30*b05-a33*b01)*det,out[7]=(a20*b05-a22*b02+a23*b01)*det,out[8]=(a10*b10-a11*b08+a13*b06)*det,out[9]=(a01*b08-a00*b10-a03*b06)*det,out[10]=(a30*b04-a31*b02+a33*b00)*det,out[11]=(a21*b02-a20*b04-a23*b00)*det,out[12]=(a11*b07-a10*b09-a12*b06)*det,out[13]=(a00*b09-a01*b07+a02*b06)*det,out[14]=(a31*b01-a30*b03-a32*b00)*det,out[15]=(a20*b03-a21*b01+a22*b00)*det,out):null}function multiply$5(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b0=b[0],b1=b[1],b2=b[2],b3=b[3];return out[0]=b0*a00+b1*a10+b2*a20+b3*a30,out[1]=b0*a01+b1*a11+b2*a21+b3*a31,out[2]=b0*a02+b1*a12+b2*a22+b3*a32,out[3]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[4],b1=b[5],b2=b[6],b3=b[7],out[4]=b0*a00+b1*a10+b2*a20+b3*a30,out[5]=b0*a01+b1*a11+b2*a21+b3*a31,out[6]=b0*a02+b1*a12+b2*a22+b3*a32,out[7]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[8],b1=b[9],b2=b[10],b3=b[11],out[8]=b0*a00+b1*a10+b2*a20+b3*a30,out[9]=b0*a01+b1*a11+b2*a21+b3*a31,out[10]=b0*a02+b1*a12+b2*a22+b3*a32,out[11]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[12],b1=b[13],b2=b[14],b3=b[15],out[12]=b0*a00+b1*a10+b2*a20+b3*a30,out[13]=b0*a01+b1*a11+b2*a21+b3*a31,out[14]=b0*a02+b1*a12+b2*a22+b3*a32,out[15]=b0*a03+b1*a13+b2*a23+b3*a33,out}function translate$1(out,a,v){var a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,x=v[0],y=v[1],z=v[2];return a===out?(out[12]=a[0]*x+a[4]*y+a[8]*z+a[12],out[13]=a[1]*x+a[5]*y+a[9]*z+a[13],out[14]=a[2]*x+a[6]*y+a[10]*z+a[14],out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]):(a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],out[0]=a00,out[1]=a01,out[2]=a02,out[3]=a03,out[4]=a10,out[5]=a11,out[6]=a12,out[7]=a13,out[8]=a20,out[9]=a21,out[10]=a22,out[11]=a23,out[12]=a00*x+a10*y+a20*z+a[12],out[13]=a01*x+a11*y+a21*z+a[13],out[14]=a02*x+a12*y+a22*z+a[14],out[15]=a03*x+a13*y+a23*z+a[15]),out}function scale$5(out,a,v){var x=v[0],y=v[1],z=v[2];return out[0]=a[0]*x,out[1]=a[1]*x,out[2]=a[2]*x,out[3]=a[3]*x,out[4]=a[4]*y,out[5]=a[5]*y,out[6]=a[6]*y,out[7]=a[7]*y,out[8]=a[8]*z,out[9]=a[9]*z,out[10]=a[10]*z,out[11]=a[11]*z,out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15],out}function rotateX$3(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11];return a!==out&&(out[0]=a[0],out[1]=a[1],out[2]=a[2],out[3]=a[3],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15]),out[4]=a10*c+a20*s,out[5]=a11*c+a21*s,out[6]=a12*c+a22*s,out[7]=a13*c+a23*s,out[8]=a20*c-a10*s,out[9]=a21*c-a11*s,out[10]=a22*c-a12*s,out[11]=a23*c-a13*s,out}function rotateZ$3(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];return a!==out&&(out[8]=a[8],out[9]=a[9],out[10]=a[10],out[11]=a[11],out[12]=a[12],out[13]=a[13],out[14]=a[14],out[15]=a[15]),out[0]=a00*c+a10*s,out[1]=a01*c+a11*s,out[2]=a02*c+a12*s,out[3]=a03*c+a13*s,out[4]=a10*c-a00*s,out[5]=a11*c-a01*s,out[6]=a12*c-a02*s,out[7]=a13*c-a03*s,out}function fromScaling(out,v){return out[0]=v[0],out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=v[1],out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=v[2],out[11]=0,out[12]=0,out[13]=0,out[14]=0,out[15]=1,out}function perspectiveNO(out,fovy,aspect,near,far){var nf,f=1/Math.tan(fovy/2);return out[0]=f/aspect,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=f,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[11]=-1,out[12]=0,out[13]=0,out[15]=0,null!=far&&far!==1/0?(nf=1/(near-far),out[10]=(far+near)*nf,out[14]=2*far*near*nf):(out[10]=-1,out[14]=-2*near),out}var perspective=perspectiveNO;function orthoNO(out,left,right,bottom,top,near,far){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);return out[0]=-2*lr,out[1]=0,out[2]=0,out[3]=0,out[4]=0,out[5]=-2*bt,out[6]=0,out[7]=0,out[8]=0,out[9]=0,out[10]=2*nf,out[11]=0,out[12]=(left+right)*lr,out[13]=(top+bottom)*bt,out[14]=(far+near)*nf,out[15]=1,out}var ortho=orthoNO;function equals$6(a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5],a6=a[6],a7=a[7],a8=a[8],a9=a[9],a10=a[10],a11=a[11],a12=a[12],a13=a[13],a14=a[14],a15=a[15],b0=b[0],b1=b[1],b2=b[2],b3=b[3],b4=b[4],b5=b[5],b6=b[6],b7=b[7],b8=b[8],b9=b[9],b10=b[10],b11=b[11],b12=b[12],b13=b[13],b14=b[14],b15=b[15];return Math.abs(a0-b0)<=EPSILON*Math.max(1,Math.abs(a0),Math.abs(b0))&&Math.abs(a1-b1)<=EPSILON*Math.max(1,Math.abs(a1),Math.abs(b1))&&Math.abs(a2-b2)<=EPSILON*Math.max(1,Math.abs(a2),Math.abs(b2))&&Math.abs(a3-b3)<=EPSILON*Math.max(1,Math.abs(a3),Math.abs(b3))&&Math.abs(a4-b4)<=EPSILON*Math.max(1,Math.abs(a4),Math.abs(b4))&&Math.abs(a5-b5)<=EPSILON*Math.max(1,Math.abs(a5),Math.abs(b5))&&Math.abs(a6-b6)<=EPSILON*Math.max(1,Math.abs(a6),Math.abs(b6))&&Math.abs(a7-b7)<=EPSILON*Math.max(1,Math.abs(a7),Math.abs(b7))&&Math.abs(a8-b8)<=EPSILON*Math.max(1,Math.abs(a8),Math.abs(b8))&&Math.abs(a9-b9)<=EPSILON*Math.max(1,Math.abs(a9),Math.abs(b9))&&Math.abs(a10-b10)<=EPSILON*Math.max(1,Math.abs(a10),Math.abs(b10))&&Math.abs(a11-b11)<=EPSILON*Math.max(1,Math.abs(a11),Math.abs(b11))&&Math.abs(a12-b12)<=EPSILON*Math.max(1,Math.abs(a12),Math.abs(b12))&&Math.abs(a13-b13)<=EPSILON*Math.max(1,Math.abs(a13),Math.abs(b13))&&Math.abs(a14-b14)<=EPSILON*Math.max(1,Math.abs(a14),Math.abs(b14))&&Math.abs(a15-b15)<=EPSILON*Math.max(1,Math.abs(a15),Math.abs(b15))}var mul$5=multiply$5;function create$4(){var out=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0,out[2]=0),out}function clone$4(a){var out=new ARRAY_TYPE(3);return out[0]=a[0],out[1]=a[1],out[2]=a[2],out}function length$4(a){var x=a[0],y=a[1],z=a[2];return Math.hypot(x,y,z)}function fromValues$4(x,y,z){var out=new ARRAY_TYPE(3);return out[0]=x,out[1]=y,out[2]=z,out}function add$4(out,a,b){return out[0]=a[0]+b[0],out[1]=a[1]+b[1],out[2]=a[2]+b[2],out}function subtract$2(out,a,b){return out[0]=a[0]-b[0],out[1]=a[1]-b[1],out[2]=a[2]-b[2],out}function scale$4(out,a,b){return out[0]=a[0]*b,out[1]=a[1]*b,out[2]=a[2]*b,out}function normalize$4(out,a){var x=a[0],y=a[1],z=a[2],len=x*x+y*y+z*z;return len>0&&(len=1/Math.sqrt(len)),out[0]=a[0]*len,out[1]=a[1]*len,out[2]=a[2]*len,out}function dot$5(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]}function cross$2(out,a,b){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];return out[0]=ay*bz-az*by,out[1]=az*bx-ax*bz,out[2]=ax*by-ay*bx,out}function transformMat3$1(out,a,m){var x=a[0],y=a[1],z=a[2];return out[0]=x*m[0]+y*m[3]+z*m[6],out[1]=x*m[1]+y*m[4]+z*m[7],out[2]=x*m[2]+y*m[5]+z*m[8],out}var vec,sub$2=subtract$2,len$4=length$4;vec=create$4();function create$3(){var out=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0,out[2]=0,out[3]=0),out}function multiply$3(out,a,b){return out[0]=a[0]*b[0],out[1]=a[1]*b[1],out[2]=a[2]*b[2],out[3]=a[3]*b[3],out}function normalize$3(out,a){var x=a[0],y=a[1],z=a[2],w=a[3],len=x*x+y*y+z*z+w*w;return len>0&&(len=1/Math.sqrt(len)),out[0]=x*len,out[1]=y*len,out[2]=z*len,out[3]=w*len,out}function dot$4(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]}function transformMat4$1(out,a,m){var x=a[0],y=a[1],z=a[2],w=a[3];return out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w,out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w,out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w,out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w,out}var mul$3=multiply$3;!function(){var vec=create$3()}();function create$2(){var out=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0,out[2]=0),out[3]=1,out}function setAxisAngle(out,axis,rad){.5;var s=Math.sin(rad);return out[0]=s*axis[0],out[1]=s*axis[1],out[2]=s*axis[2],out[3]=Math.cos(rad),out}function slerp(out,a,b,t){var omega,cosom,sinom,scale0,scale1,ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];return ax*bx+ay*by+az*bz+aw*bw<0&&(-cosom,-bx,-by,-bz,-bw),1-cosom>EPSILON?(Math.acos(cosom),Math.sin(omega),Math.sin((1-t)*omega)/sinom,Math.sin(t*omega)/sinom):(1-t,t),out[0]=scale0*ax+scale1*bx,out[1]=scale0*ay+scale1*by,out[2]=scale0*az+scale1*bz,out[3]=scale0*aw+scale1*bw,out}function fromMat3(out,m){var fRoot,fTrace=m[0]+m[4]+m[8];if(fTrace>0)Math.sqrt(fTrace+1),out[3]=.5*fRoot,.5/fRoot,out[0]=(m[5]-m[7])*fRoot,out[1]=(m[6]-m[2])*fRoot,out[2]=(m[1]-m[3])*fRoot;else{var i=0;m[4]>m[0]&&1,m[8]>m[3*i+i]&&2;var j=(i+1)%3,k=(i+2)%3;Math.sqrt(m[3*i+i]-m[3*j+j]-m[3*k+k]+1),out[i]=.5*fRoot,.5/fRoot,out[3]=(m[3*j+k]-m[3*k+j])*fRoot,out[j]=(m[3*j+i]+m[3*i+j])*fRoot,out[k]=(m[3*k+i]+m[3*i+k])*fRoot}return out}var tmpvec3,xUnitVec3,yUnitVec3,temp1,temp2,matr,normalize$2=normalize$3;tmpvec3=create$4(),xUnitVec3=fromValues$4(1,0,0),yUnitVec3=fromValues$4(0,1,0),temp1=create$2(),temp2=create$2(),matr=create$6();function create(){var out=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(out[0]=0,out[1]=0),out}function squaredLength(a){var x=a[0],y=a[1];return x*x+y*y}function transformMat4(out,a,m){var x=a[0],y=a[1];return out[0]=m[0]*x+m[4]*y+m[12],out[1]=m[1]*x+m[5]*y+m[13],out}var sqrLen=squaredLength;!function(){var vec=create()}();class CircleStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$8)}createBucket(parameters){return new CircleBucket(parameters)}queryRadius(bucket){const circleBucket=bucket;return getMaximumPaintValue("circle-radius",this,circleBucket)+getMaximumPaintValue("circle-stroke-width",this,circleBucket)+translateDistance(this.paint.get("circle-translate"))}queryIntersectsFeature(queryGeometry,feature,featureState,geometry,zoom,transform,pixelsToTileUnits,pixelPosMatrix){const translatedPolygon=translate$4(queryGeometry,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),transform.angle,pixelsToTileUnits),size=this.paint.get("circle-radius").evaluate(feature,featureState)+this.paint.get("circle-stroke-width").evaluate(feature,featureState),alignWithMap="map"===this.paint.get("circle-pitch-alignment"),transformedPolygon=alignWithMap?translatedPolygon:function(queryGeometry,pixelPosMatrix){return queryGeometry.map((p=>projectPoint(p,pixelPosMatrix)))}(translatedPolygon,pixelPosMatrix),transformedSize=alignWithMap?size*pixelsToTileUnits:size;for(const ring of geometry)for(const point of ring){const transformedPoint=alignWithMap?point:projectPoint(point,pixelPosMatrix);let adjustedSize=transformedSize;const projectedCenter=transformMat4$1([],[point.x,point.y,0,1],pixelPosMatrix);if("viewport"===this.paint.get("circle-pitch-scale")&&"map"===this.paint.get("circle-pitch-alignment")?adjustedSize*=projectedCenter[3]/transform.cameraToCenterDistance:"map"===this.paint.get("circle-pitch-scale")&&"viewport"===this.paint.get("circle-pitch-alignment")&&(adjustedSize*=transform.cameraToCenterDistance/projectedCenter[3]),polygonIntersectsBufferedPoint(transformedPolygon,transformedPoint,adjustedSize))return!0}return!1}}function projectPoint(p,pixelPosMatrix){const point=transformMat4$1([],[p.x,p.y,0,1],pixelPosMatrix);return new Point$2(point[0]/point[3],point[1]/point[3])}class HeatmapBucket extends CircleBucket{}let paint$7;register("HeatmapBucket",HeatmapBucket,{omit:["layers"]});var properties$7={get paint(){return paint$7=paint$7||new Properties({"heatmap-radius":new DataDrivenProperty(v8Spec.paint_heatmap["heatmap-radius"]),"heatmap-weight":new DataDrivenProperty(v8Spec.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new DataConstantProperty(v8Spec.paint_heatmap["heatmap-intensity"]),"heatmap-color":new ColorRampProperty(v8Spec.paint_heatmap["heatmap-color"]),"heatmap-opacity":new DataConstantProperty(v8Spec.paint_heatmap["heatmap-opacity"])})}};function createImage(image,{width:width,height:height},channels,data){if(data){if(data instanceof Uint8ClampedArray)data=new Uint8Array(data.buffer);else if(data.length!==width*height*channels)throw new RangeError(`mismatched image size. expected: ${data.length} but got: ${width*height*channels}`)}else data=new Uint8Array(width*height*channels);return image.width=width,image.height=height,image.data=data,image}function resizeImage(image,{width:width,height:height},channels){if(width===image.width&&height===image.height)return;const newImage=createImage({},{width:width,height:height},channels);copyImage(image,newImage,{x:0,y:0},{x:0,y:0},{width:Math.min(image.width,width),height:Math.min(image.height,height)},channels),image.width=width,image.height=height,image.data=newImage.data}function copyImage(srcImg,dstImg,srcPt,dstPt,size,channels){if(0===size.width||0===size.height)return dstImg;if(size.width>srcImg.width||size.height>srcImg.height||srcPt.x>srcImg.width-size.width||srcPt.y>srcImg.height-size.height)throw new RangeError("out of range source coordinates for image copy");if(size.width>dstImg.width||size.height>dstImg.height||dstPt.x>dstImg.width-size.width||dstPt.y>dstImg.height-size.height)throw new RangeError("out of range destination coordinates for image copy");const srcData=srcImg.data,dstData=dstImg.data;if(srcData===dstData)throw new Error("srcData equals dstData, so image is already copied");for(let y=0;y<size.height;y++){const srcOffset=((srcPt.y+y)*srcImg.width+srcPt.x)*channels,dstOffset=((dstPt.y+y)*dstImg.width+dstPt.x)*channels;for(let i=0;i<size.width*channels;i++)dstData[dstOffset+i]=srcData[srcOffset+i]}return dstImg}class AlphaImage{constructor(size,data){createImage(this,size,1,data)}resize(size){resizeImage(this,size,1)}clone(){return new AlphaImage({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(srcImg,dstImg,srcPt,dstPt,size){copyImage(srcImg,dstImg,srcPt,dstPt,size,1)}}class RGBAImage{constructor(size,data){createImage(this,size,4,data)}resize(size){resizeImage(this,size,4)}replace(data,copy){copy?this.data.set(data):data instanceof Uint8ClampedArray?this.data=new Uint8Array(data.buffer):this.data=data}clone(){return new RGBAImage({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(srcImg,dstImg,srcPt,dstPt,size){copyImage(srcImg,dstImg,srcPt,dstPt,size,4)}}function renderColorRamp(params){const evaluationGlobals={},width=params.resolution||256,height=params.clips?params.clips.length:1,image=params.image||new RGBAImage({width:width,height:height});if(value=width,Math.log(value)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${width}`);var value;const renderPixel=(stride,index,progress)=>{evaluationGlobals[params.evaluationKey]=progress;const pxColor=params.expression.evaluate(evaluationGlobals);image.data[stride+index+0]=Math.floor(255*pxColor.r/pxColor.a),image.data[stride+index+1]=Math.floor(255*pxColor.g/pxColor.a),image.data[stride+index+2]=Math.floor(255*pxColor.b/pxColor.a),image.data[stride+index+3]=Math.floor(255*pxColor.a)};if(params.clips)for(let clip=0,stride=0;clip<height;++clip,stride+=4*width)for(let i=0,j=0;i<width;i++,j+=4){const progress=i/(width-1),{start:start,end:end}=params.clips[clip];renderPixel(stride,j,start*(1-progress)+end*progress)}else for(let i=0,j=0;i<width;i++,j+=4){renderPixel(0,j,i/(width-1))}return image}register("AlphaImage",AlphaImage),register("RGBAImage",RGBAImage);class HeatmapStyleLayer extends StyleLayer{createBucket(options){return new HeatmapBucket(options)}constructor(layer){super(layer,properties$7),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(name){"heatmap-color"===name&&this._updateColorRamp()}_updateColorRamp(){const expression=this._transitionablePaint._values["heatmap-color"].value.expression;this.colorRamp=renderColorRamp({expression:expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}}let paint$6;var properties$6={get paint(){return paint$6=paint$6||new Properties({"hillshade-illumination-direction":new DataConstantProperty(v8Spec.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new DataConstantProperty(v8Spec.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new DataConstantProperty(v8Spec.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new DataConstantProperty(v8Spec.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new DataConstantProperty(v8Spec.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new DataConstantProperty(v8Spec.paint_hillshade["hillshade-accent-color"])})}};class HillshadeStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$6)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}}const layout$4=createLayout([{name:"a_pos",components:2,type:"Int16"}],4),{members:members$3,size:size$3,alignment:alignment$3}=layout$4;var earcut$2={exports:{}};earcut$2.exports;earcut$2.exports=earcut;earcut$2.exports.default=earcut;function earcut(data,holeIndices,dim){dim=dim||2;var minX,minY,maxX,maxY,x,y,invSize,hasHoles=holeIndices&&holeIndices.length,outerLen=hasHoles?holeIndices[0]*dim:data.length,outerNode=linkedList(data,0,outerLen,dim,!0),triangles=[];if(!outerNode||outerNode.next===outerNode.prev)return triangles;if(hasHoles&&(outerNode=function(data,holeIndices,outerNode,dim){var i,len,list,queue=[];for(i=0,len=holeIndices.length;i<len;i++)(list=linkedList(data,holeIndices[i]*dim,i<len-1?holeIndices[i+1]*dim:data.length,dim,!1))===list.next&&(list.steiner=!0),queue.push(getLeftmost(list));for(queue.sort(compareX),i=0;i<queue.length;i++)outerNode=eliminateHole(queue[i],outerNode);return outerNode}(data,holeIndices,outerNode,dim)),data.length>80*dim){minX=maxX=data[0],minY=maxY=data[1];for(var i=dim;i<outerLen;i+=dim)(x=data[i])<minX&&(minX=x),(y=data[i+1])<minY&&(minY=y),x>maxX&&(maxX=x),y>maxY&&(maxY=y);invSize=0!==(invSize=Math.max(maxX-minX,maxY-minY))?32767/invSize:0}return earcutLinked(outerNode,triangles,dim,minX,minY,invSize,0),triangles}function linkedList(data,start,end,dim,clockwise){var i,last;if(clockwise===signedArea$1(data,start,end,dim)>0)for(i=start;i<end;i+=dim)last=insertNode(i,data[i],data[i+1],last);else for(i=end-dim;i>=start;i-=dim)last=insertNode(i,data[i],data[i+1],last);return last&&equals(last,last.next)&&(removeNode(last),last=last.next),last}function filterPoints(start,end){if(!start)return start;end||(end=start);var again,p=start;do{if(again=!1,p.steiner||!equals(p,p.next)&&0!==area(p.prev,p,p.next))p=p.next;else{if(removeNode(p),(p=end=p.prev)===p.next)break;again=!0}}while(again||p!==end);return end}function earcutLinked(ear,triangles,dim,minX,minY,invSize,pass){if(ear){!pass&&invSize&&function(start,minX,minY,invSize){var p=start;do{0===p.z&&(p.z=zOrder(p.x,p.y,minX,minY,invSize)),p.prevZ=p.prev,p.nextZ=p.next,p=p.next}while(p!==start);p.prevZ.nextZ=null,p.prevZ=null,function(list){var i,p,q,e,tail,numMerges,pSize,qSize,inSize=1;do{for(p=list,list=null,tail=null,numMerges=0;p;){for(numMerges++,q=p,pSize=0,i=0;i<inSize&&(pSize++,q=q.nextZ);i++);for(qSize=inSize;pSize>0||qSize>0&&q;)0!==pSize&&(0===qSize||!q||p.z<=q.z)?(e=p,p=p.nextZ,pSize--):(e=q,q=q.nextZ,qSize--),tail?tail.nextZ=e:list=e,e.prevZ=tail,tail=e;p=q}tail.nextZ=null,inSize*=2}while(numMerges>1)}(p)}(ear,minX,minY,invSize);for(var prev,next,stop=ear;ear.prev!==ear.next;)if(prev=ear.prev,next=ear.next,invSize?isEarHashed(ear,minX,minY,invSize):isEar(ear))triangles.push(prev.i/dim|0),triangles.push(ear.i/dim|0),triangles.push(next.i/dim|0),removeNode(ear),ear=next.next,stop=next.next;else if((ear=next)===stop){pass?1===pass?earcutLinked(ear=cureLocalIntersections(filterPoints(ear),triangles,dim),triangles,dim,minX,minY,invSize,2):2===pass&&splitEarcut(ear,triangles,dim,minX,minY,invSize):earcutLinked(filterPoints(ear),triangles,dim,minX,minY,invSize,1);break}}}function isEar(ear){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return!1;for(var ax=a.x,bx=b.x,cx=c.x,ay=a.y,by=b.y,cy=c.y,x0=ax<bx?ax<cx?ax:cx:bx<cx?bx:cx,y0=ay<by?ay<cy?ay:cy:by<cy?by:cy,x1=ax>bx?ax>cx?ax:cx:bx>cx?bx:cx,y1=ay>by?ay>cy?ay:cy:by>cy?by:cy,p=c.next;p!==a;){if(p.x>=x0&&p.x<=x1&&p.y>=y0&&p.y<=y1&&pointInTriangle(ax,ay,bx,by,cx,cy,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function isEarHashed(ear,minX,minY,invSize){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return!1;for(var ax=a.x,bx=b.x,cx=c.x,ay=a.y,by=b.y,cy=c.y,x0=ax<bx?ax<cx?ax:cx:bx<cx?bx:cx,y0=ay<by?ay<cy?ay:cy:by<cy?by:cy,x1=ax>bx?ax>cx?ax:cx:bx>cx?bx:cx,y1=ay>by?ay>cy?ay:cy:by>cy?by:cy,minZ=zOrder(x0,y0,minX,minY,invSize),maxZ=zOrder(x1,y1,minX,minY,invSize),p=ear.prevZ,n=ear.nextZ;p&&p.z>=minZ&&n&&n.z<=maxZ;){if(p.x>=x0&&p.x<=x1&&p.y>=y0&&p.y<=y1&&p!==a&&p!==c&&pointInTriangle(ax,ay,bx,by,cx,cy,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,n.x>=x0&&n.x<=x1&&n.y>=y0&&n.y<=y1&&n!==a&&n!==c&&pointInTriangle(ax,ay,bx,by,cx,cy,n.x,n.y)&&area(n.prev,n,n.next)>=0)return!1;n=n.nextZ}for(;p&&p.z>=minZ;){if(p.x>=x0&&p.x<=x1&&p.y>=y0&&p.y<=y1&&p!==a&&p!==c&&pointInTriangle(ax,ay,bx,by,cx,cy,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;n&&n.z<=maxZ;){if(n.x>=x0&&n.x<=x1&&n.y>=y0&&n.y<=y1&&n!==a&&n!==c&&pointInTriangle(ax,ay,bx,by,cx,cy,n.x,n.y)&&area(n.prev,n,n.next)>=0)return!1;n=n.nextZ}return!0}function cureLocalIntersections(start,triangles,dim){var p=start;do{var a=p.prev,b=p.next.next;!equals(a,b)&&intersects(a,p,p.next,b)&&locallyInside(a,b)&&locallyInside(b,a)&&(triangles.push(a.i/dim|0),triangles.push(p.i/dim|0),triangles.push(b.i/dim|0),removeNode(p),removeNode(p.next),p=start=b),p=p.next}while(p!==start);return filterPoints(p)}function splitEarcut(start,triangles,dim,minX,minY,invSize){var a=start;do{for(var b=a.next.next;b!==a.prev;){if(a.i!==b.i&&isValidDiagonal(a,b)){var c=splitPolygon(a,b);return a=filterPoints(a,a.next),c=filterPoints(c,c.next),earcutLinked(a,triangles,dim,minX,minY,invSize,0),void earcutLinked(c,triangles,dim,minX,minY,invSize,0)}b=b.next}a=a.next}while(a!==start)}function compareX(a,b){return a.x-b.x}function eliminateHole(hole,outerNode){var bridge=function(hole,outerNode){var m,p=outerNode,hx=hole.x,hy=hole.y,qx=-1/0;do{if(hy<=p.y&&hy>=p.next.y&&p.next.y!==p.y){var x=p.x+(hy-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(x<=hx&&x>qx&&(qx=x,m=p.x<p.next.x?p:p.next,x===hx))return m}p=p.next}while(p!==outerNode);if(!m)return null;var tan,stop=m,mx=m.x,my=m.y,tanMin=1/0;p=m;do{hx>=p.x&&p.x>=mx&&hx!==p.x&&pointInTriangle(hy<my?hx:qx,hy,mx,my,hy<my?qx:hx,hy,p.x,p.y)&&(tan=Math.abs(hy-p.y)/(hx-p.x),locallyInside(p,hole)&&(tan<tanMin||tan===tanMin&&(p.x>m.x||p.x===m.x&&sectorContainsSector(m,p)))&&(m=p,tanMin=tan)),p=p.next}while(p!==stop);return m}(hole,outerNode);if(!bridge)return outerNode;var bridgeReverse=splitPolygon(bridge,hole);return filterPoints(bridgeReverse,bridgeReverse.next),filterPoints(bridge,bridge.next)}function sectorContainsSector(m,p){return area(m.prev,m,p.prev)<0&&area(p.next,m,m.next)<0}function zOrder(x,y,minX,minY,invSize){return(x=1431655765&((x=858993459&((x=252645135&((x=16711935&((x=(x-minX)*invSize|0)|x<<8))|x<<4))|x<<2))|x<<1))|(y=1431655765&((y=858993459&((y=252645135&((y=16711935&((y=(y-minY)*invSize|0)|y<<8))|y<<4))|y<<2))|y<<1))<<1}function getLeftmost(start){var p=start,leftmost=start;do{(p.x<leftmost.x||p.x===leftmost.x&&p.y<leftmost.y)&&(leftmost=p),p=p.next}while(p!==start);return leftmost}function pointInTriangle(ax,ay,bx,by,cx,cy,px,py){return(cx-px)*(ay-py)>=(ax-px)*(cy-py)&&(ax-px)*(by-py)>=(bx-px)*(ay-py)&&(bx-px)*(cy-py)>=(cx-px)*(by-py)}function isValidDiagonal(a,b){return a.next.i!==b.i&&a.prev.i!==b.i&&!function(a,b){var p=a;do{if(p.i!==a.i&&p.next.i!==a.i&&p.i!==b.i&&p.next.i!==b.i&&intersects(p,p.next,a,b))return!0;p=p.next}while(p!==a);return!1}(a,b)&&(locallyInside(a,b)&&locallyInside(b,a)&&function(a,b){var p=a,inside=!1,px=(a.x+b.x)/2,py=(a.y+b.y)/2;do{p.y>py!=p.next.y>py&&p.next.y!==p.y&&px<(p.next.x-p.x)*(py-p.y)/(p.next.y-p.y)+p.x&&(inside=!inside),p=p.next}while(p!==a);return inside}(a,b)&&(area(a.prev,a,b.prev)||area(a,b.prev,b))||equals(a,b)&&area(a.prev,a,a.next)>0&&area(b.prev,b,b.next)>0)}function area(p,q,r){return(q.y-p.y)*(r.x-q.x)-(q.x-p.x)*(r.y-q.y)}function equals(p1,p2){return p1.x===p2.x&&p1.y===p2.y}function intersects(p1,q1,p2,q2){var o1=sign(area(p1,q1,p2)),o2=sign(area(p1,q1,q2)),o3=sign(area(p2,q2,p1)),o4=sign(area(p2,q2,q1));return o1!==o2&&o3!==o4||(!(0!==o1||!onSegment(p1,p2,q1))||(!(0!==o2||!onSegment(p1,q2,q1))||(!(0!==o3||!onSegment(p2,p1,q2))||!(0!==o4||!onSegment(p2,q1,q2)))))}function onSegment(p,q,r){return q.x<=Math.max(p.x,r.x)&&q.x>=Math.min(p.x,r.x)&&q.y<=Math.max(p.y,r.y)&&q.y>=Math.min(p.y,r.y)}function sign(num){return num>0?1:num<0?-1:0}function locallyInside(a,b){return area(a.prev,a,a.next)<0?area(a,b,a.next)>=0&&area(a,a.prev,b)>=0:area(a,b,a.prev)<0||area(a,a.next,b)<0}function splitPolygon(a,b){var a2=new Node(a.i,a.x,a.y),b2=new Node(b.i,b.x,b.y),an=a.next,bp=b.prev;return a.next=b,b.prev=a,a2.next=an,an.prev=a2,b2.next=a2,a2.prev=b2,bp.next=b2,b2.prev=bp,b2}function insertNode(i,x,y,last){var p=new Node(i,x,y);return last?(p.next=last.next,p.prev=last,last.next.prev=p,last.next=p):(p.prev=p,p.next=p),p}function removeNode(p){p.next.prev=p.prev,p.prev.next=p.next,p.prevZ&&(p.prevZ.nextZ=p.nextZ),p.nextZ&&(p.nextZ.prevZ=p.prevZ)}function Node(i,x,y){this.i=i,this.x=x,this.y=y,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function signedArea$1(data,start,end,dim){for(var sum=0,i=start,j=end-dim;i<end;i+=dim)sum+=(data[j]-data[i])*(data[i+1]+data[j+1]),j=i;return sum}earcut.deviation=function(data,holeIndices,dim,triangles){var hasHoles=holeIndices&&holeIndices.length,outerLen=hasHoles?holeIndices[0]*dim:data.length,polygonArea=Math.abs(signedArea$1(data,0,outerLen,dim));if(hasHoles)for(var i=0,len=holeIndices.length;i<len;i++){var start=holeIndices[i]*dim,end=i<len-1?holeIndices[i+1]*dim:data.length;polygonArea-=Math.abs(signedArea$1(data,start,end,dim))}var trianglesArea=0;for(i=0;i<triangles.length;i+=3){var a=triangles[i]*dim,b=triangles[i+1]*dim,c=triangles[i+2]*dim;trianglesArea+=Math.abs((data[a]-data[c])*(data[b+1]-data[a+1])-(data[a]-data[b])*(data[c+1]-data[a+1]))}return 0===polygonArea&&0===trianglesArea?0:Math.abs((trianglesArea-polygonArea)/polygonArea)},earcut.flatten=function(data){for(var dim=data[0][0].length,result={vertices:[],holes:[],dimensions:dim},holeIndex=0,i=0;i<data.length;i++){for(var j=0;j<data[i].length;j++)for(var d=0;d<dim;d++)result.vertices.push(data[i][j][d]);i>0&&(holeIndex+=data[i-1].length,result.holes.push(holeIndex))}return result};var earcut$1=getDefaultExportFromCjs$1(earcut$2.exports);function quickselect(arr,k,left,right,compare){quickselectStep(arr,k,left||0,right||arr.length-1,compare||defaultCompare$1)}function quickselectStep(arr,k,left,right,compare){for(;right>left;){if(right-left>600){var n=right-left+1,m=k-left+1,z=Math.log(n),s=.5*Math.exp(2*z/3),sd=.5*Math.sqrt(z*s*(n-s)/n)*(m-n/2<0?-1:1);quickselectStep(arr,k,Math.max(left,Math.floor(k-m*s/n+sd)),Math.min(right,Math.floor(k+(n-m)*s/n+sd)),compare)}var t=arr[k],i=left,j=right;for(swap$1(arr,left,k),compare(arr[right],t)>0&&swap$1(arr,left,right);i<j;){for(swap$1(arr,i,j),i++,j--;compare(arr[i],t)<0;)i++;for(;compare(arr[j],t)>0;)j--}0===compare(arr[left],t)?swap$1(arr,left,j):swap$1(arr,++j,right),j<=k&&(left=j+1),k<=j&&(right=j-1)}}function swap$1(arr,i,j){var tmp=arr[i];arr[i]=arr[j],arr[j]=tmp}function defaultCompare$1(a,b){return a<b?-1:a>b?1:0}function classifyRings$1(rings,maxRings){const len=rings.length;if(len<=1)return[rings];const polygons=[];let polygon,ccw;for(let i=0;i<len;i++){const area=calculateSignedArea(rings[i]);0!==area&&(rings[i].area=Math.abs(area),void 0===ccw&&(ccw=area<0),ccw===area<0?(polygon&&polygons.push(polygon),polygon=[rings[i]]):polygon.push(rings[i]))}if(polygon&&polygons.push(polygon),maxRings>1)for(let j=0;j<polygons.length;j++)polygons[j].length<=maxRings||(quickselect(polygons[j],maxRings,1,polygons[j].length-1,compareAreas),polygons[j]=polygons[j].slice(0,maxRings));return polygons}function compareAreas(a,b){return b.area-a.area}function hasPattern(type,layers,options){const patterns=options.patternDependencies;let hasPattern=!1;for(const layer of layers){const patternProperty=layer.paint.get(`${type}-pattern`);patternProperty.isConstant()||(hasPattern=!0);const constantPattern=patternProperty.constantOr(null);constantPattern&&(hasPattern=!0,patterns[constantPattern.to]=!0,patterns[constantPattern.from]=!0)}return hasPattern}function addPatternDependencies(type,layers,patternFeature,zoom,options){const patterns=options.patternDependencies;for(const layer of layers){const patternPropertyValue=layer.paint.get(`${type}-pattern`).value;if("constant"!==patternPropertyValue.kind){let min=patternPropertyValue.evaluate({zoom:zoom-1},patternFeature,{},options.availableImages),mid=patternPropertyValue.evaluate({zoom:zoom},patternFeature,{},options.availableImages),max=patternPropertyValue.evaluate({zoom:zoom+1},patternFeature,{},options.availableImages);min=min&&min.name?min.name:min,mid=mid&&mid.name?mid.name:mid,max=max&&max.name?max.name:max,patterns[min]=!0,patterns[mid]=!0,patterns[max]=!0,patternFeature.patterns[layer.id]={min:min,mid:mid,max:max}}}return patternFeature}class FillBucket{constructor(options){this.zoom=options.zoom,this.overscaling=options.overscaling,this.layers=options.layers,this.layerIds=this.layers.map((layer=>layer.id)),this.index=options.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new FillLayoutArray,this.indexArray=new TriangleIndexArray,this.indexArray2=new LineIndexArray,this.programConfigurations=new ProgramConfigurationSet(options.layers,options.zoom),this.segments=new SegmentVector,this.segments2=new SegmentVector,this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id))}populate(features,options,canonical){this.hasPattern=hasPattern("fill",this.layers,options);const fillSortKey=this.layers[0].layout.get("fill-sort-key"),sortFeaturesByKey=!fillSortKey.isConstant(),bucketFeatures=[];for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=this.layers[0]._featureFilter.needGeometry,evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!this.layers[0]._featureFilter.filter(new EvaluationParameters(this.zoom),evaluationFeature,canonical))continue;const sortKey=sortFeaturesByKey?fillSortKey.evaluate(evaluationFeature,{},canonical,options.availableImages):void 0,bucketFeature={id:id,properties:feature.properties,type:feature.type,sourceLayerIndex:sourceLayerIndex,index:index,geometry:needGeometry?evaluationFeature.geometry:loadGeometry(feature),patterns:{},sortKey:sortKey};bucketFeatures.push(bucketFeature)}sortFeaturesByKey&&bucketFeatures.sort(((a,b)=>a.sortKey-b.sortKey));for(const bucketFeature of bucketFeatures){const{geometry:geometry,index:index,sourceLayerIndex:sourceLayerIndex}=bucketFeature;if(this.hasPattern){const patternFeature=addPatternDependencies("fill",this.layers,bucketFeature,this.zoom,options);this.patternFeatures.push(patternFeature)}else this.addFeature(bucketFeature,geometry,index,canonical,{});const feature=features[index].feature;options.featureIndex.insert(feature,geometry,index,sourceLayerIndex,this.index)}}update(states,vtLayer,imagePositions){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(states,vtLayer,this.stateDependentLayers,imagePositions)}addFeatures(options,canonical,imagePositions){for(const feature of this.patternFeatures)this.addFeature(feature,feature.geometry,feature.index,canonical,imagePositions)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(context){this.uploaded||(this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,members$3),this.indexBuffer=context.createIndexBuffer(this.indexArray),this.indexBuffer2=context.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(context),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(feature,geometry,index,canonical,imagePositions){for(const polygon of classifyRings$1(geometry,500)){let numVertices=0;for(const ring of polygon)numVertices+=ring.length;const triangleSegment=this.segments.prepareSegment(numVertices,this.layoutVertexArray,this.indexArray),triangleIndex=triangleSegment.vertexLength,flattened=[],holeIndices=[];for(const ring of polygon){if(0===ring.length)continue;ring!==polygon[0]&&holeIndices.push(flattened.length/2);const lineSegment=this.segments2.prepareSegment(ring.length,this.layoutVertexArray,this.indexArray2),lineIndex=lineSegment.vertexLength;this.layoutVertexArray.emplaceBack(ring[0].x,ring[0].y),this.indexArray2.emplaceBack(lineIndex+ring.length-1,lineIndex),flattened.push(ring[0].x),flattened.push(ring[0].y);for(let i=1;i<ring.length;i++)this.layoutVertexArray.emplaceBack(ring[i].x,ring[i].y),this.indexArray2.emplaceBack(lineIndex+i-1,lineIndex+i),flattened.push(ring[i].x),flattened.push(ring[i].y);lineSegment.vertexLength+=ring.length,lineSegment.primitiveLength+=ring.length}const indices=earcut$1(flattened,holeIndices);for(let i=0;i<indices.length;i+=3)this.indexArray.emplaceBack(triangleIndex+indices[i],triangleIndex+indices[i+1],triangleIndex+indices[i+2]);triangleSegment.vertexLength+=numVertices,triangleSegment.primitiveLength+=indices.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,feature,index,imagePositions,canonical)}}let layout$3;register("FillBucket",FillBucket,{omit:["layers","patternFeatures"]});let paint$5;var properties$5={get paint(){return paint$5=paint$5||new Properties({"fill-antialias":new DataConstantProperty(v8Spec.paint_fill["fill-antialias"]),"fill-opacity":new DataDrivenProperty(v8Spec.paint_fill["fill-opacity"]),"fill-color":new DataDrivenProperty(v8Spec.paint_fill["fill-color"]),"fill-outline-color":new DataDrivenProperty(v8Spec.paint_fill["fill-outline-color"]),"fill-translate":new DataConstantProperty(v8Spec.paint_fill["fill-translate"]),"fill-translate-anchor":new DataConstantProperty(v8Spec.paint_fill["fill-translate-anchor"]),"fill-pattern":new CrossFadedDataDrivenProperty(v8Spec.paint_fill["fill-pattern"])})},get layout(){return layout$3=layout$3||new Properties({"fill-sort-key":new DataDrivenProperty(v8Spec.layout_fill["fill-sort-key"])})}};class FillStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$5)}recalculate(parameters,availableImages){super.recalculate(parameters,availableImages);const outlineColor=this.paint._values["fill-outline-color"];"constant"===outlineColor.value.kind&&void 0===outlineColor.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(parameters){return new FillBucket(parameters)}queryRadius(){return translateDistance(this.paint.get("fill-translate"))}queryIntersectsFeature(queryGeometry,feature,featureState,geometry,zoom,transform,pixelsToTileUnits){return polygonIntersectsMultiPolygon(translate$4(queryGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),transform.angle,pixelsToTileUnits),geometry)}isTileClipped(){return!0}}const layout$2=createLayout([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),centroidAttributes=createLayout([{name:"a_centroid",components:2,type:"Int16"}],4),{members:members$2,size:size$2,alignment:alignment$2}=layout$2;var vectorTile={},Point=pointGeometry,vectortilefeature=VectorTileFeature$2;function VectorTileFeature$2(pbf,end,extent,keys,values){this.properties={},this.extent=extent,this.type=0,this._pbf=pbf,this._geometry=-1,this._keys=keys,this._values=values,pbf.readFields(readFeature,this,end)}function readFeature(tag,feature,pbf){1==tag?feature.id=pbf.readVarint():2==tag?function(pbf,feature){var end=pbf.readVarint()+pbf.pos;for(;pbf.pos<end;){var key=feature._keys[pbf.readVarint()],value=feature._values[pbf.readVarint()];feature.properties[key]=value}}(pbf,feature):3==tag?feature.type=pbf.readVarint():4==tag&&(feature._geometry=pbf.pos)}function signedArea(ring){for(var p1,p2,sum=0,i=0,len=ring.length,j=len-1;i<len;j=i++)p1=ring[i],sum+=((p2=ring[j]).x-p1.x)*(p1.y+p2.y);return sum}VectorTileFeature$2.types=["Unknown","Point","LineString","Polygon"],VectorTileFeature$2.prototype.loadGeometry=function(){var pbf=this._pbf;pbf.pos=this._geometry;for(var line,end=pbf.readVarint()+pbf.pos,cmd=1,length=0,x=0,y=0,lines=[];pbf.pos<end;){if(length<=0){var cmdLen=pbf.readVarint();cmd=7&cmdLen,length=cmdLen>>3}if(length--,1===cmd||2===cmd)x+=pbf.readSVarint(),y+=pbf.readSVarint(),1===cmd&&(line&&lines.push(line),line=[]),line.push(new Point(x,y));else{if(7!==cmd)throw new Error("unknown command "+cmd);line&&line.push(line[0].clone())}}return line&&lines.push(line),lines},VectorTileFeature$2.prototype.bbox=function(){var pbf=this._pbf;pbf.pos=this._geometry;for(var end=pbf.readVarint()+pbf.pos,cmd=1,length=0,x=0,y=0,x1=1/0,x2=-1/0,y1=1/0,y2=-1/0;pbf.pos<end;){if(length<=0){var cmdLen=pbf.readVarint();cmd=7&cmdLen,length=cmdLen>>3}if(length--,1===cmd||2===cmd)(x+=pbf.readSVarint())<x1&&(x1=x),x>x2&&(x2=x),(y+=pbf.readSVarint())<y1&&(y1=y),y>y2&&(y2=y);else if(7!==cmd)throw new Error("unknown command "+cmd)}return[x1,y1,x2,y2]},VectorTileFeature$2.prototype.toGeoJSON=function(x,y,z){var i,j,size=this.extent*Math.pow(2,z),x0=this.extent*x,y0=this.extent*y,coords=this.loadGeometry(),type=VectorTileFeature$2.types[this.type];function project(line){for(var j=0;j<line.length;j++){var p=line[j],y2=180-360*(p.y+y0)/size;line[j]=[360*(p.x+x0)/size-180,360/Math.PI*Math.atan(Math.exp(y2*Math.PI/180))-90]}}switch(this.type){case 1:var points=[];for(i=0;i<coords.length;i++)points[i]=coords[i][0];project(coords=points);break;case 2:for(i=0;i<coords.length;i++)project(coords[i]);break;case 3:for(coords=function(rings){var len=rings.length;if(len<=1)return[rings];for(var polygon,ccw,polygons=[],i=0;i<len;i++){var area=signedArea(rings[i]);0!==area&&(void 0===ccw&&(ccw=area<0),ccw===area<0?(polygon&&polygons.push(polygon),polygon=[rings[i]]):polygon.push(rings[i]))}polygon&&polygons.push(polygon);return polygons}(coords),i=0;i<coords.length;i++)for(j=0;j<coords[i].length;j++)project(coords[i][j])}1===coords.length?coords=coords[0]:type="Multi"+type;var result={type:"Feature",geometry:{type:type,coordinates:coords},properties:this.properties};return"id"in this&&(result.id=this.id),result};var VectorTileFeature$1=vectortilefeature,vectortilelayer=VectorTileLayer$2;function VectorTileLayer$2(pbf,end){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=pbf,this._keys=[],this._values=[],this._features=[],pbf.readFields(readLayer,this,end),this.length=this._features.length}function readLayer(tag,layer,pbf){15===tag?layer.version=pbf.readVarint():1===tag?layer.name=pbf.readString():5===tag?layer.extent=pbf.readVarint():2===tag?layer._features.push(pbf.pos):3===tag?layer._keys.push(pbf.readString()):4===tag&&layer._values.push(function(pbf){var value=null,end=pbf.readVarint()+pbf.pos;for(;pbf.pos<end;){var tag=pbf.readVarint()>>3;value=1===tag?pbf.readString():2===tag?pbf.readFloat():3===tag?pbf.readDouble():4===tag?pbf.readVarint64():5===tag?pbf.readVarint():6===tag?pbf.readSVarint():7===tag?pbf.readBoolean():null}return value}(pbf))}VectorTileLayer$2.prototype.feature=function(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var end=this._pbf.readVarint()+this._pbf.pos;return new VectorTileFeature$1(this._pbf,end,this.extent,this._keys,this._values)};var VectorTileLayer$1=vectortilelayer,vectortile=function(pbf,end){this.layers=pbf.readFields(readTile,{},end)};function readTile(tag,layers,pbf){if(3===tag){var layer=new VectorTileLayer$1(pbf,pbf.readVarint()+pbf.pos);layer.length&&(layers[layer.name]=layer)}}vectorTile.VectorTile=vectortile,vectorTile.VectorTileFeature=vectortilefeature,vectorTile.VectorTileLayer=vectortilelayer;const vectorTileFeatureTypes$2=vectorTile.VectorTileFeature.types,FACTOR=Math.pow(2,13);function addVertex$1(vertexArray,x,y,nx,ny,nz,t,e){vertexArray.emplaceBack(x,y,2*Math.floor(nx*FACTOR)+t,ny*FACTOR*2,nz*FACTOR*2,Math.round(e))}class FillExtrusionBucket{constructor(options){this.zoom=options.zoom,this.overscaling=options.overscaling,this.layers=options.layers,this.layerIds=this.layers.map((layer=>layer.id)),this.index=options.index,this.hasPattern=!1,this.layoutVertexArray=new FillExtrusionLayoutArray,this.centroidVertexArray=new PosArray,this.indexArray=new TriangleIndexArray,this.programConfigurations=new ProgramConfigurationSet(options.layers,options.zoom),this.segments=new SegmentVector,this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id))}populate(features,options,canonical){this.features=[],this.hasPattern=hasPattern("fill-extrusion",this.layers,options);for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=this.layers[0]._featureFilter.needGeometry,evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!this.layers[0]._featureFilter.filter(new EvaluationParameters(this.zoom),evaluationFeature,canonical))continue;const bucketFeature={id:id,sourceLayerIndex:sourceLayerIndex,index:index,geometry:needGeometry?evaluationFeature.geometry:loadGeometry(feature),properties:feature.properties,type:feature.type,patterns:{}};this.hasPattern?this.features.push(addPatternDependencies("fill-extrusion",this.layers,bucketFeature,this.zoom,options)):this.addFeature(bucketFeature,bucketFeature.geometry,index,canonical,{}),options.featureIndex.insert(feature,bucketFeature.geometry,index,sourceLayerIndex,this.index,!0)}}addFeatures(options,canonical,imagePositions){for(const feature of this.features){const{geometry:geometry}=feature;this.addFeature(feature,geometry,feature.index,canonical,imagePositions)}}update(states,vtLayer,imagePositions){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(states,vtLayer,this.stateDependentLayers,imagePositions)}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.centroidVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(context){this.uploaded||(this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,members$2),this.centroidVertexBuffer=context.createVertexBuffer(this.centroidVertexArray,centroidAttributes.members,!0),this.indexBuffer=context.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(context),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(feature,geometry,index,canonical,imagePositions){const centroid={x:0,y:0,vertexCount:0};for(const polygon of classifyRings$1(geometry,500)){let numVertices=0;for(const ring of polygon)numVertices+=ring.length;let segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const ring of polygon){if(0===ring.length)continue;if(isEntirelyOutside(ring))continue;let edgeDistance=0;for(let p=0;p<ring.length;p++){const p1=ring[p];if(p>=1){const p2=ring[p-1];if(!isBoundaryEdge(p1,p2)){segment.vertexLength+4>SegmentVector.MAX_VERTEX_ARRAY_LENGTH&&(segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const perp=p1.sub(p2)._perp()._unit(),dist=p2.dist(p1);edgeDistance+dist>32768&&(edgeDistance=0),addVertex$1(this.layoutVertexArray,p1.x,p1.y,perp.x,perp.y,0,0,edgeDistance),addVertex$1(this.layoutVertexArray,p1.x,p1.y,perp.x,perp.y,0,1,edgeDistance),centroid.x+=2*p1.x,centroid.y+=2*p1.y,centroid.vertexCount+=2,edgeDistance+=dist,addVertex$1(this.layoutVertexArray,p2.x,p2.y,perp.x,perp.y,0,0,edgeDistance),addVertex$1(this.layoutVertexArray,p2.x,p2.y,perp.x,perp.y,0,1,edgeDistance),centroid.x+=2*p2.x,centroid.y+=2*p2.y,centroid.vertexCount+=2;const bottomRight=segment.vertexLength;this.indexArray.emplaceBack(bottomRight,bottomRight+2,bottomRight+1),this.indexArray.emplaceBack(bottomRight+1,bottomRight+2,bottomRight+3),segment.vertexLength+=4,segment.primitiveLength+=2}}}}if(segment.vertexLength+numVertices>SegmentVector.MAX_VERTEX_ARRAY_LENGTH&&(segment=this.segments.prepareSegment(numVertices,this.layoutVertexArray,this.indexArray)),"Polygon"!==vectorTileFeatureTypes$2[feature.type])continue;const flattened=[],holeIndices=[],triangleIndex=segment.vertexLength;for(const ring of polygon)if(0!==ring.length){ring!==polygon[0]&&holeIndices.push(flattened.length/2);for(let i=0;i<ring.length;i++){const p=ring[i];addVertex$1(this.layoutVertexArray,p.x,p.y,0,0,1,1,0),centroid.x+=p.x,centroid.y+=p.y,centroid.vertexCount+=1,flattened.push(p.x),flattened.push(p.y)}}const indices=earcut$1(flattened,holeIndices);for(let j=0;j<indices.length;j+=3)this.indexArray.emplaceBack(triangleIndex+indices[j],triangleIndex+indices[j+2],triangleIndex+indices[j+1]);segment.primitiveLength+=indices.length/3,segment.vertexLength+=numVertices}for(let i=0;i<centroid.vertexCount;i++)this.centroidVertexArray.emplaceBack(Math.floor(centroid.x/centroid.vertexCount),Math.floor(centroid.y/centroid.vertexCount));this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,feature,index,imagePositions,canonical)}}function isBoundaryEdge(p1,p2){return p1.x===p2.x&&(p1.x<0||p1.x>EXTENT)||p1.y===p2.y&&(p1.y<0||p1.y>EXTENT)}function isEntirelyOutside(ring){return ring.every((p=>p.x<0))||ring.every((p=>p.x>EXTENT))||ring.every((p=>p.y<0))||ring.every((p=>p.y>EXTENT))}let paint$4;register("FillExtrusionBucket",FillExtrusionBucket,{omit:["layers","features"]});var properties$4={get paint(){return paint$4=paint$4||new Properties({"fill-extrusion-opacity":new DataConstantProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new DataDrivenProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new DataConstantProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new DataConstantProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new CrossFadedDataDrivenProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new DataDrivenProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new DataDrivenProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new DataConstantProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class FillExtrusionStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$4)}createBucket(parameters){return new FillExtrusionBucket(parameters)}queryRadius(){return translateDistance(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature(queryGeometry,feature,featureState,geometry,zoom,transform,pixelsToTileUnits,pixelPosMatrix){const translatedPolygon=translate$4(queryGeometry,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),transform.angle,pixelsToTileUnits),height=this.paint.get("fill-extrusion-height").evaluate(feature,featureState),base=this.paint.get("fill-extrusion-base").evaluate(feature,featureState),projectedQueryGeometry=function(queryGeometry,pixelPosMatrix,transform,z){const projectedQueryGeometry=[];for(const p of queryGeometry){const v=[p.x,p.y,z,1];transformMat4$1(v,v,pixelPosMatrix),projectedQueryGeometry.push(new Point$2(v[0]/v[3],v[1]/v[3]))}return projectedQueryGeometry}(translatedPolygon,pixelPosMatrix,0,0),projected=function(geometry,zBase,zTop,m){const projectedBase=[],projectedTop=[],baseXZ=m[8]*zBase,baseYZ=m[9]*zBase,baseZZ=m[10]*zBase,baseWZ=m[11]*zBase,topXZ=m[8]*zTop,topYZ=m[9]*zTop,topZZ=m[10]*zTop,topWZ=m[11]*zTop;for(const r of geometry){const ringBase=[],ringTop=[];for(const p of r){const x=p.x,y=p.y,sX=m[0]*x+m[4]*y+m[12],sY=m[1]*x+m[5]*y+m[13],sZ=m[2]*x+m[6]*y+m[14],sW=m[3]*x+m[7]*y+m[15],baseZ=sZ+baseZZ,baseW=sW+baseWZ,topX=sX+topXZ,topY=sY+topYZ,topZ=sZ+topZZ,topW=sW+topWZ,b=new Point$2((sX+baseXZ)/baseW,(sY+baseYZ)/baseW);b.z=baseZ/baseW,ringBase.push(b);const t=new Point$2(topX/topW,topY/topW);t.z=topZ/topW,ringTop.push(t)}projectedBase.push(ringBase),projectedTop.push(ringTop)}return[projectedBase,projectedTop]}(geometry,base,height,pixelPosMatrix);return function(projectedBase,projectedTop,projectedQueryGeometry){let closestDistance=1/0;polygonIntersectsMultiPolygon(projectedQueryGeometry,projectedTop)&&(closestDistance=getIntersectionDistance(projectedQueryGeometry,projectedTop[0]));for(let r=0;r<projectedTop.length;r++){const ringTop=projectedTop[r],ringBase=projectedBase[r];for(let p=0;p<ringTop.length-1;p++){const topA=ringTop[p],topB=ringTop[p+1],baseA=ringBase[p],face=[topA,topB,ringBase[p+1],baseA,topA];polygonIntersectsPolygon(projectedQueryGeometry,face)&&(closestDistance=Math.min(closestDistance,getIntersectionDistance(projectedQueryGeometry,face)))}}return closestDistance!==1/0&&closestDistance}(projected[0],projected[1],projectedQueryGeometry)}}function dot(a,b){return a.x*b.x+a.y*b.y}function getIntersectionDistance(projectedQueryGeometry,projectedFace){if(1===projectedQueryGeometry.length){let i=0;const a=projectedFace[i++];let b;for(;!b||a.equals(b);)if(b=projectedFace[i++],!b)return 1/0;for(;i<projectedFace.length;i++){const c=projectedFace[i],p=projectedQueryGeometry[0],ab=b.sub(a),ac=c.sub(a),ap=p.sub(a),dotABAB=dot(ab,ab),dotABAC=dot(ab,ac),dotACAC=dot(ac,ac),dotAPAB=dot(ap,ab),dotAPAC=dot(ap,ac),denom=dotABAB*dotACAC-dotABAC*dotABAC,v=(dotACAC*dotAPAB-dotABAC*dotAPAC)/denom,w=(dotABAB*dotAPAC-dotABAC*dotAPAB)/denom,u=1-v-w,distance=a.z*u+b.z*v+c.z*w;if(isFinite(distance))return distance}return 1/0}{let closestDistance=1/0;for(const p of projectedFace)closestDistance=Math.min(closestDistance,p.z);return closestDistance}}const lineLayoutAttributes=createLayout([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:members$1,size:size$1,alignment:alignment$1}=lineLayoutAttributes,lineLayoutAttributesExt=createLayout([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:members,size:size,alignment:alignment}=lineLayoutAttributesExt,vectorTileFeatureTypes$1=vectorTile.VectorTileFeature.types,COS_HALF_SHARP_CORNER=Math.cos(Math.PI/180*37.5),MAX_LINE_DISTANCE=Math.pow(2,14)/.5;class LineBucket{constructor(options){this.zoom=options.zoom,this.overscaling=options.overscaling,this.layers=options.layers,this.layerIds=this.layers.map((layer=>layer.id)),this.index=options.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((layer=>{this.gradients[layer.id]={}})),this.layoutVertexArray=new LineLayoutArray,this.layoutVertexArray2=new LineExtLayoutArray,this.indexArray=new TriangleIndexArray,this.programConfigurations=new ProgramConfigurationSet(options.layers,options.zoom),this.segments=new SegmentVector,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id))}populate(features,options,canonical){this.hasPattern=hasPattern("line",this.layers,options);const lineSortKey=this.layers[0].layout.get("line-sort-key"),sortFeaturesByKey=!lineSortKey.isConstant(),bucketFeatures=[];for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=this.layers[0]._featureFilter.needGeometry,evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!this.layers[0]._featureFilter.filter(new EvaluationParameters(this.zoom),evaluationFeature,canonical))continue;const sortKey=sortFeaturesByKey?lineSortKey.evaluate(evaluationFeature,{},canonical):void 0,bucketFeature={id:id,properties:feature.properties,type:feature.type,sourceLayerIndex:sourceLayerIndex,index:index,geometry:needGeometry?evaluationFeature.geometry:loadGeometry(feature),patterns:{},sortKey:sortKey};bucketFeatures.push(bucketFeature)}sortFeaturesByKey&&bucketFeatures.sort(((a,b)=>a.sortKey-b.sortKey));for(const bucketFeature of bucketFeatures){const{geometry:geometry,index:index,sourceLayerIndex:sourceLayerIndex}=bucketFeature;if(this.hasPattern){const patternBucketFeature=addPatternDependencies("line",this.layers,bucketFeature,this.zoom,options);this.patternFeatures.push(patternBucketFeature)}else this.addFeature(bucketFeature,geometry,index,canonical,{});const feature=features[index].feature;options.featureIndex.insert(feature,geometry,index,sourceLayerIndex,this.index)}}update(states,vtLayer,imagePositions){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(states,vtLayer,this.stateDependentLayers,imagePositions)}addFeatures(options,canonical,imagePositions){for(const feature of this.patternFeatures)this.addFeature(feature,feature.geometry,feature.index,canonical,imagePositions)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(context){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=context.createVertexBuffer(this.layoutVertexArray2,members)),this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,members$1),this.indexBuffer=context.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(context),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(feature){if(feature.properties&&Object.prototype.hasOwnProperty.call(feature.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(feature.properties,"mapbox_clip_end")){return{start:+feature.properties.mapbox_clip_start,end:+feature.properties.mapbox_clip_end}}}addFeature(feature,geometry,index,canonical,imagePositions){const layout=this.layers[0].layout,join=layout.get("line-join").evaluate(feature,{}),cap=layout.get("line-cap"),miterLimit=layout.get("line-miter-limit"),roundLimit=layout.get("line-round-limit");this.lineClips=this.lineFeatureClips(feature);for(const line of geometry)this.addLine(line,feature,join,cap,miterLimit,roundLimit);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,feature,index,imagePositions,canonical)}addLine(vertices,feature,join,cap,miterLimit,roundLimit){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let i=0;i<vertices.length-1;i++)this.totalDistance+=vertices[i].dist(vertices[i+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const isPolygon="Polygon"===vectorTileFeatureTypes$1[feature.type];let len=vertices.length;for(;len>=2&&vertices[len-1].equals(vertices[len-2]);)len--;let first=0;for(;first<len-1&&vertices[first].equals(vertices[first+1]);)first++;if(len<(isPolygon?3:2))return;"bevel"===join&&(miterLimit=1.05);const sharpCornerOffset=this.overscaling<=16?15*EXTENT/(512*this.overscaling):0,segment=this.segments.prepareSegment(10*len,this.layoutVertexArray,this.indexArray);let currentVertex,prevVertex,nextVertex,prevNormal,nextNormal;this.e1=this.e2=-1,isPolygon&&(currentVertex=vertices[len-2],nextNormal=vertices[first].sub(currentVertex)._unit()._perp());for(let i=first;i<len;i++){if(nextVertex=i===len-1?isPolygon?vertices[first+1]:void 0:vertices[i+1],nextVertex&&vertices[i].equals(nextVertex))continue;nextNormal&&(prevNormal=nextNormal),currentVertex&&(prevVertex=currentVertex),currentVertex=vertices[i],nextNormal=nextVertex?nextVertex.sub(currentVertex)._unit()._perp():prevNormal,prevNormal=prevNormal||nextNormal;let joinNormal=prevNormal.add(nextNormal);0===joinNormal.x&&0===joinNormal.y||joinNormal._unit();const cosAngle=prevNormal.x*nextNormal.x+prevNormal.y*nextNormal.y,cosHalfAngle=joinNormal.x*nextNormal.x+joinNormal.y*nextNormal.y,miterLength=0!==cosHalfAngle?1/cosHalfAngle:1/0,approxAngle=2*Math.sqrt(2-2*cosHalfAngle),isSharpCorner=cosHalfAngle<COS_HALF_SHARP_CORNER&&prevVertex&&nextVertex,lineTurnsLeft=prevNormal.x*nextNormal.y-prevNormal.y*nextNormal.x>0;if(isSharpCorner&&i>first){const prevSegmentLength=currentVertex.dist(prevVertex);if(prevSegmentLength>2*sharpCornerOffset){const newPrevVertex=currentVertex.sub(currentVertex.sub(prevVertex)._mult(sharpCornerOffset/prevSegmentLength)._round());this.updateDistance(prevVertex,newPrevVertex),this.addCurrentVertex(newPrevVertex,prevNormal,0,0,segment),prevVertex=newPrevVertex}}const middleVertex=prevVertex&&nextVertex;let currentJoin=middleVertex?join:isPolygon?"butt":cap;if(middleVertex&&"round"===currentJoin&&(miterLength<roundLimit?currentJoin="miter":miterLength<=2&&(currentJoin="fakeround")),"miter"===currentJoin&&miterLength>miterLimit&&(currentJoin="bevel"),"bevel"===currentJoin&&(miterLength>2&&(currentJoin="flipbevel"),miterLength<miterLimit&&(currentJoin="miter")),prevVertex&&this.updateDistance(prevVertex,currentVertex),"miter"===currentJoin)joinNormal._mult(miterLength),this.addCurrentVertex(currentVertex,joinNormal,0,0,segment);else if("flipbevel"===currentJoin){if(miterLength>100)joinNormal=nextNormal.mult(-1);else{const bevelLength=miterLength*prevNormal.add(nextNormal).mag()/prevNormal.sub(nextNormal).mag();joinNormal._perp()._mult(bevelLength*(lineTurnsLeft?-1:1))}this.addCurrentVertex(currentVertex,joinNormal,0,0,segment),this.addCurrentVertex(currentVertex,joinNormal.mult(-1),0,0,segment)}else if("bevel"===currentJoin||"fakeround"===currentJoin){const offset=-Math.sqrt(miterLength*miterLength-1),offsetA=lineTurnsLeft?offset:0,offsetB=lineTurnsLeft?0:offset;if(prevVertex&&this.addCurrentVertex(currentVertex,prevNormal,offsetA,offsetB,segment),"fakeround"===currentJoin){const n=Math.round(180*approxAngle/Math.PI/20);for(let m=1;m<n;m++){let t=m/n;if(.5!==t){const t2=t-.5;t+=t*t2*(t-1)*((1.0904+cosAngle*(cosAngle*(3.55645-1.43519*cosAngle)-3.2452))*t2*t2+(.848013+cosAngle*(.215638*cosAngle-1.06021)))}const extrude=nextNormal.sub(prevNormal)._mult(t)._add(prevNormal)._unit()._mult(lineTurnsLeft?-1:1);this.addHalfVertex(currentVertex,extrude.x,extrude.y,!1,lineTurnsLeft,0,segment)}}nextVertex&&this.addCurrentVertex(currentVertex,nextNormal,-offsetA,-offsetB,segment)}else if("butt"===currentJoin)this.addCurrentVertex(currentVertex,joinNormal,0,0,segment);else if("square"===currentJoin){const offset=prevVertex?1:-1;this.addCurrentVertex(currentVertex,joinNormal,offset,offset,segment)}else"round"===currentJoin&&(prevVertex&&(this.addCurrentVertex(currentVertex,prevNormal,0,0,segment),this.addCurrentVertex(currentVertex,prevNormal,1,1,segment,!0)),nextVertex&&(this.addCurrentVertex(currentVertex,nextNormal,-1,-1,segment,!0),this.addCurrentVertex(currentVertex,nextNormal,0,0,segment)));if(isSharpCorner&&i<len-1){const nextSegmentLength=currentVertex.dist(nextVertex);if(nextSegmentLength>2*sharpCornerOffset){const newCurrentVertex=currentVertex.add(nextVertex.sub(currentVertex)._mult(sharpCornerOffset/nextSegmentLength)._round());this.updateDistance(currentVertex,newCurrentVertex),this.addCurrentVertex(newCurrentVertex,nextNormal,0,0,segment),currentVertex=newCurrentVertex}}}}addCurrentVertex(p,normal,endLeft,endRight,segment,round=!1){const leftX=normal.x+normal.y*endLeft,leftY=normal.y-normal.x*endLeft,rightX=-normal.x+normal.y*endRight,rightY=-normal.y-normal.x*endRight;this.addHalfVertex(p,leftX,leftY,round,!1,endLeft,segment),this.addHalfVertex(p,rightX,rightY,round,!0,-endRight,segment),this.distance>MAX_LINE_DISTANCE/2&&0===this.totalDistance&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(p,normal,endLeft,endRight,segment,round))}addHalfVertex({x:x,y:y},extrudeX,extrudeY,round,up,dir,segment){const linesofarScaled=.5*(this.lineClips?this.scaledDistance*(MAX_LINE_DISTANCE-1):this.scaledDistance);if(this.layoutVertexArray.emplaceBack((x<<1)+(round?1:0),(y<<1)+(up?1:0),Math.round(63*extrudeX)+128,Math.round(63*extrudeY)+128,1+(0===dir?0:dir<0?-1:1)|(63&linesofarScaled)<<2,linesofarScaled>>6),this.lineClips){const uvX=(this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start);this.layoutVertexArray2.emplaceBack(uvX,this.lineClipsArray.length)}const e=segment.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,e),segment.primitiveLength++),up?this.e2=e:this.e1=e}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(prev,next){this.distance+=prev.dist(next),this.updateScaledDistance()}}let layout$1;register("LineBucket",LineBucket,{omit:["layers","patternFeatures"]});let paint$3;var properties$3={get paint(){return paint$3=paint$3||new Properties({"line-opacity":new DataDrivenProperty(v8Spec.paint_line["line-opacity"]),"line-color":new DataDrivenProperty(v8Spec.paint_line["line-color"]),"line-translate":new DataConstantProperty(v8Spec.paint_line["line-translate"]),"line-translate-anchor":new DataConstantProperty(v8Spec.paint_line["line-translate-anchor"]),"line-width":new DataDrivenProperty(v8Spec.paint_line["line-width"]),"line-gap-width":new DataDrivenProperty(v8Spec.paint_line["line-gap-width"]),"line-offset":new DataDrivenProperty(v8Spec.paint_line["line-offset"]),"line-blur":new DataDrivenProperty(v8Spec.paint_line["line-blur"]),"line-dasharray":new CrossFadedProperty(v8Spec.paint_line["line-dasharray"]),"line-pattern":new CrossFadedDataDrivenProperty(v8Spec.paint_line["line-pattern"]),"line-gradient":new ColorRampProperty(v8Spec.paint_line["line-gradient"])})},get layout(){return layout$1=layout$1||new Properties({"line-cap":new DataConstantProperty(v8Spec.layout_line["line-cap"]),"line-join":new DataDrivenProperty(v8Spec.layout_line["line-join"]),"line-miter-limit":new DataConstantProperty(v8Spec.layout_line["line-miter-limit"]),"line-round-limit":new DataConstantProperty(v8Spec.layout_line["line-round-limit"]),"line-sort-key":new DataDrivenProperty(v8Spec.layout_line["line-sort-key"])})}};class LineFloorwidthProperty extends DataDrivenProperty{possiblyEvaluate(value,parameters){return parameters=new EvaluationParameters(Math.floor(parameters.zoom),{now:parameters.now,fadeDuration:parameters.fadeDuration,zoomHistory:parameters.zoomHistory,transition:parameters.transition}),super.possiblyEvaluate(value,parameters)}evaluate(value,globals,feature,featureState){return globals=extend({},globals,{zoom:Math.floor(globals.zoom)}),super.evaluate(value,globals,feature,featureState)}}let lineFloorwidthProperty;class LineStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$3),this.gradientVersion=0,lineFloorwidthProperty||(lineFloorwidthProperty=new LineFloorwidthProperty(properties$3.paint.properties["line-width"].specification),lineFloorwidthProperty.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(name){if("line-gradient"===name){const expression=this.gradientExpression();isZoomExpression(expression)?this.stepInterpolant=expression._styleExpression.expression instanceof Step:this.stepInterpolant=!1,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(parameters,availableImages){super.recalculate(parameters,availableImages),this.paint._values["line-floorwidth"]=lineFloorwidthProperty.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,parameters)}createBucket(parameters){return new LineBucket(parameters)}queryRadius(bucket){const lineBucket=bucket,width=getLineWidth(getMaximumPaintValue("line-width",this,lineBucket),getMaximumPaintValue("line-gap-width",this,lineBucket)),offset=getMaximumPaintValue("line-offset",this,lineBucket);return width/2+Math.abs(offset)+translateDistance(this.paint.get("line-translate"))}queryIntersectsFeature(queryGeometry,feature,featureState,geometry,zoom,transform,pixelsToTileUnits){const translatedPolygon=translate$4(queryGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),transform.angle,pixelsToTileUnits),halfWidth=pixelsToTileUnits/2*getLineWidth(this.paint.get("line-width").evaluate(feature,featureState),this.paint.get("line-gap-width").evaluate(feature,featureState)),lineOffset=this.paint.get("line-offset").evaluate(feature,featureState);return lineOffset&&(geometry=function(rings,offset){const newRings=[];for(let ringIndex=0;ringIndex<rings.length;ringIndex++){const ring=rings[ringIndex],newRing=[];for(let index=0;index<ring.length;index++){const a=ring[index-1],b=ring[index],c=ring[index+1],aToB=0===index?new Point$2(0,0):b.sub(a)._unit()._perp(),bToC=index===ring.length-1?new Point$2(0,0):c.sub(b)._unit()._perp(),extrude=aToB._add(bToC)._unit(),cosHalfAngle=extrude.x*bToC.x+extrude.y*bToC.y;0!==cosHalfAngle&&extrude._mult(1/cosHalfAngle),newRing.push(extrude._mult(offset)._add(b))}newRings.push(newRing)}return newRings}(geometry,lineOffset*pixelsToTileUnits)),function(polygon,multiLine,radius){for(let i=0;i<multiLine.length;i++){const line=multiLine[i];if(polygon.length>=3)for(let k=0;k<line.length;k++)if(polygonContainsPoint(polygon,line[k]))return!0;if(lineIntersectsBufferedLine(polygon,line,radius))return!0}return!1}(translatedPolygon,geometry,halfWidth)}isTileClipped(){return!0}}function getLineWidth(lineWidth,lineGapWidth){return lineGapWidth>0?lineGapWidth+2*lineWidth:lineWidth}const symbolLayoutAttributes=createLayout([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),dynamicLayoutAttributes=createLayout([{name:"a_projected_pos",components:3,type:"Float32"}],4),collisionVertexAttributes=(createLayout([{name:"a_fade_opacity",components:1,type:"Uint32"}],4),createLayout([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}])),collisionBoxLayout=(createLayout([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]),createLayout([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4)),collisionCircleLayout=createLayout([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);createLayout([{name:"triangle",components:3,type:"Uint16"}]),createLayout([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),createLayout([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),createLayout([{type:"Float32",name:"offsetX"}]),createLayout([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),createLayout([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);function transformText(text,layer,feature){return text.sections.forEach((section=>{section.text=function(text,layer,feature){const transform=layer.layout.get("text-transform").evaluate(feature,{});return"uppercase"===transform?text=text.toLocaleUpperCase():"lowercase"===transform&&(text=text.toLocaleLowerCase()),rtlWorkerPlugin.applyArabicShaping&&(text=rtlWorkerPlugin.applyArabicShaping(text)),text}(section.text,layer,feature)})),text}const verticalizedCharacterMap={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};var ONE_EM=24,ieee754$1={},pbf=(ieee754$1.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},ieee754$1.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),(value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias))*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s},Pbf),ieee754=ieee754$1;function Pbf(buf){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(buf)?buf:new Uint8Array(buf||0),this.pos=0,this.type=0,this.length=this.buf.length}Pbf.Varint=0,Pbf.Fixed64=1,Pbf.Bytes=2,Pbf.Fixed32=5;var utf8TextDecoder="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function readPackedEnd(pbf){return pbf.type===Pbf.Bytes?pbf.readVarint()+pbf.pos:pbf.pos+1}function toNum(low,high,isSigned){return isSigned?4294967296*high+(low>>>0):4294967296*(high>>>0)+(low>>>0)}function makeRoomForExtraLength(startPos,len,pbf){var extraLen=len<=16383?1:len<=2097151?2:len<=268435455?3:Math.floor(Math.log(len)/(7*Math.LN2));pbf.realloc(extraLen);for(var i=pbf.pos-1;i>=startPos;i--)pbf.buf[i+extraLen]=pbf.buf[i]}function writePackedVarint(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeVarint(arr[i])}function writePackedSVarint(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSVarint(arr[i])}function writePackedFloat(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFloat(arr[i])}function writePackedDouble(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeDouble(arr[i])}function writePackedBoolean(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeBoolean(arr[i])}function writePackedFixed32(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFixed32(arr[i])}function writePackedSFixed32(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSFixed32(arr[i])}function writePackedFixed64(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFixed64(arr[i])}function writePackedSFixed64(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSFixed64(arr[i])}function readUInt32(buf,pos){return(buf[pos]|buf[pos+1]<<8|buf[pos+2]<<16)+16777216*buf[pos+3]}function writeInt32(buf,val,pos){buf[pos]=val,buf[pos+1]=val>>>8,buf[pos+2]=val>>>16,buf[pos+3]=val>>>24}function readInt32(buf,pos){return(buf[pos]|buf[pos+1]<<8|buf[pos+2]<<16)+(buf[pos+3]<<24)}Pbf.prototype={destroy:function(){this.buf=null},readFields:function(readField,result,end){for(end=end||this.length;this.pos<end;){var val=this.readVarint(),tag=val>>3,startPos=this.pos;this.type=7&val,readField(tag,result,this),this.pos===startPos&&this.skip(val)}return result},readMessage:function(readField,result){return this.readFields(readField,result,this.readVarint()+this.pos)},readFixed32:function(){var val=readUInt32(this.buf,this.pos);return this.pos+=4,val},readSFixed32:function(){var val=readInt32(this.buf,this.pos);return this.pos+=4,val},readFixed64:function(){var val=readUInt32(this.buf,this.pos)+4294967296*readUInt32(this.buf,this.pos+4);return this.pos+=8,val},readSFixed64:function(){var val=readUInt32(this.buf,this.pos)+4294967296*readInt32(this.buf,this.pos+4);return this.pos+=8,val},readFloat:function(){var val=ieee754.read(this.buf,this.pos,!0,23,4);return this.pos+=4,val},readDouble:function(){var val=ieee754.read(this.buf,this.pos,!0,52,8);return this.pos+=8,val},readVarint:function(isSigned){var val,b,buf=this.buf;return val=127&(b=buf[this.pos++]),b<128?val:(val|=(127&(b=buf[this.pos++]))<<7,b<128?val:(val|=(127&(b=buf[this.pos++]))<<14,b<128?val:(val|=(127&(b=buf[this.pos++]))<<21,b<128?val:function(l,s,p){var h,b,buf=p.buf;if(b=buf[p.pos++],h=(112&b)>>4,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<3,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<10,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<17,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(127&b)<<24,b<128)return toNum(l,h,s);if(b=buf[p.pos++],h|=(1&b)<<31,b<128)return toNum(l,h,s);throw new Error("Expected varint not more than 10 bytes")}(val|=(15&(b=buf[this.pos]))<<28,isSigned,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var num=this.readVarint();return num%2==1?(num+1)/-2:num/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var end=this.readVarint()+this.pos,pos=this.pos;return this.pos=end,end-pos>=12&&utf8TextDecoder?function(buf,pos,end){return utf8TextDecoder.decode(buf.subarray(pos,end))}(this.buf,pos,end):function(buf,pos,end){var str="",i=pos;for(;i<end;){var b1,b2,b3,b0=buf[i],c=null,bytesPerSequence=b0>239?4:b0>223?3:b0>191?2:1;if(i+bytesPerSequence>end)break;1===bytesPerSequence?b0<128&&(c=b0):2===bytesPerSequence?128==(192&(b1=buf[i+1]))&&(c=(31&b0)<<6|63&b1)<=127&&(c=null):3===bytesPerSequence?(b1=buf[i+1],b2=buf[i+2],128==(192&b1)&&128==(192&b2)&&((c=(15&b0)<<12|(63&b1)<<6|63&b2)<=2047||c>=55296&&c<=57343)&&(c=null)):4===bytesPerSequence&&(b1=buf[i+1],b2=buf[i+2],b3=buf[i+3],128==(192&b1)&&128==(192&b2)&&128==(192&b3)&&((c=(15&b0)<<18|(63&b1)<<12|(63&b2)<<6|63&b3)<=65535||c>=1114112)&&(c=null)),null===c?(c=65533,bytesPerSequence=1):c>65535&&(c-=65536,str+=String.fromCharCode(c>>>10&1023|55296),c=56320|1023&c),str+=String.fromCharCode(c),i+=bytesPerSequence}return str}(this.buf,pos,end)},readBytes:function(){var end=this.readVarint()+this.pos,buffer=this.buf.subarray(this.pos,end);return this.pos=end,buffer},readPackedVarint:function(arr,isSigned){if(this.type!==Pbf.Bytes)return arr.push(this.readVarint(isSigned));var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readVarint(isSigned));return arr},readPackedSVarint:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readSVarint());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readSVarint());return arr},readPackedBoolean:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readBoolean());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readBoolean());return arr},readPackedFloat:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readFloat());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readFloat());return arr},readPackedDouble:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readDouble());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readDouble());return arr},readPackedFixed32:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readFixed32());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readFixed32());return arr},readPackedSFixed32:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readSFixed32());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readSFixed32());return arr},readPackedFixed64:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readFixed64());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readFixed64());return arr},readPackedSFixed64:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readSFixed64());var end=readPackedEnd(this);for(arr=arr||[];this.pos<end;)arr.push(this.readSFixed64());return arr},skip:function(val){var type=7&val;if(type===Pbf.Varint)for(;this.buf[this.pos++]>127;);else if(type===Pbf.Bytes)this.pos=this.readVarint()+this.pos;else if(type===Pbf.Fixed32)this.pos+=4;else{if(type!==Pbf.Fixed64)throw new Error("Unimplemented type: "+type);this.pos+=8}},writeTag:function(tag,type){this.writeVarint(tag<<3|type)},realloc:function(min){for(var length=this.length||16;length<this.pos+min;)length*=2;if(length!==this.length){var buf=new Uint8Array(length);buf.set(this.buf),this.buf=buf,this.length=length}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(val){this.realloc(4),writeInt32(this.buf,val,this.pos),this.pos+=4},writeSFixed32:function(val){this.realloc(4),writeInt32(this.buf,val,this.pos),this.pos+=4},writeFixed64:function(val){this.realloc(8),writeInt32(this.buf,-1&val,this.pos),writeInt32(this.buf,Math.floor(2.3283064365386963e-10*val),this.pos+4),this.pos+=8},writeSFixed64:function(val){this.realloc(8),writeInt32(this.buf,-1&val,this.pos),writeInt32(this.buf,Math.floor(2.3283064365386963e-10*val),this.pos+4),this.pos+=8},writeVarint:function(val){(val=+val||0)>268435455||val<0?function(val,pbf){var low,high;val>=0?(low=val%4294967296|0,high=val/4294967296|0):(high=~(-val/4294967296),4294967295^(low=~(-val%4294967296))?low=low+1|0:(low=0,high=high+1|0));if(val>=0x10000000000000000||val<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");pbf.realloc(10),function(low,high,pbf){pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos++]=127&low|128,low>>>=7,pbf.buf[pbf.pos]=127&low}(low,0,pbf),function(high,pbf){var lsb=(7&high)<<4;if(pbf.buf[pbf.pos++]|=lsb|((high>>>=3)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;if(pbf.buf[pbf.pos++]=127&high|((high>>>=7)?128:0),!high)return;pbf.buf[pbf.pos++]=127&high}(high,pbf)}(val,this):(this.realloc(4),this.buf[this.pos++]=127&val|(val>127?128:0),val<=127||(this.buf[this.pos++]=127&(val>>>=7)|(val>127?128:0),val<=127||(this.buf[this.pos++]=127&(val>>>=7)|(val>127?128:0),val<=127||(this.buf[this.pos++]=val>>>7&127))))},writeSVarint:function(val){this.writeVarint(val<0?2*-val-1:2*val)},writeBoolean:function(val){this.writeVarint(Boolean(val))},writeString:function(str){str=String(str),this.realloc(4*str.length),this.pos++;var startPos=this.pos;this.pos=function(buf,str,pos){for(var c,lead,i=0;i<str.length;i++){if((c=str.charCodeAt(i))>55295&&c<57344){if(!lead){c>56319||i+1===str.length?(buf[pos++]=239,buf[pos++]=191,buf[pos++]=189):lead=c;continue}if(c<56320){buf[pos++]=239,buf[pos++]=191,buf[pos++]=189,lead=c;continue}c=lead-55296<<10|c-56320|65536,lead=null}else lead&&(buf[pos++]=239,buf[pos++]=191,buf[pos++]=189,lead=null);c<128?buf[pos++]=c:(c<2048?buf[pos++]=c>>6|192:(c<65536?buf[pos++]=c>>12|224:(buf[pos++]=c>>18|240,buf[pos++]=c>>12&63|128),buf[pos++]=c>>6&63|128),buf[pos++]=63&c|128)}return pos}(this.buf,str,this.pos);var len=this.pos-startPos;len>=128&&makeRoomForExtraLength(startPos,len,this),this.pos=startPos-1,this.writeVarint(len),this.pos+=len},writeFloat:function(val){this.realloc(4),ieee754.write(this.buf,val,this.pos,!0,23,4),this.pos+=4},writeDouble:function(val){this.realloc(8),ieee754.write(this.buf,val,this.pos,!0,52,8),this.pos+=8},writeBytes:function(buffer){var len=buffer.length;this.writeVarint(len),this.realloc(len);for(var i=0;i<len;i++)this.buf[this.pos++]=buffer[i]},writeRawMessage:function(fn,obj){this.pos++;var startPos=this.pos;fn(obj,this);var len=this.pos-startPos;len>=128&&makeRoomForExtraLength(startPos,len,this),this.pos=startPos-1,this.writeVarint(len),this.pos+=len},writeMessage:function(tag,fn,obj){this.writeTag(tag,Pbf.Bytes),this.writeRawMessage(fn,obj)},writePackedVarint:function(tag,arr){arr.length&&this.writeMessage(tag,writePackedVarint,arr)},writePackedSVarint:function(tag,arr){arr.length&&this.writeMessage(tag,writePackedSVarint,arr)},writePackedBoolean:function(tag,arr){arr.length&&this.writeMessage(tag,writePackedBoolean,arr)},writePackedFloat:function(tag,arr){arr.length&&this.writeMessage(tag,writePackedFloat,arr)},writePackedDouble:function(tag,arr){arr.length&&this.writeMessage(tag,writePackedDouble,arr)},writePackedFixed32:function(tag,arr){arr.length&&this.writeMessage(tag,writePackedFixed32,arr)},writePackedSFixed32:function(tag,arr){arr.length&&this.writeMessage(tag,writePackedSFixed32,arr)},writePackedFixed64:function(tag,arr){arr.length&&this.writeMessage(tag,writePackedFixed64,arr)},writePackedSFixed64:function(tag,arr){arr.length&&this.writeMessage(tag,writePackedSFixed64,arr)},writeBytesField:function(tag,buffer){this.writeTag(tag,Pbf.Bytes),this.writeBytes(buffer)},writeFixed32Field:function(tag,val){this.writeTag(tag,Pbf.Fixed32),this.writeFixed32(val)},writeSFixed32Field:function(tag,val){this.writeTag(tag,Pbf.Fixed32),this.writeSFixed32(val)},writeFixed64Field:function(tag,val){this.writeTag(tag,Pbf.Fixed64),this.writeFixed64(val)},writeSFixed64Field:function(tag,val){this.writeTag(tag,Pbf.Fixed64),this.writeSFixed64(val)},writeVarintField:function(tag,val){this.writeTag(tag,Pbf.Varint),this.writeVarint(val)},writeSVarintField:function(tag,val){this.writeTag(tag,Pbf.Varint),this.writeSVarint(val)},writeStringField:function(tag,str){this.writeTag(tag,Pbf.Bytes),this.writeString(str)},writeFloatField:function(tag,val){this.writeTag(tag,Pbf.Fixed32),this.writeFloat(val)},writeDoubleField:function(tag,val){this.writeTag(tag,Pbf.Fixed64),this.writeDouble(val)},writeBooleanField:function(tag,val){this.writeVarintField(tag,Boolean(val))}};var Protobuf=getDefaultExportFromCjs$1(pbf);const border$1=3;function readFontstacks(tag,glyphs,pbf){1===tag&&pbf.readMessage(readFontstack,glyphs)}function readFontstack(tag,glyphs,pbf){if(3===tag){const{id:id,bitmap:bitmap,width:width,height:height,left:left,top:top,advance:advance}=pbf.readMessage(readGlyph,{});glyphs.push({id:id,bitmap:new AlphaImage({width:width+2*border$1,height:height+2*border$1},bitmap),metrics:{width:width,height:height,left:left,top:top,advance:advance}})}}function readGlyph(tag,glyph,pbf){1===tag?glyph.id=pbf.readVarint():2===tag?glyph.bitmap=pbf.readBytes():3===tag?glyph.width=pbf.readVarint():4===tag?glyph.height=pbf.readVarint():5===tag?glyph.left=pbf.readSVarint():6===tag?glyph.top=pbf.readSVarint():7===tag&&(glyph.advance=pbf.readVarint())}const GLYPH_PBF_BORDER=border$1;function potpack(boxes){let area=0,maxWidth=0;for(const box of boxes)area+=box.w*box.h,maxWidth=Math.max(maxWidth,box.w);boxes.sort(((a,b)=>b.h-a.h));const spaces=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(area/.95)),maxWidth),h:1/0}];let width=0,height=0;for(const box of boxes)for(let i=spaces.length-1;i>=0;i--){const space=spaces[i];if(!(box.w>space.w||box.h>space.h)){if(box.x=space.x,box.y=space.y,height=Math.max(height,box.y+box.h),width=Math.max(width,box.x+box.w),box.w===space.w&&box.h===space.h){const last=spaces.pop();i<spaces.length&&(spaces[i]=last)}else box.h===space.h?(space.x+=box.w,space.w-=box.w):box.w===space.w?(space.y+=box.h,space.h-=box.h):(spaces.push({x:space.x+box.w,y:space.y,w:space.w-box.w,h:box.h}),space.y+=box.h,space.h-=box.h);break}}return{w:width,h:height,fill:area/(width*height)||0}}const IMAGE_PADDING=1;class ImagePosition{constructor(paddedRect,{pixelRatio:pixelRatio,version:version,stretchX:stretchX,stretchY:stretchY,content:content}){this.paddedRect=paddedRect,this.pixelRatio=pixelRatio,this.stretchX=stretchX,this.stretchY=stretchY,this.content=content,this.version=version}get tl(){return[this.paddedRect.x+IMAGE_PADDING,this.paddedRect.y+IMAGE_PADDING]}get br(){return[this.paddedRect.x+this.paddedRect.w-IMAGE_PADDING,this.paddedRect.y+this.paddedRect.h-IMAGE_PADDING]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*IMAGE_PADDING)/this.pixelRatio,(this.paddedRect.h-2*IMAGE_PADDING)/this.pixelRatio]}}class ImageAtlas{constructor(icons,patterns){const iconPositions={},patternPositions={};this.haveRenderCallbacks=[];const bins=[];this.addImages(icons,iconPositions,bins),this.addImages(patterns,patternPositions,bins);const{w:w,h:h}=potpack(bins),image=new RGBAImage({width:w||1,height:h||1});for(const id in icons){const src=icons[id],bin=iconPositions[id].paddedRect;RGBAImage.copy(src.data,image,{x:0,y:0},{x:bin.x+IMAGE_PADDING,y:bin.y+IMAGE_PADDING},src.data)}for(const id in patterns){const src=patterns[id],bin=patternPositions[id].paddedRect,x=bin.x+IMAGE_PADDING,y=bin.y+IMAGE_PADDING,w=src.data.width,h=src.data.height;RGBAImage.copy(src.data,image,{x:0,y:0},{x:x,y:y},src.data),RGBAImage.copy(src.data,image,{x:0,y:h-1},{x:x,y:y-1},{width:w,height:1}),RGBAImage.copy(src.data,image,{x:0,y:0},{x:x,y:y+h},{width:w,height:1}),RGBAImage.copy(src.data,image,{x:w-1,y:0},{x:x-1,y:y},{width:1,height:h}),RGBAImage.copy(src.data,image,{x:0,y:0},{x:x+w,y:y},{width:1,height:h})}this.image=image,this.iconPositions=iconPositions,this.patternPositions=patternPositions}addImages(images,positions,bins){for(const id in images){const src=images[id],bin={x:0,y:0,w:src.data.width+2*IMAGE_PADDING,h:src.data.height+2*IMAGE_PADDING};bins.push(bin),positions[id]=new ImagePosition(bin,src),src.hasRenderCallback&&this.haveRenderCallbacks.push(id)}}patchUpdatedImages(imageManager,texture){imageManager.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const name in imageManager.updatedImages)this.patchUpdatedImage(this.iconPositions[name],imageManager.getImage(name),texture),this.patchUpdatedImage(this.patternPositions[name],imageManager.getImage(name),texture)}patchUpdatedImage(position,image,texture){if(!position||!image)return;if(position.version===image.version)return;position.version=image.version;const[x,y]=position.tl;texture.update(image.data,void 0,{x:x,y:y})}}var WritingMode;register("ImagePosition",ImagePosition),register("ImageAtlas",ImageAtlas),exports.WritingMode=void 0,(WritingMode=exports.WritingMode||(exports.WritingMode={}))[WritingMode.none=0]="none",WritingMode[WritingMode.horizontal=1]="horizontal",WritingMode[WritingMode.vertical=2]="vertical",WritingMode[WritingMode.horizontalOnly=3]="horizontalOnly";const SHAPING_DEFAULT_OFFSET=-17;class SectionOptions{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(scale,fontStack){const textOptions=new SectionOptions;return textOptions.scale=scale||1,textOptions.fontStack=fontStack,textOptions}static forImage(imageName){const imageOptions=new SectionOptions;return imageOptions.imageName=imageName,imageOptions}}class TaggedString{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(text,defaultFontStack){const result=new TaggedString;for(let i=0;i<text.sections.length;i++){const section=text.sections[i];section.image?result.addImageSection(section):result.addTextSection(section,defaultFontStack)}return result}length(){return this.text.length}getSection(index){return this.sections[this.sectionIndex[index]]}getSectionIndex(index){return this.sectionIndex[index]}getCharCode(index){return this.text.charCodeAt(index)}verticalizePunctuation(){this.text=function(input){let output="";for(let i=0;i<input.length;i++){const nextCharCode=input.charCodeAt(i+1)||null,prevCharCode=input.charCodeAt(i-1)||null;nextCharCode&&charHasRotatedVerticalOrientation(nextCharCode)&&!verticalizedCharacterMap[input[i+1]]||prevCharCode&&charHasRotatedVerticalOrientation(prevCharCode)&&!verticalizedCharacterMap[input[i-1]]||!verticalizedCharacterMap[input[i]]?output+=input[i]:output+=verticalizedCharacterMap[input[i]]}return output}(this.text)}trim(){let beginningWhitespace=0;for(let i=0;i<this.text.length&&whitespace[this.text.charCodeAt(i)];i++)beginningWhitespace++;let trailingWhitespace=this.text.length;for(let i=this.text.length-1;i>=0&&i>=beginningWhitespace&&whitespace[this.text.charCodeAt(i)];i--)trailingWhitespace--;this.text=this.text.substring(beginningWhitespace,trailingWhitespace),this.sectionIndex=this.sectionIndex.slice(beginningWhitespace,trailingWhitespace)}substring(start,end){const substring=new TaggedString;return substring.text=this.text.substring(start,end),substring.sectionIndex=this.sectionIndex.slice(start,end),substring.sections=this.sections,substring}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((max,index)=>Math.max(max,this.sections[index].scale)),0)}addTextSection(section,defaultFontStack){this.text+=section.text,this.sections.push(SectionOptions.forText(section.scale,section.fontStack||defaultFontStack));const index=this.sections.length-1;for(let i=0;i<section.text.length;++i)this.sectionIndex.push(index)}addImageSection(section){const imageName=section.image?section.image.name:"";if(0===imageName.length)return void warnOnce("Can't add FormattedSection with an empty image.");const nextImageSectionCharCode=this.getNextImageSectionCharCode();nextImageSectionCharCode?(this.text+=String.fromCharCode(nextImageSectionCharCode),this.sections.push(SectionOptions.forImage(imageName)),this.sectionIndex.push(this.sections.length-1)):warnOnce("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function shapeText(text,glyphMap,glyphPositions,imagePositions,defaultFontStack,maxWidth,lineHeight,textAnchor,textJustify,spacing,translate,writingMode,allowVerticalPlacement,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom){const logicalInput=TaggedString.fromFeature(text,defaultFontStack);let lines;writingMode===exports.WritingMode.vertical&&logicalInput.verticalizePunctuation();const{processBidirectionalText:processBidirectionalText,processStyledBidirectionalText:processStyledBidirectionalText}=rtlWorkerPlugin;if(processBidirectionalText&&1===logicalInput.sections.length){lines=[];const untaggedLines=processBidirectionalText(logicalInput.toString(),determineLineBreaks(logicalInput,spacing,maxWidth,glyphMap,imagePositions,symbolPlacement,layoutTextSize));for(const line of untaggedLines){const taggedLine=new TaggedString;taggedLine.text=line,taggedLine.sections=logicalInput.sections;for(let i=0;i<line.length;i++)taggedLine.sectionIndex.push(0);lines.push(taggedLine)}}else if(processStyledBidirectionalText){lines=[];const processedLines=processStyledBidirectionalText(logicalInput.text,logicalInput.sectionIndex,determineLineBreaks(logicalInput,spacing,maxWidth,glyphMap,imagePositions,symbolPlacement,layoutTextSize));for(const line of processedLines){const taggedLine=new TaggedString;taggedLine.text=line[0],taggedLine.sectionIndex=line[1],taggedLine.sections=logicalInput.sections,lines.push(taggedLine)}}else lines=function(input,lineBreakPoints){const lines=[],text=input.text;let start=0;for(const lineBreak of lineBreakPoints)lines.push(input.substring(start,lineBreak)),start=lineBreak;return start<text.length&&lines.push(input.substring(start,text.length)),lines}(logicalInput,determineLineBreaks(logicalInput,spacing,maxWidth,glyphMap,imagePositions,symbolPlacement,layoutTextSize));const positionedLines=[],shaping={positionedLines:positionedLines,text:logicalInput.toString(),top:translate[1],bottom:translate[1],left:translate[0],right:translate[0],writingMode:writingMode,iconsInText:!1,verticalizable:!1};return function(shaping,glyphMap,glyphPositions,imagePositions,lines,lineHeight,textAnchor,textJustify,writingMode,spacing,allowVerticalPlacement,layoutTextSizeThisZoom){let x=0,y=SHAPING_DEFAULT_OFFSET,maxLineLength=0,maxLineHeight=0;const justify="right"===textJustify?1:"left"===textJustify?0:.5;let lineIndex=0;for(const line of lines){line.trim();const lineMaxScale=line.getMaxScale(),maxLineOffset=(lineMaxScale-1)*ONE_EM,positionedLine={positionedGlyphs:[],lineOffset:0};shaping.positionedLines[lineIndex]=positionedLine;const positionedGlyphs=positionedLine.positionedGlyphs;let lineOffset=0;if(!line.length()){y+=lineHeight,++lineIndex;continue}for(let i=0;i<line.length();i++){const section=line.getSection(i),sectionIndex=line.getSectionIndex(i),codePoint=line.getCharCode(i);let baselineOffset=0,metrics=null,rect=null,imageName=null,verticalAdvance=ONE_EM;const vertical=!(writingMode===exports.WritingMode.horizontal||!allowVerticalPlacement&&!charHasUprightVerticalOrientation(codePoint)||allowVerticalPlacement&&(whitespace[codePoint]||charInComplexShapingScript(codePoint)));if(section.imageName){const imagePosition=imagePositions[section.imageName];if(!imagePosition)continue;imageName=section.imageName,shaping.iconsInText=shaping.iconsInText||!0,rect=imagePosition.paddedRect;const size=imagePosition.displaySize;section.scale=section.scale*ONE_EM/layoutTextSizeThisZoom,metrics={width:size[0],height:size[1],left:IMAGE_PADDING,top:-GLYPH_PBF_BORDER,advance:vertical?size[1]:size[0]};baselineOffset=maxLineOffset+(ONE_EM-size[1]*section.scale),verticalAdvance=metrics.advance;const offset=vertical?size[0]*section.scale-ONE_EM*lineMaxScale:size[1]*section.scale-ONE_EM*lineMaxScale;offset>0&&offset>lineOffset&&(lineOffset=offset)}else{const positions=glyphPositions[section.fontStack],glyphPosition=positions&&positions[codePoint];if(glyphPosition&&glyphPosition.rect)rect=glyphPosition.rect,metrics=glyphPosition.metrics;else{const glyphs=glyphMap[section.fontStack],glyph=glyphs&&glyphs[codePoint];if(!glyph)continue;metrics=glyph.metrics}baselineOffset=(lineMaxScale-section.scale)*ONE_EM}vertical?(shaping.verticalizable=!0,positionedGlyphs.push({glyph:codePoint,imageName:imageName,x:x,y:y+baselineOffset,vertical:vertical,scale:section.scale,fontStack:section.fontStack,sectionIndex:sectionIndex,metrics:metrics,rect:rect}),x+=verticalAdvance*section.scale+spacing):(positionedGlyphs.push({glyph:codePoint,imageName:imageName,x:x,y:y+baselineOffset,vertical:vertical,scale:section.scale,fontStack:section.fontStack,sectionIndex:sectionIndex,metrics:metrics,rect:rect}),x+=metrics.advance*section.scale+spacing)}if(0!==positionedGlyphs.length){const lineLength=x-spacing;maxLineLength=Math.max(lineLength,maxLineLength),justifyLine(positionedGlyphs,0,positionedGlyphs.length-1,justify,lineOffset)}x=0;const currentLineHeight=lineHeight*lineMaxScale+lineOffset;positionedLine.lineOffset=Math.max(lineOffset,maxLineOffset),y+=currentLineHeight,maxLineHeight=Math.max(currentLineHeight,maxLineHeight),++lineIndex}const height=y-SHAPING_DEFAULT_OFFSET,{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}=getAnchorAlignment(textAnchor);(function(positionedLines,justify,horizontalAlign,verticalAlign,maxLineLength,maxLineHeight,lineHeight,blockHeight,lineCount){const shiftX=(justify-horizontalAlign)*maxLineLength;let shiftY=0;shiftY=maxLineHeight!==lineHeight?-blockHeight*verticalAlign-SHAPING_DEFAULT_OFFSET:(-verticalAlign*lineCount+.5)*lineHeight;for(const line of positionedLines)for(const positionedGlyph of line.positionedGlyphs)positionedGlyph.x+=shiftX,positionedGlyph.y+=shiftY})(shaping.positionedLines,justify,horizontalAlign,verticalAlign,maxLineLength,maxLineHeight,lineHeight,height,lines.length),shaping.top+=-verticalAlign*height,shaping.bottom=shaping.top+height,shaping.left+=-horizontalAlign*maxLineLength,shaping.right=shaping.left+maxLineLength}(shaping,glyphMap,glyphPositions,imagePositions,lines,lineHeight,textAnchor,textJustify,writingMode,spacing,allowVerticalPlacement,layoutTextSizeThisZoom),!function(positionedLines){for(const line of positionedLines)if(0!==line.positionedGlyphs.length)return!1;return!0}(positionedLines)&&shaping}const whitespace={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},breakable={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function getGlyphAdvance(codePoint,section,glyphMap,imagePositions,spacing,layoutTextSize){if(section.imageName){const imagePosition=imagePositions[section.imageName];return imagePosition?imagePosition.displaySize[0]*section.scale*ONE_EM/layoutTextSize+spacing:0}{const positions=glyphMap[section.fontStack],glyph=positions&&positions[codePoint];return glyph?glyph.metrics.advance*section.scale+spacing:0}}function calculateBadness(lineWidth,targetWidth,penalty,isLastBreak){const raggedness=Math.pow(lineWidth-targetWidth,2);return isLastBreak?lineWidth<targetWidth?raggedness/2:2*raggedness:raggedness+Math.abs(penalty)*penalty}function calculatePenalty(codePoint,nextCodePoint,penalizableIdeographicBreak){let penalty=0;return 10===codePoint&&(penalty-=1e4),penalizableIdeographicBreak&&(penalty+=150),40!==codePoint&&65288!==codePoint||(penalty+=50),41!==nextCodePoint&&65289!==nextCodePoint||(penalty+=50),penalty}function evaluateBreak(breakIndex,breakX,targetWidth,potentialBreaks,penalty,isLastBreak){let bestPriorBreak=null,bestBreakBadness=calculateBadness(breakX,targetWidth,penalty,isLastBreak);for(const potentialBreak of potentialBreaks){const breakBadness=calculateBadness(breakX-potentialBreak.x,targetWidth,penalty,isLastBreak)+potentialBreak.badness;breakBadness<=bestBreakBadness&&(bestPriorBreak=potentialBreak,bestBreakBadness=breakBadness)}return{index:breakIndex,x:breakX,priorBreak:bestPriorBreak,badness:bestBreakBadness}}function leastBadBreaks(lastLineBreak){return lastLineBreak?leastBadBreaks(lastLineBreak.priorBreak).concat(lastLineBreak.index):[]}function determineLineBreaks(logicalInput,spacing,maxWidth,glyphMap,imagePositions,symbolPlacement,layoutTextSize){if("point"!==symbolPlacement)return[];if(!logicalInput)return[];const potentialLineBreaks=[],targetWidth=function(logicalInput,spacing,maxWidth,glyphMap,imagePositions,layoutTextSize){let totalWidth=0;for(let index=0;index<logicalInput.length();index++){const section=logicalInput.getSection(index);totalWidth+=getGlyphAdvance(logicalInput.getCharCode(index),section,glyphMap,imagePositions,spacing,layoutTextSize)}return totalWidth/Math.max(1,Math.ceil(totalWidth/maxWidth))}(logicalInput,spacing,maxWidth,glyphMap,imagePositions,layoutTextSize),hasServerSuggestedBreakpoints=logicalInput.text.indexOf("")>=0;let currentX=0;for(let i=0;i<logicalInput.length();i++){const section=logicalInput.getSection(i),codePoint=logicalInput.getCharCode(i);if(whitespace[codePoint]||(currentX+=getGlyphAdvance(codePoint,section,glyphMap,imagePositions,spacing,layoutTextSize)),i<logicalInput.length()-1){const ideographicBreak=charAllowsIdeographicBreaking(codePoint);(breakable[codePoint]||ideographicBreak||section.imageName)&&potentialLineBreaks.push(evaluateBreak(i+1,currentX,targetWidth,potentialLineBreaks,calculatePenalty(codePoint,logicalInput.getCharCode(i+1),ideographicBreak&&hasServerSuggestedBreakpoints),!1))}}return leastBadBreaks(evaluateBreak(logicalInput.length(),currentX,targetWidth,potentialLineBreaks,0,!0))}function getAnchorAlignment(anchor){let horizontalAlign=.5,verticalAlign=.5;switch(anchor){case"right":case"top-right":case"bottom-right":horizontalAlign=1;break;case"left":case"top-left":case"bottom-left":horizontalAlign=0}switch(anchor){case"bottom":case"bottom-right":case"bottom-left":verticalAlign=1;break;case"top":case"top-right":case"top-left":verticalAlign=0}return{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}}function justifyLine(positionedGlyphs,start,end,justify,lineOffset){if(!justify&&!lineOffset)return;const lastPositionedGlyph=positionedGlyphs[end],lastAdvance=lastPositionedGlyph.metrics.advance*lastPositionedGlyph.scale,lineIndent=(positionedGlyphs[end].x+lastAdvance)*justify;for(let j=start;j<=end;j++)positionedGlyphs[j].x-=lineIndent,positionedGlyphs[j].y+=lineOffset}function shapeIcon(image,iconOffset,iconAnchor){const{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}=getAnchorAlignment(iconAnchor),dx=iconOffset[0],dy=iconOffset[1],x1=dx-image.displaySize[0]*horizontalAlign,x2=x1+image.displaySize[0],y1=dy-image.displaySize[1]*verticalAlign;return{image:image,top:y1,bottom:y1+image.displaySize[1],left:x1,right:x2}}function fitIconToText(shapedIcon,shapedText,textFit,padding,iconOffset,fontScale){const image=shapedIcon.image;let collisionPadding;if(image.content){const content=image.content,pixelRatio=image.pixelRatio||1;collisionPadding=[content[0]/pixelRatio,content[1]/pixelRatio,image.displaySize[0]-content[2]/pixelRatio,image.displaySize[1]-content[3]/pixelRatio]}const textLeft=shapedText.left*fontScale,textRight=shapedText.right*fontScale;let top,right,bottom,left;"width"===textFit||"both"===textFit?(left=iconOffset[0]+textLeft-padding[3],right=iconOffset[0]+textRight+padding[1]):(left=iconOffset[0]+(textLeft+textRight-image.displaySize[0])/2,right=left+image.displaySize[0]);const textTop=shapedText.top*fontScale,textBottom=shapedText.bottom*fontScale;return"height"===textFit||"both"===textFit?(top=iconOffset[1]+textTop-padding[0],bottom=iconOffset[1]+textBottom+padding[2]):(top=iconOffset[1]+(textTop+textBottom-image.displaySize[1])/2,bottom=top+image.displaySize[1]),{image:image,top:top,right:right,bottom:bottom,left:left,collisionPadding:collisionPadding}}const MAX_GLYPH_ICON_SIZE=255,SIZE_PACK_FACTOR=128,MAX_PACKED_SIZE=MAX_GLYPH_ICON_SIZE*SIZE_PACK_FACTOR;function getSizeData(tileZoom,value){const{expression:expression}=value;if("constant"===expression.kind){return{kind:"constant",layoutSize:expression.evaluate(new EvaluationParameters(tileZoom+1))}}if("source"===expression.kind)return{kind:"source"};{const{zoomStops:zoomStops,interpolationType:interpolationType}=expression;let lower=0;for(;lower<zoomStops.length&&zoomStops[lower]<=tileZoom;)lower++;lower=Math.max(0,lower-1);let upper=lower;for(;upper<zoomStops.length&&zoomStops[upper]<tileZoom+1;)upper++;upper=Math.min(zoomStops.length-1,upper);const minZoom=zoomStops[lower],maxZoom=zoomStops[upper];if("composite"===expression.kind)return{kind:"composite",minZoom:minZoom,maxZoom:maxZoom,interpolationType:interpolationType};return{kind:"camera",minZoom:minZoom,maxZoom:maxZoom,minSize:expression.evaluate(new EvaluationParameters(minZoom)),maxSize:expression.evaluate(new EvaluationParameters(maxZoom)),interpolationType:interpolationType}}}function getOverlapMode(layout,overlapProp,allowOverlapProp){let result="never";const overlap=layout.get(overlapProp);return overlap?result=overlap:layout.get(allowOverlapProp)&&(result="always"),result}const vectorTileFeatureTypes=vectorTile.VectorTileFeature.types,shaderOpacityAttributes=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function addVertex(array,anchorX,anchorY,ox,oy,tx,ty,sizeVertex,isSDF,pixelOffsetX,pixelOffsetY,minFontScaleX,minFontScaleY){const aSizeX=sizeVertex?Math.min(MAX_PACKED_SIZE,Math.round(sizeVertex[0])):0,aSizeY=sizeVertex?Math.min(MAX_PACKED_SIZE,Math.round(sizeVertex[1])):0;array.emplaceBack(anchorX,anchorY,Math.round(32*ox),Math.round(32*oy),tx,ty,(aSizeX<<1)+(isSDF?1:0),aSizeY,16*pixelOffsetX,16*pixelOffsetY,256*minFontScaleX,256*minFontScaleY)}function addDynamicAttributes(dynamicLayoutVertexArray,p,angle){dynamicLayoutVertexArray.emplaceBack(p.x,p.y,angle),dynamicLayoutVertexArray.emplaceBack(p.x,p.y,angle),dynamicLayoutVertexArray.emplaceBack(p.x,p.y,angle),dynamicLayoutVertexArray.emplaceBack(p.x,p.y,angle)}function containsRTLText(formattedText){for(const section of formattedText.sections)if(stringContainsRTLText(section.text))return!0;return!1}class SymbolBuffers{constructor(programConfigurations){this.layoutVertexArray=new SymbolLayoutArray,this.indexArray=new TriangleIndexArray,this.programConfigurations=programConfigurations,this.segments=new SegmentVector,this.dynamicLayoutVertexArray=new SymbolDynamicLayoutArray,this.opacityVertexArray=new SymbolOpacityArray,this.hasVisibleVertices=!1,this.placedSymbolArray=new PlacedSymbolArray}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length}upload(context,dynamicIndexBuffer,upload,update){this.isEmpty()||(upload&&(this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,symbolLayoutAttributes.members),this.indexBuffer=context.createIndexBuffer(this.indexArray,dynamicIndexBuffer),this.dynamicLayoutVertexBuffer=context.createVertexBuffer(this.dynamicLayoutVertexArray,dynamicLayoutAttributes.members,!0),this.opacityVertexBuffer=context.createVertexBuffer(this.opacityVertexArray,shaderOpacityAttributes,!0),this.opacityVertexBuffer.itemSize=1),(upload||update)&&this.programConfigurations.upload(context))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}register("SymbolBuffers",SymbolBuffers);class CollisionBuffers{constructor(LayoutArray,layoutAttributes,IndexArray){this.layoutVertexArray=new LayoutArray,this.layoutAttributes=layoutAttributes,this.indexArray=new IndexArray,this.segments=new SegmentVector,this.collisionVertexArray=new CollisionVertexArray}upload(context){this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=context.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=context.createVertexBuffer(this.collisionVertexArray,collisionVertexAttributes.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}register("CollisionBuffers",CollisionBuffers);class SymbolBucket{constructor(options){this.collisionBoxArray=options.collisionBoxArray,this.zoom=options.zoom,this.overscaling=options.overscaling,this.layers=options.layers,this.layerIds=this.layers.map((layer=>layer.id)),this.index=options.index,this.pixelRatio=options.pixelRatio,this.sourceLayerIndex=options.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=identity$2([]),this.placementViewportMatrix=identity$2([]);const unevaluatedLayoutValues=this.layers[0]._unevaluatedLayout._values;this.textSizeData=getSizeData(this.zoom,unevaluatedLayoutValues["text-size"]),this.iconSizeData=getSizeData(this.zoom,unevaluatedLayoutValues["icon-size"]);const layout=this.layers[0].layout,sortKey=layout.get("symbol-sort-key"),zOrder=layout.get("symbol-z-order");this.canOverlap="never"!==getOverlapMode(layout,"text-overlap","text-allow-overlap")||"never"!==getOverlapMode(layout,"icon-overlap","icon-allow-overlap")||layout.get("text-ignore-placement")||layout.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==zOrder&&!sortKey.isConstant();const zOrderByViewportY="viewport-y"===zOrder||"auto"===zOrder&&!this.sortFeaturesByKey;this.sortFeaturesByY=zOrderByViewportY&&this.canOverlap,"point"===layout.get("symbol-placement")&&(this.writingModes=layout.get("text-writing-mode").map((wm=>exports.WritingMode[wm]))),this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id)),this.sourceID=options.sourceID}createArrays(){this.text=new SymbolBuffers(new ProgramConfigurationSet(this.layers,this.zoom,(property=>/^text/.test(property)))),this.icon=new SymbolBuffers(new ProgramConfigurationSet(this.layers,this.zoom,(property=>/^icon/.test(property)))),this.glyphOffsetArray=new GlyphOffsetArray,this.lineVertexArray=new SymbolLineVertexArray,this.symbolInstances=new SymbolInstanceArray,this.textAnchorOffsets=new TextAnchorOffsetArray}calculateGlyphDependencies(text,stack,textAlongLine,allowVerticalPlacement,doesAllowVerticalWritingMode){for(let i=0;i<text.length;i++)if(stack[text.charCodeAt(i)]=!0,(textAlongLine||allowVerticalPlacement)&&doesAllowVerticalWritingMode){const verticalChar=verticalizedCharacterMap[text.charAt(i)];verticalChar&&(stack[verticalChar.charCodeAt(0)]=!0)}}populate(features,options,canonical){const layer=this.layers[0],layout=layer.layout,textFont=layout.get("text-font"),textField=layout.get("text-field"),iconImage=layout.get("icon-image"),hasText=("constant"!==textField.value.kind||textField.value.value instanceof Formatted&&!textField.value.value.isEmpty()||textField.value.value.toString().length>0)&&("constant"!==textFont.value.kind||textFont.value.value.length>0),hasIcon="constant"!==iconImage.value.kind||!!iconImage.value.value||Object.keys(iconImage.parameters).length>0,symbolSortKey=layout.get("symbol-sort-key");if(this.features=[],!hasText&&!hasIcon)return;const icons=options.iconDependencies,stacks=options.glyphDependencies,availableImages=options.availableImages,globalProperties=new EvaluationParameters(this.zoom);for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=layer._featureFilter.needGeometry,evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!layer._featureFilter.filter(globalProperties,evaluationFeature,canonical))continue;let text,icon;if(needGeometry||(evaluationFeature.geometry=loadGeometry(feature)),hasText){const resolvedTokens=layer.getValueAndResolveTokens("text-field",evaluationFeature,canonical,availableImages),formattedText=Formatted.factory(resolvedTokens);containsRTLText(formattedText)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===rtlWorkerPlugin.getRTLTextPluginStatus()||this.hasRTLText&&rtlWorkerPlugin.isParsed())&&(text=transformText(formattedText,layer,evaluationFeature))}if(hasIcon){const resolvedTokens=layer.getValueAndResolveTokens("icon-image",evaluationFeature,canonical,availableImages);icon=resolvedTokens instanceof ResolvedImage?resolvedTokens:ResolvedImage.fromString(resolvedTokens)}if(!text&&!icon)continue;const sortKey=this.sortFeaturesByKey?symbolSortKey.evaluate(evaluationFeature,{},canonical):void 0,symbolFeature={id:id,text:text,icon:icon,index:index,sourceLayerIndex:sourceLayerIndex,geometry:evaluationFeature.geometry,properties:feature.properties,type:vectorTileFeatureTypes[feature.type],sortKey:sortKey};if(this.features.push(symbolFeature),icon&&(icons[icon.name]=!0),text){const fontStack=textFont.evaluate(evaluationFeature,{},canonical).join(","),textAlongLine="viewport"!==layout.get("text-rotation-alignment")&&"point"!==layout.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(exports.WritingMode.vertical)>=0;for(const section of text.sections)if(section.image)icons[section.image.name]=!0;else{const doesAllowVerticalWritingMode=allowsVerticalWritingMode(text.toString()),sectionFont=section.fontStack||fontStack,sectionStack=stacks[sectionFont]=stacks[sectionFont]||{};this.calculateGlyphDependencies(section.text,sectionStack,textAlongLine,this.allowVerticalPlacement,doesAllowVerticalWritingMode)}}}"line"===layout.get("symbol-placement")&&(this.features=function(features){const leftIndex={},rightIndex={},mergedFeatures=[];let mergedIndex=0;function add(k){mergedFeatures.push(features[k]),mergedIndex++}function mergeFromRight(leftKey,rightKey,geom){const i=rightIndex[leftKey];return delete rightIndex[leftKey],rightIndex[rightKey]=i,mergedFeatures[i].geometry[0].pop(),mergedFeatures[i].geometry[0]=mergedFeatures[i].geometry[0].concat(geom[0]),i}function mergeFromLeft(leftKey,rightKey,geom){const i=leftIndex[rightKey];return delete leftIndex[rightKey],leftIndex[leftKey]=i,mergedFeatures[i].geometry[0].shift(),mergedFeatures[i].geometry[0]=geom[0].concat(mergedFeatures[i].geometry[0]),i}function getKey(text,geom,onRight){const point=onRight?geom[0][geom[0].length-1]:geom[0][0];return`${text}:${point.x}:${point.y}`}for(let k=0;k<features.length;k++){const feature=features[k],geom=feature.geometry,text=feature.text?feature.text.toString():null;if(!text){add(k);continue}const leftKey=getKey(text,geom),rightKey=getKey(text,geom,!0);if(leftKey in rightIndex&&rightKey in leftIndex&&rightIndex[leftKey]!==leftIndex[rightKey]){const j=mergeFromLeft(leftKey,rightKey,geom),i=mergeFromRight(leftKey,rightKey,mergedFeatures[j].geometry);delete leftIndex[leftKey],delete rightIndex[rightKey],rightIndex[getKey(text,mergedFeatures[i].geometry,!0)]=i,mergedFeatures[j].geometry=null}else leftKey in rightIndex?mergeFromRight(leftKey,rightKey,geom):rightKey in leftIndex?mergeFromLeft(leftKey,rightKey,geom):(add(k),leftIndex[leftKey]=mergedIndex-1,rightIndex[rightKey]=mergedIndex-1)}return mergedFeatures.filter((f=>f.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((a,b)=>a.sortKey-b.sortKey))}update(states,vtLayer,imagePositions){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(states,vtLayer,this.layers,imagePositions),this.icon.programConfigurations.updatePaintArrays(states,vtLayer,this.layers,imagePositions))}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(context){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(context),this.iconCollisionBox.upload(context)),this.text.upload(context,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(context,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(anchor,line){const lineStartIndex=this.lineVertexArray.length;if(void 0!==anchor.segment){let sumForwardLength=anchor.dist(line[anchor.segment+1]),sumBackwardLength=anchor.dist(line[anchor.segment]);const vertices={};for(let i=anchor.segment+1;i<line.length;i++)vertices[i]={x:line[i].x,y:line[i].y,tileUnitDistanceFromAnchor:sumForwardLength},i<line.length-1&&(sumForwardLength+=line[i+1].dist(line[i]));for(let i=anchor.segment||0;i>=0;i--)vertices[i]={x:line[i].x,y:line[i].y,tileUnitDistanceFromAnchor:sumBackwardLength},i>0&&(sumBackwardLength+=line[i-1].dist(line[i]));for(let i=0;i<line.length;i++){const vertex=vertices[i];this.lineVertexArray.emplaceBack(vertex.x,vertex.y,vertex.tileUnitDistanceFromAnchor)}}return{lineStartIndex:lineStartIndex,lineLength:this.lineVertexArray.length-lineStartIndex}}addSymbols(arrays,quads,sizeVertex,lineOffset,alongLine,feature,writingMode,labelAnchor,lineStartIndex,lineLength,associatedIconIndex,canonical){const indexArray=arrays.indexArray,layoutVertexArray=arrays.layoutVertexArray,segment=arrays.segments.prepareSegment(4*quads.length,layoutVertexArray,indexArray,this.canOverlap?feature.sortKey:void 0),glyphOffsetArrayStart=this.glyphOffsetArray.length,vertexStartIndex=segment.vertexLength,angle=this.allowVerticalPlacement&&writingMode===exports.WritingMode.vertical?Math.PI/2:0,sections=feature.text&&feature.text.sections;for(let i=0;i<quads.length;i++){const{tl:tl,tr:tr,bl:bl,br:br,tex:tex,pixelOffsetTL:pixelOffsetTL,pixelOffsetBR:pixelOffsetBR,minFontScaleX:minFontScaleX,minFontScaleY:minFontScaleY,glyphOffset:glyphOffset,isSDF:isSDF,sectionIndex:sectionIndex}=quads[i],index=segment.vertexLength,y=glyphOffset[1];addVertex(layoutVertexArray,labelAnchor.x,labelAnchor.y,tl.x,y+tl.y,tex.x,tex.y,sizeVertex,isSDF,pixelOffsetTL.x,pixelOffsetTL.y,minFontScaleX,minFontScaleY),addVertex(layoutVertexArray,labelAnchor.x,labelAnchor.y,tr.x,y+tr.y,tex.x+tex.w,tex.y,sizeVertex,isSDF,pixelOffsetBR.x,pixelOffsetTL.y,minFontScaleX,minFontScaleY),addVertex(layoutVertexArray,labelAnchor.x,labelAnchor.y,bl.x,y+bl.y,tex.x,tex.y+tex.h,sizeVertex,isSDF,pixelOffsetTL.x,pixelOffsetBR.y,minFontScaleX,minFontScaleY),addVertex(layoutVertexArray,labelAnchor.x,labelAnchor.y,br.x,y+br.y,tex.x+tex.w,tex.y+tex.h,sizeVertex,isSDF,pixelOffsetBR.x,pixelOffsetBR.y,minFontScaleX,minFontScaleY),addDynamicAttributes(arrays.dynamicLayoutVertexArray,labelAnchor,angle),indexArray.emplaceBack(index,index+1,index+2),indexArray.emplaceBack(index+1,index+2,index+3),segment.vertexLength+=4,segment.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(glyphOffset[0]),i!==quads.length-1&&sectionIndex===quads[i+1].sectionIndex||arrays.programConfigurations.populatePaintArrays(layoutVertexArray.length,feature,feature.index,{},canonical,sections&&sections[sectionIndex])}arrays.placedSymbolArray.emplaceBack(labelAnchor.x,labelAnchor.y,glyphOffsetArrayStart,this.glyphOffsetArray.length-glyphOffsetArrayStart,vertexStartIndex,lineStartIndex,lineLength,labelAnchor.segment,sizeVertex?sizeVertex[0]:0,sizeVertex?sizeVertex[1]:0,lineOffset[0],lineOffset[1],writingMode,0,!1,0,associatedIconIndex)}_addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,point,anchorX,anchorY,extrude){return collisionVertexArray.emplaceBack(0,0),layoutVertexArray.emplaceBack(point.x,point.y,anchorX,anchorY,Math.round(extrude.x),Math.round(extrude.y))}addCollisionDebugVertices(x1,y1,x2,y2,arrays,boxAnchorPoint,symbolInstance){const segment=arrays.segments.prepareSegment(4,arrays.layoutVertexArray,arrays.indexArray),index=segment.vertexLength,layoutVertexArray=arrays.layoutVertexArray,collisionVertexArray=arrays.collisionVertexArray,anchorX=symbolInstance.anchorX,anchorY=symbolInstance.anchorY;this._addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,boxAnchorPoint,anchorX,anchorY,new Point$2(x1,y1)),this._addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,boxAnchorPoint,anchorX,anchorY,new Point$2(x2,y1)),this._addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,boxAnchorPoint,anchorX,anchorY,new Point$2(x2,y2)),this._addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,boxAnchorPoint,anchorX,anchorY,new Point$2(x1,y2)),segment.vertexLength+=4;const indexArray=arrays.indexArray;indexArray.emplaceBack(index,index+1),indexArray.emplaceBack(index+1,index+2),indexArray.emplaceBack(index+2,index+3),indexArray.emplaceBack(index+3,index),segment.primitiveLength+=4}addDebugCollisionBoxes(startIndex,endIndex,symbolInstance,isText){for(let b=startIndex;b<endIndex;b++){const box=this.collisionBoxArray.get(b),x1=box.x1,y1=box.y1,x2=box.x2,y2=box.y2;this.addCollisionDebugVertices(x1,y1,x2,y2,isText?this.textCollisionBox:this.iconCollisionBox,box.anchorPoint,symbolInstance)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new CollisionBuffers(CollisionBoxLayoutArray,collisionBoxLayout.members,LineIndexArray),this.iconCollisionBox=new CollisionBuffers(CollisionBoxLayoutArray,collisionBoxLayout.members,LineIndexArray);for(let i=0;i<this.symbolInstances.length;i++){const symbolInstance=this.symbolInstances.get(i);this.addDebugCollisionBoxes(symbolInstance.textBoxStartIndex,symbolInstance.textBoxEndIndex,symbolInstance,!0),this.addDebugCollisionBoxes(symbolInstance.verticalTextBoxStartIndex,symbolInstance.verticalTextBoxEndIndex,symbolInstance,!0),this.addDebugCollisionBoxes(symbolInstance.iconBoxStartIndex,symbolInstance.iconBoxEndIndex,symbolInstance,!1),this.addDebugCollisionBoxes(symbolInstance.verticalIconBoxStartIndex,symbolInstance.verticalIconBoxEndIndex,symbolInstance,!1)}}_deserializeCollisionBoxesForSymbol(collisionBoxArray,textStartIndex,textEndIndex,verticalTextStartIndex,verticalTextEndIndex,iconStartIndex,iconEndIndex,verticalIconStartIndex,verticalIconEndIndex){const collisionArrays={};for(let k=textStartIndex;k<textEndIndex;k++){const box=collisionBoxArray.get(k);collisionArrays.textBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY},collisionArrays.textFeatureIndex=box.featureIndex;break}for(let k=verticalTextStartIndex;k<verticalTextEndIndex;k++){const box=collisionBoxArray.get(k);collisionArrays.verticalTextBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY},collisionArrays.verticalTextFeatureIndex=box.featureIndex;break}for(let k=iconStartIndex;k<iconEndIndex;k++){const box=collisionBoxArray.get(k);collisionArrays.iconBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY},collisionArrays.iconFeatureIndex=box.featureIndex;break}for(let k=verticalIconStartIndex;k<verticalIconEndIndex;k++){const box=collisionBoxArray.get(k);collisionArrays.verticalIconBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY},collisionArrays.verticalIconFeatureIndex=box.featureIndex;break}return collisionArrays}deserializeCollisionBoxes(collisionBoxArray){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const symbolInstance=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(collisionBoxArray,symbolInstance.textBoxStartIndex,symbolInstance.textBoxEndIndex,symbolInstance.verticalTextBoxStartIndex,symbolInstance.verticalTextBoxEndIndex,symbolInstance.iconBoxStartIndex,symbolInstance.iconBoxEndIndex,symbolInstance.verticalIconBoxStartIndex,symbolInstance.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(iconOrText,placedSymbolIndex){const placedSymbol=iconOrText.placedSymbolArray.get(placedSymbolIndex),endIndex=placedSymbol.vertexStartIndex+4*placedSymbol.numGlyphs;for(let vertexIndex=placedSymbol.vertexStartIndex;vertexIndex<endIndex;vertexIndex+=4)iconOrText.indexArray.emplaceBack(vertexIndex,vertexIndex+1,vertexIndex+2),iconOrText.indexArray.emplaceBack(vertexIndex+1,vertexIndex+2,vertexIndex+3)}getSortedSymbolIndexes(angle){if(this.sortedAngle===angle&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const sin=Math.sin(angle),cos=Math.cos(angle),rotatedYs=[],featureIndexes=[],result=[];for(let i=0;i<this.symbolInstances.length;++i){result.push(i);const symbolInstance=this.symbolInstances.get(i);rotatedYs.push(0|Math.round(sin*symbolInstance.anchorX+cos*symbolInstance.anchorY)),featureIndexes.push(symbolInstance.featureIndex)}return result.sort(((aIndex,bIndex)=>rotatedYs[aIndex]-rotatedYs[bIndex]||featureIndexes[bIndex]-featureIndexes[aIndex])),result}addToSortKeyRanges(symbolInstanceIndex,sortKey){const last=this.sortKeyRanges[this.sortKeyRanges.length-1];last&&last.sortKey===sortKey?last.symbolInstanceEnd=symbolInstanceIndex+1:this.sortKeyRanges.push({sortKey:sortKey,symbolInstanceStart:symbolInstanceIndex,symbolInstanceEnd:symbolInstanceIndex+1})}sortFeatures(angle){if(this.sortFeaturesByY&&this.sortedAngle!==angle&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(angle),this.sortedAngle=angle,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const symbolInstance=this.symbolInstances.get(i);this.featureSortOrder.push(symbolInstance.featureIndex),[symbolInstance.rightJustifiedTextSymbolIndex,symbolInstance.centerJustifiedTextSymbolIndex,symbolInstance.leftJustifiedTextSymbolIndex].forEach(((index,i,array)=>{index>=0&&array.indexOf(index)===i&&this.addIndicesForPlacedSymbol(this.text,index)})),symbolInstance.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,symbolInstance.verticalPlacedTextSymbolIndex),symbolInstance.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,symbolInstance.placedIconSymbolIndex),symbolInstance.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,symbolInstance.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let layout;register("SymbolBucket",SymbolBucket,{omit:["layers","collisionBoxArray","features","compareText"]}),SymbolBucket.MAX_GLYPHS=65535,SymbolBucket.addDynamicAttributes=addDynamicAttributes;let paint$2;var properties$2={get paint(){return paint$2=paint$2||new Properties({"icon-opacity":new DataDrivenProperty(v8Spec.paint_symbol["icon-opacity"]),"icon-color":new DataDrivenProperty(v8Spec.paint_symbol["icon-color"]),"icon-halo-color":new DataDrivenProperty(v8Spec.paint_symbol["icon-halo-color"]),"icon-halo-width":new DataDrivenProperty(v8Spec.paint_symbol["icon-halo-width"]),"icon-halo-blur":new DataDrivenProperty(v8Spec.paint_symbol["icon-halo-blur"]),"icon-translate":new DataConstantProperty(v8Spec.paint_symbol["icon-translate"]),"icon-translate-anchor":new DataConstantProperty(v8Spec.paint_symbol["icon-translate-anchor"]),"text-opacity":new DataDrivenProperty(v8Spec.paint_symbol["text-opacity"]),"text-color":new DataDrivenProperty(v8Spec.paint_symbol["text-color"],{runtimeType:ColorType,getOverride:o=>o.textColor,hasOverride:o=>!!o.textColor}),"text-halo-color":new DataDrivenProperty(v8Spec.paint_symbol["text-halo-color"]),"text-halo-width":new DataDrivenProperty(v8Spec.paint_symbol["text-halo-width"]),"text-halo-blur":new DataDrivenProperty(v8Spec.paint_symbol["text-halo-blur"]),"text-translate":new DataConstantProperty(v8Spec.paint_symbol["text-translate"]),"text-translate-anchor":new DataConstantProperty(v8Spec.paint_symbol["text-translate-anchor"])})},get layout(){return layout=layout||new Properties({"symbol-placement":new DataConstantProperty(v8Spec.layout_symbol["symbol-placement"]),"symbol-spacing":new DataConstantProperty(v8Spec.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new DataConstantProperty(v8Spec.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new DataDrivenProperty(v8Spec.layout_symbol["symbol-sort-key"]),"symbol-z-order":new DataConstantProperty(v8Spec.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new DataConstantProperty(v8Spec.layout_symbol["icon-allow-overlap"]),"icon-overlap":new DataConstantProperty(v8Spec.layout_symbol["icon-overlap"]),"icon-ignore-placement":new DataConstantProperty(v8Spec.layout_symbol["icon-ignore-placement"]),"icon-optional":new DataConstantProperty(v8Spec.layout_symbol["icon-optional"]),"icon-rotation-alignment":new DataConstantProperty(v8Spec.layout_symbol["icon-rotation-alignment"]),"icon-size":new DataDrivenProperty(v8Spec.layout_symbol["icon-size"]),"icon-text-fit":new DataConstantProperty(v8Spec.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new DataConstantProperty(v8Spec.layout_symbol["icon-text-fit-padding"]),"icon-image":new DataDrivenProperty(v8Spec.layout_symbol["icon-image"]),"icon-rotate":new DataDrivenProperty(v8Spec.layout_symbol["icon-rotate"]),"icon-padding":new DataDrivenProperty(v8Spec.layout_symbol["icon-padding"]),"icon-keep-upright":new DataConstantProperty(v8Spec.layout_symbol["icon-keep-upright"]),"icon-offset":new DataDrivenProperty(v8Spec.layout_symbol["icon-offset"]),"icon-anchor":new DataDrivenProperty(v8Spec.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new DataConstantProperty(v8Spec.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new DataConstantProperty(v8Spec.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new DataConstantProperty(v8Spec.layout_symbol["text-rotation-alignment"]),"text-field":new DataDrivenProperty(v8Spec.layout_symbol["text-field"]),"text-font":new DataDrivenProperty(v8Spec.layout_symbol["text-font"]),"text-size":new DataDrivenProperty(v8Spec.layout_symbol["text-size"]),"text-max-width":new DataDrivenProperty(v8Spec.layout_symbol["text-max-width"]),"text-line-height":new DataConstantProperty(v8Spec.layout_symbol["text-line-height"]),"text-letter-spacing":new DataDrivenProperty(v8Spec.layout_symbol["text-letter-spacing"]),"text-justify":new DataDrivenProperty(v8Spec.layout_symbol["text-justify"]),"text-radial-offset":new DataDrivenProperty(v8Spec.layout_symbol["text-radial-offset"]),"text-variable-anchor":new DataConstantProperty(v8Spec.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new DataDrivenProperty(v8Spec.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new DataDrivenProperty(v8Spec.layout_symbol["text-anchor"]),"text-max-angle":new DataConstantProperty(v8Spec.layout_symbol["text-max-angle"]),"text-writing-mode":new DataConstantProperty(v8Spec.layout_symbol["text-writing-mode"]),"text-rotate":new DataDrivenProperty(v8Spec.layout_symbol["text-rotate"]),"text-padding":new DataConstantProperty(v8Spec.layout_symbol["text-padding"]),"text-keep-upright":new DataConstantProperty(v8Spec.layout_symbol["text-keep-upright"]),"text-transform":new DataDrivenProperty(v8Spec.layout_symbol["text-transform"]),"text-offset":new DataDrivenProperty(v8Spec.layout_symbol["text-offset"]),"text-allow-overlap":new DataConstantProperty(v8Spec.layout_symbol["text-allow-overlap"]),"text-overlap":new DataConstantProperty(v8Spec.layout_symbol["text-overlap"]),"text-ignore-placement":new DataConstantProperty(v8Spec.layout_symbol["text-ignore-placement"]),"text-optional":new DataConstantProperty(v8Spec.layout_symbol["text-optional"])})}};class FormatSectionOverride{constructor(defaultValue){if(void 0===defaultValue.property.overrides)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=defaultValue.property.overrides?defaultValue.property.overrides.runtimeType:NullType,this.defaultValue=defaultValue}evaluate(ctx){if(ctx.formattedSection){const overrides=this.defaultValue.property.overrides;if(overrides&&overrides.hasOverride(ctx.formattedSection))return overrides.getOverride(ctx.formattedSection)}return ctx.feature&&ctx.featureState?this.defaultValue.evaluate(ctx.feature,ctx.featureState):this.defaultValue.property.specification.default}eachChild(fn){if(!this.defaultValue.isConstant()){fn(this.defaultValue.value._styleExpression.expression)}}outputDefined(){return!1}serialize(){return null}}register("FormatSectionOverride",FormatSectionOverride,{omit:["defaultValue"]});class SymbolStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$2)}recalculate(parameters,availableImages){if(super.recalculate(parameters,availableImages),"auto"===this.layout.get("icon-rotation-alignment")&&("point"!==this.layout.get("symbol-placement")?this.layout._values["icon-rotation-alignment"]="map":this.layout._values["icon-rotation-alignment"]="viewport"),"auto"===this.layout.get("text-rotation-alignment")&&("point"!==this.layout.get("symbol-placement")?this.layout._values["text-rotation-alignment"]="map":this.layout._values["text-rotation-alignment"]="viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]="map"===this.layout.get("text-rotation-alignment")?"map":"viewport"),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),"point"===this.layout.get("symbol-placement")){const writingModes=this.layout.get("text-writing-mode");if(writingModes){const deduped=[];for(const m of writingModes)deduped.indexOf(m)<0&&deduped.push(m);this.layout._values["text-writing-mode"]=deduped}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(name,feature,canonical,availableImages){const value=this.layout.get(name).evaluate(feature,{},canonical,availableImages),unevaluated=this._unevaluatedLayout._values[name];return unevaluated.isDataDriven()||isExpression(unevaluated.value)||!value?value:function(properties,text){return text.replace(/{([^{}]+)}/g,((match,key)=>properties&&key in properties?String(properties[key]):""))}(feature.properties,value)}createBucket(parameters){return new SymbolBucket(parameters)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const overridable of properties$2.paint.overridableProperties){if(!SymbolStyleLayer.hasPaintOverride(this.layout,overridable))continue;const overriden=this.paint.get(overridable),override=new FormatSectionOverride(overriden),styleExpression=new StyleExpression(override,overriden.property.specification);let expression=null;expression="constant"===overriden.value.kind||"source"===overriden.value.kind?new ZoomConstantExpression("source",styleExpression):new ZoomDependentExpression("composite",styleExpression,overriden.value.zoomStops),this.paint._values[overridable]=new PossiblyEvaluatedPropertyValue(overriden.property,expression,overriden.parameters)}}_handleOverridablePaintPropertyUpdate(name,oldValue,newValue){return!(!this.layout||oldValue.isDataDriven()||newValue.isDataDriven())&&SymbolStyleLayer.hasPaintOverride(this.layout,name)}static hasPaintOverride(layout,propertyName){const textField=layout.get("text-field"),property=properties$2.paint.properties[propertyName];let hasOverrides=!1;const checkSections=sections=>{for(const section of sections)if(property.overrides&&property.overrides.hasOverride(section))return void(hasOverrides=!0)};if("constant"===textField.value.kind&&textField.value.value instanceof Formatted)checkSections(textField.value.value.sections);else if("source"===textField.value.kind){const checkExpression=expression=>{if(!hasOverrides)if(expression instanceof Literal&&typeOf(expression.value)===FormattedType){const formatted=expression.value;checkSections(formatted.sections)}else expression instanceof FormatExpression?checkSections(expression.sections):expression.eachChild(checkExpression)},expr=textField.value;expr._styleExpression&&checkExpression(expr._styleExpression.expression)}return hasOverrides}}let paint$1;var properties$1={get paint(){return paint$1=paint$1||new Properties({"background-color":new DataConstantProperty(v8Spec.paint_background["background-color"]),"background-pattern":new CrossFadedProperty(v8Spec.paint_background["background-pattern"]),"background-opacity":new DataConstantProperty(v8Spec.paint_background["background-opacity"])})}};class BackgroundStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$1)}}let paint;var properties={get paint(){return paint=paint||new Properties({"raster-opacity":new DataConstantProperty(v8Spec.paint_raster["raster-opacity"]),"raster-hue-rotate":new DataConstantProperty(v8Spec.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new DataConstantProperty(v8Spec.paint_raster["raster-brightness-min"]),"raster-brightness-max":new DataConstantProperty(v8Spec.paint_raster["raster-brightness-max"]),"raster-saturation":new DataConstantProperty(v8Spec.paint_raster["raster-saturation"]),"raster-contrast":new DataConstantProperty(v8Spec.paint_raster["raster-contrast"]),"raster-resampling":new DataConstantProperty(v8Spec.paint_raster["raster-resampling"]),"raster-fade-duration":new DataConstantProperty(v8Spec.paint_raster["raster-fade-duration"])})}};class RasterStyleLayer extends StyleLayer{constructor(layer){super(layer,properties)}}class CustomStyleLayer extends StyleLayer{constructor(implementation){super(implementation,{}),this.onAdd=map=>{this.implementation.onAdd&&this.implementation.onAdd(map,map.painter.context.gl)},this.onRemove=map=>{this.implementation.onRemove&&this.implementation.onRemove(map,map.painter.context.gl)},this.implementation=implementation}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class ThrottledInvoker{constructor(methodToThrottle){this._methodToThrottle=methodToThrottle,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._methodToThrottle()}),0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}class LngLat{constructor(lng,lat){if(isNaN(lng)||isNaN(lat))throw new Error(`Invalid LngLat object: (${lng}, ${lat})`);if(this.lng=+lng,this.lat=+lat,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new LngLat(wrap(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(lngLat){const rad=Math.PI/180,lat1=this.lat*rad,lat2=lngLat.lat*rad,a=Math.sin(lat1)*Math.sin(lat2)+Math.cos(lat1)*Math.cos(lat2)*Math.cos((lngLat.lng-this.lng)*rad);return 6371008.8*Math.acos(Math.min(a,1))}static convert(input){if(input instanceof LngLat)return input;if(Array.isArray(input)&&(2===input.length||3===input.length))return new LngLat(Number(input[0]),Number(input[1]));if(!Array.isArray(input)&&"object"==typeof input&&null!==input)return new LngLat(Number("lng"in input?input.lng:input.lon),Number(input.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const earthCircumfrence=2*Math.PI*6371008.8;function circumferenceAtLatitude(latitude){return earthCircumfrence*Math.cos(latitude*Math.PI/180)}function mercatorXfromLng(lng){return(180+lng)/360}function mercatorYfromLat(lat){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+lat*Math.PI/360)))/360}function mercatorZfromAltitude(altitude,lat){return altitude/circumferenceAtLatitude(lat)}function latFromMercatorY(y){const y2=180-360*y;return 360/Math.PI*Math.atan(Math.exp(y2*Math.PI/180))-90}class MercatorCoordinate{constructor(x,y,z=0){this.x=+x,this.y=+y,this.z=+z}static fromLngLat(lngLatLike,altitude=0){const lngLat=LngLat.convert(lngLatLike);return new MercatorCoordinate(mercatorXfromLng(lngLat.lng),mercatorYfromLat(lngLat.lat),mercatorZfromAltitude(altitude,lngLat.lat))}toLngLat(){return new LngLat(360*this.x-180,latFromMercatorY(this.y))}toAltitude(){return z=this.z,y=this.y,z*circumferenceAtLatitude(latFromMercatorY(y));var z,y}meterInMercatorCoordinateUnits(){return 1/earthCircumfrence*(lat=latFromMercatorY(this.y),1/Math.cos(lat*Math.PI/180));var lat}}function getTileBBox(x,y,z){var min=getMercCoords(256*x,256*(y=Math.pow(2,z)-y-1),z),max=getMercCoords(256*(x+1),256*(y+1),z);return min[0]+","+min[1]+","+max[0]+","+max[1]}function getMercCoords(x,y,z){var resolution=2*Math.PI*6378137/256/Math.pow(2,z);return[x*resolution-2*Math.PI*6378137/2,y*resolution-2*Math.PI*6378137/2]}class CanonicalTileID{constructor(z,x,y){if(z<0||z>25||y<0||y>=Math.pow(2,z)||x<0||x>=Math.pow(2,z))throw new Error(`x=${x}, y=${y}, z=${z} outside of bounds. 0<=x<${Math.pow(2,z)}, 0<=y<${Math.pow(2,z)} 0<=z<=25 `);this.z=z,this.x=x,this.y=y,this.key=calculateKey(0,z,z,x,y)}equals(id){return this.z===id.z&&this.x===id.x&&this.y===id.y}url(urls,pixelRatio,scheme){const bbox=getTileBBox(this.x,this.y,this.z),quadkey=function(z,x,y){let mask,quadkey="";for(let i=z;i>0;i--)mask=1<<i-1,quadkey+=(x&mask?1:0)+(y&mask?2:0);return quadkey}(this.z,this.x,this.y);return urls[(this.x+this.y)%urls.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===scheme?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,pixelRatio>1?"@2x":"").replace(/{quadkey}/g,quadkey).replace(/{bbox-epsg-3857}/g,bbox)}isChildOf(parent){const dz=this.z-parent.z;return dz>0&&parent.x===this.x>>dz&&parent.y===this.y>>dz}getTilePoint(coord){const tilesAtZoom=Math.pow(2,this.z);return new Point$2((coord.x*tilesAtZoom-this.x)*EXTENT,(coord.y*tilesAtZoom-this.y)*EXTENT)}toString(){return`${this.z}/${this.x}/${this.y}`}}class UnwrappedTileID{constructor(wrap,canonical){this.wrap=wrap,this.canonical=canonical,this.key=calculateKey(wrap,canonical.z,canonical.z,canonical.x,canonical.y)}}class OverscaledTileID{constructor(overscaledZ,wrap,z,x,y){if(overscaledZ<z)throw new Error(`overscaledZ should be >= z; overscaledZ = ${overscaledZ}; z = ${z}`);this.overscaledZ=overscaledZ,this.wrap=wrap,this.canonical=new CanonicalTileID(z,+x,+y),this.key=calculateKey(wrap,overscaledZ,z,x,y)}clone(){return new OverscaledTileID(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(id){return this.overscaledZ===id.overscaledZ&&this.wrap===id.wrap&&this.canonical.equals(id.canonical)}scaledTo(targetZ){if(targetZ>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${targetZ}; overscaledZ = ${this.overscaledZ}`);const zDifference=this.canonical.z-targetZ;return targetZ>this.canonical.z?new OverscaledTileID(targetZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new OverscaledTileID(targetZ,this.wrap,targetZ,this.canonical.x>>zDifference,this.canonical.y>>zDifference)}calculateScaledKey(targetZ,withWrap){if(targetZ>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${targetZ}; overscaledZ = ${this.overscaledZ}`);const zDifference=this.canonical.z-targetZ;return targetZ>this.canonical.z?calculateKey(this.wrap*+withWrap,targetZ,this.canonical.z,this.canonical.x,this.canonical.y):calculateKey(this.wrap*+withWrap,targetZ,targetZ,this.canonical.x>>zDifference,this.canonical.y>>zDifference)}isChildOf(parent){if(parent.wrap!==this.wrap)return!1;const zDifference=this.canonical.z-parent.canonical.z;return 0===parent.overscaledZ||parent.overscaledZ<this.overscaledZ&&parent.canonical.x===this.canonical.x>>zDifference&&parent.canonical.y===this.canonical.y>>zDifference}children(sourceMaxZoom){if(this.overscaledZ>=sourceMaxZoom)return[new OverscaledTileID(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const z=this.canonical.z+1,x=2*this.canonical.x,y=2*this.canonical.y;return[new OverscaledTileID(z,this.wrap,z,x,y),new OverscaledTileID(z,this.wrap,z,x+1,y),new OverscaledTileID(z,this.wrap,z,x,y+1),new OverscaledTileID(z,this.wrap,z,x+1,y+1)]}isLessThan(rhs){return this.wrap<rhs.wrap||!(this.wrap>rhs.wrap)&&(this.overscaledZ<rhs.overscaledZ||!(this.overscaledZ>rhs.overscaledZ)&&(this.canonical.x<rhs.canonical.x||!(this.canonical.x>rhs.canonical.x)&&this.canonical.y<rhs.canonical.y))}wrapped(){return new OverscaledTileID(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(wrap){return new OverscaledTileID(this.overscaledZ,wrap,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new UnwrappedTileID(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(coord){return this.canonical.getTilePoint(new MercatorCoordinate(coord.x-this.wrap,coord.y))}}function calculateKey(wrap,overscaledZ,z,x,y){(wrap*=2)<0&&(wrap=-1*wrap-1);const dim=1<<z;return(dim*dim*wrap+dim*y+x).toString(36)+z.toString(36)+overscaledZ.toString(36)}register("CanonicalTileID",CanonicalTileID),register("OverscaledTileID",OverscaledTileID,{omit:["posMatrix"]});class DEMData{constructor(uid,data,encoding,redFactor=1,greenFactor=1,blueFactor=1,baseShift=0){if(this.uid=uid,data.height!==data.width)throw new RangeError("DEM tiles must be square");if(encoding&&!["mapbox","terrarium","custom"].includes(encoding))return void warnOnce(`"${encoding}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=data.height;const dim=this.dim=data.height-2;switch(this.data=new Uint32Array(data.data.buffer),encoding){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=redFactor,this.greenFactor=greenFactor,this.blueFactor=blueFactor,this.baseShift=baseShift;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let x=0;x<dim;x++)this.data[this._idx(-1,x)]=this.data[this._idx(0,x)],this.data[this._idx(dim,x)]=this.data[this._idx(dim-1,x)],this.data[this._idx(x,-1)]=this.data[this._idx(x,0)],this.data[this._idx(x,dim)]=this.data[this._idx(x,dim-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(dim,-1)]=this.data[this._idx(dim-1,0)],this.data[this._idx(-1,dim)]=this.data[this._idx(0,dim-1)],this.data[this._idx(dim,dim)]=this.data[this._idx(dim-1,dim-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let x=0;x<dim;x++)for(let y=0;y<dim;y++){const ele=this.get(x,y);ele>this.max&&(this.max=ele),ele<this.min&&(this.min=ele)}}get(x,y){const pixels=new Uint8Array(this.data.buffer),index=4*this._idx(x,y);return this.unpack(pixels[index],pixels[index+1],pixels[index+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(x,y){if(x<-1||x>=this.dim+1||y<-1||y>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(y+1)*this.stride+(x+1)}unpack(r,g,b){return r*this.redFactor+g*this.greenFactor+b*this.blueFactor-this.baseShift}getPixels(){return new RGBAImage({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(borderTile,dx,dy){if(this.dim!==borderTile.dim)throw new Error("dem dimension mismatch");let xMin=dx*this.dim,xMax=dx*this.dim+this.dim,yMin=dy*this.dim,yMax=dy*this.dim+this.dim;switch(dx){case-1:xMin=xMax-1;break;case 1:xMax=xMin+1}switch(dy){case-1:yMin=yMax-1;break;case 1:yMax=yMin+1}const ox=-dx*this.dim,oy=-dy*this.dim;for(let y=yMin;y<yMax;y++)for(let x=xMin;x<xMax;x++)this.data[this._idx(x,y)]=borderTile.data[this._idx(x+ox,y+oy)]}}register("DEMData",DEMData);class DictionaryCoder{constructor(strings){this._stringToNumber={},this._numberToString=[];for(let i=0;i<strings.length;i++){const string=strings[i];this._stringToNumber[string]=i,this._numberToString[i]=string}}encode(string){return this._stringToNumber[string]}decode(n){if(n>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${n} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[n]}}class GeoJSONFeature{constructor(vectorTileFeature,z,x,y,id){this.type="Feature",this._vectorTileFeature=vectorTileFeature,vectorTileFeature._z=z,vectorTileFeature._x=x,vectorTileFeature._y=y,this.properties=vectorTileFeature.properties,this.id=id}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(g){this._geometry=g}toJSON(){const json={geometry:this.geometry};for(const i in this)"_geometry"!==i&&"_vectorTileFeature"!==i&&(json[i]=this[i]);return json}}class FeatureIndex{constructor(tileID,promoteId){this.tileID=tileID,this.x=tileID.canonical.x,this.y=tileID.canonical.y,this.z=tileID.canonical.z,this.grid=new TransferableGridIndex(EXTENT,16,0),this.grid3D=new TransferableGridIndex(EXTENT,16,0),this.featureIndexArray=new FeatureIndexArray,this.promoteId=promoteId}insert(feature,geometry,featureIndex,sourceLayerIndex,bucketIndex,is3D){const key=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(featureIndex,sourceLayerIndex,bucketIndex);const grid=is3D?this.grid3D:this.grid;for(let r=0;r<geometry.length;r++){const ring=geometry[r],bbox=[1/0,1/0,-1/0,-1/0];for(let i=0;i<ring.length;i++){const p=ring[i];bbox[0]=Math.min(bbox[0],p.x),bbox[1]=Math.min(bbox[1],p.y),bbox[2]=Math.max(bbox[2],p.x),bbox[3]=Math.max(bbox[3],p.y)}bbox[0]<EXTENT&&bbox[1]<EXTENT&&bbox[2]>=0&&bbox[3]>=0&&grid.insert(key,bbox[0],bbox[1],bbox[2],bbox[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new vectorTile.VectorTile(new Protobuf(this.rawTileData)).layers,this.sourceLayerCoder=new DictionaryCoder(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(args,styleLayers,serializedLayers,sourceFeatureState){this.loadVTLayers();const params=args.params||{},pixelsToTileUnits=EXTENT/args.tileSize/args.scale,filter=createFilter(params.filter),queryGeometry=args.queryGeometry,queryPadding=args.queryPadding*pixelsToTileUnits,bounds=getBounds(queryGeometry),matching=this.grid.query(bounds.minX-queryPadding,bounds.minY-queryPadding,bounds.maxX+queryPadding,bounds.maxY+queryPadding),cameraBounds=getBounds(args.cameraQueryGeometry),matching3D=this.grid3D.query(cameraBounds.minX-queryPadding,cameraBounds.minY-queryPadding,cameraBounds.maxX+queryPadding,cameraBounds.maxY+queryPadding,((bx1,by1,bx2,by2)=>function(ring,boxX1,boxY1,boxX2,boxY2){for(const p of ring)if(boxX1<=p.x&&boxY1<=p.y&&boxX2>=p.x&&boxY2>=p.y)return!0;const corners=[new Point$2(boxX1,boxY1),new Point$2(boxX1,boxY2),new Point$2(boxX2,boxY2),new Point$2(boxX2,boxY1)];if(ring.length>2)for(const corner of corners)if(polygonContainsPoint(ring,corner))return!0;for(let i=0;i<ring.length-1;i++)if(edgeIntersectsBox(ring[i],ring[i+1],corners))return!0;return!1}(args.cameraQueryGeometry,bx1-queryPadding,by1-queryPadding,bx2+queryPadding,by2+queryPadding)));for(const key of matching3D)matching.push(key);matching.sort(topDownFeatureComparator);const result={};let previousIndex;for(let k=0;k<matching.length;k++){const index=matching[k];if(index===previousIndex)continue;previousIndex=index;const match=this.featureIndexArray.get(index);let featureGeometry=null;this.loadMatchingFeature(result,match.bucketIndex,match.sourceLayerIndex,match.featureIndex,filter,params.layers,params.availableImages,styleLayers,serializedLayers,sourceFeatureState,((feature,styleLayer,featureState)=>(featureGeometry||(featureGeometry=loadGeometry(feature)),styleLayer.queryIntersectsFeature(queryGeometry,feature,featureState,featureGeometry,this.z,args.transform,pixelsToTileUnits,args.pixelPosMatrix))))}return result}loadMatchingFeature(result,bucketIndex,sourceLayerIndex,featureIndex,filter,filterLayerIDs,availableImages,styleLayers,serializedLayers,sourceFeatureState,intersectionTest){const layerIDs=this.bucketLayerIDs[bucketIndex];if(filterLayerIDs&&!function(a,b){for(let l=0;l<a.length;l++)if(b.indexOf(a[l])>=0)return!0;return!1}(filterLayerIDs,layerIDs))return;const sourceLayerName=this.sourceLayerCoder.decode(sourceLayerIndex),feature=this.vtLayers[sourceLayerName].feature(featureIndex);if(filter.needGeometry){const evaluationFeature=toEvaluationFeature(feature,!0);if(!filter.filter(new EvaluationParameters(this.tileID.overscaledZ),evaluationFeature,this.tileID.canonical))return}else if(!filter.filter(new EvaluationParameters(this.tileID.overscaledZ),feature))return;const id=this.getId(feature,sourceLayerName);for(let l=0;l<layerIDs.length;l++){const layerID=layerIDs[l];if(filterLayerIDs&&filterLayerIDs.indexOf(layerID)<0)continue;const styleLayer=styleLayers[layerID];if(!styleLayer)continue;let featureState={};id&&sourceFeatureState&&(featureState=sourceFeatureState.getState(styleLayer.sourceLayer||"_geojsonTileLayer",id));const serializedLayer=extend({},serializedLayers[layerID]);serializedLayer.paint=evaluateProperties(serializedLayer.paint,styleLayer.paint,feature,featureState,availableImages),serializedLayer.layout=evaluateProperties(serializedLayer.layout,styleLayer.layout,feature,featureState,availableImages);const intersectionZ=!intersectionTest||intersectionTest(feature,styleLayer,featureState);if(!intersectionZ)continue;const geojsonFeature=new GeoJSONFeature(feature,this.z,this.x,this.y,id);geojsonFeature.layer=serializedLayer;let layerResult=result[layerID];void 0===layerResult&&(layerResult=result[layerID]=[]),layerResult.push({featureIndex:featureIndex,feature:geojsonFeature,intersectionZ:intersectionZ})}}lookupSymbolFeatures(symbolFeatureIndexes,serializedLayers,bucketIndex,sourceLayerIndex,filterSpec,filterLayerIDs,availableImages,styleLayers){const result={};this.loadVTLayers();const filter=createFilter(filterSpec);for(const symbolFeatureIndex of symbolFeatureIndexes)this.loadMatchingFeature(result,bucketIndex,sourceLayerIndex,symbolFeatureIndex,filter,filterLayerIDs,availableImages,styleLayers,serializedLayers);return result}hasLayer(id){for(const layerIDs of this.bucketLayerIDs)for(const layerID of layerIDs)if(id===layerID)return!0;return!1}getId(feature,sourceLayerId){let id=feature.id;if(this.promoteId){const propName="string"==typeof this.promoteId?this.promoteId:this.promoteId[sourceLayerId];id=feature.properties[propName],"boolean"==typeof id&&(id=Number(id))}return id}}function evaluateProperties(serializedProperties,styleLayerProperties,feature,featureState,availableImages){return mapObject(serializedProperties,((property,key)=>{const prop=styleLayerProperties instanceof PossiblyEvaluated?styleLayerProperties.get(key):null;return prop&&prop.evaluate?prop.evaluate(feature,featureState,availableImages):prop}))}function getBounds(geometry){let minX=1/0,minY=1/0,maxX=-1/0,maxY=-1/0;for(const p of geometry)minX=Math.min(minX,p.x),minY=Math.min(minY,p.y),maxX=Math.max(maxX,p.x),maxY=Math.max(maxY,p.y);return{minX:minX,minY:minY,maxX:maxX,maxY:maxY}}function topDownFeatureComparator(a,b){return b-a}function clipLine(lines,x1,y1,x2,y2){const clippedLines=[];for(let l=0;l<lines.length;l++){const line=lines[l];let clippedLine;for(let i=0;i<line.length-1;i++){let p0=line[i],p1=line[i+1];p0.x<x1&&p1.x<x1||(p0.x<x1?p0=new Point$2(x1,p0.y+(p1.y-p0.y)*((x1-p0.x)/(p1.x-p0.x)))._round():p1.x<x1&&(p1=new Point$2(x1,p0.y+(p1.y-p0.y)*((x1-p0.x)/(p1.x-p0.x)))._round()),p0.y<y1&&p1.y<y1||(p0.y<y1?p0=new Point$2(p0.x+(p1.x-p0.x)*((y1-p0.y)/(p1.y-p0.y)),y1)._round():p1.y<y1&&(p1=new Point$2(p0.x+(p1.x-p0.x)*((y1-p0.y)/(p1.y-p0.y)),y1)._round()),p0.x>=x2&&p1.x>=x2||(p0.x>=x2?p0=new Point$2(x2,p0.y+(p1.y-p0.y)*((x2-p0.x)/(p1.x-p0.x)))._round():p1.x>=x2&&(p1=new Point$2(x2,p0.y+(p1.y-p0.y)*((x2-p0.x)/(p1.x-p0.x)))._round()),p0.y>=y2&&p1.y>=y2||(p0.y>=y2?p0=new Point$2(p0.x+(p1.x-p0.x)*((y2-p0.y)/(p1.y-p0.y)),y2)._round():p1.y>=y2&&(p1=new Point$2(p0.x+(p1.x-p0.x)*((y2-p0.y)/(p1.y-p0.y)),y2)._round()),clippedLine&&p0.equals(clippedLine[clippedLine.length-1])||(clippedLine=[p0],clippedLines.push(clippedLine)),clippedLine.push(p1)))))}}return clippedLines}register("FeatureIndex",FeatureIndex,{omit:["rawTileData","sourceLayerCoder"]});class Anchor extends Point$2{constructor(x,y,angle,segment){super(x,y),this.angle=angle,void 0!==segment&&(this.segment=segment)}clone(){return new Anchor(this.x,this.y,this.angle,this.segment)}}function checkMaxAngle(line,anchor,labelLength,windowSize,maxAngle){if(void 0===anchor.segment||0===labelLength)return!0;let p=anchor,index=anchor.segment+1,anchorDistance=0;for(;anchorDistance>-labelLength/2;){if(index--,index<0)return!1;anchorDistance-=line[index].dist(p),p=line[index]}anchorDistance+=line[index].dist(line[index+1]),index++;const recentCorners=[];let recentAngleDelta=0;for(;anchorDistance<labelLength/2;){const prev=line[index-1],current=line[index],next=line[index+1];if(!next)return!1;let angleDelta=prev.angleTo(current)-current.angleTo(next);for(angleDelta=Math.abs((angleDelta+3*Math.PI)%(2*Math.PI)-Math.PI),recentCorners.push({distance:anchorDistance,angleDelta:angleDelta}),recentAngleDelta+=angleDelta;anchorDistance-recentCorners[0].distance>windowSize;)recentAngleDelta-=recentCorners.shift().angleDelta;if(recentAngleDelta>maxAngle)return!1;index++,anchorDistance+=current.dist(next)}return!0}function getLineLength(line){let lineLength=0;for(let k=0;k<line.length-1;k++)lineLength+=line[k].dist(line[k+1]);return lineLength}function getAngleWindowSize(shapedText,glyphSize,boxScale){return shapedText?.6*glyphSize*boxScale:0}function getShapedLabelLength(shapedText,shapedIcon){return Math.max(shapedText?shapedText.right-shapedText.left:0,shapedIcon?shapedIcon.right-shapedIcon.left:0)}function getCenterAnchor(line,maxAngle,shapedText,shapedIcon,glyphSize,boxScale){const angleWindowSize=getAngleWindowSize(shapedText,glyphSize,boxScale),labelLength=getShapedLabelLength(shapedText,shapedIcon)*boxScale;let prevDistance=0;const centerDistance=getLineLength(line)/2;for(let i=0;i<line.length-1;i++){const a=line[i],b=line[i+1],segmentDistance=a.dist(b);if(prevDistance+segmentDistance>centerDistance){const t=(centerDistance-prevDistance)/segmentDistance,x=interpolate.number(a.x,b.x,t),y=interpolate.number(a.y,b.y,t),anchor=new Anchor(x,y,b.angleTo(a),i);return anchor._round(),!angleWindowSize||checkMaxAngle(line,anchor,labelLength,angleWindowSize,maxAngle)?anchor:void 0}prevDistance+=segmentDistance}}function getAnchors(line,spacing,maxAngle,shapedText,shapedIcon,glyphSize,boxScale,overscaling,tileExtent){const angleWindowSize=getAngleWindowSize(shapedText,glyphSize,boxScale),shapedLabelLength=getShapedLabelLength(shapedText,shapedIcon),labelLength=shapedLabelLength*boxScale,isLineContinued=0===line[0].x||line[0].x===tileExtent||0===line[0].y||line[0].y===tileExtent;spacing-labelLength<spacing/4&&(spacing=labelLength+spacing/4);return resample(line,isLineContinued?spacing/2*overscaling%spacing:(shapedLabelLength/2+2*glyphSize)*boxScale*overscaling%spacing,spacing,angleWindowSize,maxAngle,labelLength,isLineContinued,!1,tileExtent)}function resample(line,offset,spacing,angleWindowSize,maxAngle,labelLength,isLineContinued,placeAtMiddle,tileExtent){const halfLabelLength=labelLength/2,lineLength=getLineLength(line);let distance=0,markedDistance=offset-spacing,anchors=[];for(let i=0;i<line.length-1;i++){const a=line[i],b=line[i+1],segmentDist=a.dist(b),angle=b.angleTo(a);for(;markedDistance+spacing<distance+segmentDist;){markedDistance+=spacing;const t=(markedDistance-distance)/segmentDist,x=interpolate.number(a.x,b.x,t),y=interpolate.number(a.y,b.y,t);if(x>=0&&x<tileExtent&&y>=0&&y<tileExtent&&markedDistance-halfLabelLength>=0&&markedDistance+halfLabelLength<=lineLength){const anchor=new Anchor(x,y,angle,i);anchor._round(),angleWindowSize&&!checkMaxAngle(line,anchor,labelLength,angleWindowSize,maxAngle)||anchors.push(anchor)}}distance+=segmentDist}return placeAtMiddle||anchors.length||isLineContinued||(anchors=resample(line,distance/2,spacing,angleWindowSize,maxAngle,labelLength,isLineContinued,!0,tileExtent)),anchors}register("Anchor",Anchor);const border=IMAGE_PADDING;function getIconQuads(shapedIcon,iconRotate,isSDFIcon,hasIconTextFit){const quads=[],image=shapedIcon.image,pixelRatio=image.pixelRatio,imageWidth=image.paddedRect.w-2*border,imageHeight=image.paddedRect.h-2*border,iconWidth=shapedIcon.right-shapedIcon.left,iconHeight=shapedIcon.bottom-shapedIcon.top,stretchX=image.stretchX||[[0,imageWidth]],stretchY=image.stretchY||[[0,imageHeight]],reduceRanges=(sum,range)=>sum+range[1]-range[0],stretchWidth=stretchX.reduce(reduceRanges,0),stretchHeight=stretchY.reduce(reduceRanges,0),fixedWidth=imageWidth-stretchWidth,fixedHeight=imageHeight-stretchHeight;let stretchOffsetX=0,stretchContentWidth=stretchWidth,stretchOffsetY=0,stretchContentHeight=stretchHeight,fixedOffsetX=0,fixedContentWidth=fixedWidth,fixedOffsetY=0,fixedContentHeight=fixedHeight;if(image.content&&hasIconTextFit){const content=image.content;stretchOffsetX=sumWithinRange(stretchX,0,content[0]),stretchOffsetY=sumWithinRange(stretchY,0,content[1]),stretchContentWidth=sumWithinRange(stretchX,content[0],content[2]),stretchContentHeight=sumWithinRange(stretchY,content[1],content[3]),fixedOffsetX=content[0]-stretchOffsetX,fixedOffsetY=content[1]-stretchOffsetY,fixedContentWidth=content[2]-content[0]-stretchContentWidth,fixedContentHeight=content[3]-content[1]-stretchContentHeight}const makeBox=(left,top,right,bottom)=>{const leftEm=getEmOffset(left.stretch-stretchOffsetX,stretchContentWidth,iconWidth,shapedIcon.left),leftPx=getPxOffset(left.fixed-fixedOffsetX,fixedContentWidth,left.stretch,stretchWidth),topEm=getEmOffset(top.stretch-stretchOffsetY,stretchContentHeight,iconHeight,shapedIcon.top),topPx=getPxOffset(top.fixed-fixedOffsetY,fixedContentHeight,top.stretch,stretchHeight),rightEm=getEmOffset(right.stretch-stretchOffsetX,stretchContentWidth,iconWidth,shapedIcon.left),rightPx=getPxOffset(right.fixed-fixedOffsetX,fixedContentWidth,right.stretch,stretchWidth),bottomEm=getEmOffset(bottom.stretch-stretchOffsetY,stretchContentHeight,iconHeight,shapedIcon.top),bottomPx=getPxOffset(bottom.fixed-fixedOffsetY,fixedContentHeight,bottom.stretch,stretchHeight),tl=new Point$2(leftEm,topEm),tr=new Point$2(rightEm,topEm),br=new Point$2(rightEm,bottomEm),bl=new Point$2(leftEm,bottomEm),pixelOffsetTL=new Point$2(leftPx/pixelRatio,topPx/pixelRatio),pixelOffsetBR=new Point$2(rightPx/pixelRatio,bottomPx/pixelRatio),angle=iconRotate*Math.PI/180;if(angle){const sin=Math.sin(angle),cos=Math.cos(angle),matrix=[cos,-sin,sin,cos];tl._matMult(matrix),tr._matMult(matrix),bl._matMult(matrix),br._matMult(matrix)}const x1=left.stretch+left.fixed,x2=right.stretch+right.fixed,y1=top.stretch+top.fixed,y2=bottom.stretch+bottom.fixed;return{tl:tl,tr:tr,bl:bl,br:br,tex:{x:image.paddedRect.x+border+x1,y:image.paddedRect.y+border+y1,w:x2-x1,h:y2-y1},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:pixelOffsetTL,pixelOffsetBR:pixelOffsetBR,minFontScaleX:fixedContentWidth/pixelRatio/iconWidth,minFontScaleY:fixedContentHeight/pixelRatio/iconHeight,isSDF:isSDFIcon}};if(hasIconTextFit&&(image.stretchX||image.stretchY)){const xCuts=stretchZonesToCuts(stretchX,fixedWidth,stretchWidth),yCuts=stretchZonesToCuts(stretchY,fixedHeight,stretchHeight);for(let xi=0;xi<xCuts.length-1;xi++){const x1=xCuts[xi],x2=xCuts[xi+1];for(let yi=0;yi<yCuts.length-1;yi++){const y1=yCuts[yi],y2=yCuts[yi+1];quads.push(makeBox(x1,y1,x2,y2))}}}else quads.push(makeBox({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:imageWidth+1},{fixed:0,stretch:imageHeight+1}));return quads}function sumWithinRange(ranges,min,max){let sum=0;for(const range of ranges)sum+=Math.max(min,Math.min(max,range[1]))-Math.max(min,Math.min(max,range[0]));return sum}function stretchZonesToCuts(stretchZones,fixedSize,stretchSize){const cuts=[{fixed:-border,stretch:0}];for(const[c1,c2]of stretchZones){const last=cuts[cuts.length-1];cuts.push({fixed:c1-last.stretch,stretch:last.stretch}),cuts.push({fixed:c1-last.stretch,stretch:last.stretch+(c2-c1)})}return cuts.push({fixed:fixedSize+border,stretch:stretchSize}),cuts}function getEmOffset(stretchOffset,stretchSize,iconSize,iconOffset){return stretchOffset/stretchSize*iconSize+iconOffset}function getPxOffset(fixedOffset,fixedSize,stretchOffset,stretchSize){return fixedOffset-fixedSize*stretchOffset/stretchSize}class CollisionFeature{constructor(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,shaped,boxScale,padding,alignLine,rotate){if(this.boxStartIndex=collisionBoxArray.length,alignLine){let top=shaped.top,bottom=shaped.bottom;const collisionPadding=shaped.collisionPadding;collisionPadding&&(top-=collisionPadding[1],bottom+=collisionPadding[3]);let height=bottom-top;height>0&&(height=Math.max(10,height),this.circleDiameter=height)}else{let y1=shaped.top*boxScale-padding[0],y2=shaped.bottom*boxScale+padding[2],x1=shaped.left*boxScale-padding[3],x2=shaped.right*boxScale+padding[1];const collisionPadding=shaped.collisionPadding;if(collisionPadding&&(x1-=collisionPadding[0]*boxScale,y1-=collisionPadding[1]*boxScale,x2+=collisionPadding[2]*boxScale,y2+=collisionPadding[3]*boxScale),rotate){const tl=new Point$2(x1,y1),tr=new Point$2(x2,y1),bl=new Point$2(x1,y2),br=new Point$2(x2,y2),rotateRadians=rotate*Math.PI/180;tl._rotate(rotateRadians),tr._rotate(rotateRadians),bl._rotate(rotateRadians),br._rotate(rotateRadians),x1=Math.min(tl.x,tr.x,bl.x,br.x),x2=Math.max(tl.x,tr.x,bl.x,br.x),y1=Math.min(tl.y,tr.y,bl.y,br.y),y2=Math.max(tl.y,tr.y,bl.y,br.y)}collisionBoxArray.emplaceBack(anchor.x,anchor.y,x1,y1,x2,y2,featureIndex,sourceLayerIndex,bucketIndex)}this.boxEndIndex=collisionBoxArray.length}}class TinyQueue{constructor(data=[],compare=defaultCompare){if(this.data=data,this.length=this.data.length,this.compare=compare,this.length>0)for(let i=(this.length>>1)-1;i>=0;i--)this._down(i)}push(item){this.data.push(item),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const top=this.data[0],bottom=this.data.pop();return this.length--,this.length>0&&(this.data[0]=bottom,this._down(0)),top}peek(){return this.data[0]}_up(pos){const{data:data,compare:compare}=this,item=data[pos];for(;pos>0;){const parent=pos-1>>1,current=data[parent];if(compare(item,current)>=0)break;data[pos]=current,pos=parent}data[pos]=item}_down(pos){const{data:data,compare:compare}=this,halfLength=this.length>>1,item=data[pos];for(;pos<halfLength;){let left=1+(pos<<1),best=data[left];const right=left+1;if(right<this.length&&compare(data[right],best)<0&&(left=right,best=data[right]),compare(best,item)>=0)break;data[pos]=best,pos=left}data[pos]=item}}function defaultCompare(a,b){return a<b?-1:a>b?1:0}function findPoleOfInaccessibility(polygonRings,precision=1,debug=!1){let minX=1/0,minY=1/0,maxX=-1/0,maxY=-1/0;const outerRing=polygonRings[0];for(let i=0;i<outerRing.length;i++){const p=outerRing[i];(!i||p.x<minX)&&(minX=p.x),(!i||p.y<minY)&&(minY=p.y),(!i||p.x>maxX)&&(maxX=p.x),(!i||p.y>maxY)&&(maxY=p.y)}const width=maxX-minX,height=maxY-minY,cellSize=Math.min(width,height);let h=cellSize/2;const cellQueue=new TinyQueue([],compareMax);if(0===cellSize)return new Point$2(minX,minY);for(let x=minX;x<maxX;x+=cellSize)for(let y=minY;y<maxY;y+=cellSize)cellQueue.push(new Cell(x+h,y+h,h,polygonRings));let bestCell=function(polygon){let area=0,x=0,y=0;const points=polygon[0];for(let i=0,len=points.length,j=len-1;i<len;j=i++){const a=points[i],b=points[j],f=a.x*b.y-b.x*a.y;x+=(a.x+b.x)*f,y+=(a.y+b.y)*f,area+=3*f}return new Cell(x/area,y/area,0,polygon)}(polygonRings),numProbes=cellQueue.length;for(;cellQueue.length;){const cell=cellQueue.pop();(cell.d>bestCell.d||!bestCell.d)&&(bestCell=cell,debug&&console.log("found best %d after %d probes",Math.round(1e4*cell.d)/1e4,numProbes)),cell.max-bestCell.d<=precision||(h=cell.h/2,cellQueue.push(new Cell(cell.p.x-h,cell.p.y-h,h,polygonRings)),cellQueue.push(new Cell(cell.p.x+h,cell.p.y-h,h,polygonRings)),cellQueue.push(new Cell(cell.p.x-h,cell.p.y+h,h,polygonRings)),cellQueue.push(new Cell(cell.p.x+h,cell.p.y+h,h,polygonRings)),numProbes+=4)}return debug&&(console.log(`num probes: ${numProbes}`),console.log(`best distance: ${bestCell.d}`)),bestCell.p}function compareMax(a,b){return b.max-a.max}function Cell(x,y,h,polygon){this.p=new Point$2(x,y),this.h=h,this.d=function(p,polygon){let inside=!1,minDistSq=1/0;for(let k=0;k<polygon.length;k++){const ring=polygon[k];for(let i=0,len=ring.length,j=len-1;i<len;j=i++){const a=ring[i],b=ring[j];a.y>p.y!=b.y>p.y&&p.x<(b.x-a.x)*(p.y-a.y)/(b.y-a.y)+a.x&&(inside=!inside),minDistSq=Math.min(minDistSq,distToSegmentSquared(p,a,b))}}return(inside?1:-1)*Math.sqrt(minDistSq)}(this.p,polygon),this.max=this.d+this.h*Math.SQRT2}var TextAnchorEnum;exports.TextAnchorEnum=void 0,(TextAnchorEnum=exports.TextAnchorEnum||(exports.TextAnchorEnum={}))[TextAnchorEnum.center=1]="center",TextAnchorEnum[TextAnchorEnum.left=2]="left",TextAnchorEnum[TextAnchorEnum.right=3]="right",TextAnchorEnum[TextAnchorEnum.top=4]="top",TextAnchorEnum[TextAnchorEnum.bottom=5]="bottom",TextAnchorEnum[TextAnchorEnum["top-left"]=6]="top-left",TextAnchorEnum[TextAnchorEnum["top-right"]=7]="top-right",TextAnchorEnum[TextAnchorEnum["bottom-left"]=8]="bottom-left",TextAnchorEnum[TextAnchorEnum["bottom-right"]=9]="bottom-right";const baselineOffset=7,INVALID_TEXT_OFFSET=Number.POSITIVE_INFINITY;function evaluateVariableOffset(anchor,offset){return offset[1]!==INVALID_TEXT_OFFSET?function(anchor,offsetX,offsetY){let x=0,y=0;switch(offsetX=Math.abs(offsetX),offsetY=Math.abs(offsetY),anchor){case"top-right":case"top-left":case"top":y=offsetY-baselineOffset;break;case"bottom-right":case"bottom-left":case"bottom":y=-offsetY+baselineOffset}switch(anchor){case"top-right":case"bottom-right":case"right":x=-offsetX;break;case"top-left":case"bottom-left":case"left":x=offsetX}return[x,y]}(anchor,offset[0],offset[1]):function(anchor,radialOffset){let x=0,y=0;radialOffset<0&&(radialOffset=0);const hypotenuse=radialOffset/Math.SQRT2;switch(anchor){case"top-right":case"top-left":y=hypotenuse-baselineOffset;break;case"bottom-right":case"bottom-left":y=-hypotenuse+baselineOffset;break;case"bottom":y=-radialOffset+baselineOffset;break;case"top":y=radialOffset-baselineOffset}switch(anchor){case"top-right":case"bottom-right":x=-hypotenuse;break;case"top-left":case"bottom-left":x=hypotenuse;break;case"left":x=radialOffset;break;case"right":x=-radialOffset}return[x,y]}(anchor,offset[0])}function getTextVariableAnchorOffset(layer,feature,canonical){var _a;const layout=layer.layout,variableAnchorOffset=null===(_a=layout.get("text-variable-anchor-offset"))||void 0===_a?void 0:_a.evaluate(feature,{},canonical);if(variableAnchorOffset){const sourceValues=variableAnchorOffset.values,destValues=[];for(let i=0;i<sourceValues.length;i+=2){const anchor=destValues[i]=sourceValues[i],offset=sourceValues[i+1].map((t=>t*ONE_EM));anchor.startsWith("top")?offset[1]-=baselineOffset:anchor.startsWith("bottom")&&(offset[1]+=baselineOffset),destValues[i+1]=offset}return new VariableAnchorOffsetCollection(destValues)}const variableAnchor=layout.get("text-variable-anchor");if(variableAnchor){let textOffset;textOffset=void 0!==layer._unevaluatedLayout.getValue("text-radial-offset")?[layout.get("text-radial-offset").evaluate(feature,{},canonical)*ONE_EM,INVALID_TEXT_OFFSET]:layout.get("text-offset").evaluate(feature,{},canonical).map((t=>t*ONE_EM));const anchorOffsets=[];for(const anchor of variableAnchor)anchorOffsets.push(anchor,evaluateVariableOffset(anchor,textOffset));return new VariableAnchorOffsetCollection(anchorOffsets)}return null}function getAnchorJustification(anchor){switch(anchor){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function addFeature(bucket,feature,shapedTextOrientations,shapedIcon,imageMap,sizes,layoutTextSize,layoutIconSize,textOffset,isSDFIcon,canonical){let textMaxSize=sizes.textMaxSize.evaluate(feature,{});void 0===textMaxSize&&(textMaxSize=layoutTextSize);const layout=bucket.layers[0].layout,iconOffset=layout.get("icon-offset").evaluate(feature,{},canonical),defaultHorizontalShaping=getDefaultHorizontalShaping(shapedTextOrientations.horizontal),fontScale=layoutTextSize/24,textBoxScale=bucket.tilePixelRatio*fontScale,textMaxBoxScale=bucket.tilePixelRatio*textMaxSize/24,iconBoxScale=bucket.tilePixelRatio*layoutIconSize,symbolMinDistance=bucket.tilePixelRatio*layout.get("symbol-spacing"),textPadding=layout.get("text-padding")*bucket.tilePixelRatio,iconPadding=function(layout,feature,canonical,pixelRatio=1){const result=layout.get("icon-padding").evaluate(feature,{},canonical),values=result&&result.values;return[values[0]*pixelRatio,values[1]*pixelRatio,values[2]*pixelRatio,values[3]*pixelRatio]}(layout,feature,canonical,bucket.tilePixelRatio),textMaxAngle=layout.get("text-max-angle")/180*Math.PI,textAlongLine="viewport"!==layout.get("text-rotation-alignment")&&"point"!==layout.get("symbol-placement"),iconAlongLine="map"===layout.get("icon-rotation-alignment")&&"point"!==layout.get("symbol-placement"),symbolPlacement=layout.get("symbol-placement"),textRepeatDistance=symbolMinDistance/2,iconTextFit=layout.get("icon-text-fit");let verticallyShapedIcon;shapedIcon&&"none"!==iconTextFit&&(bucket.allowVerticalPlacement&&shapedTextOrientations.vertical&&(verticallyShapedIcon=fitIconToText(shapedIcon,shapedTextOrientations.vertical,iconTextFit,layout.get("icon-text-fit-padding"),iconOffset,fontScale)),defaultHorizontalShaping&&(shapedIcon=fitIconToText(shapedIcon,defaultHorizontalShaping,iconTextFit,layout.get("icon-text-fit-padding"),iconOffset,fontScale)));const addSymbolAtAnchor=(line,anchor)=>{anchor.x<0||anchor.x>=EXTENT||anchor.y<0||anchor.y>=EXTENT||function(bucket,anchor,line,shapedTextOrientations,shapedIcon,imageMap,verticallyShapedIcon,layer,collisionBoxArray,featureIndex,sourceLayerIndex,bucketIndex,textBoxScale,textPadding,textAlongLine,textOffset,iconBoxScale,iconPadding,iconAlongLine,iconOffset,feature,sizes,isSDFIcon,canonical,layoutTextSize){const lineArray=bucket.addToLineVertexArray(anchor,line);let textCollisionFeature,iconCollisionFeature,verticalTextCollisionFeature,verticalIconCollisionFeature,numIconVertices=0,numVerticalIconVertices=0,numHorizontalGlyphVertices=0,numVerticalGlyphVertices=0,placedIconSymbolIndex=-1,verticalPlacedIconSymbolIndex=-1;const placedTextSymbolIndices={};let key=murmur3$1("");if(bucket.allowVerticalPlacement&&shapedTextOrientations.vertical){const verticalTextRotation=layer.layout.get("text-rotate").evaluate(feature,{},canonical)+90,verticalShaping=shapedTextOrientations.vertical;verticalTextCollisionFeature=new CollisionFeature(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,verticalShaping,textBoxScale,textPadding,textAlongLine,verticalTextRotation),verticallyShapedIcon&&(verticalIconCollisionFeature=new CollisionFeature(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,verticallyShapedIcon,iconBoxScale,iconPadding,textAlongLine,verticalTextRotation))}if(shapedIcon){const iconRotate=layer.layout.get("icon-rotate").evaluate(feature,{}),hasIconTextFit="none"!==layer.layout.get("icon-text-fit"),iconQuads=getIconQuads(shapedIcon,iconRotate,isSDFIcon,hasIconTextFit),verticalIconQuads=verticallyShapedIcon?getIconQuads(verticallyShapedIcon,iconRotate,isSDFIcon,hasIconTextFit):void 0;iconCollisionFeature=new CollisionFeature(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,shapedIcon,iconBoxScale,iconPadding,!1,iconRotate),numIconVertices=4*iconQuads.length;const sizeData=bucket.iconSizeData;let iconSizeData=null;"source"===sizeData.kind?(iconSizeData=[SIZE_PACK_FACTOR*layer.layout.get("icon-size").evaluate(feature,{})],iconSizeData[0]>MAX_PACKED_SIZE&&warnOnce(`${bucket.layerIds[0]}: Value for "icon-size" is >= ${MAX_GLYPH_ICON_SIZE}. Reduce your "icon-size".`)):"composite"===sizeData.kind&&(iconSizeData=[SIZE_PACK_FACTOR*sizes.compositeIconSizes[0].evaluate(feature,{},canonical),SIZE_PACK_FACTOR*sizes.compositeIconSizes[1].evaluate(feature,{},canonical)],(iconSizeData[0]>MAX_PACKED_SIZE||iconSizeData[1]>MAX_PACKED_SIZE)&&warnOnce(`${bucket.layerIds[0]}: Value for "icon-size" is >= ${MAX_GLYPH_ICON_SIZE}. Reduce your "icon-size".`)),bucket.addSymbols(bucket.icon,iconQuads,iconSizeData,iconOffset,iconAlongLine,feature,exports.WritingMode.none,anchor,lineArray.lineStartIndex,lineArray.lineLength,-1,canonical),placedIconSymbolIndex=bucket.icon.placedSymbolArray.length-1,verticalIconQuads&&(numVerticalIconVertices=4*verticalIconQuads.length,bucket.addSymbols(bucket.icon,verticalIconQuads,iconSizeData,iconOffset,iconAlongLine,feature,exports.WritingMode.vertical,anchor,lineArray.lineStartIndex,lineArray.lineLength,-1,canonical),verticalPlacedIconSymbolIndex=bucket.icon.placedSymbolArray.length-1)}const justifications=Object.keys(shapedTextOrientations.horizontal);for(const justification of justifications){const shaping=shapedTextOrientations.horizontal[justification];if(!textCollisionFeature){key=murmur3$1(shaping.text);const textRotate=layer.layout.get("text-rotate").evaluate(feature,{},canonical);textCollisionFeature=new CollisionFeature(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,shaping,textBoxScale,textPadding,textAlongLine,textRotate)}const singleLine=1===shaping.positionedLines.length;if(numHorizontalGlyphVertices+=addTextVertices(bucket,anchor,shaping,imageMap,layer,textAlongLine,feature,textOffset,lineArray,shapedTextOrientations.vertical?exports.WritingMode.horizontal:exports.WritingMode.horizontalOnly,singleLine?justifications:[justification],placedTextSymbolIndices,placedIconSymbolIndex,sizes,canonical),singleLine)break}shapedTextOrientations.vertical&&(numVerticalGlyphVertices+=addTextVertices(bucket,anchor,shapedTextOrientations.vertical,imageMap,layer,textAlongLine,feature,textOffset,lineArray,exports.WritingMode.vertical,["vertical"],placedTextSymbolIndices,verticalPlacedIconSymbolIndex,sizes,canonical));const textBoxStartIndex=textCollisionFeature?textCollisionFeature.boxStartIndex:bucket.collisionBoxArray.length,textBoxEndIndex=textCollisionFeature?textCollisionFeature.boxEndIndex:bucket.collisionBoxArray.length,verticalTextBoxStartIndex=verticalTextCollisionFeature?verticalTextCollisionFeature.boxStartIndex:bucket.collisionBoxArray.length,verticalTextBoxEndIndex=verticalTextCollisionFeature?verticalTextCollisionFeature.boxEndIndex:bucket.collisionBoxArray.length,iconBoxStartIndex=iconCollisionFeature?iconCollisionFeature.boxStartIndex:bucket.collisionBoxArray.length,iconBoxEndIndex=iconCollisionFeature?iconCollisionFeature.boxEndIndex:bucket.collisionBoxArray.length,verticalIconBoxStartIndex=verticalIconCollisionFeature?verticalIconCollisionFeature.boxStartIndex:bucket.collisionBoxArray.length,verticalIconBoxEndIndex=verticalIconCollisionFeature?verticalIconCollisionFeature.boxEndIndex:bucket.collisionBoxArray.length;let collisionCircleDiameter=-1;const getCollisionCircleHeight=(feature,prevHeight)=>feature&&feature.circleDiameter?Math.max(feature.circleDiameter,prevHeight):prevHeight;collisionCircleDiameter=getCollisionCircleHeight(textCollisionFeature,collisionCircleDiameter),collisionCircleDiameter=getCollisionCircleHeight(verticalTextCollisionFeature,collisionCircleDiameter),collisionCircleDiameter=getCollisionCircleHeight(iconCollisionFeature,collisionCircleDiameter),collisionCircleDiameter=getCollisionCircleHeight(verticalIconCollisionFeature,collisionCircleDiameter);const useRuntimeCollisionCircles=collisionCircleDiameter>-1?1:0;useRuntimeCollisionCircles&&(collisionCircleDiameter*=layoutTextSize/ONE_EM);bucket.glyphOffsetArray.length>=SymbolBucket.MAX_GLYPHS&&warnOnce("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907");void 0!==feature.sortKey&&bucket.addToSortKeyRanges(bucket.symbolInstances.length,feature.sortKey);const variableAnchorOffset=getTextVariableAnchorOffset(layer,feature,canonical),[textAnchorOffsetStartIndex,textAnchorOffsetEndIndex]=function(textAnchorOffsets,variableAnchorOffset){const startIndex=textAnchorOffsets.length,values=null==variableAnchorOffset?void 0:variableAnchorOffset.values;if((null==values?void 0:values.length)>0)for(let i=0;i<values.length;i+=2){const anchor=exports.TextAnchorEnum[values[i]],offset=values[i+1];textAnchorOffsets.emplaceBack(anchor,offset[0],offset[1])}return[startIndex,textAnchorOffsets.length]}(bucket.textAnchorOffsets,variableAnchorOffset);bucket.symbolInstances.emplaceBack(anchor.x,anchor.y,placedTextSymbolIndices.right>=0?placedTextSymbolIndices.right:-1,placedTextSymbolIndices.center>=0?placedTextSymbolIndices.center:-1,placedTextSymbolIndices.left>=0?placedTextSymbolIndices.left:-1,placedTextSymbolIndices.vertical||-1,placedIconSymbolIndex,verticalPlacedIconSymbolIndex,key,textBoxStartIndex,textBoxEndIndex,verticalTextBoxStartIndex,verticalTextBoxEndIndex,iconBoxStartIndex,iconBoxEndIndex,verticalIconBoxStartIndex,verticalIconBoxEndIndex,featureIndex,numHorizontalGlyphVertices,numVerticalGlyphVertices,numIconVertices,numVerticalIconVertices,useRuntimeCollisionCircles,0,textBoxScale,collisionCircleDiameter,textAnchorOffsetStartIndex,textAnchorOffsetEndIndex)}(bucket,anchor,line,shapedTextOrientations,shapedIcon,imageMap,verticallyShapedIcon,bucket.layers[0],bucket.collisionBoxArray,feature.index,feature.sourceLayerIndex,bucket.index,textBoxScale,[textPadding,textPadding,textPadding,textPadding],textAlongLine,textOffset,iconBoxScale,iconPadding,iconAlongLine,iconOffset,feature,sizes,isSDFIcon,canonical,layoutTextSize)};if("line"===symbolPlacement)for(const line of clipLine(feature.geometry,0,0,EXTENT,EXTENT)){const anchors=getAnchors(line,symbolMinDistance,textMaxAngle,shapedTextOrientations.vertical||defaultHorizontalShaping,shapedIcon,24,textMaxBoxScale,bucket.overscaling,EXTENT);for(const anchor of anchors){defaultHorizontalShaping&&anchorIsTooClose(bucket,defaultHorizontalShaping.text,textRepeatDistance,anchor)||addSymbolAtAnchor(line,anchor)}}else if("line-center"===symbolPlacement){for(const line of feature.geometry)if(line.length>1){const anchor=getCenterAnchor(line,textMaxAngle,shapedTextOrientations.vertical||defaultHorizontalShaping,shapedIcon,24,textMaxBoxScale);anchor&&addSymbolAtAnchor(line,anchor)}}else if("Polygon"===feature.type)for(const polygon of classifyRings$1(feature.geometry,0)){const poi=findPoleOfInaccessibility(polygon,16);addSymbolAtAnchor(polygon[0],new Anchor(poi.x,poi.y,0))}else if("LineString"===feature.type)for(const line of feature.geometry)addSymbolAtAnchor(line,new Anchor(line[0].x,line[0].y,0));else if("Point"===feature.type)for(const points of feature.geometry)for(const point of points)addSymbolAtAnchor([point],new Anchor(point.x,point.y,0))}function addTextVertices(bucket,anchor,shapedText,imageMap,layer,textAlongLine,feature,textOffset,lineArray,writingMode,placementTypes,placedTextSymbolIndices,placedIconIndex,sizes,canonical){const glyphQuads=function(anchor,shaping,textOffset,layer,alongLine,feature,imageMap,allowVerticalPlacement){const textRotate=layer.layout.get("text-rotate").evaluate(feature,{})*Math.PI/180,quads=[];for(const line of shaping.positionedLines)for(const positionedGlyph of line.positionedGlyphs){if(!positionedGlyph.rect)continue;const textureRect=positionedGlyph.rect||{};let rectBuffer=GLYPH_PBF_BORDER+1,isSDF=!0,pixelRatio=1,lineOffset=0;const rotateVerticalGlyph=(alongLine||allowVerticalPlacement)&&positionedGlyph.vertical,halfAdvance=positionedGlyph.metrics.advance*positionedGlyph.scale/2;if(allowVerticalPlacement&&shaping.verticalizable){const scaledGlyphOffset=(positionedGlyph.scale-1)*ONE_EM,imageOffset=(ONE_EM-positionedGlyph.metrics.width*positionedGlyph.scale)/2;lineOffset=line.lineOffset/2-(positionedGlyph.imageName?-imageOffset:scaledGlyphOffset)}if(positionedGlyph.imageName){const image=imageMap[positionedGlyph.imageName];isSDF=image.sdf,pixelRatio=image.pixelRatio,rectBuffer=IMAGE_PADDING/pixelRatio}const glyphOffset=alongLine?[positionedGlyph.x+halfAdvance,positionedGlyph.y]:[0,0];let builtInOffset=alongLine?[0,0]:[positionedGlyph.x+halfAdvance+textOffset[0],positionedGlyph.y+textOffset[1]-lineOffset],verticalizedLabelOffset=[0,0];rotateVerticalGlyph&&(verticalizedLabelOffset=builtInOffset,builtInOffset=[0,0]);const textureScale=positionedGlyph.metrics.isDoubleResolution?2:1,x1=(positionedGlyph.metrics.left-rectBuffer)*positionedGlyph.scale-halfAdvance+builtInOffset[0],y1=(-positionedGlyph.metrics.top-rectBuffer)*positionedGlyph.scale+builtInOffset[1],x2=x1+textureRect.w/textureScale*positionedGlyph.scale/pixelRatio,y2=y1+textureRect.h/textureScale*positionedGlyph.scale/pixelRatio,tl=new Point$2(x1,y1),tr=new Point$2(x2,y1),bl=new Point$2(x1,y2),br=new Point$2(x2,y2);if(rotateVerticalGlyph){const center=new Point$2(-halfAdvance,halfAdvance-SHAPING_DEFAULT_OFFSET),verticalRotation=-Math.PI/2,xHalfWidthOffsetCorrection=ONE_EM/2-halfAdvance,yImageOffsetCorrection=positionedGlyph.imageName?xHalfWidthOffsetCorrection:0,halfWidthOffsetCorrection=new Point$2(5-SHAPING_DEFAULT_OFFSET-xHalfWidthOffsetCorrection,-yImageOffsetCorrection),verticalOffsetCorrection=new Point$2(...verticalizedLabelOffset);tl._rotateAround(verticalRotation,center)._add(halfWidthOffsetCorrection)._add(verticalOffsetCorrection),tr._rotateAround(verticalRotation,center)._add(halfWidthOffsetCorrection)._add(verticalOffsetCorrection),bl._rotateAround(verticalRotation,center)._add(halfWidthOffsetCorrection)._add(verticalOffsetCorrection),br._rotateAround(verticalRotation,center)._add(halfWidthOffsetCorrection)._add(verticalOffsetCorrection)}if(textRotate){const sin=Math.sin(textRotate),cos=Math.cos(textRotate),matrix=[cos,-sin,sin,cos];tl._matMult(matrix),tr._matMult(matrix),bl._matMult(matrix),br._matMult(matrix)}const pixelOffsetTL=new Point$2(0,0),pixelOffsetBR=new Point$2(0,0),minFontScaleX=0,minFontScaleY=0;quads.push({tl:tl,tr:tr,bl:bl,br:br,tex:textureRect,writingMode:shaping.writingMode,glyphOffset:glyphOffset,sectionIndex:positionedGlyph.sectionIndex,isSDF:isSDF,pixelOffsetTL:pixelOffsetTL,pixelOffsetBR:pixelOffsetBR,minFontScaleX:minFontScaleX,minFontScaleY:minFontScaleY})}return quads}(0,shapedText,textOffset,layer,textAlongLine,feature,imageMap,bucket.allowVerticalPlacement),sizeData=bucket.textSizeData;let textSizeData=null;"source"===sizeData.kind?(textSizeData=[SIZE_PACK_FACTOR*layer.layout.get("text-size").evaluate(feature,{})],textSizeData[0]>MAX_PACKED_SIZE&&warnOnce(`${bucket.layerIds[0]}: Value for "text-size" is >= ${MAX_GLYPH_ICON_SIZE}. Reduce your "text-size".`)):"composite"===sizeData.kind&&(textSizeData=[SIZE_PACK_FACTOR*sizes.compositeTextSizes[0].evaluate(feature,{},canonical),SIZE_PACK_FACTOR*sizes.compositeTextSizes[1].evaluate(feature,{},canonical)],(textSizeData[0]>MAX_PACKED_SIZE||textSizeData[1]>MAX_PACKED_SIZE)&&warnOnce(`${bucket.layerIds[0]}: Value for "text-size" is >= ${MAX_GLYPH_ICON_SIZE}. Reduce your "text-size".`)),bucket.addSymbols(bucket.text,glyphQuads,textSizeData,textOffset,textAlongLine,feature,writingMode,anchor,lineArray.lineStartIndex,lineArray.lineLength,placedIconIndex,canonical);for(const placementType of placementTypes)placedTextSymbolIndices[placementType]=bucket.text.placedSymbolArray.length-1;return 4*glyphQuads.length}function getDefaultHorizontalShaping(horizontalShaping){for(const justification in horizontalShaping)return horizontalShaping[justification];return null}function anchorIsTooClose(bucket,text,repeatDistance,anchor){const compareText=bucket.compareText;if(text in compareText){const otherAnchors=compareText[text];for(let k=otherAnchors.length-1;k>=0;k--)if(anchor.dist(otherAnchors[k])<repeatDistance)return!0}else compareText[text]=[];return compareText[text].push(anchor),!1}const ARRAY_TYPES=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class KDBush{static from(data){if(!(data instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[magic,versionAndType]=new Uint8Array(data,0,2);if(219!==magic)throw new Error("Data does not appear to be in a KDBush format.");const version=versionAndType>>4;if(1!==version)throw new Error(`Got v${version} data when expected v1.`);const ArrayType=ARRAY_TYPES[15&versionAndType];if(!ArrayType)throw new Error("Unrecognized array type.");const[nodeSize]=new Uint16Array(data,2,1),[numItems]=new Uint32Array(data,4,1);return new KDBush(numItems,nodeSize,ArrayType,data)}constructor(numItems,nodeSize=64,ArrayType=Float64Array,data){if(isNaN(numItems)||numItems<0)throw new Error(`Unpexpected numItems value: ${numItems}.`);this.numItems=+numItems,this.nodeSize=Math.min(Math.max(+nodeSize,2),65535),this.ArrayType=ArrayType,this.IndexArrayType=numItems<65536?Uint16Array:Uint32Array;const arrayTypeIndex=ARRAY_TYPES.indexOf(this.ArrayType),coordsByteSize=2*numItems*this.ArrayType.BYTES_PER_ELEMENT,idsByteSize=numItems*this.IndexArrayType.BYTES_PER_ELEMENT,padCoords=(8-idsByteSize%8)%8;if(arrayTypeIndex<0)throw new Error(`Unexpected typed array class: ${ArrayType}.`);data&&data instanceof ArrayBuffer?(this.data=data,this.ids=new this.IndexArrayType(this.data,8,numItems),this.coords=new this.ArrayType(this.data,8+idsByteSize+padCoords,2*numItems),this._pos=2*numItems,this._finished=!0):(this.data=new ArrayBuffer(8+coordsByteSize+idsByteSize+padCoords),this.ids=new this.IndexArrayType(this.data,8,numItems),this.coords=new this.ArrayType(this.data,8+idsByteSize+padCoords,2*numItems),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+arrayTypeIndex]),new Uint16Array(this.data,2,1)[0]=nodeSize,new Uint32Array(this.data,4,1)[0]=numItems)}add(x,y){const index=this._pos>>1;return this.ids[index]=index,this.coords[this._pos++]=x,this.coords[this._pos++]=y,index}finish(){const numAdded=this._pos>>1;if(numAdded!==this.numItems)throw new Error(`Added ${numAdded} items when expected ${this.numItems}.`);return sort(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(minX,minY,maxX,maxY){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:ids,coords:coords,nodeSize:nodeSize}=this,stack=[0,ids.length-1,0],result=[];for(;stack.length;){const axis=stack.pop()||0,right=stack.pop()||0,left=stack.pop()||0;if(right-left<=nodeSize){for(let i=left;i<=right;i++){const x=coords[2*i],y=coords[2*i+1];x>=minX&&x<=maxX&&y>=minY&&y<=maxY&&result.push(ids[i])}continue}const m=left+right>>1,x=coords[2*m],y=coords[2*m+1];x>=minX&&x<=maxX&&y>=minY&&y<=maxY&&result.push(ids[m]),(0===axis?minX<=x:minY<=y)&&(stack.push(left),stack.push(m-1),stack.push(1-axis)),(0===axis?maxX>=x:maxY>=y)&&(stack.push(m+1),stack.push(right),stack.push(1-axis))}return result}within(qx,qy,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:ids,coords:coords,nodeSize:nodeSize}=this,stack=[0,ids.length-1,0],result=[],r2=r*r;for(;stack.length;){const axis=stack.pop()||0,right=stack.pop()||0,left=stack.pop()||0;if(right-left<=nodeSize){for(let i=left;i<=right;i++)sqDist(coords[2*i],coords[2*i+1],qx,qy)<=r2&&result.push(ids[i]);continue}const m=left+right>>1,x=coords[2*m],y=coords[2*m+1];sqDist(x,y,qx,qy)<=r2&&result.push(ids[m]),(0===axis?qx-r<=x:qy-r<=y)&&(stack.push(left),stack.push(m-1),stack.push(1-axis)),(0===axis?qx+r>=x:qy+r>=y)&&(stack.push(m+1),stack.push(right),stack.push(1-axis))}return result}}function sort(ids,coords,nodeSize,left,right,axis){if(right-left<=nodeSize)return;const m=left+right>>1;select(ids,coords,m,left,right,axis),sort(ids,coords,nodeSize,left,m-1,1-axis),sort(ids,coords,nodeSize,m+1,right,1-axis)}function select(ids,coords,k,left,right,axis){for(;right>left;){if(right-left>600){const n=right-left+1,m=k-left+1,z=Math.log(n),s=.5*Math.exp(2*z/3),sd=.5*Math.sqrt(z*s*(n-s)/n)*(m-n/2<0?-1:1);select(ids,coords,k,Math.max(left,Math.floor(k-m*s/n+sd)),Math.min(right,Math.floor(k+(n-m)*s/n+sd)),axis)}const t=coords[2*k+axis];let i=left,j=right;for(swapItem(ids,coords,left,k),coords[2*right+axis]>t&&swapItem(ids,coords,left,right);i<j;){for(swapItem(ids,coords,i,j),i++,j--;coords[2*i+axis]<t;)i++;for(;coords[2*j+axis]>t;)j--}coords[2*left+axis]===t?swapItem(ids,coords,left,j):(j++,swapItem(ids,coords,j,right)),j<=k&&(left=j+1),k<=j&&(right=j-1)}}function swapItem(ids,coords,i,j){swap(ids,i,j),swap(coords,2*i,2*j),swap(coords,2*i+1,2*j+1)}function swap(arr,i,j){const tmp=arr[i];arr[i]=arr[j],arr[j]=tmp}function sqDist(ax,ay,bx,by){const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy}var PerformanceMarkers;exports.PerformanceMarkers=void 0,(PerformanceMarkers=exports.PerformanceMarkers||(exports.PerformanceMarkers={})).create="create",PerformanceMarkers.load="load",PerformanceMarkers.fullLoad="fullLoad";let lastFrameTime=null,frameTimes=[];const PerformanceUtils={mark(marker){performance.mark(marker)},frame(timestamp){const currTimestamp=timestamp;if(null!=lastFrameTime){const frameTime=currTimestamp-lastFrameTime;frameTimes.push(frameTime)}lastFrameTime=currTimestamp},clearMetrics(){lastFrameTime=null,frameTimes=[],performance.clearMeasures("loadTime"),performance.clearMeasures("fullLoadTime");for(const marker in exports.PerformanceMarkers)performance.clearMarks(exports.PerformanceMarkers[marker])},getPerformanceMetrics(){performance.measure("loadTime",exports.PerformanceMarkers.create,exports.PerformanceMarkers.load),performance.measure("fullLoadTime",exports.PerformanceMarkers.create,exports.PerformanceMarkers.fullLoad);const loadTime=performance.getEntriesByName("loadTime")[0].duration,fullLoadTime=performance.getEntriesByName("fullLoadTime")[0].duration,totalFrames=frameTimes.length,fps=1/(frameTimes.reduce(((prev,curr)=>prev+curr),0)/totalFrames/1e3),droppedFrames=frameTimes.filter((frameTime=>frameTime>16.666666666666668)).reduce(((acc,curr)=>acc+(curr-16.666666666666668)/16.666666666666668),0);return{loadTime:loadTime,fullLoadTime:fullLoadTime,fps:fps,percentDroppedFrames:droppedFrames/(totalFrames+droppedFrames)*100,totalFrames:totalFrames}}};performance;exports.AJAXError=AJAXError,exports.Actor=class{constructor(target,mapId){this.target=target,this.mapId=mapId,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new ThrottledInvoker((()=>this.process())),this.subscription=function(target,message,listener,options){return target.addEventListener(message,listener,options),{unsubscribe:()=>{target.removeEventListener(message,listener,options)}}}(this.target,"message",(message=>this.receive(message)),!1),this.globalScope=isWorker(self)?target:window}registerMessageHandler(type,handler){this.messageHandlers[type]=handler}sendAsync(message,abortController){return new Promise(((resolve,reject)=>{const id=Math.round(1e18*Math.random()).toString(36).substring(0,10);this.resolveRejects[id]={resolve:resolve,reject:reject},abortController&&abortController.signal.addEventListener("abort",(()=>{delete this.resolveRejects[id];const cancelMessage={id:id,type:"<cancel>",origin:location.origin,targetMapId:message.targetMapId,sourceMapId:this.mapId};this.target.postMessage(cancelMessage)}),{once:!0});const buffers=[],messageToPost=Object.assign(Object.assign({},message),{id:id,sourceMapId:this.mapId,origin:location.origin,data:serialize(message.data,buffers)});this.target.postMessage(messageToPost,{transfer:buffers})}))}receive(message){const data=message.data,id=data.id;if(!("file://"!==data.origin&&"file://"!==location.origin&&data.origin!==location.origin||data.targetMapId&&this.mapId!==data.targetMapId)){if("<cancel>"===data.type){delete this.tasks[id];const abortController=this.abortControllers[id];return delete this.abortControllers[id],void(abortController&&abortController.abort())}if(isWorker(self)||data.mustQueue)return this.tasks[id]=data,this.taskQueue.push(id),void this.invoker.trigger();this.processTask(id,data)}}process(){if(0===this.taskQueue.length)return;const id=this.taskQueue.shift(),task=this.tasks[id];delete this.tasks[id],this.taskQueue.length>0&&this.invoker.trigger(),task&&this.processTask(id,task)}processTask(id,task){return __awaiter(this,void 0,void 0,(function*(){if("<response>"===task.type){const resolveReject=this.resolveRejects[id];if(delete this.resolveRejects[id],!resolveReject)return;return void(task.error?resolveReject.reject(deserialize(task.error)):resolveReject.resolve(deserialize(task.data)))}if(!this.messageHandlers[task.type])return void this.completeTask(id,new Error(`Could not find a registered handler for ${task.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const params=deserialize(task.data),abortController=new AbortController;this.abortControllers[id]=abortController;try{const data=yield this.messageHandlers[task.type](task.sourceMapId,params,abortController);this.completeTask(id,null,data)}catch(err){this.completeTask(id,err)}}))}completeTask(id,err,data){const buffers=[];delete this.abortControllers[id];const responseMessage={id:id,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:err?serialize(err):null,data:serialize(data,buffers)};this.target.postMessage(responseMessage,{transfer:buffers})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},exports.AlphaImage=AlphaImage,exports.CanonicalTileID=CanonicalTileID,exports.CollisionBoxArray=CollisionBoxArray,exports.CollisionCircleLayoutArray=class extends StructArrayLayout2f1f2i16{},exports.Color=Color,exports.DEMData=DEMData,exports.DataConstantProperty=DataConstantProperty,exports.DictionaryCoder=DictionaryCoder,exports.EXTENT=EXTENT,exports.ErrorEvent=ErrorEvent,exports.EvaluationParameters=EvaluationParameters,exports.Event=Event,exports.Evented=Evented,exports.FeatureIndex=FeatureIndex,exports.FillBucket=FillBucket,exports.FillExtrusionBucket=FillExtrusionBucket,exports.GLOBAL_DISPATCHER_ID="global-dispatcher",exports.GeoJSONFeature=GeoJSONFeature,exports.ImageAtlas=ImageAtlas,exports.ImagePosition=ImagePosition,exports.KDBush=KDBush,exports.LineBucket=LineBucket,exports.LineStripIndexArray=class extends StructArrayLayout1ui2{},exports.LngLat=LngLat,exports.MercatorCoordinate=MercatorCoordinate,exports.ONE_EM=ONE_EM,exports.OverscaledTileID=OverscaledTileID,exports.PerformanceUtils=PerformanceUtils,exports.Point=Point$2,exports.Pos3dArray=class extends StructArrayLayout3i6{},exports.PosArray=PosArray,exports.Properties=Properties,exports.Protobuf=Protobuf,exports.QuadTriangleArray=class extends StructArrayLayout3ui6{},exports.RGBAImage=RGBAImage,exports.RasterBoundsArray=class extends StructArrayLayout4i8{},exports.RequestPerformance=class{constructor(request){this._marks={start:[request.url,"start"].join("#"),end:[request.url,"end"].join("#"),measure:request.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let resourceTimingData=performance.getEntriesByName(this._marks.measure);return 0===resourceTimingData.length&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),resourceTimingData=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),resourceTimingData}},exports.SegmentVector=SegmentVector,exports.SymbolBucket=SymbolBucket,exports.Transitionable=Transitionable,exports.TriangleIndexArray=TriangleIndexArray,exports.Uniform1f=Uniform1f,exports.Uniform1i=class extends Uniform{constructor(context,location){super(context,location),this.current=0}set(v){this.current!==v&&(this.current=v,this.gl.uniform1i(this.location,v))}},exports.Uniform2f=class extends Uniform{constructor(context,location){super(context,location),this.current=[0,0]}set(v){v[0]===this.current[0]&&v[1]===this.current[1]||(this.current=v,this.gl.uniform2f(this.location,v[0],v[1]))}},exports.Uniform3f=class extends Uniform{constructor(context,location){super(context,location),this.current=[0,0,0]}set(v){v[0]===this.current[0]&&v[1]===this.current[1]&&v[2]===this.current[2]||(this.current=v,this.gl.uniform3f(this.location,v[0],v[1],v[2]))}},exports.Uniform4f=Uniform4f,exports.UniformColor=UniformColor,exports.UniformMatrix4f=class extends Uniform{constructor(context,location){super(context,location),this.current=emptyMat4}set(v){if(v[12]!==this.current[12]||v[0]!==this.current[0])return this.current=v,void this.gl.uniformMatrix4fv(this.location,!1,v);for(let i=1;i<16;i++)if(v[i]!==this.current[i]){this.current=v,this.gl.uniformMatrix4fv(this.location,!1,v);break}}},exports.UnwrappedTileID=UnwrappedTileID,exports.ValidationError=ValidationError,exports.ZoomHistory=ZoomHistory,exports.__awaiter=__awaiter,exports.add=add$4,exports.addDynamicAttributes=addDynamicAttributes,exports.addProtocol=function(customProtocol,loadFn){config.REGISTERED_PROTOCOLS[customProtocol]=loadFn},exports.arrayBufferToImage=data=>new Promise(((resolve,reject)=>{const img=new Image;img.onload=()=>{resolve(img),URL.revokeObjectURL(img.src),img.onload=null,window.requestAnimationFrame((()=>{img.src=transparentPngUrl}))},img.onerror=()=>reject(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const blob=new Blob([new Uint8Array(data)],{type:"image/png"});img.src=data.byteLength?URL.createObjectURL(blob):transparentPngUrl})),exports.arrayBufferToImageBitmap=data=>__awaiter(void 0,void 0,void 0,(function*(){if(0===data.byteLength)return createImageBitmap(new ImageData(1,1));const blob=new Blob([new Uint8Array(data)],{type:"image/png"});try{return createImageBitmap(blob)}catch(e){throw new Error(`Could not load image because of ${e.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}})),exports.bezier=bezier$1,exports.clamp=clamp$1,exports.clipLine=clipLine,exports.clone=clone$5,exports.clone$1=clone$9,exports.clone$2=clone$4,exports.collisionCircleLayout=collisionCircleLayout,exports.config=config,exports.copy=copy$5,exports.create=create$5,exports.create$1=create$6,exports.create$2=create$8,exports.createAbortError=createAbortError,exports.createExpression=createExpression,exports.createFilter=createFilter,exports.createLayout=createLayout,exports.createStyleLayer=function(layer){if("custom"===layer.type)return new CustomStyleLayer(layer);switch(layer.type){case"background":return new BackgroundStyleLayer(layer);case"circle":return new CircleStyleLayer(layer);case"fill":return new FillStyleLayer(layer);case"fill-extrusion":return new FillExtrusionStyleLayer(layer);case"heatmap":return new HeatmapStyleLayer(layer);case"hillshade":return new HillshadeStyleLayer(layer);case"line":return new LineStyleLayer(layer);case"raster":return new RasterStyleLayer(layer);case"symbol":return new SymbolStyleLayer(layer)}},exports.cross=cross$2,exports.deepEqual=function deepEqual$1(a,b){if(Array.isArray(a)){if(!Array.isArray(b)||a.length!==b.length)return!1;for(let i=0;i<a.length;i++)if(!deepEqual$1(a[i],b[i]))return!1;return!0}if("object"==typeof a&&null!==a&&null!==b){if("object"!=typeof b)return!1;if(Object.keys(a).length!==Object.keys(b).length)return!1;for(const key in a)if(!deepEqual$1(a[key],b[key]))return!1;return!0}return a===b},exports.defaultEasing=defaultEasing,exports.degreesToRadians=function(degrees){return degrees*Math.PI/180},exports.derefLayers=function(layers){layers=layers.slice();const map=Object.create(null);for(let i=0;i<layers.length;i++)map[layers[i].id]=layers[i];for(let i=0;i<layers.length;i++)"ref"in layers[i]&&(layers[i]=deref(layers[i],map[layers[i].ref]));return layers},exports.diffStyles=function(before,after){if(!before)return[{command:"setStyle",args:[after]}];let commands=[];try{if(!deepEqual(before.version,after.version))return[{command:"setStyle",args:[after]}];deepEqual(before.center,after.center)||commands.push({command:"setCenter",args:[after.center]}),deepEqual(before.zoom,after.zoom)||commands.push({command:"setZoom",args:[after.zoom]}),deepEqual(before.bearing,after.bearing)||commands.push({command:"setBearing",args:[after.bearing]}),deepEqual(before.pitch,after.pitch)||commands.push({command:"setPitch",args:[after.pitch]}),deepEqual(before.sprite,after.sprite)||commands.push({command:"setSprite",args:[after.sprite]}),deepEqual(before.glyphs,after.glyphs)||commands.push({command:"setGlyphs",args:[after.glyphs]}),deepEqual(before.transition,after.transition)||commands.push({command:"setTransition",args:[after.transition]}),deepEqual(before.light,after.light)||commands.push({command:"setLight",args:[after.light]}),deepEqual(before.terrain,after.terrain)||commands.push({command:"setTerrain",args:[after.terrain]}),deepEqual(before.sky,after.sky)||commands.push({command:"setSky",args:[after.sky]});const sourcesRemoved={},removeOrAddSourceCommands=[];!function(before,after,commands,sourcesRemoved){let sourceId;for(sourceId in after=after||{},before=before||{})Object.prototype.hasOwnProperty.call(before,sourceId)&&(Object.prototype.hasOwnProperty.call(after,sourceId)||removeSource(sourceId,commands,sourcesRemoved));for(sourceId in after)Object.prototype.hasOwnProperty.call(after,sourceId)&&(Object.prototype.hasOwnProperty.call(before,sourceId)?deepEqual(before[sourceId],after[sourceId])||("geojson"===before[sourceId].type&&"geojson"===after[sourceId].type&&canUpdateGeoJSON(before,after,sourceId)?addCommand(commands,{command:"setGeoJSONSourceData",args:[sourceId,after[sourceId].data]}):updateSource(sourceId,after,commands,sourcesRemoved)):addSource(sourceId,after,commands))}(before.sources,after.sources,removeOrAddSourceCommands,sourcesRemoved);const beforeLayers=[];before.layers&&before.layers.forEach((layer=>{"source"in layer&&sourcesRemoved[layer.source]?commands.push({command:"removeLayer",args:[layer.id]}):beforeLayers.push(layer)})),commands=commands.concat(removeOrAddSourceCommands),function(before,after,commands){after=after||[];const beforeOrder=(before=before||[]).map(pluckId),afterOrder=after.map(pluckId),beforeIndex=before.reduce(indexById,{}),afterIndex=after.reduce(indexById,{}),tracker=beforeOrder.slice(),clean=Object.create(null);let layerId,beforeLayer,afterLayer,insertBeforeLayerId,prop;for(let i=0,d=0;i<beforeOrder.length;i++)layerId=beforeOrder[i],Object.prototype.hasOwnProperty.call(afterIndex,layerId)?d++:(addCommand(commands,{command:"removeLayer",args:[layerId]}),tracker.splice(tracker.indexOf(layerId,d),1));for(let i=0,d=0;i<afterOrder.length;i++)layerId=afterOrder[afterOrder.length-1-i],tracker[tracker.length-1-i]!==layerId&&(Object.prototype.hasOwnProperty.call(beforeIndex,layerId)?(addCommand(commands,{command:"removeLayer",args:[layerId]}),tracker.splice(tracker.lastIndexOf(layerId,tracker.length-d),1)):d++,insertBeforeLayerId=tracker[tracker.length-i],addCommand(commands,{command:"addLayer",args:[afterIndex[layerId],insertBeforeLayerId]}),tracker.splice(tracker.length-i,0,layerId),clean[layerId]=!0);for(let i=0;i<afterOrder.length;i++)if(layerId=afterOrder[i],beforeLayer=beforeIndex[layerId],afterLayer=afterIndex[layerId],!clean[layerId]&&!deepEqual(beforeLayer,afterLayer))if(deepEqual(beforeLayer.source,afterLayer.source)&&deepEqual(beforeLayer["source-layer"],afterLayer["source-layer"])&&deepEqual(beforeLayer.type,afterLayer.type)){for(prop in diffLayerPropertyChanges(beforeLayer.layout,afterLayer.layout,commands,layerId,null,"setLayoutProperty"),diffLayerPropertyChanges(beforeLayer.paint,afterLayer.paint,commands,layerId,null,"setPaintProperty"),deepEqual(beforeLayer.filter,afterLayer.filter)||addCommand(commands,{command:"setFilter",args:[layerId,afterLayer.filter]}),deepEqual(beforeLayer.minzoom,afterLayer.minzoom)&&deepEqual(beforeLayer.maxzoom,afterLayer.maxzoom)||addCommand(commands,{command:"setLayerZoomRange",args:[layerId,afterLayer.minzoom,afterLayer.maxzoom]}),beforeLayer)Object.prototype.hasOwnProperty.call(beforeLayer,prop)&&"layout"!==prop&&"paint"!==prop&&"filter"!==prop&&"metadata"!==prop&&"minzoom"!==prop&&"maxzoom"!==prop&&(0===prop.indexOf("paint.")?diffLayerPropertyChanges(beforeLayer[prop],afterLayer[prop],commands,layerId,prop.slice(6),"setPaintProperty"):deepEqual(beforeLayer[prop],afterLayer[prop])||addCommand(commands,{command:"setLayerProperty",args:[layerId,prop,afterLayer[prop]]}));for(prop in afterLayer)Object.prototype.hasOwnProperty.call(afterLayer,prop)&&!Object.prototype.hasOwnProperty.call(beforeLayer,prop)&&"layout"!==prop&&"paint"!==prop&&"filter"!==prop&&"metadata"!==prop&&"minzoom"!==prop&&"maxzoom"!==prop&&(0===prop.indexOf("paint.")?diffLayerPropertyChanges(beforeLayer[prop],afterLayer[prop],commands,layerId,prop.slice(6),"setPaintProperty"):deepEqual(beforeLayer[prop],afterLayer[prop])||addCommand(commands,{command:"setLayerProperty",args:[layerId,prop,afterLayer[prop]]}))}else addCommand(commands,{command:"removeLayer",args:[layerId]}),insertBeforeLayerId=tracker[tracker.lastIndexOf(layerId)+1],addCommand(commands,{command:"addLayer",args:[afterLayer,insertBeforeLayerId]})}(beforeLayers,after.layers,commands)}catch(e){console.warn("Unable to compute style diff:",e),commands=[{command:"setStyle",args:[after]}]}return commands},exports.dot=dot$5,exports.dot$1=dot$4,exports.earthRadius=6371008.8,exports.emitValidationErrors=emitValidationErrors,exports.emptyStyle=function(){const style={},version=v8Spec.$version;for(const styleKey in v8Spec.$root){const spec=v8Spec.$root[styleKey];if(spec.required){let value=null;value="version"===styleKey?version:"array"===spec.type?[]:{},null!=value&&(style[styleKey]=value)}}return style},exports.equals=equals$6,exports.evaluateSizeForFeature=function(sizeData,{uSize:uSize,uSizeT:uSizeT},{lowerSize:lowerSize,upperSize:upperSize}){return"source"===sizeData.kind?lowerSize/SIZE_PACK_FACTOR:"composite"===sizeData.kind?interpolate.number(lowerSize/SIZE_PACK_FACTOR,upperSize/SIZE_PACK_FACTOR,uSizeT):uSize},exports.evaluateSizeForZoom=function(sizeData,zoom){let uSizeT=0,uSize=0;if("constant"===sizeData.kind)uSize=sizeData.layoutSize;else if("source"!==sizeData.kind){const{interpolationType:interpolationType,minZoom:minZoom,maxZoom:maxZoom}=sizeData,t=interpolationType?clamp$1(Interpolate.interpolationFactor(interpolationType,zoom,minZoom,maxZoom),0,1):0;"camera"===sizeData.kind?uSize=interpolate.number(sizeData.minSize,sizeData.maxSize,t):uSizeT=t}return{uSizeT:uSizeT,uSize:uSize}},exports.extend=extend,exports.filterObject=filterObject,exports.findLineIntersection=function(a1,a2,b1,b2){const aDeltaY=a2.y-a1.y,aDeltaX=a2.x-a1.x,bDeltaY=b2.y-b1.y,bDeltaX=b2.x-b1.x,denominator=bDeltaY*aDeltaX-bDeltaX*aDeltaY;if(0===denominator)return null;const aInterpolation=(bDeltaX*(a1.y-b1.y)-bDeltaY*(a1.x-b1.x))/denominator;return new Point$2(a1.x+aInterpolation*aDeltaX,a1.y+aInterpolation*aDeltaY)},exports.fromRotation=fromRotation$2,exports.fromScaling=fromScaling,exports.getAnchorAlignment=getAnchorAlignment,exports.getAnchorJustification=getAnchorJustification,exports.getArrayBuffer=(requestParameters,abortController)=>makeRequest(extend(requestParameters,{type:"arrayBuffer"}),abortController),exports.getDefaultExportFromCjs=getDefaultExportFromCjs$1,exports.getImageData=function(image,x,y,width,height){return __awaiter(this,void 0,void 0,(function*(){if(isOffscreenCanvasDistorted())try{return yield readImageUsingVideoFrame(image,x,y,width,height)}catch(e){}return function(imgBitmap,x,y,width,height){const origWidth=imgBitmap.width,origHeight=imgBitmap.height;offscreenCanvas&&offscreenCanvasContext||(offscreenCanvas=new OffscreenCanvas(origWidth,origHeight),offscreenCanvasContext=offscreenCanvas.getContext("2d",{willReadFrequently:!0})),offscreenCanvas.width=origWidth,offscreenCanvas.height=origHeight,offscreenCanvasContext.drawImage(imgBitmap,0,0,origWidth,origHeight);const imgData=offscreenCanvasContext.getImageData(x,y,width,height);return offscreenCanvasContext.clearRect(0,0,origWidth,origHeight),imgData.data}(image,x,y,width,height)}))},exports.getJSON=(requestParameters,abortController)=>makeRequest(extend(requestParameters,{type:"json"}),abortController),exports.getOverlapMode=getOverlapMode,exports.getProtocol=getProtocol,exports.getReferrer=getReferrer,exports.getVideo=urls=>{const video=window.document.createElement("video");return video.muted=!0,new Promise((resolve=>{video.onloadstart=()=>{resolve(video)};for(const url of urls){const s=window.document.createElement("source");sameOrigin(url)||(video.crossOrigin="Anonymous"),s.src=url,video.appendChild(s)}}))},exports.groupByLayout=function(layers,cachedKeys){const groups={};for(let i=0;i<layers.length;i++){const k=cachedKeys&&cachedKeys[layers[i].id]||getKey(layers[i]);cachedKeys&&(cachedKeys[layers[i].id]=k);let group=groups[k];group||(group=groups[k]=[]),group.push(layers[i])}const result=[];for(const k in groups)result.push(groups[k]);return result},exports.identity=identity$2,exports.interpolate=interpolate,exports.invert=invert$2,exports.isAbortError=function(error){return error.message===ABORT_ERROR},exports.isImageBitmap=isImageBitmap,exports.isOffscreenCanvasDistorted=isOffscreenCanvasDistorted,exports.isSafari=function(scope){if(null==_isSafari){const userAgent=scope.navigator?scope.navigator.userAgent:null;_isSafari=!!scope.safari||!(!userAgent||!(/\b(iPad|iPhone|iPod)\b/.test(userAgent)||userAgent.match("Safari")&&!userAgent.match("Chrome")))}return _isSafari},exports.isWorker=isWorker,exports.keysDifference=function(obj,other){const difference=[];for(const i in obj)i in other||difference.push(i);return difference},exports.makeRequest=makeRequest,exports.mapObject=mapObject,exports.mercatorXfromLng=mercatorXfromLng,exports.mercatorYfromLat=mercatorYfromLat,exports.mercatorZfromAltitude=mercatorZfromAltitude,exports.mul=mul$5,exports.mul$1=mul$3,exports.multiply=multiply$5,exports.nextPowerOfTwo=function(value){return value<=1?1:Math.pow(2,Math.ceil(Math.log(value)/Math.LN2))},exports.normalize=normalize$4,exports.offscreenCanvasSupported=offscreenCanvasSupported,exports.ortho=ortho,exports.parseCacheControl=function(cacheControl){const header={};if(cacheControl.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(($0,$1,$2,$3)=>{const value=$2||$3;return header[$1]=!value||value.toLowerCase(),""})),header["max-age"]){const maxAge=parseInt(header["max-age"],10);isNaN(maxAge)?delete header["max-age"]:header["max-age"]=maxAge}return header},exports.parseGlyphPbf=function(data){return new Protobuf(data).readFields(readFontstacks,[])},exports.pbf=pbf,exports.performSymbolLayout=function(args){args.bucket.createArrays();const tileSize=512*args.bucket.overscaling;args.bucket.tilePixelRatio=EXTENT/tileSize,args.bucket.compareText={},args.bucket.iconsNeedLinear=!1;const layer=args.bucket.layers[0],layout=layer.layout,unevaluatedLayoutValues=layer._unevaluatedLayout._values,sizes={layoutIconSize:unevaluatedLayoutValues["icon-size"].possiblyEvaluate(new EvaluationParameters(args.bucket.zoom+1),args.canonical),layoutTextSize:unevaluatedLayoutValues["text-size"].possiblyEvaluate(new EvaluationParameters(args.bucket.zoom+1),args.canonical),textMaxSize:unevaluatedLayoutValues["text-size"].possiblyEvaluate(new EvaluationParameters(18))};if("composite"===args.bucket.textSizeData.kind){const{minZoom:minZoom,maxZoom:maxZoom}=args.bucket.textSizeData;sizes.compositeTextSizes=[unevaluatedLayoutValues["text-size"].possiblyEvaluate(new EvaluationParameters(minZoom),args.canonical),unevaluatedLayoutValues["text-size"].possiblyEvaluate(new EvaluationParameters(maxZoom),args.canonical)]}if("composite"===args.bucket.iconSizeData.kind){const{minZoom:minZoom,maxZoom:maxZoom}=args.bucket.iconSizeData;sizes.compositeIconSizes=[unevaluatedLayoutValues["icon-size"].possiblyEvaluate(new EvaluationParameters(minZoom),args.canonical),unevaluatedLayoutValues["icon-size"].possiblyEvaluate(new EvaluationParameters(maxZoom),args.canonical)]}const lineHeight=layout.get("text-line-height")*ONE_EM,textAlongLine="viewport"!==layout.get("text-rotation-alignment")&&"point"!==layout.get("symbol-placement"),keepUpright=layout.get("text-keep-upright"),textSize=layout.get("text-size");for(const feature of args.bucket.features){const fontstack=layout.get("text-font").evaluate(feature,{},args.canonical).join(","),layoutTextSizeThisZoom=textSize.evaluate(feature,{},args.canonical),layoutTextSize=sizes.layoutTextSize.evaluate(feature,{},args.canonical),layoutIconSize=sizes.layoutIconSize.evaluate(feature,{},args.canonical),shapedTextOrientations={horizontal:{},vertical:void 0},text=feature.text;let shapedIcon,textOffset=[0,0];if(text){const unformattedText=text.toString(),spacing=layout.get("text-letter-spacing").evaluate(feature,{},args.canonical)*ONE_EM,spacingIfAllowed=allowsLetterSpacing(unformattedText)?spacing:0,textAnchor=layout.get("text-anchor").evaluate(feature,{},args.canonical),variableAnchorOffset=getTextVariableAnchorOffset(layer,feature,args.canonical);if(!variableAnchorOffset){const radialOffset=layout.get("text-radial-offset").evaluate(feature,{},args.canonical);textOffset=radialOffset?evaluateVariableOffset(textAnchor,[radialOffset*ONE_EM,INVALID_TEXT_OFFSET]):layout.get("text-offset").evaluate(feature,{},args.canonical).map((t=>t*ONE_EM))}let textJustify=textAlongLine?"center":layout.get("text-justify").evaluate(feature,{},args.canonical);const symbolPlacement=layout.get("symbol-placement"),maxWidth="point"===symbolPlacement?layout.get("text-max-width").evaluate(feature,{},args.canonical)*ONE_EM:0,addVerticalShapingForPointLabelIfNeeded=()=>{args.bucket.allowVerticalPlacement&&allowsVerticalWritingMode(unformattedText)&&(shapedTextOrientations.vertical=shapeText(text,args.glyphMap,args.glyphPositions,args.imagePositions,fontstack,maxWidth,lineHeight,textAnchor,"left",spacingIfAllowed,textOffset,exports.WritingMode.vertical,!0,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom))};if(!textAlongLine&&variableAnchorOffset){const justifications=new Set;if("auto"===textJustify)for(let i=0;i<variableAnchorOffset.values.length;i+=2)justifications.add(getAnchorJustification(variableAnchorOffset.values[i]));else justifications.add(textJustify);let singleLine=!1;for(const justification of justifications)if(!shapedTextOrientations.horizontal[justification])if(singleLine)shapedTextOrientations.horizontal[justification]=shapedTextOrientations.horizontal[0];else{const shaping=shapeText(text,args.glyphMap,args.glyphPositions,args.imagePositions,fontstack,maxWidth,lineHeight,"center",justification,spacingIfAllowed,textOffset,exports.WritingMode.horizontal,!1,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom);shaping&&(shapedTextOrientations.horizontal[justification]=shaping,singleLine=1===shaping.positionedLines.length)}addVerticalShapingForPointLabelIfNeeded()}else{"auto"===textJustify&&(textJustify=getAnchorJustification(textAnchor));const shaping=shapeText(text,args.glyphMap,args.glyphPositions,args.imagePositions,fontstack,maxWidth,lineHeight,textAnchor,textJustify,spacingIfAllowed,textOffset,exports.WritingMode.horizontal,!1,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom);shaping&&(shapedTextOrientations.horizontal[textJustify]=shaping),addVerticalShapingForPointLabelIfNeeded(),allowsVerticalWritingMode(unformattedText)&&textAlongLine&&keepUpright&&(shapedTextOrientations.vertical=shapeText(text,args.glyphMap,args.glyphPositions,args.imagePositions,fontstack,maxWidth,lineHeight,textAnchor,textJustify,spacingIfAllowed,textOffset,exports.WritingMode.vertical,!1,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom))}}let isSDFIcon=!1;if(feature.icon&&feature.icon.name){const image=args.imageMap[feature.icon.name];image&&(shapedIcon=shapeIcon(args.imagePositions[feature.icon.name],layout.get("icon-offset").evaluate(feature,{},args.canonical),layout.get("icon-anchor").evaluate(feature,{},args.canonical)),isSDFIcon=!!image.sdf,void 0===args.bucket.sdfIcons?args.bucket.sdfIcons=isSDFIcon:args.bucket.sdfIcons!==isSDFIcon&&warnOnce("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(image.pixelRatio!==args.bucket.pixelRatio||0!==layout.get("icon-rotate").constantOr(1))&&(args.bucket.iconsNeedLinear=!0))}const shapedText=getDefaultHorizontalShaping(shapedTextOrientations.horizontal)||shapedTextOrientations.vertical;args.bucket.iconsInText=!!shapedText&&shapedText.iconsInText,(shapedText||shapedIcon)&&addFeature(args.bucket,feature,shapedTextOrientations,shapedIcon,args.imageMap,sizes,layoutTextSize,layoutIconSize,textOffset,isSDFIcon,args.canonical)}args.showCollisionBoxes&&args.bucket.generateCollisionDebugBuffers()},exports.perspective=perspective,exports.pick=function(src,properties){const result={};for(let i=0;i<properties.length;i++){const k=properties[i];k in src&&(result[k]=src[k])}return result},exports.pointGeometry=pointGeometry,exports.polygonIntersectsPolygon=polygonIntersectsPolygon,exports.potpack=potpack,exports.readImageUsingVideoFrame=readImageUsingVideoFrame,exports.register=register,exports.removeProtocol=function(customProtocol){delete config.REGISTERED_PROTOCOLS[customProtocol]},exports.renderColorRamp=renderColorRamp,exports.rotate=rotate$4,exports.rotateX=rotateX$3,exports.rotateZ=rotateZ$3,exports.rtlWorkerPlugin=rtlWorkerPlugin,exports.sameOrigin=sameOrigin,exports.scale=scale$5,exports.scale$1=scale$4,exports.sphericalToCartesian=function([r,azimuthal,polar]){return azimuthal+=90,azimuthal*=Math.PI/180,polar*=Math.PI/180,{x:r*Math.cos(azimuthal)*Math.sin(polar),y:r*Math.sin(azimuthal)*Math.sin(polar),z:r*Math.cos(polar)}},exports.sqrLen=sqrLen,exports.sub=sub$2,exports.toEvaluationFeature=toEvaluationFeature,exports.transformMat3=transformMat3$1,exports.transformMat4=transformMat4$1,exports.transformMat4$1=transformMat4,exports.translate=translate$1,exports.unicodeBlockLookup=unicodeBlockLookup,exports.uniqueId=function(){return id++},exports.v8Spec=v8Spec,exports.validateCustomStyleLayer=function(layerObject){const errors=[],id=layerObject.id;return void 0===id&&errors.push({message:`layers.${id}: missing required property "id"`}),void 0===layerObject.render&&errors.push({message:`layers.${id}: missing required method "render"`}),layerObject.renderingMode&&"2d"!==layerObject.renderingMode&&"3d"!==layerObject.renderingMode&&errors.push({message:`layers.${id}: property "renderingMode" must be either "2d" or "3d"`}),errors},exports.validateLight=validateLight,exports.validateStyle=validateStyle,exports.vectorTile=vectorTile,exports.warnOnce=warnOnce,exports.wrap=wrap})),define("worker",0,(function(performance){class StyleLayerIndex{constructor(layerConfigs){this.keyCache={},layerConfigs&&this.replace(layerConfigs)}replace(layerConfigs){this._layerConfigs={},this._layers={},this.update(layerConfigs,[])}update(layerConfigs,removedIds){for(const layerConfig of layerConfigs){this._layerConfigs[layerConfig.id]=layerConfig;const layer=this._layers[layerConfig.id]=performance.createStyleLayer(layerConfig);layer._featureFilter=performance.createFilter(layer.filter),this.keyCache[layerConfig.id]&&delete this.keyCache[layerConfig.id]}for(const id of removedIds)delete this.keyCache[id],delete this._layerConfigs[id],delete this._layers[id];this.familiesBySource={};const groups=performance.groupByLayout(Object.values(this._layerConfigs),this.keyCache);for(const layerConfigs of groups){const layers=layerConfigs.map((layerConfig=>this._layers[layerConfig.id])),layer=layers[0];if("none"===layer.visibility)continue;const sourceId=layer.source||"";let sourceGroup=this.familiesBySource[sourceId];sourceGroup||(sourceGroup=this.familiesBySource[sourceId]={});const sourceLayerId=layer.sourceLayer||"_geojsonTileLayer";let sourceLayerFamilies=sourceGroup[sourceLayerId];sourceLayerFamilies||(sourceLayerFamilies=sourceGroup[sourceLayerId]=[]),sourceLayerFamilies.push(layers)}}}class GlyphAtlas{constructor(stacks){const positions={},bins=[];for(const stack in stacks){const glyphs=stacks[stack],stackPositions=positions[stack]={};for(const id in glyphs){const src=glyphs[+id];if(!src||0===src.bitmap.width||0===src.bitmap.height)continue;const bin={x:0,y:0,w:src.bitmap.width+2,h:src.bitmap.height+2};bins.push(bin),stackPositions[id]={rect:bin,metrics:src.metrics}}}const{w:w,h:h}=performance.potpack(bins),image=new performance.AlphaImage({width:w||1,height:h||1});for(const stack in stacks){const glyphs=stacks[stack];for(const id in glyphs){const src=glyphs[+id];if(!src||0===src.bitmap.width||0===src.bitmap.height)continue;const bin=positions[stack][id].rect;performance.AlphaImage.copy(src.bitmap,image,{x:0,y:0},{x:bin.x+1,y:bin.y+1},src.bitmap)}}this.image=image,this.positions=positions}}performance.register("GlyphAtlas",GlyphAtlas);class WorkerTile{constructor(params){this.tileID=new performance.OverscaledTileID(params.tileID.overscaledZ,params.tileID.wrap,params.tileID.canonical.z,params.tileID.canonical.x,params.tileID.canonical.y),this.uid=params.uid,this.zoom=params.zoom,this.pixelRatio=params.pixelRatio,this.tileSize=params.tileSize,this.source=params.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=params.showCollisionBoxes,this.collectResourceTiming=!!params.collectResourceTiming,this.returnDependencies=!!params.returnDependencies,this.promoteId=params.promoteId,this.inFlightDependencies=[]}parse(data,layerIndex,availableImages,actor){return performance.__awaiter(this,void 0,void 0,(function*(){this.status="parsing",this.data=data,this.collisionBoxArray=new performance.CollisionBoxArray;const sourceLayerCoder=new performance.DictionaryCoder(Object.keys(data.layers).sort()),featureIndex=new performance.FeatureIndex(this.tileID,this.promoteId);featureIndex.bucketLayerIDs=[];const buckets={},options={featureIndex:featureIndex,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:availableImages},layerFamilies=layerIndex.familiesBySource[this.source];for(const sourceLayerId in layerFamilies){const sourceLayer=data.layers[sourceLayerId];if(!sourceLayer)continue;1===sourceLayer.version&&performance.warnOnce(`Vector tile source "${this.source}" layer "${sourceLayerId}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const sourceLayerIndex=sourceLayerCoder.encode(sourceLayerId),features=[];for(let index=0;index<sourceLayer.length;index++){const feature=sourceLayer.feature(index),id=featureIndex.getId(feature,sourceLayerId);features.push({feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex})}for(const family of layerFamilies[sourceLayerId]){const layer=family[0];if(layer.source!==this.source&&performance.warnOnce(`layer.source = ${layer.source} does not equal this.source = ${this.source}`),layer.minzoom&&this.zoom<Math.floor(layer.minzoom))continue;if(layer.maxzoom&&this.zoom>=layer.maxzoom)continue;if("none"===layer.visibility)continue;recalculateLayers(family,this.zoom,availableImages);(buckets[layer.id]=layer.createBucket({index:featureIndex.bucketLayerIDs.length,layers:family,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:sourceLayerIndex,sourceID:this.source})).populate(features,options,this.tileID.canonical),featureIndex.bucketLayerIDs.push(family.map((l=>l.id)))}}const stacks=performance.mapObject(options.glyphDependencies,(glyphs=>Object.keys(glyphs).map(Number)));this.inFlightDependencies.forEach((request=>null==request?void 0:request.abort())),this.inFlightDependencies=[];let getGlyphsPromise=Promise.resolve({});if(Object.keys(stacks).length){const abortController=new AbortController;this.inFlightDependencies.push(abortController),getGlyphsPromise=actor.sendAsync({type:"getGlyphs",data:{stacks:stacks,source:this.source,tileID:this.tileID,type:"glyphs"}},abortController)}const icons=Object.keys(options.iconDependencies);let getIconsPromise=Promise.resolve({});if(icons.length){const abortController=new AbortController;this.inFlightDependencies.push(abortController),getIconsPromise=actor.sendAsync({type:"getImages",data:{icons:icons,source:this.source,tileID:this.tileID,type:"icons"}},abortController)}const patterns=Object.keys(options.patternDependencies);let getPatternsPromise=Promise.resolve({});if(patterns.length){const abortController=new AbortController;this.inFlightDependencies.push(abortController),getPatternsPromise=actor.sendAsync({type:"getImages",data:{icons:patterns,source:this.source,tileID:this.tileID,type:"patterns"}},abortController)}const[glyphMap,iconMap,patternMap]=yield Promise.all([getGlyphsPromise,getIconsPromise,getPatternsPromise]),glyphAtlas=new GlyphAtlas(glyphMap),imageAtlas=new performance.ImageAtlas(iconMap,patternMap);for(const key in buckets){const bucket=buckets[key];bucket instanceof performance.SymbolBucket?(recalculateLayers(bucket.layers,this.zoom,availableImages),performance.performSymbolLayout({bucket:bucket,glyphMap:glyphMap,glyphPositions:glyphAtlas.positions,imageMap:iconMap,imagePositions:imageAtlas.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})):bucket.hasPattern&&(bucket instanceof performance.LineBucket||bucket instanceof performance.FillBucket||bucket instanceof performance.FillExtrusionBucket)&&(recalculateLayers(bucket.layers,this.zoom,availableImages),bucket.addFeatures(options,this.tileID.canonical,imageAtlas.patternPositions))}return this.status="done",{buckets:Object.values(buckets).filter((b=>!b.isEmpty())),featureIndex:featureIndex,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:glyphAtlas.image,imageAtlas:imageAtlas,glyphMap:this.returnDependencies?glyphMap:null,iconMap:this.returnDependencies?iconMap:null,glyphPositions:this.returnDependencies?glyphAtlas.positions:null}}))}}function recalculateLayers(layers,zoom,availableImages){const parameters=new performance.EvaluationParameters(zoom);for(const layer of layers)layer.recalculate(parameters,availableImages)}class VectorTileWorkerSource{constructor(actor,layerIndex,availableImages){this.actor=actor,this.layerIndex=layerIndex,this.availableImages=availableImages,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(params,abortController){return performance.__awaiter(this,void 0,void 0,(function*(){const response=yield performance.getArrayBuffer(params.request,abortController);try{return{vectorTile:new performance.vectorTile.VectorTile(new performance.Protobuf(response.data)),rawData:response.data,cacheControl:response.cacheControl,expires:response.expires}}catch(ex){const bytes=new Uint8Array(response.data),isGzipped=31===bytes[0]&&139===bytes[1];let errorMessage=`Unable to parse the tile at ${params.request.url}, `;throw errorMessage+=isGzipped?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${ex.messge}`,new Error(errorMessage)}}))}loadTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){const tileUid=params.uid,perf=!!(params&&params.request&&params.request.collectResourceTiming)&&new performance.RequestPerformance(params.request),workerTile=new WorkerTile(params);this.loading[tileUid]=workerTile;const abortController=new AbortController;workerTile.abort=abortController;try{const response=yield this.loadVectorTile(params,abortController);if(delete this.loading[tileUid],!response)return null;const rawTileData=response.rawData,cacheControl={};response.expires&&(cacheControl.expires=response.expires),response.cacheControl&&(cacheControl.cacheControl=response.cacheControl);const resourceTiming={};if(perf){const resourceTimingData=perf.finish();resourceTimingData&&(resourceTiming.resourceTiming=JSON.parse(JSON.stringify(resourceTimingData)))}workerTile.vectorTile=response.vectorTile;const parsePromise=workerTile.parse(response.vectorTile,this.layerIndex,this.availableImages,this.actor);this.loaded[tileUid]=workerTile,this.fetching[tileUid]={rawTileData:rawTileData,cacheControl:cacheControl,resourceTiming:resourceTiming};try{const result=yield parsePromise;return performance.extend({rawTileData:rawTileData.slice(0)},result,cacheControl,resourceTiming)}finally{delete this.fetching[tileUid]}}catch(err){throw delete this.loading[tileUid],workerTile.status="done",this.loaded[tileUid]=workerTile,err}}))}reloadTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){const uid=params.uid;if(!this.loaded||!this.loaded[uid])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const workerTile=this.loaded[uid];if(workerTile.showCollisionBoxes=params.showCollisionBoxes,"parsing"===workerTile.status){const result=yield workerTile.parse(workerTile.vectorTile,this.layerIndex,this.availableImages,this.actor);let parseResult;if(this.fetching[uid]){const{rawTileData:rawTileData,cacheControl:cacheControl,resourceTiming:resourceTiming}=this.fetching[uid];delete this.fetching[uid],parseResult=performance.extend({rawTileData:rawTileData.slice(0)},result,cacheControl,resourceTiming)}else parseResult=result;return parseResult}if("done"===workerTile.status&&workerTile.vectorTile)return workerTile.parse(workerTile.vectorTile,this.layerIndex,this.availableImages,this.actor)}))}abortTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){const loading=this.loading,uid=params.uid;loading&&loading[uid]&&loading[uid].abort&&(loading[uid].abort.abort(),delete loading[uid])}))}removeTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){this.loaded&&this.loaded[params.uid]&&delete this.loaded[params.uid]}))}}class RasterDEMTileWorkerSource{constructor(){this.loaded={}}loadTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){const{uid:uid,encoding:encoding,rawImageData:rawImageData,redFactor:redFactor,greenFactor:greenFactor,blueFactor:blueFactor,baseShift:baseShift}=params,width=rawImageData.width+2,height=rawImageData.height+2,imagePixels=performance.isImageBitmap(rawImageData)?new performance.RGBAImage({width:width,height:height},yield performance.getImageData(rawImageData,-1,-1,width,height)):rawImageData,dem=new performance.DEMData(uid,imagePixels,encoding,redFactor,greenFactor,blueFactor,baseShift);return this.loaded=this.loaded||{},this.loaded[uid]=dem,dem}))}removeTile(params){const loaded=this.loaded,uid=params.uid;loaded&&loaded[uid]&&delete loaded[uid]}}var geojsonRewind=function rewind$1(gj,outer){var i,type=gj&&gj.type;if("FeatureCollection"===type)for(i=0;i<gj.features.length;i++)rewind$1(gj.features[i],outer);else if("GeometryCollection"===type)for(i=0;i<gj.geometries.length;i++)rewind$1(gj.geometries[i],outer);else if("Feature"===type)rewind$1(gj.geometry,outer);else if("Polygon"===type)rewindRings(gj.coordinates,outer);else if("MultiPolygon"===type)for(i=0;i<gj.coordinates.length;i++)rewindRings(gj.coordinates[i],outer);return gj};function rewindRings(rings,outer){if(0!==rings.length){rewindRing(rings[0],outer);for(var i=1;i<rings.length;i++)rewindRing(rings[i],!outer)}}function rewindRing(ring,dir){for(var area=0,err=0,i=0,len=ring.length,j=len-1;i<len;j=i++){var k=(ring[i][0]-ring[j][0])*(ring[j][1]+ring[i][1]),m=area+k;err+=Math.abs(area)>=Math.abs(k)?area-m+k:k-m+area,area=m}area+err>=0!=!!dir&&ring.reverse()}var rewind$2=performance.getDefaultExportFromCjs(geojsonRewind);const toGeoJSON=performance.vectorTile.VectorTileFeature.prototype.toGeoJSON;let FeatureWrapper$1=class{constructor(feature){this._feature=feature,this.extent=performance.EXTENT,this.type=feature.type,this.properties=feature.tags,"id"in feature&&!isNaN(feature.id)&&(this.id=parseInt(feature.id,10))}loadGeometry(){if(1===this._feature.type){const geometry=[];for(const point of this._feature.geometry)geometry.push([new performance.Point(point[0],point[1])]);return geometry}{const geometry=[];for(const ring of this._feature.geometry){const newRing=[];for(const point of ring)newRing.push(new performance.Point(point[0],point[1]));geometry.push(newRing)}return geometry}}toGeoJSON(x,y,z){return toGeoJSON.call(this,x,y,z)}},GeoJSONWrapper$2=class{constructor(features){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=performance.EXTENT,this.length=features.length,this._features=features}feature(i){return new FeatureWrapper$1(this._features[i])}};var vtPbf$1={exports:{}},Point=performance.pointGeometry,VectorTileFeature=performance.vectorTile.VectorTileFeature,geojson_wrapper=GeoJSONWrapper$1;function GeoJSONWrapper$1(features,options){this.options=options||{},this.features=features,this.length=features.length}function FeatureWrapper(feature,extent){this.id="number"==typeof feature.id?feature.id:void 0,this.type=feature.type,this.rawGeometry=1===feature.type?[feature.geometry]:feature.geometry,this.properties=feature.tags,this.extent=extent||4096}GeoJSONWrapper$1.prototype.feature=function(i){return new FeatureWrapper(this.features[i],this.options.extent)},FeatureWrapper.prototype.loadGeometry=function(){var rings=this.rawGeometry;this.geometry=[];for(var i=0;i<rings.length;i++){for(var ring=rings[i],newRing=[],j=0;j<ring.length;j++)newRing.push(new Point(ring[j][0],ring[j][1]));this.geometry.push(newRing)}return this.geometry},FeatureWrapper.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var rings=this.geometry,x1=1/0,x2=-1/0,y1=1/0,y2=-1/0,i=0;i<rings.length;i++)for(var ring=rings[i],j=0;j<ring.length;j++){var coord=ring[j];x1=Math.min(x1,coord.x),x2=Math.max(x2,coord.x),y1=Math.min(y1,coord.y),y2=Math.max(y2,coord.y)}return[x1,y1,x2,y2]},FeatureWrapper.prototype.toGeoJSON=VectorTileFeature.prototype.toGeoJSON;vtPbf$1.exports;var Pbf=performance.pbf,GeoJSONWrapper=geojson_wrapper;vtPbf$1.exports=fromVectorTileJs;vtPbf$1.exports.fromVectorTileJs=fromVectorTileJs,vtPbf$1.exports.fromGeojsonVt=function(layers,options){options=options||{};var l={};for(var k in layers)l[k]=new GeoJSONWrapper(layers[k].features,options),l[k].name=k,l[k].version=options.version,l[k].extent=options.extent;return fromVectorTileJs({layers:l})},vtPbf$1.exports.GeoJSONWrapper=GeoJSONWrapper;function fromVectorTileJs(tile){var out=new Pbf;return function(tile,pbf){for(var key in tile.layers)pbf.writeMessage(3,writeLayer,tile.layers[key])}(tile,out),out.finish()}function writeLayer(layer,pbf){var i;pbf.writeVarintField(15,layer.version||1),pbf.writeStringField(1,layer.name||""),pbf.writeVarintField(5,layer.extent||4096);var context={keys:[],values:[],keycache:{},valuecache:{}};for(i=0;i<layer.length;i++)context.feature=layer.feature(i),pbf.writeMessage(2,writeFeature,context);var keys=context.keys;for(i=0;i<keys.length;i++)pbf.writeStringField(3,keys[i]);var values=context.values;for(i=0;i<values.length;i++)pbf.writeMessage(4,writeValue,values[i])}function writeFeature(context,pbf){var feature=context.feature;void 0!==feature.id&&pbf.writeVarintField(1,feature.id),pbf.writeMessage(2,writeProperties,context),pbf.writeVarintField(3,feature.type),pbf.writeMessage(4,writeGeometry,feature)}function writeProperties(context,pbf){var feature=context.feature,keys=context.keys,values=context.values,keycache=context.keycache,valuecache=context.valuecache;for(var key in feature.properties){var value=feature.properties[key],keyIndex=keycache[key];if(null!==value){void 0===keyIndex&&(keys.push(key),keyIndex=keys.length-1,keycache[key]=keyIndex),pbf.writeVarint(keyIndex);var type=typeof value;"string"!==type&&"boolean"!==type&&"number"!==type&&(value=JSON.stringify(value));var valueKey=type+":"+value,valueIndex=valuecache[valueKey];void 0===valueIndex&&(values.push(value),valueIndex=values.length-1,valuecache[valueKey]=valueIndex),pbf.writeVarint(valueIndex)}}}function command(cmd,length){return(length<<3)+(7&cmd)}function zigzag(num){return num<<1^num>>31}function writeGeometry(feature,pbf){for(var geometry=feature.loadGeometry(),type=feature.type,x=0,y=0,rings=geometry.length,r=0;r<rings;r++){var ring=geometry[r],count=1;1===type&&(count=ring.length),pbf.writeVarint(command(1,count));for(var lineCount=3===type?ring.length-1:ring.length,i=0;i<lineCount;i++){1===i&&1!==type&&pbf.writeVarint(command(2,lineCount-1));var dx=ring[i].x-x,dy=ring[i].y-y;pbf.writeVarint(zigzag(dx)),pbf.writeVarint(zigzag(dy)),x+=dx,y+=dy}3===type&&pbf.writeVarint(command(7,1))}}function writeValue(value,pbf){var type=typeof value;"string"===type?pbf.writeStringField(1,value):"boolean"===type?pbf.writeBooleanField(7,value):"number"===type&&(value%1!=0?pbf.writeDoubleField(3,value):value<0?pbf.writeSVarintField(6,value):pbf.writeVarintField(5,value))}var vtPbfExports=vtPbf$1.exports,vtpbf=performance.getDefaultExportFromCjs(vtPbfExports);const defaultOptions={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:props=>props},fround=Math.fround||(tmp=new Float32Array(1),x=>(tmp[0]=+x,tmp[0]));var tmp;const OFFSET_ID=3,OFFSET_NUM=5,OFFSET_PROP=6;class Supercluster{constructor(options){this.options=Object.assign(Object.create(defaultOptions),options),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(points){const{log:log,minZoom:minZoom,maxZoom:maxZoom}=this.options;log&&console.time("total time");const timerId=`prepare ${points.length} points`;log&&console.time(timerId),this.points=points;const data=[];for(let i=0;i<points.length;i++){const p=points[i];if(!p.geometry)continue;const[lng,lat]=p.geometry.coordinates,x=fround(lngX(lng)),y=fround(latY(lat));data.push(x,y,1/0,i,-1,1),this.options.reduce&&data.push(0)}let tree=this.trees[maxZoom+1]=this._createTree(data);log&&console.timeEnd(timerId);for(let z=maxZoom;z>=minZoom;z--){const now=+Date.now();tree=this.trees[z]=this._createTree(this._cluster(tree,z)),log&&console.log("z%d: %d clusters in %dms",z,tree.numItems,+Date.now()-now)}return log&&console.timeEnd("total time"),this}getClusters(bbox,zoom){let minLng=((bbox[0]+180)%360+360)%360-180;const minLat=Math.max(-90,Math.min(90,bbox[1]));let maxLng=180===bbox[2]?180:((bbox[2]+180)%360+360)%360-180;const maxLat=Math.max(-90,Math.min(90,bbox[3]));if(bbox[2]-bbox[0]>=360)minLng=-180,maxLng=180;else if(minLng>maxLng){const easternHem=this.getClusters([minLng,minLat,180,maxLat],zoom),westernHem=this.getClusters([-180,minLat,maxLng,maxLat],zoom);return easternHem.concat(westernHem)}const tree=this.trees[this._limitZoom(zoom)],ids=tree.range(lngX(minLng),latY(maxLat),lngX(maxLng),latY(minLat)),data=tree.data,clusters=[];for(const id of ids){const k=this.stride*id;clusters.push(data[k+OFFSET_NUM]>1?getClusterJSON(data,k,this.clusterProps):this.points[data[k+OFFSET_ID]])}return clusters}getChildren(clusterId){const originId=this._getOriginId(clusterId),originZoom=this._getOriginZoom(clusterId),errorMsg="No cluster with the specified id.",tree=this.trees[originZoom];if(!tree)throw new Error(errorMsg);const data=tree.data;if(originId*this.stride>=data.length)throw new Error(errorMsg);const r=this.options.radius/(this.options.extent*Math.pow(2,originZoom-1)),x=data[originId*this.stride],y=data[originId*this.stride+1],ids=tree.within(x,y,r),children=[];for(const id of ids){const k=id*this.stride;data[k+4]===clusterId&&children.push(data[k+OFFSET_NUM]>1?getClusterJSON(data,k,this.clusterProps):this.points[data[k+OFFSET_ID]])}if(0===children.length)throw new Error(errorMsg);return children}getLeaves(clusterId,limit,offset){limit=limit||10,offset=offset||0;const leaves=[];return this._appendLeaves(leaves,clusterId,limit,offset,0),leaves}getTile(z,x,y){const tree=this.trees[this._limitZoom(z)],z2=Math.pow(2,z),{extent:extent,radius:radius}=this.options,p=radius/extent,top=(y-p)/z2,bottom=(y+1+p)/z2,tile={features:[]};return this._addTileFeatures(tree.range((x-p)/z2,top,(x+1+p)/z2,bottom),tree.data,x,y,z2,tile),0===x&&this._addTileFeatures(tree.range(1-p/z2,top,1,bottom),tree.data,z2,y,z2,tile),x===z2-1&&this._addTileFeatures(tree.range(0,top,p/z2,bottom),tree.data,-1,y,z2,tile),tile.features.length?tile:null}getClusterExpansionZoom(clusterId){let expansionZoom=this._getOriginZoom(clusterId)-1;for(;expansionZoom<=this.options.maxZoom;){const children=this.getChildren(clusterId);if(expansionZoom++,1!==children.length)break;clusterId=children[0].properties.cluster_id}return expansionZoom}_appendLeaves(result,clusterId,limit,offset,skipped){const children=this.getChildren(clusterId);for(const child of children){const props=child.properties;if(props&&props.cluster?skipped+props.point_count<=offset?skipped+=props.point_count:skipped=this._appendLeaves(result,props.cluster_id,limit,offset,skipped):skipped<offset?skipped++:result.push(child),result.length===limit)break}return skipped}_createTree(data){const tree=new performance.KDBush(data.length/this.stride|0,this.options.nodeSize,Float32Array);for(let i=0;i<data.length;i+=this.stride)tree.add(data[i],data[i+1]);return tree.finish(),tree.data=data,tree}_addTileFeatures(ids,data,x,y,z2,tile){for(const i of ids){const k=i*this.stride,isCluster=data[k+OFFSET_NUM]>1;let tags,px,py;if(isCluster)tags=getClusterProperties(data,k,this.clusterProps),px=data[k],py=data[k+1];else{const p=this.points[data[k+OFFSET_ID]];tags=p.properties;const[lng,lat]=p.geometry.coordinates;px=lngX(lng),py=latY(lat)}const f={type:1,geometry:[[Math.round(this.options.extent*(px*z2-x)),Math.round(this.options.extent*(py*z2-y))]],tags:tags};let id;id=isCluster||this.options.generateId?data[k+OFFSET_ID]:this.points[data[k+OFFSET_ID]].id,void 0!==id&&(f.id=id),tile.features.push(f)}}_limitZoom(z){return Math.max(this.options.minZoom,Math.min(Math.floor(+z),this.options.maxZoom+1))}_cluster(tree,zoom){const{radius:radius,extent:extent,reduce:reduce,minPoints:minPoints}=this.options,r=radius/(extent*Math.pow(2,zoom)),data=tree.data,nextData=[],stride=this.stride;for(let i=0;i<data.length;i+=stride){if(data[i+2]<=zoom)continue;data[i+2]=zoom;const x=data[i],y=data[i+1],neighborIds=tree.within(data[i],data[i+1],r),numPointsOrigin=data[i+OFFSET_NUM];let numPoints=numPointsOrigin;for(const neighborId of neighborIds){const k=neighborId*stride;data[k+2]>zoom&&(numPoints+=data[k+OFFSET_NUM])}if(numPoints>numPointsOrigin&&numPoints>=minPoints){let clusterProperties,wx=x*numPointsOrigin,wy=y*numPointsOrigin,clusterPropIndex=-1;const id=((i/stride|0)<<5)+(zoom+1)+this.points.length;for(const neighborId of neighborIds){const k=neighborId*stride;if(data[k+2]<=zoom)continue;data[k+2]=zoom;const numPoints2=data[k+OFFSET_NUM];wx+=data[k]*numPoints2,wy+=data[k+1]*numPoints2,data[k+4]=id,reduce&&(clusterProperties||(clusterProperties=this._map(data,i,!0),clusterPropIndex=this.clusterProps.length,this.clusterProps.push(clusterProperties)),reduce(clusterProperties,this._map(data,k)))}data[i+4]=id,nextData.push(wx/numPoints,wy/numPoints,1/0,id,-1,numPoints),reduce&&nextData.push(clusterPropIndex)}else{for(let j=0;j<stride;j++)nextData.push(data[i+j]);if(numPoints>1)for(const neighborId of neighborIds){const k=neighborId*stride;if(!(data[k+2]<=zoom)){data[k+2]=zoom;for(let j=0;j<stride;j++)nextData.push(data[k+j])}}}}return nextData}_getOriginId(clusterId){return clusterId-this.points.length>>5}_getOriginZoom(clusterId){return(clusterId-this.points.length)%32}_map(data,i,clone){if(data[i+OFFSET_NUM]>1){const props=this.clusterProps[data[i+OFFSET_PROP]];return clone?Object.assign({},props):props}const original=this.points[data[i+OFFSET_ID]].properties,result=this.options.map(original);return clone&&result===original?Object.assign({},result):result}}function getClusterJSON(data,i,clusterProps){return{type:"Feature",id:data[i+OFFSET_ID],properties:getClusterProperties(data,i,clusterProps),geometry:{type:"Point",coordinates:[(x=data[i],360*(x-.5)),yLat(data[i+1])]}};var x}function getClusterProperties(data,i,clusterProps){const count=data[i+OFFSET_NUM],abbrev=count>=1e4?`${Math.round(count/1e3)}k`:count>=1e3?Math.round(count/100)/10+"k":count,propIndex=data[i+OFFSET_PROP],properties=-1===propIndex?{}:Object.assign({},clusterProps[propIndex]);return Object.assign(properties,{cluster:!0,cluster_id:data[i+OFFSET_ID],point_count:count,point_count_abbreviated:abbrev})}function lngX(lng){return lng/360+.5}function latY(lat){const sin=Math.sin(lat*Math.PI/180),y=.5-.25*Math.log((1+sin)/(1-sin))/Math.PI;return y<0?0:y>1?1:y}function yLat(y){const y2=(180-360*y)*Math.PI/180;return 360*Math.atan(Math.exp(y2))/Math.PI-90}function simplify(coords,first,last,sqTolerance){for(var index,maxSqDist=sqTolerance,mid=last-first>>1,minPosToMid=last-first,ax=coords[first],ay=coords[first+1],bx=coords[last],by=coords[last+1],i=first+3;i<last;i+=3){var d=getSqSegDist(coords[i],coords[i+1],ax,ay,bx,by);if(d>maxSqDist)index=i,maxSqDist=d;else if(d===maxSqDist){var posToMid=Math.abs(i-mid);posToMid<minPosToMid&&(index=i,minPosToMid=posToMid)}}maxSqDist>sqTolerance&&(index-first>3&&simplify(coords,first,index,sqTolerance),coords[index+2]=maxSqDist,last-index>3&&simplify(coords,index,last,sqTolerance))}function getSqSegDist(px,py,x,y,bx,by){var dx=bx-x,dy=by-y;if(0!==dx||0!==dy){var t=((px-x)*dx+(py-y)*dy)/(dx*dx+dy*dy);t>1?(x=bx,y=by):t>0&&(x+=dx*t,y+=dy*t)}return(dx=px-x)*dx+(dy=py-y)*dy}function createFeature(id,type,geom,tags){var feature={id:void 0===id?null:id,type:type,geometry:geom,tags:tags,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(feature){var geom=feature.geometry,type=feature.type;if("Point"===type||"MultiPoint"===type||"LineString"===type)calcLineBBox(feature,geom);else if("Polygon"===type||"MultiLineString"===type)for(var i=0;i<geom.length;i++)calcLineBBox(feature,geom[i]);else if("MultiPolygon"===type)for(i=0;i<geom.length;i++)for(var j=0;j<geom[i].length;j++)calcLineBBox(feature,geom[i][j])}(feature),feature}function calcLineBBox(feature,geom){for(var i=0;i<geom.length;i+=3)feature.minX=Math.min(feature.minX,geom[i]),feature.minY=Math.min(feature.minY,geom[i+1]),feature.maxX=Math.max(feature.maxX,geom[i]),feature.maxY=Math.max(feature.maxY,geom[i+1])}function convertFeature(features,geojson,options,index){if(geojson.geometry){var coords=geojson.geometry.coordinates,type=geojson.geometry.type,tolerance=Math.pow(options.tolerance/((1<<options.maxZoom)*options.extent),2),geometry=[],id=geojson.id;if(options.promoteId?id=geojson.properties[options.promoteId]:options.generateId&&(id=index||0),"Point"===type)convertPoint(coords,geometry);else if("MultiPoint"===type)for(var i=0;i<coords.length;i++)convertPoint(coords[i],geometry);else if("LineString"===type)convertLine(coords,geometry,tolerance,!1);else if("MultiLineString"===type){if(options.lineMetrics){for(i=0;i<coords.length;i++)geometry=[],convertLine(coords[i],geometry,tolerance,!1),features.push(createFeature(id,"LineString",geometry,geojson.properties));return}convertLines(coords,geometry,tolerance,!1)}else if("Polygon"===type)convertLines(coords,geometry,tolerance,!0);else{if("MultiPolygon"!==type){if("GeometryCollection"===type){for(i=0;i<geojson.geometry.geometries.length;i++)convertFeature(features,{id:id,geometry:geojson.geometry.geometries[i],properties:geojson.properties},options,index);return}throw new Error("Input data is not a valid GeoJSON object.")}for(i=0;i<coords.length;i++){var polygon=[];convertLines(coords[i],polygon,tolerance,!0),geometry.push(polygon)}}features.push(createFeature(id,type,geometry,geojson.properties))}}function convertPoint(coords,out){out.push(projectX(coords[0])),out.push(projectY(coords[1])),out.push(0)}function convertLine(ring,out,tolerance,isPolygon){for(var x0,y0,size=0,j=0;j<ring.length;j++){var x=projectX(ring[j][0]),y=projectY(ring[j][1]);out.push(x),out.push(y),out.push(0),j>0&&(size+=isPolygon?(x0*y-x*y0)/2:Math.sqrt(Math.pow(x-x0,2)+Math.pow(y-y0,2))),x0=x,y0=y}var last=out.length-3;out[2]=1,simplify(out,0,last,tolerance),out[last+2]=1,out.size=Math.abs(size),out.start=0,out.end=out.size}function convertLines(rings,out,tolerance,isPolygon){for(var i=0;i<rings.length;i++){var geom=[];convertLine(rings[i],geom,tolerance,isPolygon),out.push(geom)}}function projectX(x){return x/360+.5}function projectY(y){var sin=Math.sin(y*Math.PI/180),y2=.5-.25*Math.log((1+sin)/(1-sin))/Math.PI;return y2<0?0:y2>1?1:y2}function clip(features,scale,k1,k2,axis,minAll,maxAll,options){if(k2/=scale,minAll>=(k1/=scale)&&maxAll<k2)return features;if(maxAll<k1||minAll>=k2)return null;for(var clipped=[],i=0;i<features.length;i++){var feature=features[i],geometry=feature.geometry,type=feature.type,min=0===axis?feature.minX:feature.minY,max=0===axis?feature.maxX:feature.maxY;if(min>=k1&&max<k2)clipped.push(feature);else if(!(max<k1||min>=k2)){var newGeometry=[];if("Point"===type||"MultiPoint"===type)clipPoints(geometry,newGeometry,k1,k2,axis);else if("LineString"===type)clipLine(geometry,newGeometry,k1,k2,axis,!1,options.lineMetrics);else if("MultiLineString"===type)clipLines(geometry,newGeometry,k1,k2,axis,!1);else if("Polygon"===type)clipLines(geometry,newGeometry,k1,k2,axis,!0);else if("MultiPolygon"===type)for(var j=0;j<geometry.length;j++){var polygon=[];clipLines(geometry[j],polygon,k1,k2,axis,!0),polygon.length&&newGeometry.push(polygon)}if(newGeometry.length){if(options.lineMetrics&&"LineString"===type){for(j=0;j<newGeometry.length;j++)clipped.push(createFeature(feature.id,type,newGeometry[j],feature.tags));continue}"LineString"!==type&&"MultiLineString"!==type||(1===newGeometry.length?(type="LineString",newGeometry=newGeometry[0]):type="MultiLineString"),"Point"!==type&&"MultiPoint"!==type||(type=3===newGeometry.length?"Point":"MultiPoint"),clipped.push(createFeature(feature.id,type,newGeometry,feature.tags))}}}return clipped.length?clipped:null}function clipPoints(geom,newGeom,k1,k2,axis){for(var i=0;i<geom.length;i+=3){var a=geom[i+axis];a>=k1&&a<=k2&&(newGeom.push(geom[i]),newGeom.push(geom[i+1]),newGeom.push(geom[i+2]))}}function clipLine(geom,newGeom,k1,k2,axis,isPolygon,trackMetrics){for(var segLen,t,slice=newSlice(geom),intersect=0===axis?intersectX:intersectY,len=geom.start,i=0;i<geom.length-3;i+=3){var ax=geom[i],ay=geom[i+1],az=geom[i+2],bx=geom[i+3],by=geom[i+4],a=0===axis?ax:ay,b=0===axis?bx:by,exited=!1;trackMetrics&&(segLen=Math.sqrt(Math.pow(ax-bx,2)+Math.pow(ay-by,2))),a<k1?b>k1&&(t=intersect(slice,ax,ay,bx,by,k1),trackMetrics&&(slice.start=len+segLen*t)):a>k2?b<k2&&(t=intersect(slice,ax,ay,bx,by,k2),trackMetrics&&(slice.start=len+segLen*t)):addPoint(slice,ax,ay,az),b<k1&&a>=k1&&(t=intersect(slice,ax,ay,bx,by,k1),exited=!0),b>k2&&a<=k2&&(t=intersect(slice,ax,ay,bx,by,k2),exited=!0),!isPolygon&&exited&&(trackMetrics&&(slice.end=len+segLen*t),newGeom.push(slice),slice=newSlice(geom)),trackMetrics&&(len+=segLen)}var last=geom.length-3;ax=geom[last],ay=geom[last+1],az=geom[last+2],(a=0===axis?ax:ay)>=k1&&a<=k2&&addPoint(slice,ax,ay,az),last=slice.length-3,isPolygon&&last>=3&&(slice[last]!==slice[0]||slice[last+1]!==slice[1])&&addPoint(slice,slice[0],slice[1],slice[2]),slice.length&&newGeom.push(slice)}function newSlice(line){var slice=[];return slice.size=line.size,slice.start=line.start,slice.end=line.end,slice}function clipLines(geom,newGeom,k1,k2,axis,isPolygon){for(var i=0;i<geom.length;i++)clipLine(geom[i],newGeom,k1,k2,axis,isPolygon,!1)}function addPoint(out,x,y,z){out.push(x),out.push(y),out.push(z)}function intersectX(out,ax,ay,bx,by,x){var t=(x-ax)/(bx-ax);return out.push(x),out.push(ay+(by-ay)*t),out.push(1),t}function intersectY(out,ax,ay,bx,by,y){var t=(y-ay)/(by-ay);return out.push(ax+(bx-ax)*t),out.push(y),out.push(1),t}function shiftFeatureCoords(features,offset){for(var newFeatures=[],i=0;i<features.length;i++){var newGeometry,feature=features[i],type=feature.type;if("Point"===type||"MultiPoint"===type||"LineString"===type)newGeometry=shiftCoords(feature.geometry,offset);else if("MultiLineString"===type||"Polygon"===type){newGeometry=[];for(var j=0;j<feature.geometry.length;j++)newGeometry.push(shiftCoords(feature.geometry[j],offset))}else if("MultiPolygon"===type)for(newGeometry=[],j=0;j<feature.geometry.length;j++){for(var newPolygon=[],k=0;k<feature.geometry[j].length;k++)newPolygon.push(shiftCoords(feature.geometry[j][k],offset));newGeometry.push(newPolygon)}newFeatures.push(createFeature(feature.id,type,newGeometry,feature.tags))}return newFeatures}function shiftCoords(points,offset){var newPoints=[];newPoints.size=points.size,void 0!==points.start&&(newPoints.start=points.start,newPoints.end=points.end);for(var i=0;i<points.length;i+=3)newPoints.push(points[i]+offset,points[i+1],points[i+2]);return newPoints}function transformTile(tile,extent){if(tile.transformed)return tile;var i,j,k,z2=1<<tile.z,tx=tile.x,ty=tile.y;for(i=0;i<tile.features.length;i++){var feature=tile.features[i],geom=feature.geometry,type=feature.type;if(feature.geometry=[],1===type)for(j=0;j<geom.length;j+=2)feature.geometry.push(transformPoint(geom[j],geom[j+1],extent,z2,tx,ty));else for(j=0;j<geom.length;j++){var ring=[];for(k=0;k<geom[j].length;k+=2)ring.push(transformPoint(geom[j][k],geom[j][k+1],extent,z2,tx,ty));feature.geometry.push(ring)}}return tile.transformed=!0,tile}function transformPoint(x,y,extent,z2,tx,ty){return[Math.round(extent*(x*z2-tx)),Math.round(extent*(y*z2-ty))]}function createTile(features,z,tx,ty,options){for(var tolerance=z===options.maxZoom?0:options.tolerance/((1<<z)*options.extent),tile={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:tx,y:ty,z:z,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},i=0;i<features.length;i++){tile.numFeatures++,addFeature(tile,features[i],tolerance,options);var minX=features[i].minX,minY=features[i].minY,maxX=features[i].maxX,maxY=features[i].maxY;minX<tile.minX&&(tile.minX=minX),minY<tile.minY&&(tile.minY=minY),maxX>tile.maxX&&(tile.maxX=maxX),maxY>tile.maxY&&(tile.maxY=maxY)}return tile}function addFeature(tile,feature,tolerance,options){var geom=feature.geometry,type=feature.type,simplified=[];if("Point"===type||"MultiPoint"===type)for(var i=0;i<geom.length;i+=3)simplified.push(geom[i]),simplified.push(geom[i+1]),tile.numPoints++,tile.numSimplified++;else if("LineString"===type)addLine(simplified,geom,tile,tolerance,!1,!1);else if("MultiLineString"===type||"Polygon"===type)for(i=0;i<geom.length;i++)addLine(simplified,geom[i],tile,tolerance,"Polygon"===type,0===i);else if("MultiPolygon"===type)for(var k=0;k<geom.length;k++){var polygon=geom[k];for(i=0;i<polygon.length;i++)addLine(simplified,polygon[i],tile,tolerance,!0,0===i)}if(simplified.length){var tags=feature.tags||null;if("LineString"===type&&options.lineMetrics){for(var key in tags={},feature.tags)tags[key]=feature.tags[key];tags.mapbox_clip_start=geom.start/geom.size,tags.mapbox_clip_end=geom.end/geom.size}var tileFeature={geometry:simplified,type:"Polygon"===type||"MultiPolygon"===type?3:"LineString"===type||"MultiLineString"===type?2:1,tags:tags};null!==feature.id&&(tileFeature.id=feature.id),tile.features.push(tileFeature)}}function addLine(result,geom,tile,tolerance,isPolygon,isOuter){var sqTolerance=tolerance*tolerance;if(tolerance>0&&geom.size<(isPolygon?sqTolerance:tolerance))tile.numPoints+=geom.length/3;else{for(var ring=[],i=0;i<geom.length;i+=3)(0===tolerance||geom[i+2]>sqTolerance)&&(tile.numSimplified++,ring.push(geom[i]),ring.push(geom[i+1])),tile.numPoints++;isPolygon&&function(ring,clockwise){for(var area=0,i=0,len=ring.length,j=len-2;i<len;j=i,i+=2)area+=(ring[i]-ring[j])*(ring[i+1]+ring[j+1]);if(area>0===clockwise)for(i=0,len=ring.length;i<len/2;i+=2){var x=ring[i],y=ring[i+1];ring[i]=ring[len-2-i],ring[i+1]=ring[len-1-i],ring[len-2-i]=x,ring[len-1-i]=y}}(ring,isOuter),result.push(ring)}}function GeoJSONVT(data,options){var debug=(options=this.options=function(dest,src){for(var i in src)dest[i]=src[i];return dest}(Object.create(this.options),options)).debug;if(debug&&console.time("preprocess data"),options.maxZoom<0||options.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(options.promoteId&&options.generateId)throw new Error("promoteId and generateId cannot be used together.");var features=function(data,options){var features=[];if("FeatureCollection"===data.type)for(var i=0;i<data.features.length;i++)convertFeature(features,data.features[i],options,i);else"Feature"===data.type?convertFeature(features,data,options):convertFeature(features,{geometry:data},options);return features}(data,options);this.tiles={},this.tileCoords=[],debug&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",options.indexMaxZoom,options.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),features=function(features,options){var buffer=options.buffer/options.extent,merged=features,left=clip(features,1,-1-buffer,buffer,0,-1,2,options),right=clip(features,1,1-buffer,2+buffer,0,-1,2,options);return(left||right)&&(merged=clip(features,1,-buffer,1+buffer,0,-1,2,options)||[],left&&(merged=shiftFeatureCoords(left,1).concat(merged)),right&&(merged=merged.concat(shiftFeatureCoords(right,-1)))),merged}(features,options),features.length&&this.splitTile(features,0,0,0),debug&&(features.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function toID(z,x,y){return 32*((1<<z)*y+x)+z}function getFeatureId(feature,promoteId){return promoteId?feature.properties[promoteId]:feature.id}function isUpdateableGeoJSON(data,promoteId){if(null==data)return!0;if("Feature"===data.type)return null!=getFeatureId(data,promoteId);if("FeatureCollection"===data.type){const seenIds=new Set;for(const feature of data.features){const id=getFeatureId(feature,promoteId);if(null==id)return!1;if(seenIds.has(id))return!1;seenIds.add(id)}return!0}return!1}function toUpdateable(data,promoteId){const result=new Map;if(null==data);else if("Feature"===data.type)result.set(getFeatureId(data,promoteId),data);else for(const feature of data.features)result.set(getFeatureId(feature,promoteId),feature);return result}GeoJSONVT.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},GeoJSONVT.prototype.splitTile=function(features,z,x,y,cz,cx,cy){for(var stack=[features,z,x,y],options=this.options,debug=options.debug;stack.length;){y=stack.pop(),x=stack.pop(),z=stack.pop(),features=stack.pop();var z2=1<<z,id=toID(z,x,y),tile=this.tiles[id];if(!tile&&(debug>1&&console.time("creation"),tile=this.tiles[id]=createTile(features,z,x,y,options),this.tileCoords.push({z:z,x:x,y:y}),debug)){debug>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",z,x,y,tile.numFeatures,tile.numPoints,tile.numSimplified),console.timeEnd("creation"));var key="z"+z;this.stats[key]=(this.stats[key]||0)+1,this.total++}if(tile.source=features,cz){if(z===options.maxZoom||z===cz)continue;var m=1<<cz-z;if(x!==Math.floor(cx/m)||y!==Math.floor(cy/m))continue}else if(z===options.indexMaxZoom||tile.numPoints<=options.indexMaxPoints)continue;if(tile.source=null,0!==features.length){debug>1&&console.time("clipping");var tl,bl,tr,br,left,right,k1=.5*options.buffer/options.extent,k2=.5-k1,k3=.5+k1,k4=1+k1;tl=bl=tr=br=null,left=clip(features,z2,x-k1,x+k3,0,tile.minX,tile.maxX,options),right=clip(features,z2,x+k2,x+k4,0,tile.minX,tile.maxX,options),features=null,left&&(tl=clip(left,z2,y-k1,y+k3,1,tile.minY,tile.maxY,options),bl=clip(left,z2,y+k2,y+k4,1,tile.minY,tile.maxY,options),left=null),right&&(tr=clip(right,z2,y-k1,y+k3,1,tile.minY,tile.maxY,options),br=clip(right,z2,y+k2,y+k4,1,tile.minY,tile.maxY,options),right=null),debug>1&&console.timeEnd("clipping"),stack.push(tl||[],z+1,2*x,2*y),stack.push(bl||[],z+1,2*x,2*y+1),stack.push(tr||[],z+1,2*x+1,2*y),stack.push(br||[],z+1,2*x+1,2*y+1)}}},GeoJSONVT.prototype.getTile=function(z,x,y){var options=this.options,extent=options.extent,debug=options.debug;if(z<0||z>24)return null;var z2=1<<z,id=toID(z,x=(x%z2+z2)%z2,y);if(this.tiles[id])return transformTile(this.tiles[id],extent);debug>1&&console.log("drilling down to z%d-%d-%d",z,x,y);for(var parent,z0=z,x0=x,y0=y;!parent&&z0>0;)z0--,x0=Math.floor(x0/2),y0=Math.floor(y0/2),parent=this.tiles[toID(z0,x0,y0)];return parent&&parent.source?(debug>1&&console.log("found parent tile z%d-%d-%d",z0,x0,y0),debug>1&&console.time("drilling down"),this.splitTile(parent.source,z0,x0,y0,z,x,y),debug>1&&console.timeEnd("drilling down"),this.tiles[id]?transformTile(this.tiles[id],extent):null):null};class GeoJSONWorkerSource extends VectorTileWorkerSource{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(params,_abortController){return performance.__awaiter(this,void 0,void 0,(function*(){const canonical=params.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const geoJSONTile=this._geoJSONIndex.getTile(canonical.z,canonical.x,canonical.y);if(!geoJSONTile)return null;const geojsonWrapper=new GeoJSONWrapper$2(geoJSONTile.features);let pbf=vtpbf(geojsonWrapper);return 0===pbf.byteOffset&&pbf.byteLength===pbf.buffer.byteLength||(pbf=new Uint8Array(pbf)),{vectorTile:geojsonWrapper,rawData:pbf.buffer}}))}loadData(params){var _a;return performance.__awaiter(this,void 0,void 0,(function*(){null===(_a=this._pendingRequest)||void 0===_a||_a.abort();const perf=!!(params&&params.request&&params.request.collectResourceTiming)&&new performance.RequestPerformance(params.request);this._pendingRequest=new AbortController;try{let data=yield this.loadGeoJSON(params,this._pendingRequest);if(delete this._pendingRequest,"object"!=typeof data)throw new Error(`Input data given to '${params.source}' is not a valid GeoJSON object.`);if(rewind$2(data,!0),params.filter){const compiled=performance.createExpression(params.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===compiled.result)throw new Error(compiled.value.map((err=>`${err.key}: ${err.message}`)).join(", "));const features=data.features.filter((feature=>compiled.value.evaluate({zoom:0},feature)));data={type:"FeatureCollection",features:features}}this._geoJSONIndex=params.cluster?new Supercluster(function({superclusterOptions:superclusterOptions,clusterProperties:clusterProperties}){if(!clusterProperties||!superclusterOptions)return superclusterOptions;const mapExpressions={},reduceExpressions={},globals={accumulated:null,zoom:0},feature={properties:null},propertyNames=Object.keys(clusterProperties);for(const key of propertyNames){const[operator,mapExpression]=clusterProperties[key],mapExpressionParsed=performance.createExpression(mapExpression),reduceExpressionParsed=performance.createExpression("string"==typeof operator?[operator,["accumulated"],["get",key]]:operator);mapExpressions[key]=mapExpressionParsed.value,reduceExpressions[key]=reduceExpressionParsed.value}return superclusterOptions.map=pointProperties=>{feature.properties=pointProperties;const properties={};for(const key of propertyNames)properties[key]=mapExpressions[key].evaluate(globals,feature);return properties},superclusterOptions.reduce=(accumulated,clusterProperties)=>{feature.properties=clusterProperties;for(const key of propertyNames)globals.accumulated=accumulated[key],accumulated[key]=reduceExpressions[key].evaluate(globals,feature)},superclusterOptions}(params)).load(data.features):function(data,options){return new GeoJSONVT(data,options)}(data,params.geojsonVtOptions),this.loaded={};const result={};if(perf){const resourceTimingData=perf.finish();resourceTimingData&&(result.resourceTiming={},result.resourceTiming[params.source]=JSON.parse(JSON.stringify(resourceTimingData)))}return result}catch(err){if(delete this._pendingRequest,performance.isAbortError(err))return{abandoned:!0};throw err}}))}reloadTile(params){const loaded=this.loaded,uid=params.uid;return loaded&&loaded[uid]?super.reloadTile(params):this.loadTile(params)}loadGeoJSON(params,abortController){return performance.__awaiter(this,void 0,void 0,(function*(){const{promoteId:promoteId}=params;if(params.request){const response=yield performance.getJSON(params.request,abortController);return this._dataUpdateable=isUpdateableGeoJSON(response.data,promoteId)?toUpdateable(response.data,promoteId):void 0,response.data}if("string"==typeof params.data)try{const parsed=JSON.parse(params.data);return this._dataUpdateable=isUpdateableGeoJSON(parsed,promoteId)?toUpdateable(parsed,promoteId):void 0,parsed}catch(e){throw new Error(`Input data given to '${params.source}' is not a valid GeoJSON object.`)}if(!params.dataDiff)throw new Error(`Input data given to '${params.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${params.source}`);return function(updateable,diff,promoteId){var _a,_b,_c,_d;if(diff.removeAll&&updateable.clear(),diff.remove)for(const id of diff.remove)updateable.delete(id);if(diff.add)for(const feature of diff.add){const id=getFeatureId(feature,promoteId);null!=id&&updateable.set(id,feature)}if(diff.update)for(const update of diff.update){let feature=updateable.get(update.id);if(null==feature)continue;const cloneFeature=update.newGeometry||update.removeAllProperties,cloneProperties=!update.removeAllProperties&&((null===(_a=update.removeProperties)||void 0===_a?void 0:_a.length)>0||(null===(_b=update.addOrUpdateProperties)||void 0===_b?void 0:_b.length)>0);if((cloneFeature||cloneProperties)&&(feature=Object.assign({},feature),updateable.set(update.id,feature),cloneProperties&&(feature.properties=Object.assign({},feature.properties))),update.newGeometry&&(feature.geometry=update.newGeometry),update.removeAllProperties)feature.properties={};else if((null===(_c=update.removeProperties)||void 0===_c?void 0:_c.length)>0)for(const prop of update.removeProperties)Object.prototype.hasOwnProperty.call(feature.properties,prop)&&delete feature.properties[prop];if((null===(_d=update.addOrUpdateProperties)||void 0===_d?void 0:_d.length)>0)for(const{key:key,value:value}of update.addOrUpdateProperties)feature.properties[key]=value}}(this._dataUpdateable,params.dataDiff,promoteId),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}}))}removeSource(_params){return performance.__awaiter(this,void 0,void 0,(function*(){this._pendingRequest&&this._pendingRequest.abort()}))}getClusterExpansionZoom(params){return this._geoJSONIndex.getClusterExpansionZoom(params.clusterId)}getClusterChildren(params){return this._geoJSONIndex.getChildren(params.clusterId)}getClusterLeaves(params){return this._geoJSONIndex.getLeaves(params.clusterId,params.limit,params.offset)}}class Worker{constructor(self){this.self=self,this.actor=new performance.Actor(self),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(name,WorkerSource)=>{if(this.externalWorkerSourceTypes[name])throw new Error(`Worker source with name "${name}" already registered.`);this.externalWorkerSourceTypes[name]=WorkerSource},this.self.addProtocol=performance.addProtocol,this.self.removeProtocol=performance.removeProtocol,this.self.registerRTLTextPlugin=rtlTextPlugin=>{if(performance.rtlWorkerPlugin.isParsed())throw new Error("RTL text plugin already registered.");performance.rtlWorkerPlugin.setMethods(rtlTextPlugin)},this.actor.registerMessageHandler("loadDEMTile",((mapId,params)=>this._getDEMWorkerSource(mapId,params.source).loadTile(params))),this.actor.registerMessageHandler("removeDEMTile",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this._getDEMWorkerSource(mapId,params.source).removeTile(params)})))),this.actor.registerMessageHandler("getClusterExpansionZoom",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){return this._getWorkerSource(mapId,params.type,params.source).getClusterExpansionZoom(params)})))),this.actor.registerMessageHandler("getClusterChildren",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){return this._getWorkerSource(mapId,params.type,params.source).getClusterChildren(params)})))),this.actor.registerMessageHandler("getClusterLeaves",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){return this._getWorkerSource(mapId,params.type,params.source).getClusterLeaves(params)})))),this.actor.registerMessageHandler("loadData",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).loadData(params))),this.actor.registerMessageHandler("loadTile",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).loadTile(params))),this.actor.registerMessageHandler("reloadTile",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).reloadTile(params))),this.actor.registerMessageHandler("abortTile",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).abortTile(params))),this.actor.registerMessageHandler("removeTile",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).removeTile(params))),this.actor.registerMessageHandler("removeSource",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){if(!this.workerSources[mapId]||!this.workerSources[mapId][params.type]||!this.workerSources[mapId][params.type][params.source])return;const worker=this.workerSources[mapId][params.type][params.source];delete this.workerSources[mapId][params.type][params.source],void 0!==worker.removeSource&&worker.removeSource(params)})))),this.actor.registerMessageHandler("setReferrer",((_mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this.referrer=params})))),this.actor.registerMessageHandler("syncRTLPluginState",((mapId,params)=>this._syncRTLPluginState(mapId,params))),this.actor.registerMessageHandler("importScript",((_mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this.self.importScripts(params)})))),this.actor.registerMessageHandler("setImages",((mapId,params)=>this._setImages(mapId,params))),this.actor.registerMessageHandler("updateLayers",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this._getLayerIndex(mapId).update(params.layers,params.removedIds)})))),this.actor.registerMessageHandler("setLayers",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this._getLayerIndex(mapId).replace(params)}))))}_setImages(mapId,images){return performance.__awaiter(this,void 0,void 0,(function*(){this.availableImages[mapId]=images;for(const workerSource in this.workerSources[mapId]){const ws=this.workerSources[mapId][workerSource];for(const source in ws)ws[source].availableImages=images}}))}_syncRTLPluginState(map,state){return performance.__awaiter(this,void 0,void 0,(function*(){performance.rtlWorkerPlugin.setState(state);const pluginURL=performance.rtlWorkerPlugin.getPluginURL();if("loaded"===state.pluginStatus&&!performance.rtlWorkerPlugin.isParsed()&&null!=pluginURL){this.self.importScripts(pluginURL);const complete=performance.rtlWorkerPlugin.isParsed();if(complete)return complete;throw new Error(`RTL Text Plugin failed to import scripts from ${pluginURL}`)}return!1}))}_getAvailableImages(mapId){let availableImages=this.availableImages[mapId];return availableImages||(availableImages=[]),availableImages}_getLayerIndex(mapId){let layerIndexes=this.layerIndexes[mapId];return layerIndexes||(layerIndexes=this.layerIndexes[mapId]=new StyleLayerIndex),layerIndexes}_getWorkerSource(mapId,sourceType,sourceName){if(this.workerSources[mapId]||(this.workerSources[mapId]={}),this.workerSources[mapId][sourceType]||(this.workerSources[mapId][sourceType]={}),!this.workerSources[mapId][sourceType][sourceName]){const actor={sendAsync:(message,abortController)=>(message.targetMapId=mapId,this.actor.sendAsync(message,abortController))};switch(sourceType){case"vector":this.workerSources[mapId][sourceType][sourceName]=new VectorTileWorkerSource(actor,this._getLayerIndex(mapId),this._getAvailableImages(mapId));break;case"geojson":this.workerSources[mapId][sourceType][sourceName]=new GeoJSONWorkerSource(actor,this._getLayerIndex(mapId),this._getAvailableImages(mapId));break;default:this.workerSources[mapId][sourceType][sourceName]=new this.externalWorkerSourceTypes[sourceType](actor,this._getLayerIndex(mapId),this._getAvailableImages(mapId))}}return this.workerSources[mapId][sourceType][sourceName]}_getDEMWorkerSource(mapId,sourceType){return this.demWorkerSources[mapId]||(this.demWorkerSources[mapId]={}),this.demWorkerSources[mapId][sourceType]||(this.demWorkerSources[mapId][sourceType]=new RasterDEMTileWorkerSource),this.demWorkerSources[mapId][sourceType]}}return performance.isWorker(self)&&(self.worker=new Worker(self)),Worker})),define("index",0,(function(exports,performance$1){var packageJSON_version="4.0.2";let linkEl,reducedMotionQuery;const browser={now:"undefined"!=typeof performance&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frameAsync:abortController=>new Promise(((resolve,reject)=>{const frame=requestAnimationFrame(resolve);abortController.signal.addEventListener("abort",(()=>{cancelAnimationFrame(frame),reject(performance$1.createAbortError())}))})),getImageData(img,padding=0){return this.getImageCanvasContext(img).getImageData(-padding,-padding,img.width+2*padding,img.height+2*padding)},getImageCanvasContext(img){const canvas=window.document.createElement("canvas"),context=canvas.getContext("2d",{willReadFrequently:!0});if(!context)throw new Error("failed to create canvas 2d context");return canvas.width=img.width,canvas.height=img.height,context.drawImage(img,0,0,img.width,img.height),context},resolveURL:path=>(linkEl||(linkEl=document.createElement("a")),linkEl.href=path,linkEl.href),hardwareConcurrency:"undefined"!=typeof navigator&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(null==reducedMotionQuery&&(reducedMotionQuery=matchMedia("(prefers-reduced-motion: reduce)")),reducedMotionQuery.matches)}};class DOM{static testProp(props){if(!DOM.docStyle)return props[0];for(let i=0;i<props.length;i++)if(props[i]in DOM.docStyle)return props[i];return props[0]}static create(tagName,className,container){const el=window.document.createElement(tagName);return void 0!==className&&(el.className=className),container&&container.appendChild(el),el}static createNS(namespaceURI,tagName){return window.document.createElementNS(namespaceURI,tagName)}static disableDrag(){DOM.docStyle&&DOM.selectProp&&(DOM.userSelect=DOM.docStyle[DOM.selectProp],DOM.docStyle[DOM.selectProp]="none")}static enableDrag(){DOM.docStyle&&DOM.selectProp&&(DOM.docStyle[DOM.selectProp]=DOM.userSelect)}static setTransform(el,value){el.style[DOM.transformProp]=value}static addEventListener(target,type,callback,options={}){"passive"in options?target.addEventListener(type,callback,options):target.addEventListener(type,callback,options.capture)}static removeEventListener(target,type,callback,options={}){"passive"in options?target.removeEventListener(type,callback,options):target.removeEventListener(type,callback,options.capture)}static suppressClickInternal(e){e.preventDefault(),e.stopPropagation(),window.removeEventListener("click",DOM.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",DOM.suppressClickInternal,!0),window.setTimeout((()=>{window.removeEventListener("click",DOM.suppressClickInternal,!0)}),0)}static getScale(element){const rect=element.getBoundingClientRect();return{x:rect.width/element.offsetWidth||1,y:rect.height/element.offsetHeight||1,boundingClientRect:rect}}static getPoint(el,scale,e){const rect=scale.boundingClientRect;return new performance$1.Point((e.clientX-rect.left)/scale.x-el.clientLeft,(e.clientY-rect.top)/scale.y-el.clientTop)}static mousePos(el,e){const scale=DOM.getScale(el);return DOM.getPoint(el,scale,e)}static touchPos(el,touches){const points=[],scale=DOM.getScale(el);for(let i=0;i<touches.length;i++)points.push(DOM.getPoint(el,scale,touches[i]));return points}static mouseButton(e){return e.button}static remove(node){node.parentNode&&node.parentNode.removeChild(node)}}DOM.docStyle="undefined"!=typeof window&&window.document&&window.document.documentElement.style,DOM.selectProp=DOM.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),DOM.transformProp=DOM.testProp(["transform","WebkitTransform"]);const webpSupported={supported:!1,testSupport:function(gl){if(webpCheckComplete||!webpImgTest)return;webpImgTestOnloadComplete?testWebpTextureUpload(gl):glForTesting=gl}};let glForTesting,webpImgTest,webpCheckComplete=!1,webpImgTestOnloadComplete=!1;function testWebpTextureUpload(gl){const texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);try{if(gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,webpImgTest),gl.isContextLost())return;webpSupported.supported=!0}catch(e){}gl.deleteTexture(texture),webpCheckComplete=!0}var ImageRequest,ResourceType;"undefined"!=typeof document&&(webpImgTest=document.createElement("img"),webpImgTest.onload=function(){glForTesting&&testWebpTextureUpload(glForTesting),glForTesting=null,webpImgTestOnloadComplete=!0},webpImgTest.onerror=function(){webpCheckComplete=!0,glForTesting=null},webpImgTest.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(ImageRequest){let imageRequestQueue,currentParallelImageRequests,throttleControlCallbackHandleCounter,throttleControlCallbacks;ImageRequest.resetRequestQueue=()=>{imageRequestQueue=[],currentParallelImageRequests=0,throttleControlCallbackHandleCounter=0,throttleControlCallbacks={}},ImageRequest.addThrottleControl=callback=>{const handle=throttleControlCallbackHandleCounter++;return throttleControlCallbacks[handle]=callback,handle},ImageRequest.removeThrottleControl=callbackHandle=>{delete throttleControlCallbacks[callbackHandle],processQueue()};ImageRequest.getImage=(requestParameters,abortController,supportImageRefresh=!0)=>new Promise(((resolve,reject)=>{webpSupported.supported&&(requestParameters.headers||(requestParameters.headers={}),requestParameters.headers.accept="image/webp,*/*"),performance$1.extend(requestParameters,{type:"image"});const request={abortController:abortController,requestParameters:requestParameters,supportImageRefresh:supportImageRefresh,state:"queued",onError:error=>{reject(error)},onSuccess:response=>{resolve(response)}};imageRequestQueue.push(request),processQueue()}));const doImageRequest=itemInQueue=>performance$1.__awaiter(this,void 0,void 0,(function*(){itemInQueue.state="running";const{requestParameters:requestParameters,supportImageRefresh:supportImageRefresh,onError:onError,onSuccess:onSuccess,abortController:abortController}=itemInQueue,canUseHTMLImageElement=!1===supportImageRefresh&&!performance$1.isWorker(self)&&!performance$1.getProtocol(requestParameters.url)&&(!requestParameters.headers||Object.keys(requestParameters.headers).reduce(((acc,item)=>acc&&"accept"===item),!0));currentParallelImageRequests++;const getImagePromise=canUseHTMLImageElement?getImageUsingHtmlImage(requestParameters,abortController):performance$1.makeRequest(requestParameters,abortController);try{const response=yield getImagePromise;if(delete itemInQueue.abortController,itemInQueue.state="completed",response.data instanceof HTMLImageElement||performance$1.isImageBitmap(response.data))onSuccess(response);else if(response.data){onSuccess({data:yield(data=response.data,"function"==typeof createImageBitmap?performance$1.arrayBufferToImageBitmap(data):performance$1.arrayBufferToImage(data)),cacheControl:response.cacheControl,expires:response.expires})}}catch(err){delete itemInQueue.abortController,onError(err)}finally{currentParallelImageRequests--,processQueue()}var data})),processQueue=()=>{const maxImageRequests=(()=>{for(const key of Object.keys(throttleControlCallbacks))if(throttleControlCallbacks[key]())return!0;return!1})()?performance$1.config.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:performance$1.config.MAX_PARALLEL_IMAGE_REQUESTS;for(let numImageRequests=currentParallelImageRequests;numImageRequests<maxImageRequests&&imageRequestQueue.length>0;numImageRequests++){const topItemInQueue=imageRequestQueue.shift();topItemInQueue.abortController.signal.aborted?numImageRequests--:doImageRequest(topItemInQueue)}},getImageUsingHtmlImage=(requestParameters,abortController)=>new Promise(((resolve,reject)=>{const image=new Image,url=requestParameters.url,credentials=requestParameters.credentials;credentials&&"include"===credentials?image.crossOrigin="use-credentials":(credentials&&"same-origin"===credentials||!performance$1.sameOrigin(url))&&(image.crossOrigin="anonymous"),abortController.signal.addEventListener("abort",(()=>{image.src="",reject(performance$1.createAbortError())})),image.fetchPriority="high",image.onload=()=>{image.onerror=image.onload=null,resolve({data:image})},image.onerror=()=>{image.onerror=image.onload=null,abortController.signal.aborted||reject(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},image.src=url}))}(ImageRequest||(ImageRequest={})),ImageRequest.resetRequestQueue(),function(ResourceType){ResourceType.Glyphs="Glyphs",ResourceType.Image="Image",ResourceType.Source="Source",ResourceType.SpriteImage="SpriteImage",ResourceType.SpriteJSON="SpriteJSON",ResourceType.Style="Style",ResourceType.Tile="Tile",ResourceType.Unknown="Unknown"}(ResourceType||(ResourceType={}));class RequestManager{constructor(transformRequestFn){this._transformRequestFn=transformRequestFn}transformRequest(url,type){return this._transformRequestFn&&this._transformRequestFn(url,type)||{url:url}}normalizeSpriteURL(url,format,extension){const urlObject=function(url){const parts=url.match(urlRe);if(!parts)throw new Error(`Unable to parse URL "${url}"`);return{protocol:parts[1],authority:parts[2],path:parts[3]||"/",params:parts[4]?parts[4].split("&"):[]}}(url);return urlObject.path+=`${format}${extension}`,function(obj){const params=obj.params.length?`?${obj.params.join("&")}`:"";return`${obj.protocol}://${obj.authority}${obj.path}${params}`}(urlObject)}setTransformRequest(transformRequest){this._transformRequestFn=transformRequest}}const urlRe=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function coerceSpriteToArray(sprite){const resultArray=[];if("string"==typeof sprite)resultArray.push({id:"default",url:sprite});else if(sprite&&sprite.length>0){const dedupArray=[];for(const{id:id,url:url}of sprite){const key=`${id}${url}`;-1===dedupArray.indexOf(key)&&(dedupArray.push(key),resultArray.push({id:id,url:url}))}}return resultArray}function loadSprite(originalSprite,requestManager,pixelRatio,abortController){return performance$1.__awaiter(this,void 0,void 0,(function*(){const spriteArray=coerceSpriteToArray(originalSprite),format=pixelRatio>1?"@2x":"",jsonsMap={},imagesMap={};for(const{id:id,url:url}of spriteArray){const jsonRequestParameters=requestManager.transformRequest(requestManager.normalizeSpriteURL(url,format,".json"),ResourceType.SpriteJSON);jsonsMap[id]=performance$1.getJSON(jsonRequestParameters,abortController);const imageRequestParameters=requestManager.transformRequest(requestManager.normalizeSpriteURL(url,format,".png"),ResourceType.SpriteImage);imagesMap[id]=ImageRequest.getImage(imageRequestParameters,abortController)}return yield Promise.all([...Object.values(jsonsMap),...Object.values(imagesMap)]),function(jsonsMap,imagesMap){return performance$1.__awaiter(this,void 0,void 0,(function*(){const result={};for(const spriteName in jsonsMap){result[spriteName]={};const context=browser.getImageCanvasContext((yield imagesMap[spriteName]).data),json=(yield jsonsMap[spriteName]).data;for(const id in json){const{width:width,height:height,x:x,y:y,sdf:sdf,pixelRatio:pixelRatio,stretchX:stretchX,stretchY:stretchY,content:content}=json[id],spriteData={width:width,height:height,x:x,y:y,context:context};result[spriteName][id]={data:null,pixelRatio:pixelRatio,sdf:sdf,stretchX:stretchX,stretchY:stretchY,content:content,spriteData:spriteData}}}return result}))}(jsonsMap,imagesMap)}))}class Texture{constructor(context,image,format,options){this.context=context,this.format=format,this.texture=context.gl.createTexture(),this.update(image,options)}update(image,options,position){const{width:width,height:height}=image,resize=!(this.size&&this.size[0]===width&&this.size[1]===height||position),{context:context}=this,{gl:gl}=context;if(this.useMipmap=Boolean(options&&options.useMipmap),gl.bindTexture(gl.TEXTURE_2D,this.texture),context.pixelStoreUnpackFlipY.set(!1),context.pixelStoreUnpack.set(1),context.pixelStoreUnpackPremultiplyAlpha.set(this.format===gl.RGBA&&(!options||!1!==options.premultiply)),resize)this.size=[width,height],image instanceof HTMLImageElement||image instanceof HTMLCanvasElement||image instanceof HTMLVideoElement||image instanceof ImageData||performance$1.isImageBitmap(image)?gl.texImage2D(gl.TEXTURE_2D,0,this.format,this.format,gl.UNSIGNED_BYTE,image):gl.texImage2D(gl.TEXTURE_2D,0,this.format,width,height,0,this.format,gl.UNSIGNED_BYTE,image.data);else{const{x:x,y:y}=position||{x:0,y:0};image instanceof HTMLImageElement||image instanceof HTMLCanvasElement||image instanceof HTMLVideoElement||image instanceof ImageData||performance$1.isImageBitmap(image)?gl.texSubImage2D(gl.TEXTURE_2D,0,x,y,gl.RGBA,gl.UNSIGNED_BYTE,image):gl.texSubImage2D(gl.TEXTURE_2D,0,x,y,width,height,gl.RGBA,gl.UNSIGNED_BYTE,image.data)}this.useMipmap&&this.isSizePowerOfTwo()&&gl.generateMipmap(gl.TEXTURE_2D)}bind(filter,wrap,minFilter){const{context:context}=this,{gl:gl}=context;gl.bindTexture(gl.TEXTURE_2D,this.texture),minFilter!==gl.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(minFilter=gl.LINEAR),filter!==this.filter&&(gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,filter),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,minFilter||filter),this.filter=filter),wrap!==this.wrap&&(gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,wrap),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,wrap),this.wrap=wrap)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:gl}=this.context;gl.deleteTexture(this.texture),this.texture=null}}function renderStyleImage(image){const{userImage:userImage}=image;if(userImage&&userImage.render){if(userImage.render())return image.data.replace(new Uint8Array(userImage.data.buffer)),!0}return!1}class ImageManager extends performance$1.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new performance$1.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(loaded){if(this.loaded!==loaded&&(this.loaded=loaded,loaded)){for(const{ids:ids,promiseResolve:promiseResolve}of this.requestors)promiseResolve(this._getImagesForIds(ids));this.requestors=[]}}getImage(id){const image=this.images[id];if(image&&!image.data&&image.spriteData){const spriteData=image.spriteData;image.data=new performance$1.RGBAImage({width:spriteData.width,height:spriteData.height},spriteData.context.getImageData(spriteData.x,spriteData.y,spriteData.width,spriteData.height).data),image.spriteData=null}return image}addImage(id,image){if(this.images[id])throw new Error(`Image id ${id} already exist, use updateImage instead`);this._validate(id,image)&&(this.images[id]=image)}_validate(id,image){let valid=!0;const data=image.data||image.spriteData;return this._validateStretch(image.stretchX,data&&data.width)||(this.fire(new performance$1.ErrorEvent(new Error(`Image "${id}" has invalid "stretchX" value`))),valid=!1),this._validateStretch(image.stretchY,data&&data.height)||(this.fire(new performance$1.ErrorEvent(new Error(`Image "${id}" has invalid "stretchY" value`))),valid=!1),this._validateContent(image.content,image)||(this.fire(new performance$1.ErrorEvent(new Error(`Image "${id}" has invalid "content" value`))),valid=!1),valid}_validateStretch(stretch,size){if(!stretch)return!0;let last=0;for(const part of stretch){if(part[0]<last||part[1]<part[0]||size<part[1])return!1;last=part[1]}return!0}_validateContent(content,image){if(!content)return!0;if(4!==content.length)return!1;const spriteData=image.spriteData,width=spriteData&&spriteData.width||image.data.width,height=spriteData&&spriteData.height||image.data.height;return!(content[0]<0||width<content[0])&&(!(content[1]<0||height<content[1])&&(!(content[2]<0||width<content[2])&&(!(content[3]<0||height<content[3])&&(!(content[2]<content[0])&&!(content[3]<content[1])))))}updateImage(id,image,validate=!0){const oldImage=this.getImage(id);if(validate&&(oldImage.data.width!==image.data.width||oldImage.data.height!==image.data.height))throw new Error(`size mismatch between old image (${oldImage.data.width}x${oldImage.data.height}) and new image (${image.data.width}x${image.data.height}).`);image.version=oldImage.version+1,this.images[id]=image,this.updatedImages[id]=!0}removeImage(id){const image=this.images[id];delete this.images[id],delete this.patterns[id],image.userImage&&image.userImage.onRemove&&image.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(ids){return new Promise(((resolve,_reject)=>{let hasAllDependencies=!0;if(!this.isLoaded())for(const id of ids)this.images[id]||(hasAllDependencies=!1);this.isLoaded()||hasAllDependencies?resolve(this._getImagesForIds(ids)):this.requestors.push({ids:ids,promiseResolve:resolve})}))}_getImagesForIds(ids){const response={};for(const id of ids){let image=this.getImage(id);image||(this.fire(new performance$1.Event("styleimagemissing",{id:id})),image=this.getImage(id)),image?response[id]={data:image.data.clone(),pixelRatio:image.pixelRatio,sdf:image.sdf,version:image.version,stretchX:image.stretchX,stretchY:image.stretchY,content:image.content,hasRenderCallback:Boolean(image.userImage&&image.userImage.render)}:performance$1.warnOnce(`Image "${id}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return response}getPixelSize(){const{width:width,height:height}=this.atlasImage;return{width:width,height:height}}getPattern(id){const pattern=this.patterns[id],image=this.getImage(id);if(!image)return null;if(pattern&&pattern.position.version===image.version)return pattern.position;if(pattern)pattern.position.version=image.version;else{const bin={w:image.data.width+2,h:image.data.height+2,x:0,y:0},position=new performance$1.ImagePosition(bin,image);this.patterns[id]={bin:bin,position:position}}return this._updatePatternAtlas(),this.patterns[id].position}bind(context){const gl=context.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new Texture(context,this.atlasImage,gl.RGBA),this.atlasTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE)}_updatePatternAtlas(){const bins=[];for(const id in this.patterns)bins.push(this.patterns[id].bin);const{w:w,h:h}=performance$1.potpack(bins),dst=this.atlasImage;dst.resize({width:w||1,height:h||1});for(const id in this.patterns){const{bin:bin}=this.patterns[id],x=bin.x+1,y=bin.y+1,src=this.getImage(id).data,w=src.width,h=src.height;performance$1.RGBAImage.copy(src,dst,{x:0,y:0},{x:x,y:y},{width:w,height:h}),performance$1.RGBAImage.copy(src,dst,{x:0,y:h-1},{x:x,y:y-1},{width:w,height:1}),performance$1.RGBAImage.copy(src,dst,{x:0,y:0},{x:x,y:y+h},{width:w,height:1}),performance$1.RGBAImage.copy(src,dst,{x:w-1,y:0},{x:x-1,y:y},{width:1,height:h}),performance$1.RGBAImage.copy(src,dst,{x:0,y:0},{x:x+w,y:y},{width:1,height:h})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(ids){for(const id of ids){if(this.callbackDispatchedThisFrame[id])continue;this.callbackDispatchedThisFrame[id]=!0;const image=this.getImage(id);image||performance$1.warnOnce(`Image with ID: "${id}" was not found`);renderStyleImage(image)&&this.updateImage(id,image)}}}const INF=1e20;function edt(data,x0,y0,width,height,gridSize,f,v,z){for(let x=x0;x<x0+width;x++)edt1d(data,y0*gridSize+x,gridSize,height,f,v,z);for(let y=y0;y<y0+height;y++)edt1d(data,y*gridSize+x0,1,width,f,v,z)}function edt1d(grid,offset,stride,length,f,v,z){v[0]=0,z[0]=-INF,z[1]=INF,f[0]=grid[offset];for(let q=1,k=0,s=0;q<length;q++){f[q]=grid[offset+q*stride];const q2=q*q;do{const r=v[k];s=(f[q]-f[r]+q2-r*r)/(q-r)/2}while(s<=z[k]&&--k>-1);k++,v[k]=q,z[k]=s,z[k+1]=INF}for(let q=0,k=0;q<length;q++){for(;z[k+1]<q;)k++;const r=v[k],qr=q-r;grid[offset+q*stride]=f[r]+qr*qr}}class GlyphManager{constructor(requestManager,localIdeographFontFamily){this.requestManager=requestManager,this.localIdeographFontFamily=localIdeographFontFamily,this.entries={}}setURL(url){this.url=url}getGlyphs(glyphs){return performance$1.__awaiter(this,void 0,void 0,(function*(){const glyphsPromises=[];for(const stack in glyphs)for(const id of glyphs[stack])glyphsPromises.push(this._getAndCacheGlyphsPromise(stack,id));const updatedGlyphs=yield Promise.all(glyphsPromises),result={};for(const{stack:stack,id:id,glyph:glyph}of updatedGlyphs)result[stack]||(result[stack]={}),result[stack][id]=glyph&&{id:glyph.id,bitmap:glyph.bitmap.clone(),metrics:glyph.metrics};return result}))}_getAndCacheGlyphsPromise(stack,id){return performance$1.__awaiter(this,void 0,void 0,(function*(){let entry=this.entries[stack];entry||(entry=this.entries[stack]={glyphs:{},requests:{},ranges:{}});let glyph=entry.glyphs[id];if(void 0!==glyph)return{stack:stack,id:id,glyph:glyph};if(glyph=this._tinySDF(entry,stack,id),glyph)return entry.glyphs[id]=glyph,{stack:stack,id:id,glyph:glyph};const range=Math.floor(id/256);if(256*range>65535)throw new Error("glyphs > 65535 not supported");if(entry.ranges[range])return{stack:stack,id:id,glyph:glyph};if(!this.url)throw new Error("glyphsUrl is not set");if(!entry.requests[range]){const promise=GlyphManager.loadGlyphRange(stack,range,this.url,this.requestManager);entry.requests[range]=promise}const response=yield entry.requests[range];for(const id in response)this._doesCharSupportLocalGlyph(+id)||(entry.glyphs[+id]=response[+id]);return entry.ranges[range]=!0,{stack:stack,id:id,glyph:response[id]||null}}))}_doesCharSupportLocalGlyph(id){return!!this.localIdeographFontFamily&&(performance$1.unicodeBlockLookup["CJK Unified Ideographs"](id)||performance$1.unicodeBlockLookup["Hangul Syllables"](id)||performance$1.unicodeBlockLookup.Hiragana(id)||performance$1.unicodeBlockLookup.Katakana(id))}_tinySDF(entry,stack,id){const fontFamily=this.localIdeographFontFamily;if(!fontFamily)return;if(!this._doesCharSupportLocalGlyph(id))return;let tinySDF=entry.tinySDF;if(!tinySDF){let fontWeight="400";/bold/i.test(stack)?fontWeight="900":/medium/i.test(stack)?fontWeight="500":/light/i.test(stack)&&(fontWeight="200"),tinySDF=entry.tinySDF=new GlyphManager.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:fontFamily,fontWeight:fontWeight})}const char=tinySDF.draw(String.fromCharCode(id));return{id:id,bitmap:new performance$1.AlphaImage({width:char.width||60,height:char.height||60},char.data),metrics:{width:char.glyphWidth/2||24,height:char.glyphHeight/2||24,left:char.glyphLeft/2+.5||0,top:char.glyphTop/2-27.5||-8,advance:char.glyphAdvance/2||24,isDoubleResolution:!0}}}}GlyphManager.loadGlyphRange=function(fontstack,range,urlTemplate,requestManager){return performance$1.__awaiter(this,void 0,void 0,(function*(){const begin=256*range,end=begin+255,request=requestManager.transformRequest(urlTemplate.replace("{fontstack}",fontstack).replace("{range}",`${begin}-${end}`),ResourceType.Glyphs),response=yield performance$1.getArrayBuffer(request,new AbortController);if(!response||!response.data)throw new Error(`Could not load glyph range. range: ${range}, ${begin}-${end}`);const glyphs={};for(const glyph of performance$1.parseGlyphPbf(response.data))glyphs[glyph.id]=glyph;return glyphs}))},GlyphManager.TinySDF=class{constructor({fontSize:fontSize=24,buffer:buffer=3,radius:radius=8,cutoff:cutoff=.25,fontFamily:fontFamily="sans-serif",fontWeight:fontWeight="normal",fontStyle:fontStyle="normal"}={}){this.buffer=buffer,this.cutoff=cutoff,this.radius=radius;const size=this.size=fontSize+4*buffer,canvas=this._createCanvas(size),ctx=this.ctx=canvas.getContext("2d",{willReadFrequently:!0});ctx.font=`${fontStyle} ${fontWeight} ${fontSize}px ${fontFamily}`,ctx.textBaseline="alphabetic",ctx.textAlign="left",ctx.fillStyle="black",this.gridOuter=new Float64Array(size*size),this.gridInner=new Float64Array(size*size),this.f=new Float64Array(size),this.z=new Float64Array(size+1),this.v=new Uint16Array(size)}_createCanvas(size){const canvas=document.createElement("canvas");return canvas.width=canvas.height=size,canvas}draw(char){const{width:glyphAdvance,actualBoundingBoxAscent:actualBoundingBoxAscent,actualBoundingBoxDescent:actualBoundingBoxDescent,actualBoundingBoxLeft:actualBoundingBoxLeft,actualBoundingBoxRight:actualBoundingBoxRight}=this.ctx.measureText(char),glyphTop=Math.ceil(actualBoundingBoxAscent),glyphWidth=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(actualBoundingBoxRight-actualBoundingBoxLeft))),glyphHeight=Math.min(this.size-this.buffer,glyphTop+Math.ceil(actualBoundingBoxDescent)),width=glyphWidth+2*this.buffer,height=glyphHeight+2*this.buffer,len=Math.max(width*height,0),data=new Uint8ClampedArray(len),glyph={data:data,width:width,height:height,glyphWidth:glyphWidth,glyphHeight:glyphHeight,glyphTop:glyphTop,glyphLeft:0,glyphAdvance:glyphAdvance};if(0===glyphWidth||0===glyphHeight)return glyph;const{ctx:ctx,buffer:buffer,gridInner:gridInner,gridOuter:gridOuter}=this;ctx.clearRect(buffer,buffer,glyphWidth,glyphHeight),ctx.fillText(char,buffer,buffer+glyphTop);const imgData=ctx.getImageData(buffer,buffer,glyphWidth,glyphHeight);gridOuter.fill(INF,0,len),gridInner.fill(0,0,len);for(let y=0;y<glyphHeight;y++)for(let x=0;x<glyphWidth;x++){const a=imgData.data[4*(y*glyphWidth+x)+3]/255;if(0===a)continue;const j=(y+buffer)*width+x+buffer;if(1===a)gridOuter[j]=0,gridInner[j]=INF;else{const d=.5-a;gridOuter[j]=d>0?d*d:0,gridInner[j]=d<0?d*d:0}}edt(gridOuter,0,0,width,height,width,this.f,this.v,this.z),edt(gridInner,buffer,buffer,glyphWidth,glyphHeight,width,this.f,this.v,this.z);for(let i=0;i<len;i++){const d=Math.sqrt(gridOuter[i])-Math.sqrt(gridInner[i]);data[i]=Math.round(255-255*(d/this.radius+this.cutoff))}return glyph}};class LightPositionProperty{constructor(){this.specification=performance$1.v8Spec.light.position}possiblyEvaluate(value,parameters){return performance$1.sphericalToCartesian(value.expression.evaluate(parameters))}interpolate(a,b,t){return{x:performance$1.interpolate.number(a.x,b.x,t),y:performance$1.interpolate.number(a.y,b.y,t),z:performance$1.interpolate.number(a.z,b.z,t)}}}let lightProperties;class Light extends performance$1.Evented{constructor(lightOptions){super(),lightProperties=lightProperties||new performance$1.Properties({anchor:new performance$1.DataConstantProperty(performance$1.v8Spec.light.anchor),position:new LightPositionProperty,color:new performance$1.DataConstantProperty(performance$1.v8Spec.light.color),intensity:new performance$1.DataConstantProperty(performance$1.v8Spec.light.intensity)}),this._transitionable=new performance$1.Transitionable(lightProperties),this.setLight(lightOptions),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(light,options={}){if(!this._validate(performance$1.validateLight,light,options))for(const name in light){const value=light[name];name.endsWith("-transition")?this._transitionable.setTransition(name.slice(0,-11),value):this._transitionable.setValue(name,value)}}updateTransitions(parameters){this._transitioning=this._transitionable.transitioned(parameters,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(parameters){this.properties=this._transitioning.possiblyEvaluate(parameters)}_validate(validate,value,options){return(!options||!1!==options.validate)&&performance$1.emitValidationErrors(this,validate.call(performance$1.validateStyle,{value:value,style:{glyphs:!0,sprite:!0},styleSpec:performance$1.v8Spec}))}}class LineAtlas{constructor(width,height){this.width=width,this.height=height,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(dasharray,round){const key=dasharray.join(",")+String(round);return this.dashEntry[key]||(this.dashEntry[key]=this.addDash(dasharray,round)),this.dashEntry[key]}getDashRanges(dasharray,lineAtlasWidth,stretch){const ranges=[];let left=dasharray.length%2==1?-dasharray[dasharray.length-1]*stretch:0,right=dasharray[0]*stretch,isDash=!0;ranges.push({left:left,right:right,isDash:isDash,zeroLength:0===dasharray[0]});let currentDashLength=dasharray[0];for(let i=1;i<dasharray.length;i++){isDash=!isDash;const dashLength=dasharray[i];left=currentDashLength*stretch,currentDashLength+=dashLength,right=currentDashLength*stretch,ranges.push({left:left,right:right,isDash:isDash,zeroLength:0===dashLength})}return ranges}addRoundDash(ranges,stretch,n){const halfStretch=stretch/2;for(let y=-n;y<=n;y++){const row=this.nextRow+n+y,index=this.width*row;let currIndex=0,range=ranges[currIndex];for(let x=0;x<this.width;x++){x/range.right>1&&(range=ranges[++currIndex]);const distLeft=Math.abs(x-range.left),distRight=Math.abs(x-range.right),minDist=Math.min(distLeft,distRight);let signedDistance;const distMiddle=y/n*(halfStretch+1);if(range.isDash){const distEdge=halfStretch-Math.abs(distMiddle);signedDistance=Math.sqrt(minDist*minDist+distEdge*distEdge)}else signedDistance=halfStretch-Math.sqrt(minDist*minDist+distMiddle*distMiddle);this.data[index+x]=Math.max(0,Math.min(255,signedDistance+128))}}}addRegularDash(ranges){for(let i=ranges.length-1;i>=0;--i){const part=ranges[i],next=ranges[i+1];part.zeroLength?ranges.splice(i,1):next&&next.isDash===part.isDash&&(next.left=part.left,ranges.splice(i,1))}const first=ranges[0],last=ranges[ranges.length-1];first.isDash===last.isDash&&(first.left=last.left-this.width,last.right=first.right+this.width);const index=this.width*this.nextRow;let currIndex=0,range=ranges[currIndex];for(let x=0;x<this.width;x++){x/range.right>1&&(range=ranges[++currIndex]);const distLeft=Math.abs(x-range.left),distRight=Math.abs(x-range.right),minDist=Math.min(distLeft,distRight),signedDistance=range.isDash?minDist:-minDist;this.data[index+x]=Math.max(0,Math.min(255,signedDistance+128))}}addDash(dasharray,round){const n=round?7:0,height=2*n+1;if(this.nextRow+height>this.height)return performance$1.warnOnce("LineAtlas out of space"),null;let length=0;for(let i=0;i<dasharray.length;i++)length+=dasharray[i];if(0!==length){const stretch=this.width/length,ranges=this.getDashRanges(dasharray,this.width,stretch);round?this.addRoundDash(ranges,stretch,n):this.addRegularDash(ranges)}const dashEntry={y:(this.nextRow+n+.5)/this.height,height:2*n/this.height,width:length};return this.nextRow+=height,this.dirty=!0,dashEntry}bind(context){const gl=context.gl;this.texture?(gl.bindTexture(gl.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,this.width,this.height,gl.ALPHA,gl.UNSIGNED_BYTE,this.data))):(this.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,this.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.ALPHA,this.width,this.height,0,gl.ALPHA,gl.UNSIGNED_BYTE,this.data))}}const PRELOAD_POOL_ID="maplibre_preloaded_worker_pool";class WorkerPool{constructor(){this.active={}}acquire(mapId){if(!this.workers)for(this.workers=[];this.workers.length<WorkerPool.workerCount;)this.workers.push(new Worker(performance$1.config.WORKER_URL));return this.active[mapId]=!0,this.workers.slice()}release(mapId){delete this.active[mapId],0===this.numActive()&&(this.workers.forEach((w=>{w.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[PRELOAD_POOL_ID]}numActive(){return Object.keys(this.active).length}}const availableLogicalProcessors=Math.floor(browser.hardwareConcurrency/2);let globalWorkerPool,globalDispatcher;function getGlobalWorkerPool(){return globalWorkerPool||(globalWorkerPool=new WorkerPool),globalWorkerPool}WorkerPool.workerCount=performance$1.isSafari(globalThis)?Math.max(Math.min(availableLogicalProcessors,3),1):1;class Dispatcher{constructor(workerPool,mapId){this.workerPool=workerPool,this.actors=[],this.currentActor=0,this.id=mapId;const workers=this.workerPool.acquire(mapId);for(let i=0;i<workers.length;i++){const worker=workers[i],actor=new performance$1.Actor(worker,mapId);actor.name=`Worker ${i}`,this.actors.push(actor)}if(!this.actors.length)throw new Error("No actors found")}broadcast(type,data){const promises=[];for(const actor of this.actors)promises.push(actor.sendAsync({type:type,data:data}));return Promise.all(promises)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(mapRemoved=!0){this.actors.forEach((actor=>{actor.remove()})),this.actors=[],mapRemoved&&this.workerPool.release(this.id)}registerMessageHandler(type,handler){for(const actor of this.actors)actor.registerMessageHandler(type,handler)}}function getGlobalDispatcher(){return globalDispatcher||(globalDispatcher=new Dispatcher(getGlobalWorkerPool(),performance$1.GLOBAL_DISPATCHER_ID),globalDispatcher.registerMessageHandler("getResource",((_mapId,params,abortController)=>performance$1.makeRequest(params,abortController)))),globalDispatcher}function getPixelPosMatrix(transform,tileID){const t=performance$1.create();return performance$1.translate(t,t,[1,1,0]),performance$1.scale(t,t,[.5*transform.width,.5*transform.height,1]),performance$1.multiply(t,t,transform.calculatePosMatrix(tileID.toUnwrapped()))}function queryRenderedFeatures(sourceCache,styleLayers,serializedLayers,queryGeometry,params,transform){const has3DLayer=function(layers,styleLayers,sourceID){if(layers)for(const layerID of layers){const layer=styleLayers[layerID];if(layer&&layer.source===sourceID&&"fill-extrusion"===layer.type)return!0}else for(const key in styleLayers){const layer=styleLayers[key];if(layer.source===sourceID&&"fill-extrusion"===layer.type)return!0}return!1}(params&&params.layers,styleLayers,sourceCache.id),maxPitchScaleFactor=transform.maxPitchScaleFactor(),tilesIn=sourceCache.tilesIn(queryGeometry,maxPitchScaleFactor,has3DLayer);tilesIn.sort(sortTilesIn);const renderedFeatureLayers=[];for(const tileIn of tilesIn)renderedFeatureLayers.push({wrappedTileID:tileIn.tileID.wrapped().key,queryResults:tileIn.tile.queryRenderedFeatures(styleLayers,serializedLayers,sourceCache._state,tileIn.queryGeometry,tileIn.cameraQueryGeometry,tileIn.scale,params,transform,maxPitchScaleFactor,getPixelPosMatrix(sourceCache.transform,tileIn.tileID))});const result=function(tiles){const result={},wrappedIDLayerMap={};for(const tile of tiles){const queryResults=tile.queryResults,wrappedID=tile.wrappedTileID,wrappedIDLayers=wrappedIDLayerMap[wrappedID]=wrappedIDLayerMap[wrappedID]||{};for(const layerID in queryResults){const tileFeatures=queryResults[layerID],wrappedIDFeatures=wrappedIDLayers[layerID]=wrappedIDLayers[layerID]||{},resultFeatures=result[layerID]=result[layerID]||[];for(const tileFeature of tileFeatures)wrappedIDFeatures[tileFeature.featureIndex]||(wrappedIDFeatures[tileFeature.featureIndex]=!0,resultFeatures.push(tileFeature))}}return result}(renderedFeatureLayers);for(const layerID in result)result[layerID].forEach((featureWrapper=>{const feature=featureWrapper.feature,state=sourceCache.getFeatureState(feature.layer["source-layer"],feature.id);feature.source=feature.layer.source,feature.layer["source-layer"]&&(feature.sourceLayer=feature.layer["source-layer"]),feature.state=state}));return result}function sortTilesIn(a,b){const idA=a.tileID,idB=b.tileID;return idA.overscaledZ-idB.overscaledZ||idA.canonical.y-idB.canonical.y||idA.wrap-idB.wrap||idA.canonical.x-idB.canonical.x}function loadTileJson(options,requestManager,abortController){return performance$1.__awaiter(this,void 0,void 0,(function*(){let tileJSON=options;if(options.url){tileJSON=(yield performance$1.getJSON(requestManager.transformRequest(options.url,ResourceType.Source),abortController)).data}else yield browser.frameAsync(abortController);if(!tileJSON)return null;const result=performance$1.pick(performance$1.extend(tileJSON,options),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in tileJSON&&tileJSON.vector_layers&&(result.vectorLayerIds=tileJSON.vector_layers.map((layer=>layer.id))),result}))}class LngLatBounds{constructor(sw,ne){sw&&(ne?this.setSouthWest(sw).setNorthEast(ne):Array.isArray(sw)&&(4===sw.length?this.setSouthWest([sw[0],sw[1]]).setNorthEast([sw[2],sw[3]]):this.setSouthWest(sw[0]).setNorthEast(sw[1])))}setNorthEast(ne){return this._ne=ne instanceof performance$1.LngLat?new performance$1.LngLat(ne.lng,ne.lat):performance$1.LngLat.convert(ne),this}setSouthWest(sw){return this._sw=sw instanceof performance$1.LngLat?new performance$1.LngLat(sw.lng,sw.lat):performance$1.LngLat.convert(sw),this}extend(obj){const sw=this._sw,ne=this._ne;let sw2,ne2;if(obj instanceof performance$1.LngLat)sw2=obj,ne2=obj;else{if(!(obj instanceof LngLatBounds)){if(Array.isArray(obj)){if(4===obj.length||obj.every(Array.isArray)){const lngLatBoundsObj=obj;return this.extend(LngLatBounds.convert(lngLatBoundsObj))}{const lngLatObj=obj;return this.extend(performance$1.LngLat.convert(lngLatObj))}}return obj&&("lng"in obj||"lon"in obj)&&"lat"in obj?this.extend(performance$1.LngLat.convert(obj)):this}if(sw2=obj._sw,ne2=obj._ne,!sw2||!ne2)return this}return sw||ne?(sw.lng=Math.min(sw2.lng,sw.lng),sw.lat=Math.min(sw2.lat,sw.lat),ne.lng=Math.max(ne2.lng,ne.lng),ne.lat=Math.max(ne2.lat,ne.lat)):(this._sw=new performance$1.LngLat(sw2.lng,sw2.lat),this._ne=new performance$1.LngLat(ne2.lng,ne2.lat)),this}getCenter(){return new performance$1.LngLat((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new performance$1.LngLat(this.getWest(),this.getNorth())}getSouthEast(){return new performance$1.LngLat(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(lnglat){const{lng:lng,lat:lat}=performance$1.LngLat.convert(lnglat),containsLatitude=this._sw.lat<=lat&&lat<=this._ne.lat;let containsLongitude=this._sw.lng<=lng&&lng<=this._ne.lng;return this._sw.lng>this._ne.lng&&(containsLongitude=this._sw.lng>=lng&&lng>=this._ne.lng),containsLatitude&&containsLongitude}static convert(input){return input instanceof LngLatBounds?input:input?new LngLatBounds(input):input}static fromLngLat(center,radius=0){const latAccuracy=360*radius/40075017,lngAccuracy=latAccuracy/Math.cos(Math.PI/180*center.lat);return new LngLatBounds(new performance$1.LngLat(center.lng-lngAccuracy,center.lat-latAccuracy),new performance$1.LngLat(center.lng+lngAccuracy,center.lat+latAccuracy))}}class TileBounds{constructor(bounds,minzoom,maxzoom){this.bounds=LngLatBounds.convert(this.validateBounds(bounds)),this.minzoom=minzoom||0,this.maxzoom=maxzoom||24}validateBounds(bounds){return Array.isArray(bounds)&&4===bounds.length?[Math.max(-180,bounds[0]),Math.max(-90,bounds[1]),Math.min(180,bounds[2]),Math.min(90,bounds[3])]:[-180,-90,180,90]}contains(tileID){const worldSize=Math.pow(2,tileID.z),level_minX=Math.floor(performance$1.mercatorXfromLng(this.bounds.getWest())*worldSize),level_minY=Math.floor(performance$1.mercatorYfromLat(this.bounds.getNorth())*worldSize),level_maxX=Math.ceil(performance$1.mercatorXfromLng(this.bounds.getEast())*worldSize),level_maxY=Math.ceil(performance$1.mercatorYfromLat(this.bounds.getSouth())*worldSize);return tileID.x>=level_minX&&tileID.x<level_maxX&&tileID.y>=level_minY&&tileID.y<level_maxY}}class VectorTileSource extends performance$1.Evented{constructor(id,options,dispatcher,eventedParent){if(super(),this.id=id,this.dispatcher=dispatcher,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,performance$1.extend(this,performance$1.pick(options,["url","scheme","tileSize","promoteId"])),this._options=performance$1.extend({type:"vector"},options),this._collectResourceTiming=options.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(eventedParent)}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new performance$1.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const tileJSON=yield loadTileJson(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),tileJSON&&(performance$1.extend(this,tileJSON),tileJSON.bounds&&(this.tileBounds=new TileBounds(tileJSON.bounds,this.minzoom,this.maxzoom)),this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"content"})))}catch(err){this._tileJSONRequest=null,this.fire(new performance$1.ErrorEvent(err))}}))}loaded(){return this._loaded}hasTile(tileID){return!this.tileBounds||this.tileBounds.contains(tileID.canonical)}onAdd(map){this.map=map,this.load()}setSourceProperty(callback){this._tileJSONRequest&&this._tileJSONRequest.abort(),callback(),this.load()}setTiles(tiles){return this.setSourceProperty((()=>{this._options.tiles=tiles})),this}setUrl(url){return this.setSourceProperty((()=>{this.url=url,this._options.url=url})),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return performance$1.extend({},this._options)}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){const url=tile.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),params={request:this.map._requestManager.transformRequest(url,ResourceType.Tile),uid:tile.uid,tileID:tile.tileID,zoom:tile.tileID.overscaledZ,tileSize:this.tileSize*tile.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};params.request.collectResourceTiming=this._collectResourceTiming;let messageType="reloadTile";if(tile.actor&&"expired"!==tile.state){if("loading"===tile.state)return new Promise(((resolve,reject)=>{tile.reloadPromise={resolve:resolve,reject:reject}}))}else tile.actor=this.dispatcher.getActor(),messageType="loadTile";tile.abortController=new AbortController;try{const data=yield tile.actor.sendAsync({type:messageType,data:params},tile.abortController);if(delete tile.abortController,tile.aborted)return;this._afterTileLoadWorkerResponse(tile,data)}catch(err){if(delete tile.abortController,tile.aborted)return;if(err&&404!==err.status)throw err;this._afterTileLoadWorkerResponse(tile,null)}}))}_afterTileLoadWorkerResponse(tile,data){if(data&&data.resourceTiming&&(tile.resourceTiming=data.resourceTiming),data&&this.map._refreshExpiredTiles&&tile.setExpiryData(data),tile.loadVectorData(data,this.map.painter),tile.reloadPromise){const reloadPromise=tile.reloadPromise;tile.reloadPromise=null,this.loadTile(tile).then(reloadPromise.resolve).catch(reloadPromise.reject)}}abortTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){tile.abortController&&(tile.abortController.abort(),delete tile.abortController),tile.actor&&(yield tile.actor.sendAsync({type:"abortTile",data:{uid:tile.uid,type:this.type,source:this.id}}))}))}unloadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){tile.unloadVectorData(),tile.actor&&(yield tile.actor.sendAsync({type:"removeTile",data:{uid:tile.uid,type:this.type,source:this.id}}))}))}hasTransition(){return!1}}class RasterTileSource extends performance$1.Evented{constructor(id,options,dispatcher,eventedParent){super(),this.id=id,this.dispatcher=dispatcher,this.setEventedParent(eventedParent),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=performance$1.extend({type:"raster"},options),performance$1.extend(this,performance$1.pick(options,["url","scheme","tileSize"]))}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new performance$1.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const tileJSON=yield loadTileJson(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,tileJSON&&(performance$1.extend(this,tileJSON),tileJSON.bounds&&(this.tileBounds=new TileBounds(tileJSON.bounds,this.minzoom,this.maxzoom)),this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"content"})))}catch(err){this._tileJSONRequest=null,this.fire(new performance$1.ErrorEvent(err))}}))}loaded(){return this._loaded}onAdd(map){this.map=map,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(callback){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),callback(),this.load()}setTiles(tiles){return this.setSourceProperty((()=>{this._options.tiles=tiles})),this}setUrl(url){return this.setSourceProperty((()=>{this.url=url,this._options.url=url})),this}serialize(){return performance$1.extend({},this._options)}hasTile(tileID){return!this.tileBounds||this.tileBounds.contains(tileID.canonical)}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){const url=tile.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);tile.abortController=new AbortController;try{const response=yield ImageRequest.getImage(this.map._requestManager.transformRequest(url,ResourceType.Tile),tile.abortController,this.map._refreshExpiredTiles);if(delete tile.abortController,tile.aborted)return void(tile.state="unloaded");if(response&&response.data){this.map._refreshExpiredTiles&&response.cacheControl&&response.expires&&tile.setExpiryData({cacheControl:response.cacheControl,expires:response.expires});const context=this.map.painter.context,gl=context.gl,img=response.data;tile.texture=this.map.painter.getTileTexture(img.width),tile.texture?tile.texture.update(img,{useMipmap:!0}):(tile.texture=new Texture(context,img,gl.RGBA,{useMipmap:!0}),tile.texture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST),context.extTextureFilterAnisotropic&&gl.texParameterf(gl.TEXTURE_2D,context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,context.extTextureFilterAnisotropicMax)),tile.state="loaded"}}catch(err){if(delete tile.abortController,tile.aborted)tile.state="unloaded";else if(err)throw tile.state="errored",err}}))}abortTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){tile.abortController&&(tile.abortController.abort(),delete tile.abortController)}))}unloadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){tile.texture&&this.map.painter.saveTileTexture(tile.texture)}))}hasTransition(){return!1}}class RasterDEMTileSource extends RasterTileSource{constructor(id,options,dispatcher,eventedParent){super(id,options,dispatcher,eventedParent),this.type="raster-dem",this.maxzoom=22,this._options=performance$1.extend({type:"raster-dem"},options),this.encoding=options.encoding||"mapbox",this.redFactor=options.redFactor,this.greenFactor=options.greenFactor,this.blueFactor=options.blueFactor,this.baseShift=options.baseShift}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){const url=tile.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),request=this.map._requestManager.transformRequest(url,ResourceType.Tile);tile.neighboringTiles=this._getNeighboringTiles(tile.tileID),tile.abortController=new AbortController;try{const response=yield ImageRequest.getImage(request,tile.abortController,this.map._refreshExpiredTiles);if(delete tile.abortController,tile.aborted)return void(tile.state="unloaded");if(response&&response.data){const img=response.data;this.map._refreshExpiredTiles&&response.cacheControl&&response.expires&&tile.setExpiryData({cacheControl:response.cacheControl,expires:response.expires});const rawImageData=performance$1.isImageBitmap(img)&&performance$1.offscreenCanvasSupported()?img:yield this.readImageNow(img),params={type:this.type,uid:tile.uid,source:this.id,rawImageData:rawImageData,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!tile.actor||"expired"===tile.state){tile.actor=this.dispatcher.getActor();const data=yield tile.actor.sendAsync({type:"loadDEMTile",data:params});tile.dem=data,tile.needsHillshadePrepare=!0,tile.needsTerrainPrepare=!0,tile.state="loaded"}}}catch(err){if(delete tile.abortController,tile.aborted)tile.state="unloaded";else if(err)throw tile.state="errored",err}}))}readImageNow(img){return performance$1.__awaiter(this,void 0,void 0,(function*(){if("undefined"!=typeof VideoFrame&&performance$1.isOffscreenCanvasDistorted()){const width=img.width+2,height=img.height+2;try{return new performance$1.RGBAImage({width:width,height:height},yield performance$1.readImageUsingVideoFrame(img,-1,-1,width,height))}catch(e){}}return browser.getImageData(img,1)}))}_getNeighboringTiles(tileID){const canonical=tileID.canonical,dim=Math.pow(2,canonical.z),px=(canonical.x-1+dim)%dim,pxw=0===canonical.x?tileID.wrap-1:tileID.wrap,nx=(canonical.x+1+dim)%dim,nxw=canonical.x+1===dim?tileID.wrap+1:tileID.wrap,neighboringTiles={};return neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,pxw,canonical.z,px,canonical.y).key]={backfilled:!1},neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,nxw,canonical.z,nx,canonical.y).key]={backfilled:!1},canonical.y>0&&(neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,pxw,canonical.z,px,canonical.y-1).key]={backfilled:!1},neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,tileID.wrap,canonical.z,canonical.x,canonical.y-1).key]={backfilled:!1},neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,nxw,canonical.z,nx,canonical.y-1).key]={backfilled:!1}),canonical.y+1<dim&&(neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,pxw,canonical.z,px,canonical.y+1).key]={backfilled:!1},neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,tileID.wrap,canonical.z,canonical.x,canonical.y+1).key]={backfilled:!1},neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,nxw,canonical.z,nx,canonical.y+1).key]={backfilled:!1}),neighboringTiles}unloadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){tile.demTexture&&this.map.painter.saveTileTexture(tile.demTexture),tile.fbo&&(tile.fbo.destroy(),delete tile.fbo),tile.dem&&delete tile.dem,delete tile.neighboringTiles,tile.state="unloaded",tile.actor&&(yield tile.actor.sendAsync({type:"removeDEMTile",data:{type:this.type,uid:tile.uid,source:this.id}}))}))}}class GeoJSONSource extends performance$1.Evented{constructor(id,options,dispatcher,eventedParent){super(),this.id=id,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=dispatcher.getActor(),this.setEventedParent(eventedParent),this._data=options.data,this._options=performance$1.extend({},options),this._collectResourceTiming=options.collectResourceTiming,void 0!==options.maxzoom&&(this.maxzoom=options.maxzoom),options.type&&(this.type=options.type),options.attribution&&(this.attribution=options.attribution),this.promoteId=options.promoteId;const scale=performance$1.EXTENT/this.tileSize;this.workerOptions=performance$1.extend({source:this.id,cluster:options.cluster||!1,geojsonVtOptions:{buffer:(void 0!==options.buffer?options.buffer:128)*scale,tolerance:(void 0!==options.tolerance?options.tolerance:.375)*scale,extent:performance$1.EXTENT,maxZoom:this.maxzoom,lineMetrics:options.lineMetrics||!1,generateId:options.generateId||!1},superclusterOptions:{maxZoom:void 0!==options.clusterMaxZoom?options.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,options.clusterMinPoints||2),extent:performance$1.EXTENT,radius:(options.clusterRadius||50)*scale,log:!1,generateId:options.generateId||!1},clusterProperties:options.clusterProperties,filter:options.filter},options.workerOptions),"string"==typeof this.promoteId&&(this.workerOptions.promoteId=this.promoteId)}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){yield this._updateWorkerData()}))}onAdd(map){this.map=map,this.load()}setData(data){return this._data=data,this._updateWorkerData(),this}updateData(diff){return this._updateWorkerData(diff),this}setClusterOptions(options){return this.workerOptions.cluster=options.cluster,options&&(void 0!==options.clusterRadius&&(this.workerOptions.superclusterOptions.radius=options.clusterRadius),void 0!==options.clusterMaxZoom&&(this.workerOptions.superclusterOptions.maxZoom=options.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(clusterId){return this.actor.sendAsync({type:"getClusterExpansionZoom",data:{type:this.type,clusterId:clusterId,source:this.id}})}getClusterChildren(clusterId){return this.actor.sendAsync({type:"getClusterChildren",data:{type:this.type,clusterId:clusterId,source:this.id}})}getClusterLeaves(clusterId,limit,offset){return this.actor.sendAsync({type:"getClusterLeaves",data:{type:this.type,source:this.id,clusterId:clusterId,limit:limit,offset:offset}})}_updateWorkerData(diff){return performance$1.__awaiter(this,void 0,void 0,(function*(){const options=performance$1.extend({type:this.type},this.workerOptions);diff?options.dataDiff=diff:"string"==typeof this._data?(options.request=this.map._requestManager.transformRequest(browser.resolveURL(this._data),ResourceType.Source),options.request.collectResourceTiming=this._collectResourceTiming):options.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new performance$1.Event("dataloading",{dataType:"source"}));try{const result=yield this.actor.sendAsync({type:"loadData",data:options});if(this._pendingLoads--,this._removed||result.abandoned)return void this.fire(new performance$1.Event("dataabort",{dataType:"source"}));let resourceTiming=null;result.resourceTiming&&result.resourceTiming[this.id]&&(resourceTiming=result.resourceTiming[this.id].slice(0));const data={dataType:"source"};this._collectResourceTiming&&resourceTiming&&resourceTiming.length>0&&performance$1.extend(data,{resourceTiming:resourceTiming}),this.fire(new performance$1.Event("data",Object.assign(Object.assign({},data),{sourceDataType:"metadata"}))),this.fire(new performance$1.Event("data",Object.assign(Object.assign({},data),{sourceDataType:"content"})))}catch(err){if(this._pendingLoads--,this._removed)return void this.fire(new performance$1.Event("dataabort",{dataType:"source"}));this.fire(new performance$1.ErrorEvent(err))}}))}loaded(){return 0===this._pendingLoads}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){const message=tile.actor?"reloadTile":"loadTile";tile.actor=this.actor;const params={type:this.type,uid:tile.uid,tileID:tile.tileID,zoom:tile.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};tile.abortController=new AbortController;const data=yield this.actor.sendAsync({type:message,data:params},tile.abortController);delete tile.abortController,tile.unloadVectorData(),tile.aborted||tile.loadVectorData(data,this.map.painter,"reloadTile"===message)}))}abortTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){tile.abortController&&(tile.abortController.abort(),delete tile.abortController),tile.aborted=!0}))}unloadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){tile.unloadVectorData(),yield this.actor.sendAsync({type:"removeTile",data:{uid:tile.uid,type:this.type,source:this.id}})}))}onRemove(){this._removed=!0,this.actor.sendAsync({type:"removeSource",data:{type:this.type,source:this.id}})}serialize(){return performance$1.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}var rasterBoundsAttributes=performance$1.createLayout([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class ImageSource extends performance$1.Evented{constructor(id,options,dispatcher,eventedParent){super(),this.id=id,this.dispatcher=dispatcher,this.coordinates=options.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(eventedParent),this.options=options}load(newCoordinates){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new performance$1.Event("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const image=yield ImageRequest.getImage(this.map._requestManager.transformRequest(this.url,ResourceType.Image),this._request);this._request=null,this._loaded=!0,image&&image.data&&(this.image=image.data,newCoordinates&&(this.coordinates=newCoordinates),this._finishLoading())}catch(err){this._request=null,this.fire(new performance$1.ErrorEvent(err))}}))}loaded(){return this._loaded}updateImage(options){return options.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=options.url,this.load(options.coordinates).finally((()=>{this.texture=null})),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(map){this.map=map,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(coordinates){this.coordinates=coordinates;const cornerCoords=coordinates.map(performance$1.MercatorCoordinate.fromLngLat);this.tileID=function(coords){let minX=1/0,minY=1/0,maxX=-1/0,maxY=-1/0;for(const coord of coords)minX=Math.min(minX,coord.x),minY=Math.min(minY,coord.y),maxX=Math.max(maxX,coord.x),maxY=Math.max(maxY,coord.y);const dx=maxX-minX,dy=maxY-minY,dMax=Math.max(dx,dy),zoom=Math.max(0,Math.floor(-Math.log(dMax)/Math.LN2)),tilesAtZoom=Math.pow(2,zoom);return new performance$1.CanonicalTileID(zoom,Math.floor((minX+maxX)/2*tilesAtZoom),Math.floor((minY+maxY)/2*tilesAtZoom))}(cornerCoords),this.minzoom=this.maxzoom=this.tileID.z;const tileCoords=cornerCoords.map((coord=>this.tileID.getTilePoint(coord)._round()));return this._boundsArray=new performance$1.RasterBoundsArray,this._boundsArray.emplaceBack(tileCoords[0].x,tileCoords[0].y,0,0),this._boundsArray.emplaceBack(tileCoords[1].x,tileCoords[1].y,performance$1.EXTENT,0),this._boundsArray.emplaceBack(tileCoords[3].x,tileCoords[3].y,0,performance$1.EXTENT),this._boundsArray.emplaceBack(tileCoords[2].x,tileCoords[2].y,performance$1.EXTENT,performance$1.EXTENT),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(0===Object.keys(this.tiles).length||!this.image)return;const context=this.map.painter.context,gl=context.gl;this.boundsBuffer||(this.boundsBuffer=context.createVertexBuffer(this._boundsArray,rasterBoundsAttributes.members)),this.boundsSegments||(this.boundsSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2)),this.texture||(this.texture=new Texture(context,this.image,gl.RGBA),this.texture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE));let newTilesLoaded=!1;for(const w in this.tiles){const tile=this.tiles[w];"loaded"!==tile.state&&(tile.state="loaded",tile.texture=this.texture,newTilesLoaded=!0)}newTilesLoaded&&this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){this.tileID&&this.tileID.equals(tile.tileID.canonical)?(this.tiles[String(tile.tileID.wrap)]=tile,tile.buckets={}):tile.state="errored"}))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class VideoSource extends ImageSource{constructor(id,options,dispatcher,eventedParent){super(id,options,dispatcher,eventedParent),this.roundZoom=!0,this.type="video",this.options=options}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=!1;const options=this.options;this.urls=[];for(const url of options.urls)this.urls.push(this.map._requestManager.transformRequest(url,ResourceType.Source).url);try{const video=yield performance$1.getVideo(this.urls);if(this._loaded=!0,!video)return;this.video=video,this.video.loop=!0,this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading()}catch(err){this.fire(new performance$1.ErrorEvent(err))}}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(seconds){if(this.video){const seekableRange=this.video.seekable;seconds<seekableRange.start(0)||seconds>seekableRange.end(0)?this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${seekableRange.start(0)} and ${seekableRange.end(0)}-second mark.`))):this.video.currentTime=seconds}}getVideo(){return this.video}onAdd(map){this.map||(this.map=map,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const context=this.map.painter.context,gl=context.gl;this.boundsBuffer||(this.boundsBuffer=context.createVertexBuffer(this._boundsArray,rasterBoundsAttributes.members)),this.boundsSegments||(this.boundsSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2)),this.texture?this.video.paused||(this.texture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE),gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,gl.RGBA,gl.UNSIGNED_BYTE,this.video)):(this.texture=new Texture(context,this.video,gl.RGBA),this.texture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE));let newTilesLoaded=!1;for(const w in this.tiles){const tile=this.tiles[w];"loaded"!==tile.state&&(tile.state="loaded",tile.texture=this.texture,newTilesLoaded=!0)}newTilesLoaded&&this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class CanvasSource extends ImageSource{constructor(id,options,dispatcher,eventedParent){super(id,options,dispatcher,eventedParent),options.coordinates?Array.isArray(options.coordinates)&&4===options.coordinates.length&&!options.coordinates.some((c=>!Array.isArray(c)||2!==c.length||c.some((l=>"number"!=typeof l))))||this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'missing required property "coordinates"'))),options.animate&&"boolean"!=typeof options.animate&&this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'optional "animate" property must be a boolean value'))),options.canvas?"string"==typeof options.canvas||options.canvas instanceof HTMLCanvasElement||this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'missing required property "canvas"'))),this.options=options,this.animate=void 0===options.animate||options.animate}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new performance$1.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}))}getCanvas(){return this.canvas}onAdd(map){this.map=map,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let resize=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,resize=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,resize=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const context=this.map.painter.context,gl=context.gl;this.boundsBuffer||(this.boundsBuffer=context.createVertexBuffer(this._boundsArray,rasterBoundsAttributes.members)),this.boundsSegments||(this.boundsSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2)),this.texture?(resize||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new Texture(context,this.canvas,gl.RGBA,{premultiply:!0});let newTilesLoaded=!1;for(const w in this.tiles){const tile=this.tiles[w];"loaded"!==tile.state&&(tile.state="loaded",tile.texture=this.texture,newTilesLoaded=!0)}newTilesLoaded&&this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const x of[this.canvas.width,this.canvas.height])if(isNaN(x)||x<=0)return!0;return!1}}const registeredSources={},getSourceType=name=>{switch(name){case"geojson":return GeoJSONSource;case"image":return ImageSource;case"raster":return RasterTileSource;case"raster-dem":return RasterDEMTileSource;case"vector":return VectorTileSource;case"video":return VideoSource;case"canvas":return CanvasSource}return registeredSources[name]};class RTLMainThreadPlugin extends performance$1.Evented{constructor(){super(...arguments),this.pluginStatus="unavailable",this.pluginURL=null,this.dispatcher=getGlobalDispatcher(),this.queue=[]}_sendPluginStateToWorker(){return performance$1.__awaiter(this,void 0,void 0,(function*(){yield this.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}),this.fire(new performance$1.Event("pluginStateChange",{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}))}))}getRTLTextPluginStatus(){return this.pluginStatus}clearRTLTextPlugin(){this.pluginStatus="unavailable",this.pluginURL=null}setRTLTextPlugin(url,deferred=!1){return performance$1.__awaiter(this,void 0,void 0,(function*(){if("deferred"===this.pluginStatus||"loading"===this.pluginStatus||"loaded"===this.pluginStatus)throw new Error("setRTLTextPlugin cannot be called multiple times.");this.pluginURL=browser.resolveURL(url),this.pluginStatus="deferred",yield this._sendPluginStateToWorker(),deferred||(yield this._downloadRTLTextPlugin())}))}_downloadRTLTextPlugin(){return performance$1.__awaiter(this,void 0,void 0,(function*(){if("deferred"!==this.pluginStatus||!this.pluginURL)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");try{this.pluginStatus="loading",yield this._sendPluginStateToWorker(),yield performance$1.getArrayBuffer({url:this.pluginURL},new AbortController),this.pluginStatus="loaded"}catch(_a){this.pluginStatus="error"}yield this._sendPluginStateToWorker()}))}lazyLoadRTLTextPlugin(){return performance$1.__awaiter(this,void 0,void 0,(function*(){"deferred"===this.pluginStatus&&(yield this._downloadRTLTextPlugin())}))}}let rtlMainThreadPlugin=null;function rtlMainThreadPluginFactory(){return rtlMainThreadPlugin||(rtlMainThreadPlugin=new RTLMainThreadPlugin),rtlMainThreadPlugin}class Tile{constructor(tileID,size){this.timeAdded=0,this.fadeEndTime=0,this.tileID=tileID,this.uid=performance$1.uniqueId(),this.uses=0,this.tileSize=size,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(duration){const fadeEndTime=duration+this.timeAdded;fadeEndTime<this.fadeEndTime||(this.fadeEndTime=fadeEndTime)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}clearTextures(painter){this.demTexture&&painter.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(data,painter,justReloaded){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",data){data.featureIndex&&(this.latestFeatureIndex=data.featureIndex,data.rawTileData?(this.latestRawTileData=data.rawTileData,this.latestFeatureIndex.rawTileData=data.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=data.collisionBoxArray,this.buckets=function(input,style){const output={};if(!style)return output;for(const bucket of input){const layers=bucket.layerIds.map((id=>style.getLayer(id))).filter(Boolean);if(0!==layers.length){bucket.layers=layers,bucket.stateDependentLayerIds&&(bucket.stateDependentLayers=bucket.stateDependentLayerIds.map((lId=>layers.filter((l=>l.id===lId))[0])));for(const layer of layers)output[layer.id]=bucket}}return output}(data.buckets,painter.style),this.hasSymbolBuckets=!1;for(const id in this.buckets){const bucket=this.buckets[id];if(bucket instanceof performance$1.SymbolBucket){if(this.hasSymbolBuckets=!0,!justReloaded)break;bucket.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const id in this.buckets){const bucket=this.buckets[id];if(bucket instanceof performance$1.SymbolBucket&&bucket.hasRTLText){this.hasRTLText=!0,rtlMainThreadPluginFactory().lazyLoadRTLTextPlugin();break}}this.queryPadding=0;for(const id in this.buckets){const bucket=this.buckets[id];this.queryPadding=Math.max(this.queryPadding,painter.style.getLayer(id).queryRadius(bucket))}data.imageAtlas&&(this.imageAtlas=data.imageAtlas),data.glyphAtlasImage&&(this.glyphAtlasImage=data.glyphAtlasImage)}else this.collisionBoxArray=new performance$1.CollisionBoxArray}unloadVectorData(){for(const id in this.buckets)this.buckets[id].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(layer){return this.buckets[layer.id]}upload(context){for(const id in this.buckets){const bucket=this.buckets[id];bucket.uploadPending()&&bucket.upload(context)}const gl=context.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new Texture(context,this.imageAtlas.image,gl.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new Texture(context,this.glyphAtlasImage,gl.ALPHA),this.glyphAtlasImage=null)}prepare(imageManager){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(imageManager,this.imageAtlasTexture)}queryRenderedFeatures(layers,serializedLayers,sourceFeatureState,queryGeometry,cameraQueryGeometry,scale,params,transform,maxPitchScaleFactor,pixelPosMatrix){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:queryGeometry,cameraQueryGeometry:cameraQueryGeometry,scale:scale,tileSize:this.tileSize,pixelPosMatrix:pixelPosMatrix,transform:transform,params:params,queryPadding:this.queryPadding*maxPitchScaleFactor},layers,serializedLayers,sourceFeatureState):{}}querySourceFeatures(result,params){const featureIndex=this.latestFeatureIndex;if(!featureIndex||!featureIndex.rawTileData)return;const vtLayers=featureIndex.loadVTLayers(),sourceLayer=params&&params.sourceLayer?params.sourceLayer:"",layer=vtLayers._geojsonTileLayer||vtLayers[sourceLayer];if(!layer)return;const filter=performance$1.createFilter(params&&params.filter),{z:z,x:x,y:y}=this.tileID.canonical,coord={z:z,x:x,y:y};for(let i=0;i<layer.length;i++){const feature=layer.feature(i);if(filter.needGeometry){const evaluationFeature=performance$1.toEvaluationFeature(feature,!0);if(!filter.filter(new performance$1.EvaluationParameters(this.tileID.overscaledZ),evaluationFeature,this.tileID.canonical))continue}else if(!filter.filter(new performance$1.EvaluationParameters(this.tileID.overscaledZ),feature))continue;const id=featureIndex.getId(feature,sourceLayer),geojsonFeature=new performance$1.GeoJSONFeature(feature,z,x,y,id);geojsonFeature.tile=coord,result.push(geojsonFeature)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(data){const prior=this.expirationTime;if(data.cacheControl){const parsedCC=performance$1.parseCacheControl(data.cacheControl);parsedCC["max-age"]&&(this.expirationTime=Date.now()+1e3*parsedCC["max-age"])}else data.expires&&(this.expirationTime=new Date(data.expires).getTime());if(this.expirationTime){const now=Date.now();let isExpired=!1;if(this.expirationTime>now)isExpired=!1;else if(prior)if(this.expirationTime<prior)isExpired=!0;else{const delta=this.expirationTime-prior;delta?this.expirationTime=now+Math.max(delta,3e4):isExpired=!0}else isExpired=!0;isExpired?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(states,painter){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||0===Object.keys(states).length)return;const vtLayers=this.latestFeatureIndex.loadVTLayers();for(const id in this.buckets){if(!painter.style.hasLayer(id))continue;const bucket=this.buckets[id],sourceLayerId=bucket.layers[0].sourceLayer||"_geojsonTileLayer",sourceLayer=vtLayers[sourceLayerId],sourceLayerStates=states[sourceLayerId];if(!sourceLayer||!sourceLayerStates||0===Object.keys(sourceLayerStates).length)continue;bucket.update(sourceLayerStates,sourceLayer,this.imageAtlas&&this.imageAtlas.patternPositions||{});const layer=painter&&painter.style&&painter.style.getLayer(id);layer&&(this.queryPadding=Math.max(this.queryPadding,layer.queryRadius(bucket)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<browser.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(duration){this.symbolFadeHoldUntil=browser.now()+duration}setDependencies(namespace,dependencies){const index={};for(const dep of dependencies)index[dep]=!0;this.dependencies[namespace]=index}hasDependency(namespaces,keys){for(const namespace of namespaces){const dependencies=this.dependencies[namespace];if(dependencies)for(const key of keys)if(dependencies[key])return!0}return!1}}class TileCache{constructor(max,onRemove){this.max=max,this.onRemove=onRemove,this.reset()}reset(){for(const key in this.data)for(const removedData of this.data[key])removedData.timeout&&clearTimeout(removedData.timeout),this.onRemove(removedData.value);return this.data={},this.order=[],this}add(tileID,data,expiryTimeout){const key=tileID.wrapped().key;void 0===this.data[key]&&(this.data[key]=[]);const dataWrapper={value:data,timeout:void 0};if(void 0!==expiryTimeout&&(dataWrapper.timeout=setTimeout((()=>{this.remove(tileID,dataWrapper)}),expiryTimeout)),this.data[key].push(dataWrapper),this.order.push(key),this.order.length>this.max){const removedData=this._getAndRemoveByKey(this.order[0]);removedData&&this.onRemove(removedData)}return this}has(tileID){return tileID.wrapped().key in this.data}getAndRemove(tileID){return this.has(tileID)?this._getAndRemoveByKey(tileID.wrapped().key):null}_getAndRemoveByKey(key){const data=this.data[key].shift();return data.timeout&&clearTimeout(data.timeout),0===this.data[key].length&&delete this.data[key],this.order.splice(this.order.indexOf(key),1),data.value}getByKey(key){const data=this.data[key];return data?data[0].value:null}get(tileID){if(!this.has(tileID))return null;return this.data[tileID.wrapped().key][0].value}remove(tileID,value){if(!this.has(tileID))return this;const key=tileID.wrapped().key,dataIndex=void 0===value?0:this.data[key].indexOf(value),data=this.data[key][dataIndex];return this.data[key].splice(dataIndex,1),data.timeout&&clearTimeout(data.timeout),0===this.data[key].length&&delete this.data[key],this.onRemove(data.value),this.order.splice(this.order.indexOf(key),1),this}setMaxSize(max){for(this.max=max;this.order.length>this.max;){const removedData=this._getAndRemoveByKey(this.order[0]);removedData&&this.onRemove(removedData)}return this}filter(filterFn){const removed=[];for(const key in this.data)for(const entry of this.data[key])filterFn(entry.value)||removed.push(entry);for(const r of removed)this.remove(r.value.tileID,r)}}class SourceFeatureState{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(sourceLayer,featureId,newState){const feature=String(featureId);if(this.stateChanges[sourceLayer]=this.stateChanges[sourceLayer]||{},this.stateChanges[sourceLayer][feature]=this.stateChanges[sourceLayer][feature]||{},performance$1.extend(this.stateChanges[sourceLayer][feature],newState),null===this.deletedStates[sourceLayer]){this.deletedStates[sourceLayer]={};for(const ft in this.state[sourceLayer])ft!==feature&&(this.deletedStates[sourceLayer][ft]=null)}else{if(this.deletedStates[sourceLayer]&&null===this.deletedStates[sourceLayer][feature]){this.deletedStates[sourceLayer][feature]={};for(const prop in this.state[sourceLayer][feature])newState[prop]||(this.deletedStates[sourceLayer][feature][prop]=null)}else for(const key in newState){this.deletedStates[sourceLayer]&&this.deletedStates[sourceLayer][feature]&&null===this.deletedStates[sourceLayer][feature][key]&&delete this.deletedStates[sourceLayer][feature][key]}}}removeFeatureState(sourceLayer,featureId,key){if(null===this.deletedStates[sourceLayer])return;const feature=String(featureId);if(this.deletedStates[sourceLayer]=this.deletedStates[sourceLayer]||{},key&&void 0!==featureId)null!==this.deletedStates[sourceLayer][feature]&&(this.deletedStates[sourceLayer][feature]=this.deletedStates[sourceLayer][feature]||{},this.deletedStates[sourceLayer][feature][key]=null);else if(void 0!==featureId){if(this.stateChanges[sourceLayer]&&this.stateChanges[sourceLayer][feature])for(key in this.deletedStates[sourceLayer][feature]={},this.stateChanges[sourceLayer][feature])this.deletedStates[sourceLayer][feature][key]=null;else this.deletedStates[sourceLayer][feature]=null}else this.deletedStates[sourceLayer]=null}getState(sourceLayer,featureId){const feature=String(featureId),base=this.state[sourceLayer]||{},changes=this.stateChanges[sourceLayer]||{},reconciledState=performance$1.extend({},base[feature],changes[feature]);if(null===this.deletedStates[sourceLayer])return{};if(this.deletedStates[sourceLayer]){const featureDeletions=this.deletedStates[sourceLayer][featureId];if(null===featureDeletions)return{};for(const prop in featureDeletions)delete reconciledState[prop]}return reconciledState}initializeTileState(tile,painter){tile.setFeatureState(this.state,painter)}coalesceChanges(tiles,painter){const featuresChanged={};for(const sourceLayer in this.stateChanges){this.state[sourceLayer]=this.state[sourceLayer]||{};const layerStates={};for(const feature in this.stateChanges[sourceLayer])this.state[sourceLayer][feature]||(this.state[sourceLayer][feature]={}),performance$1.extend(this.state[sourceLayer][feature],this.stateChanges[sourceLayer][feature]),layerStates[feature]=this.state[sourceLayer][feature];featuresChanged[sourceLayer]=layerStates}for(const sourceLayer in this.deletedStates){this.state[sourceLayer]=this.state[sourceLayer]||{};const layerStates={};if(null===this.deletedStates[sourceLayer])for(const ft in this.state[sourceLayer])layerStates[ft]={},this.state[sourceLayer][ft]={};else for(const feature in this.deletedStates[sourceLayer]){if(null===this.deletedStates[sourceLayer][feature])this.state[sourceLayer][feature]={};else for(const key of Object.keys(this.deletedStates[sourceLayer][feature]))delete this.state[sourceLayer][feature][key];layerStates[feature]=this.state[sourceLayer][feature]}featuresChanged[sourceLayer]=featuresChanged[sourceLayer]||{},performance$1.extend(featuresChanged[sourceLayer],layerStates)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(featuresChanged).length)for(const id in tiles){tiles[id].setFeatureState(featuresChanged,painter)}}}class SourceCache extends performance$1.Evented{constructor(id,options,dispatcher){super(),this.id=id,this.dispatcher=dispatcher,this.on("data",(e=>{"source"===e.dataType&&"metadata"===e.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===e.dataType&&"content"===e.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)})),this.on("dataloading",(()=>{this._sourceErrored=!1})),this.on("error",(()=>{this._sourceErrored=this._source.loaded()})),this._source=((id,specification,dispatcher,eventedParent)=>{const source=new(getSourceType(specification.type))(id,specification,dispatcher,eventedParent);if(source.id!==id)throw new Error(`Expected Source id to be ${id} instead of ${source.id}`);return source})(id,options,dispatcher,this),this._tiles={},this._cache=new TileCache(0,(tile=>this._unloadTile(tile))),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new SourceFeatureState,this._didEmitContent=!1,this._updated=!1}onAdd(map){this.map=map,this._maxTileCacheSize=map?map._maxTileCacheSize:null,this._maxTileCacheZoomLevels=map?map._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(map)}onRemove(map){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(map)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;if(!(void 0===this.used&&void 0===this.usedForTerrain||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const t in this._tiles){const tile=this._tiles[t];if("loaded"!==tile.state&&"errored"!==tile.state)return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const shouldReload=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,shouldReload&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(tile,id,state){return performance$1.__awaiter(this,void 0,void 0,(function*(){try{yield this._source.loadTile(tile),this._tileLoaded(tile,id,state)}catch(err){tile.state="errored",404!==err.status?this._source.fire(new performance$1.ErrorEvent(err,{tile:tile})):this.update(this.transform,this.terrain)}}))}_unloadTile(tile){this._source.unloadTile&&this._source.unloadTile(tile)}_abortTile(tile){this._source.abortTile&&this._source.abortTile(tile),this._source.fire(new performance$1.Event("dataabort",{tile:tile,coord:tile.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(context){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const i in this._tiles){const tile=this._tiles[i];tile.upload(context),tile.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map((tile=>tile.tileID)).sort(compareTileId).map((id=>id.key))}getRenderableIds(symbolLayer){const renderables=[];for(const id in this._tiles)this._isIdRenderable(id,symbolLayer)&&renderables.push(this._tiles[id]);return symbolLayer?renderables.sort(((a_,b_)=>{const a=a_.tileID,b=b_.tileID,rotatedA=new performance$1.Point(a.canonical.x,a.canonical.y)._rotate(this.transform.angle),rotatedB=new performance$1.Point(b.canonical.x,b.canonical.y)._rotate(this.transform.angle);return a.overscaledZ-b.overscaledZ||rotatedB.y-rotatedA.y||rotatedB.x-rotatedA.x})).map((tile=>tile.tileID.key)):renderables.map((tile=>tile.tileID)).sort(compareTileId).map((id=>id.key))}hasRenderableParent(tileID){const parentTile=this.findLoadedParent(tileID,0);return!!parentTile&&this._isIdRenderable(parentTile.tileID.key)}_isIdRenderable(id,symbolLayer){return this._tiles[id]&&this._tiles[id].hasData()&&!this._coveredTiles[id]&&(symbolLayer||!this._tiles[id].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const i in this._tiles)"errored"!==this._tiles[i].state&&this._reloadTile(i,"reloading")}}_reloadTile(id,state){return performance$1.__awaiter(this,void 0,void 0,(function*(){const tile=this._tiles[id];tile&&("loading"!==tile.state&&(tile.state=state),yield this._loadTile(tile,id,state))}))}_tileLoaded(tile,id,previousState){tile.timeAdded=browser.now(),"expired"===previousState&&(tile.refreshedUponExpiration=!0),this._setTileReloadTimer(id,tile),"raster-dem"===this.getSource().type&&tile.dem&&this._backfillDEM(tile),this._state.initializeTileState(tile,this.map?this.map.painter:null),tile.aborted||this._source.fire(new performance$1.Event("data",{dataType:"source",tile:tile,coord:tile.tileID}))}_backfillDEM(tile){const renderables=this.getRenderableIds();for(let i=0;i<renderables.length;i++){const borderId=renderables[i];if(tile.neighboringTiles&&tile.neighboringTiles[borderId]){const borderTile=this.getTileByID(borderId);fillBorder(tile,borderTile),fillBorder(borderTile,tile)}}function fillBorder(tile,borderTile){tile.needsHillshadePrepare=!0,tile.needsTerrainPrepare=!0;let dx=borderTile.tileID.canonical.x-tile.tileID.canonical.x;const dy=borderTile.tileID.canonical.y-tile.tileID.canonical.y,dim=Math.pow(2,tile.tileID.canonical.z),borderId=borderTile.tileID.key;0===dx&&0===dy||Math.abs(dy)>1||(Math.abs(dx)>1&&(1===Math.abs(dx+dim)?dx+=dim:1===Math.abs(dx-dim)&&(dx-=dim)),borderTile.dem&&tile.dem&&(tile.dem.backfillBorder(borderTile.dem,dx,dy),tile.neighboringTiles&&tile.neighboringTiles[borderId]&&(tile.neighboringTiles[borderId].backfilled=!0)))}}getTile(tileID){return this.getTileByID(tileID.key)}getTileByID(id){return this._tiles[id]}_retainLoadedChildren(idealTiles,zoom,maxCoveringZoom,retain){for(const id in this._tiles){let tile=this._tiles[id];if(retain[id]||!tile.hasData()||tile.tileID.overscaledZ<=zoom||tile.tileID.overscaledZ>maxCoveringZoom)continue;let topmostLoadedID=tile.tileID;for(;tile&&tile.tileID.overscaledZ>zoom+1;){const parentID=tile.tileID.scaledTo(tile.tileID.overscaledZ-1);tile=this._tiles[parentID.key],tile&&tile.hasData()&&(topmostLoadedID=parentID)}let tileID=topmostLoadedID;for(;tileID.overscaledZ>zoom;)if(tileID=tileID.scaledTo(tileID.overscaledZ-1),idealTiles[tileID.key]){retain[topmostLoadedID.key]=topmostLoadedID;break}}}findLoadedParent(tileID,minCoveringZoom){if(tileID.key in this._loadedParentTiles){const parent=this._loadedParentTiles[tileID.key];return parent&&parent.tileID.overscaledZ>=minCoveringZoom?parent:null}for(let z=tileID.overscaledZ-1;z>=minCoveringZoom;z--){const parentTileID=tileID.scaledTo(z),tile=this._getLoadedTile(parentTileID);if(tile)return tile}}_getLoadedTile(tileID){const tile=this._tiles[tileID.key];if(tile&&tile.hasData())return tile;return this._cache.getByKey(tileID.wrapped().key)}updateCacheSize(transform){const approxTilesInView=(Math.ceil(transform.width/this._source.tileSize)+1)*(Math.ceil(transform.height/this._source.tileSize)+1),commonZoomRange=null===this._maxTileCacheZoomLevels?performance$1.config.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels,viewDependentMaxSize=Math.floor(approxTilesInView*commonZoomRange),maxSize="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,viewDependentMaxSize):viewDependentMaxSize;this._cache.setMaxSize(maxSize)}handleWrapJump(lng){const worldDifference=(lng-(void 0===this._prevLng?lng:this._prevLng))/360,wrapDelta=Math.round(worldDifference);if(this._prevLng=lng,wrapDelta){const tiles={};for(const key in this._tiles){const tile=this._tiles[key];tile.tileID=tile.tileID.unwrapTo(tile.tileID.wrap+wrapDelta),tiles[tile.tileID.key]=tile}this._tiles=tiles;for(const id in this._timers)clearTimeout(this._timers[id]),delete this._timers[id];for(const id in this._tiles){const tile=this._tiles[id];this._setTileReloadTimer(id,tile)}}}update(transform,terrain){if(this.transform=transform,this.terrain=terrain,!this._sourceLoaded||this._paused)return;let idealTileIDs;this.updateCacheSize(transform),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?idealTileIDs=transform.getVisibleUnwrappedCoordinates(this._source.tileID).map((unwrapped=>new performance$1.OverscaledTileID(unwrapped.canonical.z,unwrapped.wrap,unwrapped.canonical.z,unwrapped.canonical.x,unwrapped.canonical.y))):(idealTileIDs=transform.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:terrain}),this._source.hasTile&&(idealTileIDs=idealTileIDs.filter((coord=>this._source.hasTile(coord))))):idealTileIDs=[];const zoom=transform.coveringZoomLevel(this._source),minCoveringZoom=Math.max(zoom-SourceCache.maxOverzooming,this._source.minzoom),maxCoveringZoom=Math.max(zoom+SourceCache.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const parents={};for(const tileID of idealTileIDs)if(tileID.canonical.z>this._source.minzoom){const parent=tileID.scaledTo(tileID.canonical.z-1);parents[parent.key]=parent;const parent2=tileID.scaledTo(Math.max(this._source.minzoom,Math.min(tileID.canonical.z,5)));parents[parent2.key]=parent2}idealTileIDs=idealTileIDs.concat(Object.values(parents))}const noPendingDataEmissions=0===idealTileIDs.length&&!this._updated&&this._didEmitContent;this._updated=!0,noPendingDataEmissions&&this.fire(new performance$1.Event("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const retain=this._updateRetainedTiles(idealTileIDs,zoom);if(isRasterType(this._source.type)){const parentsForFading={},fadingTiles={},ids=Object.keys(retain),now=browser.now();for(const id of ids){const tileID=retain[id],tile=this._tiles[id];if(!tile||0!==tile.fadeEndTime&&tile.fadeEndTime<=now)continue;const parentTile=this.findLoadedParent(tileID,minCoveringZoom);parentTile&&(this._addTile(parentTile.tileID),parentsForFading[parentTile.tileID.key]=parentTile.tileID),fadingTiles[id]=tileID}this._retainLoadedChildren(fadingTiles,zoom,maxCoveringZoom,retain);for(const id in parentsForFading)retain[id]||(this._coveredTiles[id]=!0,retain[id]=parentsForFading[id]);if(terrain){const idealRasterTileIDs={},missingTileIDs={};for(const tileID of idealTileIDs)this._tiles[tileID.key].hasData()?idealRasterTileIDs[tileID.key]=tileID:missingTileIDs[tileID.key]=tileID;for(const key in missingTileIDs){const children=missingTileIDs[key].children(this._source.maxzoom);this._tiles[children[0].key]&&this._tiles[children[1].key]&&this._tiles[children[2].key]&&this._tiles[children[3].key]&&(idealRasterTileIDs[children[0].key]=retain[children[0].key]=children[0],idealRasterTileIDs[children[1].key]=retain[children[1].key]=children[1],idealRasterTileIDs[children[2].key]=retain[children[2].key]=children[2],idealRasterTileIDs[children[3].key]=retain[children[3].key]=children[3],delete missingTileIDs[key])}for(const key in missingTileIDs){const parent=this.findLoadedParent(missingTileIDs[key],this._source.minzoom);if(parent){idealRasterTileIDs[parent.tileID.key]=retain[parent.tileID.key]=parent.tileID;for(const key in idealRasterTileIDs)idealRasterTileIDs[key].isChildOf(parent.tileID)&&delete idealRasterTileIDs[key]}}for(const key in this._tiles)idealRasterTileIDs[key]||(this._coveredTiles[key]=!0)}}for(const retainedId in retain)this._tiles[retainedId].clearFadeHold();const remove=performance$1.keysDifference(this._tiles,retain);for(const tileID of remove){const tile=this._tiles[tileID];tile.hasSymbolBuckets&&!tile.holdingForFade()?tile.setHoldDuration(this.map._fadeDuration):tile.hasSymbolBuckets&&!tile.symbolFadeFinished()||this._removeTile(tileID)}this._updateLoadedParentTileCache()}releaseSymbolFadeTiles(){for(const id in this._tiles)this._tiles[id].holdingForFade()&&this._removeTile(id)}_updateRetainedTiles(idealTileIDs,zoom){const retain={},checked={},minCoveringZoom=Math.max(zoom-SourceCache.maxOverzooming,this._source.minzoom),maxCoveringZoom=Math.max(zoom+SourceCache.maxUnderzooming,this._source.minzoom),missingTiles={};for(const tileID of idealTileIDs){const tile=this._addTile(tileID);retain[tileID.key]=tileID,tile.hasData()||zoom<this._source.maxzoom&&(missingTiles[tileID.key]=tileID)}this._retainLoadedChildren(missingTiles,zoom,maxCoveringZoom,retain);for(const tileID of idealTileIDs){let tile=this._tiles[tileID.key];if(tile.hasData())continue;if(zoom+1>this._source.maxzoom){const childCoord=tileID.children(this._source.maxzoom)[0],childTile=this.getTile(childCoord);if(childTile&&childTile.hasData()){retain[childCoord.key]=childCoord;continue}}else{const children=tileID.children(this._source.maxzoom);if(retain[children[0].key]&&retain[children[1].key]&&retain[children[2].key]&&retain[children[3].key])continue}let parentWasRequested=tile.wasRequested();for(let overscaledZ=tileID.overscaledZ-1;overscaledZ>=minCoveringZoom;--overscaledZ){const parentId=tileID.scaledTo(overscaledZ);if(checked[parentId.key])break;if(checked[parentId.key]=!0,tile=this.getTile(parentId),!tile&&parentWasRequested&&(tile=this._addTile(parentId)),tile){const hasData=tile.hasData();if((parentWasRequested||hasData)&&(retain[parentId.key]=parentId),parentWasRequested=tile.wasRequested(),hasData)break}}}return retain}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const tileKey in this._tiles){const path=[];let parentTile,currentId=this._tiles[tileKey].tileID;for(;currentId.overscaledZ>0;){if(currentId.key in this._loadedParentTiles){parentTile=this._loadedParentTiles[currentId.key];break}path.push(currentId.key);const parentId=currentId.scaledTo(currentId.overscaledZ-1);if(parentTile=this._getLoadedTile(parentId),parentTile)break;currentId=parentId}for(const key of path)this._loadedParentTiles[key]=parentTile}}_addTile(tileID){let tile=this._tiles[tileID.key];if(tile)return tile;tile=this._cache.getAndRemove(tileID),tile&&(this._setTileReloadTimer(tileID.key,tile),tile.tileID=tileID,this._state.initializeTileState(tile,this.map?this.map.painter:null),this._cacheTimers[tileID.key]&&(clearTimeout(this._cacheTimers[tileID.key]),delete this._cacheTimers[tileID.key],this._setTileReloadTimer(tileID.key,tile)));const cached=tile;return tile||(tile=new Tile(tileID,this._source.tileSize*tileID.overscaleFactor()),this._loadTile(tile,tileID.key,tile.state)),tile.uses++,this._tiles[tileID.key]=tile,cached||this._source.fire(new performance$1.Event("dataloading",{tile:tile,coord:tile.tileID,dataType:"source"})),tile}_setTileReloadTimer(id,tile){id in this._timers&&(clearTimeout(this._timers[id]),delete this._timers[id]);const expiryTimeout=tile.getExpiryTimeout();expiryTimeout&&(this._timers[id]=setTimeout((()=>{this._reloadTile(id,"expired"),delete this._timers[id]}),expiryTimeout))}_removeTile(id){const tile=this._tiles[id];tile&&(tile.uses--,delete this._tiles[id],this._timers[id]&&(clearTimeout(this._timers[id]),delete this._timers[id]),tile.uses>0||(tile.hasData()&&"reloading"!==tile.state?this._cache.add(tile.tileID,tile,tile.getExpiryTimeout()):(tile.aborted=!0,this._abortTile(tile),this._unloadTile(tile))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const id in this._tiles)this._removeTile(id);this._cache.reset()}tilesIn(pointQueryGeometry,maxPitchScaleFactor,has3DLayer){const tileResults=[],transform=this.transform;if(!transform)return tileResults;const cameraPointQueryGeometry=has3DLayer?transform.getCameraQueryGeometry(pointQueryGeometry):pointQueryGeometry,queryGeometry=pointQueryGeometry.map((p=>transform.pointCoordinate(p,this.terrain))),cameraQueryGeometry=cameraPointQueryGeometry.map((p=>transform.pointCoordinate(p,this.terrain))),ids=this.getIds();let minX=1/0,minY=1/0,maxX=-1/0,maxY=-1/0;for(const p of cameraQueryGeometry)minX=Math.min(minX,p.x),minY=Math.min(minY,p.y),maxX=Math.max(maxX,p.x),maxY=Math.max(maxY,p.y);for(let i=0;i<ids.length;i++){const tile=this._tiles[ids[i]];if(tile.holdingForFade())continue;const tileID=tile.tileID,scale=Math.pow(2,transform.zoom-tile.tileID.overscaledZ),queryPadding=maxPitchScaleFactor*tile.queryPadding*performance$1.EXTENT/tile.tileSize/scale,tileSpaceBounds=[tileID.getTilePoint(new performance$1.MercatorCoordinate(minX,minY)),tileID.getTilePoint(new performance$1.MercatorCoordinate(maxX,maxY))];if(tileSpaceBounds[0].x-queryPadding<performance$1.EXTENT&&tileSpaceBounds[0].y-queryPadding<performance$1.EXTENT&&tileSpaceBounds[1].x+queryPadding>=0&&tileSpaceBounds[1].y+queryPadding>=0){const tileSpaceQueryGeometry=queryGeometry.map((c=>tileID.getTilePoint(c))),tileSpaceCameraQueryGeometry=cameraQueryGeometry.map((c=>tileID.getTilePoint(c)));tileResults.push({tile:tile,tileID:tileID,queryGeometry:tileSpaceQueryGeometry,cameraQueryGeometry:tileSpaceCameraQueryGeometry,scale:scale})}}return tileResults}getVisibleCoordinates(symbolLayer){const coords=this.getRenderableIds(symbolLayer).map((id=>this._tiles[id].tileID));for(const coord of coords)coord.posMatrix=this.transform.calculatePosMatrix(coord.toUnwrapped());return coords}hasTransition(){if(this._source.hasTransition())return!0;if(isRasterType(this._source.type)){const now=browser.now();for(const id in this._tiles){if(this._tiles[id].fadeEndTime>=now)return!0}}return!1}setFeatureState(sourceLayer,featureId,state){sourceLayer=sourceLayer||"_geojsonTileLayer",this._state.updateState(sourceLayer,featureId,state)}removeFeatureState(sourceLayer,featureId,key){sourceLayer=sourceLayer||"_geojsonTileLayer",this._state.removeFeatureState(sourceLayer,featureId,key)}getFeatureState(sourceLayer,featureId){return sourceLayer=sourceLayer||"_geojsonTileLayer",this._state.getState(sourceLayer,featureId)}setDependencies(tileKey,namespace,dependencies){const tile=this._tiles[tileKey];tile&&tile.setDependencies(namespace,dependencies)}reloadTilesForDependencies(namespaces,keys){for(const id in this._tiles){this._tiles[id].hasDependency(namespaces,keys)&&this._reloadTile(id,"reloading")}this._cache.filter((tile=>!tile.hasDependency(namespaces,keys)))}}function compareTileId(a,b){const aWrap=Math.abs(2*a.wrap)-+(a.wrap<0),bWrap=Math.abs(2*b.wrap)-+(b.wrap<0);return a.overscaledZ-b.overscaledZ||bWrap-aWrap||b.canonical.y-a.canonical.y||b.canonical.x-a.canonical.x}function isRasterType(type){return"raster"===type||"image"===type||"video"===type}SourceCache.maxOverzooming=10,SourceCache.maxUnderzooming=3;class PathInterpolator{constructor(points_,padding_){this.reset(points_,padding_)}reset(points_,padding_){this.points=points_||[],this._distances=[0];for(let i=1;i<this.points.length;i++)this._distances[i]=this._distances[i-1]+this.points[i].dist(this.points[i-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(padding_||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(1===this.points.length)return this.points[0];t=performance$1.clamp(t,0,1);let currentIndex=1,distOfCurrentIdx=this._distances[currentIndex];const distToTarget=t*this.paddedLength+this.padding;for(;distOfCurrentIdx<distToTarget&&currentIndex<this._distances.length;)distOfCurrentIdx=this._distances[++currentIndex];const idxOfPrevPoint=currentIndex-1,distOfPrevIdx=this._distances[idxOfPrevPoint],segmentLength=distOfCurrentIdx-distOfPrevIdx,segmentT=segmentLength>0?(distToTarget-distOfPrevIdx)/segmentLength:0;return this.points[idxOfPrevPoint].mult(1-segmentT).add(this.points[currentIndex].mult(segmentT))}}function overlapAllowed(overlapA,overlapB){let allowed=!0;return"always"===overlapA||"never"!==overlapA&&"never"!==overlapB||(allowed=!1),allowed}class GridIndex{constructor(width,height,cellSize){const boxCells=this.boxCells=[],circleCells=this.circleCells=[];this.xCellCount=Math.ceil(width/cellSize),this.yCellCount=Math.ceil(height/cellSize);for(let i=0;i<this.xCellCount*this.yCellCount;i++)boxCells.push([]),circleCells.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=width,this.height=height,this.xScale=this.xCellCount/width,this.yScale=this.yCellCount/height,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(key,x1,y1,x2,y2){this._forEachCell(x1,y1,x2,y2,this._insertBoxCell,this.boxUid++),this.boxKeys.push(key),this.bboxes.push(x1),this.bboxes.push(y1),this.bboxes.push(x2),this.bboxes.push(y2)}insertCircle(key,x,y,radius){this._forEachCell(x-radius,y-radius,x+radius,y+radius,this._insertCircleCell,this.circleUid++),this.circleKeys.push(key),this.circles.push(x),this.circles.push(y),this.circles.push(radius)}_insertBoxCell(x1,y1,x2,y2,cellIndex,uid){this.boxCells[cellIndex].push(uid)}_insertCircleCell(x1,y1,x2,y2,cellIndex,uid){this.circleCells[cellIndex].push(uid)}_query(x1,y1,x2,y2,hitTest,overlapMode,predicate){if(x2<0||x1>this.width||y2<0||y1>this.height)return[];const result=[];if(x1<=0&&y1<=0&&this.width<=x2&&this.height<=y2){if(hitTest)return[{key:null,x1:x1,y1:y1,x2:x2,y2:y2}];for(let boxUid=0;boxUid<this.boxKeys.length;boxUid++)result.push({key:this.boxKeys[boxUid],x1:this.bboxes[4*boxUid],y1:this.bboxes[4*boxUid+1],x2:this.bboxes[4*boxUid+2],y2:this.bboxes[4*boxUid+3]});for(let circleUid=0;circleUid<this.circleKeys.length;circleUid++){const x=this.circles[3*circleUid],y=this.circles[3*circleUid+1],radius=this.circles[3*circleUid+2];result.push({key:this.circleKeys[circleUid],x1:x-radius,y1:y-radius,x2:x+radius,y2:y+radius})}}else{const queryArgs={hitTest:hitTest,overlapMode:overlapMode,seenUids:{box:{},circle:{}}};this._forEachCell(x1,y1,x2,y2,this._queryCell,result,queryArgs,predicate)}return result}query(x1,y1,x2,y2){return this._query(x1,y1,x2,y2,!1,null)}hitTest(x1,y1,x2,y2,overlapMode,predicate){return this._query(x1,y1,x2,y2,!0,overlapMode,predicate).length>0}hitTestCircle(x,y,radius,overlapMode,predicate){const x1=x-radius,x2=x+radius,y1=y-radius,y2=y+radius;if(x2<0||x1>this.width||y2<0||y1>this.height)return!1;const result=[],queryArgs={hitTest:!0,overlapMode:overlapMode,circle:{x:x,y:y,radius:radius},seenUids:{box:{},circle:{}}};return this._forEachCell(x1,y1,x2,y2,this._queryCellCircle,result,queryArgs,predicate),result.length>0}_queryCell(x1,y1,x2,y2,cellIndex,result,queryArgs,predicate){const{seenUids:seenUids,hitTest:hitTest,overlapMode:overlapMode}=queryArgs,boxCell=this.boxCells[cellIndex];if(null!==boxCell){const bboxes=this.bboxes;for(const boxUid of boxCell)if(!seenUids.box[boxUid]){seenUids.box[boxUid]=!0;const offset=4*boxUid,key=this.boxKeys[boxUid];if(x1<=bboxes[offset+2]&&y1<=bboxes[offset+3]&&x2>=bboxes[offset+0]&&y2>=bboxes[offset+1]&&(!predicate||predicate(key))&&(!hitTest||!overlapAllowed(overlapMode,key.overlapMode))&&(result.push({key:key,x1:bboxes[offset],y1:bboxes[offset+1],x2:bboxes[offset+2],y2:bboxes[offset+3]}),hitTest))return!0}}const circleCell=this.circleCells[cellIndex];if(null!==circleCell){const circles=this.circles;for(const circleUid of circleCell)if(!seenUids.circle[circleUid]){seenUids.circle[circleUid]=!0;const offset=3*circleUid,key=this.circleKeys[circleUid];if(this._circleAndRectCollide(circles[offset],circles[offset+1],circles[offset+2],x1,y1,x2,y2)&&(!predicate||predicate(key))&&(!hitTest||!overlapAllowed(overlapMode,key.overlapMode))){const x=circles[offset],y=circles[offset+1],radius=circles[offset+2];if(result.push({key:key,x1:x-radius,y1:y-radius,x2:x+radius,y2:y+radius}),hitTest)return!0}}}return!1}_queryCellCircle(x1,y1,x2,y2,cellIndex,result,queryArgs,predicate){const{circle:circle,seenUids:seenUids,overlapMode:overlapMode}=queryArgs,boxCell=this.boxCells[cellIndex];if(null!==boxCell){const bboxes=this.bboxes;for(const boxUid of boxCell)if(!seenUids.box[boxUid]){seenUids.box[boxUid]=!0;const offset=4*boxUid,key=this.boxKeys[boxUid];if(this._circleAndRectCollide(circle.x,circle.y,circle.radius,bboxes[offset+0],bboxes[offset+1],bboxes[offset+2],bboxes[offset+3])&&(!predicate||predicate(key))&&!overlapAllowed(overlapMode,key.overlapMode))return result.push(!0),!0}}const circleCell=this.circleCells[cellIndex];if(null!==circleCell){const circles=this.circles;for(const circleUid of circleCell)if(!seenUids.circle[circleUid]){seenUids.circle[circleUid]=!0;const offset=3*circleUid,key=this.circleKeys[circleUid];if(this._circlesCollide(circles[offset],circles[offset+1],circles[offset+2],circle.x,circle.y,circle.radius)&&(!predicate||predicate(key))&&!overlapAllowed(overlapMode,key.overlapMode))return result.push(!0),!0}}}_forEachCell(x1,y1,x2,y2,fn,arg1,arg2,predicate){const cx1=this._convertToXCellCoord(x1),cy1=this._convertToYCellCoord(y1),cx2=this._convertToXCellCoord(x2),cy2=this._convertToYCellCoord(y2);for(let x=cx1;x<=cx2;x++)for(let y=cy1;y<=cy2;y++){const cellIndex=this.xCellCount*y+x;if(fn.call(this,x1,y1,x2,y2,cellIndex,arg1,arg2,predicate))return}}_convertToXCellCoord(x){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(x*this.xScale)))}_convertToYCellCoord(y){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(y*this.yScale)))}_circlesCollide(x1,y1,r1,x2,y2,r2){const dx=x2-x1,dy=y2-y1,bothRadii=r1+r2;return bothRadii*bothRadii>dx*dx+dy*dy}_circleAndRectCollide(circleX,circleY,radius,x1,y1,x2,y2){const halfRectWidth=(x2-x1)/2,distX=Math.abs(circleX-(x1+halfRectWidth));if(distX>halfRectWidth+radius)return!1;const halfRectHeight=(y2-y1)/2,distY=Math.abs(circleY-(y1+halfRectHeight));if(distY>halfRectHeight+radius)return!1;if(distX<=halfRectWidth||distY<=halfRectHeight)return!0;const dx=distX-halfRectWidth,dy=distY-halfRectHeight;return dx*dx+dy*dy<=radius*radius}}function getLabelPlaneMatrix(posMatrix,pitchWithMap,rotateWithMap,transform,pixelsToTileUnits){const m=performance$1.create();return pitchWithMap?(performance$1.scale(m,m,[1/pixelsToTileUnits,1/pixelsToTileUnits,1]),rotateWithMap||performance$1.rotateZ(m,m,transform.angle)):performance$1.multiply(m,transform.labelPlaneMatrix,posMatrix),m}function getGlCoordMatrix(posMatrix,pitchWithMap,rotateWithMap,transform,pixelsToTileUnits){if(pitchWithMap){const m=performance$1.clone(posMatrix);return performance$1.scale(m,m,[pixelsToTileUnits,pixelsToTileUnits,1]),rotateWithMap||performance$1.rotateZ(m,m,-transform.angle),m}return transform.glCoordMatrix}function project(point,matrix,getElevation){let pos;getElevation?(pos=[point.x,point.y,getElevation(point.x,point.y),1],performance$1.transformMat4(pos,pos,matrix)):(pos=[point.x,point.y,0,1],xyTransformMat4(pos,pos,matrix));const w=pos[3];return{point:new performance$1.Point(pos[0]/w,pos[1]/w),signedDistanceFromCamera:w}}function getPerspectiveRatio(cameraToCenterDistance,signedDistanceFromCamera){return.5+cameraToCenterDistance/signedDistanceFromCamera*.5}function isVisible(anchorPos,clippingBuffer){const x=anchorPos[0]/anchorPos[3],y=anchorPos[1]/anchorPos[3];return x>=-clippingBuffer[0]&&x<=clippingBuffer[0]&&y>=-clippingBuffer[1]&&y<=clippingBuffer[1]}function updateLineLabels(bucket,posMatrix,painter,isText,labelPlaneMatrix,glCoordMatrix,pitchWithMap,keepUpright,rotateToLine,getElevation){const sizeData=isText?bucket.textSizeData:bucket.iconSizeData,partiallyEvaluatedSize=performance$1.evaluateSizeForZoom(sizeData,painter.transform.zoom),clippingBuffer=[256/painter.width*2+1,256/painter.height*2+1],dynamicLayoutVertexArray=isText?bucket.text.dynamicLayoutVertexArray:bucket.icon.dynamicLayoutVertexArray;dynamicLayoutVertexArray.clear();const lineVertexArray=bucket.lineVertexArray,placedSymbols=isText?bucket.text.placedSymbolArray:bucket.icon.placedSymbolArray,aspectRatio=painter.transform.width/painter.transform.height;let useVertical=!1;for(let s=0;s<placedSymbols.length;s++){const symbol=placedSymbols.get(s);if(symbol.hidden||symbol.writingMode===performance$1.WritingMode.vertical&&!useVertical){hideGlyphs(symbol.numGlyphs,dynamicLayoutVertexArray);continue}let anchorPos;if(useVertical=!1,getElevation?(anchorPos=[symbol.anchorX,symbol.anchorY,getElevation(symbol.anchorX,symbol.anchorY),1],performance$1.transformMat4(anchorPos,anchorPos,posMatrix)):(anchorPos=[symbol.anchorX,symbol.anchorY,0,1],xyTransformMat4(anchorPos,anchorPos,posMatrix)),!isVisible(anchorPos,clippingBuffer)){hideGlyphs(symbol.numGlyphs,dynamicLayoutVertexArray);continue}const cameraToAnchorDistance=anchorPos[3],perspectiveRatio=getPerspectiveRatio(painter.transform.cameraToCenterDistance,cameraToAnchorDistance),fontSize=performance$1.evaluateSizeForFeature(sizeData,partiallyEvaluatedSize,symbol),pitchScaledFontSize=pitchWithMap?fontSize/perspectiveRatio:fontSize*perspectiveRatio,tileAnchorPoint=new performance$1.Point(symbol.anchorX,symbol.anchorY),anchorPoint=project(tileAnchorPoint,labelPlaneMatrix,getElevation).point,projectionCache={projections:{},offsets:{}},placeUnflipped=placeGlyphsAlongLine(symbol,pitchScaledFontSize,!1,keepUpright,posMatrix,labelPlaneMatrix,glCoordMatrix,bucket.glyphOffsetArray,lineVertexArray,dynamicLayoutVertexArray,anchorPoint,tileAnchorPoint,projectionCache,aspectRatio,rotateToLine,getElevation);useVertical=placeUnflipped.useVertical,(placeUnflipped.notEnoughRoom||useVertical||placeUnflipped.needsFlipping&&placeGlyphsAlongLine(symbol,pitchScaledFontSize,!0,keepUpright,posMatrix,labelPlaneMatrix,glCoordMatrix,bucket.glyphOffsetArray,lineVertexArray,dynamicLayoutVertexArray,anchorPoint,tileAnchorPoint,projectionCache,aspectRatio,rotateToLine,getElevation).notEnoughRoom)&&hideGlyphs(symbol.numGlyphs,dynamicLayoutVertexArray)}isText?bucket.text.dynamicLayoutVertexBuffer.updateData(dynamicLayoutVertexArray):bucket.icon.dynamicLayoutVertexBuffer.updateData(dynamicLayoutVertexArray)}function placeFirstAndLastGlyph(fontScale,glyphOffsetArray,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation){const glyphEndIndex=symbol.glyphStartIndex+symbol.numGlyphs,lineStartIndex=symbol.lineStartIndex,lineEndIndex=symbol.lineStartIndex+symbol.lineLength,firstGlyphOffset=glyphOffsetArray.getoffsetX(symbol.glyphStartIndex),lastGlyphOffset=glyphOffsetArray.getoffsetX(glyphEndIndex-1),firstPlacedGlyph=placeGlyphAlongLine(fontScale*firstGlyphOffset,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol.segment,lineStartIndex,lineEndIndex,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation);if(!firstPlacedGlyph)return null;const lastPlacedGlyph=placeGlyphAlongLine(fontScale*lastGlyphOffset,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol.segment,lineStartIndex,lineEndIndex,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation);return lastPlacedGlyph?{first:firstPlacedGlyph,last:lastPlacedGlyph}:null}function requiresOrientationChange(writingMode,firstPoint,lastPoint,aspectRatio){if(writingMode===performance$1.WritingMode.horizontal){if(Math.abs(lastPoint.y-firstPoint.y)>Math.abs(lastPoint.x-firstPoint.x)*aspectRatio)return{useVertical:!0}}return(writingMode===performance$1.WritingMode.vertical?firstPoint.y<lastPoint.y:firstPoint.x>lastPoint.x)?{needsFlipping:!0}:null}function placeGlyphsAlongLine(symbol,fontSize,flip,keepUpright,posMatrix,labelPlaneMatrix,glCoordMatrix,glyphOffsetArray,lineVertexArray,dynamicLayoutVertexArray,anchorPoint,tileAnchorPoint,projectionCache,aspectRatio,rotateToLine,getElevation){const fontScale=fontSize/24,lineOffsetX=symbol.lineOffsetX*fontScale,lineOffsetY=symbol.lineOffsetY*fontScale;let placedGlyphs;if(symbol.numGlyphs>1){const glyphEndIndex=symbol.glyphStartIndex+symbol.numGlyphs,lineStartIndex=symbol.lineStartIndex,lineEndIndex=symbol.lineStartIndex+symbol.lineLength,firstAndLastGlyph=placeFirstAndLastGlyph(fontScale,glyphOffsetArray,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation);if(!firstAndLastGlyph)return{notEnoughRoom:!0};const firstPoint=project(firstAndLastGlyph.first.point,glCoordMatrix,getElevation).point,lastPoint=project(firstAndLastGlyph.last.point,glCoordMatrix,getElevation).point;if(keepUpright&&!flip){const orientationChange=requiresOrientationChange(symbol.writingMode,firstPoint,lastPoint,aspectRatio);if(orientationChange)return orientationChange}placedGlyphs=[firstAndLastGlyph.first];for(let glyphIndex=symbol.glyphStartIndex+1;glyphIndex<glyphEndIndex-1;glyphIndex++)placedGlyphs.push(placeGlyphAlongLine(fontScale*glyphOffsetArray.getoffsetX(glyphIndex),lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol.segment,lineStartIndex,lineEndIndex,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation));placedGlyphs.push(firstAndLastGlyph.last)}else{if(keepUpright&&!flip){const a=project(tileAnchorPoint,posMatrix,getElevation).point,tileVertexIndex=symbol.lineStartIndex+symbol.segment+1,tileSegmentEnd=new performance$1.Point(lineVertexArray.getx(tileVertexIndex),lineVertexArray.gety(tileVertexIndex)),projectedVertex=project(tileSegmentEnd,posMatrix,getElevation),b=projectedVertex.signedDistanceFromCamera>0?projectedVertex.point:projectTruncatedLineSegment(tileAnchorPoint,tileSegmentEnd,a,1,posMatrix,getElevation),orientationChange=requiresOrientationChange(symbol.writingMode,a,b,aspectRatio);if(orientationChange)return orientationChange}const singleGlyph=placeGlyphAlongLine(fontScale*glyphOffsetArray.getoffsetX(symbol.glyphStartIndex),lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol.segment,symbol.lineStartIndex,symbol.lineStartIndex+symbol.lineLength,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation);if(!singleGlyph)return{notEnoughRoom:!0};placedGlyphs=[singleGlyph]}for(const glyph of placedGlyphs)performance$1.addDynamicAttributes(dynamicLayoutVertexArray,glyph.point,glyph.angle);return{}}function projectTruncatedLineSegment(previousTilePoint,currentTilePoint,previousProjectedPoint,minimumLength,projectionMatrix,getElevation){const projectedUnitVertex=project(previousTilePoint.add(previousTilePoint.sub(currentTilePoint)._unit()),projectionMatrix,getElevation).point,projectedUnitSegment=previousProjectedPoint.sub(projectedUnitVertex);return previousProjectedPoint.add(projectedUnitSegment._mult(minimumLength/projectedUnitSegment.mag()))}function projectVertexToViewport(index,projectionArgs){const{projectionCache:projectionCache,lineVertexArray:lineVertexArray,labelPlaneMatrix:labelPlaneMatrix,tileAnchorPoint:tileAnchorPoint,distanceFromAnchor:distanceFromAnchor,getElevation:getElevation,previousVertex:previousVertex,direction:direction,absOffsetX:absOffsetX}=projectionArgs;if(projectionCache.projections[index])return projectionCache.projections[index];const currentVertex=new performance$1.Point(lineVertexArray.getx(index),lineVertexArray.gety(index)),projection=project(currentVertex,labelPlaneMatrix,getElevation);if(projection.signedDistanceFromCamera>0)return projectionCache.projections[index]=projection.point,projection.point;const previousLineVertexIndex=index-direction;return projectTruncatedLineSegment(0===distanceFromAnchor?tileAnchorPoint:new performance$1.Point(lineVertexArray.getx(previousLineVertexIndex),lineVertexArray.gety(previousLineVertexIndex)),currentVertex,previousVertex,absOffsetX-distanceFromAnchor+1,labelPlaneMatrix,getElevation)}function transformToOffsetNormal(segmentVector,offset,direction){return segmentVector._unit()._perp()._mult(offset*direction)}function findOffsetIntersectionPoint(index,prevToCurrentOffsetNormal,currentVertex,lineStartIndex,lineEndIndex,offsetPreviousVertex,lineOffsetY,projectionArgs){const{projectionCache:projectionCache,direction:direction}=projectionArgs;if(projectionCache.offsets[index])return projectionCache.offsets[index];const offsetCurrentVertex=currentVertex.add(prevToCurrentOffsetNormal);if(index+direction<lineStartIndex||index+direction>=lineEndIndex)return projectionCache.offsets[index]=offsetCurrentVertex,offsetCurrentVertex;const nextVertex=projectVertexToViewport(index+direction,projectionArgs),currentToNextOffsetNormal=transformToOffsetNormal(nextVertex.sub(currentVertex),lineOffsetY,direction),offsetNextSegmentBegin=currentVertex.add(currentToNextOffsetNormal),offsetNextSegmentEnd=nextVertex.add(currentToNextOffsetNormal);return projectionCache.offsets[index]=performance$1.findLineIntersection(offsetPreviousVertex,offsetCurrentVertex,offsetNextSegmentBegin,offsetNextSegmentEnd)||offsetCurrentVertex,projectionCache.offsets[index]}function placeGlyphAlongLine(offsetX,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,anchorSegment,lineStartIndex,lineEndIndex,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation){const combinedOffsetX=flip?offsetX-lineOffsetX:offsetX+lineOffsetX;let direction=combinedOffsetX>0?1:-1,angle=0;flip&&(direction*=-1,angle=Math.PI),direction<0&&(angle+=Math.PI);let offsetIntersectionPoint,offsetPreviousVertex,currentIndex=direction>0?lineStartIndex+anchorSegment:lineStartIndex+anchorSegment+1,currentVertex=anchorPoint,previousVertex=anchorPoint,distanceFromAnchor=0,currentSegmentDistance=0;const absOffsetX=Math.abs(combinedOffsetX),pathVertices=[];let currentLineSegment;for(;distanceFromAnchor+currentSegmentDistance<=absOffsetX;){if(currentIndex+=direction,currentIndex<lineStartIndex||currentIndex>=lineEndIndex)return null;distanceFromAnchor+=currentSegmentDistance,previousVertex=currentVertex,offsetPreviousVertex=offsetIntersectionPoint;const projectionArgs={projectionCache:projectionCache,lineVertexArray:lineVertexArray,labelPlaneMatrix:labelPlaneMatrix,tileAnchorPoint:tileAnchorPoint,distanceFromAnchor:distanceFromAnchor,getElevation:getElevation,previousVertex:previousVertex,direction:direction,absOffsetX:absOffsetX};if(currentVertex=projectVertexToViewport(currentIndex,projectionArgs),0===lineOffsetY)pathVertices.push(previousVertex),currentLineSegment=currentVertex.sub(previousVertex);else{let prevToCurrentOffsetNormal;const prevToCurrent=currentVertex.sub(previousVertex);if(0===prevToCurrent.mag()){prevToCurrentOffsetNormal=transformToOffsetNormal(projectVertexToViewport(currentIndex+direction,projectionArgs).sub(currentVertex),lineOffsetY,direction)}else prevToCurrentOffsetNormal=transformToOffsetNormal(prevToCurrent,lineOffsetY,direction);offsetPreviousVertex||(offsetPreviousVertex=previousVertex.add(prevToCurrentOffsetNormal)),offsetIntersectionPoint=findOffsetIntersectionPoint(currentIndex,prevToCurrentOffsetNormal,currentVertex,lineStartIndex,lineEndIndex,offsetPreviousVertex,lineOffsetY,projectionArgs),pathVertices.push(offsetPreviousVertex),currentLineSegment=offsetIntersectionPoint.sub(offsetPreviousVertex)}currentSegmentDistance=currentLineSegment.mag()}const segmentInterpolationT=(absOffsetX-distanceFromAnchor)/currentSegmentDistance,p=currentLineSegment._mult(segmentInterpolationT)._add(offsetPreviousVertex||previousVertex),segmentAngle=angle+Math.atan2(currentVertex.y-previousVertex.y,currentVertex.x-previousVertex.x);return pathVertices.push(p),{point:p,angle:rotateToLine?segmentAngle:0,path:pathVertices}}const hiddenGlyphAttributes=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function hideGlyphs(num,dynamicLayoutVertexArray){for(let i=0;i<num;i++){const offset=dynamicLayoutVertexArray.length;dynamicLayoutVertexArray.resize(offset+4),dynamicLayoutVertexArray.float32.set(hiddenGlyphAttributes,3*offset)}}function xyTransformMat4(out,a,m){const x=a[0],y=a[1];return out[0]=m[0]*x+m[4]*y+m[12],out[1]=m[1]*x+m[5]*y+m[13],out[3]=m[3]*x+m[7]*y+m[15],out}class CollisionIndex{constructor(transform,grid=new GridIndex(transform.width+200,transform.height+200,25),ignoredGrid=new GridIndex(transform.width+200,transform.height+200,25)){this.transform=transform,this.grid=grid,this.ignoredGrid=ignoredGrid,this.pitchfactor=Math.cos(transform._pitch)*transform.cameraToCenterDistance,this.screenRightBoundary=transform.width+100,this.screenBottomBoundary=transform.height+100,this.gridRightBoundary=transform.width+200,this.gridBottomBoundary=transform.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(collisionBox,overlapMode,textPixelRatio,posMatrix,collisionGroupPredicate,getElevation){const projectedPoint=this.projectAndGetPerspectiveRatio(posMatrix,collisionBox.anchorPointX,collisionBox.anchorPointY,getElevation),tileToViewport=textPixelRatio*projectedPoint.perspectiveRatio,tlX=collisionBox.x1*tileToViewport+projectedPoint.point.x,tlY=collisionBox.y1*tileToViewport+projectedPoint.point.y,brX=collisionBox.x2*tileToViewport+projectedPoint.point.x,brY=collisionBox.y2*tileToViewport+projectedPoint.point.y;return!this.isInsideGrid(tlX,tlY,brX,brY)||"always"!==overlapMode&&this.grid.hitTest(tlX,tlY,brX,brY,overlapMode,collisionGroupPredicate)||projectedPoint.perspectiveRatio<this.perspectiveRatioCutoff?{box:[],offscreen:!1}:{box:[tlX,tlY,brX,brY],offscreen:this.isOffscreen(tlX,tlY,brX,brY)}}placeCollisionCircles(overlapMode,symbol,lineVertexArray,glyphOffsetArray,fontSize,posMatrix,labelPlaneMatrix,labelToScreenMatrix,showCollisionCircles,pitchWithMap,collisionGroupPredicate,circlePixelDiameter,textPixelPadding,getElevation){const placedCollisionCircles=[],tileUnitAnchorPoint=new performance$1.Point(symbol.anchorX,symbol.anchorY),screenAnchorPoint=project(tileUnitAnchorPoint,posMatrix,getElevation),perspectiveRatio=getPerspectiveRatio(this.transform.cameraToCenterDistance,screenAnchorPoint.signedDistanceFromCamera),labelPlaneFontScale=(pitchWithMap?fontSize/perspectiveRatio:fontSize*perspectiveRatio)/performance$1.ONE_EM,labelPlaneAnchorPoint=project(tileUnitAnchorPoint,labelPlaneMatrix,getElevation).point,firstAndLastGlyph=placeFirstAndLastGlyph(labelPlaneFontScale,glyphOffsetArray,symbol.lineOffsetX*labelPlaneFontScale,symbol.lineOffsetY*labelPlaneFontScale,!1,labelPlaneAnchorPoint,tileUnitAnchorPoint,symbol,lineVertexArray,labelPlaneMatrix,{projections:{},offsets:{}},!1,getElevation);let collisionDetected=!1,inGrid=!1,entirelyOffscreen=!0;if(firstAndLastGlyph){const radius=.5*circlePixelDiameter*perspectiveRatio+textPixelPadding,screenPlaneMin=new performance$1.Point(-100,-100),screenPlaneMax=new performance$1.Point(this.screenRightBoundary,this.screenBottomBoundary),interpolator=new PathInterpolator,first=firstAndLastGlyph.first,last=firstAndLastGlyph.last;let projectedPath=[];for(let i=first.path.length-1;i>=1;i--)projectedPath.push(first.path[i]);for(let i=1;i<last.path.length;i++)projectedPath.push(last.path[i]);const circleDist=2.5*radius;if(labelToScreenMatrix){const screenSpacePath=projectedPath.map((p=>project(p,labelToScreenMatrix,getElevation)));projectedPath=screenSpacePath.some((point=>point.signedDistanceFromCamera<=0))?[]:screenSpacePath.map((p=>p.point))}let segments=[];if(projectedPath.length>0){const minPoint=projectedPath[0].clone(),maxPoint=projectedPath[0].clone();for(let i=1;i<projectedPath.length;i++)minPoint.x=Math.min(minPoint.x,projectedPath[i].x),minPoint.y=Math.min(minPoint.y,projectedPath[i].y),maxPoint.x=Math.max(maxPoint.x,projectedPath[i].x),maxPoint.y=Math.max(maxPoint.y,projectedPath[i].y);segments=minPoint.x>=screenPlaneMin.x&&maxPoint.x<=screenPlaneMax.x&&minPoint.y>=screenPlaneMin.y&&maxPoint.y<=screenPlaneMax.y?[projectedPath]:maxPoint.x<screenPlaneMin.x||minPoint.x>screenPlaneMax.x||maxPoint.y<screenPlaneMin.y||minPoint.y>screenPlaneMax.y?[]:performance$1.clipLine([projectedPath],screenPlaneMin.x,screenPlaneMin.y,screenPlaneMax.x,screenPlaneMax.y)}for(const seg of segments){interpolator.reset(seg,.25*radius);let numCircles=0;numCircles=interpolator.length<=.5*radius?1:Math.ceil(interpolator.paddedLength/circleDist)+1;for(let i=0;i<numCircles;i++){const t=i/Math.max(numCircles-1,1),circlePosition=interpolator.lerp(t),centerX=circlePosition.x+100,centerY=circlePosition.y+100;placedCollisionCircles.push(centerX,centerY,radius,0);const x1=centerX-radius,y1=centerY-radius,x2=centerX+radius,y2=centerY+radius;if(entirelyOffscreen=entirelyOffscreen&&this.isOffscreen(x1,y1,x2,y2),inGrid=inGrid||this.isInsideGrid(x1,y1,x2,y2),"always"!==overlapMode&&this.grid.hitTestCircle(centerX,centerY,radius,overlapMode,collisionGroupPredicate)&&(collisionDetected=!0,!showCollisionCircles))return{circles:[],offscreen:!1,collisionDetected:collisionDetected}}}}return{circles:!showCollisionCircles&&collisionDetected||!inGrid||perspectiveRatio<this.perspectiveRatioCutoff?[]:placedCollisionCircles,offscreen:entirelyOffscreen,collisionDetected:collisionDetected}}queryRenderedSymbols(viewportQueryGeometry){if(0===viewportQueryGeometry.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const query=[];let minX=1/0,minY=1/0,maxX=-1/0,maxY=-1/0;for(const point of viewportQueryGeometry){const gridPoint=new performance$1.Point(point.x+100,point.y+100);minX=Math.min(minX,gridPoint.x),minY=Math.min(minY,gridPoint.y),maxX=Math.max(maxX,gridPoint.x),maxY=Math.max(maxY,gridPoint.y),query.push(gridPoint)}const features=this.grid.query(minX,minY,maxX,maxY).concat(this.ignoredGrid.query(minX,minY,maxX,maxY)),seenFeatures={},result={};for(const feature of features){const featureKey=feature.key;if(void 0===seenFeatures[featureKey.bucketInstanceId]&&(seenFeatures[featureKey.bucketInstanceId]={}),seenFeatures[featureKey.bucketInstanceId][featureKey.featureIndex])continue;const bbox=[new performance$1.Point(feature.x1,feature.y1),new performance$1.Point(feature.x2,feature.y1),new performance$1.Point(feature.x2,feature.y2),new performance$1.Point(feature.x1,feature.y2)];performance$1.polygonIntersectsPolygon(query,bbox)&&(seenFeatures[featureKey.bucketInstanceId][featureKey.featureIndex]=!0,void 0===result[featureKey.bucketInstanceId]&&(result[featureKey.bucketInstanceId]=[]),result[featureKey.bucketInstanceId].push(featureKey.featureIndex))}return result}insertCollisionBox(collisionBox,overlapMode,ignorePlacement,bucketInstanceId,featureIndex,collisionGroupID){const key={bucketInstanceId:bucketInstanceId,featureIndex:featureIndex,collisionGroupID:collisionGroupID,overlapMode:overlapMode};(ignorePlacement?this.ignoredGrid:this.grid).insert(key,collisionBox[0],collisionBox[1],collisionBox[2],collisionBox[3])}insertCollisionCircles(collisionCircles,overlapMode,ignorePlacement,bucketInstanceId,featureIndex,collisionGroupID){const grid=ignorePlacement?this.ignoredGrid:this.grid,key={bucketInstanceId:bucketInstanceId,featureIndex:featureIndex,collisionGroupID:collisionGroupID,overlapMode:overlapMode};for(let k=0;k<collisionCircles.length;k+=4)grid.insertCircle(key,collisionCircles[k],collisionCircles[k+1],collisionCircles[k+2])}projectAndGetPerspectiveRatio(posMatrix,x,y,getElevation){let p;getElevation?(p=[x,y,getElevation(x,y),1],performance$1.transformMat4(p,p,posMatrix)):(p=[x,y,0,1],xyTransformMat4(p,p,posMatrix));return{point:new performance$1.Point((p[0]/p[3]+1)/2*this.transform.width+100,(-p[1]/p[3]+1)/2*this.transform.height+100),perspectiveRatio:.5+this.transform.cameraToCenterDistance/p[3]*.5}}isOffscreen(x1,y1,x2,y2){return x2<100||x1>=this.screenRightBoundary||y2<100||y1>this.screenBottomBoundary}isInsideGrid(x1,y1,x2,y2){return x2>=0&&x1<this.gridRightBoundary&&y2>=0&&y1<this.gridBottomBoundary}getViewportMatrix(){const m=performance$1.identity([]);return performance$1.translate(m,m,[-100,-100,0]),m}}function pixelsToTileUnits(tile,pixelValue,z){return pixelValue*(performance$1.EXTENT/(tile.tileSize*Math.pow(2,z-tile.tileID.overscaledZ)))}class OpacityState{constructor(prevState,increment,placed,skipFade){this.opacity=prevState?Math.max(0,Math.min(1,prevState.opacity+(prevState.placed?increment:-increment))):skipFade&&placed?1:0,this.placed=placed}isHidden(){return 0===this.opacity&&!this.placed}}class JointOpacityState{constructor(prevState,increment,placedText,placedIcon,skipFade){this.text=new OpacityState(prevState?prevState.text:null,increment,placedText,skipFade),this.icon=new OpacityState(prevState?prevState.icon:null,increment,placedIcon,skipFade)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class JointPlacement{constructor(text,icon,skipFade){this.text=text,this.icon=icon,this.skipFade=skipFade}}class CollisionCircleArray{constructor(){this.invProjMatrix=performance$1.create(),this.viewportMatrix=performance$1.create(),this.circles=[]}}class RetainedQueryData{constructor(bucketInstanceId,featureIndex,sourceLayerIndex,bucketIndex,tileID){this.bucketInstanceId=bucketInstanceId,this.featureIndex=featureIndex,this.sourceLayerIndex=sourceLayerIndex,this.bucketIndex=bucketIndex,this.tileID=tileID}}class CollisionGroups{constructor(crossSourceCollisions){this.crossSourceCollisions=crossSourceCollisions,this.maxGroupID=0,this.collisionGroups={}}get(sourceID){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[sourceID]){const nextGroupID=++this.maxGroupID;this.collisionGroups[sourceID]={ID:nextGroupID,predicate:key=>key.collisionGroupID===nextGroupID}}return this.collisionGroups[sourceID]}}function calculateVariableLayoutShift(anchor,width,height,textOffset,textBoxScale){const{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}=performance$1.getAnchorAlignment(anchor),shiftX=-(horizontalAlign-.5)*width,shiftY=-(verticalAlign-.5)*height;return new performance$1.Point(shiftX+textOffset[0]*textBoxScale,shiftY+textOffset[1]*textBoxScale)}function shiftVariableCollisionBox(collisionBox,shiftX,shiftY,rotateWithMap,pitchWithMap,angle){const{x1:x1,x2:x2,y1:y1,y2:y2,anchorPointX:anchorPointX,anchorPointY:anchorPointY}=collisionBox,rotatedOffset=new performance$1.Point(shiftX,shiftY);return rotateWithMap&&rotatedOffset._rotate(pitchWithMap?angle:-angle),{x1:x1+rotatedOffset.x,y1:y1+rotatedOffset.y,x2:x2+rotatedOffset.x,y2:y2+rotatedOffset.y,anchorPointX:anchorPointX,anchorPointY:anchorPointY}}class Placement{constructor(transform,terrain,fadeDuration,crossSourceCollisions,prevPlacement){this.transform=transform.clone(),this.terrain=terrain,this.collisionIndex=new CollisionIndex(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=fadeDuration,this.retainedQueryData={},this.collisionGroups=new CollisionGroups(crossSourceCollisions),this.collisionCircleArrays={},this.prevPlacement=prevPlacement,prevPlacement&&(prevPlacement.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(results,styleLayer,tile,sortAcrossTiles){const symbolBucket=tile.getBucket(styleLayer),bucketFeatureIndex=tile.latestFeatureIndex;if(!symbolBucket||!bucketFeatureIndex||styleLayer.id!==symbolBucket.layerIds[0])return;const collisionBoxArray=tile.collisionBoxArray,layout=symbolBucket.layers[0].layout,scale=Math.pow(2,this.transform.zoom-tile.tileID.overscaledZ),textPixelRatio=tile.tileSize/performance$1.EXTENT,posMatrix=this.transform.calculatePosMatrix(tile.tileID.toUnwrapped()),pitchWithMap="map"===layout.get("text-pitch-alignment"),rotateWithMap="map"===layout.get("text-rotation-alignment"),pixelsToTiles=pixelsToTileUnits(tile,1,this.transform.zoom),textLabelPlaneMatrix=getLabelPlaneMatrix(posMatrix,pitchWithMap,rotateWithMap,this.transform,pixelsToTiles);let labelToScreenMatrix=null;if(pitchWithMap){const glMatrix=getGlCoordMatrix(posMatrix,pitchWithMap,rotateWithMap,this.transform,pixelsToTiles);labelToScreenMatrix=performance$1.multiply([],this.transform.labelPlaneMatrix,glMatrix)}this.retainedQueryData[symbolBucket.bucketInstanceId]=new RetainedQueryData(symbolBucket.bucketInstanceId,bucketFeatureIndex,symbolBucket.sourceLayerIndex,symbolBucket.index,tile.tileID);const parameters={bucket:symbolBucket,layout:layout,posMatrix:posMatrix,textLabelPlaneMatrix:textLabelPlaneMatrix,labelToScreenMatrix:labelToScreenMatrix,scale:scale,textPixelRatio:textPixelRatio,holdingForFade:tile.holdingForFade(),collisionBoxArray:collisionBoxArray,partiallyEvaluatedTextSize:performance$1.evaluateSizeForZoom(symbolBucket.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(symbolBucket.sourceID)};if(sortAcrossTiles)for(const range of symbolBucket.sortKeyRanges){const{sortKey:sortKey,symbolInstanceStart:symbolInstanceStart,symbolInstanceEnd:symbolInstanceEnd}=range;results.push({sortKey:sortKey,symbolInstanceStart:symbolInstanceStart,symbolInstanceEnd:symbolInstanceEnd,parameters:parameters})}else results.push({symbolInstanceStart:0,symbolInstanceEnd:symbolBucket.symbolInstances.length,parameters:parameters})}attemptAnchorPlacement(textAnchorOffset,textBox,width,height,textBoxScale,rotateWithMap,pitchWithMap,textPixelRatio,posMatrix,collisionGroup,textOverlapMode,symbolInstance,bucket,orientation,iconBox,getElevation){const anchor=performance$1.TextAnchorEnum[textAnchorOffset.textAnchor],textOffset=[textAnchorOffset.textOffset0,textAnchorOffset.textOffset1],shift=calculateVariableLayoutShift(anchor,width,height,textOffset,textBoxScale),placedGlyphBoxes=this.collisionIndex.placeCollisionBox(shiftVariableCollisionBox(textBox,shift.x,shift.y,rotateWithMap,pitchWithMap,this.transform.angle),textOverlapMode,textPixelRatio,posMatrix,collisionGroup.predicate,getElevation);if(iconBox){if(0===this.collisionIndex.placeCollisionBox(shiftVariableCollisionBox(iconBox,shift.x,shift.y,rotateWithMap,pitchWithMap,this.transform.angle),textOverlapMode,textPixelRatio,posMatrix,collisionGroup.predicate,getElevation).box.length)return}if(placedGlyphBoxes.box.length>0){let prevAnchor;if(this.prevPlacement&&this.prevPlacement.variableOffsets[symbolInstance.crossTileID]&&this.prevPlacement.placements[symbolInstance.crossTileID]&&this.prevPlacement.placements[symbolInstance.crossTileID].text&&(prevAnchor=this.prevPlacement.variableOffsets[symbolInstance.crossTileID].anchor),0===symbolInstance.crossTileID)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[symbolInstance.crossTileID]={textOffset:textOffset,width:width,height:height,anchor:anchor,textBoxScale:textBoxScale,prevAnchor:prevAnchor},this.markUsedJustification(bucket,anchor,symbolInstance,orientation),bucket.allowVerticalPlacement&&(this.markUsedOrientation(bucket,orientation,symbolInstance),this.placedOrientations[symbolInstance.crossTileID]=orientation),{shift:shift,placedGlyphBoxes:placedGlyphBoxes}}}placeLayerBucketPart(bucketPart,seenCrossTileIDs,showCollisionBoxes){const{bucket:bucket,layout:layout,posMatrix:posMatrix,textLabelPlaneMatrix:textLabelPlaneMatrix,labelToScreenMatrix:labelToScreenMatrix,textPixelRatio:textPixelRatio,holdingForFade:holdingForFade,collisionBoxArray:collisionBoxArray,partiallyEvaluatedTextSize:partiallyEvaluatedTextSize,collisionGroup:collisionGroup}=bucketPart.parameters,textOptional=layout.get("text-optional"),iconOptional=layout.get("icon-optional"),textOverlapMode=performance$1.getOverlapMode(layout,"text-overlap","text-allow-overlap"),textAlwaysOverlap="always"===textOverlapMode,iconOverlapMode=performance$1.getOverlapMode(layout,"icon-overlap","icon-allow-overlap"),iconAlwaysOverlap="always"===iconOverlapMode,rotateWithMap="map"===layout.get("text-rotation-alignment"),pitchWithMap="map"===layout.get("text-pitch-alignment"),hasIconTextFit="none"!==layout.get("icon-text-fit"),zOrderByViewportY="viewport-y"===layout.get("symbol-z-order"),alwaysShowText=textAlwaysOverlap&&(iconAlwaysOverlap||!bucket.hasIconData()||iconOptional),alwaysShowIcon=iconAlwaysOverlap&&(textAlwaysOverlap||!bucket.hasTextData()||textOptional);!bucket.collisionArrays&&collisionBoxArray&&bucket.deserializeCollisionBoxes(collisionBoxArray);const tileID=this.retainedQueryData[bucket.bucketInstanceId].tileID,getElevation=this.terrain?(x,y)=>this.terrain.getElevation(tileID,x,y):null,placeSymbol=(symbolInstance,collisionArrays)=>{var _a,_b;if(seenCrossTileIDs[symbolInstance.crossTileID])return;if(holdingForFade)return void(this.placements[symbolInstance.crossTileID]=new JointPlacement(!1,!1,!1));let placeText=!1,placeIcon=!1,offscreen=!0,shift=null,placed={box:null,offscreen:null},placedVerticalText={box:null,offscreen:null},placedGlyphBoxes=null,placedGlyphCircles=null,placedIconBoxes=null,textFeatureIndex=0,verticalTextFeatureIndex=0,iconFeatureIndex=0;collisionArrays.textFeatureIndex?textFeatureIndex=collisionArrays.textFeatureIndex:symbolInstance.useRuntimeCollisionCircles&&(textFeatureIndex=symbolInstance.featureIndex),collisionArrays.verticalTextFeatureIndex&&(verticalTextFeatureIndex=collisionArrays.verticalTextFeatureIndex);const textBox=collisionArrays.textBox;if(textBox){const updatePreviousOrientationIfNotPlaced=isPlaced=>{let previousOrientation=performance$1.WritingMode.horizontal;if(bucket.allowVerticalPlacement&&!isPlaced&&this.prevPlacement){const prevPlacedOrientation=this.prevPlacement.placedOrientations[symbolInstance.crossTileID];prevPlacedOrientation&&(this.placedOrientations[symbolInstance.crossTileID]=prevPlacedOrientation,previousOrientation=prevPlacedOrientation,this.markUsedOrientation(bucket,previousOrientation,symbolInstance))}return previousOrientation},placeTextForPlacementModes=(placeHorizontalFn,placeVerticalFn)=>{if(bucket.allowVerticalPlacement&&symbolInstance.numVerticalGlyphVertices>0&&collisionArrays.verticalTextBox){for(const placementMode of bucket.writingModes)if(placementMode===performance$1.WritingMode.vertical?(placed=placeVerticalFn(),placedVerticalText=placed):placed=placeHorizontalFn(),placed&&placed.box&&placed.box.length)break}else placed=placeHorizontalFn()},textAnchorOffsetStart=symbolInstance.textAnchorOffsetStartIndex,textAnchorOffsetEnd=symbolInstance.textAnchorOffsetEndIndex;if(textAnchorOffsetEnd===textAnchorOffsetStart){const placeBox=(collisionTextBox,orientation)=>{const placedFeature=this.collisionIndex.placeCollisionBox(collisionTextBox,textOverlapMode,textPixelRatio,posMatrix,collisionGroup.predicate,getElevation);return placedFeature&&placedFeature.box&&placedFeature.box.length&&(this.markUsedOrientation(bucket,orientation,symbolInstance),this.placedOrientations[symbolInstance.crossTileID]=orientation),placedFeature};placeTextForPlacementModes((()=>placeBox(textBox,performance$1.WritingMode.horizontal)),(()=>{const verticalTextBox=collisionArrays.verticalTextBox;return bucket.allowVerticalPlacement&&symbolInstance.numVerticalGlyphVertices>0&&verticalTextBox?placeBox(verticalTextBox,performance$1.WritingMode.vertical):{box:null,offscreen:null}})),updatePreviousOrientationIfNotPlaced(placed&&placed.box&&placed.box.length)}else{let prevAnchor=performance$1.TextAnchorEnum[null===(_b=null===(_a=this.prevPlacement)||void 0===_a?void 0:_a.variableOffsets[symbolInstance.crossTileID])||void 0===_b?void 0:_b.anchor];const placeBoxForVariableAnchors=(collisionTextBox,collisionIconBox,orientation)=>{const width=collisionTextBox.x2-collisionTextBox.x1,height=collisionTextBox.y2-collisionTextBox.y1,textBoxScale=symbolInstance.textBoxScale,variableIconBox=hasIconTextFit&&"never"===iconOverlapMode?collisionIconBox:null;let placedBox={box:[],offscreen:!1},placementPasses="never"===textOverlapMode?1:2,overlapMode="never";prevAnchor&&placementPasses++;for(let pass=0;pass<placementPasses;pass++){for(let i=textAnchorOffsetStart;i<textAnchorOffsetEnd;i++){const textAnchorOffset=bucket.textAnchorOffsets.get(i);if(prevAnchor&&textAnchorOffset.textAnchor!==prevAnchor)continue;const result=this.attemptAnchorPlacement(textAnchorOffset,collisionTextBox,width,height,textBoxScale,rotateWithMap,pitchWithMap,textPixelRatio,posMatrix,collisionGroup,overlapMode,symbolInstance,bucket,orientation,variableIconBox,getElevation);if(result&&(placedBox=result.placedGlyphBoxes,placedBox&&placedBox.box&&placedBox.box.length))return placeText=!0,shift=result.shift,placedBox}prevAnchor?prevAnchor=null:overlapMode=textOverlapMode}return placedBox};placeTextForPlacementModes((()=>placeBoxForVariableAnchors(textBox,collisionArrays.iconBox,performance$1.WritingMode.horizontal)),(()=>{const verticalTextBox=collisionArrays.verticalTextBox,wasPlaced=placed&&placed.box&&placed.box.length;return bucket.allowVerticalPlacement&&!wasPlaced&&symbolInstance.numVerticalGlyphVertices>0&&verticalTextBox?placeBoxForVariableAnchors(verticalTextBox,collisionArrays.verticalIconBox,performance$1.WritingMode.vertical):{box:null,offscreen:null}})),placed&&(placeText=placed.box,offscreen=placed.offscreen);const prevOrientation=updatePreviousOrientationIfNotPlaced(placed&&placed.box);if(!placeText&&this.prevPlacement){const prevOffset=this.prevPlacement.variableOffsets[symbolInstance.crossTileID];prevOffset&&(this.variableOffsets[symbolInstance.crossTileID]=prevOffset,this.markUsedJustification(bucket,prevOffset.anchor,symbolInstance,prevOrientation))}}}if(placedGlyphBoxes=placed,placeText=placedGlyphBoxes&&placedGlyphBoxes.box&&placedGlyphBoxes.box.length>0,offscreen=placedGlyphBoxes&&placedGlyphBoxes.offscreen,symbolInstance.useRuntimeCollisionCircles){const placedSymbol=bucket.text.placedSymbolArray.get(symbolInstance.centerJustifiedTextSymbolIndex),fontSize=performance$1.evaluateSizeForFeature(bucket.textSizeData,partiallyEvaluatedTextSize,placedSymbol),textPixelPadding=layout.get("text-padding"),circlePixelDiameter=symbolInstance.collisionCircleDiameter;placedGlyphCircles=this.collisionIndex.placeCollisionCircles(textOverlapMode,placedSymbol,bucket.lineVertexArray,bucket.glyphOffsetArray,fontSize,posMatrix,textLabelPlaneMatrix,labelToScreenMatrix,showCollisionBoxes,pitchWithMap,collisionGroup.predicate,circlePixelDiameter,textPixelPadding,getElevation),placedGlyphCircles.circles.length&&placedGlyphCircles.collisionDetected&&!showCollisionBoxes&&performance$1.warnOnce("Collisions detected, but collision boxes are not shown"),placeText=textAlwaysOverlap||placedGlyphCircles.circles.length>0&&!placedGlyphCircles.collisionDetected,offscreen=offscreen&&placedGlyphCircles.offscreen}if(collisionArrays.iconFeatureIndex&&(iconFeatureIndex=collisionArrays.iconFeatureIndex),collisionArrays.iconBox){const placeIconFeature=iconBox=>{const shiftedIconBox=hasIconTextFit&&shift?shiftVariableCollisionBox(iconBox,shift.x,shift.y,rotateWithMap,pitchWithMap,this.transform.angle):iconBox;return this.collisionIndex.placeCollisionBox(shiftedIconBox,iconOverlapMode,textPixelRatio,posMatrix,collisionGroup.predicate,getElevation)};placedVerticalText&&placedVerticalText.box&&placedVerticalText.box.length&&collisionArrays.verticalIconBox?(placedIconBoxes=placeIconFeature(collisionArrays.verticalIconBox),placeIcon=placedIconBoxes.box.length>0):(placedIconBoxes=placeIconFeature(collisionArrays.iconBox),placeIcon=placedIconBoxes.box.length>0),offscreen=offscreen&&placedIconBoxes.offscreen}const iconWithoutText=textOptional||0===symbolInstance.numHorizontalGlyphVertices&&0===symbolInstance.numVerticalGlyphVertices,textWithoutIcon=iconOptional||0===symbolInstance.numIconVertices;if(iconWithoutText||textWithoutIcon?textWithoutIcon?iconWithoutText||(placeIcon=placeIcon&&placeText):placeText=placeIcon&&placeText:placeIcon=placeText=placeIcon&&placeText,placeText&&placedGlyphBoxes&&placedGlyphBoxes.box&&(placedVerticalText&&placedVerticalText.box&&verticalTextFeatureIndex?this.collisionIndex.insertCollisionBox(placedGlyphBoxes.box,textOverlapMode,layout.get("text-ignore-placement"),bucket.bucketInstanceId,verticalTextFeatureIndex,collisionGroup.ID):this.collisionIndex.insertCollisionBox(placedGlyphBoxes.box,textOverlapMode,layout.get("text-ignore-placement"),bucket.bucketInstanceId,textFeatureIndex,collisionGroup.ID)),placeIcon&&placedIconBoxes&&this.collisionIndex.insertCollisionBox(placedIconBoxes.box,iconOverlapMode,layout.get("icon-ignore-placement"),bucket.bucketInstanceId,iconFeatureIndex,collisionGroup.ID),placedGlyphCircles&&(placeText&&this.collisionIndex.insertCollisionCircles(placedGlyphCircles.circles,textOverlapMode,layout.get("text-ignore-placement"),bucket.bucketInstanceId,textFeatureIndex,collisionGroup.ID),showCollisionBoxes)){const id=bucket.bucketInstanceId;let circleArray=this.collisionCircleArrays[id];void 0===circleArray&&(circleArray=this.collisionCircleArrays[id]=new CollisionCircleArray);for(let i=0;i<placedGlyphCircles.circles.length;i+=4)circleArray.circles.push(placedGlyphCircles.circles[i+0]),circleArray.circles.push(placedGlyphCircles.circles[i+1]),circleArray.circles.push(placedGlyphCircles.circles[i+2]),circleArray.circles.push(placedGlyphCircles.collisionDetected?1:0)}if(0===symbolInstance.crossTileID)throw new Error("symbolInstance.crossTileID can't be 0");if(0===bucket.bucketInstanceId)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[symbolInstance.crossTileID]=new JointPlacement(placeText||alwaysShowText,placeIcon||alwaysShowIcon,offscreen||bucket.justReloaded),seenCrossTileIDs[symbolInstance.crossTileID]=!0};if(zOrderByViewportY){if(0!==bucketPart.symbolInstanceStart)throw new Error("bucket.bucketInstanceId should be 0");const symbolIndexes=bucket.getSortedSymbolIndexes(this.transform.angle);for(let i=symbolIndexes.length-1;i>=0;--i){const symbolIndex=symbolIndexes[i];placeSymbol(bucket.symbolInstances.get(symbolIndex),bucket.collisionArrays[symbolIndex])}}else for(let i=bucketPart.symbolInstanceStart;i<bucketPart.symbolInstanceEnd;i++)placeSymbol(bucket.symbolInstances.get(i),bucket.collisionArrays[i]);if(showCollisionBoxes&&bucket.bucketInstanceId in this.collisionCircleArrays){const circleArray=this.collisionCircleArrays[bucket.bucketInstanceId];performance$1.invert(circleArray.invProjMatrix,posMatrix),circleArray.viewportMatrix=this.collisionIndex.getViewportMatrix()}bucket.justReloaded=!1}markUsedJustification(bucket,placedAnchor,symbolInstance,orientation){const justifications={left:symbolInstance.leftJustifiedTextSymbolIndex,center:symbolInstance.centerJustifiedTextSymbolIndex,right:symbolInstance.rightJustifiedTextSymbolIndex};let autoIndex;autoIndex=orientation===performance$1.WritingMode.vertical?symbolInstance.verticalPlacedTextSymbolIndex:justifications[performance$1.getAnchorJustification(placedAnchor)];const indexes=[symbolInstance.leftJustifiedTextSymbolIndex,symbolInstance.centerJustifiedTextSymbolIndex,symbolInstance.rightJustifiedTextSymbolIndex,symbolInstance.verticalPlacedTextSymbolIndex];for(const index of indexes)index>=0&&(bucket.text.placedSymbolArray.get(index).crossTileID=autoIndex>=0&&index!==autoIndex?0:symbolInstance.crossTileID)}markUsedOrientation(bucket,orientation,symbolInstance){const horizontal=orientation===performance$1.WritingMode.horizontal||orientation===performance$1.WritingMode.horizontalOnly?orientation:0,vertical=orientation===performance$1.WritingMode.vertical?orientation:0,horizontalIndexes=[symbolInstance.leftJustifiedTextSymbolIndex,symbolInstance.centerJustifiedTextSymbolIndex,symbolInstance.rightJustifiedTextSymbolIndex];for(const index of horizontalIndexes)bucket.text.placedSymbolArray.get(index).placedOrientation=horizontal;symbolInstance.verticalPlacedTextSymbolIndex&&(bucket.text.placedSymbolArray.get(symbolInstance.verticalPlacedTextSymbolIndex).placedOrientation=vertical)}commit(now){this.commitTime=now,this.zoomAtLastRecencyCheck=this.transform.zoom;const prevPlacement=this.prevPlacement;let placementChanged=!1;this.prevZoomAdjustment=prevPlacement?prevPlacement.zoomAdjustment(this.transform.zoom):0;const increment=prevPlacement?prevPlacement.symbolFadeChange(now):1,prevOpacities=prevPlacement?prevPlacement.opacities:{},prevOffsets=prevPlacement?prevPlacement.variableOffsets:{},prevOrientations=prevPlacement?prevPlacement.placedOrientations:{};for(const crossTileID in this.placements){const jointPlacement=this.placements[crossTileID],prevOpacity=prevOpacities[crossTileID];prevOpacity?(this.opacities[crossTileID]=new JointOpacityState(prevOpacity,increment,jointPlacement.text,jointPlacement.icon),placementChanged=placementChanged||jointPlacement.text!==prevOpacity.text.placed||jointPlacement.icon!==prevOpacity.icon.placed):(this.opacities[crossTileID]=new JointOpacityState(null,increment,jointPlacement.text,jointPlacement.icon,jointPlacement.skipFade),placementChanged=placementChanged||jointPlacement.text||jointPlacement.icon)}for(const crossTileID in prevOpacities){const prevOpacity=prevOpacities[crossTileID];if(!this.opacities[crossTileID]){const jointOpacity=new JointOpacityState(prevOpacity,increment,!1,!1);jointOpacity.isHidden()||(this.opacities[crossTileID]=jointOpacity,placementChanged=placementChanged||prevOpacity.text.placed||prevOpacity.icon.placed)}}for(const crossTileID in prevOffsets)this.variableOffsets[crossTileID]||!this.opacities[crossTileID]||this.opacities[crossTileID].isHidden()||(this.variableOffsets[crossTileID]=prevOffsets[crossTileID]);for(const crossTileID in prevOrientations)this.placedOrientations[crossTileID]||!this.opacities[crossTileID]||this.opacities[crossTileID].isHidden()||(this.placedOrientations[crossTileID]=prevOrientations[crossTileID]);if(prevPlacement&&void 0===prevPlacement.lastPlacementChangeTime)throw new Error("Last placement time for previous placement is not defined");placementChanged?this.lastPlacementChangeTime=now:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=prevPlacement?prevPlacement.lastPlacementChangeTime:now)}updateLayerOpacities(styleLayer,tiles){const seenCrossTileIDs={};for(const tile of tiles){const symbolBucket=tile.getBucket(styleLayer);symbolBucket&&tile.latestFeatureIndex&&styleLayer.id===symbolBucket.layerIds[0]&&this.updateBucketOpacities(symbolBucket,seenCrossTileIDs,tile.collisionBoxArray)}}updateBucketOpacities(bucket,seenCrossTileIDs,collisionBoxArray){bucket.hasTextData()&&(bucket.text.opacityVertexArray.clear(),bucket.text.hasVisibleVertices=!1),bucket.hasIconData()&&(bucket.icon.opacityVertexArray.clear(),bucket.icon.hasVisibleVertices=!1),bucket.hasIconCollisionBoxData()&&bucket.iconCollisionBox.collisionVertexArray.clear(),bucket.hasTextCollisionBoxData()&&bucket.textCollisionBox.collisionVertexArray.clear();const layer=bucket.layers[0],layout=layer.layout,duplicateOpacityState=new JointOpacityState(null,0,!1,!1,!0),textAllowOverlap=layout.get("text-allow-overlap"),iconAllowOverlap=layout.get("icon-allow-overlap"),hasVariablePlacement=layer._unevaluatedLayout.hasValue("text-variable-anchor")||layer._unevaluatedLayout.hasValue("text-variable-anchor-offset"),rotateWithMap="map"===layout.get("text-rotation-alignment"),pitchWithMap="map"===layout.get("text-pitch-alignment"),hasIconTextFit="none"!==layout.get("icon-text-fit"),defaultOpacityState=new JointOpacityState(null,0,textAllowOverlap&&(iconAllowOverlap||!bucket.hasIconData()||layout.get("icon-optional")),iconAllowOverlap&&(textAllowOverlap||!bucket.hasTextData()||layout.get("text-optional")),!0);!bucket.collisionArrays&&collisionBoxArray&&(bucket.hasIconCollisionBoxData()||bucket.hasTextCollisionBoxData())&&bucket.deserializeCollisionBoxes(collisionBoxArray);const addOpacities=(iconOrText,numVertices,opacity)=>{for(let i=0;i<numVertices/4;i++)iconOrText.opacityVertexArray.emplaceBack(opacity);iconOrText.hasVisibleVertices=iconOrText.hasVisibleVertices||opacity!==PACKED_HIDDEN_OPACITY};for(let s=0;s<bucket.symbolInstances.length;s++){const symbolInstance=bucket.symbolInstances.get(s),{numHorizontalGlyphVertices:numHorizontalGlyphVertices,numVerticalGlyphVertices:numVerticalGlyphVertices,crossTileID:crossTileID}=symbolInstance,isDuplicate=seenCrossTileIDs[crossTileID];let opacityState=this.opacities[crossTileID];isDuplicate?opacityState=duplicateOpacityState:opacityState||(opacityState=defaultOpacityState,this.opacities[crossTileID]=opacityState),seenCrossTileIDs[crossTileID]=!0;const hasText=numHorizontalGlyphVertices>0||numVerticalGlyphVertices>0,hasIcon=symbolInstance.numIconVertices>0,placedOrientation=this.placedOrientations[symbolInstance.crossTileID],horizontalHidden=placedOrientation===performance$1.WritingMode.vertical,verticalHidden=placedOrientation===performance$1.WritingMode.horizontal||placedOrientation===performance$1.WritingMode.horizontalOnly;if(hasText){const packedOpacity=packOpacity(opacityState.text),horizontalOpacity=horizontalHidden?PACKED_HIDDEN_OPACITY:packedOpacity;addOpacities(bucket.text,numHorizontalGlyphVertices,horizontalOpacity);const verticalOpacity=verticalHidden?PACKED_HIDDEN_OPACITY:packedOpacity;addOpacities(bucket.text,numVerticalGlyphVertices,verticalOpacity);const symbolHidden=opacityState.text.isHidden();[symbolInstance.rightJustifiedTextSymbolIndex,symbolInstance.centerJustifiedTextSymbolIndex,symbolInstance.leftJustifiedTextSymbolIndex].forEach((index=>{index>=0&&(bucket.text.placedSymbolArray.get(index).hidden=symbolHidden||horizontalHidden?1:0)})),symbolInstance.verticalPlacedTextSymbolIndex>=0&&(bucket.text.placedSymbolArray.get(symbolInstance.verticalPlacedTextSymbolIndex).hidden=symbolHidden||verticalHidden?1:0);const prevOffset=this.variableOffsets[symbolInstance.crossTileID];prevOffset&&this.markUsedJustification(bucket,prevOffset.anchor,symbolInstance,placedOrientation);const prevOrientation=this.placedOrientations[symbolInstance.crossTileID];prevOrientation&&(this.markUsedJustification(bucket,"left",symbolInstance,prevOrientation),this.markUsedOrientation(bucket,prevOrientation,symbolInstance))}if(hasIcon){const packedOpacity=packOpacity(opacityState.icon),useHorizontal=!(hasIconTextFit&&symbolInstance.verticalPlacedIconSymbolIndex&&horizontalHidden);if(symbolInstance.placedIconSymbolIndex>=0){const horizontalOpacity=useHorizontal?packedOpacity:PACKED_HIDDEN_OPACITY;addOpacities(bucket.icon,symbolInstance.numIconVertices,horizontalOpacity),bucket.icon.placedSymbolArray.get(symbolInstance.placedIconSymbolIndex).hidden=opacityState.icon.isHidden()}if(symbolInstance.verticalPlacedIconSymbolIndex>=0){const verticalOpacity=useHorizontal?PACKED_HIDDEN_OPACITY:packedOpacity;addOpacities(bucket.icon,symbolInstance.numVerticalIconVertices,verticalOpacity),bucket.icon.placedSymbolArray.get(symbolInstance.verticalPlacedIconSymbolIndex).hidden=opacityState.icon.isHidden()}}if(bucket.hasIconCollisionBoxData()||bucket.hasTextCollisionBoxData()){const collisionArrays=bucket.collisionArrays[s];if(collisionArrays){let shift=new performance$1.Point(0,0);if(collisionArrays.textBox||collisionArrays.verticalTextBox){let used=!0;if(hasVariablePlacement){const variableOffset=this.variableOffsets[crossTileID];variableOffset?(shift=calculateVariableLayoutShift(variableOffset.anchor,variableOffset.width,variableOffset.height,variableOffset.textOffset,variableOffset.textBoxScale),rotateWithMap&&shift._rotate(pitchWithMap?this.transform.angle:-this.transform.angle)):used=!1}collisionArrays.textBox&&updateCollisionVertices(bucket.textCollisionBox.collisionVertexArray,opacityState.text.placed,!used||horizontalHidden,shift.x,shift.y),collisionArrays.verticalTextBox&&updateCollisionVertices(bucket.textCollisionBox.collisionVertexArray,opacityState.text.placed,!used||verticalHidden,shift.x,shift.y)}const verticalIconUsed=Boolean(!verticalHidden&&collisionArrays.verticalIconBox);collisionArrays.iconBox&&updateCollisionVertices(bucket.iconCollisionBox.collisionVertexArray,opacityState.icon.placed,verticalIconUsed,hasIconTextFit?shift.x:0,hasIconTextFit?shift.y:0),collisionArrays.verticalIconBox&&updateCollisionVertices(bucket.iconCollisionBox.collisionVertexArray,opacityState.icon.placed,!verticalIconUsed,hasIconTextFit?shift.x:0,hasIconTextFit?shift.y:0)}}}if(bucket.sortFeatures(this.transform.angle),this.retainedQueryData[bucket.bucketInstanceId]&&(this.retainedQueryData[bucket.bucketInstanceId].featureSortOrder=bucket.featureSortOrder),bucket.hasTextData()&&bucket.text.opacityVertexBuffer&&bucket.text.opacityVertexBuffer.updateData(bucket.text.opacityVertexArray),bucket.hasIconData()&&bucket.icon.opacityVertexBuffer&&bucket.icon.opacityVertexBuffer.updateData(bucket.icon.opacityVertexArray),bucket.hasIconCollisionBoxData()&&bucket.iconCollisionBox.collisionVertexBuffer&&bucket.iconCollisionBox.collisionVertexBuffer.updateData(bucket.iconCollisionBox.collisionVertexArray),bucket.hasTextCollisionBoxData()&&bucket.textCollisionBox.collisionVertexBuffer&&bucket.textCollisionBox.collisionVertexBuffer.updateData(bucket.textCollisionBox.collisionVertexArray),bucket.text.opacityVertexArray.length!==bucket.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${bucket.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${bucket.text.layoutVertexArray.length}) / 4`);if(bucket.icon.opacityVertexArray.length!==bucket.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${bucket.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${bucket.icon.layoutVertexArray.length}) / 4`);if(bucket.bucketInstanceId in this.collisionCircleArrays){const instance=this.collisionCircleArrays[bucket.bucketInstanceId];bucket.placementInvProjMatrix=instance.invProjMatrix,bucket.placementViewportMatrix=instance.viewportMatrix,bucket.collisionCircleArray=instance.circles,delete this.collisionCircleArrays[bucket.bucketInstanceId]}}symbolFadeChange(now){return 0===this.fadeDuration?1:(now-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(zoom){return Math.max(0,(this.transform.zoom-zoom)/1.5)}hasTransitions(now){return this.stale||now-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(now,zoom){const durationAdjustment=this.zoomAtLastRecencyCheck===zoom?1-this.zoomAdjustment(zoom):1;return this.zoomAtLastRecencyCheck=zoom,this.commitTime+this.fadeDuration*durationAdjustment>now}setStale(){this.stale=!0}}function updateCollisionVertices(collisionVertexArray,placed,notUsed,shiftX,shiftY){collisionVertexArray.emplaceBack(placed?1:0,notUsed?1:0,shiftX||0,shiftY||0),collisionVertexArray.emplaceBack(placed?1:0,notUsed?1:0,shiftX||0,shiftY||0),collisionVertexArray.emplaceBack(placed?1:0,notUsed?1:0,shiftX||0,shiftY||0),collisionVertexArray.emplaceBack(placed?1:0,notUsed?1:0,shiftX||0,shiftY||0)}const shift25=Math.pow(2,25),shift24=Math.pow(2,24),shift17=Math.pow(2,17),shift16=Math.pow(2,16),shift9=Math.pow(2,9),shift8=Math.pow(2,8),shift1=Math.pow(2,1);function packOpacity(opacityState){if(0===opacityState.opacity&&!opacityState.placed)return 0;if(1===opacityState.opacity&&opacityState.placed)return 4294967295;const targetBit=opacityState.placed?1:0,opacityBits=Math.floor(127*opacityState.opacity);return opacityBits*shift25+targetBit*shift24+opacityBits*shift17+targetBit*shift16+opacityBits*shift9+targetBit*shift8+opacityBits*shift1+targetBit}const PACKED_HIDDEN_OPACITY=0;class LayerPlacement{constructor(styleLayer){this._sortAcrossTiles="viewport-y"!==styleLayer.layout.get("symbol-z-order")&&!styleLayer.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(tiles,placement,showCollisionBoxes,styleLayer,shouldPausePlacement){const bucketParts=this._bucketParts;for(;this._currentTileIndex<tiles.length;){const tile=tiles[this._currentTileIndex];if(placement.getBucketParts(bucketParts,styleLayer,tile,this._sortAcrossTiles),this._currentTileIndex++,shouldPausePlacement())return!0}for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,bucketParts.sort(((a,b)=>a.sortKey-b.sortKey)));this._currentPartIndex<bucketParts.length;){const bucketPart=bucketParts[this._currentPartIndex];if(placement.placeLayerBucketPart(bucketPart,this._seenCrossTileIDs,showCollisionBoxes),this._currentPartIndex++,shouldPausePlacement())return!0}return!1}}class PauseablePlacement{constructor(transform,terrain,order,forceFullPlacement,showCollisionBoxes,fadeDuration,crossSourceCollisions,prevPlacement){this.placement=new Placement(transform,terrain,fadeDuration,crossSourceCollisions,prevPlacement),this._currentPlacementIndex=order.length-1,this._forceFullPlacement=forceFullPlacement,this._showCollisionBoxes=showCollisionBoxes,this._done=!1}isDone(){return this._done}continuePlacement(order,layers,layerTiles){const startTime=browser.now(),shouldPausePlacement=()=>!this._forceFullPlacement&&browser.now()-startTime>2;for(;this._currentPlacementIndex>=0;){const layer=layers[order[this._currentPlacementIndex]],placementZoom=this.placement.collisionIndex.transform.zoom;if("symbol"===layer.type&&(!layer.minzoom||layer.minzoom<=placementZoom)&&(!layer.maxzoom||layer.maxzoom>placementZoom)){this._inProgressLayer||(this._inProgressLayer=new LayerPlacement(layer));if(this._inProgressLayer.continuePlacement(layerTiles[layer.source],this.placement,this._showCollisionBoxes,layer,shouldPausePlacement))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(now){return this.placement.commit(now),this.placement}}const roundingFactor=512/performance$1.EXTENT/2;class TileLayerIndex{constructor(tileID,symbolInstances,bucketInstanceId){this.tileID=tileID,this.bucketInstanceId=bucketInstanceId,this._symbolsByKey={};const symbolInstancesByKey=new Map;for(let i=0;i<symbolInstances.length;i++){const symbolInstance=symbolInstances.get(i),key=symbolInstance.key,instances=symbolInstancesByKey.get(key);instances?instances.push(symbolInstance):symbolInstancesByKey.set(key,[symbolInstance])}for(const[key,symbols]of symbolInstancesByKey){const entry={positions:symbols.map((symbolInstance=>({x:Math.floor(symbolInstance.anchorX*roundingFactor),y:Math.floor(symbolInstance.anchorY*roundingFactor)}))),crossTileIDs:symbols.map((v=>v.crossTileID))};if(entry.positions.length>128){const index=new performance$1.KDBush(entry.positions.length,16,Uint16Array);for(const{x:x,y:y}of entry.positions)index.add(x,y);index.finish(),delete entry.positions,entry.index=index}this._symbolsByKey[key]=entry}}getScaledCoordinates(symbolInstance,childTileID){const{x:localX,y:localY,z:localZ}=this.tileID.canonical,{x:x,y:y,z:z}=childTileID.canonical,zDifference=z-localZ,scale=roundingFactor/Math.pow(2,zDifference),xWorld=(x*performance$1.EXTENT+symbolInstance.anchorX)*scale,yWorld=(y*performance$1.EXTENT+symbolInstance.anchorY)*scale,xOffset=localX*performance$1.EXTENT*roundingFactor,yOffset=localY*performance$1.EXTENT*roundingFactor;return{x:Math.floor(xWorld-xOffset),y:Math.floor(yWorld-yOffset)}}findMatches(symbolInstances,newTileID,zoomCrossTileIDs){const tolerance=this.tileID.canonical.z<newTileID.canonical.z?1:Math.pow(2,this.tileID.canonical.z-newTileID.canonical.z);for(let i=0;i<symbolInstances.length;i++){const symbolInstance=symbolInstances.get(i);if(symbolInstance.crossTileID)continue;const entry=this._symbolsByKey[symbolInstance.key];if(!entry)continue;const scaledSymbolCoord=this.getScaledCoordinates(symbolInstance,newTileID);if(entry.index){const indexes=entry.index.range(scaledSymbolCoord.x-tolerance,scaledSymbolCoord.y-tolerance,scaledSymbolCoord.x+tolerance,scaledSymbolCoord.y+tolerance).sort();for(const i of indexes){const crossTileID=entry.crossTileIDs[i];if(!zoomCrossTileIDs[crossTileID]){zoomCrossTileIDs[crossTileID]=!0,symbolInstance.crossTileID=crossTileID;break}}}else if(entry.positions)for(let i=0;i<entry.positions.length;i++){const thisTileSymbol=entry.positions[i],crossTileID=entry.crossTileIDs[i];if(Math.abs(thisTileSymbol.x-scaledSymbolCoord.x)<=tolerance&&Math.abs(thisTileSymbol.y-scaledSymbolCoord.y)<=tolerance&&!zoomCrossTileIDs[crossTileID]){zoomCrossTileIDs[crossTileID]=!0,symbolInstance.crossTileID=crossTileID;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map((({crossTileIDs:crossTileIDs})=>crossTileIDs))}}class CrossTileIDs{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class CrossTileSymbolLayerIndex{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(lng){const wrapDelta=Math.round((lng-this.lng)/360);if(0!==wrapDelta)for(const zoom in this.indexes){const zoomIndexes=this.indexes[zoom],newZoomIndex={};for(const key in zoomIndexes){const index=zoomIndexes[key];index.tileID=index.tileID.unwrapTo(index.tileID.wrap+wrapDelta),newZoomIndex[index.tileID.key]=index}this.indexes[zoom]=newZoomIndex}this.lng=lng}addBucket(tileID,bucket,crossTileIDs){if(this.indexes[tileID.overscaledZ]&&this.indexes[tileID.overscaledZ][tileID.key]){if(this.indexes[tileID.overscaledZ][tileID.key].bucketInstanceId===bucket.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(tileID.overscaledZ,this.indexes[tileID.overscaledZ][tileID.key])}for(let i=0;i<bucket.symbolInstances.length;i++){bucket.symbolInstances.get(i).crossTileID=0}this.usedCrossTileIDs[tileID.overscaledZ]||(this.usedCrossTileIDs[tileID.overscaledZ]={});const zoomCrossTileIDs=this.usedCrossTileIDs[tileID.overscaledZ];for(const zoom in this.indexes){const zoomIndexes=this.indexes[zoom];if(Number(zoom)>tileID.overscaledZ)for(const id in zoomIndexes){const childIndex=zoomIndexes[id];childIndex.tileID.isChildOf(tileID)&&childIndex.findMatches(bucket.symbolInstances,tileID,zoomCrossTileIDs)}else{const parentIndex=zoomIndexes[tileID.scaledTo(Number(zoom)).key];parentIndex&&parentIndex.findMatches(bucket.symbolInstances,tileID,zoomCrossTileIDs)}}for(let i=0;i<bucket.symbolInstances.length;i++){const symbolInstance=bucket.symbolInstances.get(i);symbolInstance.crossTileID||(symbolInstance.crossTileID=crossTileIDs.generate(),zoomCrossTileIDs[symbolInstance.crossTileID]=!0)}return void 0===this.indexes[tileID.overscaledZ]&&(this.indexes[tileID.overscaledZ]={}),this.indexes[tileID.overscaledZ][tileID.key]=new TileLayerIndex(tileID,bucket.symbolInstances,bucket.bucketInstanceId),!0}removeBucketCrossTileIDs(zoom,removedBucket){for(const crossTileIDs of removedBucket.getCrossTileIDsLists())for(const crossTileID of crossTileIDs)delete this.usedCrossTileIDs[zoom][crossTileID]}removeStaleBuckets(currentIDs){let tilesChanged=!1;for(const z in this.indexes){const zoomIndexes=this.indexes[z];for(const tileKey in zoomIndexes)currentIDs[zoomIndexes[tileKey].bucketInstanceId]||(this.removeBucketCrossTileIDs(z,zoomIndexes[tileKey]),delete zoomIndexes[tileKey],tilesChanged=!0)}return tilesChanged}}class CrossTileSymbolIndex{constructor(){this.layerIndexes={},this.crossTileIDs=new CrossTileIDs,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(styleLayer,tiles,lng){let layerIndex=this.layerIndexes[styleLayer.id];void 0===layerIndex&&(layerIndex=this.layerIndexes[styleLayer.id]=new CrossTileSymbolLayerIndex);let symbolBucketsChanged=!1;const currentBucketIDs={};layerIndex.handleWrapJump(lng);for(const tile of tiles){const symbolBucket=tile.getBucket(styleLayer);symbolBucket&&styleLayer.id===symbolBucket.layerIds[0]&&(symbolBucket.bucketInstanceId||(symbolBucket.bucketInstanceId=++this.maxBucketInstanceId),layerIndex.addBucket(tile.tileID,symbolBucket,this.crossTileIDs)&&(symbolBucketsChanged=!0),currentBucketIDs[symbolBucket.bucketInstanceId]=!0)}return layerIndex.removeStaleBuckets(currentBucketIDs)&&(symbolBucketsChanged=!0),symbolBucketsChanged}pruneUnusedLayers(usedLayers){const usedLayerMap={};usedLayers.forEach((usedLayer=>{usedLayerMap[usedLayer]=!0}));for(const layerId in this.layerIndexes)usedLayerMap[layerId]||delete this.layerIndexes[layerId]}}const emitValidationErrors=(evented,errors)=>performance$1.emitValidationErrors(evented,errors&&errors.filter((error=>"source.canvas"!==error.identifier))),empty=performance$1.emptyStyle();class Style extends performance$1.Evented{constructor(map,options={}){super(),this._rtlTextPluginStateChange=()=>{for(const id in this.sourceCaches){const sourceType=this.sourceCaches[id].getSource().type;"vector"!==sourceType&&"geojson"!==sourceType||this.sourceCaches[id].reload()}},this.map=map,this.dispatcher=new Dispatcher(getGlobalWorkerPool(),map._getMapId()),this.dispatcher.registerMessageHandler("getGlyphs",((mapId,params)=>this.getGlyphs(mapId,params))),this.dispatcher.registerMessageHandler("getImages",((mapId,params)=>this.getImages(mapId,params))),this.imageManager=new ImageManager,this.imageManager.setEventedParent(this),this.glyphManager=new GlyphManager(map._requestManager,options.localIdeographFontFamily),this.lineAtlas=new LineAtlas(256,512),this.crossTileSymbolIndex=new CrossTileSymbolIndex,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new performance$1.ZoomHistory,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("setReferrer",performance$1.getReferrer()),rtlMainThreadPluginFactory().on("pluginStateChange",this._rtlTextPluginStateChange),this.on("data",(event=>{if("source"!==event.dataType||"metadata"!==event.sourceDataType)return;const sourceCache=this.sourceCaches[event.sourceId];if(!sourceCache)return;const source=sourceCache.getSource();if(source&&source.vectorLayerIds)for(const layerId in this._layers){const layer=this._layers[layerId];layer.source===source.id&&this._validateLayer(layer)}}))}loadURL(url,options={},previousStyle){this.fire(new performance$1.Event("dataloading",{dataType:"style"})),options.validate="boolean"!=typeof options.validate||options.validate;const request=this.map._requestManager.transformRequest(url,ResourceType.Style);this._loadStyleRequest=new AbortController,performance$1.getJSON(request,this._loadStyleRequest).then((response=>{this._loadStyleRequest=null,this._load(response.data,options,previousStyle)})).catch((error=>{this._loadStyleRequest=null,error&&this.fire(new performance$1.ErrorEvent(error))}))}loadJSON(json,options={},previousStyle){this.fire(new performance$1.Event("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,browser.frameAsync(this._frameRequest).then((()=>{this._frameRequest=null,options.validate=!1!==options.validate,this._load(json,options,previousStyle)})).catch((()=>{}))}loadEmpty(){this.fire(new performance$1.Event("dataloading",{dataType:"style"})),this._load(empty,{validate:!1})}_load(json,options,previousStyle){var _a;const nextState=options.transformStyle?options.transformStyle(previousStyle,json):json;if(!options.validate||!emitValidationErrors(this,performance$1.validateStyle(nextState))){this._loaded=!0,this.stylesheet=nextState;for(const id in nextState.sources)this.addSource(id,nextState.sources[id],{validate:!1});nextState.sprite?this._loadSprite(nextState.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(nextState.glyphs),this._createLayers(),this.light=new Light(this.stylesheet.light),this.map.setTerrain(null!==(_a=this.stylesheet.terrain)&&void 0!==_a?_a:null),this.fire(new performance$1.Event("data",{dataType:"style"})),this.fire(new performance$1.Event("style.load"))}}_createLayers(){const dereferencedLayers=performance$1.derefLayers(this.stylesheet.layers);this.dispatcher.broadcast("setLayers",dereferencedLayers),this._order=dereferencedLayers.map((layer=>layer.id)),this._layers={},this._serializedLayers=null;for(const layer of dereferencedLayers){const styledLayer=performance$1.createStyleLayer(layer);styledLayer.setEventedParent(this,{layer:{id:layer.id}}),this._layers[layer.id]=styledLayer}}_loadSprite(sprite,isUpdate=!1,completion=void 0){let err;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,loadSprite(sprite,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then((images=>{if(this._spriteRequest=null,images)for(const spriteId in images){this._spritesImagesIds[spriteId]=[];const imagesToRemove=this._spritesImagesIds[spriteId]?this._spritesImagesIds[spriteId].filter((id=>!(id in images))):[];for(const id of imagesToRemove)this.imageManager.removeImage(id),this._changedImages[id]=!0;for(const id in images[spriteId]){const imageId="default"===spriteId?id:`${spriteId}:${id}`;this._spritesImagesIds[spriteId].push(imageId),imageId in this.imageManager.images?this.imageManager.updateImage(imageId,images[spriteId][id],!1):this.imageManager.addImage(imageId,images[spriteId][id]),isUpdate&&(this._changedImages[imageId]=!0)}}})).catch((error=>{this._spriteRequest=null,err=error,this.fire(new performance$1.ErrorEvent(err))})).finally((()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),isUpdate&&(this._changed=!0),this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new performance$1.Event("data",{dataType:"style"})),completion&&completion(err)}))}_unloadSprite(){for(const id of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(id),this._changedImages[id]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new performance$1.Event("data",{dataType:"style"}))}_validateLayer(layer){const sourceCache=this.sourceCaches[layer.source];if(!sourceCache)return;const sourceLayer=layer.sourceLayer;if(!sourceLayer)return;const source=sourceCache.getSource();("geojson"===source.type||source.vectorLayerIds&&-1===source.vectorLayerIds.indexOf(sourceLayer))&&this.fire(new performance$1.ErrorEvent(new Error(`Source layer "${sourceLayer}" does not exist on source "${source.id}" as specified by style layer "${layer.id}".`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._updatedSources).length)return!1;for(const id in this.sourceCaches)if(!this.sourceCaches[id].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(ids){const serializedLayersDictionary=this._serializedAllLayers();if(!ids||0===ids.length)return Object.values(serializedLayersDictionary);const serializedLayers=[];for(const id of ids)serializedLayersDictionary[id]&&serializedLayers.push(serializedLayersDictionary[id]);return serializedLayers}_serializedAllLayers(){let serializedLayers=this._serializedLayers;if(serializedLayers)return serializedLayers;serializedLayers=this._serializedLayers={};const allLayerIds=Object.keys(this._layers);for(const layerId of allLayerIds){const layer=this._layers[layerId];"custom"!==layer.type&&(serializedLayers[layerId]=layer.serialize())}return serializedLayers}hasTransitions(){if(this.light&&this.light.hasTransition())return!0;for(const id in this.sourceCaches)if(this.sourceCaches[id].hasTransition())return!0;for(const id in this._layers)if(this._layers[id].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(parameters){if(!this._loaded)return;const changed=this._changed;if(this._changed){const updatedIds=Object.keys(this._updatedLayers),removedIds=Object.keys(this._removedLayers);(updatedIds.length||removedIds.length)&&this._updateWorkerLayers(updatedIds,removedIds);for(const id in this._updatedSources){const action=this._updatedSources[id];if("reload"===action)this._reloadSource(id);else{if("clear"!==action)throw new Error(`Invalid action ${action}`);this._clearSource(id)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const id in this._updatedPaintProps)this._layers[id].updateTransitions(parameters);this.light.updateTransitions(parameters),this._resetUpdates()}const sourcesUsedBefore={};for(const sourceId in this.sourceCaches){const sourceCache=this.sourceCaches[sourceId];sourcesUsedBefore[sourceId]=sourceCache.used,sourceCache.used=!1}for(const layerId of this._order){const layer=this._layers[layerId];layer.recalculate(parameters,this._availableImages),!layer.isHidden(parameters.zoom)&&layer.source&&(this.sourceCaches[layer.source].used=!0)}for(const sourceId in sourcesUsedBefore){const sourceCache=this.sourceCaches[sourceId];sourcesUsedBefore[sourceId]!==sourceCache.used&&sourceCache.fire(new performance$1.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:sourceId}))}this.light.recalculate(parameters),this.z=parameters.zoom,changed&&this.fire(new performance$1.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const changedImages=Object.keys(this._changedImages);if(changedImages.length){for(const name in this.sourceCaches)this.sourceCaches[name].reloadTilesForDependencies(["icons","patterns"],changedImages);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const name in this.sourceCaches)this.sourceCaches[name].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(updatedIds,removedIds){this.dispatcher.broadcast("updateLayers",{layers:this._serializeByIds(updatedIds),removedIds:removedIds})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(nextState,options={}){var _a;this._checkLoaded();const serializedStyle=this.serialize();nextState=options.transformStyle?options.transformStyle(serializedStyle,nextState):nextState;if((null===(_a=options.validate)||void 0===_a||_a)&&emitValidationErrors(this,performance$1.validateStyle(nextState)))return!1;(nextState=performance$1.clone$1(nextState)).layers=performance$1.derefLayers(nextState.layers);const changes=performance$1.diffStyles(serializedStyle,nextState),operations=this._getOperationsToPerform(changes);if(operations.unimplemented.length>0)throw new Error(`Unimplemented: ${operations.unimplemented.join(", ")}.`);if(0===operations.operations.length)return!1;for(const styleChangeOperation of operations.operations)styleChangeOperation();return this.stylesheet=nextState,this._serializedLayers=null,!0}_getOperationsToPerform(diff){const operations=[],unimplemented=[];for(const op of diff)switch(op.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":continue;case"addLayer":operations.push((()=>this.addLayer.apply(this,op.args)));break;case"removeLayer":operations.push((()=>this.removeLayer.apply(this,op.args)));break;case"setPaintProperty":operations.push((()=>this.setPaintProperty.apply(this,op.args)));break;case"setLayoutProperty":operations.push((()=>this.setLayoutProperty.apply(this,op.args)));break;case"setFilter":operations.push((()=>this.setFilter.apply(this,op.args)));break;case"addSource":operations.push((()=>this.addSource.apply(this,op.args)));break;case"removeSource":operations.push((()=>this.removeSource.apply(this,op.args)));break;case"setLayerZoomRange":operations.push((()=>this.setLayerZoomRange.apply(this,op.args)));break;case"setLight":operations.push((()=>this.setLight.apply(this,op.args)));break;case"setGeoJSONSourceData":operations.push((()=>this.setGeoJSONSourceData.apply(this,op.args)));break;case"setGlyphs":operations.push((()=>this.setGlyphs.apply(this,op.args)));break;case"setSprite":operations.push((()=>this.setSprite.apply(this,op.args)));break;case"setTerrain":operations.push((()=>this.map.setTerrain.apply(this,op.args)));break;case"setTransition":operations.push((()=>{}));break;default:unimplemented.push(op.command)}return{operations:operations,unimplemented:unimplemented}}addImage(id,image){if(this.getImage(id))return this.fire(new performance$1.ErrorEvent(new Error(`An image named "${id}" already exists.`)));this.imageManager.addImage(id,image),this._afterImageUpdated(id)}updateImage(id,image){this.imageManager.updateImage(id,image)}getImage(id){return this.imageManager.getImage(id)}removeImage(id){if(!this.getImage(id))return this.fire(new performance$1.ErrorEvent(new Error(`An image named "${id}" does not exist.`)));this.imageManager.removeImage(id),this._afterImageUpdated(id)}_afterImageUpdated(id){this._availableImages=this.imageManager.listImages(),this._changedImages[id]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new performance$1.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(id,source,options={}){if(this._checkLoaded(),void 0!==this.sourceCaches[id])throw new Error(`Source "${id}" already exists.`);if(!source.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(source).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(source.type)>=0&&this._validate(performance$1.validateStyle.source,`sources.${id}`,source,null,options))return;this.map&&this.map._collectResourceTiming&&(source.collectResourceTiming=!0);const sourceCache=this.sourceCaches[id]=new SourceCache(id,source,this.dispatcher);sourceCache.style=this,sourceCache.setEventedParent(this,(()=>({isSourceLoaded:sourceCache.loaded(),source:sourceCache.serialize(),sourceId:id}))),sourceCache.onAdd(this.map),this._changed=!0}removeSource(id){if(this._checkLoaded(),void 0===this.sourceCaches[id])throw new Error("There is no source with this ID");for(const layerId in this._layers)if(this._layers[layerId].source===id)return this.fire(new performance$1.ErrorEvent(new Error(`Source "${id}" cannot be removed while layer "${layerId}" is using it.`)));const sourceCache=this.sourceCaches[id];delete this.sourceCaches[id],delete this._updatedSources[id],sourceCache.fire(new performance$1.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:id})),sourceCache.setEventedParent(null),sourceCache.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(id,data){if(this._checkLoaded(),void 0===this.sourceCaches[id])throw new Error(`There is no source with this ID=${id}`);const geojsonSource=this.sourceCaches[id].getSource();if("geojson"!==geojsonSource.type)throw new Error(`geojsonSource.type is ${geojsonSource.type}, which is !== 'geojson`);geojsonSource.setData(data),this._changed=!0}getSource(id){return this.sourceCaches[id]&&this.sourceCaches[id].getSource()}addLayer(layerObject,before,options={}){this._checkLoaded();const id=layerObject.id;if(this.getLayer(id))return void this.fire(new performance$1.ErrorEvent(new Error(`Layer "${id}" already exists on this map.`)));let layer;if("custom"===layerObject.type){if(emitValidationErrors(this,performance$1.validateCustomStyleLayer(layerObject)))return;layer=performance$1.createStyleLayer(layerObject)}else{if("source"in layerObject&&"object"==typeof layerObject.source&&(this.addSource(id,layerObject.source),layerObject=performance$1.clone$1(layerObject),layerObject=performance$1.extend(layerObject,{source:id})),this._validate(performance$1.validateStyle.layer,`layers.${id}`,layerObject,{arrayIndex:-1},options))return;layer=performance$1.createStyleLayer(layerObject),this._validateLayer(layer),layer.setEventedParent(this,{layer:{id:id}})}const index=before?this._order.indexOf(before):this._order.length;if(before&&-1===index)this.fire(new performance$1.ErrorEvent(new Error(`Cannot add layer "${id}" before non-existing layer "${before}".`)));else{if(this._order.splice(index,0,id),this._layerOrderChanged=!0,this._layers[id]=layer,this._removedLayers[id]&&layer.source&&"custom"!==layer.type){const removed=this._removedLayers[id];delete this._removedLayers[id],removed.type!==layer.type?this._updatedSources[layer.source]="clear":(this._updatedSources[layer.source]="reload",this.sourceCaches[layer.source].pause())}this._updateLayer(layer),layer.onAdd&&layer.onAdd(this.map)}}moveLayer(id,before){this._checkLoaded(),this._changed=!0;if(!this._layers[id])return void this.fire(new performance$1.ErrorEvent(new Error(`The layer '${id}' does not exist in the map's style and cannot be moved.`)));if(id===before)return;const index=this._order.indexOf(id);this._order.splice(index,1);const newIndex=before?this._order.indexOf(before):this._order.length;before&&-1===newIndex?this.fire(new performance$1.ErrorEvent(new Error(`Cannot move layer "${id}" before non-existing layer "${before}".`))):(this._order.splice(newIndex,0,id),this._layerOrderChanged=!0)}removeLayer(id){this._checkLoaded();const layer=this._layers[id];if(!layer)return void this.fire(new performance$1.ErrorEvent(new Error(`Cannot remove non-existing layer "${id}".`)));layer.setEventedParent(null);const index=this._order.indexOf(id);this._order.splice(index,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[id]=layer,delete this._layers[id],this._serializedLayers&&delete this._serializedLayers[id],delete this._updatedLayers[id],delete this._updatedPaintProps[id],layer.onRemove&&layer.onRemove(this.map)}getLayer(id){return this._layers[id]}getLayersOrder(){return[...this._order]}hasLayer(id){return id in this._layers}setLayerZoomRange(layerId,minzoom,maxzoom){this._checkLoaded();const layer=this.getLayer(layerId);layer?layer.minzoom===minzoom&&layer.maxzoom===maxzoom||(null!=minzoom&&(layer.minzoom=minzoom),null!=maxzoom&&(layer.maxzoom=maxzoom),this._updateLayer(layer)):this.fire(new performance$1.ErrorEvent(new Error(`Cannot set the zoom range of non-existing layer "${layerId}".`)))}setFilter(layerId,filter,options={}){this._checkLoaded();const layer=this.getLayer(layerId);if(layer){if(!performance$1.deepEqual(layer.filter,filter))return null==filter?(layer.filter=void 0,void this._updateLayer(layer)):void(this._validate(performance$1.validateStyle.filter,`layers.${layer.id}.filter`,filter,null,options)||(layer.filter=performance$1.clone$1(filter),this._updateLayer(layer)))}else this.fire(new performance$1.ErrorEvent(new Error(`Cannot filter non-existing layer "${layerId}".`)))}getFilter(layer){return performance$1.clone$1(this.getLayer(layer).filter)}setLayoutProperty(layerId,name,value,options={}){this._checkLoaded();const layer=this.getLayer(layerId);layer?performance$1.deepEqual(layer.getLayoutProperty(name),value)||(layer.setLayoutProperty(name,value,options),this._updateLayer(layer)):this.fire(new performance$1.ErrorEvent(new Error(`Cannot style non-existing layer "${layerId}".`)))}getLayoutProperty(layerId,name){const layer=this.getLayer(layerId);if(layer)return layer.getLayoutProperty(name);this.fire(new performance$1.ErrorEvent(new Error(`Cannot get style of non-existing layer "${layerId}".`)))}setPaintProperty(layerId,name,value,options={}){this._checkLoaded();const layer=this.getLayer(layerId);if(!layer)return void this.fire(new performance$1.ErrorEvent(new Error(`Cannot style non-existing layer "${layerId}".`)));if(performance$1.deepEqual(layer.getPaintProperty(name),value))return;layer.setPaintProperty(name,value,options)&&this._updateLayer(layer),this._changed=!0,this._updatedPaintProps[layerId]=!0}getPaintProperty(layer,name){return this.getLayer(layer).getPaintProperty(name)}setFeatureState(target,state){this._checkLoaded();const sourceId=target.source,sourceLayer=target.sourceLayer,sourceCache=this.sourceCaches[sourceId];if(void 0===sourceCache)return void this.fire(new performance$1.ErrorEvent(new Error(`The source '${sourceId}' does not exist in the map's style.`)));const sourceType=sourceCache.getSource().type;"geojson"===sourceType&&sourceLayer?this.fire(new performance$1.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):"vector"!==sourceType||sourceLayer?(void 0===target.id&&this.fire(new performance$1.ErrorEvent(new Error("The feature id parameter must be provided."))),sourceCache.setFeatureState(sourceLayer,target.id,state)):this.fire(new performance$1.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(target,key){this._checkLoaded();const sourceId=target.source,sourceCache=this.sourceCaches[sourceId];if(void 0===sourceCache)return void this.fire(new performance$1.ErrorEvent(new Error(`The source '${sourceId}' does not exist in the map's style.`)));const sourceType=sourceCache.getSource().type,sourceLayer="vector"===sourceType?target.sourceLayer:void 0;"vector"!==sourceType||sourceLayer?key&&"string"!=typeof target.id&&"number"!=typeof target.id?this.fire(new performance$1.ErrorEvent(new Error("A feature id is required to remove its specific state property."))):sourceCache.removeFeatureState(sourceLayer,target.id,key):this.fire(new performance$1.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(target){this._checkLoaded();const sourceId=target.source,sourceLayer=target.sourceLayer,sourceCache=this.sourceCaches[sourceId];if(void 0===sourceCache)return void this.fire(new performance$1.ErrorEvent(new Error(`The source '${sourceId}' does not exist in the map's style.`)));if("vector"!==sourceCache.getSource().type||sourceLayer)return void 0===target.id&&this.fire(new performance$1.ErrorEvent(new Error("The feature id parameter must be provided."))),sourceCache.getFeatureState(sourceLayer,target.id);this.fire(new performance$1.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}getTransition(){return performance$1.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const sources=performance$1.mapObject(this.sourceCaches,(source=>source.serialize())),layers=this._serializeByIds(this._order),terrain=this.map.getTerrain()||void 0,myStyleSheet=this.stylesheet;return performance$1.filterObject({version:myStyleSheet.version,name:myStyleSheet.name,metadata:myStyleSheet.metadata,light:myStyleSheet.light,center:myStyleSheet.center,zoom:myStyleSheet.zoom,bearing:myStyleSheet.bearing,pitch:myStyleSheet.pitch,sprite:myStyleSheet.sprite,glyphs:myStyleSheet.glyphs,transition:myStyleSheet.transition,sources:sources,layers:layers,terrain:terrain},(value=>void 0!==value))}_updateLayer(layer){this._updatedLayers[layer.id]=!0,layer.source&&!this._updatedSources[layer.source]&&"raster"!==this.sourceCaches[layer.source].getSource().type&&(this._updatedSources[layer.source]="reload",this.sourceCaches[layer.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(sourceResults){const isLayer3D=layerId=>"fill-extrusion"===this._layers[layerId].type,layerIndex={},features3D=[];for(let l=this._order.length-1;l>=0;l--){const layerId=this._order[l];if(isLayer3D(layerId)){layerIndex[layerId]=l;for(const sourceResult of sourceResults){const layerFeatures=sourceResult[layerId];if(layerFeatures)for(const featureWrapper of layerFeatures)features3D.push(featureWrapper)}}}features3D.sort(((a,b)=>b.intersectionZ-a.intersectionZ));const features=[];for(let l=this._order.length-1;l>=0;l--){const layerId=this._order[l];if(isLayer3D(layerId))for(let i=features3D.length-1;i>=0;i--){const topmost3D=features3D[i].feature;if(layerIndex[topmost3D.layer.id]<l)break;features.push(topmost3D),features3D.pop()}else for(const sourceResult of sourceResults){const layerFeatures=sourceResult[layerId];if(layerFeatures)for(const featureWrapper of layerFeatures)features.push(featureWrapper.feature)}}return features}queryRenderedFeatures(queryGeometry,params,transform){params&&params.filter&&this._validate(performance$1.validateStyle.filter,"queryRenderedFeatures.filter",params.filter,null,params);const includedSources={};if(params&&params.layers){if(!Array.isArray(params.layers))return this.fire(new performance$1.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const layerId of params.layers){const layer=this._layers[layerId];if(!layer)return this.fire(new performance$1.ErrorEvent(new Error(`The layer '${layerId}' does not exist in the map's style and cannot be queried for features.`))),[];includedSources[layer.source]=!0}}const sourceResults=[];params.availableImages=this._availableImages;const serializedLayers=this._serializedAllLayers();for(const id in this.sourceCaches)params.layers&&!includedSources[id]||sourceResults.push(queryRenderedFeatures(this.sourceCaches[id],this._layers,serializedLayers,queryGeometry,params,transform));return this.placement&&sourceResults.push(function(styleLayers,serializedLayers,sourceCaches,queryGeometry,params,collisionIndex,retainedQueryData){const result={},renderedSymbols=collisionIndex.queryRenderedSymbols(queryGeometry),bucketQueryData=[];for(const bucketInstanceId of Object.keys(renderedSymbols).map(Number))bucketQueryData.push(retainedQueryData[bucketInstanceId]);bucketQueryData.sort(sortTilesIn);for(const queryData of bucketQueryData){const bucketSymbols=queryData.featureIndex.lookupSymbolFeatures(renderedSymbols[queryData.bucketInstanceId],serializedLayers,queryData.bucketIndex,queryData.sourceLayerIndex,params.filter,params.layers,params.availableImages,styleLayers);for(const layerID in bucketSymbols){const resultFeatures=result[layerID]=result[layerID]||[],layerSymbols=bucketSymbols[layerID];layerSymbols.sort(((a,b)=>{const featureSortOrder=queryData.featureSortOrder;if(featureSortOrder){const sortedA=featureSortOrder.indexOf(a.featureIndex);return featureSortOrder.indexOf(b.featureIndex)-sortedA}return b.featureIndex-a.featureIndex}));for(const symbolFeature of layerSymbols)resultFeatures.push(symbolFeature)}}for(const layerName in result)result[layerName].forEach((featureWrapper=>{const feature=featureWrapper.feature,layer=styleLayers[layerName],state=sourceCaches[layer.source].getFeatureState(feature.layer["source-layer"],feature.id);feature.source=feature.layer.source,feature.layer["source-layer"]&&(feature.sourceLayer=feature.layer["source-layer"]),feature.state=state}));return result}(this._layers,serializedLayers,this.sourceCaches,queryGeometry,params,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(sourceResults)}querySourceFeatures(sourceID,params){params&&params.filter&&this._validate(performance$1.validateStyle.filter,"querySourceFeatures.filter",params.filter,null,params);const sourceCache=this.sourceCaches[sourceID];return sourceCache?function(sourceCache,params){const tiles=sourceCache.getRenderableIds().map((id=>sourceCache.getTileByID(id))),result=[],dataTiles={};for(let i=0;i<tiles.length;i++){const tile=tiles[i],dataID=tile.tileID.canonical.key;dataTiles[dataID]||(dataTiles[dataID]=!0,tile.querySourceFeatures(result,params))}return result}(sourceCache,params):[]}getLight(){return this.light.getLight()}setLight(lightOptions,options={}){this._checkLoaded();const light=this.light.getLight();let _update=!1;for(const key in lightOptions)if(!performance$1.deepEqual(lightOptions[key],light[key])){_update=!0;break}if(!_update)return;const parameters={now:browser.now(),transition:performance$1.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(lightOptions,options),this.light.updateTransitions(parameters)}_validate(validate,key,value,props,options={}){return(!options||!1!==options.validate)&&emitValidationErrors(this,validate.call(performance$1.validateStyle,performance$1.extend({key:key,style:this.serialize(),value:value,styleSpec:performance$1.v8Spec},props)))}_remove(mapRemoved=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),rtlMainThreadPluginFactory().off("pluginStateChange",this._rtlTextPluginStateChange);for(const layerId in this._layers){this._layers[layerId].setEventedParent(null)}for(const id in this.sourceCaches){const sourceCache=this.sourceCaches[id];sourceCache.setEventedParent(null),sourceCache.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove(mapRemoved)}_clearSource(id){this.sourceCaches[id].clearTiles()}_reloadSource(id){this.sourceCaches[id].resume(),this.sourceCaches[id].reload()}_updateSources(transform){for(const id in this.sourceCaches)this.sourceCaches[id].update(transform,this.map.terrain)}_generateCollisionBoxes(){for(const id in this.sourceCaches)this._reloadSource(id)}_updatePlacement(transform,showCollisionBoxes,fadeDuration,crossSourceCollisions,forceFullPlacement=!1){let symbolBucketsChanged=!1,placementCommitted=!1;const layerTiles={};for(const layerID of this._order){const styleLayer=this._layers[layerID];if("symbol"!==styleLayer.type)continue;if(!layerTiles[styleLayer.source]){const sourceCache=this.sourceCaches[styleLayer.source];layerTiles[styleLayer.source]=sourceCache.getRenderableIds(!0).map((id=>sourceCache.getTileByID(id))).sort(((a,b)=>b.tileID.overscaledZ-a.tileID.overscaledZ||(a.tileID.isLessThan(b.tileID)?-1:1)))}const layerBucketsChanged=this.crossTileSymbolIndex.addLayer(styleLayer,layerTiles[styleLayer.source],transform.center.lng);symbolBucketsChanged=symbolBucketsChanged||layerBucketsChanged}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((forceFullPlacement=forceFullPlacement||this._layerOrderChanged||0===fadeDuration)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(browser.now(),transform.zoom))&&(this.pauseablePlacement=new PauseablePlacement(transform,this.map.terrain,this._order,forceFullPlacement,showCollisionBoxes,fadeDuration,crossSourceCollisions,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,layerTiles),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(browser.now()),placementCommitted=!0),symbolBucketsChanged&&this.pauseablePlacement.placement.setStale()),placementCommitted||symbolBucketsChanged)for(const layerID of this._order){const styleLayer=this._layers[layerID];"symbol"===styleLayer.type&&this.placement.updateLayerOpacities(styleLayer,layerTiles[styleLayer.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(browser.now())}_releaseSymbolFadeTiles(){for(const id in this.sourceCaches)this.sourceCaches[id].releaseSymbolFadeTiles()}getImages(mapId,params){return performance$1.__awaiter(this,void 0,void 0,(function*(){const images=yield this.imageManager.getImages(params.icons);this._updateTilesForChangedImages();const sourceCache=this.sourceCaches[params.source];return sourceCache&&sourceCache.setDependencies(params.tileID.key,params.type,params.icons),images}))}getGlyphs(mapId,params){return performance$1.__awaiter(this,void 0,void 0,(function*(){const glypgs=yield this.glyphManager.getGlyphs(params.stacks),sourceCache=this.sourceCaches[params.source];return sourceCache&&sourceCache.setDependencies(params.tileID.key,params.type,[""]),glypgs}))}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(glyphsUrl,options={}){this._checkLoaded(),glyphsUrl&&this._validate(performance$1.validateStyle.glyphs,"glyphs",glyphsUrl,null,options)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=glyphsUrl,this.glyphManager.entries={},this.glyphManager.setURL(glyphsUrl))}addSprite(id,url,options={},completion){this._checkLoaded();const spriteToAdd=[{id:id,url:url}],updatedSprite=[...coerceSpriteToArray(this.stylesheet.sprite),...spriteToAdd];this._validate(performance$1.validateStyle.sprite,"sprite",updatedSprite,null,options)||(this.stylesheet.sprite=updatedSprite,this._loadSprite(spriteToAdd,!0,completion))}removeSprite(id){this._checkLoaded();const internalSpriteRepresentation=coerceSpriteToArray(this.stylesheet.sprite);if(internalSpriteRepresentation.find((sprite=>sprite.id===id))){if(this._spritesImagesIds[id])for(const imageId of this._spritesImagesIds[id])this.imageManager.removeImage(imageId),this._changedImages[imageId]=!0;internalSpriteRepresentation.splice(internalSpriteRepresentation.findIndex((sprite=>sprite.id===id)),1),this.stylesheet.sprite=internalSpriteRepresentation.length>0?internalSpriteRepresentation:void 0,delete this._spritesImagesIds[id],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new performance$1.Event("data",{dataType:"style"}))}else this.fire(new performance$1.ErrorEvent(new Error(`Sprite "${id}" doesn't exists on this map.`)))}getSprite(){return coerceSpriteToArray(this.stylesheet.sprite)}setSprite(sprite,options={},completion){this._checkLoaded(),sprite&&this._validate(performance$1.validateStyle.sprite,"sprite",sprite,null,options)||(this.stylesheet.sprite=sprite,sprite?this._loadSprite(sprite,!0,completion):(this._unloadSprite(),completion&&completion(null)))}}var posAttributes=performance$1.createLayout([{name:"a_pos",type:"Int16",components:2}]),terrainVert="attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;varying float v_depth;void main() {float extent=8192.0;float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/extent;gl_Position=u_matrix*vec4(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta,1.0);v_depth=gl_Position.z/gl_Position.w;}";const shaders={prelude:compile("#ifdef GL_ES\nprecision mediump float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif\n","#ifdef GL_ES\nprecision highp float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}\n#ifdef TERRAIN3D\nuniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;\n#endif\nconst highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {\n#ifdef TERRAIN3D\nhighp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));\n#else\nreturn 1.0;\n#endif\n}float calculate_visibility(vec4 pos) {\n#ifdef TERRAIN3D\nvec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;\n#else\nreturn 1.0;\n#endif\n}float ele(vec2 pos) {\n#ifdef TERRAIN3D\nvec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;\n#else\nreturn 0.0;\n#endif\n}float get_elevation(vec2 pos) {\n#ifdef TERRAIN3D\nvec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;\n#else\nreturn 0.0;\n#endif\n}"),background:compile("uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),backgroundPattern:compile("uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:compile("varying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);}"),clippingMask:compile("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:compile("uniform highp float u_intensity;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,0,1);gl_Position=u_matrix*pos;}"),heatmapTexture:compile("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(0.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:compile("varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}","attribute vec2 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_anchor_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);gl_Position=u_matrix*vec4(a_pos,get_elevation(a_pos),1.0);gl_Position.xy+=(a_extrude+a_shift)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:compile("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:compile("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}"),fill:compile("#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_FragColor=color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);}"),fillOutline:compile("varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}"),fillOutlinePattern:compile("uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}"),fillPattern:compile("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}"),fillExtrusion:compile("varying vec4 v_color;void main() {gl_FragColor=v_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;\n#ifdef TERRAIN3D\nattribute vec2 a_centroid;\n#endif\nvarying vec4 v_color;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\nvec3 normal=a_normal_ed.xyz;\n#ifdef TERRAIN3D\nfloat height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);\n#else\nfloat height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;\n#endif\nbase=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}"),fillExtrusionPattern:compile("uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;\n#ifdef TERRAIN3D\nattribute vec2 a_centroid;\n#endif\nvarying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;\n#ifdef TERRAIN3D\nfloat height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);\n#else\nfloat height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;\n#endif\nbase=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0\n? a_pos\n: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}"),hillshadePrepare:compile("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:compile("uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;\n#define PI 3.141592653589793\nvoid main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}"),line:compile("uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_width2=vec2(outset,inset);}"),lineGradient:compile("uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_width2=vec2(outset,inset);}"),linePattern:compile("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\nattribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}"),lineSDF:compile("uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\nattribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}"),raster:compile("uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:compile("uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nlowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0),z,1.0);v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}"),symbolSDF:compile("#define SDF_PX 8.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}"),symbolTextAndIcon:compile("#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}"),terrain:compile("uniform sampler2D u_texture;varying vec2 v_texture_pos;void main() {gl_FragColor=texture2D(u_texture,v_texture_pos);}",terrainVert),terrainDepth:compile("varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}",terrainVert),terrainCoords:compile("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}",terrainVert)};function compile(fragmentSource,vertexSource){const re=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,staticAttributes=vertexSource.match(/attribute ([\w]+) ([\w]+)/g),fragmentUniforms=fragmentSource.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),vertexUniforms=vertexSource.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),staticUniforms=vertexUniforms?vertexUniforms.concat(fragmentUniforms):fragmentUniforms,fragmentPragmas={};return fragmentSource=fragmentSource.replace(re,((match,operation,precision,type,name)=>(fragmentPragmas[name]=!0,"define"===operation?`\n#ifndef HAS_UNIFORM_u_${name}\nvarying ${precision} ${type} ${name};\n#else\nuniform ${precision} ${type} u_${name};\n#endif\n`:`\n#ifdef HAS_UNIFORM_u_${name}\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`))),vertexSource=vertexSource.replace(re,((match,operation,precision,type,name)=>{const attrType="float"===type?"vec2":"vec4",unpackType=name.match(/color/)?"color":attrType;return fragmentPragmas[name]?"define"===operation?`\n#ifndef HAS_UNIFORM_u_${name}\nuniform lowp float u_${name}_t;\nattribute ${precision} ${attrType} a_${name};\nvarying ${precision} ${type} ${name};\n#else\nuniform ${precision} ${type} u_${name};\n#endif\n`:"vec4"===unpackType?`\n#ifndef HAS_UNIFORM_u_${name}\n    ${name} = a_${name};\n#else\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${name}\n    ${name} = unpack_mix_${unpackType}(a_${name}, u_${name}_t);\n#else\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`:"define"===operation?`\n#ifndef HAS_UNIFORM_u_${name}\nuniform lowp float u_${name}_t;\nattribute ${precision} ${attrType} a_${name};\n#else\nuniform ${precision} ${type} u_${name};\n#endif\n`:"vec4"===unpackType?`\n#ifndef HAS_UNIFORM_u_${name}\n    ${precision} ${type} ${name} = a_${name};\n#else\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${name}\n    ${precision} ${type} ${name} = unpack_mix_${unpackType}(a_${name}, u_${name}_t);\n#else\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`})),{fragmentSource:fragmentSource,vertexSource:vertexSource,staticAttributes:staticAttributes,staticUniforms:staticUniforms}}class VertexArrayObject{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(context,program,layoutVertexBuffer,paintVertexBuffers,indexBuffer,vertexOffset,dynamicVertexBuffer,dynamicVertexBuffer2,dynamicVertexBuffer3){this.context=context;let paintBuffersDiffer=this.boundPaintVertexBuffers.length!==paintVertexBuffers.length;for(let i=0;!paintBuffersDiffer&&i<paintVertexBuffers.length;i++)this.boundPaintVertexBuffers[i]!==paintVertexBuffers[i]&&(paintBuffersDiffer=!0);!this.vao||this.boundProgram!==program||this.boundLayoutVertexBuffer!==layoutVertexBuffer||paintBuffersDiffer||this.boundIndexBuffer!==indexBuffer||this.boundVertexOffset!==vertexOffset||this.boundDynamicVertexBuffer!==dynamicVertexBuffer||this.boundDynamicVertexBuffer2!==dynamicVertexBuffer2||this.boundDynamicVertexBuffer3!==dynamicVertexBuffer3?this.freshBind(program,layoutVertexBuffer,paintVertexBuffers,indexBuffer,vertexOffset,dynamicVertexBuffer,dynamicVertexBuffer2,dynamicVertexBuffer3):(context.bindVertexArray.set(this.vao),dynamicVertexBuffer&&dynamicVertexBuffer.bind(),indexBuffer&&indexBuffer.dynamicDraw&&indexBuffer.bind(),dynamicVertexBuffer2&&dynamicVertexBuffer2.bind(),dynamicVertexBuffer3&&dynamicVertexBuffer3.bind())}freshBind(program,layoutVertexBuffer,paintVertexBuffers,indexBuffer,vertexOffset,dynamicVertexBuffer,dynamicVertexBuffer2,dynamicVertexBuffer3){const numNextAttributes=program.numAttributes,context=this.context,gl=context.gl;this.vao&&this.destroy(),this.vao=context.createVertexArray(),context.bindVertexArray.set(this.vao),this.boundProgram=program,this.boundLayoutVertexBuffer=layoutVertexBuffer,this.boundPaintVertexBuffers=paintVertexBuffers,this.boundIndexBuffer=indexBuffer,this.boundVertexOffset=vertexOffset,this.boundDynamicVertexBuffer=dynamicVertexBuffer,this.boundDynamicVertexBuffer2=dynamicVertexBuffer2,this.boundDynamicVertexBuffer3=dynamicVertexBuffer3,layoutVertexBuffer.enableAttributes(gl,program);for(const vertexBuffer of paintVertexBuffers)vertexBuffer.enableAttributes(gl,program);dynamicVertexBuffer&&dynamicVertexBuffer.enableAttributes(gl,program),dynamicVertexBuffer2&&dynamicVertexBuffer2.enableAttributes(gl,program),dynamicVertexBuffer3&&dynamicVertexBuffer3.enableAttributes(gl,program),layoutVertexBuffer.bind(),layoutVertexBuffer.setVertexAttribPointers(gl,program,vertexOffset);for(const vertexBuffer of paintVertexBuffers)vertexBuffer.bind(),vertexBuffer.setVertexAttribPointers(gl,program,vertexOffset);dynamicVertexBuffer&&(dynamicVertexBuffer.bind(),dynamicVertexBuffer.setVertexAttribPointers(gl,program,vertexOffset)),indexBuffer&&indexBuffer.bind(),dynamicVertexBuffer2&&(dynamicVertexBuffer2.bind(),dynamicVertexBuffer2.setVertexAttribPointers(gl,program,vertexOffset)),dynamicVertexBuffer3&&(dynamicVertexBuffer3.bind(),dynamicVertexBuffer3.setVertexAttribPointers(gl,program,vertexOffset)),context.currentNumAttributes=numNextAttributes}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}function getTokenizedAttributesAndUniforms(array){const result=[];for(let i=0;i<array.length;i++){if(null===array[i])continue;const token=array[i].split(" ");result.push(token.pop())}return result}class Program{constructor(context,source,configuration,fixedUniforms,showOverdrawInspector,terrain){const gl=context.gl;this.program=gl.createProgram();const staticAttrInfo=getTokenizedAttributesAndUniforms(source.staticAttributes),dynamicAttrInfo=configuration?configuration.getBinderAttributes():[],allAttrInfo=staticAttrInfo.concat(dynamicAttrInfo),preludeUniformsInfo=shaders.prelude.staticUniforms?getTokenizedAttributesAndUniforms(shaders.prelude.staticUniforms):[],staticUniformsInfo=source.staticUniforms?getTokenizedAttributesAndUniforms(source.staticUniforms):[],dynamicUniformsInfo=configuration?configuration.getBinderUniforms():[],uniformList=preludeUniformsInfo.concat(staticUniformsInfo).concat(dynamicUniformsInfo),allUniformsInfo=[];for(const uniform of uniformList)allUniformsInfo.indexOf(uniform)<0&&allUniformsInfo.push(uniform);const defines=configuration?configuration.defines():[];showOverdrawInspector&&defines.push("#define OVERDRAW_INSPECTOR;"),terrain&&defines.push("#define TERRAIN3D;");const fragmentSource=defines.concat(shaders.prelude.fragmentSource,source.fragmentSource).join("\n"),vertexSource=defines.concat(shaders.prelude.vertexSource,source.vertexSource).join("\n"),fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);if(gl.isContextLost())return void(this.failedToCreate=!0);if(gl.shaderSource(fragmentShader,fragmentSource),gl.compileShader(fragmentShader),!gl.getShaderParameter(fragmentShader,gl.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${gl.getShaderInfoLog(fragmentShader)}`);gl.attachShader(this.program,fragmentShader);const vertexShader=gl.createShader(gl.VERTEX_SHADER);if(gl.isContextLost())return void(this.failedToCreate=!0);if(gl.shaderSource(vertexShader,vertexSource),gl.compileShader(vertexShader),!gl.getShaderParameter(vertexShader,gl.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${gl.getShaderInfoLog(vertexShader)}`);gl.attachShader(this.program,vertexShader),this.attributes={};const uniformLocations={};this.numAttributes=allAttrInfo.length;for(let i=0;i<this.numAttributes;i++)allAttrInfo[i]&&(gl.bindAttribLocation(this.program,i,allAttrInfo[i]),this.attributes[allAttrInfo[i]]=i);if(gl.linkProgram(this.program),!gl.getProgramParameter(this.program,gl.LINK_STATUS))throw new Error(`Program failed to link: ${gl.getProgramInfoLog(this.program)}`);gl.deleteShader(vertexShader),gl.deleteShader(fragmentShader);for(let it=0;it<allUniformsInfo.length;it++){const uniform=allUniformsInfo[it];if(uniform&&!uniformLocations[uniform]){const uniformLocation=gl.getUniformLocation(this.program,uniform);uniformLocation&&(uniformLocations[uniform]=uniformLocation)}}this.fixedUniforms=fixedUniforms(context,uniformLocations),this.terrainUniforms=((context,locations)=>({u_depth:new performance$1.Uniform1i(context,locations.u_depth),u_terrain:new performance$1.Uniform1i(context,locations.u_terrain),u_terrain_dim:new performance$1.Uniform1f(context,locations.u_terrain_dim),u_terrain_matrix:new performance$1.UniformMatrix4f(context,locations.u_terrain_matrix),u_terrain_unpack:new performance$1.Uniform4f(context,locations.u_terrain_unpack),u_terrain_exaggeration:new performance$1.Uniform1f(context,locations.u_terrain_exaggeration)}))(context,uniformLocations),this.binderUniforms=configuration?configuration.getUniforms(context,uniformLocations):[]}draw(context,drawMode,depthMode,stencilMode,colorMode,cullFaceMode,uniformValues,terrain,layerID,layoutVertexBuffer,indexBuffer,segments,currentProperties,zoom,configuration,dynamicLayoutBuffer,dynamicLayoutBuffer2,dynamicLayoutBuffer3){const gl=context.gl;if(this.failedToCreate)return;if(context.program.set(this.program),context.setDepthMode(depthMode),context.setStencilMode(stencilMode),context.setColorMode(colorMode),context.setCullFace(cullFaceMode),terrain){context.activeTexture.set(gl.TEXTURE2),gl.bindTexture(gl.TEXTURE_2D,terrain.depthTexture),context.activeTexture.set(gl.TEXTURE3),gl.bindTexture(gl.TEXTURE_2D,terrain.texture);for(const name in this.terrainUniforms)this.terrainUniforms[name].set(terrain[name])}for(const name in this.fixedUniforms)this.fixedUniforms[name].set(uniformValues[name]);configuration&&configuration.setUniforms(context,this.binderUniforms,currentProperties,{zoom:zoom});let primitiveSize=0;switch(drawMode){case gl.LINES:primitiveSize=2;break;case gl.TRIANGLES:primitiveSize=3;break;case gl.LINE_STRIP:primitiveSize=1}for(const segment of segments.get()){const vaos=segment.vaos||(segment.vaos={});(vaos[layerID]||(vaos[layerID]=new VertexArrayObject)).bind(context,this,layoutVertexBuffer,configuration?configuration.getPaintVertexBuffers():[],indexBuffer,segment.vertexOffset,dynamicLayoutBuffer,dynamicLayoutBuffer2,dynamicLayoutBuffer3),gl.drawElements(drawMode,segment.primitiveLength*primitiveSize,gl.UNSIGNED_SHORT,segment.primitiveOffset*primitiveSize*2)}}}function patternUniformValues(crossfade,painter,tile){const tileRatio=1/pixelsToTileUnits(tile,1,painter.transform.tileZoom),numTiles=Math.pow(2,tile.tileID.overscaledZ),tileSizeAtNearestZoom=tile.tileSize*Math.pow(2,painter.transform.tileZoom)/numTiles,pixelX=tileSizeAtNearestZoom*(tile.tileID.canonical.x+tile.tileID.wrap*numTiles),pixelY=tileSizeAtNearestZoom*tile.tileID.canonical.y;return{u_image:0,u_texsize:tile.imageAtlasTexture.size,u_scale:[tileRatio,crossfade.fromScale,crossfade.toScale],u_fade:crossfade.t,u_pixel_coord_upper:[pixelX>>16,pixelY>>16],u_pixel_coord_lower:[65535&pixelX,65535&pixelY]}}const fillExtrusionUniformValues=(matrix,painter,shouldUseVerticalGradient,opacity)=>{const light=painter.style.light,_lp=light.properties.get("position"),lightPos=[_lp.x,_lp.y,_lp.z],lightMat=performance$1.create$1();"viewport"===light.properties.get("anchor")&&performance$1.fromRotation(lightMat,-painter.transform.angle),performance$1.transformMat3(lightPos,lightPos,lightMat);const lightColor=light.properties.get("color");return{u_matrix:matrix,u_lightpos:lightPos,u_lightintensity:light.properties.get("intensity"),u_lightcolor:[lightColor.r,lightColor.g,lightColor.b],u_vertical_gradient:+shouldUseVerticalGradient,u_opacity:opacity}},fillExtrusionPatternUniformValues=(matrix,painter,shouldUseVerticalGradient,opacity,coord,crossfade,tile)=>performance$1.extend(fillExtrusionUniformValues(matrix,painter,shouldUseVerticalGradient,opacity),patternUniformValues(crossfade,painter,tile),{u_height_factor:-Math.pow(2,coord.overscaledZ)/tile.tileSize/8}),fillUniformValues=matrix=>({u_matrix:matrix}),fillPatternUniformValues=(matrix,painter,crossfade,tile)=>performance$1.extend(fillUniformValues(matrix),patternUniformValues(crossfade,painter,tile)),fillOutlineUniformValues=(matrix,drawingBufferSize)=>({u_matrix:matrix,u_world:drawingBufferSize}),fillOutlinePatternUniformValues=(matrix,painter,crossfade,tile,drawingBufferSize)=>performance$1.extend(fillPatternUniformValues(matrix,painter,crossfade,tile),{u_world:drawingBufferSize}),circleUniformValues=(painter,coord,tile,layer)=>{const transform=painter.transform;let pitchWithMap,extrudeScale;if("map"===layer.paint.get("circle-pitch-alignment")){const pixelRatio=pixelsToTileUnits(tile,1,transform.zoom);pitchWithMap=!0,extrudeScale=[pixelRatio,pixelRatio]}else pitchWithMap=!1,extrudeScale=transform.pixelsToGLUnits;return{u_camera_to_center_distance:transform.cameraToCenterDistance,u_scale_with_map:+("map"===layer.paint.get("circle-pitch-scale")),u_matrix:painter.translatePosMatrix(coord.posMatrix,tile,layer.paint.get("circle-translate"),layer.paint.get("circle-translate-anchor")),u_pitch_with_map:+pitchWithMap,u_device_pixel_ratio:painter.pixelRatio,u_extrude_scale:extrudeScale}},collisionUniformValues=(matrix,transform,tile)=>{const pixelRatio=pixelsToTileUnits(tile,1,transform.zoom),scale=Math.pow(2,transform.zoom-tile.tileID.overscaledZ),overscaleFactor=tile.tileID.overscaleFactor();return{u_matrix:matrix,u_camera_to_center_distance:transform.cameraToCenterDistance,u_pixels_to_tile_units:pixelRatio,u_extrude_scale:[transform.pixelsToGLUnits[0]/(pixelRatio*scale),transform.pixelsToGLUnits[1]/(pixelRatio*scale)],u_overscale_factor:overscaleFactor}},collisionCircleUniformValues=(matrix,invMatrix,transform)=>({u_matrix:matrix,u_inv_matrix:invMatrix,u_camera_to_center_distance:transform.cameraToCenterDistance,u_viewport_size:[transform.width,transform.height]}),debugUniformValues=(matrix,color,scaleRatio=1)=>({u_matrix:matrix,u_color:color,u_overlay:0,u_overlay_scale:scaleRatio}),clippingMaskUniformValues=matrix=>({u_matrix:matrix}),heatmapUniformValues=(matrix,tile,zoom,intensity)=>({u_matrix:matrix,u_extrude_scale:pixelsToTileUnits(tile,1,zoom),u_intensity:intensity}),heatmapTextureUniformValues=(painter,layer,textureUnit,colorRampUnit)=>{const matrix=performance$1.create();performance$1.ortho(matrix,0,painter.width,painter.height,0,0,1);const gl=painter.context.gl;return{u_matrix:matrix,u_world:[gl.drawingBufferWidth,gl.drawingBufferHeight],u_image:textureUnit,u_color_ramp:colorRampUnit,u_opacity:layer.paint.get("heatmap-opacity")}},hillshadeUniformValues=(painter,tile,layer,coord)=>{const shadow=layer.paint.get("hillshade-shadow-color"),highlight=layer.paint.get("hillshade-highlight-color"),accent=layer.paint.get("hillshade-accent-color");let azimuthal=layer.paint.get("hillshade-illumination-direction")*(Math.PI/180);"viewport"===layer.paint.get("hillshade-illumination-anchor")&&(azimuthal-=painter.transform.angle);const align=!painter.options.moving;return{u_matrix:coord?coord.posMatrix:painter.transform.calculatePosMatrix(tile.tileID.toUnwrapped(),align),u_image:0,u_latrange:getTileLatRange(painter,tile.tileID),u_light:[layer.paint.get("hillshade-exaggeration"),azimuthal],u_shadow:shadow,u_highlight:highlight,u_accent:accent}},hillshadeUniformPrepareValues=(tileID,dem)=>{const stride=dem.stride,matrix=performance$1.create();return performance$1.ortho(matrix,0,performance$1.EXTENT,-performance$1.EXTENT,0,0,1),performance$1.translate(matrix,matrix,[0,-performance$1.EXTENT,0]),{u_matrix:matrix,u_image:1,u_dimension:[stride,stride],u_zoom:tileID.overscaledZ,u_unpack:dem.getUnpackVector()}};function getTileLatRange(painter,tileID){const tilesAtZoom=Math.pow(2,tileID.canonical.z),y=tileID.canonical.y;return[new performance$1.MercatorCoordinate(0,y/tilesAtZoom).toLngLat().lat,new performance$1.MercatorCoordinate(0,(y+1)/tilesAtZoom).toLngLat().lat]}const lineUniformValues=(painter,tile,layer,coord)=>{const transform=painter.transform;return{u_matrix:calculateMatrix(painter,tile,layer,coord),u_ratio:1/pixelsToTileUnits(tile,1,transform.zoom),u_device_pixel_ratio:painter.pixelRatio,u_units_to_pixels:[1/transform.pixelsToGLUnits[0],1/transform.pixelsToGLUnits[1]]}},lineGradientUniformValues=(painter,tile,layer,imageHeight,coord)=>performance$1.extend(lineUniformValues(painter,tile,layer,coord),{u_image:0,u_image_height:imageHeight}),linePatternUniformValues=(painter,tile,layer,crossfade,coord)=>{const transform=painter.transform,tileZoomRatio=calculateTileRatio(tile,transform);return{u_matrix:calculateMatrix(painter,tile,layer,coord),u_texsize:tile.imageAtlasTexture.size,u_ratio:1/pixelsToTileUnits(tile,1,transform.zoom),u_device_pixel_ratio:painter.pixelRatio,u_image:0,u_scale:[tileZoomRatio,crossfade.fromScale,crossfade.toScale],u_fade:crossfade.t,u_units_to_pixels:[1/transform.pixelsToGLUnits[0],1/transform.pixelsToGLUnits[1]]}},lineSDFUniformValues=(painter,tile,layer,dasharray,crossfade,coord)=>{const transform=painter.transform,lineAtlas=painter.lineAtlas,tileRatio=calculateTileRatio(tile,transform),round="round"===layer.layout.get("line-cap"),posA=lineAtlas.getDash(dasharray.from,round),posB=lineAtlas.getDash(dasharray.to,round),widthA=posA.width*crossfade.fromScale,widthB=posB.width*crossfade.toScale;return performance$1.extend(lineUniformValues(painter,tile,layer,coord),{u_patternscale_a:[tileRatio/widthA,-posA.height/2],u_patternscale_b:[tileRatio/widthB,-posB.height/2],u_sdfgamma:lineAtlas.width/(256*Math.min(widthA,widthB)*painter.pixelRatio)/2,u_image:0,u_tex_y_a:posA.y,u_tex_y_b:posB.y,u_mix:crossfade.t})};function calculateTileRatio(tile,transform){return 1/pixelsToTileUnits(tile,1,transform.tileZoom)}function calculateMatrix(painter,tile,layer,coord){return painter.translatePosMatrix(coord?coord.posMatrix:tile.tileID.posMatrix,tile,layer.paint.get("line-translate"),layer.paint.get("line-translate-anchor"))}const rasterUniformValues=(matrix,parentTL,parentScaleBy,fade,layer)=>{return{u_matrix:matrix,u_tl_parent:parentTL,u_scale_parent:parentScaleBy,u_buffer_scale:1,u_fade_t:fade.mix,u_opacity:fade.opacity*layer.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:layer.paint.get("raster-brightness-min"),u_brightness_high:layer.paint.get("raster-brightness-max"),u_saturation_factor:(saturation=layer.paint.get("raster-saturation"),saturation>0?1-1/(1.001-saturation):-saturation),u_contrast_factor:(contrast=layer.paint.get("raster-contrast"),contrast>0?1/(1-contrast):1+contrast),u_spin_weights:spinWeights(layer.paint.get("raster-hue-rotate"))};var contrast,saturation};function spinWeights(angle){angle*=Math.PI/180;const s=Math.sin(angle),c=Math.cos(angle);return[(2*c+1)/3,(-Math.sqrt(3)*s-c+1)/3,(Math.sqrt(3)*s-c+1)/3]}const symbolIconUniformValues=(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,isText,texSize)=>{const transform=painter.transform;return{u_is_size_zoom_constant:+("constant"===functionType||"source"===functionType),u_is_size_feature_constant:+("constant"===functionType||"camera"===functionType),u_size_t:size?size.uSizeT:0,u_size:size?size.uSize:0,u_camera_to_center_distance:transform.cameraToCenterDistance,u_pitch:transform.pitch/360*2*Math.PI,u_rotate_symbol:+rotateInShader,u_aspect_ratio:transform.width/transform.height,u_fade_change:painter.options.fadeDuration?painter.symbolFadeChange:1,u_matrix:matrix,u_label_plane_matrix:labelPlaneMatrix,u_coord_matrix:glCoordMatrix,u_is_text:+isText,u_pitch_with_map:+pitchWithMap,u_texsize:texSize,u_texture:0}},symbolSDFUniformValues=(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,isText,texSize,isHalo)=>{const transform=painter.transform;return performance$1.extend(symbolIconUniformValues(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,isText,texSize),{u_gamma_scale:pitchWithMap?Math.cos(transform._pitch)*transform.cameraToCenterDistance:1,u_device_pixel_ratio:painter.pixelRatio,u_is_halo:+isHalo})},symbolTextAndIconUniformValues=(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,texSizeSDF,texSizeIcon)=>performance$1.extend(symbolSDFUniformValues(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,!0,texSizeSDF,!0),{u_texsize_icon:texSizeIcon,u_texture_icon:1}),backgroundUniformValues=(matrix,opacity,color)=>({u_matrix:matrix,u_opacity:opacity,u_color:color}),backgroundPatternUniformValues=(matrix,opacity,painter,image,tile,crossfade)=>performance$1.extend(function(image,crossfade,painter,tile){const imagePosA=painter.imageManager.getPattern(image.from.toString()),imagePosB=painter.imageManager.getPattern(image.to.toString()),{width:width,height:height}=painter.imageManager.getPixelSize(),numTiles=Math.pow(2,tile.tileID.overscaledZ),tileSizeAtNearestZoom=tile.tileSize*Math.pow(2,painter.transform.tileZoom)/numTiles,pixelX=tileSizeAtNearestZoom*(tile.tileID.canonical.x+tile.tileID.wrap*numTiles),pixelY=tileSizeAtNearestZoom*tile.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:imagePosA.tl,u_pattern_br_a:imagePosA.br,u_pattern_tl_b:imagePosB.tl,u_pattern_br_b:imagePosB.br,u_texsize:[width,height],u_mix:crossfade.t,u_pattern_size_a:imagePosA.displaySize,u_pattern_size_b:imagePosB.displaySize,u_scale_a:crossfade.fromScale,u_scale_b:crossfade.toScale,u_tile_units_to_pixels:1/pixelsToTileUnits(tile,1,painter.transform.tileZoom),u_pixel_coord_upper:[pixelX>>16,pixelY>>16],u_pixel_coord_lower:[65535&pixelX,65535&pixelY]}}(image,crossfade,painter,tile),{u_matrix:matrix,u_opacity:opacity}),programUniforms={fillExtrusion:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_lightpos:new performance$1.Uniform3f(context,locations.u_lightpos),u_lightintensity:new performance$1.Uniform1f(context,locations.u_lightintensity),u_lightcolor:new performance$1.Uniform3f(context,locations.u_lightcolor),u_vertical_gradient:new performance$1.Uniform1f(context,locations.u_vertical_gradient),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity)}),fillExtrusionPattern:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_lightpos:new performance$1.Uniform3f(context,locations.u_lightpos),u_lightintensity:new performance$1.Uniform1f(context,locations.u_lightintensity),u_lightcolor:new performance$1.Uniform3f(context,locations.u_lightcolor),u_vertical_gradient:new performance$1.Uniform1f(context,locations.u_vertical_gradient),u_height_factor:new performance$1.Uniform1f(context,locations.u_height_factor),u_image:new performance$1.Uniform1i(context,locations.u_image),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_pixel_coord_upper:new performance$1.Uniform2f(context,locations.u_pixel_coord_upper),u_pixel_coord_lower:new performance$1.Uniform2f(context,locations.u_pixel_coord_lower),u_scale:new performance$1.Uniform3f(context,locations.u_scale),u_fade:new performance$1.Uniform1f(context,locations.u_fade),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity)}),fill:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix)}),fillPattern:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_image:new performance$1.Uniform1i(context,locations.u_image),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_pixel_coord_upper:new performance$1.Uniform2f(context,locations.u_pixel_coord_upper),u_pixel_coord_lower:new performance$1.Uniform2f(context,locations.u_pixel_coord_lower),u_scale:new performance$1.Uniform3f(context,locations.u_scale),u_fade:new performance$1.Uniform1f(context,locations.u_fade)}),fillOutline:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_world:new performance$1.Uniform2f(context,locations.u_world)}),fillOutlinePattern:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_world:new performance$1.Uniform2f(context,locations.u_world),u_image:new performance$1.Uniform1i(context,locations.u_image),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_pixel_coord_upper:new performance$1.Uniform2f(context,locations.u_pixel_coord_upper),u_pixel_coord_lower:new performance$1.Uniform2f(context,locations.u_pixel_coord_lower),u_scale:new performance$1.Uniform3f(context,locations.u_scale),u_fade:new performance$1.Uniform1f(context,locations.u_fade)}),circle:(context,locations)=>({u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_scale_with_map:new performance$1.Uniform1i(context,locations.u_scale_with_map),u_pitch_with_map:new performance$1.Uniform1i(context,locations.u_pitch_with_map),u_extrude_scale:new performance$1.Uniform2f(context,locations.u_extrude_scale),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix)}),collisionBox:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_pixels_to_tile_units:new performance$1.Uniform1f(context,locations.u_pixels_to_tile_units),u_extrude_scale:new performance$1.Uniform2f(context,locations.u_extrude_scale),u_overscale_factor:new performance$1.Uniform1f(context,locations.u_overscale_factor)}),collisionCircle:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_inv_matrix:new performance$1.UniformMatrix4f(context,locations.u_inv_matrix),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_viewport_size:new performance$1.Uniform2f(context,locations.u_viewport_size)}),debug:(context,locations)=>({u_color:new performance$1.UniformColor(context,locations.u_color),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_overlay:new performance$1.Uniform1i(context,locations.u_overlay),u_overlay_scale:new performance$1.Uniform1f(context,locations.u_overlay_scale)}),clippingMask:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix)}),heatmap:(context,locations)=>({u_extrude_scale:new performance$1.Uniform1f(context,locations.u_extrude_scale),u_intensity:new performance$1.Uniform1f(context,locations.u_intensity),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix)}),heatmapTexture:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_world:new performance$1.Uniform2f(context,locations.u_world),u_image:new performance$1.Uniform1i(context,locations.u_image),u_color_ramp:new performance$1.Uniform1i(context,locations.u_color_ramp),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity)}),hillshade:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_image:new performance$1.Uniform1i(context,locations.u_image),u_latrange:new performance$1.Uniform2f(context,locations.u_latrange),u_light:new performance$1.Uniform2f(context,locations.u_light),u_shadow:new performance$1.UniformColor(context,locations.u_shadow),u_highlight:new performance$1.UniformColor(context,locations.u_highlight),u_accent:new performance$1.UniformColor(context,locations.u_accent)}),hillshadePrepare:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_image:new performance$1.Uniform1i(context,locations.u_image),u_dimension:new performance$1.Uniform2f(context,locations.u_dimension),u_zoom:new performance$1.Uniform1f(context,locations.u_zoom),u_unpack:new performance$1.Uniform4f(context,locations.u_unpack)}),line:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_ratio:new performance$1.Uniform1f(context,locations.u_ratio),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_units_to_pixels:new performance$1.Uniform2f(context,locations.u_units_to_pixels)}),lineGradient:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_ratio:new performance$1.Uniform1f(context,locations.u_ratio),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_units_to_pixels:new performance$1.Uniform2f(context,locations.u_units_to_pixels),u_image:new performance$1.Uniform1i(context,locations.u_image),u_image_height:new performance$1.Uniform1f(context,locations.u_image_height)}),linePattern:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_ratio:new performance$1.Uniform1f(context,locations.u_ratio),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_image:new performance$1.Uniform1i(context,locations.u_image),u_units_to_pixels:new performance$1.Uniform2f(context,locations.u_units_to_pixels),u_scale:new performance$1.Uniform3f(context,locations.u_scale),u_fade:new performance$1.Uniform1f(context,locations.u_fade)}),lineSDF:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_ratio:new performance$1.Uniform1f(context,locations.u_ratio),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_units_to_pixels:new performance$1.Uniform2f(context,locations.u_units_to_pixels),u_patternscale_a:new performance$1.Uniform2f(context,locations.u_patternscale_a),u_patternscale_b:new performance$1.Uniform2f(context,locations.u_patternscale_b),u_sdfgamma:new performance$1.Uniform1f(context,locations.u_sdfgamma),u_image:new performance$1.Uniform1i(context,locations.u_image),u_tex_y_a:new performance$1.Uniform1f(context,locations.u_tex_y_a),u_tex_y_b:new performance$1.Uniform1f(context,locations.u_tex_y_b),u_mix:new performance$1.Uniform1f(context,locations.u_mix)}),raster:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_tl_parent:new performance$1.Uniform2f(context,locations.u_tl_parent),u_scale_parent:new performance$1.Uniform1f(context,locations.u_scale_parent),u_buffer_scale:new performance$1.Uniform1f(context,locations.u_buffer_scale),u_fade_t:new performance$1.Uniform1f(context,locations.u_fade_t),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity),u_image0:new performance$1.Uniform1i(context,locations.u_image0),u_image1:new performance$1.Uniform1i(context,locations.u_image1),u_brightness_low:new performance$1.Uniform1f(context,locations.u_brightness_low),u_brightness_high:new performance$1.Uniform1f(context,locations.u_brightness_high),u_saturation_factor:new performance$1.Uniform1f(context,locations.u_saturation_factor),u_contrast_factor:new performance$1.Uniform1f(context,locations.u_contrast_factor),u_spin_weights:new performance$1.Uniform3f(context,locations.u_spin_weights)}),symbolIcon:(context,locations)=>({u_is_size_zoom_constant:new performance$1.Uniform1i(context,locations.u_is_size_zoom_constant),u_is_size_feature_constant:new performance$1.Uniform1i(context,locations.u_is_size_feature_constant),u_size_t:new performance$1.Uniform1f(context,locations.u_size_t),u_size:new performance$1.Uniform1f(context,locations.u_size),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_pitch:new performance$1.Uniform1f(context,locations.u_pitch),u_rotate_symbol:new performance$1.Uniform1i(context,locations.u_rotate_symbol),u_aspect_ratio:new performance$1.Uniform1f(context,locations.u_aspect_ratio),u_fade_change:new performance$1.Uniform1f(context,locations.u_fade_change),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_label_plane_matrix:new performance$1.UniformMatrix4f(context,locations.u_label_plane_matrix),u_coord_matrix:new performance$1.UniformMatrix4f(context,locations.u_coord_matrix),u_is_text:new performance$1.Uniform1i(context,locations.u_is_text),u_pitch_with_map:new performance$1.Uniform1i(context,locations.u_pitch_with_map),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_texture:new performance$1.Uniform1i(context,locations.u_texture)}),symbolSDF:(context,locations)=>({u_is_size_zoom_constant:new performance$1.Uniform1i(context,locations.u_is_size_zoom_constant),u_is_size_feature_constant:new performance$1.Uniform1i(context,locations.u_is_size_feature_constant),u_size_t:new performance$1.Uniform1f(context,locations.u_size_t),u_size:new performance$1.Uniform1f(context,locations.u_size),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_pitch:new performance$1.Uniform1f(context,locations.u_pitch),u_rotate_symbol:new performance$1.Uniform1i(context,locations.u_rotate_symbol),u_aspect_ratio:new performance$1.Uniform1f(context,locations.u_aspect_ratio),u_fade_change:new performance$1.Uniform1f(context,locations.u_fade_change),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_label_plane_matrix:new performance$1.UniformMatrix4f(context,locations.u_label_plane_matrix),u_coord_matrix:new performance$1.UniformMatrix4f(context,locations.u_coord_matrix),u_is_text:new performance$1.Uniform1i(context,locations.u_is_text),u_pitch_with_map:new performance$1.Uniform1i(context,locations.u_pitch_with_map),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_texture:new performance$1.Uniform1i(context,locations.u_texture),u_gamma_scale:new performance$1.Uniform1f(context,locations.u_gamma_scale),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_is_halo:new performance$1.Uniform1i(context,locations.u_is_halo)}),symbolTextAndIcon:(context,locations)=>({u_is_size_zoom_constant:new performance$1.Uniform1i(context,locations.u_is_size_zoom_constant),u_is_size_feature_constant:new performance$1.Uniform1i(context,locations.u_is_size_feature_constant),u_size_t:new performance$1.Uniform1f(context,locations.u_size_t),u_size:new performance$1.Uniform1f(context,locations.u_size),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_pitch:new performance$1.Uniform1f(context,locations.u_pitch),u_rotate_symbol:new performance$1.Uniform1i(context,locations.u_rotate_symbol),u_aspect_ratio:new performance$1.Uniform1f(context,locations.u_aspect_ratio),u_fade_change:new performance$1.Uniform1f(context,locations.u_fade_change),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_label_plane_matrix:new performance$1.UniformMatrix4f(context,locations.u_label_plane_matrix),u_coord_matrix:new performance$1.UniformMatrix4f(context,locations.u_coord_matrix),u_is_text:new performance$1.Uniform1i(context,locations.u_is_text),u_pitch_with_map:new performance$1.Uniform1i(context,locations.u_pitch_with_map),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_texsize_icon:new performance$1.Uniform2f(context,locations.u_texsize_icon),u_texture:new performance$1.Uniform1i(context,locations.u_texture),u_texture_icon:new performance$1.Uniform1i(context,locations.u_texture_icon),u_gamma_scale:new performance$1.Uniform1f(context,locations.u_gamma_scale),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_is_halo:new performance$1.Uniform1i(context,locations.u_is_halo)}),background:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity),u_color:new performance$1.UniformColor(context,locations.u_color)}),backgroundPattern:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity),u_image:new performance$1.Uniform1i(context,locations.u_image),u_pattern_tl_a:new performance$1.Uniform2f(context,locations.u_pattern_tl_a),u_pattern_br_a:new performance$1.Uniform2f(context,locations.u_pattern_br_a),u_pattern_tl_b:new performance$1.Uniform2f(context,locations.u_pattern_tl_b),u_pattern_br_b:new performance$1.Uniform2f(context,locations.u_pattern_br_b),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_mix:new performance$1.Uniform1f(context,locations.u_mix),u_pattern_size_a:new performance$1.Uniform2f(context,locations.u_pattern_size_a),u_pattern_size_b:new performance$1.Uniform2f(context,locations.u_pattern_size_b),u_scale_a:new performance$1.Uniform1f(context,locations.u_scale_a),u_scale_b:new performance$1.Uniform1f(context,locations.u_scale_b),u_pixel_coord_upper:new performance$1.Uniform2f(context,locations.u_pixel_coord_upper),u_pixel_coord_lower:new performance$1.Uniform2f(context,locations.u_pixel_coord_lower),u_tile_units_to_pixels:new performance$1.Uniform1f(context,locations.u_tile_units_to_pixels)}),terrain:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_texture:new performance$1.Uniform1i(context,locations.u_texture),u_ele_delta:new performance$1.Uniform1f(context,locations.u_ele_delta)}),terrainDepth:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_ele_delta:new performance$1.Uniform1f(context,locations.u_ele_delta)}),terrainCoords:(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_texture:new performance$1.Uniform1i(context,locations.u_texture),u_terrain_coords_id:new performance$1.Uniform1f(context,locations.u_terrain_coords_id),u_ele_delta:new performance$1.Uniform1f(context,locations.u_ele_delta)})};class IndexBuffer{constructor(context,array,dynamicDraw){this.context=context;const gl=context.gl;this.buffer=gl.createBuffer(),this.dynamicDraw=Boolean(dynamicDraw),this.context.unbindVAO(),context.bindElementBuffer.set(this.buffer),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,array.arrayBuffer,this.dynamicDraw?gl.DYNAMIC_DRAW:gl.STATIC_DRAW),this.dynamicDraw||delete array.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(array){const gl=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),gl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER,0,array.arrayBuffer)}destroy(){const gl=this.context.gl;this.buffer&&(gl.deleteBuffer(this.buffer),delete this.buffer)}}const AttributeType={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class VertexBuffer{constructor(context,array,attributes,dynamicDraw){this.length=array.length,this.attributes=attributes,this.itemSize=array.bytesPerElement,this.dynamicDraw=dynamicDraw,this.context=context;const gl=context.gl;this.buffer=gl.createBuffer(),context.bindVertexBuffer.set(this.buffer),gl.bufferData(gl.ARRAY_BUFFER,array.arrayBuffer,this.dynamicDraw?gl.DYNAMIC_DRAW:gl.STATIC_DRAW),this.dynamicDraw||delete array.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(array){if(array.length!==this.length)throw new Error(`Length of new data is ${array.length}, which doesn't match current length of ${this.length}`);const gl=this.context.gl;this.bind(),gl.bufferSubData(gl.ARRAY_BUFFER,0,array.arrayBuffer)}enableAttributes(gl,program){for(let j=0;j<this.attributes.length;j++){const member=this.attributes[j],attribIndex=program.attributes[member.name];void 0!==attribIndex&&gl.enableVertexAttribArray(attribIndex)}}setVertexAttribPointers(gl,program,vertexOffset){for(let j=0;j<this.attributes.length;j++){const member=this.attributes[j],attribIndex=program.attributes[member.name];void 0!==attribIndex&&gl.vertexAttribPointer(attribIndex,member.components,gl[AttributeType[member.type]],!1,this.itemSize,member.offset+this.itemSize*(vertexOffset||0))}}destroy(){const gl=this.context.gl;this.buffer&&(gl.deleteBuffer(this.buffer),delete this.buffer)}}const cache=new WeakMap;function isWebGL2(gl){var _a;if(cache.has(gl))return cache.get(gl);{const value=null===(_a=gl.getParameter(gl.VERSION))||void 0===_a?void 0:_a.startsWith("WebGL 2.0");return cache.set(gl,value),value}}class BaseValue{constructor(context){this.gl=context.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(value){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ClearColor extends BaseValue{getDefault(){return performance$1.Color.transparent}set(v){const c=this.current;(v.r!==c.r||v.g!==c.g||v.b!==c.b||v.a!==c.a||this.dirty)&&(this.gl.clearColor(v.r,v.g,v.b,v.a),this.current=v,this.dirty=!1)}}class ClearDepth extends BaseValue{getDefault(){return 1}set(v){(v!==this.current||this.dirty)&&(this.gl.clearDepth(v),this.current=v,this.dirty=!1)}}class ClearStencil extends BaseValue{getDefault(){return 0}set(v){(v!==this.current||this.dirty)&&(this.gl.clearStencil(v),this.current=v,this.dirty=!1)}}class ColorMask extends BaseValue{getDefault(){return[!0,!0,!0,!0]}set(v){const c=this.current;(v[0]!==c[0]||v[1]!==c[1]||v[2]!==c[2]||v[3]!==c[3]||this.dirty)&&(this.gl.colorMask(v[0],v[1],v[2],v[3]),this.current=v,this.dirty=!1)}}class DepthMask extends BaseValue{getDefault(){return!0}set(v){(v!==this.current||this.dirty)&&(this.gl.depthMask(v),this.current=v,this.dirty=!1)}}class StencilMask extends BaseValue{getDefault(){return 255}set(v){(v!==this.current||this.dirty)&&(this.gl.stencilMask(v),this.current=v,this.dirty=!1)}}class StencilFunc extends BaseValue{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(v){const c=this.current;(v.func!==c.func||v.ref!==c.ref||v.mask!==c.mask||this.dirty)&&(this.gl.stencilFunc(v.func,v.ref,v.mask),this.current=v,this.dirty=!1)}}class StencilOp extends BaseValue{getDefault(){const gl=this.gl;return[gl.KEEP,gl.KEEP,gl.KEEP]}set(v){const c=this.current;(v[0]!==c[0]||v[1]!==c[1]||v[2]!==c[2]||this.dirty)&&(this.gl.stencilOp(v[0],v[1],v[2]),this.current=v,this.dirty=!1)}}class StencilTest extends BaseValue{getDefault(){return!1}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;v?gl.enable(gl.STENCIL_TEST):gl.disable(gl.STENCIL_TEST),this.current=v,this.dirty=!1}}class DepthRange extends BaseValue{getDefault(){return[0,1]}set(v){const c=this.current;(v[0]!==c[0]||v[1]!==c[1]||this.dirty)&&(this.gl.depthRange(v[0],v[1]),this.current=v,this.dirty=!1)}}class DepthTest extends BaseValue{getDefault(){return!1}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;v?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST),this.current=v,this.dirty=!1}}class DepthFunc extends BaseValue{getDefault(){return this.gl.LESS}set(v){(v!==this.current||this.dirty)&&(this.gl.depthFunc(v),this.current=v,this.dirty=!1)}}class Blend extends BaseValue{getDefault(){return!1}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;v?gl.enable(gl.BLEND):gl.disable(gl.BLEND),this.current=v,this.dirty=!1}}class BlendFunc extends BaseValue{getDefault(){const gl=this.gl;return[gl.ONE,gl.ZERO]}set(v){const c=this.current;(v[0]!==c[0]||v[1]!==c[1]||this.dirty)&&(this.gl.blendFunc(v[0],v[1]),this.current=v,this.dirty=!1)}}class BlendColor extends BaseValue{getDefault(){return performance$1.Color.transparent}set(v){const c=this.current;(v.r!==c.r||v.g!==c.g||v.b!==c.b||v.a!==c.a||this.dirty)&&(this.gl.blendColor(v.r,v.g,v.b,v.a),this.current=v,this.dirty=!1)}}class BlendEquation extends BaseValue{getDefault(){return this.gl.FUNC_ADD}set(v){(v!==this.current||this.dirty)&&(this.gl.blendEquation(v),this.current=v,this.dirty=!1)}}class CullFace extends BaseValue{getDefault(){return!1}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;v?gl.enable(gl.CULL_FACE):gl.disable(gl.CULL_FACE),this.current=v,this.dirty=!1}}class CullFaceSide extends BaseValue{getDefault(){return this.gl.BACK}set(v){(v!==this.current||this.dirty)&&(this.gl.cullFace(v),this.current=v,this.dirty=!1)}}class FrontFace extends BaseValue{getDefault(){return this.gl.CCW}set(v){(v!==this.current||this.dirty)&&(this.gl.frontFace(v),this.current=v,this.dirty=!1)}}class ProgramValue extends BaseValue{getDefault(){return null}set(v){(v!==this.current||this.dirty)&&(this.gl.useProgram(v),this.current=v,this.dirty=!1)}}class ActiveTextureUnit extends BaseValue{getDefault(){return this.gl.TEXTURE0}set(v){(v!==this.current||this.dirty)&&(this.gl.activeTexture(v),this.current=v,this.dirty=!1)}}class Viewport extends BaseValue{getDefault(){const gl=this.gl;return[0,0,gl.drawingBufferWidth,gl.drawingBufferHeight]}set(v){const c=this.current;(v[0]!==c[0]||v[1]!==c[1]||v[2]!==c[2]||v[3]!==c[3]||this.dirty)&&(this.gl.viewport(v[0],v[1],v[2],v[3]),this.current=v,this.dirty=!1)}}class BindFramebuffer extends BaseValue{getDefault(){return null}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,v),this.current=v,this.dirty=!1}}class BindRenderbuffer extends BaseValue{getDefault(){return null}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.bindRenderbuffer(gl.RENDERBUFFER,v),this.current=v,this.dirty=!1}}class BindTexture extends BaseValue{getDefault(){return null}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.bindTexture(gl.TEXTURE_2D,v),this.current=v,this.dirty=!1}}class BindVertexBuffer extends BaseValue{getDefault(){return null}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.bindBuffer(gl.ARRAY_BUFFER,v),this.current=v,this.dirty=!1}}class BindElementBuffer extends BaseValue{getDefault(){return null}set(v){const gl=this.gl;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,v),this.current=v,this.dirty=!1}}class BindVertexArray extends BaseValue{getDefault(){return null}set(v){var _a;if(v===this.current&&!this.dirty)return;const gl=this.gl;isWebGL2(gl)?gl.bindVertexArray(v):null===(_a=gl.getExtension("OES_vertex_array_object"))||void 0===_a||_a.bindVertexArrayOES(v),this.current=v,this.dirty=!1}}class PixelStoreUnpack extends BaseValue{getDefault(){return 4}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.pixelStorei(gl.UNPACK_ALIGNMENT,v),this.current=v,this.dirty=!1}}class PixelStoreUnpackPremultiplyAlpha extends BaseValue{getDefault(){return!1}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,v),this.current=v,this.dirty=!1}}class PixelStoreUnpackFlipY extends BaseValue{getDefault(){return!1}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,v),this.current=v,this.dirty=!1}}class FramebufferAttachment extends BaseValue{constructor(context,parent){super(context),this.context=context,this.parent=parent}getDefault(){return null}}class ColorAttachment extends FramebufferAttachment{setDirty(){this.dirty=!0}set(v){if(v===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const gl=this.gl;gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,v,0),this.current=v,this.dirty=!1}}class DepthAttachment extends FramebufferAttachment{set(v){if(v===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const gl=this.gl;gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,v),this.current=v,this.dirty=!1}}class DepthStencilAttachment extends FramebufferAttachment{set(v){if(v===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const gl=this.gl;gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,v),this.current=v,this.dirty=!1}}class Framebuffer{constructor(context,width,height,hasDepth,hasStencil){this.context=context,this.width=width,this.height=height;const gl=context.gl,fbo=this.framebuffer=gl.createFramebuffer();if(this.colorAttachment=new ColorAttachment(context,fbo),hasDepth)this.depthAttachment=hasStencil?new DepthStencilAttachment(context,fbo):new DepthAttachment(context,fbo);else if(hasStencil)throw new Error("Stencil cannot be set without depth");if(gl.checkFramebufferStatus(gl.FRAMEBUFFER)!==gl.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer is not complete")}destroy(){const gl=this.context.gl,texture=this.colorAttachment.get();if(texture&&gl.deleteTexture(texture),this.depthAttachment){const renderbuffer=this.depthAttachment.get();renderbuffer&&gl.deleteRenderbuffer(renderbuffer)}gl.deleteFramebuffer(this.framebuffer)}}class ColorMode{constructor(blendFunction,blendColor,mask){this.blendFunction=blendFunction,this.blendColor=blendColor,this.mask=mask}}ColorMode.Replace=[1,0],ColorMode.disabled=new ColorMode(ColorMode.Replace,performance$1.Color.transparent,[!1,!1,!1,!1]),ColorMode.unblended=new ColorMode(ColorMode.Replace,performance$1.Color.transparent,[!0,!0,!0,!0]),ColorMode.alphaBlended=new ColorMode([1,771],performance$1.Color.transparent,[!0,!0,!0,!0]);class Context{constructor(gl){var _a,_b;if(this.gl=gl,this.clearColor=new ClearColor(this),this.clearDepth=new ClearDepth(this),this.clearStencil=new ClearStencil(this),this.colorMask=new ColorMask(this),this.depthMask=new DepthMask(this),this.stencilMask=new StencilMask(this),this.stencilFunc=new StencilFunc(this),this.stencilOp=new StencilOp(this),this.stencilTest=new StencilTest(this),this.depthRange=new DepthRange(this),this.depthTest=new DepthTest(this),this.depthFunc=new DepthFunc(this),this.blend=new Blend(this),this.blendFunc=new BlendFunc(this),this.blendColor=new BlendColor(this),this.blendEquation=new BlendEquation(this),this.cullFace=new CullFace(this),this.cullFaceSide=new CullFaceSide(this),this.frontFace=new FrontFace(this),this.program=new ProgramValue(this),this.activeTexture=new ActiveTextureUnit(this),this.viewport=new Viewport(this),this.bindFramebuffer=new BindFramebuffer(this),this.bindRenderbuffer=new BindRenderbuffer(this),this.bindTexture=new BindTexture(this),this.bindVertexBuffer=new BindVertexBuffer(this),this.bindElementBuffer=new BindElementBuffer(this),this.bindVertexArray=new BindVertexArray(this),this.pixelStoreUnpack=new PixelStoreUnpack(this),this.pixelStoreUnpackPremultiplyAlpha=new PixelStoreUnpackPremultiplyAlpha(this),this.pixelStoreUnpackFlipY=new PixelStoreUnpackFlipY(this),this.extTextureFilterAnisotropic=gl.getExtension("EXT_texture_filter_anisotropic")||gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=gl.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=gl.getParameter(gl.MAX_TEXTURE_SIZE),isWebGL2(gl)){this.HALF_FLOAT=gl.HALF_FLOAT;const extColorBufferHalfFloat=gl.getExtension("EXT_color_buffer_half_float");this.RGBA16F=null!==(_a=gl.RGBA16F)&&void 0!==_a?_a:null==extColorBufferHalfFloat?void 0:extColorBufferHalfFloat.RGBA16F_EXT,this.RGB16F=null!==(_b=gl.RGB16F)&&void 0!==_b?_b:null==extColorBufferHalfFloat?void 0:extColorBufferHalfFloat.RGB16F_EXT,gl.getExtension("EXT_color_buffer_float")}else{gl.getExtension("EXT_color_buffer_half_float"),gl.getExtension("OES_texture_half_float_linear");const extTextureHalfFloat=gl.getExtension("OES_texture_half_float");this.HALF_FLOAT=null==extTextureHalfFloat?void 0:extTextureHalfFloat.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(array,dynamicDraw){return new IndexBuffer(this,array,dynamicDraw)}createVertexBuffer(array,attributes,dynamicDraw){return new VertexBuffer(this,array,attributes,dynamicDraw)}createRenderbuffer(storageFormat,width,height){const gl=this.gl,rbo=gl.createRenderbuffer();return this.bindRenderbuffer.set(rbo),gl.renderbufferStorage(gl.RENDERBUFFER,storageFormat,width,height),this.bindRenderbuffer.set(null),rbo}createFramebuffer(width,height,hasDepth,hasStencil){return new Framebuffer(this,width,height,hasDepth,hasStencil)}clear({color:color,depth:depth,stencil:stencil}){const gl=this.gl;let mask=0;color&&(mask|=gl.COLOR_BUFFER_BIT,this.clearColor.set(color),this.colorMask.set([!0,!0,!0,!0])),void 0!==depth&&(mask|=gl.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(depth),this.depthMask.set(!0)),void 0!==stencil&&(mask|=gl.STENCIL_BUFFER_BIT,this.clearStencil.set(stencil),this.stencilMask.set(255)),gl.clear(mask)}setCullFace(cullFaceMode){!1===cullFaceMode.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(cullFaceMode.mode),this.frontFace.set(cullFaceMode.frontFace))}setDepthMode(depthMode){depthMode.func!==this.gl.ALWAYS||depthMode.mask?(this.depthTest.set(!0),this.depthFunc.set(depthMode.func),this.depthMask.set(depthMode.mask),this.depthRange.set(depthMode.range)):this.depthTest.set(!1)}setStencilMode(stencilMode){stencilMode.test.func!==this.gl.ALWAYS||stencilMode.mask?(this.stencilTest.set(!0),this.stencilMask.set(stencilMode.mask),this.stencilOp.set([stencilMode.fail,stencilMode.depthFail,stencilMode.pass]),this.stencilFunc.set({func:stencilMode.test.func,ref:stencilMode.ref,mask:stencilMode.test.mask})):this.stencilTest.set(!1)}setColorMode(colorMode){performance$1.deepEqual(colorMode.blendFunction,ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(colorMode.blendFunction),this.blendColor.set(colorMode.blendColor)),this.colorMask.set(colorMode.mask)}createVertexArray(){var _a;return isWebGL2(this.gl)?this.gl.createVertexArray():null===(_a=this.gl.getExtension("OES_vertex_array_object"))||void 0===_a?void 0:_a.createVertexArrayOES()}deleteVertexArray(x){var _a;return isWebGL2(this.gl)?this.gl.deleteVertexArray(x):null===(_a=this.gl.getExtension("OES_vertex_array_object"))||void 0===_a?void 0:_a.deleteVertexArrayOES(x)}unbindVAO(){this.bindVertexArray.set(null)}}class DepthMode{constructor(depthFunc,depthMask,depthRange){this.func=depthFunc,this.mask=depthMask,this.range=depthRange}}DepthMode.ReadOnly=!1,DepthMode.ReadWrite=!0,DepthMode.disabled=new DepthMode(519,DepthMode.ReadOnly,[0,1]);class StencilMode{constructor(test,ref,mask,fail,depthFail,pass){this.test=test,this.ref=ref,this.mask=mask,this.fail=fail,this.depthFail=depthFail,this.pass=pass}}StencilMode.disabled=new StencilMode({func:519,mask:0},0,0,7680,7680,7680);class CullFaceMode{constructor(enable,mode,frontFace){this.enable=enable,this.mode=mode,this.frontFace=frontFace}}let quadTriangles;function drawCollisionDebug(painter,sourceCache,layer,coords,translate,translateAnchor,isText){const context=painter.context,gl=context.gl,program=painter.useProgram("collisionBox"),tileBatches=[];let circleCount=0,circleOffset=0;for(let i=0;i<coords.length;i++){const coord=coords[i],tile=sourceCache.getTile(coord),bucket=tile.getBucket(layer);if(!bucket)continue;let posMatrix=coord.posMatrix;0===translate[0]&&0===translate[1]||(posMatrix=painter.translatePosMatrix(coord.posMatrix,tile,translate,translateAnchor));const buffers=isText?bucket.textCollisionBox:bucket.iconCollisionBox,circleArray=bucket.collisionCircleArray;if(circleArray.length>0){const invTransform=performance$1.create(),transform=posMatrix;performance$1.mul(invTransform,bucket.placementInvProjMatrix,painter.transform.glCoordMatrix),performance$1.mul(invTransform,invTransform,bucket.placementViewportMatrix),tileBatches.push({circleArray:circleArray,circleOffset:circleOffset,transform:transform,invTransform:invTransform,coord:coord}),circleCount+=circleArray.length/4,circleOffset=circleCount}buffers&&program.draw(context,gl.LINES,DepthMode.disabled,StencilMode.disabled,painter.colorModeForRenderPass(),CullFaceMode.disabled,collisionUniformValues(posMatrix,painter.transform,tile),painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord),layer.id,buffers.layoutVertexBuffer,buffers.indexBuffer,buffers.segments,null,painter.transform.zoom,null,null,buffers.collisionVertexBuffer)}if(!isText||!tileBatches.length)return;const circleProgram=painter.useProgram("collisionCircle"),vertexData=new performance$1.CollisionCircleLayoutArray;vertexData.resize(4*circleCount),vertexData._trim();let vertexOffset=0;for(const batch of tileBatches)for(let i=0;i<batch.circleArray.length/4;i++){const circleIdx=4*i,x=batch.circleArray[circleIdx+0],y=batch.circleArray[circleIdx+1],radius=batch.circleArray[circleIdx+2],collision=batch.circleArray[circleIdx+3];vertexData.emplace(vertexOffset++,x,y,radius,collision,0),vertexData.emplace(vertexOffset++,x,y,radius,collision,1),vertexData.emplace(vertexOffset++,x,y,radius,collision,2),vertexData.emplace(vertexOffset++,x,y,radius,collision,3)}(!quadTriangles||quadTriangles.length<2*circleCount)&&(quadTriangles=function(quadCount){const triCount=2*quadCount,array=new performance$1.QuadTriangleArray;array.resize(triCount),array._trim();for(let i=0;i<triCount;i++){const idx=6*i;array.uint16[idx+0]=4*i+0,array.uint16[idx+1]=4*i+1,array.uint16[idx+2]=4*i+2,array.uint16[idx+3]=4*i+2,array.uint16[idx+4]=4*i+3,array.uint16[idx+5]=4*i+0}return array}(circleCount));const indexBuffer=context.createIndexBuffer(quadTriangles,!0),vertexBuffer=context.createVertexBuffer(vertexData,performance$1.collisionCircleLayout.members,!0);for(const batch of tileBatches){const uniforms=collisionCircleUniformValues(batch.transform,batch.invTransform,painter.transform);circleProgram.draw(context,gl.TRIANGLES,DepthMode.disabled,StencilMode.disabled,painter.colorModeForRenderPass(),CullFaceMode.disabled,uniforms,painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(batch.coord),layer.id,vertexBuffer,indexBuffer,performance$1.SegmentVector.simpleSegment(0,2*batch.circleOffset,batch.circleArray.length,batch.circleArray.length/2),null,painter.transform.zoom,null,null,null)}vertexBuffer.destroy(),indexBuffer.destroy()}CullFaceMode.disabled=new CullFaceMode(!1,1029,2305),CullFaceMode.backCCW=new CullFaceMode(!0,1029,2305);const identityMat4=performance$1.identity(new Float32Array(16));function drawSymbols(painter,sourceCache,layer,coords,variableOffsets){if("translucent"!==painter.renderPass)return;const stencilMode=StencilMode.disabled,colorMode=painter.colorModeForRenderPass();(layer._unevaluatedLayout.hasValue("text-variable-anchor")||layer._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(coords,painter,layer,sourceCache,rotationAlignment,pitchAlignment,variableOffsets){const tr=painter.transform,rotateWithMap="map"===rotationAlignment,pitchWithMap="map"===pitchAlignment;for(const coord of coords){const tile=sourceCache.getTile(coord),bucket=tile.getBucket(layer);if(!bucket||!bucket.text||!bucket.text.segments.get().length)continue;const sizeData=bucket.textSizeData,size=performance$1.evaluateSizeForZoom(sizeData,tr.zoom),pixelToTileScale=pixelsToTileUnits(tile,1,painter.transform.zoom),labelPlaneMatrix=getLabelPlaneMatrix(coord.posMatrix,pitchWithMap,rotateWithMap,painter.transform,pixelToTileScale),updateTextFitIcon="none"!==layer.layout.get("icon-text-fit")&&bucket.hasIconData();if(size){const tileScale=Math.pow(2,tr.zoom-tile.tileID.overscaledZ),getElevation=painter.style.map.terrain?(x,y)=>painter.style.map.terrain.getElevation(coord,x,y):null;updateVariableAnchorsForBucket(bucket,rotateWithMap,pitchWithMap,variableOffsets,tr,labelPlaneMatrix,coord.posMatrix,tileScale,size,updateTextFitIcon,getElevation)}}}(coords,painter,layer,sourceCache,layer.layout.get("text-rotation-alignment"),layer.layout.get("text-pitch-alignment"),variableOffsets),0!==layer.paint.get("icon-opacity").constantOr(1)&&drawLayerSymbols(painter,sourceCache,layer,coords,!1,layer.paint.get("icon-translate"),layer.paint.get("icon-translate-anchor"),layer.layout.get("icon-rotation-alignment"),layer.layout.get("icon-pitch-alignment"),layer.layout.get("icon-keep-upright"),stencilMode,colorMode),0!==layer.paint.get("text-opacity").constantOr(1)&&drawLayerSymbols(painter,sourceCache,layer,coords,!0,layer.paint.get("text-translate"),layer.paint.get("text-translate-anchor"),layer.layout.get("text-rotation-alignment"),layer.layout.get("text-pitch-alignment"),layer.layout.get("text-keep-upright"),stencilMode,colorMode),sourceCache.map.showCollisionBoxes&&(drawCollisionDebug(painter,sourceCache,layer,coords,layer.paint.get("text-translate"),layer.paint.get("text-translate-anchor"),!0),drawCollisionDebug(painter,sourceCache,layer,coords,layer.paint.get("icon-translate"),layer.paint.get("icon-translate-anchor"),!1))}function calculateVariableRenderShift(anchor,width,height,textOffset,textBoxScale,renderTextSize){const{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}=performance$1.getAnchorAlignment(anchor),shiftX=-(horizontalAlign-.5)*width,shiftY=-(verticalAlign-.5)*height;return new performance$1.Point((shiftX/textBoxScale+textOffset[0])*renderTextSize,(shiftY/textBoxScale+textOffset[1])*renderTextSize)}function updateVariableAnchorsForBucket(bucket,rotateWithMap,pitchWithMap,variableOffsets,transform,labelPlaneMatrix,posMatrix,tileScale,size,updateTextFitIcon,getElevation){const placedSymbols=bucket.text.placedSymbolArray,dynamicTextLayoutVertexArray=bucket.text.dynamicLayoutVertexArray,dynamicIconLayoutVertexArray=bucket.icon.dynamicLayoutVertexArray,placedTextShifts={};dynamicTextLayoutVertexArray.clear();for(let s=0;s<placedSymbols.length;s++){const symbol=placedSymbols.get(s),skipOrientation=bucket.allowVerticalPlacement&&!symbol.placedOrientation,variableOffset=symbol.hidden||!symbol.crossTileID||skipOrientation?null:variableOffsets[symbol.crossTileID];if(variableOffset){const tileAnchor=new performance$1.Point(symbol.anchorX,symbol.anchorY),projectedAnchor=project(tileAnchor,pitchWithMap?posMatrix:labelPlaneMatrix,getElevation),perspectiveRatio=getPerspectiveRatio(transform.cameraToCenterDistance,projectedAnchor.signedDistanceFromCamera);let renderTextSize=performance$1.evaluateSizeForFeature(bucket.textSizeData,size,symbol)*perspectiveRatio/performance$1.ONE_EM;pitchWithMap&&(renderTextSize*=bucket.tilePixelRatio/tileScale);const{width:width,height:height,anchor:anchor,textOffset:textOffset,textBoxScale:textBoxScale}=variableOffset,shift=calculateVariableRenderShift(anchor,width,height,textOffset,textBoxScale,renderTextSize),shiftedAnchor=pitchWithMap?project(tileAnchor.add(shift),labelPlaneMatrix,getElevation).point:projectedAnchor.point.add(rotateWithMap?shift.rotate(-transform.angle):shift),angle=bucket.allowVerticalPlacement&&symbol.placedOrientation===performance$1.WritingMode.vertical?Math.PI/2:0;for(let g=0;g<symbol.numGlyphs;g++)performance$1.addDynamicAttributes(dynamicTextLayoutVertexArray,shiftedAnchor,angle);updateTextFitIcon&&symbol.associatedIconIndex>=0&&(placedTextShifts[symbol.associatedIconIndex]={shiftedAnchor:shiftedAnchor,angle:angle})}else hideGlyphs(symbol.numGlyphs,dynamicTextLayoutVertexArray)}if(updateTextFitIcon){dynamicIconLayoutVertexArray.clear();const placedIcons=bucket.icon.placedSymbolArray;for(let i=0;i<placedIcons.length;i++){const placedIcon=placedIcons.get(i);if(placedIcon.hidden)hideGlyphs(placedIcon.numGlyphs,dynamicIconLayoutVertexArray);else{const shift=placedTextShifts[i];if(shift)for(let g=0;g<placedIcon.numGlyphs;g++)performance$1.addDynamicAttributes(dynamicIconLayoutVertexArray,shift.shiftedAnchor,shift.angle);else hideGlyphs(placedIcon.numGlyphs,dynamicIconLayoutVertexArray)}}bucket.icon.dynamicLayoutVertexBuffer.updateData(dynamicIconLayoutVertexArray)}bucket.text.dynamicLayoutVertexBuffer.updateData(dynamicTextLayoutVertexArray)}function getSymbolProgramName(isSDF,isText,bucket){return bucket.iconsInText&&isText?"symbolTextAndIcon":isSDF?"symbolSDF":"symbolIcon"}function drawLayerSymbols(painter,sourceCache,layer,coords,isText,translate,translateAnchor,rotationAlignment,pitchAlignment,keepUpright,stencilMode,colorMode){const context=painter.context,gl=context.gl,tr=painter.transform,rotateWithMap="map"===rotationAlignment,pitchWithMap="map"===pitchAlignment,alongLine="viewport"!==rotationAlignment&&"point"!==layer.layout.get("symbol-placement"),rotateInShader=rotateWithMap&&!pitchWithMap&&!alongLine,hasSortKey=!layer.layout.get("symbol-sort-key").isConstant();let sortFeaturesByKey=!1;const depthMode=painter.depthModeForSublayer(0,DepthMode.ReadOnly),hasVariablePlacement=layer._unevaluatedLayout.hasValue("text-variable-anchor")||layer._unevaluatedLayout.hasValue("text-variable-anchor-offset"),tileRenderState=[];for(const coord of coords){const tile=sourceCache.getTile(coord),bucket=tile.getBucket(layer);if(!bucket)continue;const buffers=isText?bucket.text:bucket.icon;if(!buffers||!buffers.segments.get().length||!buffers.hasVisibleVertices)continue;const programConfiguration=buffers.programConfigurations.get(layer.id),isSDF=isText||bucket.sdfIcons,sizeData=isText?bucket.textSizeData:bucket.iconSizeData,transformed=pitchWithMap||0!==tr.pitch,program=painter.useProgram(getSymbolProgramName(isSDF,isText,bucket),programConfiguration),size=performance$1.evaluateSizeForZoom(sizeData,tr.zoom),terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);let texSize,atlasTexture,atlasInterpolation,atlasInterpolationIcon,texSizeIcon=[0,0],atlasTextureIcon=null;if(isText){if(atlasTexture=tile.glyphAtlasTexture,atlasInterpolation=gl.LINEAR,texSize=tile.glyphAtlasTexture.size,bucket.iconsInText){texSizeIcon=tile.imageAtlasTexture.size,atlasTextureIcon=tile.imageAtlasTexture;const zoomDependentSize="composite"===sizeData.kind||"camera"===sizeData.kind;atlasInterpolationIcon=transformed||painter.options.rotating||painter.options.zooming||zoomDependentSize?gl.LINEAR:gl.NEAREST}}else{const iconScaled=1!==layer.layout.get("icon-size").constantOr(0)||bucket.iconsNeedLinear;atlasTexture=tile.imageAtlasTexture,atlasInterpolation=isSDF||painter.options.rotating||painter.options.zooming||iconScaled||transformed?gl.LINEAR:gl.NEAREST,texSize=tile.imageAtlasTexture.size}const s=pixelsToTileUnits(tile,1,painter.transform.zoom),labelPlaneMatrix=getLabelPlaneMatrix(coord.posMatrix,pitchWithMap,rotateWithMap,painter.transform,s),glCoordMatrix=getGlCoordMatrix(coord.posMatrix,pitchWithMap,rotateWithMap,painter.transform,s),hasVariableAnchors=hasVariablePlacement&&bucket.hasTextData(),updateTextFitIcon="none"!==layer.layout.get("icon-text-fit")&&hasVariableAnchors&&bucket.hasIconData();if(alongLine){const getElevation=painter.style.map.terrain?(x,y)=>painter.style.map.terrain.getElevation(coord,x,y):null,rotateToLine="map"===layer.layout.get("text-rotation-alignment");updateLineLabels(bucket,coord.posMatrix,painter,isText,labelPlaneMatrix,glCoordMatrix,pitchWithMap,keepUpright,rotateToLine,getElevation)}const matrix=painter.translatePosMatrix(coord.posMatrix,tile,translate,translateAnchor),uLabelPlaneMatrix=alongLine||isText&&hasVariablePlacement||updateTextFitIcon?identityMat4:labelPlaneMatrix,uglCoordMatrix=painter.translatePosMatrix(glCoordMatrix,tile,translate,translateAnchor,!0),hasHalo=isSDF&&0!==layer.paint.get(isText?"text-halo-width":"icon-halo-width").constantOr(1);let uniformValues;uniformValues=isSDF?bucket.iconsInText?symbolTextAndIconUniformValues(sizeData.kind,size,rotateInShader,pitchWithMap,painter,matrix,uLabelPlaneMatrix,uglCoordMatrix,texSize,texSizeIcon):symbolSDFUniformValues(sizeData.kind,size,rotateInShader,pitchWithMap,painter,matrix,uLabelPlaneMatrix,uglCoordMatrix,isText,texSize,!0):symbolIconUniformValues(sizeData.kind,size,rotateInShader,pitchWithMap,painter,matrix,uLabelPlaneMatrix,uglCoordMatrix,isText,texSize);const state={program:program,buffers:buffers,uniformValues:uniformValues,atlasTexture:atlasTexture,atlasTextureIcon:atlasTextureIcon,atlasInterpolation:atlasInterpolation,atlasInterpolationIcon:atlasInterpolationIcon,isSDF:isSDF,hasHalo:hasHalo};if(hasSortKey&&bucket.canOverlap){sortFeaturesByKey=!0;const oldSegments=buffers.segments.get();for(const segment of oldSegments)tileRenderState.push({segments:new performance$1.SegmentVector([segment]),sortKey:segment.sortKey,state:state,terrainData:terrainData})}else tileRenderState.push({segments:buffers.segments,sortKey:0,state:state,terrainData:terrainData})}sortFeaturesByKey&&tileRenderState.sort(((a,b)=>a.sortKey-b.sortKey));for(const segmentState of tileRenderState){const state=segmentState.state;if(context.activeTexture.set(gl.TEXTURE0),state.atlasTexture.bind(state.atlasInterpolation,gl.CLAMP_TO_EDGE),state.atlasTextureIcon&&(context.activeTexture.set(gl.TEXTURE1),state.atlasTextureIcon&&state.atlasTextureIcon.bind(state.atlasInterpolationIcon,gl.CLAMP_TO_EDGE)),state.isSDF){const uniformValues=state.uniformValues;state.hasHalo&&(uniformValues.u_is_halo=1,drawSymbolElements(state.buffers,segmentState.segments,layer,painter,state.program,depthMode,stencilMode,colorMode,uniformValues,segmentState.terrainData)),uniformValues.u_is_halo=0}drawSymbolElements(state.buffers,segmentState.segments,layer,painter,state.program,depthMode,stencilMode,colorMode,state.uniformValues,segmentState.terrainData)}}function drawSymbolElements(buffers,segments,layer,painter,program,depthMode,stencilMode,colorMode,uniformValues,terrainData){const context=painter.context,gl=context.gl;program.draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,buffers.layoutVertexBuffer,buffers.indexBuffer,segments,layer.paint,painter.transform.zoom,buffers.programConfigurations.get(layer.id),buffers.dynamicLayoutVertexBuffer,buffers.opacityVertexBuffer)}function drawHeatmap(painter,sourceCache,layer,coords){if(0!==layer.paint.get("heatmap-opacity"))if("offscreen"===painter.renderPass){const context=painter.context,gl=context.gl,stencilMode=StencilMode.disabled,colorMode=new ColorMode([gl.ONE,gl.ONE],performance$1.Color.transparent,[!0,!0,!0,!0]);!function(context,painter,layer){const gl=context.gl;context.activeTexture.set(gl.TEXTURE1),context.viewport.set([0,0,painter.width/4,painter.height/4]);let fbo=layer.heatmapFbo;if(fbo)gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get()),context.bindFramebuffer.set(fbo.framebuffer);else{const texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),fbo=layer.heatmapFbo=context.createFramebuffer(painter.width/4,painter.height/4,!1,!1),function(context,painter,texture,fbo){var _a,_b;const gl=context.gl,numType=null!==(_a=context.HALF_FLOAT)&&void 0!==_a?_a:gl.UNSIGNED_BYTE,internalFormat=null!==(_b=context.RGBA16F)&&void 0!==_b?_b:gl.RGBA;gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,painter.width/4,painter.height/4,0,gl.RGBA,numType,null),fbo.colorAttachment.set(texture)}(context,painter,texture,fbo)}}(context,painter,layer),context.clear({color:performance$1.Color.transparent});for(let i=0;i<coords.length;i++){const coord=coords[i];if(sourceCache.hasRenderableParent(coord))continue;const tile=sourceCache.getTile(coord),bucket=tile.getBucket(layer);if(!bucket)continue;const programConfiguration=bucket.programConfigurations.get(layer.id),program=painter.useProgram("heatmap",programConfiguration),{zoom:zoom}=painter.transform;program.draw(context,gl.TRIANGLES,DepthMode.disabled,stencilMode,colorMode,CullFaceMode.disabled,heatmapUniformValues(coord.posMatrix,tile,zoom,layer.paint.get("heatmap-intensity")),null,layer.id,bucket.layoutVertexBuffer,bucket.indexBuffer,bucket.segments,layer.paint,painter.transform.zoom,programConfiguration)}context.viewport.set([0,0,painter.width,painter.height])}else"translucent"===painter.renderPass&&(painter.context.setColorMode(painter.colorModeForRenderPass()),function(painter,layer){const context=painter.context,gl=context.gl,fbo=layer.heatmapFbo;if(!fbo)return;context.activeTexture.set(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get()),context.activeTexture.set(gl.TEXTURE1);let colorRampTexture=layer.colorRampTexture;colorRampTexture||(colorRampTexture=layer.colorRampTexture=new Texture(context,layer.colorRamp,gl.RGBA));colorRampTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE),painter.useProgram("heatmapTexture").draw(context,gl.TRIANGLES,DepthMode.disabled,StencilMode.disabled,painter.colorModeForRenderPass(),CullFaceMode.disabled,heatmapTextureUniformValues(painter,layer,0,1),null,layer.id,painter.viewportBuffer,painter.quadTriangleIndexBuffer,painter.viewportSegments,layer.paint,painter.transform.zoom)}(painter,layer))}function updatePatternPositionsInProgram(programConfiguration,propertyName,constantPattern,tile,layer){if(!constantPattern||!tile||!tile.imageAtlas)return;const patternPositions=tile.imageAtlas.patternPositions;let posTo=patternPositions[constantPattern.to.toString()],posFrom=patternPositions[constantPattern.from.toString()];if(!posTo&&posFrom&&(posTo=posFrom),!posFrom&&posTo&&(posFrom=posTo),!posTo||!posFrom){const transitioned=layer.getPaintProperty(propertyName);posTo=patternPositions[transitioned],posFrom=patternPositions[transitioned]}posTo&&posFrom&&programConfiguration.setConstantPatternPositions(posTo,posFrom)}function drawFillTiles(painter,sourceCache,layer,coords,depthMode,colorMode,isOutline){const gl=painter.context.gl,patternProperty=layer.paint.get("fill-pattern"),image=patternProperty&&patternProperty.constantOr(1),crossfade=layer.getCrossfadeParameters();let drawMode,programName,uniformValues,indexBuffer,segments;isOutline?(programName=image&&!layer.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",drawMode=gl.LINES):(programName=image?"fillPattern":"fill",drawMode=gl.TRIANGLES);const constantPattern=patternProperty.constantOr(null);for(const coord of coords){const tile=sourceCache.getTile(coord);if(image&&!tile.patternsLoaded())continue;const bucket=tile.getBucket(layer);if(!bucket)continue;const programConfiguration=bucket.programConfigurations.get(layer.id),program=painter.useProgram(programName,programConfiguration),terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);image&&(painter.context.activeTexture.set(gl.TEXTURE0),tile.imageAtlasTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE),programConfiguration.updatePaintBuffers(crossfade)),updatePatternPositionsInProgram(programConfiguration,"fill-pattern",constantPattern,tile,layer);const terrainCoord=terrainData?coord:null,posMatrix=terrainCoord?terrainCoord.posMatrix:coord.posMatrix,tileMatrix=painter.translatePosMatrix(posMatrix,tile,layer.paint.get("fill-translate"),layer.paint.get("fill-translate-anchor"));if(isOutline){indexBuffer=bucket.indexBuffer2,segments=bucket.segments2;const drawingBufferSize=[gl.drawingBufferWidth,gl.drawingBufferHeight];uniformValues="fillOutlinePattern"===programName&&image?fillOutlinePatternUniformValues(tileMatrix,painter,crossfade,tile,drawingBufferSize):fillOutlineUniformValues(tileMatrix,drawingBufferSize)}else indexBuffer=bucket.indexBuffer,segments=bucket.segments,uniformValues=image?fillPatternUniformValues(tileMatrix,painter,crossfade,tile):fillUniformValues(tileMatrix);program.draw(painter.context,drawMode,depthMode,painter.stencilModeForClipping(coord),colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,bucket.layoutVertexBuffer,indexBuffer,segments,layer.paint,painter.transform.zoom,programConfiguration)}}function drawExtrusionTiles(painter,source,layer,coords,depthMode,stencilMode,colorMode){const context=painter.context,gl=context.gl,patternProperty=layer.paint.get("fill-extrusion-pattern"),image=patternProperty.constantOr(1),crossfade=layer.getCrossfadeParameters(),opacity=layer.paint.get("fill-extrusion-opacity"),constantPattern=patternProperty.constantOr(null);for(const coord of coords){const tile=source.getTile(coord),bucket=tile.getBucket(layer);if(!bucket)continue;const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord),programConfiguration=bucket.programConfigurations.get(layer.id),program=painter.useProgram(image?"fillExtrusionPattern":"fillExtrusion",programConfiguration);image&&(painter.context.activeTexture.set(gl.TEXTURE0),tile.imageAtlasTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE),programConfiguration.updatePaintBuffers(crossfade)),updatePatternPositionsInProgram(programConfiguration,"fill-extrusion-pattern",constantPattern,tile,layer);const matrix=painter.translatePosMatrix(coord.posMatrix,tile,layer.paint.get("fill-extrusion-translate"),layer.paint.get("fill-extrusion-translate-anchor")),shouldUseVerticalGradient=layer.paint.get("fill-extrusion-vertical-gradient"),uniformValues=image?fillExtrusionPatternUniformValues(matrix,painter,shouldUseVerticalGradient,opacity,coord,crossfade,tile):fillExtrusionUniformValues(matrix,painter,shouldUseVerticalGradient,opacity);program.draw(context,context.gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.backCCW,uniformValues,terrainData,layer.id,bucket.layoutVertexBuffer,bucket.indexBuffer,bucket.segments,layer.paint,painter.transform.zoom,programConfiguration,painter.style.map.terrain&&bucket.centroidVertexBuffer)}}function renderHillshade(painter,coord,tile,layer,depthMode,stencilMode,colorMode){const context=painter.context,gl=context.gl,fbo=tile.fbo;if(!fbo)return;const program=painter.useProgram("hillshade"),terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);context.activeTexture.set(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());const terrainCoord=terrainData?coord:null;program.draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,hillshadeUniformValues(painter,tile,layer,terrainCoord),terrainData,layer.id,painter.rasterBoundsBuffer,painter.quadTriangleIndexBuffer,painter.rasterBoundsSegments)}function prepareHillshade(painter,tile,layer,depthMode,stencilMode,colorMode){const context=painter.context,gl=context.gl,dem=tile.dem;if(dem&&dem.data){const tileSize=dem.dim,textureStride=dem.stride,pixelData=dem.getPixels();if(context.activeTexture.set(gl.TEXTURE1),context.pixelStoreUnpackPremultiplyAlpha.set(!1),tile.demTexture=tile.demTexture||painter.getTileTexture(textureStride),tile.demTexture){const demTexture=tile.demTexture;demTexture.update(pixelData,{premultiply:!1}),demTexture.bind(gl.NEAREST,gl.CLAMP_TO_EDGE)}else tile.demTexture=new Texture(context,pixelData,gl.RGBA,{premultiply:!1}),tile.demTexture.bind(gl.NEAREST,gl.CLAMP_TO_EDGE);context.activeTexture.set(gl.TEXTURE0);let fbo=tile.fbo;if(!fbo){const renderTexture=new Texture(context,{width:tileSize,height:tileSize,data:null},gl.RGBA);renderTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE),fbo=tile.fbo=context.createFramebuffer(tileSize,tileSize,!0,!1),fbo.colorAttachment.set(renderTexture.texture)}context.bindFramebuffer.set(fbo.framebuffer),context.viewport.set([0,0,tileSize,tileSize]),painter.useProgram("hillshadePrepare").draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,hillshadeUniformPrepareValues(tile.tileID,dem),null,layer.id,painter.rasterBoundsBuffer,painter.quadTriangleIndexBuffer,painter.rasterBoundsSegments),tile.needsHillshadePrepare=!1}}function getFadeValues(tile,parentTile,sourceCache,layer,transform,terrain){const fadeDuration=layer.paint.get("raster-fade-duration");if(!terrain&&fadeDuration>0){const now=browser.now(),sinceTile=(now-tile.timeAdded)/fadeDuration,sinceParent=parentTile?(now-parentTile.timeAdded)/fadeDuration:-1,source=sourceCache.getSource(),idealZ=transform.coveringZoomLevel({tileSize:source.tileSize,roundZoom:source.roundZoom}),fadeIn=!parentTile||Math.abs(parentTile.tileID.overscaledZ-idealZ)>Math.abs(tile.tileID.overscaledZ-idealZ),childOpacity=fadeIn&&tile.refreshedUponExpiration?1:performance$1.clamp(fadeIn?sinceTile:1-sinceParent,0,1);return tile.refreshedUponExpiration&&sinceTile>=1&&(tile.refreshedUponExpiration=!1),parentTile?{opacity:1,mix:1-childOpacity}:{opacity:childOpacity,mix:0}}return{opacity:1,mix:0}}const topColor=new performance$1.Color(1,0,0,1),btmColor=new performance$1.Color(0,1,0,1),leftColor=new performance$1.Color(0,0,1,1),rightColor=new performance$1.Color(1,0,1,1),centerColor=new performance$1.Color(0,1,1,1);function drawDebugPadding(painter){const padding=painter.transform.padding;drawHorizontalLine(painter,painter.transform.height-(padding.top||0),3,topColor),drawHorizontalLine(painter,padding.bottom||0,3,btmColor),drawVerticalLine(painter,padding.left||0,3,leftColor),drawVerticalLine(painter,painter.transform.width-(padding.right||0),3,rightColor);const center=painter.transform.centerPoint;!function(painter,x,y,color){const size=20,lineWidth=2;drawDebugSSRect(painter,x-lineWidth/2,y-size/2,lineWidth,size,color),drawDebugSSRect(painter,x-size/2,y-lineWidth/2,size,lineWidth,color)}(painter,center.x,painter.transform.height-center.y,centerColor)}function drawHorizontalLine(painter,y,lineWidth,color){drawDebugSSRect(painter,0,y+lineWidth/2,painter.transform.width,lineWidth,color)}function drawVerticalLine(painter,x,lineWidth,color){drawDebugSSRect(painter,x-lineWidth/2,0,lineWidth,painter.transform.height,color)}function drawDebugSSRect(painter,x,y,width,height,color){const context=painter.context,gl=context.gl;gl.enable(gl.SCISSOR_TEST),gl.scissor(x*painter.pixelRatio,y*painter.pixelRatio,width*painter.pixelRatio,height*painter.pixelRatio),context.clear({color:color}),gl.disable(gl.SCISSOR_TEST)}function drawDebugTile(painter,sourceCache,coord){const context=painter.context,gl=context.gl,posMatrix=coord.posMatrix,program=painter.useProgram("debug"),depthMode=DepthMode.disabled,stencilMode=StencilMode.disabled,colorMode=painter.colorModeForRenderPass(),terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);context.activeTexture.set(gl.TEXTURE0);const tileRawData=sourceCache.getTileByID(coord.key).latestRawTileData,tileByteLength=tileRawData&&tileRawData.byteLength||0,tileSizeKb=Math.floor(tileByteLength/1024),tileSize=sourceCache.getTile(coord).tileSize,scaleRatio=512/Math.min(tileSize,512)*(coord.overscaledZ/painter.transform.zoom)*.5;let tileIdText=coord.canonical.toString();coord.overscaledZ!==coord.canonical.z&&(tileIdText+=` => ${coord.overscaledZ}`);!function(painter,text){painter.initDebugOverlayCanvas();const canvas=painter.debugOverlayCanvas,gl=painter.context.gl,ctx2d=painter.debugOverlayCanvas.getContext("2d");ctx2d.clearRect(0,0,canvas.width,canvas.height),ctx2d.shadowColor="white",ctx2d.shadowBlur=2,ctx2d.lineWidth=1.5,ctx2d.strokeStyle="white",ctx2d.textBaseline="top",ctx2d.font="bold 36px Open Sans, sans-serif",ctx2d.fillText(text,5,5),ctx2d.strokeText(text,5,5),painter.debugOverlayTexture.update(canvas),painter.debugOverlayTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE)}(painter,`${tileIdText} ${tileSizeKb}kB`),program.draw(context,gl.TRIANGLES,depthMode,stencilMode,ColorMode.alphaBlended,CullFaceMode.disabled,debugUniformValues(posMatrix,performance$1.Color.transparent,scaleRatio),null,"$debug",painter.debugBuffer,painter.quadTriangleIndexBuffer,painter.debugSegments),program.draw(context,gl.LINE_STRIP,depthMode,stencilMode,colorMode,CullFaceMode.disabled,debugUniformValues(posMatrix,performance$1.Color.red),terrainData,"$debug",painter.debugBuffer,painter.tileBorderIndexBuffer,painter.debugSegments)}function drawTerrain(painter,terrain,tiles){const context=painter.context,gl=context.gl,colorMode=painter.colorModeForRenderPass(),depthMode=new DepthMode(gl.LEQUAL,DepthMode.ReadWrite,painter.depthRangeFor3D),program=painter.useProgram("terrain"),mesh=terrain.getTerrainMesh();context.bindFramebuffer.set(null),context.viewport.set([0,0,painter.width,painter.height]);for(const tile of tiles){const texture=painter.renderToTexture.getTexture(tile),terrainData=terrain.getTerrainData(tile.tileID);context.activeTexture.set(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,texture.texture);const posMatrix=painter.transform.calculatePosMatrix(tile.tileID.toUnwrapped()),uniformValues=(matrix=posMatrix,eleDelta=terrain.getMeshFrameDelta(painter.transform.zoom),{u_matrix:matrix,u_texture:0,u_ele_delta:eleDelta});program.draw(context,gl.TRIANGLES,depthMode,StencilMode.disabled,colorMode,CullFaceMode.backCCW,uniformValues,terrainData,"terrain",mesh.vertexBuffer,mesh.indexBuffer,mesh.segments)}var matrix,eleDelta}class Painter{constructor(gl,transform){this.context=new Context(gl),this.transform=transform,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:performance$1.create(),renderTime:0},this.setup(),this.numSublayers=SourceCache.maxUnderzooming+SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new CrossTileSymbolIndex}resize(width,height,pixelRatio){if(this.width=Math.floor(width*pixelRatio),this.height=Math.floor(height*pixelRatio),this.pixelRatio=pixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const layerId of this.style._order)this.style._layers[layerId].resize()}setup(){const context=this.context,tileExtentArray=new performance$1.PosArray;tileExtentArray.emplaceBack(0,0),tileExtentArray.emplaceBack(performance$1.EXTENT,0),tileExtentArray.emplaceBack(0,performance$1.EXTENT),tileExtentArray.emplaceBack(performance$1.EXTENT,performance$1.EXTENT),this.tileExtentBuffer=context.createVertexBuffer(tileExtentArray,posAttributes.members),this.tileExtentSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2);const debugArray=new performance$1.PosArray;debugArray.emplaceBack(0,0),debugArray.emplaceBack(performance$1.EXTENT,0),debugArray.emplaceBack(0,performance$1.EXTENT),debugArray.emplaceBack(performance$1.EXTENT,performance$1.EXTENT),this.debugBuffer=context.createVertexBuffer(debugArray,posAttributes.members),this.debugSegments=performance$1.SegmentVector.simpleSegment(0,0,4,5);const rasterBoundsArray=new performance$1.RasterBoundsArray;rasterBoundsArray.emplaceBack(0,0,0,0),rasterBoundsArray.emplaceBack(performance$1.EXTENT,0,performance$1.EXTENT,0),rasterBoundsArray.emplaceBack(0,performance$1.EXTENT,0,performance$1.EXTENT),rasterBoundsArray.emplaceBack(performance$1.EXTENT,performance$1.EXTENT,performance$1.EXTENT,performance$1.EXTENT),this.rasterBoundsBuffer=context.createVertexBuffer(rasterBoundsArray,rasterBoundsAttributes.members),this.rasterBoundsSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2);const viewportArray=new performance$1.PosArray;viewportArray.emplaceBack(0,0),viewportArray.emplaceBack(1,0),viewportArray.emplaceBack(0,1),viewportArray.emplaceBack(1,1),this.viewportBuffer=context.createVertexBuffer(viewportArray,posAttributes.members),this.viewportSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2);const tileLineStripIndices=new performance$1.LineStripIndexArray;tileLineStripIndices.emplaceBack(0),tileLineStripIndices.emplaceBack(1),tileLineStripIndices.emplaceBack(3),tileLineStripIndices.emplaceBack(2),tileLineStripIndices.emplaceBack(0),this.tileBorderIndexBuffer=context.createIndexBuffer(tileLineStripIndices);const quadTriangleIndices=new performance$1.TriangleIndexArray;quadTriangleIndices.emplaceBack(0,1,2),quadTriangleIndices.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=context.createIndexBuffer(quadTriangleIndices);const gl=this.context.gl;this.stencilClearMode=new StencilMode({func:gl.ALWAYS,mask:0},0,255,gl.ZERO,gl.ZERO,gl.ZERO)}clearStencil(){const context=this.context,gl=context.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const matrix=performance$1.create();performance$1.ortho(matrix,0,this.width,this.height,0,0,1),performance$1.scale(matrix,matrix,[gl.drawingBufferWidth,gl.drawingBufferHeight,0]),this.useProgram("clippingMask").draw(context,gl.TRIANGLES,DepthMode.disabled,this.stencilClearMode,ColorMode.disabled,CullFaceMode.disabled,clippingMaskUniformValues(matrix),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(layer,tileIDs){if(this.currentStencilSource===layer.source||!layer.isTileClipped()||!tileIDs||!tileIDs.length)return;this.currentStencilSource=layer.source;const context=this.context,gl=context.gl;this.nextStencilID+tileIDs.length>256&&this.clearStencil(),context.setColorMode(ColorMode.disabled),context.setDepthMode(DepthMode.disabled);const program=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const tileID of tileIDs){const id=this._tileClippingMaskIDs[tileID.key]=this.nextStencilID++,terrainData=this.style.map.terrain&&this.style.map.terrain.getTerrainData(tileID);program.draw(context,gl.TRIANGLES,DepthMode.disabled,new StencilMode({func:gl.ALWAYS,mask:0},id,255,gl.KEEP,gl.KEEP,gl.REPLACE),ColorMode.disabled,CullFaceMode.disabled,clippingMaskUniformValues(tileID.posMatrix),terrainData,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const id=this.nextStencilID++,gl=this.context.gl;return new StencilMode({func:gl.NOTEQUAL,mask:255},id,255,gl.KEEP,gl.KEEP,gl.REPLACE)}stencilModeForClipping(tileID){const gl=this.context.gl;return new StencilMode({func:gl.EQUAL,mask:255},this._tileClippingMaskIDs[tileID.key],0,gl.KEEP,gl.KEEP,gl.REPLACE)}stencilConfigForOverlap(tileIDs){const gl=this.context.gl,coords=tileIDs.sort(((a,b)=>b.overscaledZ-a.overscaledZ)),minTileZ=coords[coords.length-1].overscaledZ,stencilValues=coords[0].overscaledZ-minTileZ+1;if(stencilValues>1){this.currentStencilSource=void 0,this.nextStencilID+stencilValues>256&&this.clearStencil();const zToStencilMode={};for(let i=0;i<stencilValues;i++)zToStencilMode[i+minTileZ]=new StencilMode({func:gl.GEQUAL,mask:255},i+this.nextStencilID,255,gl.KEEP,gl.KEEP,gl.REPLACE);return this.nextStencilID+=stencilValues,[zToStencilMode,coords]}return[{[minTileZ]:StencilMode.disabled},coords]}colorModeForRenderPass(){const gl=this.context.gl;if(this._showOverdrawInspector){const a=1/8;return new ColorMode([gl.CONSTANT_COLOR,gl.ONE],new performance$1.Color(a,a,a,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?ColorMode.unblended:ColorMode.alphaBlended}depthModeForSublayer(n,mask,func){if(!this.opaquePassEnabledForLayer())return DepthMode.disabled;const depth=1-((1+this.currentLayer)*this.numSublayers+n)*this.depthEpsilon;return new DepthMode(func||this.context.gl.LEQUAL,mask,[depth,depth])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(style,options){this.style=style,this.options=options,this.lineAtlas=style.lineAtlas,this.imageManager=style.imageManager,this.glyphManager=style.glyphManager,this.symbolFadeChange=style.placement.symbolFadeChange(browser.now()),this.imageManager.beginFrame();const layerIds=this.style._order,sourceCaches=this.style.sourceCaches,coordsAscending={},coordsDescending={},coordsDescendingSymbol={};for(const id in sourceCaches){const sourceCache=sourceCaches[id];sourceCache.used&&sourceCache.prepare(this.context),coordsAscending[id]=sourceCache.getVisibleCoordinates(),coordsDescending[id]=coordsAscending[id].slice().reverse(),coordsDescendingSymbol[id]=sourceCache.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let i=0;i<layerIds.length;i++){const layerId=layerIds[i];if(this.style._layers[layerId].is3D()){this.opaquePassCutoff=i;break}}if(this.renderToTexture){this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0;const newTiles=this.style.map.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime);(this.terrainFacilitator.dirty||!performance$1.equals(this.terrainFacilitator.matrix,this.transform.projMatrix)||newTiles.length)&&(performance$1.copy(this.terrainFacilitator.matrix,this.transform.projMatrix),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(painter,terrain){const context=painter.context,gl=context.gl,colorMode=ColorMode.unblended,depthMode=new DepthMode(gl.LEQUAL,DepthMode.ReadWrite,[0,1]),mesh=terrain.getTerrainMesh(),tiles=terrain.sourceCache.getRenderableTiles(),program=painter.useProgram("terrainDepth");context.bindFramebuffer.set(terrain.getFramebuffer("depth").framebuffer),context.viewport.set([0,0,painter.width/devicePixelRatio,painter.height/devicePixelRatio]),context.clear({color:performance$1.Color.transparent,depth:1});for(const tile of tiles){const terrainData=terrain.getTerrainData(tile.tileID),uniformValues={u_matrix:painter.transform.calculatePosMatrix(tile.tileID.toUnwrapped()),u_ele_delta:terrain.getMeshFrameDelta(painter.transform.zoom)};program.draw(context,gl.TRIANGLES,depthMode,StencilMode.disabled,colorMode,CullFaceMode.backCCW,uniformValues,terrainData,"terrain",mesh.vertexBuffer,mesh.indexBuffer,mesh.segments)}context.bindFramebuffer.set(null),context.viewport.set([0,0,painter.width,painter.height])}(this,this.style.map.terrain),function(painter,terrain){const context=painter.context,gl=context.gl,colorMode=ColorMode.unblended,depthMode=new DepthMode(gl.LEQUAL,DepthMode.ReadWrite,[0,1]),mesh=terrain.getTerrainMesh(),coords=terrain.getCoordsTexture(),tiles=terrain.sourceCache.getRenderableTiles(),program=painter.useProgram("terrainCoords");context.bindFramebuffer.set(terrain.getFramebuffer("coords").framebuffer),context.viewport.set([0,0,painter.width/devicePixelRatio,painter.height/devicePixelRatio]),context.clear({color:performance$1.Color.transparent,depth:1}),terrain.coordsIndex=[];for(const tile of tiles){const terrainData=terrain.getTerrainData(tile.tileID);context.activeTexture.set(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,coords.texture);const uniformValues={u_matrix:painter.transform.calculatePosMatrix(tile.tileID.toUnwrapped()),u_terrain_coords_id:(255-terrain.coordsIndex.length)/255,u_texture:0,u_ele_delta:terrain.getMeshFrameDelta(painter.transform.zoom)};program.draw(context,gl.TRIANGLES,depthMode,StencilMode.disabled,colorMode,CullFaceMode.backCCW,uniformValues,terrainData,"terrain",mesh.vertexBuffer,mesh.indexBuffer,mesh.segments),terrain.coordsIndex.push(tile.tileID.key)}context.bindFramebuffer.set(null),context.viewport.set([0,0,painter.width,painter.height])}(this,this.style.map.terrain))}this.renderPass="offscreen";for(const layerId of layerIds){const layer=this.style._layers[layerId];if(!layer.hasOffscreenPass()||layer.isHidden(this.transform.zoom))continue;const coords=coordsDescending[layer.source];("custom"===layer.type||coords.length)&&this.renderLayer(this,sourceCaches[layer.source],layer,coords)}if(this.context.bindFramebuffer.set(null),this.context.clear({color:options.showOverdrawInspector?performance$1.Color.black:performance$1.Color.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=options.showOverdrawInspector,this.depthRangeFor3D=[0,1-(style._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=layerIds.length-1;this.currentLayer>=0;this.currentLayer--){const layer=this.style._layers[layerIds[this.currentLayer]],sourceCache=sourceCaches[layer.source],coords=coordsAscending[layer.source];this._renderTileClippingMasks(layer,coords),this.renderLayer(this,sourceCache,layer,coords)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<layerIds.length;this.currentLayer++){const layer=this.style._layers[layerIds[this.currentLayer]],sourceCache=sourceCaches[layer.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(layer))continue;const coords=("symbol"===layer.type?coordsDescendingSymbol:coordsDescending)[layer.source];this._renderTileClippingMasks(layer,coordsAscending[layer.source]),this.renderLayer(this,sourceCache,layer,coords)}if(this.options.showTileBoundaries){const selectedSource=function(style,zoom){let selectedSource=null;const sources=Object.values(style._layers).flatMap((layer=>layer.source&&!layer.isHidden(zoom)?[style.sourceCaches[layer.source]]:[])),vectorSources=sources.filter((source=>"vector"===source.getSource().type)),otherSources=sources.filter((source=>"vector"!==source.getSource().type)),considerSource=source=>{(!selectedSource||selectedSource.getSource().maxzoom<source.getSource().maxzoom)&&(selectedSource=source)};return vectorSources.forEach((source=>considerSource(source))),selectedSource||otherSources.forEach((source=>considerSource(source))),selectedSource}(this.style,this.transform.zoom);selectedSource&&function(painter,sourceCache,coords){for(let i=0;i<coords.length;i++)drawDebugTile(painter,sourceCache,coords[i])}(this,selectedSource,selectedSource.getVisibleCoordinates())}this.options.showPadding&&drawDebugPadding(this),this.context.setDefault()}renderLayer(painter,sourceCache,layer,coords){if(!layer.isHidden(this.transform.zoom)&&("background"===layer.type||"custom"===layer.type||(coords||[]).length))switch(this.id=layer.id,layer.type){case"symbol":drawSymbols(painter,sourceCache,layer,coords,this.style.placement.variableOffsets);break;case"circle":!function(painter,sourceCache,layer,coords){if("translucent"!==painter.renderPass)return;const opacity=layer.paint.get("circle-opacity"),strokeWidth=layer.paint.get("circle-stroke-width"),strokeOpacity=layer.paint.get("circle-stroke-opacity"),sortFeaturesByKey=!layer.layout.get("circle-sort-key").isConstant();if(0===opacity.constantOr(1)&&(0===strokeWidth.constantOr(1)||0===strokeOpacity.constantOr(1)))return;const context=painter.context,gl=context.gl,depthMode=painter.depthModeForSublayer(0,DepthMode.ReadOnly),stencilMode=StencilMode.disabled,colorMode=painter.colorModeForRenderPass(),segmentsRenderStates=[];for(let i=0;i<coords.length;i++){const coord=coords[i],tile=sourceCache.getTile(coord),bucket=tile.getBucket(layer);if(!bucket)continue;const programConfiguration=bucket.programConfigurations.get(layer.id),program=painter.useProgram("circle",programConfiguration),layoutVertexBuffer=bucket.layoutVertexBuffer,indexBuffer=bucket.indexBuffer,terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord),state={programConfiguration:programConfiguration,program:program,layoutVertexBuffer:layoutVertexBuffer,indexBuffer:indexBuffer,uniformValues:circleUniformValues(painter,coord,tile,layer),terrainData:terrainData};if(sortFeaturesByKey){const oldSegments=bucket.segments.get();for(const segment of oldSegments)segmentsRenderStates.push({segments:new performance$1.SegmentVector([segment]),sortKey:segment.sortKey,state:state})}else segmentsRenderStates.push({segments:bucket.segments,sortKey:0,state:state})}sortFeaturesByKey&&segmentsRenderStates.sort(((a,b)=>a.sortKey-b.sortKey));for(const segmentsState of segmentsRenderStates){const{programConfiguration:programConfiguration,program:program,layoutVertexBuffer:layoutVertexBuffer,indexBuffer:indexBuffer,uniformValues:uniformValues,terrainData:terrainData}=segmentsState.state,segments=segmentsState.segments;program.draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,layoutVertexBuffer,indexBuffer,segments,layer.paint,painter.transform.zoom,programConfiguration)}}(painter,sourceCache,layer,coords);break;case"heatmap":drawHeatmap(painter,sourceCache,layer,coords);break;case"line":!function(painter,sourceCache,layer,coords){if("translucent"!==painter.renderPass)return;const opacity=layer.paint.get("line-opacity"),width=layer.paint.get("line-width");if(0===opacity.constantOr(1)||0===width.constantOr(1))return;const depthMode=painter.depthModeForSublayer(0,DepthMode.ReadOnly),colorMode=painter.colorModeForRenderPass(),dasharray=layer.paint.get("line-dasharray"),patternProperty=layer.paint.get("line-pattern"),image=patternProperty.constantOr(1),gradient=layer.paint.get("line-gradient"),crossfade=layer.getCrossfadeParameters(),programId=image?"linePattern":dasharray?"lineSDF":gradient?"lineGradient":"line",context=painter.context,gl=context.gl;let firstTile=!0;for(const coord of coords){const tile=sourceCache.getTile(coord);if(image&&!tile.patternsLoaded())continue;const bucket=tile.getBucket(layer);if(!bucket)continue;const programConfiguration=bucket.programConfigurations.get(layer.id),prevProgram=painter.context.program.get(),program=painter.useProgram(programId,programConfiguration),programChanged=firstTile||program.program!==prevProgram,terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord),constantPattern=patternProperty.constantOr(null);if(constantPattern&&tile.imageAtlas){const atlas=tile.imageAtlas,posTo=atlas.patternPositions[constantPattern.to.toString()],posFrom=atlas.patternPositions[constantPattern.from.toString()];posTo&&posFrom&&programConfiguration.setConstantPatternPositions(posTo,posFrom)}const terrainCoord=terrainData?coord:null,uniformValues=image?linePatternUniformValues(painter,tile,layer,crossfade,terrainCoord):dasharray?lineSDFUniformValues(painter,tile,layer,dasharray,crossfade,terrainCoord):gradient?lineGradientUniformValues(painter,tile,layer,bucket.lineClipsArray.length,terrainCoord):lineUniformValues(painter,tile,layer,terrainCoord);if(image)context.activeTexture.set(gl.TEXTURE0),tile.imageAtlasTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE),programConfiguration.updatePaintBuffers(crossfade);else if(dasharray&&(programChanged||painter.lineAtlas.dirty))context.activeTexture.set(gl.TEXTURE0),painter.lineAtlas.bind(context);else if(gradient){const layerGradient=bucket.gradients[layer.id];let gradientTexture=layerGradient.texture;if(layer.gradientVersion!==layerGradient.version){let textureResolution=256;if(layer.stepInterpolant){const sourceMaxZoom=sourceCache.getSource().maxzoom,potentialOverzoom=coord.canonical.z===sourceMaxZoom?Math.ceil(1<<painter.transform.maxZoom-coord.canonical.z):1,maxTextureCoverage=bucket.maxLineLength/performance$1.EXTENT*1024*potentialOverzoom;textureResolution=performance$1.clamp(performance$1.nextPowerOfTwo(maxTextureCoverage),256,context.maxTextureSize)}layerGradient.gradient=performance$1.renderColorRamp({expression:layer.gradientExpression(),evaluationKey:"lineProgress",resolution:textureResolution,image:layerGradient.gradient||void 0,clips:bucket.lineClipsArray}),layerGradient.texture?layerGradient.texture.update(layerGradient.gradient):layerGradient.texture=new Texture(context,layerGradient.gradient,gl.RGBA),layerGradient.version=layer.gradientVersion,gradientTexture=layerGradient.texture}context.activeTexture.set(gl.TEXTURE0),gradientTexture.bind(layer.stepInterpolant?gl.NEAREST:gl.LINEAR,gl.CLAMP_TO_EDGE)}program.draw(context,gl.TRIANGLES,depthMode,painter.stencilModeForClipping(coord),colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,bucket.layoutVertexBuffer,bucket.indexBuffer,bucket.segments,layer.paint,painter.transform.zoom,programConfiguration,bucket.layoutVertexBuffer2),firstTile=!1}}(painter,sourceCache,layer,coords);break;case"fill":!function(painter,sourceCache,layer,coords){const color=layer.paint.get("fill-color"),opacity=layer.paint.get("fill-opacity");if(0===opacity.constantOr(1))return;const colorMode=painter.colorModeForRenderPass(),pattern=layer.paint.get("fill-pattern"),pass=painter.opaquePassEnabledForLayer()&&!pattern.constantOr(1)&&1===color.constantOr(performance$1.Color.transparent).a&&1===opacity.constantOr(0)?"opaque":"translucent";if(painter.renderPass===pass){const depthMode=painter.depthModeForSublayer(1,"opaque"===painter.renderPass?DepthMode.ReadWrite:DepthMode.ReadOnly);drawFillTiles(painter,sourceCache,layer,coords,depthMode,colorMode,!1)}if("translucent"===painter.renderPass&&layer.paint.get("fill-antialias")){const depthMode=painter.depthModeForSublayer(layer.getPaintProperty("fill-outline-color")?2:0,DepthMode.ReadOnly);drawFillTiles(painter,sourceCache,layer,coords,depthMode,colorMode,!0)}}(painter,sourceCache,layer,coords);break;case"fill-extrusion":!function(painter,source,layer,coords){const opacity=layer.paint.get("fill-extrusion-opacity");if(0!==opacity&&"translucent"===painter.renderPass){const depthMode=new DepthMode(painter.context.gl.LEQUAL,DepthMode.ReadWrite,painter.depthRangeFor3D);if(1!==opacity||layer.paint.get("fill-extrusion-pattern").constantOr(1))drawExtrusionTiles(painter,source,layer,coords,depthMode,StencilMode.disabled,ColorMode.disabled),drawExtrusionTiles(painter,source,layer,coords,depthMode,painter.stencilModeFor3D(),painter.colorModeForRenderPass());else{const colorMode=painter.colorModeForRenderPass();drawExtrusionTiles(painter,source,layer,coords,depthMode,StencilMode.disabled,colorMode)}}}(painter,sourceCache,layer,coords);break;case"hillshade":!function(painter,sourceCache,layer,tileIDs){if("offscreen"!==painter.renderPass&&"translucent"!==painter.renderPass)return;const context=painter.context,depthMode=painter.depthModeForSublayer(0,DepthMode.ReadOnly),colorMode=painter.colorModeForRenderPass(),[stencilModes,coords]="translucent"===painter.renderPass?painter.stencilConfigForOverlap(tileIDs):[{},tileIDs];for(const coord of coords){const tile=sourceCache.getTile(coord);void 0!==tile.needsHillshadePrepare&&tile.needsHillshadePrepare&&"offscreen"===painter.renderPass?prepareHillshade(painter,tile,layer,depthMode,StencilMode.disabled,colorMode):"translucent"===painter.renderPass&&renderHillshade(painter,coord,tile,layer,depthMode,stencilModes[coord.overscaledZ],colorMode)}context.viewport.set([0,0,painter.width,painter.height])}(painter,sourceCache,layer,coords);break;case"raster":!function(painter,sourceCache,layer,tileIDs){if("translucent"!==painter.renderPass)return;if(0===layer.paint.get("raster-opacity"))return;if(!tileIDs.length)return;const context=painter.context,gl=context.gl,source=sourceCache.getSource(),program=painter.useProgram("raster"),colorMode=painter.colorModeForRenderPass(),[stencilModes,coords]=source instanceof ImageSource?[{},tileIDs]:painter.stencilConfigForOverlap(tileIDs),minTileZ=coords[coords.length-1].overscaledZ,align=!painter.options.moving;for(const coord of coords){const depthMode=painter.depthModeForSublayer(coord.overscaledZ-minTileZ,1===layer.paint.get("raster-opacity")?DepthMode.ReadWrite:DepthMode.ReadOnly,gl.LESS),tile=sourceCache.getTile(coord);tile.registerFadeDuration(layer.paint.get("raster-fade-duration"));const parentTile=sourceCache.findLoadedParent(coord,0),fade=getFadeValues(tile,parentTile,sourceCache,layer,painter.transform,painter.style.map.terrain);let parentScaleBy,parentTL;const textureFilter="nearest"===layer.paint.get("raster-resampling")?gl.NEAREST:gl.LINEAR;context.activeTexture.set(gl.TEXTURE0),tile.texture.bind(textureFilter,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST),context.activeTexture.set(gl.TEXTURE1),parentTile?(parentTile.texture.bind(textureFilter,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST),parentScaleBy=Math.pow(2,parentTile.tileID.overscaledZ-tile.tileID.overscaledZ),parentTL=[tile.tileID.canonical.x*parentScaleBy%1,tile.tileID.canonical.y*parentScaleBy%1]):tile.texture.bind(textureFilter,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST);const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord),terrainCoord=terrainData?coord:null,posMatrix=terrainCoord?terrainCoord.posMatrix:painter.transform.calculatePosMatrix(coord.toUnwrapped(),align),uniformValues=rasterUniformValues(posMatrix,parentTL||[0,0],parentScaleBy||1,fade,layer);source instanceof ImageSource?program.draw(context,gl.TRIANGLES,depthMode,StencilMode.disabled,colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,source.boundsBuffer,painter.quadTriangleIndexBuffer,source.boundsSegments):program.draw(context,gl.TRIANGLES,depthMode,stencilModes[coord.overscaledZ],colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,painter.rasterBoundsBuffer,painter.quadTriangleIndexBuffer,painter.rasterBoundsSegments)}}(painter,sourceCache,layer,coords);break;case"background":!function(painter,sourceCache,layer,coords){const color=layer.paint.get("background-color"),opacity=layer.paint.get("background-opacity");if(0===opacity)return;const context=painter.context,gl=context.gl,transform=painter.transform,tileSize=transform.tileSize,image=layer.paint.get("background-pattern");if(painter.isPatternMissing(image))return;const pass=!image&&1===color.a&&1===opacity&&painter.opaquePassEnabledForLayer()?"opaque":"translucent";if(painter.renderPass!==pass)return;const stencilMode=StencilMode.disabled,depthMode=painter.depthModeForSublayer(0,"opaque"===pass?DepthMode.ReadWrite:DepthMode.ReadOnly),colorMode=painter.colorModeForRenderPass(),program=painter.useProgram(image?"backgroundPattern":"background"),tileIDs=coords||transform.coveringTiles({tileSize:tileSize,terrain:painter.style.map.terrain});image&&(context.activeTexture.set(gl.TEXTURE0),painter.imageManager.bind(painter.context));const crossfade=layer.getCrossfadeParameters();for(const tileID of tileIDs){const matrix=coords?tileID.posMatrix:painter.transform.calculatePosMatrix(tileID.toUnwrapped()),uniformValues=image?backgroundPatternUniformValues(matrix,opacity,painter,image,{tileID:tileID,tileSize:tileSize},crossfade):backgroundUniformValues(matrix,opacity,color),terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(tileID);program.draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,painter.tileExtentBuffer,painter.quadTriangleIndexBuffer,painter.tileExtentSegments)}}(painter,0,layer,coords);break;case"custom":!function(painter,sourceCache,layer){const context=painter.context,implementation=layer.implementation;if("offscreen"===painter.renderPass){const prerender=implementation.prerender;prerender&&(painter.setCustomLayerDefaults(),context.setColorMode(painter.colorModeForRenderPass()),prerender.call(implementation,context.gl,painter.transform.customLayerMatrix()),context.setDirty(),painter.setBaseState())}else if("translucent"===painter.renderPass){painter.setCustomLayerDefaults(),context.setColorMode(painter.colorModeForRenderPass()),context.setStencilMode(StencilMode.disabled);const depthMode="3d"===implementation.renderingMode?new DepthMode(painter.context.gl.LEQUAL,DepthMode.ReadWrite,painter.depthRangeFor3D):painter.depthModeForSublayer(0,DepthMode.ReadOnly);context.setDepthMode(depthMode),implementation.render(context.gl,painter.transform.customLayerMatrix()),context.setDirty(),painter.setBaseState(),context.bindFramebuffer.set(null)}}(painter,0,layer)}}translatePosMatrix(matrix,tile,translate,translateAnchor,inViewportPixelUnitsUnits){if(!translate[0]&&!translate[1])return matrix;const angle=inViewportPixelUnitsUnits?"map"===translateAnchor?this.transform.angle:0:"viewport"===translateAnchor?-this.transform.angle:0;if(angle){const sinA=Math.sin(angle),cosA=Math.cos(angle);translate=[translate[0]*cosA-translate[1]*sinA,translate[0]*sinA+translate[1]*cosA]}const translation=[inViewportPixelUnitsUnits?translate[0]:pixelsToTileUnits(tile,translate[0],this.transform.zoom),inViewportPixelUnitsUnits?translate[1]:pixelsToTileUnits(tile,translate[1],this.transform.zoom),0],translatedMatrix=new Float32Array(16);return performance$1.translate(translatedMatrix,matrix,translation),translatedMatrix}saveTileTexture(texture){const textures=this._tileTextures[texture.size[0]];textures?textures.push(texture):this._tileTextures[texture.size[0]]=[texture]}getTileTexture(size){const textures=this._tileTextures[size];return textures&&textures.length>0?textures.pop():null}isPatternMissing(image){if(!image)return!1;if(!image.from||!image.to)return!0;const imagePosA=this.imageManager.getPattern(image.from.toString()),imagePosB=this.imageManager.getPattern(image.to.toString());return!imagePosA||!imagePosB}useProgram(name,programConfiguration){this.cache=this.cache||{};const key=name+(programConfiguration?programConfiguration.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.map.terrain?"/terrain":"");return this.cache[key]||(this.cache[key]=new Program(this.context,shaders[name],programConfiguration,programUniforms[name],this._showOverdrawInspector,this.style.map.terrain)),this.cache[key]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const gl=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(gl.FUNC_ADD)}initDebugOverlayCanvas(){if(null==this.debugOverlayCanvas){this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512;const gl=this.context.gl;this.debugOverlayTexture=new Texture(this.context,this.debugOverlayCanvas,gl.RGBA)}}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:drawingBufferWidth,drawingBufferHeight:drawingBufferHeight}=this.context.gl;return this.width!==drawingBufferWidth||this.height!==drawingBufferHeight}}class Frustum{constructor(points,planes){this.points=points,this.planes=planes}static fromInvProjectionMatrix(invProj,worldSize,zoom){const scale=Math.pow(2,zoom),frustumCoords=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((v=>{const s=1/(v=performance$1.transformMat4([],v,invProj))[3]/worldSize*scale;return performance$1.mul$1(v,v,[s,s,1/v[3],s])})),frustumPlanes=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((p=>{const a=performance$1.sub([],frustumCoords[p[0]],frustumCoords[p[1]]),b=performance$1.sub([],frustumCoords[p[2]],frustumCoords[p[1]]),n=performance$1.normalize([],performance$1.cross([],a,b)),d=-performance$1.dot(n,frustumCoords[p[1]]);return n.concat(d)}));return new Frustum(frustumCoords,frustumPlanes)}}class Aabb{constructor(min_,max_){this.min=min_,this.max=max_,this.center=performance$1.scale$1([],performance$1.add([],this.min,this.max),.5)}quadrant(index){const split=[index%2==0,index<2],qMin=performance$1.clone$2(this.min),qMax=performance$1.clone$2(this.max);for(let axis=0;axis<split.length;axis++)qMin[axis]=split[axis]?this.min[axis]:this.center[axis],qMax[axis]=split[axis]?this.center[axis]:this.max[axis];return qMax[2]=this.max[2],new Aabb(qMin,qMax)}distanceX(point){return Math.max(Math.min(this.max[0],point[0]),this.min[0])-point[0]}distanceY(point){return Math.max(Math.min(this.max[1],point[1]),this.min[1])-point[1]}intersects(frustum){const aabbPoints=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let fullyInside=!0;for(let p=0;p<frustum.planes.length;p++){const plane=frustum.planes[p];let pointsInside=0;for(let i=0;i<aabbPoints.length;i++)performance$1.dot$1(plane,aabbPoints[i])>=0&&pointsInside++;if(0===pointsInside)return 0;pointsInside!==aabbPoints.length&&(fullyInside=!1)}if(fullyInside)return 2;for(let axis=0;axis<3;axis++){let projMin=Number.MAX_VALUE,projMax=-Number.MAX_VALUE;for(let p=0;p<frustum.points.length;p++){const projectedPoint=frustum.points[p][axis]-this.min[axis];projMin=Math.min(projMin,projectedPoint),projMax=Math.max(projMax,projectedPoint)}if(projMax<0||projMin>this.max[axis]-this.min[axis])return 0}return 1}}class EdgeInsets{constructor(top=0,bottom=0,left=0,right=0){if(isNaN(top)||top<0||isNaN(bottom)||bottom<0||isNaN(left)||left<0||isNaN(right)||right<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=top,this.bottom=bottom,this.left=left,this.right=right}interpolate(start,target,t){return null!=target.top&&null!=start.top&&(this.top=performance$1.interpolate.number(start.top,target.top,t)),null!=target.bottom&&null!=start.bottom&&(this.bottom=performance$1.interpolate.number(start.bottom,target.bottom,t)),null!=target.left&&null!=start.left&&(this.left=performance$1.interpolate.number(start.left,target.left,t)),null!=target.right&&null!=start.right&&(this.right=performance$1.interpolate.number(start.right,target.right,t)),this}getCenter(width,height){const x=performance$1.clamp((this.left+width-this.right)/2,0,width),y=performance$1.clamp((this.top+height-this.bottom)/2,0,height);return new performance$1.Point(x,y)}equals(other){return this.top===other.top&&this.bottom===other.bottom&&this.left===other.left&&this.right===other.right}clone(){return new EdgeInsets(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}class Transform{constructor(minZoom,maxZoom,minPitch,maxPitch,renderWorldCopies){this.tileSize=512,this.maxValidLatitude=85.051129,this._renderWorldCopies=void 0===renderWorldCopies||!!renderWorldCopies,this._minZoom=minZoom||0,this._maxZoom=maxZoom||22,this._minPitch=null==minPitch?0:minPitch,this._maxPitch=null==maxPitch?60:maxPitch,this.setMaxBounds(),this.width=0,this.height=0,this._center=new performance$1.LngLat(0,0),this._elevation=0,this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._unmodified=!0,this._edgeInsets=new EdgeInsets,this._posMatrixCache={},this._alignedPosMatrixCache={},this.minElevationForCurrentTile=0}clone(){const clone=new Transform(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return clone.apply(this),clone}apply(that){this.tileSize=that.tileSize,this.latRange=that.latRange,this.width=that.width,this.height=that.height,this._center=that._center,this._elevation=that._elevation,this.minElevationForCurrentTile=that.minElevationForCurrentTile,this.zoom=that.zoom,this.angle=that.angle,this._fov=that._fov,this._pitch=that._pitch,this._unmodified=that._unmodified,this._edgeInsets=that._edgeInsets.clone(),this._calcMatrices()}get minZoom(){return this._minZoom}set minZoom(zoom){this._minZoom!==zoom&&(this._minZoom=zoom,this.zoom=Math.max(this.zoom,zoom))}get maxZoom(){return this._maxZoom}set maxZoom(zoom){this._maxZoom!==zoom&&(this._maxZoom=zoom,this.zoom=Math.min(this.zoom,zoom))}get minPitch(){return this._minPitch}set minPitch(pitch){this._minPitch!==pitch&&(this._minPitch=pitch,this.pitch=Math.max(this.pitch,pitch))}get maxPitch(){return this._maxPitch}set maxPitch(pitch){this._maxPitch!==pitch&&(this._maxPitch=pitch,this.pitch=Math.min(this.pitch,pitch))}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(renderWorldCopies){void 0===renderWorldCopies?renderWorldCopies=!0:null===renderWorldCopies&&(renderWorldCopies=!1),this._renderWorldCopies=renderWorldCopies}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new performance$1.Point(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(bearing){const b=-performance$1.wrap(bearing,-180,180)*Math.PI/180;this.angle!==b&&(this._unmodified=!1,this.angle=b,this._calcMatrices(),this.rotationMatrix=performance$1.create$2(),performance$1.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(pitch){const p=performance$1.clamp(pitch,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==p&&(this._unmodified=!1,this._pitch=p,this._calcMatrices())}get fov(){return this._fov/Math.PI*180}set fov(fov){fov=Math.max(.01,Math.min(60,fov)),this._fov!==fov&&(this._unmodified=!1,this._fov=fov/180*Math.PI,this._calcMatrices())}get zoom(){return this._zoom}set zoom(zoom){const constrainedZoom=Math.min(Math.max(zoom,this.minZoom),this.maxZoom);this._zoom!==constrainedZoom&&(this._unmodified=!1,this._zoom=constrainedZoom,this.tileZoom=Math.max(0,Math.floor(constrainedZoom)),this.scale=this.zoomScale(constrainedZoom),this._constrain(),this._calcMatrices())}get center(){return this._center}set center(center){center.lat===this._center.lat&&center.lng===this._center.lng||(this._unmodified=!1,this._center=center,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}set elevation(elevation){elevation!==this._elevation&&(this._elevation=elevation,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}set padding(padding){this._edgeInsets.equals(padding)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,padding,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(padding){return this._edgeInsets.equals(padding)}interpolatePadding(start,target,t){this._unmodified=!1,this._edgeInsets.interpolate(start,target,t),this._constrain(),this._calcMatrices()}coveringZoomLevel(options){const z=(options.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/options.tileSize));return Math.max(0,z)}getVisibleUnwrappedCoordinates(tileID){const result=[new performance$1.UnwrappedTileID(0,tileID)];if(this._renderWorldCopies){const utl=this.pointCoordinate(new performance$1.Point(0,0)),utr=this.pointCoordinate(new performance$1.Point(this.width,0)),ubl=this.pointCoordinate(new performance$1.Point(this.width,this.height)),ubr=this.pointCoordinate(new performance$1.Point(0,this.height)),w0=Math.floor(Math.min(utl.x,utr.x,ubl.x,ubr.x)),w1=Math.floor(Math.max(utl.x,utr.x,ubl.x,ubr.x)),extraWorldCopy=1;for(let w=w0-extraWorldCopy;w<=w1+extraWorldCopy;w++)0!==w&&result.push(new performance$1.UnwrappedTileID(w,tileID))}return result}coveringTiles(options){var _a,_b;let z=this.coveringZoomLevel(options);const actualZ=z;if(void 0!==options.minzoom&&z<options.minzoom)return[];void 0!==options.maxzoom&&z>options.maxzoom&&(z=options.maxzoom);const cameraCoord=this.pointCoordinate(this.getCameraPoint()),centerCoord=performance$1.MercatorCoordinate.fromLngLat(this.center),numTiles=Math.pow(2,z),cameraPoint=[numTiles*cameraCoord.x,numTiles*cameraCoord.y,0],centerPoint=[numTiles*centerCoord.x,numTiles*centerCoord.y,0],cameraFrustum=Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,z);let minZoom=options.minzoom||0;!options.terrain&&this.pitch<=60&&this._edgeInsets.top<.1&&(minZoom=z);const radiusOfMaxLvlLodInTiles=options.terrain?2/Math.min(this.tileSize,options.tileSize)*this.tileSize:3,newRootTile=wrap=>({aabb:new Aabb([wrap*numTiles,0,0],[(wrap+1)*numTiles,numTiles,0]),zoom:0,x:0,y:0,wrap:wrap,fullyVisible:!1}),stack=[],result=[],maxZoom=z,overscaledZ=options.reparseOverscaled?actualZ:z;if(this._renderWorldCopies)for(let i=1;i<=3;i++)stack.push(newRootTile(-i)),stack.push(newRootTile(i));for(stack.push(newRootTile(0));stack.length>0;){const it=stack.pop(),x=it.x,y=it.y;let fullyVisible=it.fullyVisible;if(!fullyVisible){const intersectResult=it.aabb.intersects(cameraFrustum);if(0===intersectResult)continue;fullyVisible=2===intersectResult}const refPoint=options.terrain?cameraPoint:centerPoint,distanceX=it.aabb.distanceX(refPoint),distanceY=it.aabb.distanceY(refPoint),longestDim=Math.max(Math.abs(distanceX),Math.abs(distanceY)),distToSplit=radiusOfMaxLvlLodInTiles+(1<<maxZoom-it.zoom)-2;if(it.zoom===maxZoom||longestDim>distToSplit&&it.zoom>=minZoom){const dz=maxZoom-it.zoom,dx=cameraPoint[0]-.5-(x<<dz),dy=cameraPoint[1]-.5-(y<<dz);result.push({tileID:new performance$1.OverscaledTileID(it.zoom===maxZoom?overscaledZ:it.zoom,it.wrap,it.zoom,x,y),distanceSq:performance$1.sqrLen([centerPoint[0]-.5-x,centerPoint[1]-.5-y]),tileDistanceToCamera:Math.sqrt(dx*dx+dy*dy)})}else for(let i=0;i<4;i++){const childX=(x<<1)+i%2,childY=(y<<1)+(i>>1),childZ=it.zoom+1;let quadrant=it.aabb.quadrant(i);if(options.terrain){const tileID=new performance$1.OverscaledTileID(childZ,it.wrap,childZ,childX,childY),minMax=options.terrain.getMinMaxElevation(tileID),minElevation=null!==(_a=minMax.minElevation)&&void 0!==_a?_a:this.elevation,maxElevation=null!==(_b=minMax.maxElevation)&&void 0!==_b?_b:this.elevation;quadrant=new Aabb([quadrant.min[0],quadrant.min[1],minElevation],[quadrant.max[0],quadrant.max[1],maxElevation])}stack.push({aabb:quadrant,zoom:childZ,x:childX,y:childY,wrap:it.wrap,fullyVisible:fullyVisible})}}return result.sort(((a,b)=>a.distanceSq-b.distanceSq)).map((a=>a.tileID))}resize(width,height){this.width=width,this.height=height,this.pixelsToGLUnits=[2/width,-2/height],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(zoom){return Math.pow(2,zoom)}scaleZoom(scale){return Math.log(scale)/Math.LN2}project(lnglat){const lat=performance$1.clamp(lnglat.lat,-this.maxValidLatitude,this.maxValidLatitude);return new performance$1.Point(performance$1.mercatorXfromLng(lnglat.lng)*this.worldSize,performance$1.mercatorYfromLat(lat)*this.worldSize)}unproject(point){return new performance$1.MercatorCoordinate(point.x/this.worldSize,point.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}getCameraPosition(){return{lngLat:this.pointLocation(this.getCameraPoint()),altitude:Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter+this.elevation}}recalculateZoom(terrain){const center=this.pointLocation(this.centerPoint,terrain),elevation=terrain.getElevationForLngLatZoom(center,this.tileZoom);if(!(this.elevation-elevation))return;const cameraPosition=this.getCameraPosition(),camera=performance$1.MercatorCoordinate.fromLngLat(cameraPosition.lngLat,cameraPosition.altitude),target=performance$1.MercatorCoordinate.fromLngLat(center,elevation),dx=camera.x-target.x,dy=camera.y-target.y,dz=camera.z-target.z,distance=Math.sqrt(dx*dx+dy*dy+dz*dz),zoom=this.scaleZoom(this.cameraToCenterDistance/distance/this.tileSize);this._elevation=elevation,this._center=center,this.zoom=zoom}setLocationAtPoint(lnglat,point){const a=this.pointCoordinate(point),b=this.pointCoordinate(this.centerPoint),loc=this.locationCoordinate(lnglat),newCenter=new performance$1.MercatorCoordinate(loc.x-(a.x-b.x),loc.y-(a.y-b.y));this.center=this.coordinateLocation(newCenter),this._renderWorldCopies&&(this.center=this.center.wrap())}locationPoint(lnglat,terrain){return terrain?this.coordinatePoint(this.locationCoordinate(lnglat),terrain.getElevationForLngLatZoom(lnglat,this.tileZoom),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(lnglat))}pointLocation(p,terrain){return this.coordinateLocation(this.pointCoordinate(p,terrain))}locationCoordinate(lnglat){return performance$1.MercatorCoordinate.fromLngLat(lnglat)}coordinateLocation(coord){return coord&&coord.toLngLat()}pointCoordinate(p,terrain){if(terrain){const coordinate=terrain.pointCoordinate(p);if(null!=coordinate)return coordinate}const coord0=[p.x,p.y,0,1],coord1=[p.x,p.y,1,1];performance$1.transformMat4(coord0,coord0,this.pixelMatrixInverse),performance$1.transformMat4(coord1,coord1,this.pixelMatrixInverse);const w0=coord0[3],w1=coord1[3],x0=coord0[0]/w0,x1=coord1[0]/w1,y0=coord0[1]/w0,y1=coord1[1]/w1,z0=coord0[2]/w0,z1=coord1[2]/w1,t=z0===z1?0:(0-z0)/(z1-z0);return new performance$1.MercatorCoordinate(performance$1.interpolate.number(x0,x1,t)/this.worldSize,performance$1.interpolate.number(y0,y1,t)/this.worldSize)}coordinatePoint(coord,elevation=0,pixelMatrix=this.pixelMatrix){const p=[coord.x*this.worldSize,coord.y*this.worldSize,elevation,1];return performance$1.transformMat4(p,p,pixelMatrix),new performance$1.Point(p[0]/p[3],p[1]/p[3])}getBounds(){const top=Math.max(0,this.height/2-this.getHorizon());return(new LngLatBounds).extend(this.pointLocation(new performance$1.Point(0,top))).extend(this.pointLocation(new performance$1.Point(this.width,top))).extend(this.pointLocation(new performance$1.Point(this.width,this.height))).extend(this.pointLocation(new performance$1.Point(0,this.height)))}getMaxBounds(){return this.latRange&&2===this.latRange.length&&this.lngRange&&2===this.lngRange.length?new LngLatBounds([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]]):null}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(bounds){bounds?(this.lngRange=[bounds.getWest(),bounds.getEast()],this.latRange=[bounds.getSouth(),bounds.getNorth()],this._constrain()):(this.lngRange=null,this.latRange=[-this.maxValidLatitude,this.maxValidLatitude])}calculatePosMatrix(unwrappedTileID,aligned=!1){const posMatrixKey=unwrappedTileID.key,cache=aligned?this._alignedPosMatrixCache:this._posMatrixCache;if(cache[posMatrixKey])return cache[posMatrixKey];const canonical=unwrappedTileID.canonical,scale=this.worldSize/this.zoomScale(canonical.z),unwrappedX=canonical.x+Math.pow(2,canonical.z)*unwrappedTileID.wrap,posMatrix=performance$1.identity(new Float64Array(16));return performance$1.translate(posMatrix,posMatrix,[unwrappedX*scale,canonical.y*scale,0]),performance$1.scale(posMatrix,posMatrix,[scale/performance$1.EXTENT,scale/performance$1.EXTENT,1]),performance$1.multiply(posMatrix,aligned?this.alignedProjMatrix:this.projMatrix,posMatrix),cache[posMatrixKey]=new Float32Array(posMatrix),cache[posMatrixKey]}customLayerMatrix(){return this.mercatorMatrix.slice()}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let sy,sx,x2,y2,minY=-90,maxY=90,minX=-180,maxX=180;const size=this.size,unmodified=this._unmodified;if(this.latRange){const latRange=this.latRange;minY=performance$1.mercatorYfromLat(latRange[1])*this.worldSize,maxY=performance$1.mercatorYfromLat(latRange[0])*this.worldSize,sy=maxY-minY<size.y?size.y/(maxY-minY):0}if(this.lngRange){const lngRange=this.lngRange;minX=performance$1.wrap(performance$1.mercatorXfromLng(lngRange[0])*this.worldSize,0,this.worldSize),maxX=performance$1.wrap(performance$1.mercatorXfromLng(lngRange[1])*this.worldSize,0,this.worldSize),maxX<minX&&(maxX+=this.worldSize),sx=maxX-minX<size.x?size.x/(maxX-minX):0}const point=this.point,s=Math.max(sx||0,sy||0);if(s)return this.center=this.unproject(new performance$1.Point(sx?(maxX+minX)/2:point.x,sy?(maxY+minY)/2:point.y)),this.zoom+=this.scaleZoom(s),this._unmodified=unmodified,void(this._constraining=!1);if(this.latRange){const y=point.y,h2=size.y/2;y-h2<minY&&(y2=minY+h2),y+h2>maxY&&(y2=maxY-h2)}if(this.lngRange){const centerX=(minX+maxX)/2,x=performance$1.wrap(point.x,centerX-this.worldSize/2,centerX+this.worldSize/2),w2=size.x/2;x-w2<minX&&(x2=minX+w2),x+w2>maxX&&(x2=maxX-w2)}void 0===x2&&void 0===y2||(this.center=this.unproject(new performance$1.Point(void 0!==x2?x2:point.x,void 0!==y2?y2:point.y)).wrap()),this._unmodified=unmodified,this._constraining=!1}_calcMatrices(){if(!this.height)return;const halfFov=this._fov/2,offset=this.centerOffset,x=this.point.x,y=this.point.y;this.cameraToCenterDistance=.5/Math.tan(halfFov)*this.height,this._pixelPerMeter=performance$1.mercatorZfromAltitude(1,this.center.lat)*this.worldSize;let m=performance$1.identity(new Float64Array(16));performance$1.scale(m,m,[this.width/2,-this.height/2,1]),performance$1.translate(m,m,[1,-1,0]),this.labelPlaneMatrix=m,m=performance$1.identity(new Float64Array(16)),performance$1.scale(m,m,[1,-1,1]),performance$1.translate(m,m,[-1,-1,0]),performance$1.scale(m,m,[2/this.width,2/this.height,1]),this.glCoordMatrix=m;const cameraToSeaLevelDistance=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch),minElevation=Math.min(this.elevation,this.minElevationForCurrentTile),cameraToLowestPointDistance=cameraToSeaLevelDistance-minElevation*this._pixelPerMeter/Math.cos(this._pitch),lowestPlane=minElevation<0?cameraToLowestPointDistance:cameraToSeaLevelDistance,groundAngle=Math.PI/2+this._pitch,fovAboveCenter=this._fov*(.5+offset.y/this.height),topHalfSurfaceDistance=Math.sin(fovAboveCenter)*lowestPlane/Math.sin(performance$1.clamp(Math.PI-groundAngle-fovAboveCenter,.01,Math.PI-.01)),horizon=this.getHorizon(),fovCenterToHorizon=2*Math.atan(horizon/this.cameraToCenterDistance)*(.5+offset.y/(2*horizon)),topHalfSurfaceDistanceHorizon=Math.sin(fovCenterToHorizon)*lowestPlane/Math.sin(performance$1.clamp(Math.PI-groundAngle-fovCenterToHorizon,.01,Math.PI-.01)),topHalfMinDistance=Math.min(topHalfSurfaceDistance,topHalfSurfaceDistanceHorizon),farZ=1.01*(Math.cos(Math.PI/2-this._pitch)*topHalfMinDistance+lowestPlane),nearZ=this.height/50;m=new Float64Array(16),performance$1.perspective(m,this._fov,this.width/this.height,nearZ,farZ),m[8]=2*-offset.x/this.width,m[9]=2*offset.y/this.height,performance$1.scale(m,m,[1,-1,1]),performance$1.translate(m,m,[0,0,-this.cameraToCenterDistance]),performance$1.rotateX(m,m,this._pitch),performance$1.rotateZ(m,m,this.angle),performance$1.translate(m,m,[-x,-y,0]),this.mercatorMatrix=performance$1.scale([],m,[this.worldSize,this.worldSize,this.worldSize]),performance$1.scale(m,m,[1,1,this._pixelPerMeter]),this.pixelMatrix=performance$1.multiply(new Float64Array(16),this.labelPlaneMatrix,m),performance$1.translate(m,m,[0,0,-this.elevation]),this.projMatrix=m,this.invProjMatrix=performance$1.invert([],m),this.pixelMatrix3D=performance$1.multiply(new Float64Array(16),this.labelPlaneMatrix,m);const xShift=this.width%2/2,yShift=this.height%2/2,angleCos=Math.cos(this.angle),angleSin=Math.sin(this.angle),dx=x-Math.round(x)+angleCos*xShift+angleSin*yShift,dy=y-Math.round(y)+angleCos*yShift+angleSin*xShift,alignedM=new Float64Array(m);if(performance$1.translate(alignedM,alignedM,[dx>.5?dx-1:dx,dy>.5?dy-1:dy,0]),this.alignedProjMatrix=alignedM,m=performance$1.invert(new Float64Array(16),this.pixelMatrix),!m)throw new Error("failed to invert matrix");this.pixelMatrixInverse=m,this._posMatrixCache={},this._alignedPosMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const coord=this.pointCoordinate(new performance$1.Point(0,0)),p=[coord.x*this.worldSize,coord.y*this.worldSize,0,1];return performance$1.transformMat4(p,p,this.pixelMatrix)[3]/this.cameraToCenterDistance}getCameraPoint(){const pitch=this._pitch,yOffset=Math.tan(pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new performance$1.Point(0,yOffset))}getCameraQueryGeometry(queryGeometry){const c=this.getCameraPoint();if(1===queryGeometry.length)return[queryGeometry[0],c];{let minX=c.x,minY=c.y,maxX=c.x,maxY=c.y;for(const p of queryGeometry)minX=Math.min(minX,p.x),minY=Math.min(minY,p.y),maxX=Math.max(maxX,p.x),maxY=Math.max(maxY,p.y);return[new performance$1.Point(minX,minY),new performance$1.Point(maxX,minY),new performance$1.Point(maxX,maxY),new performance$1.Point(minX,maxY),new performance$1.Point(minX,minY)]}}lngLatToCameraDepth(lngLat,elevation){const coord=this.locationCoordinate(lngLat),p=[coord.x*this.worldSize,coord.y*this.worldSize,elevation,1];return performance$1.transformMat4(p,p,this.projMatrix),p[2]/p[3]}}function throttle(fn,time){let lastCallArgs,pending=!1,timerId=null,lastCallContext=null;const later=()=>{timerId=null,pending&&(fn.apply(lastCallContext,lastCallArgs),timerId=setTimeout(later,time),pending=!1)};return(...args)=>(pending=!0,lastCallContext=this,lastCallArgs=args,timerId||later(),timerId)}class Hash{constructor(hashName){this._getCurrentHash=()=>{const hash=window.location.hash.replace("#","");if(this._hashName){let keyval;return hash.split("&").map((part=>part.split("="))).forEach((part=>{part[0]===this._hashName&&(keyval=part)})),(keyval&&keyval[1]||"").split("/")}return hash.split("/")},this._onHashChange=()=>{const loc=this._getCurrentHash();if(loc.length>=3&&!loc.some((v=>isNaN(v)))){const bearing=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(loc[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+loc[2],+loc[1]],zoom:+loc[0],bearing:bearing,pitch:+(loc[4]||0)}),!0}return!1},this._updateHashUnthrottled=()=>{const location=window.location.href.replace(/(#.+)?$/,this.getHashString());try{window.history.replaceState(window.history.state,null,location)}catch(SecurityError){}},this._updateHash=throttle(this._updateHashUnthrottled,300),this._hashName=hashName&&encodeURIComponent(hashName)}addTo(map){return this._map=map,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this}getHashString(mapFeedback){const center=this._map.getCenter(),zoom=Math.round(100*this._map.getZoom())/100,precision=Math.ceil((zoom*Math.LN2+Math.log(512/360/.5))/Math.LN10),m=Math.pow(10,precision),lng=Math.round(center.lng*m)/m,lat=Math.round(center.lat*m)/m,bearing=this._map.getBearing(),pitch=this._map.getPitch();let hash="";if(hash+=mapFeedback?`/${lng}/${lat}/${zoom}`:`${zoom}/${lat}/${lng}`,(bearing||pitch)&&(hash+="/"+Math.round(10*bearing)/10),pitch&&(hash+=`/${Math.round(pitch)}`),this._hashName){const hashName=this._hashName;let found=!1;const parts=window.location.hash.slice(1).split("&").map((part=>{const key=part.split("=")[0];return key===hashName?(found=!0,`${key}=${hash}`):part})).filter((a=>a));return found||parts.push(`${hashName}=${hash}`),`#${parts.join("&")}`}return`#${hash}`}}const defaultInertiaOptions={linearity:.3,easing:performance$1.bezier(0,0,.3,1)},defaultPanInertiaOptions=performance$1.extend({deceleration:2500,maxSpeed:1400},defaultInertiaOptions),defaultZoomInertiaOptions=performance$1.extend({deceleration:20,maxSpeed:1400},defaultInertiaOptions),defaultBearingInertiaOptions=performance$1.extend({deceleration:1e3,maxSpeed:360},defaultInertiaOptions),defaultPitchInertiaOptions=performance$1.extend({deceleration:1e3,maxSpeed:90},defaultInertiaOptions);class HandlerInertia{constructor(map){this._map=map,this.clear()}clear(){this._inertiaBuffer=[]}record(settings){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:browser.now(),settings:settings})}_drainInertiaBuffer(){const inertia=this._inertiaBuffer,now=browser.now();for(;inertia.length>0&&now-inertia[0].time>160;)inertia.shift()}_onMoveEnd(panInertiaOptions){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const deltas={zoom:0,bearing:0,pitch:0,pan:new performance$1.Point(0,0),pinchAround:void 0,around:void 0};for(const{settings:settings}of this._inertiaBuffer)deltas.zoom+=settings.zoomDelta||0,deltas.bearing+=settings.bearingDelta||0,deltas.pitch+=settings.pitchDelta||0,settings.panDelta&&deltas.pan._add(settings.panDelta),settings.around&&(deltas.around=settings.around),settings.pinchAround&&(deltas.pinchAround=settings.pinchAround);const duration=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,easeOptions={};if(deltas.pan.mag()){const result=calculateEasing(deltas.pan.mag(),duration,performance$1.extend({},defaultPanInertiaOptions,panInertiaOptions||{}));easeOptions.offset=deltas.pan.mult(result.amount/deltas.pan.mag()),easeOptions.center=this._map.transform.center,extendDuration(easeOptions,result)}if(deltas.zoom){const result=calculateEasing(deltas.zoom,duration,defaultZoomInertiaOptions);easeOptions.zoom=this._map.transform.zoom+result.amount,extendDuration(easeOptions,result)}if(deltas.bearing){const result=calculateEasing(deltas.bearing,duration,defaultBearingInertiaOptions);easeOptions.bearing=this._map.transform.bearing+performance$1.clamp(result.amount,-179,179),extendDuration(easeOptions,result)}if(deltas.pitch){const result=calculateEasing(deltas.pitch,duration,defaultPitchInertiaOptions);easeOptions.pitch=this._map.transform.pitch+result.amount,extendDuration(easeOptions,result)}if(easeOptions.zoom||easeOptions.bearing){const last=void 0===deltas.pinchAround?deltas.around:deltas.pinchAround;easeOptions.around=last?this._map.unproject(last):this._map.getCenter()}return this.clear(),performance$1.extend(easeOptions,{noMoveStart:!0})}}function extendDuration(easeOptions,result){(!easeOptions.duration||easeOptions.duration<result.duration)&&(easeOptions.duration=result.duration,easeOptions.easing=result.easing)}function calculateEasing(amount,inertiaDuration,inertiaOptions){const{maxSpeed:maxSpeed,linearity:linearity,deceleration:deceleration}=inertiaOptions,speed=performance$1.clamp(amount*linearity/(inertiaDuration/1e3),-maxSpeed,maxSpeed),duration=Math.abs(speed)/(deceleration*linearity);return{easing:inertiaOptions.easing,duration:1e3*duration,amount:speed*(duration/2)}}class MapMouseEvent extends performance$1.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(type,map,originalEvent,data={}){const point=DOM.mousePos(map.getCanvas(),originalEvent),lngLat=map.unproject(point);super(type,performance$1.extend({point:point,lngLat:lngLat,originalEvent:originalEvent},data)),this._defaultPrevented=!1,this.target=map}}class MapTouchEvent extends performance$1.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(type,map,originalEvent){const touches="touchend"===type?originalEvent.changedTouches:originalEvent.touches,points=DOM.touchPos(map.getCanvasContainer(),touches),lngLats=points.map((t=>map.unproject(t))),point=points.reduce(((prev,curr,i,arr)=>prev.add(curr.div(arr.length))),new performance$1.Point(0,0));super(type,{points:points,point:point,lngLats:lngLats,lngLat:map.unproject(point),originalEvent:originalEvent}),this._defaultPrevented=!1}}class MapWheelEvent extends performance$1.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(type,map,originalEvent){super(type,{originalEvent:originalEvent}),this._defaultPrevented=!1}}class MapEventHandler{constructor(map,options){this._map=map,this._clickTolerance=options.clickTolerance}reset(){delete this._mousedownPos}wheel(e){return this._firePreventable(new MapWheelEvent(e.type,this._map,e))}mousedown(e,point){return this._mousedownPos=point,this._firePreventable(new MapMouseEvent(e.type,this._map,e))}mouseup(e){this._map.fire(new MapMouseEvent(e.type,this._map,e))}click(e,point){this._mousedownPos&&this._mousedownPos.dist(point)>=this._clickTolerance||this._map.fire(new MapMouseEvent(e.type,this._map,e))}dblclick(e){return this._firePreventable(new MapMouseEvent(e.type,this._map,e))}mouseover(e){this._map.fire(new MapMouseEvent(e.type,this._map,e))}mouseout(e){this._map.fire(new MapMouseEvent(e.type,this._map,e))}touchstart(e){return this._firePreventable(new MapTouchEvent(e.type,this._map,e))}touchmove(e){this._map.fire(new MapTouchEvent(e.type,this._map,e))}touchend(e){this._map.fire(new MapTouchEvent(e.type,this._map,e))}touchcancel(e){this._map.fire(new MapTouchEvent(e.type,this._map,e))}_firePreventable(mapEvent){if(this._map.fire(mapEvent),mapEvent.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class BlockableMapEventHandler{constructor(map){this._map=map}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(e){this._map.fire(new MapMouseEvent(e.type,this._map,e))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new MapMouseEvent("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._ignoreContextMenu||this._map.fire(new MapMouseEvent(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class TransformProvider{constructor(map){this._map=map}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(point){return this.transform.pointLocation(performance$1.Point.convert(point),this._map.terrain)}}class BoxZoomHandler{constructor(map,options){this._map=map,this._tr=new TransformProvider(map),this._el=map.getCanvasContainer(),this._container=map.getContainer(),this._clickTolerance=options.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(e,point){this.isEnabled()&&e.shiftKey&&0===e.button&&(DOM.disableDrag(),this._startPos=this._lastPos=point,this._active=!0)}mousemoveWindow(e,point){if(!this._active)return;const pos=point;if(this._lastPos.equals(pos)||!this._box&&pos.dist(this._startPos)<this._clickTolerance)return;const p0=this._startPos;this._lastPos=pos,this._box||(this._box=DOM.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",e));const minX=Math.min(p0.x,pos.x),maxX=Math.max(p0.x,pos.x),minY=Math.min(p0.y,pos.y),maxY=Math.max(p0.y,pos.y);DOM.setTransform(this._box,`translate(${minX}px,${minY}px)`),this._box.style.width=maxX-minX+"px",this._box.style.height=maxY-minY+"px"}mouseupWindow(e,point){if(!this._active)return;if(0!==e.button)return;const p0=this._startPos,p1=point;if(this.reset(),DOM.suppressClick(),p0.x!==p1.x||p0.y!==p1.y)return this._map.fire(new performance$1.Event("boxzoomend",{originalEvent:e})),{cameraAnimation:map=>map.fitScreenCoordinates(p0,p1,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",e)}keydown(e){this._active&&27===e.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",e))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(DOM.remove(this._box),this._box=null),DOM.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(type,e){return this._map.fire(new performance$1.Event(type,{originalEvent:e}))}}function indexTouches(touches,points){if(touches.length!==points.length)throw new Error(`The number of touches and points are not equal - touches ${touches.length}, points ${points.length}`);const obj={};for(let i=0;i<touches.length;i++)obj[touches[i].identifier]=points[i];return obj}class SingleTapRecognizer{constructor(options){this.reset(),this.numTouches=options.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(e,points,mapTouches){(this.centroid||mapTouches.length>this.numTouches)&&(this.aborted=!0),this.aborted||(void 0===this.startTime&&(this.startTime=e.timeStamp),mapTouches.length===this.numTouches&&(this.centroid=function(points){const sum=new performance$1.Point(0,0);for(const point of points)sum._add(point);return sum.div(points.length)}(points),this.touches=indexTouches(mapTouches,points)))}touchmove(e,points,mapTouches){if(this.aborted||!this.centroid)return;const newTouches=indexTouches(mapTouches,points);for(const id in this.touches){const prevPos=this.touches[id],pos=newTouches[id];(!pos||pos.dist(prevPos)>30)&&(this.aborted=!0)}}touchend(e,points,mapTouches){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),0===mapTouches.length){const centroid=!this.aborted&&this.centroid;if(this.reset(),centroid)return centroid}}}class TapRecognizer{constructor(options){this.singleTap=new SingleTapRecognizer(options),this.numTaps=options.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(e,points,mapTouches){this.singleTap.touchstart(e,points,mapTouches)}touchmove(e,points,mapTouches){this.singleTap.touchmove(e,points,mapTouches)}touchend(e,points,mapTouches){const tap=this.singleTap.touchend(e,points,mapTouches);if(tap){const soonEnough=e.timeStamp-this.lastTime<500,closeEnough=!this.lastTap||this.lastTap.dist(tap)<30;if(soonEnough&&closeEnough||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=tap,this.count===this.numTaps)return this.reset(),tap}}}class TapZoomHandler{constructor(map){this._tr=new TransformProvider(map),this._zoomIn=new TapRecognizer({numTouches:1,numTaps:2}),this._zoomOut=new TapRecognizer({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(e,points,mapTouches){this._zoomIn.touchstart(e,points,mapTouches),this._zoomOut.touchstart(e,points,mapTouches)}touchmove(e,points,mapTouches){this._zoomIn.touchmove(e,points,mapTouches),this._zoomOut.touchmove(e,points,mapTouches)}touchend(e,points,mapTouches){const zoomInPoint=this._zoomIn.touchend(e,points,mapTouches),zoomOutPoint=this._zoomOut.touchend(e,points,mapTouches),tr=this._tr;return zoomInPoint?(this._active=!0,e.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:map=>map.easeTo({duration:300,zoom:tr.zoom+1,around:tr.unproject(zoomInPoint)},{originalEvent:e})}):zoomOutPoint?(this._active=!0,e.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:map=>map.easeTo({duration:300,zoom:tr.zoom-1,around:tr.unproject(zoomOutPoint)},{originalEvent:e})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class DragHandler{constructor(options){this._enabled=!!options.enable,this._moveStateManager=options.moveStateManager,this._clickTolerance=options.clickTolerance||1,this._moveFunction=options.move,this._activateOnStart=!!options.activateOnStart,options.assignEvents(this),this.reset()}reset(e){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(e)}_move(...params){const move=this._moveFunction(...params);if(move.bearingDelta||move.pitchDelta||move.around||move.panDelta)return this._active=!0,move}dragStart(e,point){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(e)&&(this._moveStateManager.startMove(e),this._lastPoint=point.length?point[0]:point,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(e,point){if(!this.isEnabled())return;const lastPoint=this._lastPoint;if(!lastPoint)return;if(e.preventDefault(),!this._moveStateManager.isValidMoveEvent(e))return void this.reset(e);const movePoint=point.length?point[0]:point;return!this._moved&&movePoint.dist(lastPoint)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=movePoint,this._move(lastPoint,movePoint))}dragEnd(e){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(e)&&(this._moved&&DOM.suppressClick(),this.reset(e))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const BUTTONS_FLAGS={0:1,2:2};class MouseMoveStateManager{constructor(options){this._correctEvent=options.checkCorrectEvent}startMove(e){const eventButton=DOM.mouseButton(e);this._eventButton=eventButton}endMove(_e){delete this._eventButton}isValidStartEvent(e){return this._correctEvent(e)}isValidMoveEvent(e){return!function(e,button){const flag=BUTTONS_FLAGS[button];return void 0===e.buttons||(e.buttons&flag)!==flag}(e,this._eventButton)}isValidEndEvent(e){return DOM.mouseButton(e)===this._eventButton}}class OneFingerTouchMoveStateManager{constructor(){this._firstTouch=void 0}_isOneFingerTouch(e){return 1===e.targetTouches.length}_isSameTouchEvent(e){return e.targetTouches[0].identifier===this._firstTouch}startMove(e){const firstTouch=e.targetTouches[0].identifier;this._firstTouch=firstTouch}endMove(_e){delete this._firstTouch}isValidStartEvent(e){return this._isOneFingerTouch(e)}isValidMoveEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}isValidEndEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}}const assignEvents$1=handler=>{handler.mousedown=handler.dragStart,handler.mousemoveWindow=handler.dragMove,handler.mouseup=handler.dragEnd,handler.contextmenu=function(e){e.preventDefault()}},generateMouseRotationHandler=({enable:enable,clickTolerance:clickTolerance,bearingDegreesPerPixelMoved:bearingDegreesPerPixelMoved=.8})=>{const mouseMoveStateManager=new MouseMoveStateManager({checkCorrectEvent:e=>0===DOM.mouseButton(e)&&e.ctrlKey||2===DOM.mouseButton(e)});return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({bearingDelta:(point.x-lastPoint.x)*bearingDegreesPerPixelMoved}),moveStateManager:mouseMoveStateManager,enable:enable,assignEvents:assignEvents$1})},generateMousePitchHandler=({enable:enable,clickTolerance:clickTolerance,pitchDegreesPerPixelMoved:pitchDegreesPerPixelMoved=-.5})=>{const mouseMoveStateManager=new MouseMoveStateManager({checkCorrectEvent:e=>0===DOM.mouseButton(e)&&e.ctrlKey||2===DOM.mouseButton(e)});return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({pitchDelta:(point.y-lastPoint.y)*pitchDegreesPerPixelMoved}),moveStateManager:mouseMoveStateManager,enable:enable,assignEvents:assignEvents$1})};class TouchPanHandler{constructor(options,map){this._clickTolerance=options.clickTolerance||1,this._map=map,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new performance$1.Point(0,0)}minTouchs(){return this._map.cooperativeGestures.isEnabled()?2:1}touchstart(e,points,mapTouches){return this._calculateTransform(e,points,mapTouches)}touchmove(e,points,mapTouches){if(this._active&&!(mapTouches.length<this.minTouchs()))return e.preventDefault(),this._calculateTransform(e,points,mapTouches)}touchend(e,points,mapTouches){this._calculateTransform(e,points,mapTouches),this._active&&mapTouches.length<this.minTouchs()&&this.reset()}touchcancel(){this.reset()}_calculateTransform(e,points,mapTouches){mapTouches.length>0&&(this._active=!0);const touches=indexTouches(mapTouches,points),touchPointSum=new performance$1.Point(0,0),touchDeltaSum=new performance$1.Point(0,0);let touchDeltaCount=0;for(const identifier in touches){const point=touches[identifier],prevPoint=this._touches[identifier];prevPoint&&(touchPointSum._add(point),touchDeltaSum._add(point.sub(prevPoint)),touchDeltaCount++,touches[identifier]=point)}if(this._touches=touches,touchDeltaCount<this.minTouchs()||!touchDeltaSum.mag())return;const panDelta=touchDeltaSum.div(touchDeltaCount);if(this._sum._add(panDelta),this._sum.mag()<this._clickTolerance)return;return{around:touchPointSum.div(touchDeltaCount),panDelta:panDelta}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class TwoFingersTouchHandler{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(e,points,mapTouches){this._firstTwoTouches||mapTouches.length<2||(this._firstTwoTouches=[mapTouches[0].identifier,mapTouches[1].identifier],this._start([points[0],points[1]]))}touchmove(e,points,mapTouches){if(!this._firstTwoTouches)return;e.preventDefault();const[idA,idB]=this._firstTwoTouches,a=getTouchById(mapTouches,points,idA),b=getTouchById(mapTouches,points,idB);if(!a||!b)return;const pinchAround=this._aroundCenter?null:a.add(b).div(2);return this._move([a,b],pinchAround,e)}touchend(e,points,mapTouches){if(!this._firstTwoTouches)return;const[idA,idB]=this._firstTwoTouches,a=getTouchById(mapTouches,points,idA),b=getTouchById(mapTouches,points,idB);a&&b||(this._active&&DOM.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(options){this._enabled=!0,this._aroundCenter=!!options&&"center"===options.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function getTouchById(mapTouches,points,identifier){for(let i=0;i<mapTouches.length;i++)if(mapTouches[i].identifier===identifier)return points[i]}function getZoomDelta(distance,lastDistance){return Math.log(distance/lastDistance)/Math.LN2}class TwoFingersTouchZoomHandler extends TwoFingersTouchHandler{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(points){this._startDistance=this._distance=points[0].dist(points[1])}_move(points,pinchAround){const lastDistance=this._distance;if(this._distance=points[0].dist(points[1]),this._active||!(Math.abs(getZoomDelta(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:getZoomDelta(this._distance,lastDistance),pinchAround:pinchAround}}}function getBearingDelta(a,b){return 180*a.angleWith(b)/Math.PI}class TwoFingersTouchRotateHandler extends TwoFingersTouchHandler{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(points){this._startVector=this._vector=points[0].sub(points[1]),this._minDiameter=points[0].dist(points[1])}_move(points,pinchAround,_e){const lastVector=this._vector;if(this._vector=points[0].sub(points[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:getBearingDelta(this._vector,lastVector),pinchAround:pinchAround}}_isBelowThreshold(vector){this._minDiameter=Math.min(this._minDiameter,vector.mag());const threshold=25/(Math.PI*this._minDiameter)*360,bearingDeltaSinceStart=getBearingDelta(vector,this._startVector);return Math.abs(bearingDeltaSinceStart)<threshold}}function isVertical(vector){return Math.abs(vector.y)>Math.abs(vector.x)}class TwoFingersTouchPitchHandler extends TwoFingersTouchHandler{constructor(map){super(),this._currentTouchCount=0,this._map=map}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(e,points,mapTouches){super.touchstart(e,points,mapTouches),this._currentTouchCount=mapTouches.length}_start(points){this._lastPoints=points,isVertical(points[0].sub(points[1]))&&(this._valid=!1)}_move(points,center,e){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const vectorA=points[0].sub(this._lastPoints[0]),vectorB=points[1].sub(this._lastPoints[1]);if(this._valid=this.gestureBeginsVertically(vectorA,vectorB,e.timeStamp),!this._valid)return;this._lastPoints=points,this._active=!0;return{pitchDelta:-.5*((vectorA.y+vectorB.y)/2)}}gestureBeginsVertically(vectorA,vectorB,timeStamp){if(void 0!==this._valid)return this._valid;const movedA=vectorA.mag()>=2,movedB=vectorB.mag()>=2;if(!movedA&&!movedB)return;if(!movedA||!movedB)return void 0===this._firstMove&&(this._firstMove=timeStamp),timeStamp-this._firstMove<100&&void 0;const isSameDirection=vectorA.y>0==vectorB.y>0;return isVertical(vectorA)&&isVertical(vectorB)&&isSameDirection}}const defaultOptions$5={panStep:100,bearingStep:15,pitchStep:10};class KeyboardHandler{constructor(map){this._tr=new TransformProvider(map);const stepOptions=defaultOptions$5;this._panStep=stepOptions.panStep,this._bearingStep=stepOptions.bearingStep,this._pitchStep=stepOptions.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let zoomDir=0,bearingDir=0,pitchDir=0,xDir=0,yDir=0;switch(e.keyCode){case 61:case 107:case 171:case 187:zoomDir=1;break;case 189:case 109:case 173:zoomDir=-1;break;case 37:e.shiftKey?bearingDir=-1:(e.preventDefault(),xDir=-1);break;case 39:e.shiftKey?bearingDir=1:(e.preventDefault(),xDir=1);break;case 38:e.shiftKey?pitchDir=1:(e.preventDefault(),yDir=-1);break;case 40:e.shiftKey?pitchDir=-1:(e.preventDefault(),yDir=1);break;default:return}return this._rotationDisabled&&(bearingDir=0,pitchDir=0),{cameraAnimation:map=>{const tr=this._tr;map.easeTo({duration:300,easeId:"keyboardHandler",easing:easeOut,zoom:zoomDir?Math.round(tr.zoom)+zoomDir*(e.shiftKey?2:1):tr.zoom,bearing:tr.bearing+bearingDir*this._bearingStep,pitch:tr.pitch+pitchDir*this._pitchStep,offset:[-xDir*this._panStep,-yDir*this._panStep],center:tr.center},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function easeOut(t){return t*(2-t)}class ScrollZoomHandler{constructor(map,triggerRenderFrame){this._onTimeout=initialEvent=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(initialEvent)},this._map=map,this._tr=new TransformProvider(map),this._triggerRenderFrame=triggerRenderFrame,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(zoomRate){this._defaultZoomRate=zoomRate}setWheelZoomRate(wheelZoomRate){this._wheelZoomRate=wheelZoomRate}isEnabled(){return!!this._enabled}isActive(){return!!this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(options){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!options&&"center"===options.around)}disable(){this.isEnabled()&&(this._enabled=!1)}wheel(e){if(!this.isEnabled())return;if(this._map.cooperativeGestures.isEnabled()&&!e[this._map.cooperativeGestures._bypassKey])return;let value=e.deltaMode===WheelEvent.DOM_DELTA_LINE?40*e.deltaY:e.deltaY;const now=browser.now(),timeDelta=now-(this._lastWheelEventTime||0);this._lastWheelEventTime=now,0!==value&&value%4.000244140625==0?this._type="wheel":0!==value&&Math.abs(value)<4?this._type="trackpad":timeDelta>400?(this._type=null,this._lastValue=value,this._timeout=setTimeout(this._onTimeout,40,e)):this._type||(this._type=Math.abs(timeDelta*value)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,value+=this._lastValue)),e.shiftKey&&value&&(value/=4),this._type&&(this._lastWheelEvent=e,this._delta-=value,this._active||this._start(e)),e.preventDefault()}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const pos=DOM.mousePos(this._map.getCanvas(),e),tr=this._tr;pos.y>tr.transform.height/2-tr.transform.getHorizon()?this._around=performance$1.LngLat.convert(this._aroundCenter?tr.center:tr.unproject(pos)):this._around=performance$1.LngLat.convert(tr.center),this._aroundPoint=tr.transform.locationPoint(this._around),this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const tr=this._tr.transform;if(0!==this._delta){const zoomRate="wheel"===this._type&&Math.abs(this._delta)>4.000244140625?this._wheelZoomRate:this._defaultZoomRate;let scale=2/(1+Math.exp(-Math.abs(this._delta*zoomRate)));this._delta<0&&0!==scale&&(scale=1/scale);const fromScale="number"==typeof this._targetZoom?tr.zoomScale(this._targetZoom):tr.scale;this._targetZoom=Math.min(tr.maxZoom,Math.max(tr.minZoom,tr.scaleZoom(fromScale*scale))),"wheel"===this._type&&(this._startZoom=tr.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const targetZoom="number"==typeof this._targetZoom?this._targetZoom:tr.zoom,startZoom=this._startZoom,easing=this._easing;let zoom,finished=!1;if("wheel"===this._type&&startZoom&&easing){const t=Math.min((browser.now()-this._lastWheelEventTime)/200,1),k=easing(t);zoom=performance$1.interpolate.number(startZoom,targetZoom,k),t<1?this._frameId||(this._frameId=!0):finished=!0}else zoom=targetZoom,finished=!0;return this._active=!0,finished&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200)),{noInertia:!0,needsRenderFrame:!finished,zoomDelta:zoom-tr.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(duration){let easing=performance$1.defaultEasing;if(this._prevEase){const currentEase=this._prevEase,t=(browser.now()-currentEase.start)/currentEase.duration,speed=currentEase.easing(t+.01)-currentEase.easing(t),x=.27/Math.sqrt(speed*speed+1e-4)*.01,y=Math.sqrt(.0729-x*x);easing=performance$1.bezier(x,y,.25,1)}return this._prevEase={start:browser.now(),duration:duration,easing:easing},easing}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class DoubleClickZoomHandler{constructor(clickZoom,TapZoom){this._clickZoom=clickZoom,this._tapZoom=TapZoom}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ClickZoomHandler{constructor(map){this._tr=new TransformProvider(map),this.reset()}reset(){this._active=!1}dblclick(e,point){return e.preventDefault(),{cameraAnimation:map=>{map.easeTo({duration:300,zoom:this._tr.zoom+(e.shiftKey?-1:1),around:this._tr.unproject(point)},{originalEvent:e})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class TapDragZoomHandler{constructor(){this._tap=new TapRecognizer({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(e,points,mapTouches){if(!this._swipePoint)if(this._tapTime){const swipePoint=points[0],soonEnough=e.timeStamp-this._tapTime<500,closeEnough=this._tapPoint.dist(swipePoint)<30;soonEnough&&closeEnough?mapTouches.length>0&&(this._swipePoint=swipePoint,this._swipeTouch=mapTouches[0].identifier):this.reset()}else this._tap.touchstart(e,points,mapTouches)}touchmove(e,points,mapTouches){if(this._tapTime){if(this._swipePoint){if(mapTouches[0].identifier!==this._swipeTouch)return;const newSwipePoint=points[0],dist=newSwipePoint.y-this._swipePoint.y;return this._swipePoint=newSwipePoint,e.preventDefault(),this._active=!0,{zoomDelta:dist/128}}}else this._tap.touchmove(e,points,mapTouches)}touchend(e,points,mapTouches){if(this._tapTime)this._swipePoint&&0===mapTouches.length&&this.reset();else{const point=this._tap.touchend(e,points,mapTouches);point&&(this._tapTime=e.timeStamp,this._tapPoint=point)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class DragPanHandler{constructor(el,mousePan,touchPan){this._el=el,this._mousePan=mousePan,this._touchPan=touchPan}enable(options){this._inertiaOptions=options||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class DragRotateHandler{constructor(options,mouseRotate,mousePitch){this._pitchWithRotate=options.pitchWithRotate,this._mouseRotate=mouseRotate,this._mousePitch=mousePitch}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class TwoFingersTouchZoomRotateHandler{constructor(el,touchZoom,touchRotate,tapDragZoom){this._el=el,this._touchZoom=touchZoom,this._touchRotate=touchRotate,this._tapDragZoom=tapDragZoom,this._rotationDisabled=!1,this._enabled=!0}enable(options){this._touchZoom.enable(options),this._rotationDisabled||this._touchRotate.enable(options),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class CooperativeGesturesHandler{constructor(map,options){this._bypassKey=-1!==navigator.userAgent.indexOf("Mac")?"metaKey":"ctrlKey",this._map=map,this._options=options,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const mapCanvasContainer=this._map.getCanvasContainer();mapCanvasContainer.classList.add("maplibregl-cooperative-gestures"),this._container=DOM.create("div","maplibregl-cooperative-gesture-screen",mapCanvasContainer);let desktopMessage=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");"metaKey"===this._bypassKey&&(desktopMessage=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const mobileMessage=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),desktopDiv=document.createElement("div");desktopDiv.className="maplibregl-desktop-message",desktopDiv.textContent=desktopMessage,this._container.appendChild(desktopDiv);const mobileDiv=document.createElement("div");mobileDiv.className="maplibregl-mobile-message",mobileDiv.textContent=mobileMessage,this._container.appendChild(mobileDiv),this._container.setAttribute("aria-hidden","true")}_destoryUI(){if(this._container){DOM.remove(this._container);this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")}delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destoryUI()}isEnabled(){return this._enabled}touchmove(e){this._onCooperativeGesture(1===e.touches.length)}wheel(e){this._map.scrollZoom.isEnabled()&&this._onCooperativeGesture(!e[this._bypassKey])}_onCooperativeGesture(showNotification){this._enabled&&showNotification&&(this._container.classList.add("maplibregl-show"),setTimeout((()=>{this._container.classList.remove("maplibregl-show")}),100))}}const isMoving=p=>p.zoom||p.drag||p.pitch||p.rotate;class RenderFrameEvent extends performance$1.Event{}function hasChange(result){return result.panDelta&&result.panDelta.mag()||result.zoomDelta||result.bearingDelta||result.pitchDelta}class HandlerManager{constructor(map,options){this.handleWindowEvent=e=>{this.handleEvent(e,`${e.type}Window`)},this.handleEvent=(e,eventName)=>{if("blur"===e.type)return void this.stop(!0);this._updatingCamera=!0;const inputEvent="renderFrame"===e.type?void 0:e,mergedHandlerResult={needsRenderFrame:!1},eventsInProgress={},activeHandlers={},eventTouches=e.touches,mapTouches=eventTouches?this._getMapTouches(eventTouches):void 0,points=mapTouches?DOM.touchPos(this._map.getCanvas(),mapTouches):DOM.mousePos(this._map.getCanvas(),e);for(const{handlerName:handlerName,handler:handler,allowed:allowed}of this._handlers){if(!handler.isEnabled())continue;let data;this._blockedByActive(activeHandlers,allowed,handlerName)?handler.reset():handler[eventName||e.type]&&(data=handler[eventName||e.type](e,points,mapTouches),this.mergeHandlerResult(mergedHandlerResult,eventsInProgress,data,handlerName,inputEvent),data&&data.needsRenderFrame&&this._triggerRenderFrame()),(data||handler.isActive())&&(activeHandlers[handlerName]=handler)}const deactivatedHandlers={};for(const name in this._previousActiveHandlers)activeHandlers[name]||(deactivatedHandlers[name]=inputEvent);this._previousActiveHandlers=activeHandlers,(Object.keys(deactivatedHandlers).length||hasChange(mergedHandlerResult))&&(this._changes.push([mergedHandlerResult,eventsInProgress,deactivatedHandlers]),this._triggerRenderFrame()),(Object.keys(activeHandlers).length||hasChange(mergedHandlerResult))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:cameraAnimation}=mergedHandlerResult;cameraAnimation&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],cameraAnimation(this._map))},this._map=map,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new HandlerInertia(map),this._bearingSnap=options.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(options);const el=this._el;this._listeners=[[el,"touchstart",{passive:!0}],[el,"touchmove",{passive:!1}],[el,"touchend",void 0],[el,"touchcancel",void 0],[el,"mousedown",void 0],[el,"mousemove",void 0],[el,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[el,"mouseover",void 0],[el,"mouseout",void 0],[el,"dblclick",void 0],[el,"click",void 0],[el,"keydown",{capture:!1}],[el,"keyup",void 0],[el,"wheel",{passive:!1}],[el,"contextmenu",void 0],[window,"blur",void 0]];for(const[target,type,listenerOptions]of this._listeners)DOM.addEventListener(target,type,target===document?this.handleWindowEvent:this.handleEvent,listenerOptions)}destroy(){for(const[target,type,listenerOptions]of this._listeners)DOM.removeEventListener(target,type,target===document?this.handleWindowEvent:this.handleEvent,listenerOptions)}_addDefaultHandlers(options){const map=this._map,el=map.getCanvasContainer();this._add("mapEvent",new MapEventHandler(map,options));const boxZoom=map.boxZoom=new BoxZoomHandler(map,options);this._add("boxZoom",boxZoom),options.interactive&&options.boxZoom&&boxZoom.enable();const cooperativeGestures=map.cooperativeGestures=new CooperativeGesturesHandler(map,options.cooperativeGestures);this._add("cooperativeGestures",cooperativeGestures),options.cooperativeGestures&&cooperativeGestures.enable();const tapZoom=new TapZoomHandler(map),clickZoom=new ClickZoomHandler(map);map.doubleClickZoom=new DoubleClickZoomHandler(clickZoom,tapZoom),this._add("tapZoom",tapZoom),this._add("clickZoom",clickZoom),options.interactive&&options.doubleClickZoom&&map.doubleClickZoom.enable();const tapDragZoom=new TapDragZoomHandler;this._add("tapDragZoom",tapDragZoom);const touchPitch=map.touchPitch=new TwoFingersTouchPitchHandler(map);this._add("touchPitch",touchPitch),options.interactive&&options.touchPitch&&map.touchPitch.enable(options.touchPitch);const mouseRotate=generateMouseRotationHandler(options),mousePitch=generateMousePitchHandler(options);map.dragRotate=new DragRotateHandler(options,mouseRotate,mousePitch),this._add("mouseRotate",mouseRotate,["mousePitch"]),this._add("mousePitch",mousePitch,["mouseRotate"]),options.interactive&&options.dragRotate&&map.dragRotate.enable();const mousePan=(({enable:enable,clickTolerance:clickTolerance})=>{const mouseMoveStateManager=new MouseMoveStateManager({checkCorrectEvent:e=>0===DOM.mouseButton(e)&&!e.ctrlKey});return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({around:point,panDelta:point.sub(lastPoint)}),activateOnStart:!0,moveStateManager:mouseMoveStateManager,enable:enable,assignEvents:assignEvents$1})})(options),touchPan=new TouchPanHandler(options,map);map.dragPan=new DragPanHandler(el,mousePan,touchPan),this._add("mousePan",mousePan),this._add("touchPan",touchPan,["touchZoom","touchRotate"]),options.interactive&&options.dragPan&&map.dragPan.enable(options.dragPan);const touchRotate=new TwoFingersTouchRotateHandler,touchZoom=new TwoFingersTouchZoomHandler;map.touchZoomRotate=new TwoFingersTouchZoomRotateHandler(el,touchZoom,touchRotate,tapDragZoom),this._add("touchRotate",touchRotate,["touchPan","touchZoom"]),this._add("touchZoom",touchZoom,["touchPan","touchRotate"]),options.interactive&&options.touchZoomRotate&&map.touchZoomRotate.enable(options.touchZoomRotate);const scrollZoom=map.scrollZoom=new ScrollZoomHandler(map,(()=>this._triggerRenderFrame()));this._add("scrollZoom",scrollZoom,["mousePan"]),options.interactive&&options.scrollZoom&&map.scrollZoom.enable(options.scrollZoom);const keyboard=map.keyboard=new KeyboardHandler(map);this._add("keyboard",keyboard),options.interactive&&options.keyboard&&map.keyboard.enable(),this._add("blockableMapEvent",new BlockableMapEventHandler(map))}_add(handlerName,handler,allowed){this._handlers.push({handlerName:handlerName,handler:handler,allowed:allowed}),this._handlersById[handlerName]=handler}stop(allowEndAnimation){if(!this._updatingCamera){for(const{handler:handler}of this._handlers)handler.reset();this._inertia.clear(),this._fireEvents({},{},allowEndAnimation),this._changes=[]}}isActive(){for(const{handler:handler}of this._handlers)if(handler.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return Boolean(isMoving(this._eventsInProgress))||this.isZooming()}_blockedByActive(activeHandlers,allowed,myName){for(const name in activeHandlers)if(name!==myName&&(!allowed||allowed.indexOf(name)<0))return!0;return!1}_getMapTouches(touches){const mapTouches=[];for(const t of touches){const target=t.target;this._el.contains(target)&&mapTouches.push(t)}return mapTouches}mergeHandlerResult(mergedHandlerResult,eventsInProgress,handlerResult,name,e){if(!handlerResult)return;performance$1.extend(mergedHandlerResult,handlerResult);const eventData={handlerName:name,originalEvent:handlerResult.originalEvent||e};void 0!==handlerResult.zoomDelta&&(eventsInProgress.zoom=eventData),void 0!==handlerResult.panDelta&&(eventsInProgress.drag=eventData),void 0!==handlerResult.pitchDelta&&(eventsInProgress.pitch=eventData),void 0!==handlerResult.bearingDelta&&(eventsInProgress.rotate=eventData)}_applyChanges(){const combined={},combinedEventsInProgress={},combinedDeactivatedHandlers={};for(const[change,eventsInProgress,deactivatedHandlers]of this._changes)change.panDelta&&(combined.panDelta=(combined.panDelta||new performance$1.Point(0,0))._add(change.panDelta)),change.zoomDelta&&(combined.zoomDelta=(combined.zoomDelta||0)+change.zoomDelta),change.bearingDelta&&(combined.bearingDelta=(combined.bearingDelta||0)+change.bearingDelta),change.pitchDelta&&(combined.pitchDelta=(combined.pitchDelta||0)+change.pitchDelta),void 0!==change.around&&(combined.around=change.around),void 0!==change.pinchAround&&(combined.pinchAround=change.pinchAround),change.noInertia&&(combined.noInertia=change.noInertia),performance$1.extend(combinedEventsInProgress,eventsInProgress),performance$1.extend(combinedDeactivatedHandlers,deactivatedHandlers);this._updateMapTransform(combined,combinedEventsInProgress,combinedDeactivatedHandlers),this._changes=[]}_updateMapTransform(combinedResult,combinedEventsInProgress,deactivatedHandlers){const map=this._map,tr=map._getTransformForUpdate(),terrain=map.terrain;if(!(hasChange(combinedResult)||terrain&&this._terrainMovement))return this._fireEvents(combinedEventsInProgress,deactivatedHandlers,!0);let{panDelta:panDelta,zoomDelta:zoomDelta,bearingDelta:bearingDelta,pitchDelta:pitchDelta,around:around,pinchAround:pinchAround}=combinedResult;void 0!==pinchAround&&(around=pinchAround),map._stop(!0),around=around||map.transform.centerPoint;const loc=tr.pointLocation(panDelta?around.sub(panDelta):around);bearingDelta&&(tr.bearing+=bearingDelta),pitchDelta&&(tr.pitch+=pitchDelta),zoomDelta&&(tr.zoom+=zoomDelta),terrain?this._terrainMovement||!combinedEventsInProgress.drag&&!combinedEventsInProgress.zoom?combinedEventsInProgress.drag&&this._terrainMovement?tr.center=tr.pointLocation(tr.centerPoint.sub(panDelta)):tr.setLocationAtPoint(loc,around):(this._terrainMovement=!0,this._map._elevationFreeze=!0,tr.setLocationAtPoint(loc,around),this._map.once("moveend",(()=>{this._map._elevationFreeze=!1,this._terrainMovement=!1,tr.recalculateZoom(map.terrain)}))):tr.setLocationAtPoint(loc,around),map._applyUpdatedTransform(tr),this._map._update(),combinedResult.noInertia||this._inertia.record(combinedResult),this._fireEvents(combinedEventsInProgress,deactivatedHandlers,!0)}_fireEvents(newEventsInProgress,deactivatedHandlers,allowEndAnimation){const wasMoving=isMoving(this._eventsInProgress),nowMoving=isMoving(newEventsInProgress),startEvents={};for(const eventName in newEventsInProgress){const{originalEvent:originalEvent}=newEventsInProgress[eventName];this._eventsInProgress[eventName]||(startEvents[`${eventName}start`]=originalEvent),this._eventsInProgress[eventName]=newEventsInProgress[eventName]}!wasMoving&&nowMoving&&this._fireEvent("movestart",nowMoving.originalEvent);for(const name in startEvents)this._fireEvent(name,startEvents[name]);nowMoving&&this._fireEvent("move",nowMoving.originalEvent);for(const eventName in newEventsInProgress){const{originalEvent:originalEvent}=newEventsInProgress[eventName];this._fireEvent(eventName,originalEvent)}const endEvents={};let originalEndEvent;for(const eventName in this._eventsInProgress){const{handlerName:handlerName,originalEvent:originalEvent}=this._eventsInProgress[eventName];this._handlersById[handlerName].isActive()||(delete this._eventsInProgress[eventName],originalEndEvent=deactivatedHandlers[handlerName]||originalEvent,endEvents[`${eventName}end`]=originalEndEvent)}for(const name in endEvents)this._fireEvent(name,endEvents[name]);const stillMoving=isMoving(this._eventsInProgress);if(allowEndAnimation&&(wasMoving||nowMoving)&&!stillMoving){this._updatingCamera=!0;const inertialEase=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),shouldSnapToNorth=bearing=>0!==bearing&&-this._bearingSnap<bearing&&bearing<this._bearingSnap;!inertialEase||!inertialEase.essential&&browser.prefersReducedMotion?(this._map.fire(new performance$1.Event("moveend",{originalEvent:originalEndEvent})),shouldSnapToNorth(this._map.getBearing())&&this._map.resetNorth()):(shouldSnapToNorth(inertialEase.bearing||this._map.getBearing())&&(inertialEase.bearing=0),inertialEase.freezeElevation=!0,this._map.easeTo(inertialEase,{originalEvent:originalEndEvent})),this._updatingCamera=!1}}_fireEvent(type,e){this._map.fire(new performance$1.Event(type,e?{originalEvent:e}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((timeStamp=>{delete this._frameId,this.handleEvent(new RenderFrameEvent("renderFrame",{timeStamp:timeStamp})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}class Camera extends performance$1.Evented{constructor(transform,options){super(),this._renderFrameCallback=()=>{const t=Math.min((browser.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(t)),t<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=transform,this._bearingSnap=options.bearingSnap,this.on("moveend",(()=>{delete this._requestedCameraState}))}getCenter(){return new performance$1.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(center,eventData){return this.jumpTo({center:center},eventData)}panBy(offset,options,eventData){return offset=performance$1.Point.convert(offset).mult(-1),this.panTo(this.transform.center,performance$1.extend({offset:offset},options),eventData)}panTo(lnglat,options,eventData){return this.easeTo(performance$1.extend({center:lnglat},options),eventData)}getZoom(){return this.transform.zoom}setZoom(zoom,eventData){return this.jumpTo({zoom:zoom},eventData),this}zoomTo(zoom,options,eventData){return this.easeTo(performance$1.extend({zoom:zoom},options),eventData)}zoomIn(options,eventData){return this.zoomTo(this.getZoom()+1,options,eventData),this}zoomOut(options,eventData){return this.zoomTo(this.getZoom()-1,options,eventData),this}getBearing(){return this.transform.bearing}setBearing(bearing,eventData){return this.jumpTo({bearing:bearing},eventData),this}getPadding(){return this.transform.padding}setPadding(padding,eventData){return this.jumpTo({padding:padding},eventData),this}rotateTo(bearing,options,eventData){return this.easeTo(performance$1.extend({bearing:bearing},options),eventData)}resetNorth(options,eventData){return this.rotateTo(0,performance$1.extend({duration:1e3},options),eventData),this}resetNorthPitch(options,eventData){return this.easeTo(performance$1.extend({bearing:0,pitch:0,duration:1e3},options),eventData),this}snapToNorth(options,eventData){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(options,eventData):this}getPitch(){return this.transform.pitch}setPitch(pitch,eventData){return this.jumpTo({pitch:pitch},eventData),this}cameraForBounds(bounds,options){bounds=LngLatBounds.convert(bounds);const bearing=options&&options.bearing||0;return this._cameraForBoxAndBearing(bounds.getNorthWest(),bounds.getSouthEast(),bearing,options)}_cameraForBoxAndBearing(p0,p1,bearing,options){const defaultPadding={top:0,bottom:0,right:0,left:0};if("number"==typeof(options=performance$1.extend({padding:defaultPadding,offset:[0,0],maxZoom:this.transform.maxZoom},options)).padding){const p=options.padding;options.padding={top:p,bottom:p,right:p,left:p}}options.padding=performance$1.extend(defaultPadding,options.padding);const tr=this.transform,edgePadding=tr.padding,bounds=new LngLatBounds(p0,p1),nwWorld=tr.project(bounds.getNorthWest()),neWorld=tr.project(bounds.getNorthEast()),seWorld=tr.project(bounds.getSouthEast()),swWorld=tr.project(bounds.getSouthWest()),bearingRadians=performance$1.degreesToRadians(-bearing),nwRotatedWorld=nwWorld.rotate(bearingRadians),neRotatedWorld=neWorld.rotate(bearingRadians),seRotatedWorld=seWorld.rotate(bearingRadians),swRotatedWorld=swWorld.rotate(bearingRadians),upperRight=new performance$1.Point(Math.max(nwRotatedWorld.x,neRotatedWorld.x,swRotatedWorld.x,seRotatedWorld.x),Math.max(nwRotatedWorld.y,neRotatedWorld.y,swRotatedWorld.y,seRotatedWorld.y)),lowerLeft=new performance$1.Point(Math.min(nwRotatedWorld.x,neRotatedWorld.x,swRotatedWorld.x,seRotatedWorld.x),Math.min(nwRotatedWorld.y,neRotatedWorld.y,swRotatedWorld.y,seRotatedWorld.y)),size=upperRight.sub(lowerLeft),scaleX=(tr.width-(edgePadding.left+edgePadding.right+options.padding.left+options.padding.right))/size.x,scaleY=(tr.height-(edgePadding.top+edgePadding.bottom+options.padding.top+options.padding.bottom))/size.y;if(scaleY<0||scaleX<0)return void performance$1.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const zoom=Math.min(tr.scaleZoom(tr.scale*Math.min(scaleX,scaleY)),options.maxZoom),offset=performance$1.Point.convert(options.offset),paddingOffsetX=(options.padding.left-options.padding.right)/2,paddingOffsetY=(options.padding.top-options.padding.bottom)/2,rotatedPaddingOffset=new performance$1.Point(paddingOffsetX,paddingOffsetY).rotate(performance$1.degreesToRadians(bearing)),offsetAtFinalZoom=offset.add(rotatedPaddingOffset).mult(tr.scale/tr.zoomScale(zoom));return{center:tr.unproject(nwWorld.add(seWorld).div(2).sub(offsetAtFinalZoom)),zoom:zoom,bearing:bearing}}fitBounds(bounds,options,eventData){return this._fitInternal(this.cameraForBounds(bounds,options),options,eventData)}fitScreenCoordinates(p0,p1,bearing,options,eventData){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(performance$1.Point.convert(p0)),this.transform.pointLocation(performance$1.Point.convert(p1)),bearing,options),options,eventData)}_fitInternal(calculatedOptions,options,eventData){return calculatedOptions?(delete(options=performance$1.extend(calculatedOptions,options)).padding,options.linear?this.easeTo(options,eventData):this.flyTo(options,eventData)):this}jumpTo(options,eventData){this.stop();const tr=this._getTransformForUpdate();let zoomChanged=!1,bearingChanged=!1,pitchChanged=!1;return"zoom"in options&&tr.zoom!==+options.zoom&&(zoomChanged=!0,tr.zoom=+options.zoom),void 0!==options.center&&(tr.center=performance$1.LngLat.convert(options.center)),"bearing"in options&&tr.bearing!==+options.bearing&&(bearingChanged=!0,tr.bearing=+options.bearing),"pitch"in options&&tr.pitch!==+options.pitch&&(pitchChanged=!0,tr.pitch=+options.pitch),null==options.padding||tr.isPaddingEqual(options.padding)||(tr.padding=options.padding),this._applyUpdatedTransform(tr),this.fire(new performance$1.Event("movestart",eventData)).fire(new performance$1.Event("move",eventData)),zoomChanged&&this.fire(new performance$1.Event("zoomstart",eventData)).fire(new performance$1.Event("zoom",eventData)).fire(new performance$1.Event("zoomend",eventData)),bearingChanged&&this.fire(new performance$1.Event("rotatestart",eventData)).fire(new performance$1.Event("rotate",eventData)).fire(new performance$1.Event("rotateend",eventData)),pitchChanged&&this.fire(new performance$1.Event("pitchstart",eventData)).fire(new performance$1.Event("pitch",eventData)).fire(new performance$1.Event("pitchend",eventData)),this.fire(new performance$1.Event("moveend",eventData))}calculateCameraOptionsFromTo(from,altitudeFrom,to,altitudeTo=0){const fromMerc=performance$1.MercatorCoordinate.fromLngLat(from,altitudeFrom),toMerc=performance$1.MercatorCoordinate.fromLngLat(to,altitudeTo),dx=toMerc.x-fromMerc.x,dy=toMerc.y-fromMerc.y,dz=toMerc.z-fromMerc.z,distance3D=Math.hypot(dx,dy,dz);if(0===distance3D)throw new Error("Can't calculate camera options with same From and To");const groundDistance=Math.hypot(dx,dy),zoom=this.transform.scaleZoom(this.transform.cameraToCenterDistance/distance3D/this.transform.tileSize),bearing=180*Math.atan2(dx,-dy)/Math.PI;let pitch=180*Math.acos(groundDistance/distance3D)/Math.PI;return pitch=dz<0?90-pitch:90+pitch,{center:toMerc.toLngLat(),zoom:zoom,pitch:pitch,bearing:bearing}}easeTo(options,eventData){this._stop(!1,options.easeId),(!1===(options=performance$1.extend({offset:[0,0],duration:500,easing:performance$1.defaultEasing},options)).animate||!options.essential&&browser.prefersReducedMotion)&&(options.duration=0);const tr=this._getTransformForUpdate(),startZoom=this.getZoom(),startBearing=this.getBearing(),startPitch=this.getPitch(),startPadding=this.getPadding(),zoom="zoom"in options?+options.zoom:startZoom,bearing="bearing"in options?this._normalizeBearing(options.bearing,startBearing):startBearing,pitch="pitch"in options?+options.pitch:startPitch,padding="padding"in options?options.padding:tr.padding,offsetAsPoint=performance$1.Point.convert(options.offset);let pointAtOffset=tr.centerPoint.add(offsetAsPoint);const locationAtOffset=tr.pointLocation(pointAtOffset),center=performance$1.LngLat.convert(options.center||locationAtOffset);this._normalizeCenter(center);const from=tr.project(locationAtOffset),delta=tr.project(center).sub(from),finalScale=tr.zoomScale(zoom-startZoom);let around,aroundPoint;options.around&&(around=performance$1.LngLat.convert(options.around),aroundPoint=tr.locationPoint(around));const currently={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=this._zooming||zoom!==startZoom,this._rotating=this._rotating||startBearing!==bearing,this._pitching=this._pitching||pitch!==startPitch,this._padding=!tr.isPaddingEqual(padding),this._easeId=options.easeId,this._prepareEase(eventData,options.noMoveStart,currently),this.terrain&&this._prepareElevation(center),this._ease((k=>{if(this._zooming&&(tr.zoom=performance$1.interpolate.number(startZoom,zoom,k)),this._rotating&&(tr.bearing=performance$1.interpolate.number(startBearing,bearing,k)),this._pitching&&(tr.pitch=performance$1.interpolate.number(startPitch,pitch,k)),this._padding&&(tr.interpolatePadding(startPadding,padding,k),pointAtOffset=tr.centerPoint.add(offsetAsPoint)),this.terrain&&!options.freezeElevation&&this._updateElevation(k),around)tr.setLocationAtPoint(around,aroundPoint);else{const scale=tr.zoomScale(tr.zoom-startZoom),base=zoom>startZoom?Math.min(2,finalScale):Math.max(.5,finalScale),speedup=Math.pow(base,1-k),newCenter=tr.unproject(from.add(delta.mult(k*speedup)).mult(scale));tr.setLocationAtPoint(tr.renderWorldCopies?newCenter.wrap():newCenter,pointAtOffset)}this._applyUpdatedTransform(tr),this._fireMoveEvents(eventData)}),(interruptingEaseId=>{this.terrain&&this._finalizeElevation(),this._afterEase(eventData,interruptingEaseId)}),options),this}_prepareEase(eventData,noMoveStart,currently={}){this._moving=!0,noMoveStart||currently.moving||this.fire(new performance$1.Event("movestart",eventData)),this._zooming&&!currently.zooming&&this.fire(new performance$1.Event("zoomstart",eventData)),this._rotating&&!currently.rotating&&this.fire(new performance$1.Event("rotatestart",eventData)),this._pitching&&!currently.pitching&&this.fire(new performance$1.Event("pitchstart",eventData))}_prepareElevation(center){this._elevationCenter=center,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(center,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(k){this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);const elevation=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(k<1&&elevation!==this._elevationTarget){const pitch1=this._elevationTarget-this._elevationStart,pitch2=(elevation-(pitch1*k+this._elevationStart))/(1-k);this._elevationStart+=k*(pitch1-pitch2),this._elevationTarget=elevation}this.transform.elevation=performance$1.interpolate.number(this._elevationStart,this._elevationTarget,k)}_finalizeElevation(){this._elevationFreeze=!1,this.transform.recalculateZoom(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_applyUpdatedTransform(tr){if(!this.transformCameraUpdate)return;const nextTransform=tr.clone(),{center:center,zoom:zoom,pitch:pitch,bearing:bearing,elevation:elevation}=this.transformCameraUpdate(nextTransform);center&&(nextTransform.center=center),void 0!==zoom&&(nextTransform.zoom=zoom),void 0!==pitch&&(nextTransform.pitch=pitch),void 0!==bearing&&(nextTransform.bearing=bearing),void 0!==elevation&&(nextTransform.elevation=elevation),this.transform.apply(nextTransform)}_fireMoveEvents(eventData){this.fire(new performance$1.Event("move",eventData)),this._zooming&&this.fire(new performance$1.Event("zoom",eventData)),this._rotating&&this.fire(new performance$1.Event("rotate",eventData)),this._pitching&&this.fire(new performance$1.Event("pitch",eventData))}_afterEase(eventData,easeId){if(this._easeId&&easeId&&this._easeId===easeId)return;delete this._easeId;const wasZooming=this._zooming,wasRotating=this._rotating,wasPitching=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,wasZooming&&this.fire(new performance$1.Event("zoomend",eventData)),wasRotating&&this.fire(new performance$1.Event("rotateend",eventData)),wasPitching&&this.fire(new performance$1.Event("pitchend",eventData)),this.fire(new performance$1.Event("moveend",eventData))}flyTo(options,eventData){if(!options.essential&&browser.prefersReducedMotion){const coercedOptions=performance$1.pick(options,["center","zoom","bearing","pitch","around"]);return this.jumpTo(coercedOptions,eventData)}this.stop(),options=performance$1.extend({offset:[0,0],speed:1.2,curve:1.42,easing:performance$1.defaultEasing},options);const tr=this._getTransformForUpdate(),startZoom=this.getZoom(),startBearing=this.getBearing(),startPitch=this.getPitch(),startPadding=this.getPadding(),zoom="zoom"in options?performance$1.clamp(+options.zoom,tr.minZoom,tr.maxZoom):startZoom,bearing="bearing"in options?this._normalizeBearing(options.bearing,startBearing):startBearing,pitch="pitch"in options?+options.pitch:startPitch,padding="padding"in options?options.padding:tr.padding,scale=tr.zoomScale(zoom-startZoom),offsetAsPoint=performance$1.Point.convert(options.offset);let pointAtOffset=tr.centerPoint.add(offsetAsPoint);const locationAtOffset=tr.pointLocation(pointAtOffset),center=performance$1.LngLat.convert(options.center||locationAtOffset);this._normalizeCenter(center);const from=tr.project(locationAtOffset),delta=tr.project(center).sub(from);let rho=options.curve;const w0=Math.max(tr.width,tr.height),w1=w0/scale,u1=delta.mag();if("minZoom"in options){const minZoom=performance$1.clamp(Math.min(options.minZoom,startZoom,zoom),tr.minZoom,tr.maxZoom),wMax=w0/tr.zoomScale(minZoom-startZoom);rho=Math.sqrt(wMax/u1*2)}const rho2=rho*rho;function zoomOutFactor(descent){const b=(w1*w1-w0*w0+(descent?-1:1)*rho2*rho2*u1*u1)/(2*(descent?w1:w0)*rho2*u1);return Math.log(Math.sqrt(b*b+1)-b)}function sinh(n){return(Math.exp(n)-Math.exp(-n))/2}function cosh(n){return(Math.exp(n)+Math.exp(-n))/2}const r0=zoomOutFactor(!1);let w=function(s){return cosh(r0)/cosh(r0+rho*s)},u=function(s){return w0*((cosh(r0)*(sinh(n=r0+rho*s)/cosh(n))-sinh(r0))/rho2)/u1;var n},S=(zoomOutFactor(!0)-r0)/rho;if(Math.abs(u1)<1e-6||!isFinite(S)){if(Math.abs(w0-w1)<1e-6)return this.easeTo(options,eventData);const k=w1<w0?-1:1;S=Math.abs(Math.log(w1/w0))/rho,u=function(){return 0},w=function(s){return Math.exp(k*rho*s)}}if("duration"in options)options.duration=+options.duration;else{const V="screenSpeed"in options?+options.screenSpeed/rho:+options.speed;options.duration=1e3*S/V}return options.maxDuration&&options.duration>options.maxDuration&&(options.duration=0),this._zooming=!0,this._rotating=startBearing!==bearing,this._pitching=pitch!==startPitch,this._padding=!tr.isPaddingEqual(padding),this._prepareEase(eventData,!1),this.terrain&&this._prepareElevation(center),this._ease((k=>{const s=k*S,scale=1/w(s);tr.zoom=1===k?zoom:startZoom+tr.scaleZoom(scale),this._rotating&&(tr.bearing=performance$1.interpolate.number(startBearing,bearing,k)),this._pitching&&(tr.pitch=performance$1.interpolate.number(startPitch,pitch,k)),this._padding&&(tr.interpolatePadding(startPadding,padding,k),pointAtOffset=tr.centerPoint.add(offsetAsPoint)),this.terrain&&!options.freezeElevation&&this._updateElevation(k);const newCenter=1===k?center:tr.unproject(from.add(delta.mult(u(s))).mult(scale));tr.setLocationAtPoint(tr.renderWorldCopies?newCenter.wrap():newCenter,pointAtOffset),this._applyUpdatedTransform(tr),this._fireMoveEvents(eventData)}),(()=>{this.terrain&&this._finalizeElevation(),this._afterEase(eventData)}),options),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(allowGestures,easeId){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const onEaseEnd=this._onEaseEnd;delete this._onEaseEnd,onEaseEnd.call(this,easeId)}if(!allowGestures){const handlers=this.handlers;handlers&&handlers.stop(!1)}return this}_ease(frame,finish,options){!1===options.animate||0===options.duration?(frame(1),finish()):(this._easeStart=browser.now(),this._easeOptions=options,this._onEaseFrame=frame,this._onEaseEnd=finish,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(bearing,currentBearing){bearing=performance$1.wrap(bearing,-180,180);const diff=Math.abs(bearing-currentBearing);return Math.abs(bearing-360-currentBearing)<diff&&(bearing-=360),Math.abs(bearing+360-currentBearing)<diff&&(bearing+=360),bearing}_normalizeCenter(center){const tr=this.transform;if(!tr.renderWorldCopies||tr.lngRange)return;const delta=center.lng-tr.center.lng;center.lng+=delta>180?-360:delta<-180?360:0}queryTerrainElevation(lngLatLike){if(!this.terrain)return null;return this.terrain.getElevationForLngLatZoom(performance$1.LngLat.convert(lngLatLike),this.transform.tileZoom)-this.transform.elevation}}const defaultAtributionControlOptions={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class AttributionControl{constructor(options=defaultAtributionControlOptions){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=e=>{!e||"metadata"!==e.sourceDataType&&"visibility"!==e.sourceDataType&&"style"!==e.dataType&&"terrain"!==e.type||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?!1===this._compact?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=options}getDefaultPosition(){return"bottom-right"}onAdd(map){return this._map=map,this._compact=this.options.compact,this._container=DOM.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=DOM.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=DOM.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){DOM.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(element,title){const str=this._map._getUIString(`AttributionControl.${title}`);element.title=str,element.setAttribute("aria-label",str)}_updateAttributions(){if(!this._map.style)return;let attributions=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?attributions=attributions.concat(this.options.customAttribution.map((attribution=>"string"!=typeof attribution?"":attribution))):"string"==typeof this.options.customAttribution&&attributions.push(this.options.customAttribution)),this._map.style.stylesheet){const stylesheet=this._map.style.stylesheet;this.styleOwner=stylesheet.owner,this.styleId=stylesheet.id}const sourceCaches=this._map.style.sourceCaches;for(const id in sourceCaches){const sourceCache=sourceCaches[id];if(sourceCache.used||sourceCache.usedForTerrain){const source=sourceCache.getSource();source.attribution&&attributions.indexOf(source.attribution)<0&&attributions.push(source.attribution)}}attributions=attributions.filter((e=>String(e).trim())),attributions.sort(((a,b)=>a.length-b.length)),attributions=attributions.filter(((attrib,i)=>{for(let j=i+1;j<attributions.length;j++)if(attributions[j].indexOf(attrib)>=0)return!1;return!0}));const attribHTML=attributions.join(" | ");attribHTML!==this._attribHTML&&(this._attribHTML=attribHTML,attributions.length?(this._innerContainer.innerHTML=attribHTML,this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class LogoControl{constructor(options={}){this._updateCompact=()=>{const containerChildren=this._container.children;if(containerChildren.length){const anchor=containerChildren[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?!1!==this._compact&&anchor.classList.add("maplibregl-compact"):anchor.classList.remove("maplibregl-compact")}},this.options=options}getDefaultPosition(){return"bottom-left"}onAdd(map){this._map=map,this._compact=this.options&&this.options.compact,this._container=DOM.create("div","maplibregl-ctrl");const anchor=DOM.create("a","maplibregl-ctrl-logo");return anchor.target="_blank",anchor.rel="noopener nofollow",anchor.href="https://maplibre.org/",anchor.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),anchor.setAttribute("rel","noopener nofollow"),this._container.appendChild(anchor),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){DOM.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class TaskQueue{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(callback){const id=++this._id;return this._queue.push({callback:callback,id:id,cancelled:!1}),id}remove(id){const running=this._currentlyRunning,queue=running?this._queue.concat(running):this._queue;for(const task of queue)if(task.id===id)return void(task.cancelled=!0)}run(timeStamp=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const queue=this._currentlyRunning=this._queue;this._queue=[];for(const task of queue)if(!task.cancelled&&(task.callback(timeStamp),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var pos3dAttributes=performance$1.createLayout([{name:"a_pos3d",type:"Int16",components:3}]);class TerrainSourceCache extends performance$1.Evented{constructor(sourceCache){super(),this.sourceCache=sourceCache,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.deltaZoom=1,sourceCache.usedForTerrain=!0,sourceCache.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(transform,terrain){this.sourceCache.update(transform,terrain),this._renderableTilesKeys=[];const keys={};for(const tileID of transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:terrain}))keys[tileID.key]=!0,this._renderableTilesKeys.push(tileID.key),this._tiles[tileID.key]||(tileID.posMatrix=new Float64Array(16),performance$1.ortho(tileID.posMatrix,0,performance$1.EXTENT,0,performance$1.EXTENT,0,1),this._tiles[tileID.key]=new Tile(tileID,this.tileSize));for(const key in this._tiles)keys[key]||delete this._tiles[key]}freeRtt(tileID){for(const key in this._tiles){const tile=this._tiles[key];(!tileID||tile.tileID.equals(tileID)||tile.tileID.isChildOf(tileID)||tileID.isChildOf(tile.tileID))&&(tile.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map((key=>this.getTileByID(key)))}getTileByID(id){return this._tiles[id]}getTerrainCoords(tileID){const coords={};for(const key of this._renderableTilesKeys){const _tileID=this._tiles[key].tileID;if(_tileID.canonical.equals(tileID.canonical)){const coord=tileID.clone();coord.posMatrix=new Float64Array(16),performance$1.ortho(coord.posMatrix,0,performance$1.EXTENT,0,performance$1.EXTENT,0,1),coords[key]=coord}else if(_tileID.canonical.isChildOf(tileID.canonical)){const coord=tileID.clone();coord.posMatrix=new Float64Array(16);const dz=_tileID.canonical.z-tileID.canonical.z,dx=_tileID.canonical.x-(_tileID.canonical.x>>dz<<dz),dy=_tileID.canonical.y-(_tileID.canonical.y>>dz<<dz),size=performance$1.EXTENT>>dz;performance$1.ortho(coord.posMatrix,0,size,0,size,0,1),performance$1.translate(coord.posMatrix,coord.posMatrix,[-dx*size,-dy*size,0]),coords[key]=coord}else if(tileID.canonical.isChildOf(_tileID.canonical)){const coord=tileID.clone();coord.posMatrix=new Float64Array(16);const dz=tileID.canonical.z-_tileID.canonical.z,dx=tileID.canonical.x-(tileID.canonical.x>>dz<<dz),dy=tileID.canonical.y-(tileID.canonical.y>>dz<<dz),size=performance$1.EXTENT>>dz;performance$1.ortho(coord.posMatrix,0,performance$1.EXTENT,0,performance$1.EXTENT,0,1),performance$1.translate(coord.posMatrix,coord.posMatrix,[dx*size,dy*size,0]),performance$1.scale(coord.posMatrix,coord.posMatrix,[1/2**dz,1/2**dz,0]),coords[key]=coord}}return coords}getSourceTile(tileID,searchForDEM){const source=this.sourceCache._source;let z=tileID.overscaledZ-this.deltaZoom;if(z>source.maxzoom&&(z=source.maxzoom),z<source.minzoom)return null;this._sourceTileCache[tileID.key]||(this._sourceTileCache[tileID.key]=tileID.scaledTo(z).key);let tile=this.sourceCache.getTileByID(this._sourceTileCache[tileID.key]);if((!tile||!tile.dem)&&searchForDEM)for(;z>=source.minzoom&&(!tile||!tile.dem);)tile=this.sourceCache.getTileByID(tileID.scaledTo(z--).key);return tile}tilesAfterTime(time=Date.now()){return Object.values(this._tiles).filter((t=>t.timeAdded>=time))}}class Terrain{constructor(painter,sourceCache,options){this.painter=painter,this.sourceCache=new TerrainSourceCache(sourceCache),this.options=options,this.exaggeration="number"==typeof options.exaggeration?options.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(tileID,x,y,extent=performance$1.EXTENT){var _a;if(!(x>=0&&x<extent&&y>=0&&y<extent))return 0;const terrain=this.getTerrainData(tileID),dem=null===(_a=terrain.tile)||void 0===_a?void 0:_a.dem;if(!dem)return 0;const pos=performance$1.transformMat4$1([],[x/extent*performance$1.EXTENT,y/extent*performance$1.EXTENT],terrain.u_terrain_matrix),coord=[pos[0]*dem.dim,pos[1]*dem.dim],cx=Math.floor(coord[0]),cy=Math.floor(coord[1]),tx=coord[0]-cx,ty=coord[1]-cy;return dem.get(cx,cy)*(1-tx)*(1-ty)+dem.get(cx+1,cy)*tx*(1-ty)+dem.get(cx,cy+1)*(1-tx)*ty+dem.get(cx+1,cy+1)*tx*ty}getElevationForLngLatZoom(lnglat,zoom){const{tileID:tileID,mercatorX:mercatorX,mercatorY:mercatorY}=this._getOverscaledTileIDFromLngLatZoom(lnglat,zoom);return this.getElevation(tileID,mercatorX%performance$1.EXTENT,mercatorY%performance$1.EXTENT,performance$1.EXTENT)}getElevation(tileID,x,y,extent=performance$1.EXTENT){return this.getDEMElevation(tileID,x,y,extent)*this.exaggeration}getTerrainData(tileID){if(!this._emptyDemTexture){const context=this.painter.context,image=new performance$1.RGBAImage({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new Texture(context,image,context.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new Texture(context,new performance$1.RGBAImage({width:1,height:1}),context.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(context.gl.NEAREST,context.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=performance$1.identity([])}const sourceTile=this.sourceCache.getSourceTile(tileID,!0);if(sourceTile&&sourceTile.dem&&(!sourceTile.demTexture||sourceTile.needsTerrainPrepare)){const context=this.painter.context;sourceTile.demTexture=this.painter.getTileTexture(sourceTile.dem.stride),sourceTile.demTexture?sourceTile.demTexture.update(sourceTile.dem.getPixels(),{premultiply:!1}):sourceTile.demTexture=new Texture(context,sourceTile.dem.getPixels(),context.gl.RGBA,{premultiply:!1}),sourceTile.demTexture.bind(context.gl.NEAREST,context.gl.CLAMP_TO_EDGE),sourceTile.needsTerrainPrepare=!1}const matrixKey=sourceTile&&sourceTile+sourceTile.tileID.key+tileID.key;if(matrixKey&&!this._demMatrixCache[matrixKey]){const maxzoom=this.sourceCache.sourceCache._source.maxzoom;let dz=tileID.canonical.z-sourceTile.tileID.canonical.z;tileID.overscaledZ>tileID.canonical.z&&(tileID.canonical.z>=maxzoom?dz=tileID.canonical.z-maxzoom:performance$1.warnOnce("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const dx=tileID.canonical.x-(tileID.canonical.x>>dz<<dz),dy=tileID.canonical.y-(tileID.canonical.y>>dz<<dz),demMatrix=performance$1.fromScaling(new Float64Array(16),[1/(performance$1.EXTENT<<dz),1/(performance$1.EXTENT<<dz),0]);performance$1.translate(demMatrix,demMatrix,[dx*performance$1.EXTENT,dy*performance$1.EXTENT,0]),this._demMatrixCache[tileID.key]={matrix:demMatrix,coord:tileID}}return{u_depth:2,u_terrain:3,u_terrain_dim:sourceTile&&sourceTile.dem&&sourceTile.dem.dim||1,u_terrain_matrix:matrixKey?this._demMatrixCache[tileID.key].matrix:this._emptyDemMatrix,u_terrain_unpack:sourceTile&&sourceTile.dem&&sourceTile.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(sourceTile&&sourceTile.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:sourceTile}}getFramebuffer(texture){const painter=this.painter,width=painter.width/devicePixelRatio,height=painter.height/devicePixelRatio;return!this._fbo||this._fbo.width===width&&this._fbo.height===height||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new Texture(painter.context,{width:width,height:height,data:null},painter.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(painter.context.gl.NEAREST,painter.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new Texture(painter.context,{width:width,height:height,data:null},painter.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(painter.context.gl.NEAREST,painter.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=painter.context.createFramebuffer(width,height,!0,!1),this._fbo.depthAttachment.set(painter.context.createRenderbuffer(painter.context.gl.DEPTH_COMPONENT16,width,height))),this._fbo.colorAttachment.set("coords"===texture?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const context=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const data=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let y=0,i=0;y<this._coordsTextureSize;y++)for(let x=0;x<this._coordsTextureSize;x++,i+=4)data[i+0]=255&x,data[i+1]=255&y,data[i+2]=x>>8<<4|y>>8,data[i+3]=0;const image=new performance$1.RGBAImage({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(data.buffer)),texture=new Texture(context,image,context.gl.RGBA,{premultiply:!1});return texture.bind(context.gl.NEAREST,context.gl.CLAMP_TO_EDGE),this._coordsTexture=texture,texture}pointCoordinate(p){const rgba=new Uint8Array(4),context=this.painter.context,gl=context.gl;context.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),gl.readPixels(p.x,this.painter.height/devicePixelRatio-p.y-1,1,1,gl.RGBA,gl.UNSIGNED_BYTE,rgba),context.bindFramebuffer.set(null);const x=rgba[0]+(rgba[2]>>4<<8),y=rgba[1]+((15&rgba[2])<<8),tileID=this.coordsIndex[255-rgba[3]],tile=tileID&&this.sourceCache.getTileByID(tileID);if(!tile)return null;const coordsSize=this._coordsTextureSize,worldSize=(1<<tile.tileID.canonical.z)*coordsSize;return new performance$1.MercatorCoordinate((tile.tileID.canonical.x*coordsSize+x)/worldSize+tile.tileID.wrap,(tile.tileID.canonical.y*coordsSize+y)/worldSize,this.getElevation(tile.tileID,x,y,coordsSize))}depthAtPoint(p){const rgba=new Uint8Array(4),context=this.painter.context,gl=context.gl;context.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),gl.readPixels(p.x,this.painter.height/devicePixelRatio-p.y-1,1,1,gl.RGBA,gl.UNSIGNED_BYTE,rgba),context.bindFramebuffer.set(null);return(rgba[0]/16777216+rgba[1]/65536+rgba[2]/256+rgba[3])/256}getTerrainMesh(){if(this._mesh)return this._mesh;const context=this.painter.context,vertexArray=new performance$1.Pos3dArray,indexArray=new performance$1.TriangleIndexArray,meshSize=this.meshSize,delta=performance$1.EXTENT/meshSize,meshSize2=meshSize*meshSize;for(let y=0;y<=meshSize;y++)for(let x=0;x<=meshSize;x++)vertexArray.emplaceBack(x*delta,y*delta,0);for(let y=0;y<meshSize2;y+=meshSize+1)for(let x=0;x<meshSize;x++)indexArray.emplaceBack(x+y,meshSize+x+y+1,meshSize+x+y+2),indexArray.emplaceBack(x+y,meshSize+x+y+2,x+y+1);const offsetTop=vertexArray.length,offsetBottom=offsetTop+2*(meshSize+1);for(const y of[0,1])for(let x=0;x<=meshSize;x++)for(const z of[0,1])vertexArray.emplaceBack(x*delta,y*performance$1.EXTENT,z);for(let x=0;x<2*meshSize;x+=2)indexArray.emplaceBack(offsetBottom+x,offsetBottom+x+1,offsetBottom+x+3),indexArray.emplaceBack(offsetBottom+x,offsetBottom+x+3,offsetBottom+x+2),indexArray.emplaceBack(offsetTop+x,offsetTop+x+3,offsetTop+x+1),indexArray.emplaceBack(offsetTop+x,offsetTop+x+2,offsetTop+x+3);const offsetLeft=vertexArray.length,offsetRight=offsetLeft+2*(meshSize+1);for(const x of[0,1])for(let y=0;y<=meshSize;y++)for(const z of[0,1])vertexArray.emplaceBack(x*performance$1.EXTENT,y*delta,z);for(let y=0;y<2*meshSize;y+=2)indexArray.emplaceBack(offsetLeft+y,offsetLeft+y+1,offsetLeft+y+3),indexArray.emplaceBack(offsetLeft+y,offsetLeft+y+3,offsetLeft+y+2),indexArray.emplaceBack(offsetRight+y,offsetRight+y+3,offsetRight+y+1),indexArray.emplaceBack(offsetRight+y,offsetRight+y+2,offsetRight+y+3);return this._mesh={indexBuffer:context.createIndexBuffer(indexArray),vertexBuffer:context.createVertexBuffer(vertexArray,pos3dAttributes.members),segments:performance$1.SegmentVector.simpleSegment(0,0,vertexArray.length,indexArray.length)},this._mesh}getMeshFrameDelta(zoom){return 2*Math.PI*performance$1.earthRadius/Math.pow(2,zoom)/5}getMinTileElevationForLngLatZoom(lnglat,zoom){var _a;const{tileID:tileID}=this._getOverscaledTileIDFromLngLatZoom(lnglat,zoom);return null!==(_a=this.getMinMaxElevation(tileID).minElevation)&&void 0!==_a?_a:0}getMinMaxElevation(tileID){const tile=this.getTerrainData(tileID).tile,minMax={minElevation:null,maxElevation:null};return tile&&tile.dem&&(minMax.minElevation=tile.dem.min*this.exaggeration,minMax.maxElevation=tile.dem.max*this.exaggeration),minMax}_getOverscaledTileIDFromLngLatZoom(lnglat,zoom){const mercatorCoordinate=performance$1.MercatorCoordinate.fromLngLat(lnglat.wrap()),worldSize=(1<<zoom)*performance$1.EXTENT,mercatorX=mercatorCoordinate.x*worldSize,mercatorY=mercatorCoordinate.y*worldSize,tileX=Math.floor(mercatorX/performance$1.EXTENT),tileY=Math.floor(mercatorY/performance$1.EXTENT);return{tileID:new performance$1.OverscaledTileID(zoom,0,zoom,tileX,tileY),mercatorX:mercatorX,mercatorY:mercatorY}}}class RenderPool{constructor(_context,_size,_tileSize){this._context=_context,this._size=_size,this._tileSize=_tileSize,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const obj of this._objects)obj.texture.destroy(),obj.fbo.destroy()}_createObject(id){const fbo=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),texture=new Texture(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return texture.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),fbo.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),fbo.colorAttachment.set(texture.texture),{id:id,fbo:fbo,texture:texture,stamp:-1,inUse:!1}}getObjectForId(id){return this._objects[id]}useObject(obj){obj.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter((id=>obj.id!==id)),this._recentlyUsed.push(obj.id)}stampObject(obj){obj.stamp=++this._stamp}getOrCreateFreeObject(){for(const id of this._recentlyUsed)if(!this._objects[id].inUse)return this._objects[id];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const obj=this._createObject(this._objects.length);return this._objects.push(obj),obj}freeObject(obj){obj.inUse=!1}freeAllObjects(){for(const obj of this._objects)this.freeObject(obj)}isFull(){return!(this._objects.length<this._size)&&!1===this._objects.some((o=>!o.inUse))}}const LAYERS={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class RenderToTexture{constructor(painter,terrain){this.painter=painter,this.terrain=terrain,this.pool=new RenderPool(painter.context,30,terrain.sourceCache.tileSize*terrain.qualityFactor)}destruct(){this.pool.destruct()}getTexture(tile){return this.pool.getObjectForId(tile.rtt[this._stacks.length-1].id).texture}prepareForRender(style,zoom){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=style._order.filter((id=>!style._layers[id].isHidden(zoom))),this._coordsDescendingInv={};for(const id in style.sourceCaches){this._coordsDescendingInv[id]={};const tileIDs=style.sourceCaches[id].getVisibleCoordinates();for(const tileID of tileIDs){const keys=this.terrain.sourceCache.getTerrainCoords(tileID);for(const key in keys)this._coordsDescendingInv[id][key]||(this._coordsDescendingInv[id][key]=[]),this._coordsDescendingInv[id][key].push(keys[key])}}this._coordsDescendingInvStr={};for(const id of style._order){const layer=style._layers[id],source=layer.source;if(LAYERS[layer.type]&&!this._coordsDescendingInvStr[source]){this._coordsDescendingInvStr[source]={};for(const key in this._coordsDescendingInv[source])this._coordsDescendingInvStr[source][key]=this._coordsDescendingInv[source][key].map((c=>c.key)).sort().join()}}for(const tile of this._renderableTiles)for(const source in this._coordsDescendingInvStr){const coords=this._coordsDescendingInvStr[source][tile.tileID.key];coords&&coords!==tile.rttCoords[source]&&(tile.rtt=[])}}renderLayer(layer){if(layer.isHidden(this.painter.transform.zoom))return!1;const type=layer.type,painter=this.painter,isLastLayer=this._renderableLayerIds[this._renderableLayerIds.length-1]===layer.id;if(LAYERS[type]&&(this._prevType&&LAYERS[this._prevType]||this._stacks.push([]),this._prevType=type,this._stacks[this._stacks.length-1].push(layer.id),!isLastLayer))return!0;if(LAYERS[this._prevType]||LAYERS[type]&&isLastLayer){this._prevType=type;const stack=this._stacks.length-1,layers=this._stacks[stack]||[];for(const tile of this._renderableTiles){if(this.pool.isFull()&&(drawTerrain(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(tile),tile.rtt[stack]){const obj=this.pool.getObjectForId(tile.rtt[stack].id);if(obj.stamp===tile.rtt[stack].stamp){this.pool.useObject(obj);continue}}const obj=this.pool.getOrCreateFreeObject();this.pool.useObject(obj),this.pool.stampObject(obj),tile.rtt[stack]={id:obj.id,stamp:obj.stamp},painter.context.bindFramebuffer.set(obj.fbo.framebuffer),painter.context.clear({color:performance$1.Color.transparent,stencil:0}),painter.currentStencilSource=void 0;for(let l=0;l<layers.length;l++){const layer=painter.style._layers[layers[l]],coords=layer.source?this._coordsDescendingInv[layer.source][tile.tileID.key]:[tile.tileID];painter.context.viewport.set([0,0,obj.fbo.width,obj.fbo.height]),painter._renderTileClippingMasks(layer,coords),painter.renderLayer(painter,painter.style.sourceCaches[layer.source],layer,coords),layer.source&&(tile.rttCoords[layer.source]=this._coordsDescendingInvStr[layer.source][tile.tileID.key])}}return drawTerrain(this.painter,this.terrain,this._rttTiles),this._rttTiles=[],this.pool.freeAllObjects(),LAYERS[type]}return!1}}const defaultLocale={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use  + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},version$1=packageJSON_version,defaultOptions$4={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:defaultAtributionControlOptions,maplibreLogo:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:performance$1.config.MAX_TILE_CACHE_ZOOM_LEVELS,localIdeographFontFamily:"sans-serif",transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,validateStyle:!0,maxCanvasSize:[4096,4096]};const assignEvents=handler=>{handler.touchstart=handler.dragStart,handler.touchmoveWindow=handler.dragMove,handler.touchend=handler.dragEnd},defaultOptions$3={showCompass:!0,showZoom:!0,visualizePitch:!1};class MouseRotateWrapper{constructor(map,element,pitch=!1){this.mousedown=e=>{this.startMouse(performance$1.extend({},e,{ctrlKey:!0,preventDefault:()=>e.preventDefault()}),DOM.mousePos(this.element,e)),DOM.addEventListener(window,"mousemove",this.mousemove),DOM.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=e=>{this.moveMouse(e,DOM.mousePos(this.element,e))},this.mouseup=e=>{this.mouseRotate.dragEnd(e),this.mousePitch&&this.mousePitch.dragEnd(e),this.offTemp()},this.touchstart=e=>{1!==e.targetTouches.length?this.reset():(this._startPos=this._lastPos=DOM.touchPos(this.element,e.targetTouches)[0],this.startTouch(e,this._startPos),DOM.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),DOM.addEventListener(window,"touchend",this.touchend))},this.touchmove=e=>{1!==e.targetTouches.length?this.reset():(this._lastPos=DOM.touchPos(this.element,e.targetTouches)[0],this.moveTouch(e,this._lastPos))},this.touchend=e=>{0===e.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),this.touchRotate.reset(),this.touchPitch&&this.touchPitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10;const mapRotateTolerance=map.dragRotate._mouseRotate.getClickTolerance(),mapPitchTolerance=map.dragRotate._mousePitch.getClickTolerance();this.element=element,this.mouseRotate=generateMouseRotationHandler({clickTolerance:mapRotateTolerance,enable:!0}),this.touchRotate=(({enable:enable,clickTolerance:clickTolerance,bearingDegreesPerPixelMoved:bearingDegreesPerPixelMoved=.8})=>{const touchMoveStateManager=new OneFingerTouchMoveStateManager;return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({bearingDelta:(point.x-lastPoint.x)*bearingDegreesPerPixelMoved}),moveStateManager:touchMoveStateManager,enable:enable,assignEvents:assignEvents})})({clickTolerance:mapRotateTolerance,enable:!0}),this.map=map,pitch&&(this.mousePitch=generateMousePitchHandler({clickTolerance:mapPitchTolerance,enable:!0}),this.touchPitch=(({enable:enable,clickTolerance:clickTolerance,pitchDegreesPerPixelMoved:pitchDegreesPerPixelMoved=-.5})=>{const touchMoveStateManager=new OneFingerTouchMoveStateManager;return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({pitchDelta:(point.y-lastPoint.y)*pitchDegreesPerPixelMoved}),moveStateManager:touchMoveStateManager,enable:enable,assignEvents:assignEvents})})({clickTolerance:mapPitchTolerance,enable:!0})),DOM.addEventListener(element,"mousedown",this.mousedown),DOM.addEventListener(element,"touchstart",this.touchstart,{passive:!1}),DOM.addEventListener(element,"touchcancel",this.reset)}startMouse(e,point){this.mouseRotate.dragStart(e,point),this.mousePitch&&this.mousePitch.dragStart(e,point),DOM.disableDrag()}startTouch(e,point){this.touchRotate.dragStart(e,point),this.touchPitch&&this.touchPitch.dragStart(e,point),DOM.disableDrag()}moveMouse(e,point){const map=this.map,{bearingDelta:bearingDelta}=this.mouseRotate.dragMove(e,point)||{};if(bearingDelta&&map.setBearing(map.getBearing()+bearingDelta),this.mousePitch){const{pitchDelta:pitchDelta}=this.mousePitch.dragMove(e,point)||{};pitchDelta&&map.setPitch(map.getPitch()+pitchDelta)}}moveTouch(e,point){const map=this.map,{bearingDelta:bearingDelta}=this.touchRotate.dragMove(e,point)||{};if(bearingDelta&&map.setBearing(map.getBearing()+bearingDelta),this.touchPitch){const{pitchDelta:pitchDelta}=this.touchPitch.dragMove(e,point)||{};pitchDelta&&map.setPitch(map.getPitch()+pitchDelta)}}off(){const element=this.element;DOM.removeEventListener(element,"mousedown",this.mousedown),DOM.removeEventListener(element,"touchstart",this.touchstart,{passive:!1}),DOM.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),DOM.removeEventListener(window,"touchend",this.touchend),DOM.removeEventListener(element,"touchcancel",this.reset),this.offTemp()}offTemp(){DOM.enableDrag(),DOM.removeEventListener(window,"mousemove",this.mousemove),DOM.removeEventListener(window,"mouseup",this.mouseup),DOM.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),DOM.removeEventListener(window,"touchend",this.touchend)}}let supportsGeolocation;function smartWrap(lngLat,priorPos,transform){const originalLngLat=new performance$1.LngLat(lngLat.lng,lngLat.lat);if(lngLat=new performance$1.LngLat(lngLat.lng,lngLat.lat),priorPos){const left=new performance$1.LngLat(lngLat.lng-360,lngLat.lat),right=new performance$1.LngLat(lngLat.lng+360,lngLat.lat),delta=transform.locationPoint(lngLat).distSqr(priorPos);transform.locationPoint(left).distSqr(priorPos)<delta?lngLat=left:transform.locationPoint(right).distSqr(priorPos)<delta&&(lngLat=right)}for(;Math.abs(lngLat.lng-transform.center.lng)>180;){const pos=transform.locationPoint(lngLat);if(pos.x>=0&&pos.y>=0&&pos.x<=transform.width&&pos.y<=transform.height)break;lngLat.lng>transform.center.lng?lngLat.lng-=360:lngLat.lng+=360}return lngLat.lng!==originalLngLat.lng&&transform.locationPoint(lngLat).y>transform.height/2-transform.getHorizon()?lngLat:originalLngLat}const anchorTranslate={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function applyAnchorClass(element,anchor,prefix){const classList=element.classList;for(const key in anchorTranslate)classList.remove(`maplibregl-${prefix}-anchor-${key}`);classList.add(`maplibregl-${prefix}-anchor-${anchor}`)}class Marker extends performance$1.Evented{constructor(options){if(super(),this._onKeyPress=e=>{const code=e.code,legacyCode=e.charCode||e.keyCode;"Space"!==code&&"Enter"!==code&&32!==legacyCode&&13!==legacyCode||this.togglePopup()},this._onMapClick=e=>{const targetElement=e.originalEvent.target,element=this._element;this._popup&&(targetElement===element||element.contains(targetElement))&&this.togglePopup()},this._update=e=>{if(!this._map)return;const isFullyLoaded=this._map.loaded()&&!this._map.isMoving();("terrain"===(null==e?void 0:e.type)||"render"===(null==e?void 0:e.type)&&!isFullyLoaded)&&this._map.once("render",this._update),this._map.transform.renderWorldCopies&&(this._lngLat=smartWrap(this._lngLat,this._flatPos,this._map.transform)),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationPoint(this._lngLat)._add(this._offset));let rotation="";"viewport"===this._rotationAlignment||"auto"===this._rotationAlignment?rotation=`rotateZ(${this._rotation}deg)`:"map"===this._rotationAlignment&&(rotation=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let pitch="";"viewport"===this._pitchAlignment||"auto"===this._pitchAlignment?pitch="rotateX(0deg)":"map"===this._pitchAlignment&&(pitch=`rotateX(${this._map.getPitch()}deg)`),e&&"moveend"!==e.type||(this._pos=this._pos.round()),DOM.setTransform(this._element,`${anchorTranslate[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${pitch} ${rotation}`),browser.frameAsync(new AbortController).then((()=>{this._updateOpacity(e&&"moveend"===e.type)})).catch((()=>{}))},this._onMove=e=>{if(!this._isDragging){const clickTolerance=this._clickTolerance||this._map._clickTolerance;this._isDragging=e.point.dist(this._pointerdownPos)>=clickTolerance}this._isDragging&&(this._pos=e.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new performance$1.Event("dragstart"))),this.fire(new performance$1.Event("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),"active"===this._state&&this.fire(new performance$1.Event("dragend")),this._state="inactive"},this._addDragHandler=e=>{this._element.contains(e.originalEvent.target)&&(e.preventDefault(),this._positionDelta=e.point.sub(this._pos).add(this._offset),this._pointerdownPos=e.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=options&&options.anchor||"center",this._color=options&&options.color||"#3FB1CE",this._scale=options&&options.scale||1,this._draggable=options&&options.draggable||!1,this._clickTolerance=options&&options.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=options&&options.rotation||0,this._rotationAlignment=options&&options.rotationAlignment||"auto",this._pitchAlignment=options&&options.pitchAlignment&&"auto"!==options.pitchAlignment?options.pitchAlignment:this._rotationAlignment,this.setOpacity(),this.setOpacity(null==options?void 0:options.opacity,null==options?void 0:options.opacityWhenCovered),options&&options.element)this._element=options.element,this._offset=performance$1.Point.convert(options&&options.offset||[0,0]);else{this._defaultMarker=!0,this._element=DOM.create("div"),this._element.setAttribute("aria-label","Map marker");const svg=DOM.createNS("http://www.w3.org/2000/svg","svg"),defaultHeight=41,defaultWidth=27;svg.setAttributeNS(null,"display","block"),svg.setAttributeNS(null,"height",`${defaultHeight}px`),svg.setAttributeNS(null,"width",`${defaultWidth}px`),svg.setAttributeNS(null,"viewBox",`0 0 ${defaultWidth} ${defaultHeight}`);const markerLarge=DOM.createNS("http://www.w3.org/2000/svg","g");markerLarge.setAttributeNS(null,"stroke","none"),markerLarge.setAttributeNS(null,"stroke-width","1"),markerLarge.setAttributeNS(null,"fill","none"),markerLarge.setAttributeNS(null,"fill-rule","evenodd");const page1=DOM.createNS("http://www.w3.org/2000/svg","g");page1.setAttributeNS(null,"fill-rule","nonzero");const shadow=DOM.createNS("http://www.w3.org/2000/svg","g");shadow.setAttributeNS(null,"transform","translate(3.0, 29.0)"),shadow.setAttributeNS(null,"fill","#000000");const ellipses=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const data of ellipses){const ellipse=DOM.createNS("http://www.w3.org/2000/svg","ellipse");ellipse.setAttributeNS(null,"opacity","0.04"),ellipse.setAttributeNS(null,"cx","10.5"),ellipse.setAttributeNS(null,"cy","5.80029008"),ellipse.setAttributeNS(null,"rx",data.rx),ellipse.setAttributeNS(null,"ry",data.ry),shadow.appendChild(ellipse)}const background=DOM.createNS("http://www.w3.org/2000/svg","g");background.setAttributeNS(null,"fill",this._color);const bgPath=DOM.createNS("http://www.w3.org/2000/svg","path");bgPath.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),background.appendChild(bgPath);const border=DOM.createNS("http://www.w3.org/2000/svg","g");border.setAttributeNS(null,"opacity","0.25"),border.setAttributeNS(null,"fill","#000000");const borderPath=DOM.createNS("http://www.w3.org/2000/svg","path");borderPath.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),border.appendChild(borderPath);const maki=DOM.createNS("http://www.w3.org/2000/svg","g");maki.setAttributeNS(null,"transform","translate(6.0, 7.0)"),maki.setAttributeNS(null,"fill","#FFFFFF");const circleContainer=DOM.createNS("http://www.w3.org/2000/svg","g");circleContainer.setAttributeNS(null,"transform","translate(8.0, 8.0)");const circle1=DOM.createNS("http://www.w3.org/2000/svg","circle");circle1.setAttributeNS(null,"fill","#000000"),circle1.setAttributeNS(null,"opacity","0.25"),circle1.setAttributeNS(null,"cx","5.5"),circle1.setAttributeNS(null,"cy","5.5"),circle1.setAttributeNS(null,"r","5.4999962");const circle2=DOM.createNS("http://www.w3.org/2000/svg","circle");circle2.setAttributeNS(null,"fill","#FFFFFF"),circle2.setAttributeNS(null,"cx","5.5"),circle2.setAttributeNS(null,"cy","5.5"),circle2.setAttributeNS(null,"r","5.4999962"),circleContainer.appendChild(circle1),circleContainer.appendChild(circle2),page1.appendChild(shadow),page1.appendChild(background),page1.appendChild(border),page1.appendChild(maki),page1.appendChild(circleContainer),svg.appendChild(page1),svg.setAttributeNS(null,"height",defaultHeight*this._scale+"px"),svg.setAttributeNS(null,"width",defaultWidth*this._scale+"px"),this._element.appendChild(svg),this._offset=performance$1.Point.convert(options&&options.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",(e=>{e.preventDefault()})),this._element.addEventListener("mousedown",(e=>{e.preventDefault()})),applyAnchorClass(this._element,this._anchor,"marker"),options&&options.className)for(const name of options.className.split(" "))this._element.classList.add(name);this._popup=null}addTo(map){return this.remove(),this._map=map,map.getCanvasContainer().appendChild(this._element),map.on("move",this._update),map.on("moveend",this._update),map.on("terrain",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),DOM.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(lnglat){return this._lngLat=performance$1.LngLat.convert(lnglat),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(popup){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),popup){if(!("offset"in popup.options)){const markerHeight=38.1,markerRadius=13.5,linearOffset=Math.abs(markerRadius)/Math.SQRT2;popup.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-markerHeight],"bottom-left":[linearOffset,-1*(markerHeight-markerRadius+linearOffset)],"bottom-right":[-linearOffset,-1*(markerHeight-markerRadius+linearOffset)],left:[markerRadius,-1*(markerHeight-markerRadius)],right:[-markerRadius,-1*(markerHeight-markerRadius)]}:this._offset}this._popup=popup,this._lngLat&&this._popup.setLngLat(this._lngLat),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}getPopup(){return this._popup}togglePopup(){const popup=this._popup;return popup?(popup.isOpen()?popup.remove():popup.addTo(this._map),this):this}_updateOpacity(force=!1){var _a;if(!(null===(_a=this._map)||void 0===_a?void 0:_a.terrain))return void(this._element.style.opacity!==this._opacity&&(this._element.style.opacity=this._opacity));if(force)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout((()=>{this._opacityTimeout=null}),100)}const map=this._map,terrainDistance=map.terrain.depthAtPoint(this._pos),elevation=map.terrain.getElevationForLngLatZoom(this._lngLat,map.transform.tileZoom);if(map.transform.lngLatToCameraDepth(this._lngLat,elevation)-terrainDistance<.006)return void(this._element.style.opacity=this._opacity);const metersToCenter=-this._offset.y/map.transform._pixelPerMeter,elevationToCenter=Math.sin(map.getPitch()*Math.PI/180)*metersToCenter,terrainDistanceCenter=map.terrain.depthAtPoint(new performance$1.Point(this._pos.x,this._pos.y-this._offset.y)),centerIsInvisible=map.transform.lngLatToCameraDepth(this._lngLat,elevation+elevationToCenter)-terrainDistanceCenter>.006;this._element.style.opacity=centerIsInvisible?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(offset){return this._offset=performance$1.Point.convert(offset),this._update(),this}addClassName(className){this._element.classList.add(className)}removeClassName(className){this._element.classList.remove(className)}toggleClassName(className){return this._element.classList.toggle(className)}setDraggable(shouldBeDraggable){return this._draggable=!!shouldBeDraggable,this._map&&(shouldBeDraggable?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(rotation){return this._rotation=rotation||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(alignment){return this._rotationAlignment=alignment||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(alignment){return this._pitchAlignment=alignment&&"auto"!==alignment?alignment:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(opacity,opacityWhenCovered){return void 0===opacity&&void 0===opacityWhenCovered&&(this._opacity="1",this._opacityWhenCovered="0.2"),void 0!==opacity&&(this._opacity=opacity),void 0!==opacityWhenCovered&&(this._opacityWhenCovered=opacityWhenCovered),this._map&&this._updateOpacity(!0),this}}const defaultOptions$2={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let numberOfWatches=0,noTimeout=!1;class GeolocateControl extends performance$1.Evented{constructor(options){super(),this._onSuccess=position=>{if(this._map){if(this._isOutOfMapMaxBounds(position))return this._setErrorState(),this.fire(new performance$1.Event("outofmaxbounds",position)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=position,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(position),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(position),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new performance$1.Event("geolocate",position)),this._finish()}},this._updateCamera=position=>{const center=new performance$1.LngLat(position.coords.longitude,position.coords.latitude),radius=position.coords.accuracy,bearing=this._map.getBearing(),options=performance$1.extend({bearing:bearing},this.options.fitBoundsOptions),newBounds=LngLatBounds.fromLngLat(center,radius);this._map.fitBounds(newBounds,options,{geolocateSource:!0})},this._updateMarker=position=>{if(position){const center=new performance$1.LngLat(position.coords.longitude,position.coords.latitude);this._accuracyCircleMarker.setLngLat(center).addTo(this._map),this._userLocationDotMarker.setLngLat(center).addTo(this._map),this._accuracy=position.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=error=>{if(this._map){if(this.options.trackUserLocation)if(1===error.code){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const title=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=title,this._geolocateButton.setAttribute("aria-label",title),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===error.code&&noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new performance$1.Event("error",error)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=supported=>{if(this._map){if(this._container.addEventListener("contextmenu",(e=>e.preventDefault())),this._geolocateButton=DOM.create("button","maplibregl-ctrl-geolocate",this._container),DOM.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===supported){performance$1.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const title=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=title,this._geolocateButton.setAttribute("aria-label",title)}else{const title=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.title=title,this._geolocateButton.setAttribute("aria-label",title)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=DOM.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Marker({element:this._dotElement}),this._circleElement=DOM.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Marker({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",(()=>this.trigger())),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(event=>{const fromResize=event.originalEvent&&"resize"===event.originalEvent.type;event.geolocateSource||"ACTIVE_LOCK"!==this._watchState||fromResize||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new performance$1.Event("trackuserlocationend")))}))}},this.options=performance$1.extend({},defaultOptions$2,options)}onAdd(map){return this._map=map,this._container=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-group"),function(forceRecalculation=!1){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(void 0!==supportsGeolocation&&!forceRecalculation)return supportsGeolocation;if(void 0===window.navigator.permissions)return supportsGeolocation=!!window.navigator.geolocation,supportsGeolocation;try{const permissions=yield window.navigator.permissions.query({name:"geolocation"});supportsGeolocation="denied"!==permissions.state}catch(_a){supportsGeolocation=!!window.navigator.geolocation}return supportsGeolocation}))}().then((supported=>this._setupUI(supported))),this._container}onRemove(){void 0!==this._geolocationWatchID&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),DOM.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,numberOfWatches=0,noTimeout=!1}_isOutOfMapMaxBounds(position){const bounds=this._map.getMaxBounds(),coordinates=position.coords;return bounds&&(coordinates.longitude<bounds.getWest()||coordinates.longitude>bounds.getEast()||coordinates.latitude<bounds.getSouth()||coordinates.latitude>bounds.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const bounds=this._map.getBounds(),southEastPoint=bounds.getSouthEast(),northEastPoint=bounds.getNorthEast(),mapHeightInMeters=southEastPoint.distanceTo(northEastPoint),mapHeightInPixels=this._map._container.clientHeight,circleDiameter=Math.ceil(this._accuracy/(mapHeightInMeters/mapHeightInPixels)*2);this._circleElement.style.width=`${circleDiameter}px`,this._circleElement.style.height=`${circleDiameter}px`}trigger(){if(!this._setup)return performance$1.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new performance$1.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":numberOfWatches--,noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new performance$1.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new performance$1.Event("trackuserlocationstart"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let positionOptions;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),numberOfWatches++,numberOfWatches>1?(positionOptions={maximumAge:6e5,timeout:0},noTimeout=!0):(positionOptions=this.options.positionOptions,noTimeout=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,positionOptions)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}}const defaultOptions$1={maxWidth:100,unit:"metric"};function updateScale(map,container,options){const maxWidth=options&&options.maxWidth||100,y=map._container.clientHeight/2,left=map.unproject([0,y]),right=map.unproject([maxWidth,y]),maxMeters=left.distanceTo(right);if(options&&"imperial"===options.unit){const maxFeet=3.2808*maxMeters;if(maxFeet>5280){setScale(container,maxWidth,maxFeet/5280,map._getUIString("ScaleControl.Miles"))}else setScale(container,maxWidth,maxFeet,map._getUIString("ScaleControl.Feet"))}else if(options&&"nautical"===options.unit){setScale(container,maxWidth,maxMeters/1852,map._getUIString("ScaleControl.NauticalMiles"))}else maxMeters>=1e3?setScale(container,maxWidth,maxMeters/1e3,map._getUIString("ScaleControl.Kilometers")):setScale(container,maxWidth,maxMeters,map._getUIString("ScaleControl.Meters"))}function setScale(container,maxWidth,maxDistance,unit){const distance=function(num){const pow10=Math.pow(10,`${Math.floor(num)}`.length-1);let d=num/pow10;return d=d>=10?10:d>=5?5:d>=3?3:d>=2?2:d>=1?1:function(d){const multiplier=Math.pow(10,Math.ceil(-Math.log(d)/Math.LN10));return Math.round(d*multiplier)/multiplier}(d),pow10*d}(maxDistance),ratio=distance/maxDistance;container.style.width=maxWidth*ratio+"px",container.innerHTML=`${distance}&nbsp;${unit}`}class FullscreenControl extends performance$1.Evented{constructor(options={}){super(),this._onFullscreenChange=()=>{(window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement)===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,options&&options.container&&(options.container instanceof HTMLElement?this._container=options.container:performance$1.warnOnce("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(map){return this._map=map,this._container||(this._container=this._map.getContainer()),this._controlContainer=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){DOM.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const button=this._fullscreenButton=DOM.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);DOM.create("span","maplibregl-ctrl-icon",button).setAttribute("aria-hidden","true"),button.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const title=this._getTitle();this._fullscreenButton.setAttribute("aria-label",title),this._fullscreenButton.title=title}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new performance$1.Event("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new performance$1.Event("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}}const defaultOptions={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},focusQuerySelector=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");class Popup extends performance$1.Evented{constructor(options){super(),this.remove=()=>(this._content&&DOM.remove(this._content),this._container&&(DOM.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map),this.fire(new performance$1.Event("close")),this),this._onMouseUp=event=>{this._update(event.point)},this._onMouseMove=event=>{this._update(event.point)},this._onDrag=event=>{this._update(event.point)},this._update=cursor=>{const hasPosition=this._lngLat||this._trackPointer;if(!this._map||!hasPosition||!this._content)return;if(!this._container){if(this._container=DOM.create("div","maplibregl-popup",this._map.getContainer()),this._tip=DOM.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const name of this.options.className.split(" "))this._container.classList.add(name);this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._map.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=smartWrap(this._lngLat,this._flatPos,this._map.transform)),this._trackPointer&&!cursor)return;const pos=this._flatPos=this._pos=this._trackPointer&&cursor?cursor:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&cursor?cursor:this._map.transform.locationPoint(this._lngLat));let anchor=this.options.anchor;const offset=normalizeOffset(this.options.offset);if(!anchor){const width=this._container.offsetWidth,height=this._container.offsetHeight;let anchorComponents;anchorComponents=pos.y+offset.bottom.y<height?["top"]:pos.y>this._map.transform.height-height?["bottom"]:[],pos.x<width/2?anchorComponents.push("left"):pos.x>this._map.transform.width-width/2&&anchorComponents.push("right"),anchor=0===anchorComponents.length?"bottom":anchorComponents.join("-")}const offsetedPos=pos.add(offset[anchor]).round();DOM.setTransform(this._container,`${anchorTranslate[anchor]} translate(${offsetedPos.x}px,${offsetedPos.y}px)`),applyAnchorClass(this._container,anchor,"popup")},this._onClose=()=>{this.remove()},this.options=performance$1.extend(Object.create(defaultOptions),options)}addTo(map){return this._map&&this.remove(),this._map=map,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new performance$1.Event("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(lnglat){return this._lngLat=performance$1.LngLat.convert(lnglat),this._pos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(text){return this.setDOMContent(document.createTextNode(text))}setHTML(html){const frag=document.createDocumentFragment(),temp=document.createElement("body");let child;for(temp.innerHTML=html;child=temp.firstChild,child;)frag.appendChild(child);return this.setDOMContent(frag)}getMaxWidth(){var _a;return null===(_a=this._container)||void 0===_a?void 0:_a.style.maxWidth}setMaxWidth(maxWidth){return this.options.maxWidth=maxWidth,this._update(),this}setDOMContent(htmlNode){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=DOM.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(htmlNode),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(className){this._container&&this._container.classList.add(className)}removeClassName(className){this._container&&this._container.classList.remove(className)}setOffset(offset){return this.options.offset=offset,this._update(),this}toggleClassName(className){if(this._container)return this._container.classList.toggle(className)}_createCloseButton(){this.options.closeButton&&(this._closeButton=DOM.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const firstFocusable=this._container.querySelector(focusQuerySelector);firstFocusable&&firstFocusable.focus()}}function normalizeOffset(offset){if(offset){if("number"==typeof offset){const cornerOffset=Math.round(Math.abs(offset)/Math.SQRT2);return{center:new performance$1.Point(0,0),top:new performance$1.Point(0,offset),"top-left":new performance$1.Point(cornerOffset,cornerOffset),"top-right":new performance$1.Point(-cornerOffset,cornerOffset),bottom:new performance$1.Point(0,-offset),"bottom-left":new performance$1.Point(cornerOffset,-cornerOffset),"bottom-right":new performance$1.Point(-cornerOffset,-cornerOffset),left:new performance$1.Point(offset,0),right:new performance$1.Point(-offset,0)}}if(offset instanceof performance$1.Point||Array.isArray(offset)){const convertedOffset=performance$1.Point.convert(offset);return{center:convertedOffset,top:convertedOffset,"top-left":convertedOffset,"top-right":convertedOffset,bottom:convertedOffset,"bottom-left":convertedOffset,"bottom-right":convertedOffset,left:convertedOffset,right:convertedOffset}}return{center:performance$1.Point.convert(offset.center||[0,0]),top:performance$1.Point.convert(offset.top||[0,0]),"top-left":performance$1.Point.convert(offset["top-left"]||[0,0]),"top-right":performance$1.Point.convert(offset["top-right"]||[0,0]),bottom:performance$1.Point.convert(offset.bottom||[0,0]),"bottom-left":performance$1.Point.convert(offset["bottom-left"]||[0,0]),"bottom-right":performance$1.Point.convert(offset["bottom-right"]||[0,0]),left:performance$1.Point.convert(offset.left||[0,0]),right:performance$1.Point.convert(offset.right||[0,0])}}return normalizeOffset(new performance$1.Point(0,0))}const version=packageJSON_version;exports.AJAXError=performance$1.AJAXError,exports.Evented=performance$1.Evented,exports.LngLat=performance$1.LngLat,exports.MercatorCoordinate=performance$1.MercatorCoordinate,exports.Point=performance$1.Point,exports.addProtocol=performance$1.addProtocol,exports.config=performance$1.config,exports.removeProtocol=performance$1.removeProtocol,exports.AttributionControl=AttributionControl,exports.BoxZoomHandler=BoxZoomHandler,exports.CanvasSource=CanvasSource,exports.CooperativeGesturesHandler=CooperativeGesturesHandler,exports.DoubleClickZoomHandler=DoubleClickZoomHandler,exports.DragPanHandler=DragPanHandler,exports.DragRotateHandler=DragRotateHandler,exports.EdgeInsets=EdgeInsets,exports.FullscreenControl=FullscreenControl,exports.GeoJSONSource=GeoJSONSource,exports.GeolocateControl=GeolocateControl,exports.Hash=Hash,exports.ImageSource=ImageSource,exports.KeyboardHandler=KeyboardHandler,exports.LngLatBounds=LngLatBounds,exports.LogoControl=LogoControl,exports.Map=class extends Camera{constructor(options){if(performance$1.PerformanceUtils.mark(performance$1.PerformanceMarkers.create),null!=(options=performance$1.extend({},defaultOptions$4,options)).minZoom&&null!=options.maxZoom&&options.minZoom>options.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=options.minPitch&&null!=options.maxPitch&&options.minPitch>options.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=options.minPitch&&options.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=options.maxPitch&&options.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(super(new Transform(options.minZoom,options.maxZoom,options.minPitch,options.maxPitch,options.renderWorldCopies),{bearingSnap:options.bearingSnap}),this._contextLost=event=>{event.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new performance$1.Event("webglcontextlost",{originalEvent:event}))},this._contextRestored=event=>{this._setupPainter(),this.resize(),this._update(),this.fire(new performance$1.Event("webglcontextrestored",{originalEvent:event}))},this._onMapScroll=event=>{if(event.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=options.interactive,this._maxTileCacheSize=options.maxTileCacheSize,this._maxTileCacheZoomLevels=options.maxTileCacheZoomLevels,this._failIfMajorPerformanceCaveat=options.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=options.preserveDrawingBuffer,this._antialias=options.antialias,this._trackResize=options.trackResize,this._bearingSnap=options.bearingSnap,this._refreshExpiredTiles=options.refreshExpiredTiles,this._fadeDuration=options.fadeDuration,this._crossSourceCollisions=options.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=options.collectResourceTiming,this._renderTaskQueue=new TaskQueue,this._controls=[],this._mapId=performance$1.uniqueId(),this._locale=performance$1.extend({},defaultLocale,options.locale),this._clickTolerance=options.clickTolerance,this._overridePixelRatio=options.pixelRatio,this._maxCanvasSize=options.maxCanvasSize,this.transformCameraUpdate=options.transformCameraUpdate,this._imageQueueHandle=ImageRequest.addThrottleControl((()=>this.isMoving())),this._requestManager=new RequestManager(options.transformRequest),"string"==typeof options.container){if(this._container=document.getElementById(options.container),!this._container)throw new Error(`Container '${options.container}' not found.`)}else{if(!(options.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=options.container}if(options.maxBounds&&this.setMaxBounds(options.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this.on("terrain",(()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)})),this.once("idle",(()=>{this._idleTriggered=!0})),"undefined"!=typeof window){addEventListener("online",this._onWindowOnline,!1);let initialResizeEventCaptured=!1;const throttledResizeCallback=throttle((entries=>{this._trackResize&&!this._removed&&this.resize(entries)._update()}),50);this._resizeObserver=new ResizeObserver((entries=>{initialResizeEventCaptured?throttledResizeCallback(entries):initialResizeEventCaptured=!0})),this._resizeObserver.observe(this._container)}this.handlers=new HandlerManager(this,options);const hashName="string"==typeof options.hash&&options.hash||void 0;this._hash=options.hash&&new Hash(hashName).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:options.center,zoom:options.zoom,bearing:options.bearing,pitch:options.pitch}),options.bounds&&(this.resize(),this.fitBounds(options.bounds,performance$1.extend({},options.fitBoundsOptions,{duration:0})))),this.resize(),this._localIdeographFontFamily=options.localIdeographFontFamily,this._validateStyle=options.validateStyle,options.style&&this.setStyle(options.style,{localIdeographFontFamily:options.localIdeographFontFamily}),options.attributionControl&&this.addControl(new AttributionControl("boolean"==typeof options.attributionControl?void 0:options.attributionControl)),options.maplibreLogo&&this.addControl(new LogoControl,options.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)})),this.on("data",(event=>{this._update("style"===event.dataType),this.fire(new performance$1.Event(`${event.dataType}data`,event))})),this.on("dataloading",(event=>{this.fire(new performance$1.Event(`${event.dataType}dataloading`,event))})),this.on("dataabort",(event=>{this.fire(new performance$1.Event("sourcedataabort",event))}))}_getMapId(){return this._mapId}addControl(control,position){if(void 0===position&&(position=control.getDefaultPosition?control.getDefaultPosition():"top-right"),!control||!control.onAdd)return this.fire(new performance$1.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const controlElement=control.onAdd(this);this._controls.push(control);const positionContainer=this._controlPositions[position];return-1!==position.indexOf("bottom")?positionContainer.insertBefore(controlElement,positionContainer.firstChild):positionContainer.appendChild(controlElement),this}removeControl(control){if(!control||!control.onRemove)return this.fire(new performance$1.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const ci=this._controls.indexOf(control);return ci>-1&&this._controls.splice(ci,1),control.onRemove(this),this}hasControl(control){return this._controls.indexOf(control)>-1}calculateCameraOptionsFromTo(from,altitudeFrom,to,altitudeTo){return null==altitudeTo&&this.terrain&&(altitudeTo=this.terrain.getElevationForLngLatZoom(to,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(from,altitudeFrom,to,altitudeTo)}resize(eventData){var _a;const dimensions=this._containerDimensions(),width=dimensions[0],height=dimensions[1],clampedPixelRatio=this._getClampedPixelRatio(width,height);if(this._resizeCanvas(width,height,clampedPixelRatio),this.painter.resize(width,height,clampedPixelRatio),this.painter.overLimit()){const gl=this.painter.context.gl;this._maxCanvasSize=[gl.drawingBufferWidth,gl.drawingBufferHeight];const clampedPixelRatio=this._getClampedPixelRatio(width,height);this._resizeCanvas(width,height,clampedPixelRatio),this.painter.resize(width,height,clampedPixelRatio)}this.transform.resize(width,height),null===(_a=this._requestedCameraState)||void 0===_a||_a.resize(width,height);const fireMoving=!this._moving;return fireMoving&&(this.stop(),this.fire(new performance$1.Event("movestart",eventData)).fire(new performance$1.Event("move",eventData))),this.fire(new performance$1.Event("resize",eventData)),fireMoving&&this.fire(new performance$1.Event("moveend",eventData)),this}_getClampedPixelRatio(width,height){const{0:maxCanvasWidth,1:maxCanvasHeight}=this._maxCanvasSize,pixelRatio=this.getPixelRatio(),canvasWidth=width*pixelRatio,canvasHeight=height*pixelRatio,widthScaleFactor=canvasWidth>maxCanvasWidth?maxCanvasWidth/canvasWidth:1,heightScaleFactor=canvasHeight>maxCanvasHeight?maxCanvasHeight/canvasHeight:1;return Math.min(widthScaleFactor,heightScaleFactor)*pixelRatio}getPixelRatio(){var _a;return null!==(_a=this._overridePixelRatio)&&void 0!==_a?_a:devicePixelRatio}setPixelRatio(pixelRatio){this._overridePixelRatio=pixelRatio,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(bounds){return this.transform.setMaxBounds(LngLatBounds.convert(bounds)),this._update()}setMinZoom(minZoom){if((minZoom=null==minZoom?-2:minZoom)>=-2&&minZoom<=this.transform.maxZoom)return this.transform.minZoom=minZoom,this._update(),this.getZoom()<minZoom&&this.setZoom(minZoom),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(maxZoom){if((maxZoom=null==maxZoom?22:maxZoom)>=this.transform.minZoom)return this.transform.maxZoom=maxZoom,this._update(),this.getZoom()>maxZoom&&this.setZoom(maxZoom),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(minPitch){if((minPitch=null==minPitch?0:minPitch)<0)throw new Error("minPitch must be greater than or equal to 0");if(minPitch>=0&&minPitch<=this.transform.maxPitch)return this.transform.minPitch=minPitch,this._update(),this.getPitch()<minPitch&&this.setPitch(minPitch),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(maxPitch){if((maxPitch=null==maxPitch?60:maxPitch)>85)throw new Error("maxPitch must be less than or equal to 85");if(maxPitch>=this.transform.minPitch)return this.transform.maxPitch=maxPitch,this._update(),this.getPitch()>maxPitch&&this.setPitch(maxPitch),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(renderWorldCopies){return this.transform.renderWorldCopies=renderWorldCopies,this._update()}project(lnglat){return this.transform.locationPoint(performance$1.LngLat.convert(lnglat),this.style&&this.terrain)}unproject(point){return this.transform.pointLocation(performance$1.Point.convert(point),this.terrain)}isMoving(){var _a;return this._moving||(null===(_a=this.handlers)||void 0===_a?void 0:_a.isMoving())}isZooming(){var _a;return this._zooming||(null===(_a=this.handlers)||void 0===_a?void 0:_a.isZooming())}isRotating(){var _a;return this._rotating||(null===(_a=this.handlers)||void 0===_a?void 0:_a.isRotating())}_createDelegatedListener(type,layerId,listener){if("mouseenter"===type||"mouseover"===type){let mousein=!1;const mousemove=e=>{const features=this.getLayer(layerId)?this.queryRenderedFeatures(e.point,{layers:[layerId]}):[];features.length?mousein||(mousein=!0,listener.call(this,new MapMouseEvent(type,this,e.originalEvent,{features:features}))):mousein=!1};return{layer:layerId,listener:listener,delegates:{mousemove:mousemove,mouseout:()=>{mousein=!1}}}}if("mouseleave"===type||"mouseout"===type){let mousein=!1;const mousemove=e=>{(this.getLayer(layerId)?this.queryRenderedFeatures(e.point,{layers:[layerId]}):[]).length?mousein=!0:mousein&&(mousein=!1,listener.call(this,new MapMouseEvent(type,this,e.originalEvent)))},mouseout=e=>{mousein&&(mousein=!1,listener.call(this,new MapMouseEvent(type,this,e.originalEvent)))};return{layer:layerId,listener:listener,delegates:{mousemove:mousemove,mouseout:mouseout}}}{const delegate=e=>{const features=this.getLayer(layerId)?this.queryRenderedFeatures(e.point,{layers:[layerId]}):[];features.length&&(e.features=features,listener.call(this,e),delete e.features)};return{layer:layerId,listener:listener,delegates:{[type]:delegate}}}}on(type,layerIdOrListener,listener){if(void 0===listener)return super.on(type,layerIdOrListener);const delegatedListener=this._createDelegatedListener(type,layerIdOrListener,listener);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[type]=this._delegatedListeners[type]||[],this._delegatedListeners[type].push(delegatedListener);for(const event in delegatedListener.delegates)this.on(event,delegatedListener.delegates[event]);return this}once(type,layerIdOrListener,listener){if(void 0===listener)return super.once(type,layerIdOrListener);const delegatedListener=this._createDelegatedListener(type,layerIdOrListener,listener);for(const event in delegatedListener.delegates)this.once(event,delegatedListener.delegates[event]);return this}off(type,layerIdOrListener,listener){if(void 0===listener)return super.off(type,layerIdOrListener);const removeDelegatedListener=delegatedListeners=>{const listeners=delegatedListeners[type];for(let i=0;i<listeners.length;i++){const delegatedListener=listeners[i];if(delegatedListener.layer===layerIdOrListener&&delegatedListener.listener===listener){for(const event in delegatedListener.delegates)this.off(event,delegatedListener.delegates[event]);return listeners.splice(i,1),this}}};return this._delegatedListeners&&this._delegatedListeners[type]&&removeDelegatedListener(this._delegatedListeners),this}queryRenderedFeatures(geometryOrOptions,options){if(!this.style)return[];let queryGeometry;const isGeometry=geometryOrOptions instanceof performance$1.Point||Array.isArray(geometryOrOptions),geometry=isGeometry?geometryOrOptions:[[0,0],[this.transform.width,this.transform.height]];if(options=options||(isGeometry?{}:geometryOrOptions)||{},geometry instanceof performance$1.Point||"number"==typeof geometry[0])queryGeometry=[performance$1.Point.convert(geometry)];else{const tl=performance$1.Point.convert(geometry[0]),br=performance$1.Point.convert(geometry[1]);queryGeometry=[tl,new performance$1.Point(br.x,tl.y),br,new performance$1.Point(tl.x,br.y),tl]}return this.style.queryRenderedFeatures(queryGeometry,options,this.transform)}querySourceFeatures(sourceId,parameters){return this.style.querySourceFeatures(sourceId,parameters)}setStyle(style,options){return!1!==(options=performance$1.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},options)).diff&&options.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&style?(this._diffStyle(style,options),this):(this._localIdeographFontFamily=options.localIdeographFontFamily,this._updateStyle(style,options))}setTransformRequest(transformRequest){return this._requestManager.setTransformRequest(transformRequest),this}_getUIString(key){const str=this._locale[key];if(null==str)throw new Error(`Missing UI string '${key}'`);return str}_updateStyle(style,options){if(options.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",(()=>this._updateStyle(style,options)));const previousStyle=this.style&&options.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!style)),style?(this.style=new Style(this,options||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof style?this.style.loadURL(style,options,previousStyle):this.style.loadJSON(style,options,previousStyle),this):(delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new Style(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(style,options){if("string"==typeof style){const url=style,request=this._requestManager.transformRequest(url,ResourceType.Style);performance$1.getJSON(request,new AbortController).then((response=>{this._updateDiff(response.data,options)})).catch((error=>{error&&this.fire(new performance$1.ErrorEvent(error))}))}else"object"==typeof style&&this._updateDiff(style,options)}_updateDiff(style,options){try{this.style.setState(style,options)&&this._update(!0)}catch(e){performance$1.warnOnce(`Unable to perform style diff: ${e.message||e.error||e}.  Rebuilding the style from scratch.`),this._updateStyle(style,options)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():performance$1.warnOnce("There is no style added to the map.")}addSource(id,source){return this._lazyInitEmptyStyle(),this.style.addSource(id,source),this._update(!0)}isSourceLoaded(id){const source=this.style&&this.style.sourceCaches[id];if(void 0!==source)return source.loaded();this.fire(new performance$1.ErrorEvent(new Error(`There is no source with ID '${id}'`)))}setTerrain(options){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),options){const sourceCache=this.style.sourceCaches[options.source];if(!sourceCache)throw new Error(`cannot load terrain, because there exists no source with ID: ${options.source}`);null===this.terrain&&sourceCache.reload();for(const index in this.style._layers){const thisLayer=this.style._layers[index];"hillshade"===thisLayer.type&&thisLayer.source===options.source&&performance$1.warnOnce("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new Terrain(this.painter,sourceCache,options),this.painter.renderToTexture=new RenderToTexture(this.painter,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._terrainDataCallback=e=>{"style"===e.dataType?this.terrain.sourceCache.freeRtt():"source"===e.dataType&&e.tile&&(e.sourceId!==options.source||this._elevationFreeze||(this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.terrain.sourceCache.freeRtt(e.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.minElevationForCurrentTile=0,this.transform.elevation=0;return this.fire(new performance$1.Event("terrain",{terrain:options})),this}getTerrain(){var _a,_b;return null!==(_b=null===(_a=this.terrain)||void 0===_a?void 0:_a.options)&&void 0!==_b?_b:null}areTilesLoaded(){const sources=this.style&&this.style.sourceCaches;for(const id in sources){const tiles=sources[id]._tiles;for(const t in tiles){const tile=tiles[t];if("loaded"!==tile.state&&"errored"!==tile.state)return!1}}return!0}removeSource(id){return this.style.removeSource(id),this._update(!0)}getSource(id){return this.style.getSource(id)}addImage(id,image,options={}){const{pixelRatio:pixelRatio=1,sdf:sdf=!1,stretchX:stretchX,stretchY:stretchY,content:content}=options;this._lazyInitEmptyStyle();if(!(image instanceof HTMLImageElement||performance$1.isImageBitmap(image))){if(void 0===image.width||void 0===image.height)return this.fire(new performance$1.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:width,height:height,data:data}=image,userImage=image;return this.style.addImage(id,{data:new performance$1.RGBAImage({width:width,height:height},new Uint8Array(data)),pixelRatio:pixelRatio,stretchX:stretchX,stretchY:stretchY,content:content,sdf:sdf,version:0,userImage:userImage}),userImage.onAdd&&userImage.onAdd(this,id),this}}{const{width:width,height:height,data:data}=browser.getImageData(image);this.style.addImage(id,{data:new performance$1.RGBAImage({width:width,height:height},data),pixelRatio:pixelRatio,stretchX:stretchX,stretchY:stretchY,content:content,sdf:sdf,version:0})}}updateImage(id,image){const existingImage=this.style.getImage(id);if(!existingImage)return this.fire(new performance$1.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const imageData=image instanceof HTMLImageElement||performance$1.isImageBitmap(image)?browser.getImageData(image):image,{width:width,height:height,data:data}=imageData;if(void 0===width||void 0===height)return this.fire(new performance$1.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(width!==existingImage.data.width||height!==existingImage.data.height)return this.fire(new performance$1.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image")));const copy=!(image instanceof HTMLImageElement||performance$1.isImageBitmap(image));return existingImage.data.replace(data,copy),this.style.updateImage(id,existingImage),this}getImage(id){return this.style.getImage(id)}hasImage(id){return id?!!this.style.getImage(id):(this.fire(new performance$1.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(id){this.style.removeImage(id)}loadImage(url){return ImageRequest.getImage(this._requestManager.transformRequest(url,ResourceType.Image),new AbortController)}listImages(){return this.style.listImages()}addLayer(layer,beforeId){return this._lazyInitEmptyStyle(),this.style.addLayer(layer,beforeId),this._update(!0)}moveLayer(id,beforeId){return this.style.moveLayer(id,beforeId),this._update(!0)}removeLayer(id){return this.style.removeLayer(id),this._update(!0)}getLayer(id){return this.style.getLayer(id)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(layerId,minzoom,maxzoom){return this.style.setLayerZoomRange(layerId,minzoom,maxzoom),this._update(!0)}setFilter(layerId,filter,options={}){return this.style.setFilter(layerId,filter,options),this._update(!0)}getFilter(layerId){return this.style.getFilter(layerId)}setPaintProperty(layerId,name,value,options={}){return this.style.setPaintProperty(layerId,name,value,options),this._update(!0)}getPaintProperty(layerId,name){return this.style.getPaintProperty(layerId,name)}setLayoutProperty(layerId,name,value,options={}){return this.style.setLayoutProperty(layerId,name,value,options),this._update(!0)}getLayoutProperty(layerId,name){return this.style.getLayoutProperty(layerId,name)}setGlyphs(glyphsUrl,options={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(glyphsUrl,options),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(id,url,options={}){return this._lazyInitEmptyStyle(),this.style.addSprite(id,url,options,(err=>{err||this._update(!0)})),this}removeSprite(id){return this._lazyInitEmptyStyle(),this.style.removeSprite(id),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(spriteUrl,options={}){return this._lazyInitEmptyStyle(),this.style.setSprite(spriteUrl,options,(err=>{err||this._update(!0)})),this}setLight(light,options={}){return this._lazyInitEmptyStyle(),this.style.setLight(light,options),this._update(!0)}getLight(){return this.style.getLight()}setFeatureState(feature,state){return this.style.setFeatureState(feature,state),this._update()}removeFeatureState(target,key){return this.style.removeFeatureState(target,key),this._update()}getFeatureState(feature){return this.style.getFeatureState(feature)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let width=0,height=0;return this._container&&(width=this._container.clientWidth||400,height=this._container.clientHeight||300),[width,height]}_setupContainer(){const container=this._container;container.classList.add("maplibregl-map");const canvasContainer=this._canvasContainer=DOM.create("div","maplibregl-canvas-container",container);this._interactive&&canvasContainer.classList.add("maplibregl-interactive"),this._canvas=DOM.create("canvas","maplibregl-canvas",canvasContainer),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region");const dimensions=this._containerDimensions(),clampedPixelRatio=this._getClampedPixelRatio(dimensions[0],dimensions[1]);this._resizeCanvas(dimensions[0],dimensions[1],clampedPixelRatio);const controlContainer=this._controlContainer=DOM.create("div","maplibregl-control-container",container),positions=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((positionName=>{positions[positionName]=DOM.create("div",`maplibregl-ctrl-${positionName} `,controlContainer)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(width,height,pixelRatio){this._canvas.width=Math.floor(pixelRatio*width),this._canvas.height=Math.floor(pixelRatio*height),this._canvas.style.width=`${width}px`,this._canvas.style.height=`${height}px`}_setupPainter(){const attributes={alpha:!0,stencil:!0,depth:!0,failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1};let webglcontextcreationerrorDetailObject=null;this._canvas.addEventListener("webglcontextcreationerror",(args=>{webglcontextcreationerrorDetailObject={requestedAttributes:attributes},args&&(webglcontextcreationerrorDetailObject.statusMessage=args.statusMessage,webglcontextcreationerrorDetailObject.type=args.type)}),{once:!0});const gl=this._canvas.getContext("webgl2",attributes)||this._canvas.getContext("webgl",attributes);if(!gl){const msg="Failed to initialize WebGL";throw webglcontextcreationerrorDetailObject?(webglcontextcreationerrorDetailObject.message=msg,new Error(JSON.stringify(webglcontextcreationerrorDetailObject))):new Error(msg)}this.painter=new Painter(gl,this.transform),webpSupported.testSupport(gl)}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(updateStyle){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||updateStyle,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(callback){return this._update(),this._renderTaskQueue.add(callback)}_cancelRenderFrame(id){this._renderTaskQueue.remove(id)}_render(paintStartTimeStamp){const fadeDuration=this._idleTriggered?this._fadeDuration:0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(paintStartTimeStamp),this._removed)return;let crossFading=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const zoom=this.transform.zoom,now=browser.now();this.style.zoomHistory.update(zoom,now);const parameters=new performance$1.EvaluationParameters(zoom,{now:now,fadeDuration:fadeDuration,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),factor=parameters.crossFadingFactor();1===factor&&factor===this._crossFadingFactor||(crossFading=!0,this._crossFadingFactor=factor),this.style.update(parameters)}this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom),this._elevationFreeze||(this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.minElevationForCurrentTile=0,this.transform.elevation=0),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,fadeDuration,this._crossSourceCollisions),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:fadeDuration,showPadding:this.showPadding}),this.fire(new performance$1.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,performance$1.PerformanceUtils.mark(performance$1.PerformanceMarkers.load),this.fire(new performance$1.Event("load"))),this.style&&(this.style.hasTransitions()||crossFading)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const somethingDirty=this._sourcesDirty||this._styleDirty||this._placementDirty;return somethingDirty||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new performance$1.Event("idle")),!this._loaded||this._fullyLoaded||somethingDirty||(this._fullyLoaded=!0,performance$1.PerformanceUtils.mark(performance$1.PerformanceMarkers.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var _a;this._hash&&this._hash.remove();for(const control of this._controls)control.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),"undefined"!=typeof window&&removeEventListener("online",this._onWindowOnline,!1),ImageRequest.removeThrottleControl(this._imageQueueHandle),null===(_a=this._resizeObserver)||void 0===_a||_a.disconnect();const extension=this.painter.context.gl.getExtension("WEBGL_lose_context");extension&&extension.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),DOM.remove(this._canvasContainer),DOM.remove(this._controlContainer),this._container.classList.remove("maplibregl-map"),performance$1.PerformanceUtils.clearMetrics(),this._removed=!0,this.fire(new performance$1.Event("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,browser.frameAsync(this._frameRequest).then((paintStartTimeStamp=>{performance$1.PerformanceUtils.frame(paintStartTimeStamp),this._frameRequest=null,this._render(paintStartTimeStamp)})).catch((()=>{})))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(value){this._showTileBoundaries!==value&&(this._showTileBoundaries=value,this._update())}get showPadding(){return!!this._showPadding}set showPadding(value){this._showPadding!==value&&(this._showPadding=value,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(value){this._showCollisionBoxes!==value&&(this._showCollisionBoxes=value,value?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(value){this._showOverdrawInspector!==value&&(this._showOverdrawInspector=value,this._update())}get repaint(){return!!this._repaint}set repaint(value){this._repaint!==value&&(this._repaint=value,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(value){this._vertices=value,this._update()}get version(){return version$1}getCameraTargetElevation(){return this.transform.elevation}},exports.MapMouseEvent=MapMouseEvent,exports.MapTouchEvent=MapTouchEvent,exports.MapWheelEvent=MapWheelEvent,exports.Marker=Marker,exports.NavigationControl=class{constructor(options){this._updateZoomButtons=()=>{const zoom=this._map.getZoom(),isMax=zoom===this._map.getMaxZoom(),isMin=zoom===this._map.getMinZoom();this._zoomInButton.disabled=isMax,this._zoomOutButton.disabled=isMin,this._zoomInButton.setAttribute("aria-disabled",isMax.toString()),this._zoomOutButton.setAttribute("aria-disabled",isMin.toString())},this._rotateCompassArrow=()=>{const rotate=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=rotate},this._setButtonTitle=(button,title)=>{const str=this._map._getUIString(`NavigationControl.${title}`);button.title=str,button.setAttribute("aria-label",str)},this.options=performance$1.extend({},defaultOptions$3,options),this._container=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",(e=>e.preventDefault())),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",(e=>this._map.zoomIn({},{originalEvent:e}))),DOM.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",(e=>this._map.zoomOut({},{originalEvent:e}))),DOM.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",(e=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:e}):this._map.resetNorth({},{originalEvent:e})})),this._compassIcon=DOM.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(map){return this._map=map,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new MouseRotateWrapper(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){DOM.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(className,fn){const a=DOM.create("button",className,this._container);return a.type="button",a.addEventListener("click",fn),a}},exports.Popup=Popup,exports.RasterDEMTileSource=RasterDEMTileSource,exports.RasterTileSource=RasterTileSource,exports.ScaleControl=class{constructor(options){this._onMove=()=>{updateScale(this._map,this._container,this.options)},this.setUnit=unit=>{this.options.unit=unit,updateScale(this._map,this._container,this.options)},this.options=performance$1.extend({},defaultOptions$1,options)}getDefaultPosition(){return"bottom-left"}onAdd(map){return this._map=map,this._container=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-scale",map.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){DOM.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},exports.ScrollZoomHandler=ScrollZoomHandler,exports.Style=Style,exports.TerrainControl=class{constructor(options){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=options}onAdd(map){return this._map=map,this._container=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=DOM.create("button","maplibregl-ctrl-terrain",this._container),DOM.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){DOM.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},exports.TwoFingersTouchPitchHandler=TwoFingersTouchPitchHandler,exports.TwoFingersTouchRotateHandler=TwoFingersTouchRotateHandler,exports.TwoFingersTouchZoomHandler=TwoFingersTouchZoomHandler,exports.TwoFingersTouchZoomRotateHandler=TwoFingersTouchZoomRotateHandler,exports.VectorTileSource=VectorTileSource,exports.VideoSource=VideoSource,exports.addSourceType=(name,SourceType)=>performance$1.__awaiter(void 0,void 0,void 0,(function*(){if(getSourceType(name))throw new Error(`A source type called "${name}" already exists.`);((name,type)=>{registeredSources[name]=type})(name,SourceType)})),exports.clearPrewarmedResources=function(){const pool=globalWorkerPool;pool&&(pool.isPreloaded()&&1===pool.numActive()?(pool.release(PRELOAD_POOL_ID),globalWorkerPool=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},exports.getMaxParallelImageRequests=function(){return performance$1.config.MAX_PARALLEL_IMAGE_REQUESTS},exports.getRTLTextPluginStatus=function(){return rtlMainThreadPluginFactory().getRTLTextPluginStatus()},exports.getVersion=function(){return version},exports.getWorkerCount=function(){return WorkerPool.workerCount},exports.getWorkerUrl=function(){return performance$1.config.WORKER_URL},exports.importScriptInWorkers=function(workerUrl){return getGlobalDispatcher().broadcast("importScript",workerUrl)},exports.prewarm=function(){getGlobalWorkerPool().acquire(PRELOAD_POOL_ID)},exports.setMaxParallelImageRequests=function(numRequests){performance$1.config.MAX_PARALLEL_IMAGE_REQUESTS=numRequests},exports.setRTLTextPlugin=function(pluginURL,lazy){return rtlMainThreadPluginFactory().setRTLTextPlugin(pluginURL,lazy)},exports.setWorkerCount=function(count){WorkerPool.workerCount=count},exports.setWorkerUrl=function(value){performance$1.config.WORKER_URL=value}})),maplibregl})),window.$=jQuery,
/*!
 * jQuery UI Tabs 1.13.2
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
function(factory){"function"==typeof define&&define.amd?define(["jquery","../keycode","../safe-active-element","../unique-id","../version","../widget"],factory):factory(jQuery)}((function($){var rhash;return $.widget("ui.tabs",{version:"1.13.2",delay:300,options:{active:null,classes:{"ui-tabs":"ui-corner-all","ui-tabs-nav":"ui-corner-all","ui-tabs-panel":"ui-corner-bottom","ui-tabs-tab":"ui-corner-top"},collapsible:!1,event:"click",heightStyle:"content",hide:null,show:null,activate:null,beforeActivate:null,beforeLoad:null,load:null},_isLocal:(rhash=/#.*$/,function(anchor){var anchorUrl,locationUrl;anchorUrl=anchor.href.replace(rhash,""),locationUrl=location.href.replace(rhash,"");try{anchorUrl=decodeURIComponent(anchorUrl)}catch(error){}try{locationUrl=decodeURIComponent(locationUrl)}catch(error){}return anchor.hash.length>1&&anchorUrl===locationUrl}),_create:function(){var that=this,options=this.options;this.running=!1,this._addClass("ui-tabs","ui-widget ui-widget-content"),this._toggleClass("ui-tabs-collapsible",null,options.collapsible),this._processTabs(),options.active=this._initialActive(),Array.isArray(options.disabled)&&(options.disabled=$.uniqueSort(options.disabled.concat($.map(this.tabs.filter(".ui-state-disabled"),(function(li){return that.tabs.index(li)})))).sort()),!1!==this.options.active&&this.anchors.length?this.active=this._findActive(options.active):this.active=$(),this._refresh(),this.active.length&&this.load(options.active)},_initialActive:function(){var active=this.options.active,collapsible=this.options.collapsible,locationHash=location.hash.substring(1);return null===active&&(locationHash&&this.tabs.each((function(i,tab){if($(tab).attr("aria-controls")===locationHash)return active=i,!1})),null===active&&(active=this.tabs.index(this.tabs.filter(".ui-tabs-active"))),null!==active&&-1!==active||(active=!!this.tabs.length&&0)),!1!==active&&-1===(active=this.tabs.index(this.tabs.eq(active)))&&(active=!collapsible&&0),!collapsible&&!1===active&&this.anchors.length&&(active=0),active},_getCreateEventData:function(){return{tab:this.active,panel:this.active.length?this._getPanelForTab(this.active):$()}},_tabKeydown:function(event){var focusedTab=$($.ui.safeActiveElement(this.document[0])).closest("li"),selectedIndex=this.tabs.index(focusedTab),goingForward=!0;if(!this._handlePageNav(event)){switch(event.keyCode){case $.ui.keyCode.RIGHT:case $.ui.keyCode.DOWN:selectedIndex++;break;case $.ui.keyCode.UP:case $.ui.keyCode.LEFT:goingForward=!1,selectedIndex--;break;case $.ui.keyCode.END:selectedIndex=this.anchors.length-1;break;case $.ui.keyCode.HOME:selectedIndex=0;break;case $.ui.keyCode.SPACE:return event.preventDefault(),clearTimeout(this.activating),void this._activate(selectedIndex);case $.ui.keyCode.ENTER:return event.preventDefault(),clearTimeout(this.activating),void this._activate(selectedIndex!==this.options.active&&selectedIndex);default:return}event.preventDefault(),clearTimeout(this.activating),selectedIndex=this._focusNextTab(selectedIndex,goingForward),event.ctrlKey||event.metaKey||(focusedTab.attr("aria-selected","false"),this.tabs.eq(selectedIndex).attr("aria-selected","true"),this.activating=this._delay((function(){this.option("active",selectedIndex)}),this.delay))}},_panelKeydown:function(event){this._handlePageNav(event)||event.ctrlKey&&event.keyCode===$.ui.keyCode.UP&&(event.preventDefault(),this.active.trigger("focus"))},_handlePageNav:function(event){return event.altKey&&event.keyCode===$.ui.keyCode.PAGE_UP?(this._activate(this._focusNextTab(this.options.active-1,!1)),!0):event.altKey&&event.keyCode===$.ui.keyCode.PAGE_DOWN?(this._activate(this._focusNextTab(this.options.active+1,!0)),!0):void 0},_findNextTab:function(index,goingForward){var lastTabIndex=this.tabs.length-1;for(;-1!==$.inArray((index>lastTabIndex&&(index=0),index<0&&(index=lastTabIndex),index),this.options.disabled);)index=goingForward?index+1:index-1;return index},_focusNextTab:function(index,goingForward){return index=this._findNextTab(index,goingForward),this.tabs.eq(index).trigger("focus"),index},_setOption:function(key,value){"active"!==key?(this._super(key,value),"collapsible"===key&&(this._toggleClass("ui-tabs-collapsible",null,value),value||!1!==this.options.active||this._activate(0)),"event"===key&&this._setupEvents(value),"heightStyle"===key&&this._setupHeightStyle(value)):this._activate(value)},_sanitizeSelector:function(hash){return hash?hash.replace(/[!"$%&'()*+,.\/:;<=>?@\[\]\^`{|}~]/g,"\\$&"):""},refresh:function(){var options=this.options,lis=this.tablist.children(":has(a[href])");options.disabled=$.map(lis.filter(".ui-state-disabled"),(function(tab){return lis.index(tab)})),this._processTabs(),!1!==options.active&&this.anchors.length?this.active.length&&!$.contains(this.tablist[0],this.active[0])?this.tabs.length===options.disabled.length?(options.active=!1,this.active=$()):this._activate(this._findNextTab(Math.max(0,options.active-1),!1)):options.active=this.tabs.index(this.active):(options.active=!1,this.active=$()),this._refresh()},_refresh:function(){this._setOptionDisabled(this.options.disabled),this._setupEvents(this.options.event),this._setupHeightStyle(this.options.heightStyle),this.tabs.not(this.active).attr({"aria-selected":"false","aria-expanded":"false",tabIndex:-1}),this.panels.not(this._getPanelForTab(this.active)).hide().attr({"aria-hidden":"true"}),this.active.length?(this.active.attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0}),this._addClass(this.active,"ui-tabs-active","ui-state-active"),this._getPanelForTab(this.active).show().attr({"aria-hidden":"false"})):this.tabs.eq(0).attr("tabIndex",0)},_processTabs:function(){var that=this,prevTabs=this.tabs,prevAnchors=this.anchors,prevPanels=this.panels;this.tablist=this._getList().attr("role","tablist"),this._addClass(this.tablist,"ui-tabs-nav","ui-helper-reset ui-helper-clearfix ui-widget-header"),this.tablist.on("mousedown"+this.eventNamespace,"> li",(function(event){$(this).is(".ui-state-disabled")&&event.preventDefault()})).on("focus"+this.eventNamespace,".ui-tabs-anchor",(function(){$(this).closest("li").is(".ui-state-disabled")&&this.blur()})),this.tabs=this.tablist.find("> li:has(a[href])").attr({role:"tab",tabIndex:-1}),this._addClass(this.tabs,"ui-tabs-tab","ui-state-default"),this.anchors=this.tabs.map((function(){return $("a",this)[0]})).attr({tabIndex:-1}),this._addClass(this.anchors,"ui-tabs-anchor"),this.panels=$(),this.anchors.each((function(i,anchor){var selector,panel,panelId,anchorId=$(anchor).uniqueId().attr("id"),tab=$(anchor).closest("li"),originalAriaControls=tab.attr("aria-controls");that._isLocal(anchor)?(panelId=(selector=anchor.hash).substring(1),panel=that.element.find(that._sanitizeSelector(selector))):(selector="#"+(panelId=tab.attr("aria-controls")||$({}).uniqueId()[0].id),(panel=that.element.find(selector)).length||(panel=that._createPanel(panelId)).insertAfter(that.panels[i-1]||that.tablist),panel.attr("aria-live","polite")),panel.length&&(that.panels=that.panels.add(panel)),originalAriaControls&&tab.data("ui-tabs-aria-controls",originalAriaControls),tab.attr({"aria-controls":panelId,"aria-labelledby":anchorId}),panel.attr("aria-labelledby",anchorId)})),this.panels.attr("role","tabpanel"),this._addClass(this.panels,"ui-tabs-panel","ui-widget-content"),prevTabs&&(this._off(prevTabs.not(this.tabs)),this._off(prevAnchors.not(this.anchors)),this._off(prevPanels.not(this.panels)))},_getList:function(){return this.tablist||this.element.find("ol, ul").eq(0)},_createPanel:function(id){return $("<div>").attr("id",id).data("ui-tabs-destroy",!0)},_setOptionDisabled:function(disabled){var currentItem,li,i;for(Array.isArray(disabled)&&(disabled.length?disabled.length===this.anchors.length&&(disabled=!0):disabled=!1),i=0;li=this.tabs[i];i++)currentItem=$(li),!0===disabled||-1!==$.inArray(i,disabled)?(currentItem.attr("aria-disabled","true"),this._addClass(currentItem,null,"ui-state-disabled")):(currentItem.removeAttr("aria-disabled"),this._removeClass(currentItem,null,"ui-state-disabled"));this.options.disabled=disabled,this._toggleClass(this.widget(),this.widgetFullName+"-disabled",null,!0===disabled)},_setupEvents:function(event){var events={};event&&$.each(event.split(" "),(function(index,eventName){events[eventName]="_eventHandler"})),this._off(this.anchors.add(this.tabs).add(this.panels)),this._on(!0,this.anchors,{click:function(event){event.preventDefault()}}),this._on(this.anchors,events),this._on(this.tabs,{keydown:"_tabKeydown"}),this._on(this.panels,{keydown:"_panelKeydown"}),this._focusable(this.tabs),this._hoverable(this.tabs)},_setupHeightStyle:function(heightStyle){var maxHeight,parent=this.element.parent();"fill"===heightStyle?(maxHeight=parent.height(),maxHeight-=this.element.outerHeight()-this.element.height(),this.element.siblings(":visible").each((function(){var elem=$(this),position=elem.css("position");"absolute"!==position&&"fixed"!==position&&(maxHeight-=elem.outerHeight(!0))})),this.element.children().not(this.panels).each((function(){maxHeight-=$(this).outerHeight(!0)})),this.panels.each((function(){$(this).height(Math.max(0,maxHeight-$(this).innerHeight()+$(this).height()))})).css("overflow","auto")):"auto"===heightStyle&&(maxHeight=0,this.panels.each((function(){maxHeight=Math.max(maxHeight,$(this).height("").height())})).height(maxHeight))},_eventHandler:function(event){var options=this.options,active=this.active,tab=$(event.currentTarget).closest("li"),clickedIsActive=tab[0]===active[0],collapsing=clickedIsActive&&options.collapsible,toShow=collapsing?$():this._getPanelForTab(tab),toHide=active.length?this._getPanelForTab(active):$(),eventData={oldTab:active,oldPanel:toHide,newTab:collapsing?$():tab,newPanel:toShow};event.preventDefault(),tab.hasClass("ui-state-disabled")||tab.hasClass("ui-tabs-loading")||this.running||clickedIsActive&&!options.collapsible||!1===this._trigger("beforeActivate",event,eventData)||(options.active=!collapsing&&this.tabs.index(tab),this.active=clickedIsActive?$():tab,this.xhr&&this.xhr.abort(),toHide.length||toShow.length||$.error("jQuery UI Tabs: Mismatching fragment identifier."),toShow.length&&this.load(this.tabs.index(tab),event),this._toggle(event,eventData))},_toggle:function(event,eventData){var that=this,toShow=eventData.newPanel,toHide=eventData.oldPanel;function complete(){that.running=!1,that._trigger("activate",event,eventData)}function show(){that._addClass(eventData.newTab.closest("li"),"ui-tabs-active","ui-state-active"),toShow.length&&that.options.show?that._show(toShow,that.options.show,complete):(toShow.css("display","block"),complete())}this.running=!0,toHide.length&&this.options.hide?this._hide(toHide,this.options.hide,(function(){that._removeClass(eventData.oldTab.closest("li"),"ui-tabs-active","ui-state-active"),show()})):(this._removeClass(eventData.oldTab.closest("li"),"ui-tabs-active","ui-state-active"),toHide.css("display","none"),show()),toHide.attr("aria-hidden","true"),eventData.oldTab.attr({"aria-selected":"false","aria-expanded":"false"}),toShow.length&&toHide.length?eventData.oldTab.attr("tabIndex",-1):toShow.length&&this.tabs.filter((function(){return 0===$(this).attr("tabIndex")})).attr("tabIndex",-1),toShow.attr("aria-hidden","false"),eventData.newTab.attr({"aria-selected":"true","aria-expanded":"true",tabIndex:0})},_activate:function(index){var anchor,active=this._findActive(index);active[0]!==this.active[0]&&(active.length||(active=this.active),anchor=active.find(".ui-tabs-anchor")[0],this._eventHandler({target:anchor,currentTarget:anchor,preventDefault:$.noop}))},_findActive:function(index){return!1===index?$():this.tabs.eq(index)},_getIndex:function(index){return"string"==typeof index&&(index=this.anchors.index(this.anchors.filter("[href$='"+$.escapeSelector(index)+"']"))),index},_destroy:function(){this.xhr&&this.xhr.abort(),this.tablist.removeAttr("role").off(this.eventNamespace),this.anchors.removeAttr("role tabIndex").removeUniqueId(),this.tabs.add(this.panels).each((function(){$.data(this,"ui-tabs-destroy")?$(this).remove():$(this).removeAttr("role tabIndex aria-live aria-busy aria-selected aria-labelledby aria-hidden aria-expanded")})),this.tabs.each((function(){var li=$(this),prev=li.data("ui-tabs-aria-controls");prev?li.attr("aria-controls",prev).removeData("ui-tabs-aria-controls"):li.removeAttr("aria-controls")})),this.panels.show(),"content"!==this.options.heightStyle&&this.panels.css("height","")},enable:function(index){var disabled=this.options.disabled;!1!==disabled&&(void 0===index?disabled=!1:(index=this._getIndex(index),disabled=Array.isArray(disabled)?$.map(disabled,(function(num){return num!==index?num:null})):$.map(this.tabs,(function(li,num){return num!==index?num:null}))),this._setOptionDisabled(disabled))},disable:function(index){var disabled=this.options.disabled;if(!0!==disabled){if(void 0===index)disabled=!0;else{if(index=this._getIndex(index),-1!==$.inArray(index,disabled))return;disabled=Array.isArray(disabled)?$.merge([index],disabled).sort():[index]}this._setOptionDisabled(disabled)}},load:function(index,event){index=this._getIndex(index);var that=this,tab=this.tabs.eq(index),anchor=tab.find(".ui-tabs-anchor"),panel=this._getPanelForTab(tab),eventData={tab:tab,panel:panel},complete=function(jqXHR,status){"abort"===status&&that.panels.stop(!1,!0),that._removeClass(tab,"ui-tabs-loading"),panel.removeAttr("aria-busy"),jqXHR===that.xhr&&delete that.xhr};this._isLocal(anchor[0])||(this.xhr=$.ajax(this._ajaxSettings(anchor,event,eventData)),this.xhr&&"canceled"!==this.xhr.statusText&&(this._addClass(tab,"ui-tabs-loading"),panel.attr("aria-busy","true"),this.xhr.done((function(response,status,jqXHR){setTimeout((function(){panel.html(response),that._trigger("load",event,eventData),complete(jqXHR,status)}),1)})).fail((function(jqXHR,status){setTimeout((function(){complete(jqXHR,status)}),1)}))))},_ajaxSettings:function(anchor,event,eventData){var that=this;return{url:anchor.attr("href").replace(/#.*$/,""),beforeSend:function(jqXHR,settings){return that._trigger("beforeLoad",event,$.extend({jqXHR:jqXHR,ajaxSettings:settings},eventData))}}},_getPanelForTab:function(tab){var id=$(tab).attr("aria-controls");return this.element.find(this._sanitizeSelector("#"+id))}}),!1!==$.uiBackCompat&&$.widget("ui.tabs",$.ui.tabs,{_processTabs:function(){this._superApply(arguments),this._addClass(this.tabs,"ui-tab")}}),$.ui.tabs}));/*! lz4.js v0.3.3 Released under the MIT license. https://github.com/ukyo/lz4.js/LICENSE */var lz4={};(function(){var c;c||(c=eval("(function() { try { return Module || {} } catch(e) { return {} } })()"));var l={},n;for(n in c)c.hasOwnProperty(n)&&(l[n]=c[n]);var q="object"==typeof window,v="function"==typeof importScripts,w="object"==typeof process&&"function"==typeof require&&!q&&!v,aa=!q&&!w&&!v;if(w){c.print||(c.print=function(a){process.stdout.write(a+"\n")}),c.printErr||(c.printErr=function(a){process.stderr.write(a+"\n")});var ba=require("fs"),ca=require("path");c.read=function(a,b){a=ca.normalize(a);var d=ba.readFileSync(a);return d||a==ca.resolve(a)||(a=path.join(__dirname,"..","src",a),d=ba.readFileSync(a)),d&&!b&&(d=d.toString()),d},c.readBinary=function(a){return(a=c.read(a,!0)).buffer||(a=new Uint8Array(a)),assert(a.buffer),a},c.load=function(a){da(read(a))},c.thisProgram||(c.thisProgram=1<process.argv.length?process.argv[1].replace(/\\/g,"/"):"unknown-program"),c.arguments=process.argv.slice(2),"undefined"!=typeof module&&(module.exports=c),process.on("uncaughtException",(function(a){if(!(a instanceof x))throw a})),c.inspect=function(){return"[Emscripten Module object]"}}else if(aa)c.print||(c.print=print),"undefined"!=typeof printErr&&(c.printErr=printErr),c.read="undefined"!=typeof read?read:function(){throw"no read() available (jsc?)"},c.readBinary=function(a){return"function"==typeof readbuffer?new Uint8Array(readbuffer(a)):(assert("object"==typeof(a=read(a,"binary"))),a)},"undefined"!=typeof scriptArgs?c.arguments=scriptArgs:void 0!==arguments&&(c.arguments=arguments),eval("if (typeof gc === 'function' && gc.toString().indexOf('[native code]') > 0) var gc = undefined");else{if(!q&&!v)throw"Unknown runtime environment. Where are we?";c.read=function(a){var b=new XMLHttpRequest;return b.open("GET",a,!1),b.send(null),b.responseText},void 0!==arguments&&(c.arguments=arguments),"undefined"!=typeof console?(c.print||(c.print=function(a){console.log(a)}),c.printErr||(c.printErr=function(a){console.log(a)})):c.print||(c.print=function(){}),v&&(c.load=importScripts),void 0===c.setWindowTitle&&(c.setWindowTitle=function(a){document.title=a})}function da(a){eval.call(null,a)}for(n in!c.load&&c.read&&(c.load=function(a){da(c.read(a))}),c.print||(c.print=function(){}),c.printErr||(c.printErr=c.print),c.arguments||(c.arguments=[]),c.thisProgram||(c.thisProgram="./this.program"),c.print=c.print,c.K=c.printErr,c.preRun=[],c.postRun=[],l)l.hasOwnProperty(n)&&(c[n]=l[n]);var z={ja:function(a){ea=a},ha:function(){return ea},T:function(){return y},S:function(a){y=a},Q:function(a){switch(a){case"i1":case"i8":return 1;case"i16":return 2;case"i32":case"float":return 4;case"i64":case"double":return 8;default:return"*"===a[a.length-1]?z.F:"i"===a[0]?(assert(0==(a=parseInt(a.substr(1)))%8),a/8):0}},ga:function(a){return Math.max(z.Q(a),z.F)},la:16,xa:function(a,b){return"double"===b||"i64"===b?7&a&&(assert(4==(7&a)),a+=4):assert(0==(3&a)),a},ra:function(a,b,d){return d||"i64"!=a&&"double"!=a?a?Math.min(b||(a?z.ga(a):0),z.F):Math.min(b,8):8},I:function(a,b,d){return d&&d.length?(d.splice||(d=Array.prototype.slice.call(d)),d.splice(0,0,b),c["dynCall_"+a].apply(null,d)):c["dynCall_"+a].call(null,b)},C:[],V:function(a){for(var b=0;b<z.C.length;b++)if(!z.C[b])return z.C[b]=a,2*(1+b);throw"Finished up all reserved function pointers. Use a higher value for RESERVED_FUNCTION_POINTERS."},ia:function(a){z.C[(a-2)/2]=null},r:function(a){z.r.L||(z.r.L={}),z.r.L[a]||(z.r.L[a]=1,c.K(a))},J:{},ta:function(a,b){assert(b),z.J[b]||(z.J[b]={});var d=z.J[b];return d[a]||(d[a]=function(){return z.I(b,a,arguments)}),d[a]},sa:function(){throw"You must build with -s RETAIN_COMPILER_SETTINGS=1 for Runtime.getCompilerSetting or emscripten_get_compiler_setting to work"},D:function(a){var b=y;return y=(y=y+a|0)+15&-16,b},ka:function(a){var b=A;return A=(A=A+a|0)+15&-16,b},B:function(a){var b=C;return(a=(C=(C=C+a|0)+15&-16)>=D)&&(E("Cannot enlarge memory arrays. Either (1) compile with  -s TOTAL_MEMORY=X  with X higher than the current value "+D+", (2) compile with  -s ALLOW_MEMORY_GROWTH=1  which adjusts the size at runtime but prevents some optimizations, (3) set Module.TOTAL_MEMORY to a higher value before the program runs, or if you want malloc to return NULL (0) instead of this abort, compile with  -s ABORTING_MALLOC=0 "),a=!0),a?(C=b,0):b},G:function(a,b){return Math.ceil(a/(b||16))*(b||16)},wa:function(a,b,d){return d?+(a>>>0)+4294967296*+(b>>>0):+(a>>>0)+4294967296*+(0|b)},U:8,F:4,ma:0};z.addFunction=z.V,z.removeFunction=z.ia;var F=!1,G,H,ea,buffer;function assert(a,b){a||E("Assertion failed: "+b)}function ga(a){var b;switch("*"===(b="i32").charAt(b.length-1)&&(b="i32"),b){case"i1":case"i8":return I[a>>0];case"i16":return J[a>>1];case"i32":case"i64":return K[a>>2];case"float":return L[a>>2];case"double":return M[a>>3];default:E("invalid type for setValue: "+b)}return null}function N(a,b,d,e){var g,k;"number"==typeof a?(g=!0,k=a):(g=!1,k=a.length);var f,u,h="string"==typeof b?b:null;if(d=4==d?e:[O,z.D,z.ka,z.B][void 0===d?2:d](Math.max(k,h?1:b.length)),g){for(e=d,assert(0==(3&d)),a=d+(-4&k);e<a;e+=4)K[e>>2]=0;for(a=d+k;e<a;)I[e++>>0]=0;return d}if("i8"===h)return a.subarray||a.slice?P.set(a,d):P.set(new Uint8Array(a),d),d;for(e=0;e<k;){var m=a[e];if("function"==typeof m&&(m=z.ua(m)),0===(g=h||b[e]))e++;else{"i64"==g&&(g="i32");var t,p=d+e;switch("*"===(t=(t=g)||"i8").charAt(t.length-1)&&(t="i32"),t){case"i1":case"i8":I[p>>0]=m;break;case"i16":J[p>>1]=m;break;case"i32":K[p>>2]=m;break;case"i64":H=[m>>>0,(G=m,1<=+ha(G)?0<G?(0|ja(+ka(G/4294967296),4294967295))>>>0:~~+la((G-+(~~G>>>0))/4294967296)>>>0:0)],K[p>>2]=H[0],K[p+4>>2]=H[1];break;case"float":L[p>>2]=m;break;case"double":M[p>>3]=m;break;default:E("invalid type for setValue: "+t)}u!==g&&(f=z.Q(g),u=g),e+=f}}return d}function ma(a){var b;if(0===b||!a)return"";for(var e,d=0,g=0;(d|=e=P[a+g>>0],0!=e||b)&&(g++,!b||g!=b););if(b||(b=g),e="",128>d){for(;0<b;)d=String.fromCharCode.apply(String,P.subarray(a,a+Math.min(b,1024))),e=e?e+d:d,a+=1024,b-=1024;return e}return c.UTF8ToString(a)}function na(a){var d=!!c.___cxa_demangle;if(d)try{var e=O(a.length);fa(a.substr(1),e);var g=O(4),k=c.___cxa_demangle(e,0,0,g);if(0===ga(g)&&k)return ma(k)}catch(h){}finally{e&&Q(e),g&&Q(g),k&&Q(k)}var f=3,u={v:"void",b:"bool",c:"char",s:"short",i:"int",l:"long",f:"float",d:"double",w:"wchar_t",a:"signed char",h:"unsigned char",t:"unsigned short",j:"unsigned int",m:"unsigned long",x:"long long",y:"unsigned long long",z:"..."},m=[],p=!0;e=a;try{if("Object._main"==a||"_main"==a)return"main()";if("number"==typeof a&&(a=ma(a)),"_"!==a[0]||"_"!==a[1]||"Z"!==a[2])return a;switch(a[3]){case"n":return"operator new()";case"d":return"operator delete()"}e=function b(d,e,g){e=e||1/0;var h,t="",k=[];if("N"===a[f]){for(f++,"K"===a[f]&&f++,h=[];"E"!==a[f];)if("S"===a[f]){f++;var r=a.indexOf("_",f);h.push(m[a.substring(f,r)||0]||"?"),f=r+1}else if("C"===a[f])h.push(h[h.length-1]),f+=2;else{var B=(r=parseInt(a.substr(f))).toString().length;if(!r||!B){f--;break}var ia=a.substr(f+B,r);h.push(ia),m.push(ia),f+=B+r}if(f++,h=h.join("::"),0==--e)return d?[h]:h}else("K"===a[f]||p&&"L"===a[f])&&f++,(r=parseInt(a.substr(f)))&&(B=r.toString().length,h=a.substr(f+B,r),f+=B+r);p=!1,"I"===a[f]?(f++,r=b(!0),t+=(B=b(!0,1,!0))[0]+" "+h+"<"+r.join(", ")+">"):t=h;a:for(;f<a.length&&0<e--;)if(h=a[f++],h in u)k.push(u[h]);else switch(h){case"P":k.push(b(!0,1,!0)[0]+"*");break;case"R":k.push(b(!0,1,!0)[0]+"&");break;case"L":f++,r=a.indexOf("E",f)-f,k.push(a.substr(f,r)),f+=r+2;break;case"A":if(r=parseInt(a.substr(f)),f+=r.toString().length,"_"!==a[f])throw"?";f++,k.push(b(!0,1,!0)[0]+" ["+r+"]");break;case"E":break a;default:t+="?"+h;break a}return g||1!==k.length||"void"!==k[0]||(k=[]),d?(t&&k.push(t+"?"),k):t+"("+k.join(", ")+")"}()}catch(t){e+="?"}return 0<=e.indexOf("?")&&!d&&z.r("warning: a problem occurred in builtin C++ name demangling; build with  -s DEMANGLE_SUPPORT=1  to link in libcxxabi demangling"),e}function oa(){return pa().replace(/__Z[\w\d_]+/g,(function(a){var b=na(a);return a===b?a:a+" ["+b+"]"}))}function pa(){var a=Error();if(!a.stack){try{throw Error(0)}catch(b){a=b}if(!a.stack)return"(no stack trace available)"}return a.stack.toString()}function qa(){var a=C;return 0<a%4096&&(a+=4096-a%4096),a}!function(){var d,a={stackSave:function(){z.T()},stackRestore:function(){z.S()},arrayToC:function(a){for(var b=z.D(a.length),d=b,h=0;h<a.length;h++)I[d++>>0]=a[h];return b},stringToC:function(a){var b=0;return null!=a&&0!==a&&fa(a,b=z.D(1+(a.length<<2))),b}},b=/^function\s*\(([^)]*)\)\s*{\s*([^*]*?)[\s;]*(?:return\s*(.*?)[;\s]*)?}$/;for(d in a)a.hasOwnProperty(d)&&a[d].toString().match(b).slice(1)}();for(var I,P,J,ra,K,sa,L,M,ta=0,A=0,ua=0,y=0,R=0,va=0,C=0,wa=c.TOTAL_STACK||5242880,D=c.TOTAL_MEMORY||33554432,S=65536;S<D||S<2*wa;)S=16777216>S?2*S:S+16777216;function T(a){for(;0<a.length;){var b=a.shift();if("function"==typeof b)b();else{var d=b.qa;"number"==typeof d?void 0===b.H?z.I("v",d):z.I("vi",d,[b.H]):d(void 0===b.H?null:b.H)}}}S!==D&&(D=S),assert("undefined"!=typeof Int32Array&&"undefined"!=typeof Float64Array&&!!new Int32Array(1).subarray&&!!new Int32Array(1).set,"JS engine does not provide full typed array support"),buffer=new ArrayBuffer(D),I=new Int8Array(buffer),J=new Int16Array(buffer),K=new Int32Array(buffer),P=new Uint8Array(buffer),ra=new Uint16Array(buffer),sa=new Uint32Array(buffer),L=new Float32Array(buffer),M=new Float64Array(buffer),K[0]=255,assert(255===P[0]&&0===P[3],"Typed arrays 2 must be run on a little-endian system"),c.HEAP=void 0,c.buffer=buffer,c.HEAP8=I,c.HEAP16=J,c.HEAP32=K,c.HEAPU8=P,c.HEAPU16=ra,c.HEAPU32=sa,c.HEAPF32=L,c.HEAPF64=M;var U=[],V=[],xa=[],ya=[],za=[],W=!1;function Aa(){var a=c.preRun.shift();U.unshift(a)}function Ba(a,b){for(var d=0,e=0;e<a.length;++e){55296<=(g=a.charCodeAt(e))&&57343>=g&&(g=65536+((1023&g)<<10)|1023&a.charCodeAt(++e)),127>=g?++d:d=2047>=g?d+2:65535>=g?d+3:2097151>=g?d+4:67108863>=g?d+5:d+6}e=0;if(0<(k=(d=Array(d+1)).length)){for(var g=e,k=e+k-1,h=0;h<a.length;++h){var f=a.charCodeAt(h);if(55296<=f&&57343>=f&&(f=65536+((1023&f)<<10)|1023&a.charCodeAt(++h)),127>=f){if(e>=k)break;d[e++]=f}else{if(2047>=f){if(e+1>=k)break;d[e++]=192|f>>6}else{if(65535>=f){if(e+2>=k)break;d[e++]=224|f>>12}else{if(2097151>=f){if(e+3>=k)break;d[e++]=240|f>>18}else{if(67108863>=f){if(e+4>=k)break;d[e++]=248|f>>24}else{if(e+5>=k)break;d[e++]=252|f>>30,d[e++]=128|f>>24&63}d[e++]=128|f>>18&63}d[e++]=128|f>>12&63}d[e++]=128|f>>6&63}d[e++]=128|63&f}}d[e]=0,e-=g}else e=0;return b&&(d.length=e),d}function fa(a,b){for(var d=Ba(a,void 0),e=0;e<d.length;)I[b+e>>0]=d[e],e+=1}Math.imul&&-5===Math.imul(4294967295,5)||(Math.imul=function(a,b){var d=65535&a,e=65535&b;return d*e+((a>>>16)*e+d*(b>>>16)<<16)|0}),Math.va=Math.imul,Math.clz32||(Math.clz32=function(a){a>>>=0;for(var b=0;32>b;b++)if(a&1<<31-b)return b;return 32}),Math.oa=Math.clz32;var ha=Math.abs,la=Math.ceil,ka=Math.floor,ja=Math.min;c.preloadedImages={},c.preloadedAudios={};var Ca=[function(a,b){a:for(var g,k,h,f,u,d=b,e=P,p="";g=e[d++];)128&g?(k=63&e[d++],192==(224&g)?p+=String.fromCharCode((31&g)<<6|k):(h=63&e[d++],224==(240&g)?g=(15&g)<<12|k<<6|h:(f=63&e[d++],240==(248&g)?g=(7&g)<<18|k<<12|h<<6|f:(u=63&e[d++],248==(252&g)?g=(3&g)<<24|k<<18|h<<12|f<<6|u:g=(1&g)<<30|k<<24|h<<18|f<<12|u<<6|63&e[d++])),65536>g?p+=String.fromCharCode(g):(g-=65536,p+=String.fromCharCode(55296|g>>10,56320|1023&g)))):p+=String.fromCharCode(g);X[a].n=Error(p)},function(a,b,d){X[a].A(b,d)},function(a,b,d){return X[a].u(b,d)}],ta=8,A=ta+1296;V.push(),N([0,32,0,0,0,0,0,0,0,0,0,0,36,3,0,0,47,3,0,0,61,3,0,0,88,3,0,0,112,3,0,0,146,3,0,0,177,3,0,0,203,3,0,0,235,3,0,0,2,4,0,0,26,4,0,0,49,4,0,0,75,4,0,0,104,4,0,0,128,4,0,0,150,4,0,0,169,4,0,0,195,4,0,0,224,4,0,0,254,4,0,0,0,0,1,0,0,0,4,0,0,0,16,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,1,0,0,0,2,0,0,0,3,0,0,0,4,0,0,0,1,0,0,0,2,0,0,0,1,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,123,114,101,116,117,114,110,32,76,90,52,74,83,95,114,101,97,100,40,36,48,44,32,36,49,44,32,36,50,41,125,0,123,76,90,52,74,83,95,119,114,105,116,101,40,36,48,44,32,36,49,44,32,36,50,41,125,0,123,76,90,52,74,83,95,101,114,114,111,114,40,36,48,44,32,36,49,41,125,0,79,75,95,78,111,69,114,114,111,114,0,69,82,82,79,82,95,71,69,78,69,82,73,67,0,69,82,82,79,82,95,109,97,120,66,108,111,99,107,83,105,122,101,95,105,110,118,97,108,105,100,0,69,82,82,79,82,95,98,108,111,99,107,77,111,100,101,95,105,110,118,97,108,105,100,0,69,82,82,79,82,95,99,111,110,116,101,110,116,67,104,101,99,107,115,117,109,70,108,97,103,95,105,110,118,97,108,105,100,0,69,82,82,79,82,95,99,111,109,112,114,101,115,115,105,111,110,76,101,118,101,108,95,105,110,118,97,108,105,100,0,69,82,82,79,82,95,104,101,97,100,101,114,86,101,114,115,105,111,110,95,119,114,111,110,103,0,69,82,82,79,82,95,98,108,111,99,107,67,104,101,99,107,115,117,109,95,117,110,115,117,112,112,111,114,116,101,100,0,69,82,82,79,82,95,114,101,115,101,114,118,101,100,70,108,97,103,95,115,101,116,0,69,82,82,79,82,95,97,108,108,111,99,97,116,105,111,110,95,102,97,105,108,101,100,0,69,82,82,79,82,95,115,114,99,83,105,122,101,95,116,111,111,76,97,114,103,101,0,69,82,82,79,82,95,100,115,116,77,97,120,83,105,122,101,95,116,111,111,83,109,97,108,108,0,69,82,82,79,82,95,102,114,97,109,101,72,101,97,100,101,114,95,105,110,99,111,109,112,108,101,116,101,0,69,82,82,79,82,95,102,114,97,109,101,84,121,112,101,95,117,110,107,110,111,119,110,0,69,82,82,79,82,95,102,114,97,109,101,83,105,122,101,95,119,114,111,110,103,0,69,82,82,79,82,95,115,114,99,80,116,114,95,119,114,111,110,103,0,69,82,82,79,82,95,100,101,99,111,109,112,114,101,115,115,105,111,110,70,97,105,108,101,100,0,69,82,82,79,82,95,104,101,97,100,101,114,67,104,101,99,107,115,117,109,95,105,110,118,97,108,105,100,0,69,82,82,79,82,95,99,111,110,116,101,110,116,67,104,101,99,107,115,117,109,95,105,110,118,97,108,105,100,0,69,82,82,79,82,95,109,97,120,67,111,100,101,0],"i8",4,z.U);var Da=z.G(N(12,"i8",2),8);function Ka(a){return c.___errno_location&&(K[c.___errno_location()>>2]=a),a}function Y(a){Y.fa||(C=qa(),Y.fa=!0,assert(z.B),Y.ea=z.B,z.B=function(){E("cannot dynamically allocate, sbrk now has control")});var b=C;return 0==a||Y.ea(a)?b:4294967295}assert(0==Da%8),c._i64Subtract=Ea,c._i64Add=Fa,c._memset=Ga,c._bitshift64Lshr=Ha,c._bitshift64Shl=Ia,c._memcpy=Ja,c._memmove=La;var Ma=N([8,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,6,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,7,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,6,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,5,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0,4,0,1,0,2,0,1,0,3,0,1,0,2,0,1,0],"i8",2);c._llvm_cttz_i32=Na,ua=y=z.G(A),R=ua+wa,va=C=z.G(R),assert(va<D,"TOTAL_MEMORY not big enough for stack"),c.W={Math:Math,Int8Array:Int8Array,Int16Array:Int16Array,Int32Array:Int32Array,Uint8Array:Uint8Array,Uint16Array:Uint16Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array,NaN:NaN,Infinity:1/0},c.X={abort:E,assert:assert,invoke_iiiiiii:function(a,b,d,e,g,k,h){try{return c.dynCall_iiiiiii(a,b,d,e,g,k,h)}catch(f){if("number"!=typeof f&&"longjmp"!==f)throw f;Z.setThrew(1,0)}},_sysconf:function(a){switch(a){case 30:return 4096;case 85:return S/4096;case 132:case 133:case 12:case 137:case 138:case 15:case 235:case 16:case 17:case 18:case 19:case 20:case 149:case 13:case 10:case 236:case 153:case 9:case 21:case 22:case 159:case 154:case 14:case 77:case 78:case 139:case 80:case 81:case 82:case 68:case 67:case 164:case 11:case 29:case 47:case 48:case 95:case 52:case 51:case 46:return 200809;case 79:return 0;case 27:case 246:case 127:case 128:case 23:case 24:case 160:case 161:case 181:case 182:case 242:case 183:case 184:case 243:case 244:case 245:case 165:case 178:case 179:case 49:case 50:case 168:case 169:case 175:case 170:case 171:case 172:case 97:case 76:case 32:case 173:case 35:return-1;case 176:case 177:case 7:case 155:case 8:case 157:case 125:case 126:case 92:case 93:case 129:case 130:case 131:case 94:case 91:return 1;case 74:case 60:case 69:case 70:case 4:return 1024;case 31:case 42:case 72:return 32;case 87:case 26:case 33:return 2147483647;case 34:case 1:return 47839;case 38:case 36:return 99;case 43:case 37:return 2048;case 0:return 2097152;case 3:return 65536;case 28:return 32768;case 44:return 32767;case 75:return 16384;case 39:return 1e3;case 89:return 700;case 71:return 256;case 40:return 255;case 2:return 100;case 180:return 64;case 25:return 20;case 5:return 16;case 6:return 6;case 73:return 4;case 84:return"object"==typeof navigator&&navigator.hardwareConcurrency||1}return Ka(22),-1},_pthread_self:function(){return 0},_abort:function(){c.abort()},___setErrNo:Ka,_sbrk:Y,_time:function(a){var b=Date.now()/1e3|0;return a&&(K[a>>2]=b),b},_emscripten_memcpy_big:function(a,b,d){return P.set(P.subarray(b,b+d),a),a},_emscripten_asm_const_3:function(a,b,d,e){return Ca[a](b,d,e)},_emscripten_asm_const_2:function(a,b,d){return Ca[a](b,d)},STACKTOP:y,STACK_MAX:R,tempDoublePtr:Da,ABORT:F,cttz_i8:Ma};var Z=function(global,env,buffer){"use asm";var a=new global.Int8Array(buffer);var b=new global.Int16Array(buffer);var c=new global.Int32Array(buffer);var d=new global.Uint8Array(buffer);var e=new global.Uint16Array(buffer);var f=new global.Uint32Array(buffer);var g=new global.Float32Array(buffer);var h=new global.Float64Array(buffer);var i=env.STACKTOP|0;var j=env.STACK_MAX|0;var k=env.tempDoublePtr|0;var l=env.ABORT|0;var m=env.cttz_i8|0;var n=0;var o=0;var p=0;var q=0;var r=global.NaN,s=global.Infinity;var t=0,u=0,v=0,w=0,x=0.0,y=0,z=0,A=0,B=0.0;var C=0;var D=0;var E=0;var F=0;var G=0;var H=0;var I=0;var J=0;var K=0;var L=0;var M=global.Math.floor;var N=global.Math.abs;var O=global.Math.sqrt;var P=global.Math.pow;var Q=global.Math.cos;var R=global.Math.sin;var S=global.Math.tan;var T=global.Math.acos;var U=global.Math.asin;var V=global.Math.atan;var W=global.Math.atan2;var X=global.Math.exp;var Y=global.Math.log;var Z=global.Math.ceil;var _=global.Math.imul;var $=global.Math.min;var aa=global.Math.clz32;var ba=env.abort;var ca=env.assert;var da=env.invoke_iiiiiii;var ea=env._sysconf;var fa=env._pthread_self;var ga=env._abort;var ha=env.___setErrNo;var ia=env._sbrk;var ja=env._time;var ka=env._emscripten_memcpy_big;var la=env._emscripten_asm_const_3;var ma=env._emscripten_asm_const_2;var na=0.0;function pa(a){a=a|0;var b=0;b=i;i=i+a|0;i=i+15&-16;return b|0}function qa(){return i|0}function ra(a){a=a|0;i=a}function sa(a,b){a=a|0;b=b|0;i=a;j=b}function ta(a,b){a=a|0;b=b|0;if(!n){n=a;o=b}}function ua(b){b=b|0;a[k>>0]=a[b>>0];a[k+1>>0]=a[b+1>>0];a[k+2>>0]=a[b+2>>0];a[k+3>>0]=a[b+3>>0]}function va(b){b=b|0;a[k>>0]=a[b>>0];a[k+1>>0]=a[b+1>>0];a[k+2>>0]=a[b+2>>0];a[k+3>>0]=a[b+3>>0];a[k+4>>0]=a[b+4>>0];a[k+5>>0]=a[b+5>>0];a[k+6>>0]=a[b+6>>0];a[k+7>>0]=a[b+7>>0]}function wa(a){a=a|0;C=a}function xa(){return C|0}function ya(){c[3]=_a(8192)|0;c[4]=_a(8192)|0;return}function za(a,b,d,e){a=a|0;b=b|0;d=d|0;e=e|0;var f=0,g=0;g=_a(64)|0;f=_a(152)|0;if(!f){$a(g);g=0;return g|0}if(c[f+-4>>2]&3)db(f|0,0,152)|0;c[f+56>>2]=100;c[f+60>>2]=0;c[g+4>>2]=f;f=g+8|0;c[f>>2]=a;c[g+12>>2]=b;c[g+16>>2]=d;d=g+20|0;c[d>>2]=0;c[d+4>>2]=0;c[d+8>>2]=0;c[d+12>>2]=0;c[d+16>>2]=0;c[g+40>>2]=e;d=g+44|0;c[d>>2]=0;c[d+4>>2]=0;c[d+8>>2]=0;c[d+12>>2]=0;c[d+16>>2]=0;f=Ha(8192,f)|0;if(f>>>0<=(c[2]|0)>>>0)return g|0;$a(c[4]|0);c[2]=f;c[4]=_a(f)|0;return g|0}function Aa(a){a=a|0;var b=0;b=c[a+4>>2]|0;if(!b){$a(a);return}$a(c[b+144>>2]|0);$a(c[b+72>>2]|0);$a(b);$a(a);return}function Ba(b){b=b|0;var d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0;k=c[b+4>>2]|0;l=c[4]|0;d=b+8|0;do{if((c[2]|0)>>>0>=15){m=k+60|0;if(!(c[m>>2]|0)){f=k;e=f+56|0;do{c[f>>2]=c[d>>2];f=f+4|0;d=d+4|0}while((f|0)<(e|0));j=k+32|0;d=(c[j>>2]|0)<3?1:2;e=k+148|0;if((c[e>>2]|0)>>>0<d>>>0){f=k+144|0;$a(c[f>>2]|0);if((c[j>>2]|0)<3){g=_a(16416)|0;if((g|0)!=0?(c[g+-4>>2]&3|0)!=0:0)db(g|0,0,16416)|0;db(g|0,0,16416)|0;c[f>>2]=g}else c[f>>2]=_a(262192)|0;c[e>>2]=d}d=c[k>>2]|0;if(d){d=d+-4|0;if(d>>>0>3)d=-2;else h=14}else{c[k>>2]=4;d=0;h=14}if((h|0)==14)d=c[100+(d<<2)>>2]|0;c[k+64>>2]=d;i=k+4|0;f=(c[i>>2]|0)==0&1;f=(c[b+44>>2]|0)==0?d+(f<<17)|0:f<<16;d=k+68|0;if((c[d>>2]|0)>>>0<f>>>0){c[d>>2]=f;e=k+72|0;$a(c[e>>2]|0);d=_a(f)|0;if(!d){c[e>>2]=d;d=-9;break}if(c[d+-4>>2]&3)db(d|0,0,f|0)|0;c[e>>2]=d}else d=c[k+72>>2]|0;c[k+76>>2]=d;c[k+80>>2]=0;d=k+96|0;c[k+104>>2]=0;c[d+12>>2]=606290984;c[k+112>>2]=-2048144777;c[d+20>>2]=0;c[k+120>>2]=1640531535;e=d;c[e>>2]=0;c[e+4>>2]=0;c[d+44>>2]=0;d=c[j>>2]|0;e=k+144|0;if((d|0)<3)db(c[e>>2]|0,0,16416)|0;else{j=c[e>>2]|0;c[j+262148>>2]=0;c[j+262172>>2]=d}g=l;a[g>>0]=4;a[g+1>>0]=34;a[g+2>>0]=77;a[g+3>>0]=24;h=g+4|0;f=k+16|0;d=f;a[h>>0]=c[i>>2]<<5&32|c[k+8>>2]<<2&4|(((c[d>>2]|0)!=0|(c[d+4>>2]|0)!=0)&1)<<3|64;d=g+6|0;a[g+5>>0]=c[k>>2]<<4&112;e=c[f>>2]|0;f=c[f+4>>2]|0;if((e|0)==0&(f|0)==0)e=7;else{a[d>>0]=e;d=eb(e|0,f|0,8)|0;a[g+7>>0]=d;d=eb(e|0,f|0,16)|0;a[g+8>>0]=d;d=eb(e|0,f|0,24)|0;a[g+9>>0]=d;a[g+10>>0]=f;d=eb(e|0,f|0,40)|0;a[g+11>>0]=d;d=eb(e|0,f|0,48)|0;a[g+12>>0]=d;e=eb(e|0,f|0,56)|0;a[g+13>>0]=e;e=k+88|0;c[e>>2]=0;c[e+4>>2]=0;e=15;d=g+14|0}a[d>>0]=Ia(h,d-h|0)|0;c[m>>2]=1;d=g+e-l|0;if(d>>>0<=4294967277){la(1,b|0,c[4]|0,d|0)|0;b=1;return b|0}}else d=-1}else d=-11}while(0);ma(0,b|0,c[20+(0-d<<2)>>2]|0)|0;b=0;return b|0}function Ca(a){a=a|0;var b=0,d=0,e=0,f=0,g=0,h=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0;y=i;i=i+16|0;p=y;s=c[a+4>>2]|0;t=c[4]|0;b=c[2]|0;u=c[3]|0;v=la(2,a|0,u|0,8192)|0;d=u;q=c[s+64>>2]|0;w=u+v|0;m=w;a:do{if((c[s+60>>2]|0)==1)if(b>>>0>=(Ha(v,s)|0)>>>0){c[p>>2]=0;n=s+4|0;l=s+32|0;g=(c[n>>2]|0)==1;g=(c[l>>2]|0)<3?g?1:2:g?3:4;r=s+80|0;b=c[r>>2]|0;do{if(!b){b=t;f=0}else{e=q-b|0;d=s+76|0;b=(c[d>>2]|0)+b|0;if(e>>>0>v>>>0){gb(b|0,u|0,v|0)|0;c[r>>2]=(c[r>>2]|0)+v;b=t;f=0;d=m;break}gb(b|0,u|0,e|0)|0;b=t;b=b+(Ja(b,c[d>>2]|0,q,g,c[s+144>>2]|0,c[l>>2]|0)|0)|0;if(!(c[n>>2]|0))c[d>>2]=(c[d>>2]|0)+q;c[r>>2]=0;f=1;d=u+e|0}}while(0);o=w;j=s+144|0;h=f;while(1){e=d;f=o-d|0;if(f>>>0<q>>>0)break;h=b;b=h+(Ja(h,e,q,g,c[j>>2]|0,c[l>>2]|0)|0)|0;h=2;d=e+q|0}k=s+36|0;if((c[k>>2]|0)!=0&e>>>0<w>>>0){g=b+(Ja(b,e,f,g,c[j>>2]|0,c[l>>2]|0)|0)|0;b=2;f=m}else{g=b;b=h;f=d}do{if((c[n>>2]|0)==0&(b|0)==2){if(c[p>>2]|0){c[s+76>>2]=c[s+72>>2];break}b=Ka(s)|0;if(!b){b=-1;x=26;break a}c[s+76>>2]=(c[s+72>>2]|0)+b}}while(0);d=s+76|0;b=c[d>>2]|0;e=s+72|0;if((b+q|0)>>>0>((c[e>>2]|0)+(c[s+68>>2]|0)|0)>>>0?(c[k>>2]|0)==0:0){b=Ka(s)|0;b=(c[e>>2]|0)+b|0;c[d>>2]=b}d=f;if(d>>>0<w>>>0){w=o-f|0;gb(b|0,d|0,w|0)|0;c[r>>2]=w}if((c[s+8>>2]|0)==1)Ra(s+96|0,u,v);b=s+88|0;w=b;w=cb(c[w>>2]|0,c[w+4>>2]|0,v|0,0)|0;c[b>>2]=w;c[b+4>>2]=C;b=g-t|0;if(b>>>0<=4294967277){la(1,a|0,c[4]|0,b|0)|0;x=1;i=y;return x|0}}else{b=-11;x=26}else{b=-1;x=26}}while(0);ma(0,a|0,c[20+(0-b<<2)>>2]|0)|0;x=0;i=y;return x|0}function Da(b){b=b|0;var d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0;j=c[b+4>>2]|0;k=c[4]|0;d=c[2]|0;if(c[j+80>>2]|0)if((c[j+60>>2]|0)==1){g=j+80|0;e=c[g>>2]|0;if(d>>>0>=(e+8|0)>>>0){f=j+4|0;d=c[j+32>>2]|0;l=(c[f>>2]|0)==1;m=k;h=j+76|0;e=m+(Ja(m,c[h>>2]|0,e,(d|0)<3?l?1:2:l?3:4,c[j+144>>2]|0,d)|0)|0;if(!(c[f>>2]|0)){f=(c[h>>2]|0)+(c[g>>2]|0)|0;c[h>>2]=f}else f=c[h>>2]|0;c[g>>2]=0;d=j+72|0;if((f+(c[j+64>>2]|0)|0)>>>0>((c[d>>2]|0)+(c[j+68>>2]|0)|0)>>>0){m=Ka(j)|0;c[h>>2]=(c[d>>2]|0)+m}d=e-k|0;if(d>>>0<=4294967277)i=10}else d=-11}else d=-1;else{d=0;i=10}do{if((i|0)==10){e=k;a[e+d>>0]=0;a[e+(d+1)>>0]=0;a[e+(d+2)>>0]=0;a[e+(d+3)>>0]=0;f=e+(d+4)|0;if((c[j+8>>2]|0)==1){m=Sa(j+96|0)|0;a[f>>0]=m;a[e+(d+5)>>0]=m>>>8;a[e+(d+6)>>0]=m>>>16;a[e+(d+7)>>0]=m>>>24;d=e+(d+8)|0}else d=f;c[j+60>>2]=0;f=j+16|0;e=c[f>>2]|0;f=c[f+4>>2]|0;if(!((e|0)==0&(f|0)==0)?(m=j+88|0,!((e|0)==(c[m>>2]|0)?(f|0)==(c[m+4>>2]|0):0)):0){d=-14;break}d=d-k|0;if(d>>>0<=4294967277){la(1,b|0,c[4]|0,d|0)|0;m=1;return m|0}}}while(0);ma(0,b|0,c[20+(0-d<<2)>>2]|0)|0;m=0;return m|0}function Ea(){var a=0,b=0;a=_a(4)|0;b=_a(160)|0;if(!b){b=0;return b|0}if(c[b+-4>>2]&3)db(b|0,0,160)|0;c[b+32>>2]=100;c[a>>2]=b;if((c[2]|0)>>>0>=8192){b=a;return b|0}$a(c[4]|0);c[2]=8192;c[4]=_a(8192)|0;b=a;return b|0}function Fa(a){a=a|0;a=c[a>>2]|0;if(!a)return;$a(c[a+60>>2]|0);$a(c[a+72>>2]|0);$a(a);return}function Ga(b){b=b|0;var e=0,f=0,g=0,h=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0,O=0,P=0,Q=0,R=0,S=0,T=0,U=0,V=0,W=0,X=0,Y=0,Z=0;X=i;i=i+16|0;V=X;N=la(2,b|0,c[3]|0,8192)|0;e=8192;U=0;a:while(1){D=c[b>>2]|0;O=c[4]|0;T=c[3]|0;S=T+U|0;T=T+N|0;F=O;B=F+e|0;c[V>>2]=0;I=D+56|0;M=c[I>>2]|0;if(!((M|0)==0|(S|0)==(M|0))){e=-15;W=99;break}m=D+36|0;n=T;o=D+64|0;p=D+68|0;q=D+60|0;r=D+48|0;s=B;t=D+8|0;u=D+16|0;v=D+4|0;w=D+40|0;x=D+96|0;G=D+88|0;J=D+92|0;y=D+84|0;z=D+144|0;K=D+76|0;L=D+80|0;M=D+72|0;A=D+148|0;E=1;l=O;H=1;k=0;j=S;b:while(1){if(!E)break;c:do{switch(c[m>>2]|0){case 0:{h=j;e=n-j|0;if(e>>>0<=14){c[o>>2]=0;c[p>>2]=7;c[m>>2]=1;f=7;g=0;W=11;break c}e=La(D,h,e)|0;if(e>>>0>4294967277){W=99;break a}Z=k;Y=H;f=l;g=E;j=h+e|0;k=Z;H=Y;l=f;E=g;continue b}case 1:{e=n-j|0;h=j;f=c[p>>2]|0;g=c[o>>2]|0;W=11;break}case 2:if((n-j|0)>>>0>3){h=j;f=j+4|0;W=20;break c}else{c[o>>2]=0;c[m>>2]=3;W=17;break c}case 3:{W=17;break}case 4:{h=c[p>>2]|0;e=j;f=n-j|0;h=f>>>0<h>>>0?f:h;f=l;Z=s-l|0;h=Z>>>0<h>>>0?Z:h;gb(f|0,e|0,h|0)|0;if(c[t>>2]|0)Ra(x,e,h);Z=u;if(!((c[Z>>2]|0)==0&(c[Z+4>>2]|0)==0)){Y=w;Y=bb(c[Y>>2]|0,c[Y+4>>2]|0,h|0,0)|0;Z=w;c[Z>>2]=Y;c[Z+4>>2]=C}if(!(c[v>>2]|0))Ma(D,f,h,F,0);g=e+h|0;e=f+h|0;f=c[p>>2]|0;if((f|0)==(h|0)){c[m>>2]=2;h=k;Y=H;Z=E;l=e;j=g;k=h;H=Y;E=Z;continue b}else{H=f-h|0;c[p>>2]=H;Z=k;E=0;l=e;H=H+4|0;j=g;k=Z;continue b}}case 5:{e=c[p>>2]|0;if((n-j|0)>>>0<e>>>0){c[o>>2]=0;c[m>>2]=6;f=j;g=k;h=H;Y=l;Z=E;j=f;k=g;H=h;l=Y;E=Z;continue b}else{c[m>>2]=7;k=j;h=H;Y=l;Z=E;j=j+e|0;H=h;l=Y;E=Z;continue b}}case 6:{e=c[o>>2]|0;f=(c[p>>2]|0)-e|0;g=j;Z=n-j|0;f=f>>>0>Z>>>0?Z:f;gb((c[q>>2]|0)+e|0,g|0,f|0)|0;e=(c[o>>2]|0)+f|0;c[o>>2]=e;f=g+f|0;g=c[p>>2]|0;if(g>>>0>e>>>0){Y=k;Z=l;E=0;H=g-e+4|0;j=f;k=Y;l=Z;continue b}else{k=c[q>>2]|0;c[m>>2]=7;h=H;Y=l;Z=E;j=f;H=h;l=Y;E=Z;continue b}}case 7:if((s-l|0)>>>0<(c[r>>2]|0)>>>0){c[m>>2]=9;f=j;g=k;h=H;Y=l;Z=E;j=f;k=g;H=h;l=Y;E=Z;continue b}else{c[m>>2]=8;f=j;g=k;h=H;Y=l;Z=E;j=f;k=g;H=h;l=Y;E=Z;continue b}case 8:{e=l;f=oa[((c[v>>2]|0)==0?5:6)&7](k,e,c[p>>2]|0,c[r>>2]|0,c[K>>2]|0,c[L>>2]|0)|0;if((f|0)<0){e=-1;W=99;break a}if(c[t>>2]|0)Ra(x,e,f);Z=u;if(!((c[Z>>2]|0)==0&(c[Z+4>>2]|0)==0)){Y=w;Y=bb(c[Y>>2]|0,c[Y+4>>2]|0,f|0,((f|0)<0)<<31>>31|0)|0;Z=w;c[Z>>2]=Y;c[Z+4>>2]=C}if(!(c[v>>2]|0))Ma(D,e,f,F,0);c[m>>2]=2;g=j;h=k;Y=H;Z=E;l=e+f|0;j=g;k=h;H=Y;E=Z;continue b}case 9:{do{if(!(c[v>>2]|0)){e=c[K>>2]|0;f=c[M>>2]|0;g=c[L>>2]|0;if((e|0)!=(f|0)){h=f+(g>>>0>65536?65536:g)|0;c[y>>2]=h;f=g;e=5;break}if(g>>>0>131072){gb(e|0,e+(g+-65536)|0,65536)|0;c[L>>2]=65536;e=c[M>>2]|0;f=65536}else f=g;h=e+f|0;c[y>>2]=h;e=5}else{h=c[y>>2]|0;f=c[L>>2]|0;e=6}}while(0);e=oa[e&7](k,h,c[p>>2]|0,c[r>>2]|0,c[K>>2]|0,f)|0;if((e|0)<0){e=-16;W=99;break a}if(c[t>>2]|0)Ra(x,c[y>>2]|0,e);Z=u;if(!((c[Z>>2]|0)==0&(c[Z+4>>2]|0)==0)){Y=w;Y=bb(c[Y>>2]|0,c[Y+4>>2]|0,e|0,((e|0)<0)<<31>>31|0)|0;Z=w;c[Z>>2]=Y;c[Z+4>>2]=C}c[G>>2]=e;c[J>>2]=0;c[m>>2]=10;f=j;g=k;h=H;Y=l;Z=E;j=f;k=g;H=h;l=Y;E=Z;continue b}case 10:{Z=c[J>>2]|0;e=(c[G>>2]|0)-Z|0;f=l;Y=s-l|0;e=e>>>0>Y>>>0?Y:e;gb(f|0,(c[y>>2]|0)+Z|0,e|0)|0;if(!(c[v>>2]|0))Ma(D,f,e,F,1);Z=(c[J>>2]|0)+e|0;c[J>>2]=Z;e=f+e|0;if((Z|0)!=(c[G>>2]|0)){Y=j;Z=k;E=0;l=e;H=4;j=Y;k=Z;continue b}c[m>>2]=2;g=j;h=k;Y=H;Z=E;l=e;j=g;k=h;H=Y;E=Z;continue b}case 11:{Z=w;if(!((c[Z>>2]|0)==0&(c[Z+4>>2]|0)==0)){e=-14;W=99;break a}if(!(c[t>>2]&1073741823)){c[m>>2]=0;h=j;Y=k;Z=l;E=0;H=0;j=h;k=Y;l=Z;continue b}if((n-j|0)<4){c[o>>2]=0;c[m>>2]=12;W=75;break c}else{g=j;e=j+4|0;W=78;break c}}case 12:{W=75;break}case 13:if((n-j|0)>3){f=j;e=j+4|0;W=85;break c}else{c[o>>2]=4;c[p>>2]=8;c[m>>2]=14;W=82;break c}case 14:{W=82;break}case 15:{Y=c[p>>2]|0;Z=n-j|0;Z=Y>>>0>Z>>>0?Z:Y;f=j+Z|0;e=Y-Z|0;c[p>>2]=e;if((Y|0)!=(Z|0)){Y=k;Z=l;E=0;H=e;j=f;k=Y;l=Z;continue b}c[m>>2]=0;Y=k;Z=l;E=0;H=0;j=f;k=Y;l=Z;continue b}default:{f=j;g=k;h=H;Y=l;Z=E;j=f;k=g;H=h;l=Y;E=Z;continue b}}}while(0);do{if((W|0)==11){W=0;f=f-g|0;e=f>>>0>e>>>0?e:f;gb(D+144+g|0,h|0,e|0)|0;f=(c[o>>2]|0)+e|0;c[o>>2]=f;g=h+e|0;e=c[p>>2]|0;if(e>>>0<=f>>>0){e=La(D,z,e)|0;if(e>>>0>4294967277){W=99;break a}else{f=k;h=H;Y=l;Z=E;j=g;k=f;H=h;l=Y;E=Z;continue b}}else{Y=k;Z=l;E=0;H=e-f+4|0;j=g;k=Y;l=Z;continue b}}else if((W|0)==17){W=0;Z=c[o>>2]|0;e=4-Z|0;f=j;Y=n-j|0;e=e>>>0>Y>>>0?Y:e;gb((c[q>>2]|0)+Z|0,f|0,e|0)|0;f=f+e|0;e=(c[o>>2]|0)+e|0;c[o>>2]=e;if(e>>>0<4){Y=k;Z=l;E=0;H=4-e|0;j=f;k=Y;l=Z;continue b}else{h=c[q>>2]|0;W=20;break}}else if((W|0)==75){W=0;Z=c[o>>2]|0;e=4-Z|0;f=j;Y=n-j|0;e=e>>>0>Y>>>0?Y:e;gb((c[q>>2]|0)+Z|0,f|0,e|0)|0;f=f+e|0;e=(c[o>>2]|0)+e|0;c[o>>2]=e;if(e>>>0<4){Y=k;Z=l;E=0;H=4-e|0;j=f;k=Y;l=Z;continue b}else{g=c[q>>2]|0;e=f;W=78;break}}else if((W|0)==82){W=0;g=c[o>>2]|0;f=(c[p>>2]|0)-g|0;e=j;Z=n-j|0;f=f>>>0>Z>>>0?Z:f;gb(D+144+g|0,e|0,f|0)|0;e=e+f|0;f=(c[o>>2]|0)+f|0;c[o>>2]=f;g=c[p>>2]|0;if(g>>>0>f>>>0){Y=k;Z=l;E=0;H=g-f|0;j=e;k=Y;l=Z;continue b}else{f=A;W=85}}}while(0);if((W|0)==20){W=0;g=h;e=g+3|0;g=d[g>>0]|d[g+1>>0]<<8|d[g+2>>0]<<16|d[e>>0]<<24&2130706432;if(!g){c[m>>2]=11;g=H;Y=l;Z=E;k=h;j=f;H=g;l=Y;E=Z;continue}if(g>>>0>(c[r>>2]|0)>>>0){e=-1;W=99;break a}c[p>>2]=g;if((a[e>>0]|0)<0){c[m>>2]=4;g=H;Y=l;Z=E;k=h;j=f;H=g;l=Y;E=Z;continue}else{c[m>>2]=5;k=(l|0)==(B|0);Z=l;E=k?0:E;H=k?g+4|0:H;k=h;j=f;l=Z;continue}}else if((W|0)==78){W=0;Z=g;Z=d[Z>>0]|d[Z+1>>0]<<8|d[Z+2>>0]<<16|d[Z+3>>0]<<24;if((Z|0)!=(Sa(x)|0)){e=-18;W=99;break a}c[m>>2]=0;Z=l;E=0;H=0;k=g;j=e;l=Z;continue}else if((W|0)==85){W=0;h=f;h=d[h>>0]|d[h+1>>0]<<8|d[h+2>>0]<<16|d[h+3>>0]<<24;Y=u;c[Y>>2]=h;c[Y+4>>2]=0;c[p>>2]=h;c[m>>2]=15;h=H;Y=l;Z=E;k=f;j=e;H=h;l=Y;E=Z;continue}}do{if(((c[v>>2]|0)==0?(P=c[K>>2]|0,Q=c[M>>2]|0,(P|0)!=(Q|0)&(c[V>>2]|0)==0):0)?(R=c[m>>2]|0,(R+-1|0)>>>0<10):0){if((R|0)!=10){Y=c[L>>2]|0;Z=Y>>>0>65536?65536:Y;gb(Q|0,P+(Y-Z)|0,Z|0)|0;Y=c[M>>2]|0;c[K>>2]=Y;c[L>>2]=Z;c[y>>2]=Y+Z;break}f=(c[y>>2]|0)-Q|0;e=c[G>>2]|0;if(e>>>0>65536)e=0;else{e=65536-e|0;e=e>>>0>f>>>0?f:e}gb(Q+(f-e)|0,P+((c[L>>2]|0)-(c[J>>2]|0)-e)|0,e|0)|0;c[K>>2]=c[M>>2];c[L>>2]=f+(c[J>>2]|0)}}while(0);if(j>>>0<T>>>0)c[I>>2]=j;else c[I>>2]=0;e=l-O|0;if(H>>>0>4294967277){e=H;break}U=j-S+U|0;if(e)la(1,b|0,c[4]|0,e|0)|0;if(!H){e=1;W=106;break}if(!(N>>>0>U>>>0|(e|0)==8192)){e=1;W=106;break}}if((W|0)!=99)if((W|0)==106){i=X;return e|0}ma(0,b|0,c[20+(0-e<<2)>>2]|0)|0;Z=0;i=X;return Z|0}function Ha(a,b){a=a|0;b=b|0;var d=0,e=0,f=0,g=0,h=0;h=i;i=i+64|0;d=h;e=d;f=e+56|0;do{c[e>>2]=0;e=e+4|0}while((e|0)<(f|0));c[d+8>>2]=1;f=(b|0)==0?d:b;b=c[f>>2]|0;if(b){b=b+-4|0;if(b>>>0>3)e=-2;else g=3}else{b=0;g=3}if((g|0)==3)e=c[100+(b<<2)>>2]|0;d=(a>>>0)/(e>>>0)|0;if(!(c[f+36>>2]|0))b=e;else b=(a>>>0)%(e>>>0)|0;a=(d<<2)+4+(_(e,d)|0)+b+((c[f+8>>2]<<2)+4)|0;i=h;return a|0}function Ia(a,b){a=a|0;b=b|0;var e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0;e=a;n=a+b|0;f=b>>>0>15;if(!(e&3)){if(f){i=a+(b+-16)|0;j=606290984;k=-2048144777;l=0;m=1640531535;do{f=j+(_(c[e>>2]|0,-2048144777)|0)|0;f=f<<13|f>>>19;j=_(f,-1640531535)|0;o=e;a=k+(_(c[o+4>>2]|0,-2048144777)|0)|0;a=a<<13|a>>>19;k=_(a,-1640531535)|0;g=l+(_(c[o+8>>2]|0,-2048144777)|0)|0;g=g<<13|g>>>19;l=_(g,-1640531535)|0;h=m+(_(c[o+12>>2]|0,-2048144777)|0)|0;h=h<<13|h>>>19;m=_(h,-1640531535)|0;o=o+16|0;e=o}while(o>>>0<=i>>>0);f=(_(f,1013904226)|0|j>>>31)+(_(a,465361024)|0|k>>>25)+(_(g,2006650880)|0|l>>>20)+(_(h,-423362560)|0|m>>>14)|0}else f=374761393;a=f+b|0;while(1){f=e+4|0;if(f>>>0>n>>>0)break;o=a+(_(c[e>>2]|0,-1028477379)|0)|0;a=_(o<<17|o>>>15,668265263)|0;e=f}while(1){if(e>>>0>=n>>>0)break;o=a+(_(d[e>>0]|0,374761393)|0)|0;a=_(o<<11|o>>>21,-1640531535)|0;e=e+1|0}o=_(a^a>>>15,-2048144777)|0;o=_(o^o>>>13,-1028477379)|0;o=o^o>>>16;o=o>>>8;o=o&255;return o|0}else{if(f){h=a+(b+-16)|0;j=606290984;k=-2048144777;l=0;m=1640531535;do{i=e;i=j+(_(d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24,-2048144777)|0)|0;i=i<<13|i>>>19;j=_(i,-1640531535)|0;o=e;f=o+4|0;f=k+(_(d[f>>0]|d[f+1>>0]<<8|d[f+2>>0]<<16|d[f+3>>0]<<24,-2048144777)|0)|0;f=f<<13|f>>>19;k=_(f,-1640531535)|0;a=o+8|0;a=l+(_(d[a>>0]|d[a+1>>0]<<8|d[a+2>>0]<<16|d[a+3>>0]<<24,-2048144777)|0)|0;a=a<<13|a>>>19;l=_(a,-1640531535)|0;g=o+12|0;g=m+(_(d[g>>0]|d[g+1>>0]<<8|d[g+2>>0]<<16|d[g+3>>0]<<24,-2048144777)|0)|0;g=g<<13|g>>>19;m=_(g,-1640531535)|0;o=o+16|0;e=o}while(o>>>0<=h>>>0);f=(_(i,1013904226)|0|j>>>31)+(_(f,465361024)|0|k>>>25)+(_(a,2006650880)|0|l>>>20)+(_(g,-423362560)|0|m>>>14)|0}else f=374761393;a=f+b|0;while(1){f=e+4|0;if(f>>>0>n>>>0)break;o=e;o=a+(_(d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24,-1028477379)|0)|0;a=_(o<<17|o>>>15,668265263)|0;e=f}while(1){if(e>>>0>=n>>>0)break;o=a+(_(d[e>>0]|0,374761393)|0)|0;a=_(o<<11|o>>>21,-1640531535)|0;e=e+1|0}o=_(a^a>>>15,-2048144777)|0;o=_(o^o>>>13,-1028477379)|0;o=o^o>>>16;o=o>>>8;o=o&255;return o|0}return 0}function Ja(b,c,d,e,f,g){b=b|0;c=c|0;d=d|0;e=e|0;f=f|0;g=g|0;var h=0,i=0;i=b+4|0;g=oa[e&7](f,c,i,d,d+-1|0,g)|0;a[b>>0]=g;f=b+1|0;a[f>>0]=g>>>8;h=b+2|0;a[h>>0]=g>>>16;e=b+3|0;a[e>>0]=g>>>24;if(g){d=g;d=d+4|0;return d|0}a[b>>0]=d;a[f>>0]=d>>>8;a[h>>0]=d>>>16;a[e>>0]=d>>>24^128;gb(i|0,c|0,d|0)|0;d=d+4|0;return d|0}function Ka(a){a=a|0;var b=0,d=0,e=0,f=0,g=0,h=0;b=a+144|0;if((c[a+32>>2]|0)<3){b=c[b>>2]|0;e=c[a+72>>2]|0;a=b+16400|0;d=c[a>>2]|0;d=d>>>0<65536?d:65536;hb(e|0,(c[b+16392>>2]|0)+((c[b+16400>>2]|0)-d)|0,d|0)|0;c[b+16392>>2]=e;c[a>>2]=d;return d|0}e=c[b>>2]|0;f=e+262160|0;d=(c[e+262144>>2]|0)-((c[e+262148>>2]|0)+(c[f>>2]|0))|0;d=(d|0)<65536?d:65536;g=c[a+72>>2]|0;h=e+262144|0;hb(g|0,(c[h>>2]|0)+(0-d)|0,d|0)|0;a=e+262148|0;b=(c[h>>2]|0)-(c[a>>2]|0)|0;c[h>>2]=g+d;c[a>>2]=g+(d-b);b=b-d|0;c[f>>2]=b;c[e+262164>>2]=b;a=e+262168|0;if((c[a>>2]|0)>>>0>=b>>>0){h=d;return h|0}c[a>>2]=b;h=d;return h|0}function La(b,e,f){b=b|0;e=e|0;f=f|0;var g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0;if(f>>>0<7){b=-12;return b|0}c[b>>2]=0;c[b+4>>2]=0;c[b+8>>2]=0;c[b+12>>2]=0;c[b+16>>2]=0;c[b+20>>2]=0;c[b+24>>2]=0;c[b+28>>2]=0;i=d[e>>0]|0;j=d[e+1>>0]<<8;g=d[e+2>>0]<<16;h=d[e+3>>0]<<24;if((i&240|j|g|h|0)==407710288){c[b+12>>2]=1;if((b+144|0)==(e|0)){c[b+64>>2]=f;c[b+68>>2]=8;c[b+36>>2]=14;b=f;return b|0}else{c[b+36>>2]=13;b=4;return b|0}}if((i|j|g|h|0)!=407708164){b=-13;return b|0}c[b+12>>2]=0;i=e+4|0;j=a[i>>0]|0;k=j&255;h=k>>>5&1;l=k&16;m=k>>>3&1;n=k>>>2&1;o=m<<3|7;if(o>>>0>f>>>0){g=b+144|0;if((g|0)!=(e|0))gb(g|0,e|0,f|0)|0;c[b+64>>2]=f;c[b+68>>2]=o;c[b+36>>2]=1;b=f;return b|0}g=a[e+5>>0]|0;f=(g&255)>>>4&7;if((k&192|0)!=64){b=-6;return b|0}if(l){b=-7;return b|0}if((j&3)!=0|g<<24>>24<0){b=-8;return b|0}if(f>>>0<4){b=-2;return b|0}if(g&15){b=-8;return b|0}l=Ia(i,o+-5|0)|0;if(l<<24>>24!=(a[e+(o+-1)>>0]|0)){b=-17;return b|0}i=b+4|0;c[i>>2]=h;c[b+8>>2]=n;c[b>>2]=f;g=f+-4|0;if(g>>>0>3)g=-2;else g=c[100+(g<<2)>>2]|0;l=b+48|0;c[l>>2]=g;if(m){r=d[e+6>>0]|0;q=fb(d[e+7>>0]|0,0,8)|0;m=C;p=fb(d[e+8>>0]|0,0,16)|0;m=m|C;j=fb(d[e+9>>0]|0,0,24)|0;m=m|C|d[e+10>>0];f=fb(d[e+11>>0]|0,0,40)|0;m=m|C;k=fb(d[e+12>>0]|0,0,48)|0;k=cb(r|q|p|j|f|0,m|0,k|0,C|0)|0;m=C;f=fb(d[e+13>>0]|0,0,56)|0;f=cb(k|0,m|0,f|0,C|0)|0;m=C;e=b+16|0;c[e>>2]=f;c[e+4>>2]=m;e=b+40|0;c[e>>2]=f;c[e+4>>2]=m}if(n){h=b+96|0;c[b+104>>2]=0;c[h+12>>2]=606290984;c[b+112>>2]=-2048144777;c[h+20>>2]=0;c[b+120>>2]=1640531535;g=h;c[g>>2]=0;c[g+4>>2]=0;c[h+44>>2]=0;h=c[i>>2]|0;g=c[l>>2]|0}g=g+(((h|0)==0&1)<<17)|0;i=b+52|0;if(g>>>0>(c[i>>2]|0)>>>0){j=b+60|0;$a(c[j>>2]|0);k=b+72|0;$a(c[k>>2]|0);c[i>>2]=g;g=c[l>>2]|0;h=_a(g)|0;if(!h){c[j>>2]=h;r=-1;return r|0}if(c[h+-4>>2]&3)db(h|0,0,g|0)|0;c[j>>2]=h;h=c[i>>2]|0;g=_a(h)|0;if(!g){c[k>>2]=g;r=-1;return r|0}if(c[g+-4>>2]&3)db(g|0,0,h|0)|0;c[k>>2]=g}else g=c[b+72>>2]|0;c[b+64>>2]=0;c[b+68>>2]=0;c[b+76>>2]=g;c[b+80>>2]=0;c[b+84>>2]=g;c[b+92>>2]=0;c[b+88>>2]=0;c[b+36>>2]=2;r=o;return r|0}function Ma(a,b,d,e,f){a=a|0;b=b|0;d=d|0;e=e|0;f=f|0;var g=0,h=0,i=0,j=0,k=0,l=0,m=0;m=a+80|0;g=c[m>>2]|0;if(!g){l=a+76|0;c[l>>2]=b;h=b}else{h=a+76|0;l=h;h=c[h>>2]|0}if((h+g|0)==(b|0)){c[m>>2]=g+d;return}i=b-e+d|0;if(i>>>0>65535){c[l>>2]=e;c[m>>2]=i;return}j=a+72|0;k=c[j>>2]|0;i=(h|0)==(k|0);if(!f){if(!i){a=65536-d|0;a=a>>>0>g>>>0?g:a;gb(k|0,h+(g-a)|0,a|0)|0;gb((c[j>>2]|0)+a|0,b|0,d|0)|0;c[l>>2]=c[j>>2];c[m>>2]=a+d;return}if((g+d|0)>>>0>(c[a+52>>2]|0)>>>0){l=65536-d|0;gb(h|0,h+(g-l)|0,l|0)|0;c[m>>2]=l;h=c[j>>2]|0;g=l}gb(h+g|0,b|0,d|0)|0;c[m>>2]=(c[m>>2]|0)+d;return}else{if(i){c[m>>2]=g+d;return}f=(c[a+84>>2]|0)-k|0;i=c[a+88>>2]|0;e=a+92|0;if(i>>>0>65536)i=0;else{i=65536-i|0;i=i>>>0>f>>>0?f:i}gb(k+(f-i)|0,h+(g-(c[e>>2]|0)-i)|0,i|0)|0;c[l>>2]=c[j>>2];c[m>>2]=f+(c[e>>2]|0)+d;return}}function Na(b,e,f,g,h,i){b=b|0;e=e|0;f=f|0;g=g|0;h=h|0;i=i|0;var j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0;i=b;h=e;u=b+f|0;v=e+g|0;if(!g){if((f|0)==1)i=(a[b>>0]|0)!=0;else i=1;z=i<<31>>31;return z|0}w=e+(g+-8)|0;x=e+(g+-5)|0;y=e;q=e+(g+-12)|0;r=w;s=b+(f+-5)|0;t=b+(f+-8)|0;p=b+(f+-15)|0;a:while(1){j=i;i=j+1|0;j=d[j>>0]|0;g=j>>>4;if((g|0)==15){g=15;do{o=i;n=o+1|0;i=n;o=a[o>>0]|0;g=g+(o&255)|0}while(n>>>0<p>>>0&o<<24>>24==-1);if((g|0)<0)break}o=h;m=o+g|0;if(m>>>0>q>>>0){z=11;break}f=i;if((f+g|0)>>>0>t>>>0){z=11;break}else i=f;while(1){l=i;A=l;A=d[A>>0]|d[A+1>>0]<<8|d[A+2>>0]<<16|d[A+3>>0]<<24;l=l+4|0;l=d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24;n=h;k=n;a[k>>0]=A;a[k+1>>0]=A>>8;a[k+2>>0]=A>>16;a[k+3>>0]=A>>24;n=n+4|0;a[n>>0]=l;a[n+1>>0]=l>>8;a[n+2>>0]=l>>16;a[n+3>>0]=l>>24;h=h+8|0;if(h>>>0>=m>>>0)break;else i=i+8|0}k=f+g|0;k=g-((d[k>>0]|d[k+1>>0]<<8)&65535)|0;l=o+k|0;i=f+(g+2)|0;if(l>>>0<e>>>0)break;h=j&15;if((h|0)==15){h=15;do{f=i;if(f>>>0>s>>>0)break a;i=f+1|0;A=a[f>>0]|0;h=h+(A&255)|0}while(A<<24>>24==-1);if((h|0)<0)break}n=o+(g+(h+4))|0;h=n;f=m-l|0;if((f|0)<8){A=c[116+(f<<2)>>2]|0;a[m>>0]=a[l>>0]|0;a[o+(g+1)>>0]=a[o+(k+1)>>0]|0;a[o+(g+2)>>0]=a[o+(k+2)>>0]|0;a[o+(g+3)>>0]=a[o+(k+3)>>0]|0;k=k+(c[148+(f<<2)>>2]|0)|0;l=o+k|0;m=o+(g+4)|0;l=d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24;a[m>>0]=l;a[m+1>>0]=l>>8;a[m+2>>0]=l>>16;a[m+3>>0]=l>>24;k=k-A|0}else{j=l;j=d[j>>0]|d[j+1>>0]<<8|d[j+2>>0]<<16|d[j+3>>0]<<24;l=l+4|0;l=d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24;A=m;m=A;a[m>>0]=j;a[m+1>>0]=j>>8;a[m+2>>0]=j>>16;a[m+3>>0]=j>>24;A=A+4|0;a[A>>0]=l;a[A+1>>0]=l>>8;a[A+2>>0]=l>>16;a[A+3>>0]=l>>24;k=k+8|0}j=o+(g+8)|0;f=o+k|0;g=j;if(n>>>0<=q>>>0){g=j;while(1){o=f;l=o;l=d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24;o=o+4|0;o=d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24;A=g;m=A;a[m>>0]=l;a[m+1>>0]=l>>8;a[m+2>>0]=l>>16;a[m+3>>0]=l>>24;A=A+4|0;a[A>>0]=o;a[A+1>>0]=o>>8;a[A+2>>0]=o>>16;a[A+3>>0]=o>>24;g=g+8|0;if(g>>>0<n>>>0)f=f+8|0;else continue a}}if(n>>>0>x>>>0)break;if(j>>>0<w>>>0){g=j;j=g;while(1){m=f;B=m;B=d[B>>0]|d[B+1>>0]<<8|d[B+2>>0]<<16|d[B+3>>0]<<24;m=m+4|0;m=d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24;A=j;l=A;a[l>>0]=B;a[l+1>>0]=B>>8;a[l+2>>0]=B>>16;a[l+3>>0]=B>>24;A=A+4|0;a[A>>0]=m;a[A+1>>0]=m>>8;a[A+2>>0]=m>>16;a[A+3>>0]=m>>24;j=j+8|0;if(j>>>0>=w>>>0)break;else f=f+8|0}f=o+(k+(r-g))|0;g=r}while(1){if(g>>>0>=n>>>0)continue a;a[g>>0]=a[f>>0]|0;f=f+1|0;g=g+1|0}}if((z|0)==11)if(!((i+g|0)!=(u|0)|m>>>0>v>>>0)){gb(o|0,i|0,g|0)|0;B=m-y|0;return B|0}B=b-i+-1|0;return B|0}function Oa(f,g,h,i,j,k){f=f|0;g=g|0;h=h|0;i=i|0;j=j|0;k=k|0;var l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0;l=h;db(f|0,0,16416)|0;o=i>>>0>2113929216;if(o)m=0;else m=((i|0)/255|0)+i+16|0;q=(i|0)<65547;n=g;k=g+i|0;z=g+(i+-12)|0;A=g+(i+-5)|0;if((m|0)<=(j|0))if(q){if(o){h=0;return h|0}a:do{if((i|0)<13)r=n;else{Ua(g,f,2,g);m=g+1|0;u=g;o=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>19;while(1){i=64;r=1;while(1){q=o+r|0;r=i>>>6;if(q>>>0>z>>>0){r=n;break a}p=g+(e[f+(m<<1)>>1]|0)|0;j=m;m=(_(d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24,-1640531535)|0)>>>19;b[f+(j<<1)>>1]=o-u;j=p;if((d[j>>0]|d[j+1>>0]<<8|d[j+2>>0]<<16|d[j+3>>0]<<24|0)==(d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24|0))break;else{o=q;i=i+1|0}}i=n;while(1){t=o;if(o>>>0<=i>>>0)break;m=p;if(m>>>0<=g>>>0)break;q=o+-1|0;m=m+-1|0;if((a[q>>0]|0)!=(a[m>>0]|0))break;o=q;p=m}m=o;s=m-n|0;o=l+1|0;if(s>>>0>14){a[l>>0]=-16;r=m+241|0;q=n+14-m|0;m=m+240+((q|0)>-255?q:-255)-n|0;q=(m>>>0)%255|0;i=s+-15|0;while(1){if((i|0)<=254)break;j=o;a[j>>0]=-1;i=i+-255|0;o=j+1|0}a[o>>0]=r-n+(q-m);o=o+1|0}else a[l>>0]=s<<4;m=o+s|0;while(1){y=n;w=y;w=d[w>>0]|d[w+1>>0]<<8|d[w+2>>0]<<16|d[w+3>>0]<<24;y=y+4|0;y=d[y>>0]|d[y+1>>0]<<8|d[y+2>>0]<<16|d[y+3>>0]<<24;j=o;x=j;a[x>>0]=w;a[x+1>>0]=w>>8;a[x+2>>0]=w>>16;a[x+3>>0]=w>>24;j=j+4|0;a[j>>0]=y;a[j+1>>0]=y>>8;a[j+2>>0]=y>>16;a[j+3>>0]=y>>24;o=o+8|0;if(o>>>0>=m>>>0){n=t;break}else n=n+8|0}while(1){r=n;o=n-p&65535;a[m>>0]=o;a[m+1>>0]=o>>8;m=m+2|0;o=Va(r+4|0,p+4|0,A)|0;r=r+(o+4)|0;n=d[l>>0]|0;if(o>>>0>14){a[l>>0]=n+15;p=o+-15|0;n=14-o|0;n=o+495+(n>>>0>4294966786?n:-510)|0;o=(n>>>0)%510|0;l=p;while(1){if(l>>>0<=509)break;j=m;a[j>>0]=-1;a[j+1>>0]=-1;m=j+2|0;l=l+-510|0}l=p+(o-n)|0;if(l>>>0>254){a[m>>0]=-1;l=l+-255|0;m=m+1|0}j=m;a[j>>0]=l;l=j+1|0}else{a[l>>0]=n+o;l=m}n=r;if(n>>>0>z>>>0)break a;Ua(n+-2|0,f,2,g);m=r;p=g+(e[f+((_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>19<<1)>>1]|0)|0;Ua(n,f,2,g);o=p;if((o+65535|0)>>>0<n>>>0)break;if((d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24|0)!=(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24|0))break;a[l>>0]=0;n=r;m=l+1|0}m=n+1|0;n=r;o=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>19}}}while(0);i=r;q=k-r|0;if(q>>>0>14){p=l;a[p>>0]=-16;o=k+241|0;m=r+14-k|0;k=k+(m>>>0>4294967041?m:-255)+240-r|0;m=(k>>>0)%255|0;n=q+-15|0;while(1){l=p+1|0;if(n>>>0<=254)break;a[l>>0]=-1;p=l;n=n+-255|0}a[l>>0]=o-r+(m-k);k=p+2|0}else{k=l;a[k>>0]=q<<4;l=k;k=k+1|0}gb(k|0,i|0,q|0)|0;h=l+(q+1)-h|0;return h|0}else{if(o){h=0;return h|0}Ua(g,f,0,g);m=g+1|0;o=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20;b:while(1){r=64;s=1;while(1){t=o;i=o;o=o+s|0;j=r;r=r+1|0;s=j>>>6;if(o>>>0>z>>>0){r=n;break b}p=c[f+(m<<2)>>2]|0;q=m;m=(_(d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24,-1640531535)|0)>>>20;c[f+(q<<2)>>2]=t;q=p;if((q+65535|0)>>>0<i>>>0)continue;if((d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24|0)==(d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24|0))break}i=n;while(1){m=t;if(m>>>0<=i>>>0)break;o=p;if(o>>>0<=g>>>0)break;q=m+-1|0;m=o+-1|0;if((a[q>>0]|0)!=(a[m>>0]|0))break;t=q;p=m}s=t-n|0;o=l+1|0;if(s>>>0>14){a[l>>0]=-16;m=t+241|0;q=n+14-t|0;q=t+240+((q|0)>-255?q:-255)-n|0;i=(q>>>0)%255|0;r=s+-15|0;while(1){if((r|0)<=254)break;j=o;a[j>>0]=-1;r=r+-255|0;o=j+1|0}a[o>>0]=m-n+(i-q);o=o+1|0}else a[l>>0]=s<<4;m=o+s|0;while(1){y=n;w=y;w=d[w>>0]|d[w+1>>0]<<8|d[w+2>>0]<<16|d[w+3>>0]<<24;y=y+4|0;y=d[y>>0]|d[y+1>>0]<<8|d[y+2>>0]<<16|d[y+3>>0]<<24;j=o;x=j;a[x>>0]=w;a[x+1>>0]=w>>8;a[x+2>>0]=w>>16;a[x+3>>0]=w>>24;j=j+4|0;a[j>>0]=y;a[j+1>>0]=y>>8;a[j+2>>0]=y>>16;a[j+3>>0]=y>>24;o=o+8|0;if(o>>>0>=m>>>0){n=t;break}else n=n+8|0}while(1){r=n;o=n-p&65535;a[m>>0]=o;a[m+1>>0]=o>>8;m=m+2|0;o=Va(r+4|0,p+4|0,A)|0;r=r+(o+4)|0;n=d[l>>0]|0;if(o>>>0>14){a[l>>0]=n+15;p=o+-15|0;n=14-o|0;n=o+495+(n>>>0>4294966786?n:-510)|0;o=(n>>>0)%510|0;l=p;while(1){if(l>>>0<=509)break;j=m;a[j>>0]=-1;a[j+1>>0]=-1;m=j+2|0;l=l+-510|0}l=p+(o-n)|0;if(l>>>0>254){a[m>>0]=-1;l=l+-255|0;m=m+1|0}j=m;a[j>>0]=l;l=j+1|0}else{a[l>>0]=n+o;l=m}n=r;if(n>>>0>z>>>0)break b;Ua(n+-2|0,f,0,g);m=r;p=c[f+((_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20<<2)>>2]|0;Ua(n,f,0,g);o=p;if((o+65535|0)>>>0<n>>>0)break;if((d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24|0)!=(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24|0))break;a[l>>0]=0;n=r;m=l+1|0}m=n+1|0;n=r;o=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20}i=r;q=k-r|0;if(q>>>0>14){a[l>>0]=-16;p=k+241|0;n=r+14-k|0;k=k+(n>>>0>4294967041?n:-255)+240-r|0;n=(k>>>0)%255|0;o=q+-15|0;while(1){m=l+1|0;if(o>>>0<=254)break;a[m>>0]=-1;l=m;o=o+-255|0}a[m>>0]=p-r+(n-k);k=l+2|0}else{k=l;a[k>>0]=q<<4;m=k;k=k+1|0}gb(k|0,i|0,q|0)|0;h=m+(q+1)-h|0;return h|0}y=h+j|0;if(!q){if(o){h=0;return h|0}Ua(g,f,0,g);m=g+1|0;o=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20;c:while(1){r=64;s=1;while(1){t=o;i=o;o=o+s|0;w=r;r=r+1|0;s=w>>>6;if(o>>>0>z>>>0){x=n;v=l;l=160;break c}q=c[f+(m<<2)>>2]|0;p=m;m=(_(d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24,-1640531535)|0)>>>20;c[f+(p<<2)>>2]=t;p=q;if((p+65535|0)>>>0<i>>>0)continue;if((d[p>>0]|d[p+1>>0]<<8|d[p+2>>0]<<16|d[p+3>>0]<<24|0)==(d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24|0))break}i=n;while(1){m=t;if(m>>>0<=i>>>0)break;o=q;if(o>>>0<=g>>>0)break;p=m+-1|0;m=o+-1|0;if((a[p>>0]|0)!=(a[m>>0]|0))break;t=p;q=m}s=t-n|0;m=l+1|0;if((l+(s+8+((s>>>0)/255|0)+1)|0)>>>0>y>>>0){u=0;l=168;break}if(s>>>0>14){a[l>>0]=-16;o=t+241|0;p=n+14-t|0;p=t+240+((p|0)>-255?p:-255)-n|0;i=(p>>>0)%255|0;r=s+-15|0;while(1){if((r|0)<=254)break;w=m;a[w>>0]=-1;r=r+-255|0;m=w+1|0}a[m>>0]=o-n+(i-p);m=m+1|0}else a[l>>0]=s<<4;o=m+s|0;while(1){s=n;i=s;i=d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24;s=s+4|0;s=d[s>>0]|d[s+1>>0]<<8|d[s+2>>0]<<16|d[s+3>>0]<<24;w=m;r=w;a[r>>0]=i;a[r+1>>0]=i>>8;a[r+2>>0]=i>>16;a[r+3>>0]=i>>24;w=w+4|0;a[w>>0]=s;a[w+1>>0]=s>>8;a[w+2>>0]=s>>16;a[w+3>>0]=s>>24;m=m+8|0;if(m>>>0>=o>>>0){n=t;break}else n=n+8|0}while(1){w=n;m=n-q&65535;a[o>>0]=m;a[o+1>>0]=m>>8;m=o+2|0;p=Va(w+4|0,q+4|0,A)|0;n=w+(p+4)|0;if((o+((p>>>8)+8)|0)>>>0>y>>>0){u=0;l=168;break c}o=d[l>>0]|0;if(p>>>0>14){a[l>>0]=o+15;q=p+-15|0;o=14-p|0;o=p+495+(o>>>0>4294966786?o:-510)|0;p=(o>>>0)%510|0;l=q;while(1){if(l>>>0<=509)break;w=m;a[w>>0]=-1;a[w+1>>0]=-1;m=w+2|0;l=l+-510|0}l=q+(p-o)|0;if(l>>>0>254){a[m>>0]=-1;l=l+-255|0;m=m+1|0}w=m;a[w>>0]=l;l=w+1|0}else{a[l>>0]=o+p;l=m}o=n;if(o>>>0>z>>>0){x=n;v=l;l=160;break c}Ua(o+-2|0,f,0,g);m=n;q=c[f+((_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20<<2)>>2]|0;Ua(o,f,0,g);p=q;if((p+65535|0)>>>0<o>>>0)break;if((d[p>>0]|d[p+1>>0]<<8|d[p+2>>0]<<16|d[p+3>>0]<<24|0)!=(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24|0))break;a[l>>0]=0;o=l+1|0}m=o+1|0;o=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20}if((l|0)==160){i=x;q=k-x|0;if((v-h+q+1+(((q+240|0)>>>0)/255|0)|0)>>>0>j>>>0){h=0;return h|0}if(q>>>0>14){p=v;a[p>>0]=-16;o=k+241|0;m=x+14-k|0;k=k+(m>>>0>4294967041?m:-255)+240-x|0;m=(k>>>0)%255|0;n=q+-15|0;while(1){l=p+1|0;if(n>>>0<=254)break;a[l>>0]=-1;p=l;n=n+-255|0}a[l>>0]=o-x+(m-k);k=p+2|0}else{k=v;a[k>>0]=q<<4;l=k;k=k+1|0}gb(k|0,i|0,q|0)|0;h=l+(q+1)-h|0;return h|0}else if((l|0)==168)return u|0}else{if(o){h=0;return h|0}d:do{if((i|0)>=13){Ua(g,f,2,g);m=g+1|0;v=g;o=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>19;e:while(1){r=64;s=1;while(1){q=o+s|0;s=r>>>6;if(q>>>0>z>>>0){w=n;p=l;break d}i=g+(e[f+(m<<1)>>1]|0)|0;x=m;m=(_(d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24,-1640531535)|0)>>>19;b[f+(x<<1)>>1]=o-v;x=i;if((d[x>>0]|d[x+1>>0]<<8|d[x+2>>0]<<16|d[x+3>>0]<<24|0)==(d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24|0))break;else{o=q;r=r+1|0}}r=n;while(1){u=o;if(o>>>0<=r>>>0)break;m=i;if(m>>>0<=g>>>0)break;q=o+-1|0;m=m+-1|0;if((a[q>>0]|0)!=(a[m>>0]|0))break;o=q;i=m}t=o-n|0;m=l+1|0;if((l+(t+8+((t>>>0)/255|0)+1)|0)>>>0>y>>>0){u=0;l=168;break}if(t>>>0>14){a[l>>0]=-16;s=o+241|0;q=n+14-o|0;o=o+240+((q|0)>-255?q:-255)-n|0;q=(o>>>0)%255|0;r=t+-15|0;while(1){if((r|0)<=254)break;x=m;a[x>>0]=-1;r=r+-255|0;m=x+1|0}a[m>>0]=s-n+(q-o);m=m+1|0}else a[l>>0]=t<<4;o=m+t|0;while(1){t=n;r=t;r=d[r>>0]|d[r+1>>0]<<8|d[r+2>>0]<<16|d[r+3>>0]<<24;t=t+4|0;t=d[t>>0]|d[t+1>>0]<<8|d[t+2>>0]<<16|d[t+3>>0]<<24;x=m;s=x;a[s>>0]=r;a[s+1>>0]=r>>8;a[s+2>>0]=r>>16;a[s+3>>0]=r>>24;x=x+4|0;a[x>>0]=t;a[x+1>>0]=t>>8;a[x+2>>0]=t>>16;a[x+3>>0]=t>>24;m=m+8|0;if(m>>>0>=o>>>0){n=u;break}else n=n+8|0}while(1){x=n;m=n-i&65535;a[o>>0]=m;a[o+1>>0]=m>>8;m=o+2|0;q=Va(x+4|0,i+4|0,A)|0;n=x+(q+4)|0;if((o+((q>>>8)+8)|0)>>>0>y>>>0){u=0;l=168;break e}o=d[l>>0]|0;if(q>>>0>14){a[l>>0]=o+15;i=q+-15|0;o=14-q|0;o=q+495+(o>>>0>4294966786?o:-510)|0;q=(o>>>0)%510|0;l=i;while(1){if(l>>>0<=509)break;x=m;a[x>>0]=-1;a[x+1>>0]=-1;m=x+2|0;l=l+-510|0}l=i+(q-o)|0;if(l>>>0>254){a[m>>0]=-1;l=l+-255|0;m=m+1|0}x=m;a[x>>0]=l;l=x+1|0}else{a[l>>0]=o+q;l=m}m=n;if(m>>>0>z>>>0){w=n;p=l;break d}Ua(m+-2|0,f,2,g);o=n;i=g+(e[f+((_(d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24,-1640531535)|0)>>>19<<1)>>1]|0)|0;Ua(m,f,2,g);q=i;if((q+65535|0)>>>0<m>>>0)break;if((d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24|0)!=(d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24|0))break;a[l>>0]=0;o=l+1|0}m=m+1|0;o=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>19}if((l|0)==168)return u|0}else{w=n;p=l}}while(0);i=w;q=k-w|0;if((p-h+q+1+(((q+240|0)>>>0)/255|0)|0)>>>0>j>>>0){h=0;return h|0}if(q>>>0>14){a[p>>0]=-16;o=k+241|0;m=w+14-k|0;k=k+(m>>>0>4294967041?m:-255)+240-w|0;m=(k>>>0)%255|0;n=q+-15|0;while(1){l=p+1|0;if(n>>>0<=254)break;a[l>>0]=-1;p=l;n=n+-255|0}a[l>>0]=o-w+(m-k);k=p+2|0}else{k=p;a[k>>0]=q<<4;l=k;k=k+1|0}gb(k|0,i|0,q|0)|0;h=l+(q+1)-h|0;return h|0}return 0}function Pa(b,e,f,g,h,i){b=b|0;e=e|0;f=f|0;g=g|0;h=h|0;i=i|0;var j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0;G=e;j=f;F=b+16392|0;n=c[F>>2]|0;I=b+16400|0;o=c[I>>2]|0;p=n+o|0;k=n;if(c[b+16388>>2]|0){g=0;return g|0}H=b+16384|0;i=c[H>>2]|0;if(i>>>0>2147483648?1:i>>>0>((o|0)!=0&p>>>0<e>>>0?p:G)>>>0){i=i+-65536|0;k=0;while(1){if((k|0)==4096)break;E=b+(k<<2)|0;D=c[E>>2]|0;c[E>>2]=D>>>0<i>>>0?0:D-i|0;k=k+1|0}c[H>>2]=65536;i=c[I>>2]|0;if(i>>>0>65536){c[I>>2]=65536;i=65536}k=n+(o-i)|0;c[F>>2]=k;m=k;r=65536;l=i}else{m=n;r=i;l=o}i=e+g|0;if(i>>>0>m>>>0&i>>>0<p>>>0){k=p-i|0;if(k>>>0>65536){k=65536;l=65536}else{l=k;E=l>>>0<4;k=E?0:l;l=E?0:l}c[I>>2]=l;E=n+(o-k)|0;c[F>>2]=E;l=k;k=E}m=l>>>0<65536&l>>>0<r>>>0;if((p|0)==(e|0)){t=e+(0-l)|0;q=e;x=e+(g+-12)|0;y=e+(g+-5)|0;z=f+h|0;k=g>>>0>2113929216;a:do{if(m)if(!k){u=e+(0-r)|0;v=t;b:do{if((g|0)>=13){w=u;Ua(e,b,1,w);k=e+1|0;l=k;k=(_(d[k>>0]|d[k+1>>0]<<8|d[k+2>>0]<<16|d[k+3>>0]<<24,-1640531535)|0)>>>20;while(1){p=64;r=1;while(1){m=l+r|0;G=p;p=p+1|0;r=G>>>6;if(m>>>0>x>>>0)break b;n=w+(c[b+(k<<2)>>2]|0)|0;G=k;k=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20;c[b+(G<<2)>>2]=l-u;if(n>>>0<t>>>0){l=m;continue}o=n;if((o+65535|0)>>>0<l>>>0){l=m;continue}if((d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24|0)==(d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24|0))break;else l=m}o=q;p=v;while(1){s=l;if(l>>>0<=o>>>0)break;k=n;if(k>>>0<=p>>>0)break;m=l+-1|0;k=k+-1|0;if((a[m>>0]|0)!=(a[k>>0]|0))break;l=m;n=k}r=l-q|0;k=j+1|0;if((j+(r+8+((r>>>0)/255|0)+1)|0)>>>0>z>>>0){i=0;break a}if(r>>>0>14){a[j>>0]=-16;p=l+241|0;m=q+14-l|0;l=l+240+((m|0)>-255?m:-255)-q|0;m=(l>>>0)%255|0;o=r+-15|0;while(1){if((o|0)<=254)break;G=k;a[G>>0]=-1;o=o+-255|0;k=G+1|0}a[k>>0]=p-q+(m-l);k=k+1|0}else a[j>>0]=r<<4;l=k+r|0;while(1){F=q;E=F;E=d[E>>0]|d[E+1>>0]<<8|d[E+2>>0]<<16|d[E+3>>0]<<24;F=F+4|0;F=d[F>>0]|d[F+1>>0]<<8|d[F+2>>0]<<16|d[F+3>>0]<<24;G=k;e=G;a[e>>0]=E;a[e+1>>0]=E>>8;a[e+2>>0]=E>>16;a[e+3>>0]=E>>24;G=G+4|0;a[G>>0]=F;a[G+1>>0]=F>>8;a[G+2>>0]=F>>16;a[G+3>>0]=F>>24;k=k+8|0;if(k>>>0>=l>>>0){q=s;break}else q=q+8|0}while(1){G=q;k=q-n&65535;a[l>>0]=k;a[l+1>>0]=k>>8;k=l+2|0;m=Va(G+4|0,n+4|0,y)|0;q=G+(m+4)|0;if((l+((m>>>8)+8)|0)>>>0>z>>>0){i=0;break a}l=d[j>>0]|0;if(m>>>0>14){a[j>>0]=l+15;n=m+-15|0;l=14-m|0;l=m+495+(l>>>0>4294966786?l:-510)|0;m=(l>>>0)%510|0;j=n;while(1){if(j>>>0<=509)break;G=k;a[G>>0]=-1;a[G+1>>0]=-1;k=G+2|0;j=j+-510|0}j=n+(m-l)|0;if(j>>>0>254){a[k>>0]=-1;j=j+-255|0;k=k+1|0}G=k;a[G>>0]=j;j=G+1|0}else{a[j>>0]=l+m;j=k}k=q;if(k>>>0>x>>>0)break b;Ua(k+-2|0,b,1,w);l=q;n=w+(c[b+((_(d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24,-1640531535)|0)>>>20<<2)>>2]|0)|0;Ua(k,b,1,w);m=n;if(m>>>0<t>>>0|(m+65535|0)>>>0<k>>>0)break;if((d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24|0)!=(d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24|0))break;a[j>>0]=0;l=j+1|0}k=k+1|0;l=k;k=(_(d[k>>0]|d[k+1>>0]<<8|d[k+2>>0]<<16|d[k+3>>0]<<24,-1640531535)|0)>>>20}}}while(0);p=q;o=i-q|0;if((j-f+o+1+(((o+240|0)>>>0)/255|0)|0)>>>0<=h>>>0){if(o>>>0>14){n=j;a[n>>0]=-16;m=i+241|0;k=q+14-i|0;i=i+(k>>>0>4294967041?k:-255)+240-q|0;k=(i>>>0)%255|0;l=o+-15|0;while(1){j=n+1|0;if(l>>>0<=254)break;a[j>>0]=-1;n=j;l=l+-255|0}a[j>>0]=m-q+(k-i);i=n+2|0}else{i=j;a[i>>0]=o<<4;j=i;i=i+1|0}gb(i|0,p|0,o|0)|0;i=j+(o+1)-f|0}else i=0}else i=0;else if(!k){v=e+(0-r)|0;c:do{if((g|0)>=13){u=v;Ua(e,b,1,u);k=e+1|0;l=k;k=(_(d[k>>0]|d[k+1>>0]<<8|d[k+2>>0]<<16|d[k+3>>0]<<24,-1640531535)|0)>>>20;while(1){p=64;r=1;while(1){m=l+r|0;G=p;p=p+1|0;r=G>>>6;if(m>>>0>x>>>0)break c;n=u+(c[b+(k<<2)>>2]|0)|0;o=k;k=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20;c[b+(o<<2)>>2]=l-v;o=n;if((o+65535|0)>>>0<l>>>0){l=m;continue}if((d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24|0)==(d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24|0))break;else l=m}o=q;p=t;while(1){s=l;if(l>>>0<=o>>>0)break;k=n;if(k>>>0<=p>>>0)break;m=l+-1|0;k=k+-1|0;if((a[m>>0]|0)!=(a[k>>0]|0))break;l=m;n=k}k=l;r=k-q|0;l=j+1|0;if((j+(r+8+((r>>>0)/255|0)+1)|0)>>>0>z>>>0){i=0;break a}if(r>>>0>14){a[j>>0]=-16;p=k+241|0;m=q+14-k|0;k=k+240+((m|0)>-255?m:-255)-q|0;m=(k>>>0)%255|0;o=r+-15|0;while(1){if((o|0)<=254)break;G=l;a[G>>0]=-1;o=o+-255|0;l=G+1|0}a[l>>0]=p-q+(m-k);l=l+1|0}else a[j>>0]=r<<4;m=l+r|0;k=q;while(1){F=k;E=F;E=d[E>>0]|d[E+1>>0]<<8|d[E+2>>0]<<16|d[E+3>>0]<<24;F=F+4|0;F=d[F>>0]|d[F+1>>0]<<8|d[F+2>>0]<<16|d[F+3>>0]<<24;G=l;e=G;a[e>>0]=E;a[e+1>>0]=E>>8;a[e+2>>0]=E>>16;a[e+3>>0]=E>>24;G=G+4|0;a[G>>0]=F;a[G+1>>0]=F>>8;a[G+2>>0]=F>>16;a[G+3>>0]=F>>24;l=l+8|0;if(l>>>0>=m>>>0){q=s;l=m;break}else k=k+8|0}while(1){G=q;k=q-n&65535;a[l>>0]=k;a[l+1>>0]=k>>8;k=l+2|0;m=Va(G+4|0,n+4|0,y)|0;q=G+(m+4)|0;if((l+((m>>>8)+8)|0)>>>0>z>>>0){i=0;break a}l=d[j>>0]|0;if(m>>>0>14){a[j>>0]=l+15;n=m+-15|0;l=14-m|0;l=m+495+(l>>>0>4294966786?l:-510)|0;m=(l>>>0)%510|0;j=n;while(1){if(j>>>0<=509)break;G=k;a[G>>0]=-1;a[G+1>>0]=-1;k=G+2|0;j=j+-510|0}j=n+(m-l)|0;if(j>>>0>254){a[k>>0]=-1;j=j+-255|0;k=k+1|0}G=k;a[G>>0]=j;j=G+1|0}else{a[j>>0]=l+m;j=k}k=q;if(k>>>0>x>>>0)break c;Ua(k+-2|0,b,1,u);l=q;n=u+(c[b+((_(d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24,-1640531535)|0)>>>20<<2)>>2]|0)|0;Ua(k,b,1,u);m=n;if((m+65535|0)>>>0<k>>>0)break;if((d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24|0)!=(d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24|0))break;a[j>>0]=0;l=j+1|0}k=k+1|0;l=k;k=(_(d[k>>0]|d[k+1>>0]<<8|d[k+2>>0]<<16|d[k+3>>0]<<24,-1640531535)|0)>>>20}}}while(0);p=q;o=i-q|0;if((j-f+o+1+(((o+240|0)>>>0)/255|0)|0)>>>0<=h>>>0){if(o>>>0>14){a[j>>0]=-16;n=i+241|0;l=q+14-i|0;i=i+(l>>>0>4294967041?l:-255)+240-q|0;l=(i>>>0)%255|0;m=o+-15|0;while(1){k=j+1|0;if(m>>>0<=254)break;a[k>>0]=-1;j=k;m=m+-255|0}a[k>>0]=n-q+(l-i);i=j+2|0}else{i=j;a[i>>0]=o<<4;k=i;i=i+1|0}gb(i|0,p|0,o|0)|0;i=k+(o+1)-f|0}else i=0}else i=0}while(0);c[I>>2]=(c[I>>2]|0)+g;c[H>>2]=(c[H>>2]|0)+g;g=i;return g|0}d:do{if(m){E=e+(0-l)|0;D=k;y=D+l|0;q=e;z=y-q|0;A=e+(g+-12)|0;B=e+(g+-5)|0;C=f+h|0;if(g>>>0<=2113929216){w=e+(0-r)|0;e:do{if((g|0)>=13){x=w;Ua(e,b,1,x);l=e+1|0;m=l;l=(_(d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24,-1640531535)|0)>>>20;while(1){s=64;t=1;while(1){p=m+t|0;v=s;s=s+1|0;t=v>>>6;if(p>>>0>A>>>0)break e;o=x+(c[b+(l<<2)>>2]|0)|0;v=o>>>0<e>>>0;n=v?z:0;v=v?k:G;u=l;l=(_(d[p>>0]|d[p+1>>0]<<8|d[p+2>>0]<<16|d[p+3>>0]<<24,-1640531535)|0)>>>20;c[b+(u<<2)>>2]=m-w;if(o>>>0<E>>>0){m=p;continue}r=o;if((r+65535|0)>>>0<m>>>0){m=p;continue}u=r+n|0;if((d[u>>0]|d[u+1>>0]<<8|d[u+2>>0]<<16|d[u+3>>0]<<24|0)==(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24|0))break;else m=p}r=q;s=v;t=n+-1|0;while(1){u=m;if(m>>>0<=r>>>0)break;l=o;if((l+n|0)>>>0<=s>>>0)break;p=m+-1|0;if((a[p>>0]|0)!=(a[l+t>>0]|0))break;m=p;o=l+-1|0}t=m-q|0;l=j+1|0;if((j+(t+8+((t>>>0)/255|0)+1)|0)>>>0>C>>>0){j=F;i=0;break d}if(t>>>0>14){a[j>>0]=-16;s=m+241|0;p=q+14-m|0;m=m+240+((p|0)>-255?p:-255)-q|0;p=(m>>>0)%255|0;r=t+-15|0;while(1){if((r|0)<=254)break;J=l;a[J>>0]=-1;r=r+-255|0;l=J+1|0}a[l>>0]=s-q+(p-m);l=l+1|0}else a[j>>0]=t<<4;m=l+t|0;while(1){t=q;r=t;r=d[r>>0]|d[r+1>>0]<<8|d[r+2>>0]<<16|d[r+3>>0]<<24;t=t+4|0;t=d[t>>0]|d[t+1>>0]<<8|d[t+2>>0]<<16|d[t+3>>0]<<24;J=l;s=J;a[s>>0]=r;a[s+1>>0]=r>>8;a[s+2>>0]=r>>16;a[s+3>>0]=r>>24;J=J+4|0;a[J>>0]=t;a[J+1>>0]=t>>8;a[J+2>>0]=t>>16;a[J+3>>0]=t>>24;l=l+8|0;if(l>>>0>=m>>>0){q=u;r=v;s=m;break}else q=q+8|0}while(1){p=q;m=o;l=q-o&65535;a[s>>0]=l;a[s+1>>0]=l>>8;l=s+2|0;if((r|0)==(D|0)){J=p+(y-(m+n))|0;J=J>>>0>B>>>0?B:J;o=Va(p+4|0,m+(n+4)|0,J)|0;m=o+4|0;n=p+m|0;if((n|0)==(J|0)){J=Va(n,e,B)|0;n=p+(m+J)|0;o=o+J|0}}else{o=Va(p+4|0,m+4|0,B)|0;n=p+(o+4)|0}q=n;if((s+((o>>>8)+8)|0)>>>0>C>>>0){j=F;i=0;break d}m=d[j>>0]|0;if(o>>>0>14){a[j>>0]=m+15;p=o+-15|0;m=14-o|0;m=o+495+(m>>>0>4294966786?m:-510)|0;o=(m>>>0)%510|0;j=p;while(1){if(j>>>0<=509)break;J=l;a[J>>0]=-1;a[J+1>>0]=-1;l=J+2|0;j=j+-510|0}j=p+(o-m)|0;if(j>>>0>254){a[l>>0]=-1;j=j+-255|0;l=l+1|0}J=l;a[J>>0]=j;j=J+1|0}else{a[j>>0]=m+o;j=l}if(n>>>0>A>>>0)break e;Ua(n+-2|0,b,1,x);o=x+(c[b+((_(d[n>>0]|d[n+1>>0]<<8|d[n+2>>0]<<16|d[n+3>>0]<<24,-1640531535)|0)>>>20<<2)>>2]|0)|0;m=o>>>0<e>>>0;p=m?z:0;Ua(n,b,1,x);l=o;if(l>>>0<E>>>0|(l+65535|0)>>>0<n>>>0)break;J=l+p|0;if((d[J>>0]|d[J+1>>0]<<8|d[J+2>>0]<<16|d[J+3>>0]<<24|0)!=(d[n>>0]|d[n+1>>0]<<8|d[n+2>>0]<<16|d[n+3>>0]<<24|0))break;a[j>>0]=0;r=m?k:G;s=j+1|0;n=p}l=n+1|0;m=l;l=(_(d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24,-1640531535)|0)>>>20}}}while(0);o=q;p=i-q|0;if((j-f+p+1+(((p+240|0)>>>0)/255|0)|0)>>>0<=h>>>0){if(p>>>0>14){a[j>>0]=-16;n=i+241|0;l=q+14-i|0;i=i+(l>>>0>4294967041?l:-255)+240-q|0;l=(i>>>0)%255|0;m=p+-15|0;while(1){k=j+1|0;if(m>>>0<=254)break;a[k>>0]=-1;j=k;m=m+-255|0}a[k>>0]=n-q+(l-i);i=j+2|0}else{i=j;a[i>>0]=p<<4;k=i;i=i+1|0}gb(i|0,o|0,p|0)|0;j=F;i=k+(p+1)-f|0}else{j=F;i=0}}else{j=F;i=0}}else{D=k;y=D+l|0;l=e;z=y-l|0;A=e+(g+-12)|0;B=e+(g+-5)|0;C=f+h|0;if(g>>>0<=2113929216){w=e+(0-r)|0;f:do{if((g|0)<13)q=l;else{x=w;Ua(e,b,1,x);m=e+1|0;n=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20;while(1){s=64;t=1;while(1){q=n+t|0;J=s;s=s+1|0;t=J>>>6;if(q>>>0>A>>>0){q=l;break f}o=x+(c[b+(m<<2)>>2]|0)|0;v=o>>>0<e>>>0;p=v?z:0;v=v?k:G;r=m;m=(_(d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24,-1640531535)|0)>>>20;c[b+(r<<2)>>2]=n-w;r=o;if((r+65535|0)>>>0<n>>>0){n=q;continue}J=r+p|0;if((d[J>>0]|d[J+1>>0]<<8|d[J+2>>0]<<16|d[J+3>>0]<<24|0)==(d[n>>0]|d[n+1>>0]<<8|d[n+2>>0]<<16|d[n+3>>0]<<24|0))break;else n=q}r=l;s=v;t=p+-1|0;while(1){u=n;if(n>>>0<=r>>>0)break;m=o;if((m+p|0)>>>0<=s>>>0)break;q=n+-1|0;if((a[q>>0]|0)!=(a[m+t>>0]|0))break;n=q;o=m+-1|0}t=n-l|0;m=j+1|0;if((j+(t+8+((t>>>0)/255|0)+1)|0)>>>0>C>>>0){j=F;i=0;break d}if(t>>>0>14){a[j>>0]=-16;s=n+241|0;q=l+14-n|0;n=n+240+((q|0)>-255?q:-255)-l|0;q=(n>>>0)%255|0;r=t+-15|0;while(1){if((r|0)<=254)break;J=m;a[J>>0]=-1;r=r+-255|0;m=J+1|0}a[m>>0]=s-l+(q-n);m=m+1|0}else a[j>>0]=t<<4;n=m+t|0;while(1){E=l;s=E;s=d[s>>0]|d[s+1>>0]<<8|d[s+2>>0]<<16|d[s+3>>0]<<24;E=E+4|0;E=d[E>>0]|d[E+1>>0]<<8|d[E+2>>0]<<16|d[E+3>>0]<<24;J=m;t=J;a[t>>0]=s;a[t+1>>0]=s>>8;a[t+2>>0]=s>>16;a[t+3>>0]=s>>24;J=J+4|0;a[J>>0]=E;a[J+1>>0]=E>>8;a[J+2>>0]=E>>16;a[J+3>>0]=E>>24;m=m+8|0;if(m>>>0>=n>>>0){l=u;r=v;s=n;break}else l=l+8|0}while(1){q=l;n=o;m=l-o&65535;a[s>>0]=m;a[s+1>>0]=m>>8;m=s+2|0;if((r|0)==(D|0)){J=q+(y-(n+p))|0;J=J>>>0>B>>>0?B:J;o=Va(q+4|0,n+(p+4)|0,J)|0;l=o+4|0;n=q+l|0;if((n|0)==(J|0)){J=Va(n,e,B)|0;q=q+(l+J)|0;o=o+J|0}else q=n}else{o=Va(q+4|0,n+4|0,B)|0;q=q+(o+4)|0}l=q;if((s+((o>>>8)+8)|0)>>>0>C>>>0){j=F;i=0;break d}n=d[j>>0]|0;if(o>>>0>14){a[j>>0]=n+15;p=o+-15|0;n=14-o|0;n=o+495+(n>>>0>4294966786?n:-510)|0;o=(n>>>0)%510|0;j=p;while(1){if(j>>>0<=509)break;J=m;a[J>>0]=-1;a[J+1>>0]=-1;m=J+2|0;j=j+-510|0}j=p+(o-n)|0;if(j>>>0>254){a[m>>0]=-1;j=j+-255|0;m=m+1|0}J=m;a[J>>0]=j;j=J+1|0}else{a[j>>0]=n+o;j=m}if(q>>>0>A>>>0){q=l;break f}Ua(q+-2|0,b,1,x);o=x+(c[b+((_(d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24,-1640531535)|0)>>>20<<2)>>2]|0)|0;n=o>>>0<e>>>0;p=n?z:0;Ua(q,b,1,x);m=o;if((m+65535|0)>>>0<q>>>0)break;J=m+p|0;if((d[J>>0]|d[J+1>>0]<<8|d[J+2>>0]<<16|d[J+3>>0]<<24|0)!=(d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24|0))break;a[j>>0]=0;r=n?k:G;s=j+1|0}m=q+1|0;n=m;m=(_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-1640531535)|0)>>>20}}}while(0);o=q;p=i-q|0;if((j-f+p+1+(((p+240|0)>>>0)/255|0)|0)>>>0<=h>>>0){if(p>>>0>14){a[j>>0]=-16;n=i+241|0;l=q+14-i|0;i=i+(l>>>0>4294967041?l:-255)+240-q|0;l=(i>>>0)%255|0;m=p+-15|0;while(1){k=j+1|0;if(m>>>0<=254)break;a[k>>0]=-1;j=k;m=m+-255|0}a[k>>0]=n-q+(l-i);i=j+2|0}else{i=j;a[i>>0]=p<<4;k=i;i=i+1|0}gb(i|0,o|0,p|0)|0;j=F;i=k+(p+1)-f|0}else{j=F;i=0}}else{j=F;i=0}}}while(0);c[j>>2]=G;c[I>>2]=g;c[H>>2]=(c[H>>2]|0)+g;J=i;return J|0}function Qa(a,b,c,d,e,f){a=a|0;b=b|0;c=c|0;d=d|0;e=e|0;f=f|0;if(d>>>0>2113929216)f=0;else f=((d|0)/255|0)+d+16|0;if((f|0)>(e|0)){d=Ya(a,b,c,d,e,1)|0;return d|0}else{d=Ya(a,b,c,d,e,0)|0;return d|0}return 0}function Ra(a,b,e){a=a|0;b=b|0;e=e|0;var f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0;n=b+e|0;f=a;f=cb(c[f>>2]|0,c[f+4>>2]|0,e|0,0)|0;o=a;c[o>>2]=f;c[o+4>>2]=C;o=a+44|0;f=c[o>>2]|0;if((f+e|0)>>>0<16){gb(a+28+f|0,b|0,e|0)|0;c[o>>2]=(c[o>>2]|0)+e;return}if(!f)f=b;else{l=a+28|0;gb(l+f|0,b|0,16-f|0)|0;l=_(d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24,-2048144777)|0;f=a+12|0;l=(c[f>>2]|0)+l|0;c[f>>2]=_(l<<13|l>>>19,-1640531535)|0;f=a+32|0;l=_(d[f>>0]|d[f+1>>0]<<8|d[f+2>>0]<<16|d[f+3>>0]<<24,-2048144777)|0;m=a+16|0;l=(c[m>>2]|0)+l|0;c[m>>2]=_(l<<13|l>>>19,-1640531535)|0;f=f+4|0;f=_(d[f>>0]|d[f+1>>0]<<8|d[f+2>>0]<<16|d[f+3>>0]<<24,-2048144777)|0;m=a+20|0;f=(c[m>>2]|0)+f|0;c[m>>2]=_(f<<13|f>>>19,-1640531535)|0;m=a+40|0;m=_(d[m>>0]|d[m+1>>0]<<8|d[m+2>>0]<<16|d[m+3>>0]<<24,-2048144777)|0;f=a+24|0;m=(c[f>>2]|0)+m|0;c[f>>2]=_(m<<13|m>>>19,-1640531535)|0;f=b+(16-(c[o>>2]|0))|0;c[o>>2]=0}g=f;m=b+(e+-16)|0;if(f>>>0<=m>>>0){i=a+12|0;j=a+16|0;k=a+20|0;l=a+24|0;f=c[i>>2]|0;b=c[j>>2]|0;e=c[k>>2]|0;h=c[l>>2]|0;do{p=g;p=f+(_(d[p>>0]|d[p+1>>0]<<8|d[p+2>>0]<<16|d[p+3>>0]<<24,-2048144777)|0)|0;f=_(p<<13|p>>>19,-1640531535)|0;p=g;q=p+4|0;q=b+(_(d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24,-2048144777)|0)|0;b=_(q<<13|q>>>19,-1640531535)|0;q=p+8|0;q=e+(_(d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24,-2048144777)|0)|0;e=_(q<<13|q>>>19,-1640531535)|0;q=p+12|0;q=h+(_(d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24,-2048144777)|0)|0;h=_(q<<13|q>>>19,-1640531535)|0;p=p+16|0;g=p}while(p>>>0<=m>>>0);c[i>>2]=f;c[j>>2]=b;c[k>>2]=e;c[l>>2]=h}f=g;if(f>>>0>=n>>>0)return;q=n-g|0;gb(a+28|0,f|0,q|0)|0;c[o>>2]=q;return}function Sa(a){a=a|0;var b=0,e=0,f=0,g=0,h=0,i=0;b=a+28|0;f=b+(c[a+44>>2]|0)|0;g=a;e=c[g>>2]|0;g=c[g+4>>2]|0;if(g>>>0>0|(g|0)==0&e>>>0>15){i=c[a+12>>2]|0;h=c[a+16>>2]|0;g=c[a+20>>2]|0;a=c[a+24>>2]|0;a=(i<<1|i>>>31)+(h<<7|h>>>25)+(g<<12|g>>>20)+(a<<18|a>>>14)|0}else a=(c[a+8>>2]|0)+374761393|0;e=a+e|0;while(1){a=b+4|0;if(a>>>0>f>>>0)break;i=b;i=e+(_(d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24,-1028477379)|0)|0;e=_(i<<17|i>>>15,668265263)|0;b=a}while(1){if(b>>>0>=f>>>0)break;i=e+(_(d[b>>0]|0,374761393)|0)|0;e=_(i<<11|i>>>21,-1640531535)|0;b=b+1|0}i=_(e^e>>>15,-2048144777)|0;i=_(i^i>>>13,-1028477379)|0;return i^i>>>16|0}function Ta(b,e,f,g,h,i){b=b|0;e=e|0;f=f|0;g=g|0;h=h|0;i=i|0;var j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0;j=b;D=e;if(!i){A=b+f|0;B=e+g|0;if(!g){if((f|0)==1)j=(a[b>>0]|0)!=0;else j=1;E=j<<31>>31;return E|0}x=e+(g+-8)|0;y=e+(g+-5)|0;z=e;t=e+(g+-12)|0;u=x;v=b+(f+-5)|0;w=b+(f+-8)|0;s=b+(f+-15)|0;g=D;a:while(1){l=j;j=l+1|0;l=d[l>>0]|0;k=l>>>4;if((k|0)==15){k=15;do{h=j;D=h+1|0;j=D;h=a[h>>0]|0;k=k+(h&255)|0}while(D>>>0<s>>>0&h<<24>>24==-1);if((k|0)<0)break}r=g;o=r+k|0;if(o>>>0>t>>>0){E=12;break}f=j;if((f+k|0)>>>0>w>>>0){E=12;break}else{j=g;g=f}while(1){D=g;C=D;C=d[C>>0]|d[C+1>>0]<<8|d[C+2>>0]<<16|d[C+3>>0]<<24;D=D+4|0;D=d[D>>0]|d[D+1>>0]<<8|d[D+2>>0]<<16|d[D+3>>0]<<24;h=j;i=h;a[i>>0]=C;a[i+1>>0]=C>>8;a[i+2>>0]=C>>16;a[i+3>>0]=C>>24;h=h+4|0;a[h>>0]=D;a[h+1>>0]=D>>8;a[h+2>>0]=D>>16;a[h+3>>0]=D>>24;j=j+8|0;if(j>>>0>=o>>>0)break;else g=g+8|0}m=f+k|0;m=k-((d[m>>0]|d[m+1>>0]<<8)&65535)|0;n=r+m|0;j=f+(k+2)|0;if(n>>>0<e>>>0)break;g=l&15;if((g|0)==15){g=15;do{f=j;if(f>>>0>v>>>0)break a;j=f+1|0;h=a[f>>0]|0;g=g+(h&255)|0}while(h<<24>>24==-1);if((g|0)<0)break}p=r+(k+(g+4))|0;q=p;g=o-n|0;if((g|0)<8){l=c[116+(g<<2)>>2]|0;a[o>>0]=a[n>>0]|0;a[r+(k+1)>>0]=a[r+(m+1)>>0]|0;a[r+(k+2)>>0]=a[r+(m+2)>>0]|0;a[r+(k+3)>>0]=a[r+(m+3)>>0]|0;h=m+(c[148+(g<<2)>>2]|0)|0;i=r+h|0;D=r+(k+4)|0;i=d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24;a[D>>0]=i;a[D+1>>0]=i>>8;a[D+2>>0]=i>>16;a[D+3>>0]=i>>24;l=h-l|0}else{h=n;i=h;i=d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24;h=h+4|0;h=d[h>>0]|d[h+1>>0]<<8|d[h+2>>0]<<16|d[h+3>>0]<<24;l=o;D=l;a[D>>0]=i;a[D+1>>0]=i>>8;a[D+2>>0]=i>>16;a[D+3>>0]=i>>24;l=l+4|0;a[l>>0]=h;a[l+1>>0]=h>>8;a[l+2>>0]=h>>16;a[l+3>>0]=h>>24;l=m+8|0}f=r+(k+8)|0;g=r+l|0;k=f;if(p>>>0<=t>>>0){k=f;while(1){D=g;C=D;C=d[C>>0]|d[C+1>>0]<<8|d[C+2>>0]<<16|d[C+3>>0]<<24;D=D+4|0;D=d[D>>0]|d[D+1>>0]<<8|d[D+2>>0]<<16|d[D+3>>0]<<24;h=k;i=h;a[i>>0]=C;a[i+1>>0]=C>>8;a[i+2>>0]=C>>16;a[i+3>>0]=C>>24;h=h+4|0;a[h>>0]=D;a[h+1>>0]=D>>8;a[h+2>>0]=D>>16;a[h+3>>0]=D>>24;k=k+8|0;if(k>>>0<p>>>0)g=g+8|0;else{g=q;continue a}}}if(p>>>0>y>>>0)break;if(f>>>0<x>>>0){k=f;f=k;while(1){D=g;C=D;C=d[C>>0]|d[C+1>>0]<<8|d[C+2>>0]<<16|d[C+3>>0]<<24;D=D+4|0;D=d[D>>0]|d[D+1>>0]<<8|d[D+2>>0]<<16|d[D+3>>0]<<24;h=f;i=h;a[i>>0]=C;a[i+1>>0]=C>>8;a[i+2>>0]=C>>16;a[i+3>>0]=C>>24;h=h+4|0;a[h>>0]=D;a[h+1>>0]=D>>8;a[h+2>>0]=D>>16;a[h+3>>0]=D>>24;f=f+8|0;if(f>>>0>=x>>>0)break;else g=g+8|0}g=r+(l+(u-k))|0;k=u}while(1){if(k>>>0>=p>>>0){g=q;continue a}a[k>>0]=a[g>>0]|0;g=g+1|0;k=k+1|0}}if((E|0)==12)if(!((j+k|0)!=(A|0)|o>>>0>B>>>0)){gb(r|0,j|0,k|0)|0;E=o-z|0;return E|0}E=b-j+-1|0;return E|0}C=h+i|0;if((C|0)!=(e|0)){w=b+f|0;x=e+g|0;y=e+(0-i)|0;z=i>>>0<65536;if(!g){if((f|0)==1)j=(a[b>>0]|0)!=0;else j=1;E=j<<31>>31;return E|0}A=e+(g+-8)|0;B=e+(g+-5)|0;C=e;s=e+(g+-12)|0;t=A;u=b+(f+-5)|0;v=b+(f+-8)|0;r=b+(f+-15)|0;l=D;b:while(1){f=j;j=f+1|0;f=d[f>>0]|0;k=f>>>4;if((k|0)==15){k=15;do{q=j;p=q+1|0;j=p;q=a[q>>0]|0;k=k+(q&255)|0}while(p>>>0<r>>>0&q<<24>>24==-1);if((k|0)<0)break}q=l;p=q+k|0;if(p>>>0>s>>>0){E=107;break}g=j;if((g+k|0)>>>0>v>>>0){E=107;break}else j=g;while(1){n=j;F=n;F=d[F>>0]|d[F+1>>0]<<8|d[F+2>>0]<<16|d[F+3>>0]<<24;n=n+4|0;n=d[n>>0]|d[n+1>>0]<<8|d[n+2>>0]<<16|d[n+3>>0]<<24;o=l;m=o;a[m>>0]=F;a[m+1>>0]=F>>8;a[m+2>>0]=F>>16;a[m+3>>0]=F>>24;o=o+4|0;a[o>>0]=n;a[o+1>>0]=n>>8;a[o+2>>0]=n>>16;a[o+3>>0]=n>>24;l=l+8|0;if(l>>>0>=p>>>0)break;else j=j+8|0}m=g+k|0;m=k-((d[m>>0]|d[m+1>>0]<<8)&65535)|0;o=q+m|0;j=g+(k+2)|0;if(z&o>>>0<y>>>0)break;g=f&15;if((g|0)==15){g=15;do{f=j;if(f>>>0>u>>>0)break b;j=f+1|0;F=a[f>>0]|0;g=g+(F&255)|0}while(F<<24>>24==-1);if((g|0)<0)break}n=g+4|0;l=q+(k+n)|0;if(o>>>0<e>>>0){if(l>>>0>B>>>0)break;g=o;m=C-g|0;if(n>>>0<=m>>>0){hb(p|0,h+(g-C+i)|0,n|0)|0;continue}gb(p|0,h+(i-m)|0,m|0)|0;f=q+(k+m)|0;l=f;g=n-m|0;if(g>>>0<=(l-C|0)>>>0){gb(f|0,e|0,g|0)|0;l=q+(k+n)|0;continue}g=q+(k+n)|0;f=D;while(1){k=l;if(k>>>0>=g>>>0)continue b;l=f;a[k>>0]=a[l>>0]|0;f=l+1|0;l=k+1|0}}n=l;g=p-o|0;if((g|0)<8){F=c[116+(g<<2)>>2]|0;a[p>>0]=a[o>>0]|0;a[q+(k+1)>>0]=a[q+(m+1)>>0]|0;a[q+(k+2)>>0]=a[q+(m+2)>>0]|0;a[q+(k+3)>>0]=a[q+(m+3)>>0]|0;m=m+(c[148+(g<<2)>>2]|0)|0;o=q+m|0;p=q+(k+4)|0;o=d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24;a[p>>0]=o;a[p+1>>0]=o>>8;a[p+2>>0]=o>>16;a[p+3>>0]=o>>24;m=m-F|0}else{f=o;f=d[f>>0]|d[f+1>>0]<<8|d[f+2>>0]<<16|d[f+3>>0]<<24;o=o+4|0;o=d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24;F=p;p=F;a[p>>0]=f;a[p+1>>0]=f>>8;a[p+2>>0]=f>>16;a[p+3>>0]=f>>24;F=F+4|0;a[F>>0]=o;a[F+1>>0]=o>>8;a[F+2>>0]=o>>16;a[F+3>>0]=o>>24;m=m+8|0}f=q+(k+8)|0;g=q+m|0;k=f;if(l>>>0<=s>>>0){k=f;while(1){q=g;o=q;o=d[o>>0]|d[o+1>>0]<<8|d[o+2>>0]<<16|d[o+3>>0]<<24;q=q+4|0;q=d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24;F=k;p=F;a[p>>0]=o;a[p+1>>0]=o>>8;a[p+2>>0]=o>>16;a[p+3>>0]=o>>24;F=F+4|0;a[F>>0]=q;a[F+1>>0]=q>>8;a[F+2>>0]=q>>16;a[F+3>>0]=q>>24;k=k+8|0;if(k>>>0<l>>>0)g=g+8|0;else{l=n;continue b}}}if(l>>>0>B>>>0)break;if(f>>>0<A>>>0){k=f;f=k;while(1){p=g;G=p;G=d[G>>0]|d[G+1>>0]<<8|d[G+2>>0]<<16|d[G+3>>0]<<24;p=p+4|0;p=d[p>>0]|d[p+1>>0]<<8|d[p+2>>0]<<16|d[p+3>>0]<<24;F=f;o=F;a[o>>0]=G;a[o+1>>0]=G>>8;a[o+2>>0]=G>>16;a[o+3>>0]=G>>24;F=F+4|0;a[F>>0]=p;a[F+1>>0]=p>>8;a[F+2>>0]=p>>16;a[F+3>>0]=p>>24;f=f+8|0;if(f>>>0>=A>>>0)break;else g=g+8|0}g=q+(m+(t-k))|0;k=t}while(1){if(k>>>0>=l>>>0){l=n;continue b}a[k>>0]=a[g>>0]|0;g=g+1|0;k=k+1|0}}if((E|0)==107)if(!((j+k|0)!=(w|0)|p>>>0>x>>>0)){gb(q|0,j|0,k|0)|0;G=p-C|0;return G|0}G=b-j+-1|0;return G|0}if((i|0)>65534){A=h+(i+-65536)|0;B=b+f|0;k=i+g|0;z=h+k|0;if(!g){if((f|0)==1)j=(a[b>>0]|0)!=0;else j=1;G=j<<31>>31;return G|0}x=h+(k+-8)|0;y=h+(k+-5)|0;t=h+(k+-12)|0;u=x;v=b+(f+-5)|0;w=b+(f+-8)|0;s=b+(f+-15)|0;g=D;c:while(1){l=j;j=l+1|0;l=d[l>>0]|0;k=l>>>4;if((k|0)==15){k=15;do{G=j;F=G+1|0;j=F;G=a[G>>0]|0;k=k+(G&255)|0}while(F>>>0<s>>>0&G<<24>>24==-1);if((k|0)<0)break}r=g;o=r+k|0;if(o>>>0>t>>>0){E=45;break}f=j;if((f+k|0)>>>0>w>>>0){E=45;break}else{j=g;g=f}while(1){F=g;e=F;e=d[e>>0]|d[e+1>>0]<<8|d[e+2>>0]<<16|d[e+3>>0]<<24;F=F+4|0;F=d[F>>0]|d[F+1>>0]<<8|d[F+2>>0]<<16|d[F+3>>0]<<24;G=j;h=G;a[h>>0]=e;a[h+1>>0]=e>>8;a[h+2>>0]=e>>16;a[h+3>>0]=e>>24;G=G+4|0;a[G>>0]=F;a[G+1>>0]=F>>8;a[G+2>>0]=F>>16;a[G+3>>0]=F>>24;j=j+8|0;if(j>>>0>=o>>>0)break;else g=g+8|0}m=f+k|0;m=k-((d[m>>0]|d[m+1>>0]<<8)&65535)|0;n=r+m|0;j=f+(k+2)|0;if(n>>>0<A>>>0)break;g=l&15;if((g|0)==15){g=15;do{f=j;if(f>>>0>v>>>0)break c;j=f+1|0;G=a[f>>0]|0;g=g+(G&255)|0}while(G<<24>>24==-1);if((g|0)<0)break}p=r+(k+(g+4))|0;q=p;g=o-n|0;if((g|0)<8){l=c[116+(g<<2)>>2]|0;a[o>>0]=a[n>>0]|0;a[r+(k+1)>>0]=a[r+(m+1)>>0]|0;a[r+(k+2)>>0]=a[r+(m+2)>>0]|0;a[r+(k+3)>>0]=a[r+(m+3)>>0]|0;G=m+(c[148+(g<<2)>>2]|0)|0;h=r+G|0;F=r+(k+4)|0;h=d[h>>0]|d[h+1>>0]<<8|d[h+2>>0]<<16|d[h+3>>0]<<24;a[F>>0]=h;a[F+1>>0]=h>>8;a[F+2>>0]=h>>16;a[F+3>>0]=h>>24;l=G-l|0}else{G=n;h=G;h=d[h>>0]|d[h+1>>0]<<8|d[h+2>>0]<<16|d[h+3>>0]<<24;G=G+4|0;G=d[G>>0]|d[G+1>>0]<<8|d[G+2>>0]<<16|d[G+3>>0]<<24;l=o;F=l;a[F>>0]=h;a[F+1>>0]=h>>8;a[F+2>>0]=h>>16;a[F+3>>0]=h>>24;l=l+4|0;a[l>>0]=G;a[l+1>>0]=G>>8;a[l+2>>0]=G>>16;a[l+3>>0]=G>>24;l=m+8|0}f=r+(k+8)|0;g=r+l|0;k=f;if(p>>>0<=t>>>0){k=f;while(1){F=g;e=F;e=d[e>>0]|d[e+1>>0]<<8|d[e+2>>0]<<16|d[e+3>>0]<<24;F=F+4|0;F=d[F>>0]|d[F+1>>0]<<8|d[F+2>>0]<<16|d[F+3>>0]<<24;G=k;h=G;a[h>>0]=e;a[h+1>>0]=e>>8;a[h+2>>0]=e>>16;a[h+3>>0]=e>>24;G=G+4|0;a[G>>0]=F;a[G+1>>0]=F>>8;a[G+2>>0]=F>>16;a[G+3>>0]=F>>24;k=k+8|0;if(k>>>0<p>>>0)g=g+8|0;else{g=q;continue c}}}if(p>>>0>y>>>0)break;if(f>>>0<x>>>0){k=f;f=k;while(1){F=g;e=F;e=d[e>>0]|d[e+1>>0]<<8|d[e+2>>0]<<16|d[e+3>>0]<<24;F=F+4|0;F=d[F>>0]|d[F+1>>0]<<8|d[F+2>>0]<<16|d[F+3>>0]<<24;G=f;h=G;a[h>>0]=e;a[h+1>>0]=e>>8;a[h+2>>0]=e>>16;a[h+3>>0]=e>>24;G=G+4|0;a[G>>0]=F;a[G+1>>0]=F>>8;a[G+2>>0]=F>>16;a[G+3>>0]=F>>24;f=f+8|0;if(f>>>0>=x>>>0)break;else g=g+8|0}g=r+(l+(u-k))|0;k=u}while(1){if(k>>>0>=p>>>0){g=q;continue c}a[k>>0]=a[g>>0]|0;g=g+1|0;k=k+1|0}}if((E|0)==45)if(!((j+k|0)!=(B|0)|o>>>0>z>>>0)){gb(r|0,j|0,k|0)|0;G=o-C|0;return G|0}G=b-j+-1|0;return G|0}else{A=b+f|0;k=i+g|0;z=h+k|0;if(!g){if((f|0)==1)j=(a[b>>0]|0)!=0;else j=1;G=j<<31>>31;return G|0}x=h+(k+-8)|0;y=h+(k+-5)|0;t=h+(k+-12)|0;u=x;v=b+(f+-5)|0;w=b+(f+-8)|0;s=b+(f+-15)|0;g=D;d:while(1){l=j;j=l+1|0;l=d[l>>0]|0;k=l>>>4;if((k|0)==15){k=15;do{G=j;F=G+1|0;j=F;G=a[G>>0]|0;k=k+(G&255)|0}while(F>>>0<s>>>0&G<<24>>24==-1);if((k|0)<0)break}r=g;o=r+k|0;if(o>>>0>t>>>0){E=76;break}f=j;if((f+k|0)>>>0>w>>>0){E=76;break}else{j=g;g=f}while(1){F=g;D=F;D=d[D>>0]|d[D+1>>0]<<8|d[D+2>>0]<<16|d[D+3>>0]<<24;F=F+4|0;F=d[F>>0]|d[F+1>>0]<<8|d[F+2>>0]<<16|d[F+3>>0]<<24;G=j;e=G;a[e>>0]=D;a[e+1>>0]=D>>8;a[e+2>>0]=D>>16;a[e+3>>0]=D>>24;G=G+4|0;a[G>>0]=F;a[G+1>>0]=F>>8;a[G+2>>0]=F>>16;a[G+3>>0]=F>>24;j=j+8|0;if(j>>>0>=o>>>0)break;else g=g+8|0}m=f+k|0;m=k-((d[m>>0]|d[m+1>>0]<<8)&65535)|0;n=r+m|0;j=f+(k+2)|0;if(n>>>0<h>>>0)break;g=l&15;if((g|0)==15){g=15;do{f=j;if(f>>>0>v>>>0)break d;j=f+1|0;G=a[f>>0]|0;g=g+(G&255)|0}while(G<<24>>24==-1);if((g|0)<0)break}p=r+(k+(g+4))|0;q=p;g=o-n|0;if((g|0)<8){l=c[116+(g<<2)>>2]|0;a[o>>0]=a[n>>0]|0;a[r+(k+1)>>0]=a[r+(m+1)>>0]|0;a[r+(k+2)>>0]=a[r+(m+2)>>0]|0;a[r+(k+3)>>0]=a[r+(m+3)>>0]|0;G=m+(c[148+(g<<2)>>2]|0)|0;e=r+G|0;F=r+(k+4)|0;e=d[e>>0]|d[e+1>>0]<<8|d[e+2>>0]<<16|d[e+3>>0]<<24;a[F>>0]=e;a[F+1>>0]=e>>8;a[F+2>>0]=e>>16;a[F+3>>0]=e>>24;l=G-l|0}else{G=n;e=G;e=d[e>>0]|d[e+1>>0]<<8|d[e+2>>0]<<16|d[e+3>>0]<<24;G=G+4|0;G=d[G>>0]|d[G+1>>0]<<8|d[G+2>>0]<<16|d[G+3>>0]<<24;l=o;F=l;a[F>>0]=e;a[F+1>>0]=e>>8;a[F+2>>0]=e>>16;a[F+3>>0]=e>>24;l=l+4|0;a[l>>0]=G;a[l+1>>0]=G>>8;a[l+2>>0]=G>>16;a[l+3>>0]=G>>24;l=m+8|0}f=r+(k+8)|0;g=r+l|0;k=f;if(p>>>0<=t>>>0){k=f;while(1){F=g;D=F;D=d[D>>0]|d[D+1>>0]<<8|d[D+2>>0]<<16|d[D+3>>0]<<24;F=F+4|0;F=d[F>>0]|d[F+1>>0]<<8|d[F+2>>0]<<16|d[F+3>>0]<<24;G=k;e=G;a[e>>0]=D;a[e+1>>0]=D>>8;a[e+2>>0]=D>>16;a[e+3>>0]=D>>24;G=G+4|0;a[G>>0]=F;a[G+1>>0]=F>>8;a[G+2>>0]=F>>16;a[G+3>>0]=F>>24;k=k+8|0;if(k>>>0<p>>>0)g=g+8|0;else{g=q;continue d}}}if(p>>>0>y>>>0)break;if(f>>>0<x>>>0){k=f;f=k;while(1){F=g;D=F;D=d[D>>0]|d[D+1>>0]<<8|d[D+2>>0]<<16|d[D+3>>0]<<24;F=F+4|0;F=d[F>>0]|d[F+1>>0]<<8|d[F+2>>0]<<16|d[F+3>>0]<<24;G=f;e=G;a[e>>0]=D;a[e+1>>0]=D>>8;a[e+2>>0]=D>>16;a[e+3>>0]=D>>24;G=G+4|0;a[G>>0]=F;a[G+1>>0]=F>>8;a[G+2>>0]=F>>16;a[G+3>>0]=F>>24;f=f+8|0;if(f>>>0>=x>>>0)break;else g=g+8|0}g=r+(l+(u-k))|0;k=u}while(1){if(k>>>0>=p>>>0){g=q;continue d}a[k>>0]=a[g>>0]|0;g=g+1|0;k=k+1|0}}if((E|0)==76)if(!((j+k|0)!=(A|0)|o>>>0>z>>>0)){gb(r|0,j|0,k|0)|0;G=o-C|0;return G|0}G=b-j+-1|0;return G|0}return 0}function Ua(a,e,f,g){a=a|0;e=e|0;f=f|0;g=g|0;var h=0;h=_(d[a>>0]|d[a+1>>0]<<8|d[a+2>>0]<<16|d[a+3>>0]<<24,-1640531535)|0;if((f|0)==2){b[e+(h>>>19<<1)>>1]=a-g;return}h=h>>>20;switch(f|0){case 0:{c[e+(h<<2)>>2]=a;return}case 1:{c[e+(h<<2)>>2]=a-g;return}default:return}}function Va(b,c,e){b=b|0;c=c|0;e=e|0;var f=0,g=0,h=0,i=0,j=0,k=0;j=e+-3|0;h=c;i=b;while(1){c=i;g=h;if(i>>>0>=j>>>0)break;c=d[h>>0]|d[h+1>>0]<<8|d[h+2>>0]<<16|d[h+3>>0]<<24;f=d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24;if((c|0)!=(f|0)){k=5;break}h=h+4|0;i=i+4|0}if((k|0)==5){b=i+((ib(c^f|0)|0)>>>3)-b|0;return b|0}if(i>>>0<(e+-1|0)>>>0?(d[h>>0]|d[h+1>>0]<<8)<<16>>16==(d[i>>0]|d[i+1>>0]<<8)<<16>>16:0){g=h+2|0;c=i+2|0}f=c;if(f>>>0<e>>>0?(a[g>>0]|0)==(a[f>>0]|0):0)c=f+1|0;b=c-b|0;return b|0}function Wa(a,b,d,e,f,g){a=a|0;b=b|0;d=d|0;e=e|0;f=f|0;g=g|0;var h=0;if(a&3){a=0;return a|0}db(a|0,0,131072)|0;db(a+131072|0,-1,131072)|0;c[a+262168>>2]=65536;h=b+-65536|0;c[a+262148>>2]=h;c[a+262144>>2]=b;c[a+262152>>2]=h;c[a+262160>>2]=65536;c[a+262164>>2]=65536;if(e>>>0>2113929216)h=0;else h=((e|0)/255|0)+e+16|0;if((h|0)>(f|0)){a=Xa(a,b,d,e,f,g,1)|0;return a|0}else{a=Xa(a,b,d,e,f,g,0)|0;return a|0}return 0}function Xa(f,g,h,i,j,k,l){f=f|0;g=g|0;h=h|0;i=i|0;j=j|0;k=k|0;l=l|0;var m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0,O=0,P=0,Q=0,R=0,S=0,T=0,U=0,V=0,W=0,X=0,Y=0,Z=0,$=0,aa=0,ba=0,ca=0;m=g+i|0;Y=g+(i+-12)|0;$=g+(i+-5)|0;aa=$;ba=h+j|0;W=1<<((k|0)>16?16:(k|0)<1?9:k)+-1;Q=f+262144|0;c[Q>>2]=(c[Q>>2]|0)+i;Q=f+131072|0;R=f+262148|0;S=f+262152|0;T=f+262160|0;U=f+262164|0;V=f+262168|0;X=(l|0)==0;D=g;l=g+1|0;k=h;i=0;n=0;B=0;C=0;A=0;a:while(1){z=l;o=i;while(1){w=z;if(w>>>0>=Y>>>0){ca=187;break a}i=c[R>>2]|0;g=c[S>>2]|0;x=c[T>>2]|0;l=c[U>>2]|0;y=i;v=z-i|0;v=(l+65536|0)>>>0>v>>>0?l:v+-65535|0;i=z-i|0;l=c[V>>2]|0;while(1){if(l>>>0>=i>>>0)break;P=y+l|0;P=f+((_(d[P>>0]|d[P+1>>0]<<8|d[P+2>>0]<<16|d[P+3>>0]<<24,-1640531535)|0)>>>17<<2)|0;O=l-(c[P>>2]|0)|0;b[Q+((l&65535)<<1)>>1]=O>>>0>65535?65535:O;c[P>>2]=l;l=l+1|0}c[V>>2]=i;t=z;t=d[t>>0]|d[t+1>>0]<<8|d[t+2>>0]<<16|d[t+3>>0]<<24;r=w+4|0;s=y+x|0;u=0;i=W;q=c[f+((_(t,-1640531535)|0)>>>17<<2)>>2]|0;while(1){if(!(q>>>0>=v>>>0&(i|0)!=0))break;p=i+-1|0;if(x>>>0>q>>>0){P=g+q|0;if((d[P>>0]|d[P+1>>0]<<8|d[P+2>>0]<<16|d[P+3>>0]<<24|0)==(t|0)){l=w+(x-q)|0;l=l>>>0>$>>>0?aa:l;i=(Za(r,g+(q+4)|0,l)|0)+4|0;if((w+i|0)==(l|0)&l>>>0<$>>>0)i=i+(Za(l,s,$)|0)|0;if(i>>>0>u>>>0)o=y+q|0;else i=u}else i=u}else{P=y+q|0;l=P;if((a[y+(q+u)>>0]|0)==(a[w+u>>0]|0)?(d[P>>0]|d[P+1>>0]<<8|d[P+2>>0]<<16|d[P+3>>0]<<24|0)==(t|0):0){i=(Za(r,y+(q+4)|0,$)|0)+4|0;P=i>>>0>u>>>0;i=P?i:u;o=P?l:o}else i=u}u=i;i=p;q=q-(e[Q+((q&65535)<<1)>>1]|0)|0}if(u){M=D;g=z;p=u;l=o;H=o;G=z;i=C;break}z=w+1|0}b:while(1){F=G;I=g;K=p;L=l;while(1){E=I;J=E+K|0;if(J>>>0>=Y>>>0){q=n;r=i;ca=46;break b}z=K+-2|0;l=E+z|0;g=c[R>>2]|0;C=c[T>>2]|0;y=g;D=y+C|0;p=c[U>>2]|0;o=l;x=o-g|0;x=(p+65536|0)>>>0>x>>>0?p:x+-65535|0;p=c[S>>2]|0;g=o-g|0;o=c[V>>2]|0;while(1){if(o>>>0>=g>>>0)break;P=y+o|0;P=f+((_(d[P>>0]|d[P+1>>0]<<8|d[P+2>>0]<<16|d[P+3>>0]<<24,-1640531535)|0)>>>17<<2)|0;O=o-(c[P>>2]|0)|0;b[Q+((o&65535)<<1)>>1]=O>>>0>65535?65535:O;c[P>>2]=o;o=o+1|0}c[V>>2]=g;w=d[l>>0]|d[l+1>>0]<<8|d[l+2>>0]<<16|d[l+3>>0]<<24;t=p;v=E+(K+2)|0;p=K;l=W;s=c[f+((_(w,-1640531535)|0)>>>17<<2)>>2]|0;while(1){if(!(s>>>0>=x>>>0&(l|0)!=0)){g=i;break}r=l+-1|0;if(C>>>0>s>>>0){P=t+s|0;if((d[P>>0]|d[P+1>>0]<<8|d[P+2>>0]<<16|d[P+3>>0]<<24|0)==(w|0)){l=E+(z+(C-s))|0;l=l>>>0>$>>>0?aa:l;g=(Za(v,t+(s+4)|0,l)|0)+4|0;if(l>>>0<$>>>0?(E+(z+g)|0)==(l|0):0)g=g+(Za(l,D,$)|0)|0;o=0;while(1){P=z+o|0;q=E+P|0;if(!((P|0)>1&(s+o|0)>>>0>x>>>0))break;l=o+-1|0;if((a[E+(z+l)>>0]|0)==(a[t+(s+l)>>0]|0))o=l;else break}l=g-o|0;if((l|0)>(p|0)){p=l;n=y+(s+o)|0;i=q}}}else if((a[E+(p+1)>>0]|0)==(a[y+(s-(K+-3)+p)>>0]|0)?(P=y+s|0,(d[P>>0]|d[P+1>>0]<<8|d[P+2>>0]<<16|d[P+3>>0]<<24|0)==(w|0)):0){l=(Za(v,y+(s+4)|0,$)|0)+4|0;o=0;while(1){P=z+o|0;q=E+P|0;if(!((P|0)>1&(s+o|0)>(C|0)))break;g=o+-1|0;if((a[E+(z+g)>>0]|0)==(a[y+(s+g)>>0]|0))o=g;else break}l=l-o|0;if((l|0)>(p|0)){p=l;n=y+(s+o)|0;i=q}}l=r;s=s-(e[Q+((s&65535)<<1)>>1]|0)|0}if((p|0)==(K|0)){q=n;r=g;ca=46;break b}P=g;l=F>>>0<E>>>0&P>>>0<(E+u|0)>>>0;o=l?H:L;i=l?G:I;l=l?u:K;if((P-i|0)<3){I=g;K=p;L=n;i=g}else{N=M;O=i;s=l;P=o;l=B;i=A;break}}c:while(1){L=O;I=(s|0)>18;H=L+(s+3)|0;M=L+s|0;o=p;t=l;q=i;while(1){l=g;i=g-O|0;if((i|0)<18?(Z=I?18:s,Z=((L+Z|0)>>>0>(l+(o+-4)|0)>>>0?i+o+-4|0:Z)+(O-g)|0,(Z|0)>0):0){K=o-Z|0;v=n+Z|0;r=l+Z|0}else{K=o;v=n;r=g}G=r;J=G+K|0;if(J>>>0>=Y>>>0){A=q;break b}B=K+-3|0;i=G+B|0;l=c[R>>2]|0;C=c[T>>2]|0;z=l;D=z+C|0;n=c[U>>2]|0;E=i;y=E-l|0;y=(n+65536|0)>>>0>y>>>0?n:y+-65535|0;n=c[S>>2]|0;F=r;l=E-l|0;g=c[V>>2]|0;while(1){if(g>>>0>=l>>>0)break;A=z+g|0;A=f+((_(d[A>>0]|d[A+1>>0]<<8|d[A+2>>0]<<16|d[A+3>>0]<<24,-1640531535)|0)>>>17<<2)|0;x=g-(c[A>>2]|0)|0;b[Q+((g&65535)<<1)>>1]=x>>>0>65535?65535:x;c[A>>2]=g;g=g+1|0}c[V>>2]=l;x=d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24;w=G+(K+1)|0;p=K;l=W;g=t;A=q;u=c[f+((_(x,-1640531535)|0)>>>17<<2)>>2]|0;while(1){if(!(u>>>0>=y>>>0&(l|0)!=0)){t=g;break}t=l+-1|0;if(C>>>0>u>>>0){q=n+u|0;if((d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24|0)==(x|0)){i=G+(B+(C-u))|0;i=i>>>0>$>>>0?aa:i;l=(Za(w,n+(u+4)|0,i)|0)+4|0;if(i>>>0<$>>>0?(G+(B+l)|0)==(i|0):0)l=l+(Za(i,D,$)|0)|0;o=0;while(1){q=G+(B+o)|0;if(!(q>>>0>F>>>0&(u+o|0)>>>0>y>>>0))break;i=o+-1|0;if((a[G+(B+i)>>0]|0)==(a[n+(u+i)>>0]|0))o=i;else break}i=l-o|0;if((i|0)>(p|0)){p=i;g=z+(u+o)|0;i=q}else i=A}else i=A}else if((a[F+p>>0]|0)==(a[z+(u+(r-E)+p)>>0]|0)?(q=z+u|0,(d[q>>0]|d[q+1>>0]<<8|d[q+2>>0]<<16|d[q+3>>0]<<24|0)==(x|0)):0){i=(Za(w,z+(u+4)|0,$)|0)+4|0;o=0;while(1){q=G+(B+o)|0;if(!(q>>>0>F>>>0&(u+o|0)>(C|0)))break;l=o+-1|0;if((a[G+(B+l)>>0]|0)==(a[z+(u+l)>>0]|0))o=l;else break}i=i-o|0;if((i|0)>(p|0)){p=i;g=z+(u+o)|0;i=q}else i=A}else i=A;l=t;A=i;u=u-(e[Q+((u&65535)<<1)>>1]|0)|0}if((p|0)==(K|0))break b;i=A;if(i>>>0>=H>>>0)break;if(i>>>0<M>>>0){o=p;n=t;g=A;q=A}else break c}if(G>>>0<M>>>0){i=r-O|0;if((i|0)<15){l=I?18:s;i=(L+l|0)>>>0>(G+(K+-4)|0)>>>0?i+K+-4|0:l;l=i+(O-r)|0;if((l|0)>0){u=i;s=K-l|0;v=v+l|0;r=G+l|0}else{u=i;s=K}}else{u=i;s=K}}else{u=s;s=K}q=O-N|0;i=k+1|0;if(!X?(k+((q>>8)+q+9)|0)>>>0>ba>>>0:0){m=0;ca=196;break a}if((q|0)>14){a[k>>0]=-16;g=O+241|0;n=N+14-O|0;n=O+240+((n|0)>-255?n:-255)-N|0;o=(n>>>0)%255|0;l=q+-15|0;while(1){if((l|0)<=254)break;M=i;a[M>>0]=-1;i=M+1|0;l=l+-255|0}a[i>>0]=g-N+(o-n);i=i+1|0}else a[k>>0]=q<<4;n=i;g=n+q|0;l=i;i=N;while(1){M=i;J=M;J=d[J>>0]|d[J+1>>0]<<8|d[J+2>>0]<<16|d[J+3>>0]<<24;M=M+4|0;M=d[M>>0]|d[M+1>>0]<<8|d[M+2>>0]<<16|d[M+3>>0]<<24;N=l;K=N;a[K>>0]=J;a[K+1>>0]=J>>8;a[K+2>>0]=J>>16;a[K+3>>0]=J>>24;N=N+4|0;a[N>>0]=M;a[N+1>>0]=M>>8;a[N+2>>0]=M>>16;a[N+3>>0]=M>>24;l=l+8|0;if(l>>>0>=g>>>0)break;else i=i+8|0}P=O-P&65535;a[g>>0]=P;a[g+1>>0]=P>>8;P=q+2|0;i=n+P|0;g=u+-4|0;if(!X?(n+(P+((g>>8)+6))|0)>>>0>ba>>>0:0){m=0;ca=196;break a}l=d[k>>0]|0;if((g|0)>14){a[k>>0]=l+15;l=18-u|0;l=u+491+((l|0)>-510?l:-510)|0;g=(l>>>0)%510|0;k=u+-19|0;while(1){if((k|0)<=509)break;P=i;a[P>>0]=-1;a[P+1>>0]=-1;i=P+2|0;k=k+-510|0}k=u+-19+(g-l)|0;if((k|0)>254){a[i>>0]=-1;k=k+-255|0;i=i+1|0}P=i;a[P>>0]=k;k=P+1|0}else{a[k>>0]=l+g;k=i}N=L+u|0;O=r;P=v;n=t;l=t;g=A;i=A}if(G>>>0<M>>>0){L=M;J=L-r|0;u=K-J|0;r=(u|0)<4;u=r?p:u;v=r?t:v+J|0;r=r?A:L}else u=K;o=O-N|0;q=k;k=q+1|0;if(!X?(q+((o>>8)+o+9)|0)>>>0>ba>>>0:0){m=0;ca=196;break a}if((o|0)>14){a[q>>0]=-16;l=O+241|0;g=N+14-O|0;g=O+240+((g|0)>-255?g:-255)-N|0;n=(g>>>0)%255|0;i=o+-15|0;while(1){if((i|0)<=254)break;L=k;a[L>>0]=-1;k=L+1|0;i=i+-255|0}a[k>>0]=l-N+(n-g);k=k+1|0}else a[q>>0]=o<<4;g=k;l=g+o|0;i=k;k=N;while(1){L=k;J=L;J=d[J>>0]|d[J+1>>0]<<8|d[J+2>>0]<<16|d[J+3>>0]<<24;L=L+4|0;L=d[L>>0]|d[L+1>>0]<<8|d[L+2>>0]<<16|d[L+3>>0]<<24;N=i;K=N;a[K>>0]=J;a[K+1>>0]=J>>8;a[K+2>>0]=J>>16;a[K+3>>0]=J>>24;N=N+4|0;a[N>>0]=L;a[N+1>>0]=L>>8;a[N+2>>0]=L>>16;a[N+3>>0]=L>>24;i=i+8|0;if(i>>>0>=l>>>0)break;else k=k+8|0}P=O-P&65535;a[l>>0]=P;a[l+1>>0]=P>>8;P=o+2|0;k=g+P|0;l=s+-4|0;if(!X?(g+(P+((l>>8)+6))|0)>>>0>ba>>>0:0){m=0;ca=196;break a}i=d[q>>0]|0;if((l|0)>14){a[q>>0]=i+15;l=18-s|0;l=s+491+((l|0)>-510?l:-510)|0;g=(l>>>0)%510|0;i=s+-19|0;while(1){if((i|0)<=509)break;P=k;a[P>>0]=-1;a[P+1>>0]=-1;k=P+2|0;i=i+-510|0}i=s+-19+(g-l)|0;if((i|0)>254){a[k>>0]=-1;i=i+-255|0;k=k+1|0}a[k>>0]=i;k=k+1|0}else a[q>>0]=i+l;g=A;l=t;H=v;n=v;B=t;G=r;i=r}if((ca|0)==46){ca=0;p=I-M|0;i=k+1|0;if(!X?(k+((p>>8)+p+9)|0)>>>0>ba>>>0:0){m=0;ca=196;break}if((p|0)>14){a[k>>0]=-16;g=I+241|0;n=M+14-I|0;n=I+240+((n|0)>-255?n:-255)-M|0;o=(n>>>0)%255|0;l=p+-15|0;while(1){if((l|0)<=254)break;P=i;a[P>>0]=-1;i=P+1|0;l=l+-255|0}a[i>>0]=g-M+(o-n);i=i+1|0}else a[k>>0]=p<<4;n=i;g=n+p|0;l=i;i=M;while(1){O=i;M=O;M=d[M>>0]|d[M+1>>0]<<8|d[M+2>>0]<<16|d[M+3>>0]<<24;O=O+4|0;O=d[O>>0]|d[O+1>>0]<<8|d[O+2>>0]<<16|d[O+3>>0]<<24;P=l;N=P;a[N>>0]=M;a[N+1>>0]=M>>8;a[N+2>>0]=M>>16;a[N+3>>0]=M>>24;P=P+4|0;a[P>>0]=O;a[P+1>>0]=O>>8;a[P+2>>0]=O>>16;a[P+3>>0]=O>>24;l=l+8|0;if(l>>>0>=g>>>0)break;else i=i+8|0}P=I-L&65535;a[g>>0]=P;a[g+1>>0]=P>>8;P=p+2|0;i=n+P|0;g=K+-4|0;if(!X?(n+(P+((g>>8)+6))|0)>>>0>ba>>>0:0){m=0;ca=196;break}l=d[k>>0]|0;if((g|0)>14){a[k>>0]=l+15;l=18-K|0;l=K+491+((l|0)>-510?l:-510)|0;g=(l>>>0)%510|0;k=K+-19|0;while(1){if((k|0)<=509)break;P=i;a[P>>0]=-1;a[P+1>>0]=-1;i=P+2|0;k=k+-510|0}k=K+-19+(g-l)|0;if((k|0)>254){a[i>>0]=-1;k=k+-255|0;i=i+1|0}P=i;a[P>>0]=k;k=P+1|0}else{a[k>>0]=l+g;k=i}l=J;D=l;i=L;n=q;C=r;continue}q=G>>>0<M>>>0?r-O|0:s;p=O-N|0;i=k+1|0;if(!X?(k+((p>>8)+p+9)|0)>>>0>ba>>>0:0){m=0;ca=196;break}if((p|0)>14){a[k>>0]=-16;g=O+241|0;n=N+14-O|0;n=O+240+((n|0)>-255?n:-255)-N|0;o=(n>>>0)%255|0;l=p+-15|0;while(1){if((l|0)<=254)break;M=i;a[M>>0]=-1;i=M+1|0;l=l+-255|0}a[i>>0]=g-N+(o-n);i=i+1|0}else a[k>>0]=p<<4;n=i;g=n+p|0;l=i;i=N;while(1){M=i;H=M;H=d[H>>0]|d[H+1>>0]<<8|d[H+2>>0]<<16|d[H+3>>0]<<24;M=M+4|0;M=d[M>>0]|d[M+1>>0]<<8|d[M+2>>0]<<16|d[M+3>>0]<<24;N=l;I=N;a[I>>0]=H;a[I+1>>0]=H>>8;a[I+2>>0]=H>>16;a[I+3>>0]=H>>24;N=N+4|0;a[N>>0]=M;a[N+1>>0]=M>>8;a[N+2>>0]=M>>16;a[N+3>>0]=M>>24;l=l+8|0;if(l>>>0>=g>>>0)break;else i=i+8|0}O=O-P&65535;a[g>>0]=O;a[g+1>>0]=O>>8;O=p+2|0;i=n+O|0;g=q+-4|0;if(!X?(n+(O+((g>>8)+6))|0)>>>0>ba>>>0:0){m=0;ca=196;break}l=d[k>>0]|0;if((g|0)>14){a[k>>0]=l+15;l=18-q|0;l=q+491+((l|0)>-510?l:-510)|0;g=(l>>>0)%510|0;k=q+-19|0;while(1){if((k|0)<=509)break;O=i;a[O>>0]=-1;a[O+1>>0]=-1;i=O+2|0;k=k+-510|0}k=q+-19+(g-l)|0;if((k|0)>254){a[i>>0]=-1;k=k+-255|0;i=i+1|0}a[i>>0]=k;i=i+1|0}else a[k>>0]=l+g;o=L+q|0;p=r-o|0;q=i;k=q+1|0;if(!X?(q+((p>>8)+p+9)|0)>>>0>ba>>>0:0){m=0;ca=196;break}if((p|0)>14){a[q>>0]=-16;l=r+241|0;g=o+14-r|0;g=r+240+((g|0)>-255?g:-255)-o|0;n=(g>>>0)%255|0;i=p+-15|0;while(1){if((i|0)<=254)break;O=k;a[O>>0]=-1;k=O+1|0;i=i+-255|0}a[k>>0]=l-o+(n-g);k=k+1|0}else a[q>>0]=p<<4;g=k;l=g+p|0;i=k;k=o;while(1){N=k;L=N;L=d[L>>0]|d[L+1>>0]<<8|d[L+2>>0]<<16|d[L+3>>0]<<24;N=N+4|0;N=d[N>>0]|d[N+1>>0]<<8|d[N+2>>0]<<16|d[N+3>>0]<<24;O=i;M=O;a[M>>0]=L;a[M+1>>0]=L>>8;a[M+2>>0]=L>>16;a[M+3>>0]=L>>24;O=O+4|0;a[O>>0]=N;a[O+1>>0]=N>>8;a[O+2>>0]=N>>16;a[O+3>>0]=N>>24;i=i+8|0;if(i>>>0>=l>>>0)break;else k=k+8|0}O=r-v&65535;a[l>>0]=O;a[l+1>>0]=O>>8;O=p+2|0;k=g+O|0;l=K+-4|0;if(!X?(g+(O+((l>>8)+6))|0)>>>0>ba>>>0:0){m=0;ca=196;break}i=d[q>>0]|0;if((l|0)>14){a[q>>0]=i+15;l=18-K|0;l=K+491+((l|0)>-510?l:-510)|0;g=(l>>>0)%510|0;i=K+-19|0;while(1){if((i|0)<=509)break;O=k;a[O>>0]=-1;a[O+1>>0]=-1;k=O+2|0;i=i+-510|0}i=K+-19+(g-l)|0;if((i|0)>254){a[k>>0]=-1;i=i+-255|0;k=k+1|0}a[k>>0]=i;k=k+1|0}else a[q>>0]=i+l;l=J;D=l;i=P;n=v;B=t;C=r}if((ca|0)==187){p=D;o=m-D|0;if(!X?(k-h+o+1+(((o+240|0)>>>0)/255|0)|0)>>>0>j>>>0:0){h=0;return h|0}if((o|0)>14){n=k;a[n>>0]=-16;g=m+241|0;i=D+14-m|0;m=m+((i|0)>-255?i:-255)+240-D|0;i=(m>>>0)%255|0;l=o+-15|0;while(1){k=n+1|0;if((l|0)<=254)break;a[k>>0]=-1;n=k;l=l+-255|0}a[k>>0]=g-D+(i-m);m=n+2|0}else{m=k;a[m>>0]=o<<4;k=m;m=m+1|0}gb(m|0,p|0,o|0)|0;h=k+(o+1)-h|0;return h|0}else if((ca|0)==196)return m|0;return 0}function Ya(a,e,f,g,h,i){a=a|0;e=e|0;f=f|0;g=g|0;h=h|0;i=i|0;var j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0;s=e;r=a+262148|0;k=c[r>>2]|0;if(!k){db(a|0,0,131072)|0;db(a+131072|0,-1,131072)|0;c[a+262168>>2]=65536;k=e+-65536|0;c[r>>2]=k;q=a+262144|0;c[q>>2]=s;c[a+262152>>2]=k;c[a+262160>>2]=65536;c[a+262164>>2]=65536;j=e}else{j=a+262144|0;q=j;j=c[j>>2]|0}if((j-k|0)>>>0>2147483648){k=j-k-(c[a+262160>>2]|0)|0;k=k>>>0>65536?65536:k;l=0-k|0;db(a|0,0,131072)|0;db(a+131072|0,-1,131072)|0;m=a+262168|0;c[m>>2]=65536;p=j+(l+-65536)|0;c[a+262148>>2]=p;n=a+262144|0;c[n>>2]=j+l;c[a+262152>>2]=p;c[a+262160>>2]=65536;c[a+262164>>2]=65536;if((k|0)>3){o=k+65533|0;p=65536;while(1){if(p>>>0>=o>>>0)break;t=j+(l+(p+-65536))|0;t=a+((_(d[t>>0]|d[t+1>>0]<<8|d[t+2>>0]<<16|d[t+3>>0]<<24,-1640531535)|0)>>>17<<2)|0;u=p-(c[t>>2]|0)|0;b[a+131072+((p&65535)<<1)>>1]=u>>>0>65535?65535:u;c[t>>2]=p;p=p+1|0}c[m>>2]=o}c[n>>2]=j+(l+k);j=c[q>>2]|0}if((j|0)!=(e|0)){l=a+262144|0;if(j>>>0<((c[r>>2]|0)+4|0)>>>0){k=a+262148|0;j=a+262168|0}else{k=a+262148|0;n=c[k>>2]|0;m=(c[l>>2]|0)+-3-n|0;j=a+262168|0;o=c[j>>2]|0;while(1){if(o>>>0>=m>>>0)break;u=n+o|0;u=a+((_(d[u>>0]|d[u+1>>0]<<8|d[u+2>>0]<<16|d[u+3>>0]<<24,-1640531535)|0)>>>17<<2)|0;t=o-(c[u>>2]|0)|0;b[a+131072+((o&65535)<<1)>>1]=t>>>0>65535?65535:t;c[u>>2]=o;o=o+1|0}c[j>>2]=m}r=a+262160|0;c[a+262164>>2]=c[r>>2];t=c[k>>2]|0;u=(c[l>>2]|0)-t|0;c[r>>2]=u;c[a+262152>>2]=t;c[k>>2]=e+(0-u);c[l>>2]=s;c[j>>2]=u}j=e+g|0;k=c[a+262152>>2]|0;l=a+262164|0;m=c[a+262160>>2]|0;n=k+m|0;if(!(n>>>0>e>>>0?j>>>0>(k+(c[l>>2]|0)|0)>>>0:0)){u=a+262172|0;u=c[u>>2]|0;u=Xa(a,e,f,g,h,u,i)|0;return u|0}u=(j>>>0>n>>>0?n:j)-k|0;c[l>>2]=u;c[l>>2]=(m-u|0)>>>0<4?m:u;u=a+262172|0;u=c[u>>2]|0;u=Xa(a,e,f,g,h,u,i)|0;return u|0}function Za(b,c,e){b=b|0;c=c|0;e=e|0;var f=0,g=0,h=0,i=0,j=0,k=0;j=e+-3|0;h=c;i=b;while(1){c=i;g=h;if(i>>>0>=j>>>0)break;c=d[h>>0]|d[h+1>>0]<<8|d[h+2>>0]<<16|d[h+3>>0]<<24;f=d[i>>0]|d[i+1>>0]<<8|d[i+2>>0]<<16|d[i+3>>0]<<24;if((c|0)!=(f|0)){k=5;break}h=h+4|0;i=i+4|0}if((k|0)==5){b=i+((ib(c^f|0)|0)>>>3)-b|0;return b|0}if(i>>>0<(e+-1|0)>>>0?(d[h>>0]|d[h+1>>0]<<8)<<16>>16==(d[i>>0]|d[i+1>>0]<<8)<<16>>16:0){g=h+2|0;c=i+2|0}f=c;if(f>>>0<e>>>0?(a[g>>0]|0)==(a[f>>0]|0):0)c=f+1|0;b=c-b|0;return b|0}function _a(a){a=a|0;var b=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0;do{if(a>>>0<245){o=a>>>0<11?16:a+11&-8;a=o>>>3;i=c[57]|0;b=i>>>a;if(b&3){b=(b&1^1)+a|0;e=b<<1;d=268+(e<<2)|0;e=268+(e+2<<2)|0;f=c[e>>2]|0;g=f+8|0;h=c[g>>2]|0;do{if((d|0)!=(h|0)){if(h>>>0<(c[61]|0)>>>0)ga();a=h+12|0;if((c[a>>2]|0)==(f|0)){c[a>>2]=d;c[e>>2]=h;break}else ga()}else c[57]=i&~(1<<b)}while(0);L=b<<3;c[f+4>>2]=L|3;L=f+(L|4)|0;c[L>>2]=c[L>>2]|1;L=g;return L|0}h=c[59]|0;if(o>>>0>h>>>0){if(b){e=2<<a;e=b<<a&(e|0-e);e=(e&0-e)+-1|0;j=e>>>12&16;e=e>>>j;f=e>>>5&8;e=e>>>f;g=e>>>2&4;e=e>>>g;d=e>>>1&2;e=e>>>d;b=e>>>1&1;b=(f|j|g|d|b)+(e>>>b)|0;e=b<<1;d=268+(e<<2)|0;e=268+(e+2<<2)|0;g=c[e>>2]|0;j=g+8|0;f=c[j>>2]|0;do{if((d|0)!=(f|0)){if(f>>>0<(c[61]|0)>>>0)ga();a=f+12|0;if((c[a>>2]|0)==(g|0)){c[a>>2]=d;c[e>>2]=f;k=c[59]|0;break}else ga()}else{c[57]=i&~(1<<b);k=h}}while(0);L=b<<3;h=L-o|0;c[g+4>>2]=o|3;i=g+o|0;c[g+(o|4)>>2]=h|1;c[g+L>>2]=h;if(k){f=c[62]|0;d=k>>>3;a=d<<1;e=268+(a<<2)|0;b=c[57]|0;d=1<<d;if(b&d){b=268+(a+2<<2)|0;a=c[b>>2]|0;if(a>>>0<(c[61]|0)>>>0)ga();else{l=b;m=a}}else{c[57]=b|d;l=268+(a+2<<2)|0;m=e}c[l>>2]=f;c[m+12>>2]=f;c[f+8>>2]=m;c[f+12>>2]=e}c[59]=h;c[62]=i;L=j;return L|0}a=c[58]|0;if(a){i=(a&0-a)+-1|0;K=i>>>12&16;i=i>>>K;J=i>>>5&8;i=i>>>J;L=i>>>2&4;i=i>>>L;b=i>>>1&2;i=i>>>b;j=i>>>1&1;j=c[532+((J|K|L|b|j)+(i>>>j)<<2)>>2]|0;i=(c[j+4>>2]&-8)-o|0;b=j;while(1){a=c[b+16>>2]|0;if(!a){a=c[b+20>>2]|0;if(!a)break}b=(c[a+4>>2]&-8)-o|0;L=b>>>0<i>>>0;i=L?b:i;b=a;j=L?a:j}f=c[61]|0;if(j>>>0<f>>>0)ga();h=j+o|0;if(j>>>0>=h>>>0)ga();g=c[j+24>>2]|0;d=c[j+12>>2]|0;do{if((d|0)==(j|0)){b=j+20|0;a=c[b>>2]|0;if(!a){b=j+16|0;a=c[b>>2]|0;if(!a){n=0;break}}while(1){d=a+20|0;e=c[d>>2]|0;if(e){a=e;b=d;continue}d=a+16|0;e=c[d>>2]|0;if(!e)break;else{a=e;b=d}}if(b>>>0<f>>>0)ga();else{c[b>>2]=0;n=a;break}}else{e=c[j+8>>2]|0;if(e>>>0<f>>>0)ga();a=e+12|0;if((c[a>>2]|0)!=(j|0))ga();b=d+8|0;if((c[b>>2]|0)==(j|0)){c[a>>2]=d;c[b>>2]=e;n=d;break}else ga()}}while(0);do{if(g){a=c[j+28>>2]|0;b=532+(a<<2)|0;if((j|0)==(c[b>>2]|0)){c[b>>2]=n;if(!n){c[58]=c[58]&~(1<<a);break}}else{if(g>>>0<(c[61]|0)>>>0)ga();a=g+16|0;if((c[a>>2]|0)==(j|0))c[a>>2]=n;else c[g+20>>2]=n;if(!n)break}b=c[61]|0;if(n>>>0<b>>>0)ga();c[n+24>>2]=g;a=c[j+16>>2]|0;do{if(a)if(a>>>0<b>>>0)ga();else{c[n+16>>2]=a;c[a+24>>2]=n;break}}while(0);a=c[j+20>>2]|0;if(a)if(a>>>0<(c[61]|0)>>>0)ga();else{c[n+20>>2]=a;c[a+24>>2]=n;break}}}while(0);if(i>>>0<16){L=i+o|0;c[j+4>>2]=L|3;L=j+(L+4)|0;c[L>>2]=c[L>>2]|1}else{c[j+4>>2]=o|3;c[j+(o|4)>>2]=i|1;c[j+(i+o)>>2]=i;a=c[59]|0;if(a){f=c[62]|0;d=a>>>3;a=d<<1;e=268+(a<<2)|0;b=c[57]|0;d=1<<d;if(b&d){a=268+(a+2<<2)|0;b=c[a>>2]|0;if(b>>>0<(c[61]|0)>>>0)ga();else{p=a;q=b}}else{c[57]=b|d;p=268+(a+2<<2)|0;q=e}c[p>>2]=f;c[q+12>>2]=f;c[f+8>>2]=q;c[f+12>>2]=e}c[59]=i;c[62]=h}L=j+8|0;return L|0}}}else if(a>>>0<=4294967231){a=a+11|0;o=a&-8;j=c[58]|0;if(j){b=0-o|0;a=a>>>8;if(a)if(o>>>0>16777215)i=31;else{q=(a+1048320|0)>>>16&8;x=a<<q;p=(x+520192|0)>>>16&4;x=x<<p;i=(x+245760|0)>>>16&2;i=14-(p|q|i)+(x<<i>>>15)|0;i=o>>>(i+7|0)&1|i<<1}else i=0;a=c[532+(i<<2)>>2]|0;a:do{if(!a){d=0;a=0;x=86}else{f=b;d=0;g=o<<((i|0)==31?0:25-(i>>>1)|0);h=a;a=0;while(1){e=c[h+4>>2]&-8;b=e-o|0;if(b>>>0<f>>>0)if((e|0)==(o|0)){e=h;a=h;x=90;break a}else a=h;else b=f;x=c[h+20>>2]|0;h=c[h+16+(g>>>31<<2)>>2]|0;d=(x|0)==0|(x|0)==(h|0)?d:x;if(!h){x=86;break}else{f=b;g=g<<1}}}}while(0);if((x|0)==86){if((d|0)==0&(a|0)==0){a=2<<i;a=j&(a|0-a);if(!a)break;a=(a&0-a)+-1|0;n=a>>>12&16;a=a>>>n;m=a>>>5&8;a=a>>>m;p=a>>>2&4;a=a>>>p;q=a>>>1&2;a=a>>>q;d=a>>>1&1;d=c[532+((m|n|p|q|d)+(a>>>d)<<2)>>2]|0;a=0}if(!d){i=b;j=a}else{e=d;x=90}}if((x|0)==90)while(1){x=0;q=(c[e+4>>2]&-8)-o|0;d=q>>>0<b>>>0;b=d?q:b;a=d?e:a;d=c[e+16>>2]|0;if(d){e=d;x=90;continue}e=c[e+20>>2]|0;if(!e){i=b;j=a;break}else x=90}if((j|0)!=0?i>>>0<((c[59]|0)-o|0)>>>0:0){f=c[61]|0;if(j>>>0<f>>>0)ga();h=j+o|0;if(j>>>0>=h>>>0)ga();g=c[j+24>>2]|0;d=c[j+12>>2]|0;do{if((d|0)==(j|0)){b=j+20|0;a=c[b>>2]|0;if(!a){b=j+16|0;a=c[b>>2]|0;if(!a){s=0;break}}while(1){d=a+20|0;e=c[d>>2]|0;if(e){a=e;b=d;continue}d=a+16|0;e=c[d>>2]|0;if(!e)break;else{a=e;b=d}}if(b>>>0<f>>>0)ga();else{c[b>>2]=0;s=a;break}}else{e=c[j+8>>2]|0;if(e>>>0<f>>>0)ga();a=e+12|0;if((c[a>>2]|0)!=(j|0))ga();b=d+8|0;if((c[b>>2]|0)==(j|0)){c[a>>2]=d;c[b>>2]=e;s=d;break}else ga()}}while(0);do{if(g){a=c[j+28>>2]|0;b=532+(a<<2)|0;if((j|0)==(c[b>>2]|0)){c[b>>2]=s;if(!s){c[58]=c[58]&~(1<<a);break}}else{if(g>>>0<(c[61]|0)>>>0)ga();a=g+16|0;if((c[a>>2]|0)==(j|0))c[a>>2]=s;else c[g+20>>2]=s;if(!s)break}b=c[61]|0;if(s>>>0<b>>>0)ga();c[s+24>>2]=g;a=c[j+16>>2]|0;do{if(a)if(a>>>0<b>>>0)ga();else{c[s+16>>2]=a;c[a+24>>2]=s;break}}while(0);a=c[j+20>>2]|0;if(a)if(a>>>0<(c[61]|0)>>>0)ga();else{c[s+20>>2]=a;c[a+24>>2]=s;break}}}while(0);b:do{if(i>>>0>=16){c[j+4>>2]=o|3;c[j+(o|4)>>2]=i|1;c[j+(i+o)>>2]=i;a=i>>>3;if(i>>>0<256){b=a<<1;e=268+(b<<2)|0;d=c[57]|0;a=1<<a;if(d&a){a=268+(b+2<<2)|0;b=c[a>>2]|0;if(b>>>0<(c[61]|0)>>>0)ga();else{t=a;u=b}}else{c[57]=d|a;t=268+(b+2<<2)|0;u=e}c[t>>2]=h;c[u+12>>2]=h;c[j+(o+8)>>2]=u;c[j+(o+12)>>2]=e;break}a=i>>>8;if(a)if(i>>>0>16777215)e=31;else{K=(a+1048320|0)>>>16&8;L=a<<K;J=(L+520192|0)>>>16&4;L=L<<J;e=(L+245760|0)>>>16&2;e=14-(J|K|e)+(L<<e>>>15)|0;e=i>>>(e+7|0)&1|e<<1}else e=0;a=532+(e<<2)|0;c[j+(o+28)>>2]=e;c[j+(o+20)>>2]=0;c[j+(o+16)>>2]=0;b=c[58]|0;d=1<<e;if(!(b&d)){c[58]=b|d;c[a>>2]=h;c[j+(o+24)>>2]=a;c[j+(o+12)>>2]=h;c[j+(o+8)>>2]=h;break}a=c[a>>2]|0;c:do{if((c[a+4>>2]&-8|0)!=(i|0)){e=i<<((e|0)==31?0:25-(e>>>1)|0);while(1){d=a+16+(e>>>31<<2)|0;b=c[d>>2]|0;if(!b)break;if((c[b+4>>2]&-8|0)==(i|0)){w=b;break c}else{e=e<<1;a=b}}if(d>>>0<(c[61]|0)>>>0)ga();else{c[d>>2]=h;c[j+(o+24)>>2]=a;c[j+(o+12)>>2]=h;c[j+(o+8)>>2]=h;break b}}else w=a}while(0);a=w+8|0;b=c[a>>2]|0;L=c[61]|0;if(b>>>0>=L>>>0&w>>>0>=L>>>0){c[b+12>>2]=h;c[a>>2]=h;c[j+(o+8)>>2]=b;c[j+(o+12)>>2]=w;c[j+(o+24)>>2]=0;break}else ga()}else{L=i+o|0;c[j+4>>2]=L|3;L=j+(L+4)|0;c[L>>2]=c[L>>2]|1}}while(0);L=j+8|0;return L|0}}}else o=-1}while(0);d=c[59]|0;if(d>>>0>=o>>>0){a=d-o|0;b=c[62]|0;if(a>>>0>15){c[62]=b+o;c[59]=a;c[b+(o+4)>>2]=a|1;c[b+d>>2]=a;c[b+4>>2]=o|3}else{c[59]=0;c[62]=0;c[b+4>>2]=d|3;L=b+(d+4)|0;c[L>>2]=c[L>>2]|1}L=b+8|0;return L|0}a=c[60]|0;if(a>>>0>o>>>0){K=a-o|0;c[60]=K;L=c[63]|0;c[63]=L+o;c[L+(o+4)>>2]=K|1;c[L+4>>2]=o|3;L=L+8|0;return L|0}do{if(!(c[175]|0)){a=ea(30)|0;if(!(a+-1&a)){c[177]=a;c[176]=a;c[178]=-1;c[179]=-1;c[180]=0;c[168]=0;c[175]=(ja(0)|0)&-16^1431655768;break}else ga()}}while(0);g=o+48|0;f=c[177]|0;h=o+47|0;e=f+h|0;f=0-f|0;i=e&f;if(i>>>0<=o>>>0){L=0;return L|0}a=c[167]|0;if((a|0)!=0?(u=c[165]|0,w=u+i|0,w>>>0<=u>>>0|w>>>0>a>>>0):0){L=0;return L|0}d:do{if(!(c[168]&4)){d=c[63]|0;e:do{if(d){a=676;while(1){b=c[a>>2]|0;if(b>>>0<=d>>>0?(r=a+4|0,(b+(c[r>>2]|0)|0)>>>0>d>>>0):0)break;a=c[a+8>>2]|0;if(!a){x=174;break e}}b=e-(c[60]|0)&f;if(b>>>0<2147483647){d=ia(b|0)|0;w=(d|0)==((c[a>>2]|0)+(c[r>>2]|0)|0);a=w?b:0;if(w){if((d|0)!=(-1|0)){r=d;q=a;x=194;break d}}else x=184}else a=0}else x=174}while(0);do{if((x|0)==174){e=ia(0)|0;if((e|0)!=(-1|0)){a=e;b=c[176]|0;d=b+-1|0;if(!(d&a))b=i;else b=i-a+(d+a&0-b)|0;a=c[165]|0;d=a+b|0;if(b>>>0>o>>>0&b>>>0<2147483647){w=c[167]|0;if((w|0)!=0?d>>>0<=a>>>0|d>>>0>w>>>0:0){a=0;break}d=ia(b|0)|0;x=(d|0)==(e|0);a=x?b:0;if(x){r=e;q=a;x=194;break d}else x=184}else a=0}else a=0}}while(0);f:do{if((x|0)==184){e=0-b|0;do{if(g>>>0>b>>>0&(b>>>0<2147483647&(d|0)!=(-1|0))?(v=c[177]|0,v=h-b+v&0-v,v>>>0<2147483647):0)if((ia(v|0)|0)==(-1|0)){ia(e|0)|0;break f}else{b=v+b|0;break}}while(0);if((d|0)!=(-1|0)){r=d;q=b;x=194;break d}}}while(0);c[168]=c[168]|4;x=191}else{a=0;x=191}}while(0);if((((x|0)==191?i>>>0<2147483647:0)?(y=ia(i|0)|0,z=ia(0)|0,y>>>0<z>>>0&((y|0)!=(-1|0)&(z|0)!=(-1|0))):0)?(A=z-y|0,B=A>>>0>(o+40|0)>>>0,B):0){r=y;q=B?A:a;x=194}if((x|0)==194){a=(c[165]|0)+q|0;c[165]=a;if(a>>>0>(c[166]|0)>>>0)c[166]=a;h=c[63]|0;g:do{if(h){f=676;while(1){a=c[f>>2]|0;b=f+4|0;d=c[b>>2]|0;if((r|0)==(a+d|0)){x=204;break}e=c[f+8>>2]|0;if(!e)break;else f=e}if(((x|0)==204?(c[f+12>>2]&8|0)==0:0)?h>>>0<r>>>0&h>>>0>=a>>>0:0){c[b>>2]=d+q;L=(c[60]|0)+q|0;K=h+8|0;K=(K&7|0)==0?0:0-K&7;J=L-K|0;c[63]=h+K;c[60]=J;c[h+(K+4)>>2]=J|1;c[h+(L+4)>>2]=40;c[64]=c[179];break}a=c[61]|0;if(r>>>0<a>>>0){c[61]=r;j=r}else j=a;b=r+q|0;a=676;while(1){if((c[a>>2]|0)==(b|0)){x=212;break}a=c[a+8>>2]|0;if(!a){b=676;break}}if((x|0)==212)if(!(c[a+12>>2]&8)){c[a>>2]=r;n=a+4|0;c[n>>2]=(c[n>>2]|0)+q;n=r+8|0;n=(n&7|0)==0?0:0-n&7;k=r+(q+8)|0;k=(k&7|0)==0?0:0-k&7;a=r+(k+q)|0;m=n+o|0;p=r+m|0;l=a-(r+n)-o|0;c[r+(n+4)>>2]=o|3;h:do{if((a|0)!=(h|0)){if((a|0)==(c[62]|0)){L=(c[59]|0)+l|0;c[59]=L;c[62]=p;c[r+(m+4)>>2]=L|1;c[r+(L+m)>>2]=L;break}h=q+4|0;b=c[r+(h+k)>>2]|0;if((b&3|0)==1){i=b&-8;f=b>>>3;i:do{if(b>>>0>=256){g=c[r+((k|24)+q)>>2]|0;e=c[r+(q+12+k)>>2]|0;do{if((e|0)==(a|0)){d=k|16;e=r+(h+d)|0;b=c[e>>2]|0;if(!b){d=r+(d+q)|0;b=c[d>>2]|0;if(!b){I=0;break}}else d=e;while(1){e=b+20|0;f=c[e>>2]|0;if(f){b=f;d=e;continue}e=b+16|0;f=c[e>>2]|0;if(!f)break;else{b=f;d=e}}if(d>>>0<j>>>0)ga();else{c[d>>2]=0;I=b;break}}else{f=c[r+((k|8)+q)>>2]|0;if(f>>>0<j>>>0)ga();b=f+12|0;if((c[b>>2]|0)!=(a|0))ga();d=e+8|0;if((c[d>>2]|0)==(a|0)){c[b>>2]=e;c[d>>2]=f;I=e;break}else ga()}}while(0);if(!g)break;b=c[r+(q+28+k)>>2]|0;d=532+(b<<2)|0;do{if((a|0)!=(c[d>>2]|0)){if(g>>>0<(c[61]|0)>>>0)ga();b=g+16|0;if((c[b>>2]|0)==(a|0))c[b>>2]=I;else c[g+20>>2]=I;if(!I)break i}else{c[d>>2]=I;if(I)break;c[58]=c[58]&~(1<<b);break i}}while(0);d=c[61]|0;if(I>>>0<d>>>0)ga();c[I+24>>2]=g;a=k|16;b=c[r+(a+q)>>2]|0;do{if(b)if(b>>>0<d>>>0)ga();else{c[I+16>>2]=b;c[b+24>>2]=I;break}}while(0);a=c[r+(h+a)>>2]|0;if(!a)break;if(a>>>0<(c[61]|0)>>>0)ga();else{c[I+20>>2]=a;c[a+24>>2]=I;break}}else{d=c[r+((k|8)+q)>>2]|0;e=c[r+(q+12+k)>>2]|0;b=268+(f<<1<<2)|0;do{if((d|0)!=(b|0)){if(d>>>0<j>>>0)ga();if((c[d+12>>2]|0)==(a|0))break;ga()}}while(0);if((e|0)==(d|0)){c[57]=c[57]&~(1<<f);break}do{if((e|0)==(b|0))E=e+8|0;else{if(e>>>0<j>>>0)ga();b=e+8|0;if((c[b>>2]|0)==(a|0)){E=b;break}ga()}}while(0);c[d+12>>2]=e;c[E>>2]=d}}while(0);a=r+((i|k)+q)|0;f=i+l|0}else f=l;a=a+4|0;c[a>>2]=c[a>>2]&-2;c[r+(m+4)>>2]=f|1;c[r+(f+m)>>2]=f;a=f>>>3;if(f>>>0<256){b=a<<1;e=268+(b<<2)|0;d=c[57]|0;a=1<<a;do{if(!(d&a)){c[57]=d|a;J=268+(b+2<<2)|0;K=e}else{a=268+(b+2<<2)|0;b=c[a>>2]|0;if(b>>>0>=(c[61]|0)>>>0){J=a;K=b;break}ga()}}while(0);c[J>>2]=p;c[K+12>>2]=p;c[r+(m+8)>>2]=K;c[r+(m+12)>>2]=e;break}a=f>>>8;do{if(!a)e=0;else{if(f>>>0>16777215){e=31;break}J=(a+1048320|0)>>>16&8;K=a<<J;I=(K+520192|0)>>>16&4;K=K<<I;e=(K+245760|0)>>>16&2;e=14-(I|J|e)+(K<<e>>>15)|0;e=f>>>(e+7|0)&1|e<<1}}while(0);a=532+(e<<2)|0;c[r+(m+28)>>2]=e;c[r+(m+20)>>2]=0;c[r+(m+16)>>2]=0;b=c[58]|0;d=1<<e;if(!(b&d)){c[58]=b|d;c[a>>2]=p;c[r+(m+24)>>2]=a;c[r+(m+12)>>2]=p;c[r+(m+8)>>2]=p;break}a=c[a>>2]|0;j:do{if((c[a+4>>2]&-8|0)!=(f|0)){e=f<<((e|0)==31?0:25-(e>>>1)|0);while(1){d=a+16+(e>>>31<<2)|0;b=c[d>>2]|0;if(!b)break;if((c[b+4>>2]&-8|0)==(f|0)){L=b;break j}else{e=e<<1;a=b}}if(d>>>0<(c[61]|0)>>>0)ga();else{c[d>>2]=p;c[r+(m+24)>>2]=a;c[r+(m+12)>>2]=p;c[r+(m+8)>>2]=p;break h}}else L=a}while(0);a=L+8|0;b=c[a>>2]|0;K=c[61]|0;if(b>>>0>=K>>>0&L>>>0>=K>>>0){c[b+12>>2]=p;c[a>>2]=p;c[r+(m+8)>>2]=b;c[r+(m+12)>>2]=L;c[r+(m+24)>>2]=0;break}else ga()}else{L=(c[60]|0)+l|0;c[60]=L;c[63]=p;c[r+(m+4)>>2]=L|1}}while(0);L=r+(n|8)|0;return L|0}else b=676;while(1){a=c[b>>2]|0;if(a>>>0<=h>>>0?(C=c[b+4>>2]|0,D=a+C|0,D>>>0>h>>>0):0)break;b=c[b+8>>2]|0}b=a+(C+-39)|0;b=a+(C+-47+((b&7|0)==0?0:0-b&7))|0;f=h+16|0;b=b>>>0<f>>>0?h:b;a=b+8|0;d=r+8|0;d=(d&7|0)==0?0:0-d&7;L=q+-40-d|0;c[63]=r+d;c[60]=L;c[r+(d+4)>>2]=L|1;c[r+(q+-36)>>2]=40;c[64]=c[179];d=b+4|0;c[d>>2]=27;c[a>>2]=c[169];c[a+4>>2]=c[170];c[a+8>>2]=c[171];c[a+12>>2]=c[172];c[169]=r;c[170]=q;c[172]=0;c[171]=a;a=b+28|0;c[a>>2]=7;if((b+32|0)>>>0<D>>>0)do{L=a;a=a+4|0;c[a>>2]=7}while((L+8|0)>>>0<D>>>0);if((b|0)!=(h|0)){g=b-h|0;c[d>>2]=c[d>>2]&-2;c[h+4>>2]=g|1;c[b>>2]=g;a=g>>>3;if(g>>>0<256){b=a<<1;e=268+(b<<2)|0;d=c[57]|0;a=1<<a;if(d&a){a=268+(b+2<<2)|0;b=c[a>>2]|0;if(b>>>0<(c[61]|0)>>>0)ga();else{F=a;G=b}}else{c[57]=d|a;F=268+(b+2<<2)|0;G=e}c[F>>2]=h;c[G+12>>2]=h;c[h+8>>2]=G;c[h+12>>2]=e;break}a=g>>>8;if(a)if(g>>>0>16777215)e=31;else{K=(a+1048320|0)>>>16&8;L=a<<K;J=(L+520192|0)>>>16&4;L=L<<J;e=(L+245760|0)>>>16&2;e=14-(J|K|e)+(L<<e>>>15)|0;e=g>>>(e+7|0)&1|e<<1}else e=0;d=532+(e<<2)|0;c[h+28>>2]=e;c[h+20>>2]=0;c[f>>2]=0;a=c[58]|0;b=1<<e;if(!(a&b)){c[58]=a|b;c[d>>2]=h;c[h+24>>2]=d;c[h+12>>2]=h;c[h+8>>2]=h;break}a=c[d>>2]|0;k:do{if((c[a+4>>2]&-8|0)!=(g|0)){e=g<<((e|0)==31?0:25-(e>>>1)|0);while(1){d=a+16+(e>>>31<<2)|0;b=c[d>>2]|0;if(!b)break;if((c[b+4>>2]&-8|0)==(g|0)){H=b;break k}else{e=e<<1;a=b}}if(d>>>0<(c[61]|0)>>>0)ga();else{c[d>>2]=h;c[h+24>>2]=a;c[h+12>>2]=h;c[h+8>>2]=h;break g}}else H=a}while(0);a=H+8|0;b=c[a>>2]|0;L=c[61]|0;if(b>>>0>=L>>>0&H>>>0>=L>>>0){c[b+12>>2]=h;c[a>>2]=h;c[h+8>>2]=b;c[h+12>>2]=H;c[h+24>>2]=0;break}else ga()}}else{L=c[61]|0;if((L|0)==0|r>>>0<L>>>0)c[61]=r;c[169]=r;c[170]=q;c[172]=0;c[66]=c[175];c[65]=-1;a=0;do{L=a<<1;K=268+(L<<2)|0;c[268+(L+3<<2)>>2]=K;c[268+(L+2<<2)>>2]=K;a=a+1|0}while((a|0)!=32);L=r+8|0;L=(L&7|0)==0?0:0-L&7;K=q+-40-L|0;c[63]=r+L;c[60]=K;c[r+(L+4)>>2]=K|1;c[r+(q+-36)>>2]=40;c[64]=c[179]}}while(0);a=c[60]|0;if(a>>>0>o>>>0){K=a-o|0;c[60]=K;L=c[63]|0;c[63]=L+o;c[L+(o+4)>>2]=K|1;c[L+4>>2]=o|3;L=L+8|0;return L|0}}if(!(c[45]|0))a=224;else a=c[(fa()|0)+60>>2]|0;c[a>>2]=12;L=0;return L|0}function $a(a){a=a|0;var b=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0;if(!a)return;b=a+-8|0;i=c[61]|0;if(b>>>0<i>>>0)ga();d=c[a+-4>>2]|0;e=d&3;if((e|0)==1)ga();o=d&-8;q=a+(o+-8)|0;do{if(!(d&1)){b=c[b>>2]|0;if(!e)return;j=-8-b|0;l=a+j|0;m=b+o|0;if(l>>>0<i>>>0)ga();if((l|0)==(c[62]|0)){b=a+(o+-4)|0;d=c[b>>2]|0;if((d&3|0)!=3){u=l;g=m;break}c[59]=m;c[b>>2]=d&-2;c[a+(j+4)>>2]=m|1;c[q>>2]=m;return}f=b>>>3;if(b>>>0<256){e=c[a+(j+8)>>2]|0;d=c[a+(j+12)>>2]|0;b=268+(f<<1<<2)|0;if((e|0)!=(b|0)){if(e>>>0<i>>>0)ga();if((c[e+12>>2]|0)!=(l|0))ga()}if((d|0)==(e|0)){c[57]=c[57]&~(1<<f);u=l;g=m;break}if((d|0)!=(b|0)){if(d>>>0<i>>>0)ga();b=d+8|0;if((c[b>>2]|0)==(l|0))h=b;else ga()}else h=d+8|0;c[e+12>>2]=d;c[h>>2]=e;u=l;g=m;break}h=c[a+(j+24)>>2]|0;e=c[a+(j+12)>>2]|0;do{if((e|0)==(l|0)){d=a+(j+20)|0;b=c[d>>2]|0;if(!b){d=a+(j+16)|0;b=c[d>>2]|0;if(!b){k=0;break}}while(1){e=b+20|0;f=c[e>>2]|0;if(f){b=f;d=e;continue}e=b+16|0;f=c[e>>2]|0;if(!f)break;else{b=f;d=e}}if(d>>>0<i>>>0)ga();else{c[d>>2]=0;k=b;break}}else{f=c[a+(j+8)>>2]|0;if(f>>>0<i>>>0)ga();b=f+12|0;if((c[b>>2]|0)!=(l|0))ga();d=e+8|0;if((c[d>>2]|0)==(l|0)){c[b>>2]=e;c[d>>2]=f;k=e;break}else ga()}}while(0);if(h){b=c[a+(j+28)>>2]|0;d=532+(b<<2)|0;if((l|0)==(c[d>>2]|0)){c[d>>2]=k;if(!k){c[58]=c[58]&~(1<<b);u=l;g=m;break}}else{if(h>>>0<(c[61]|0)>>>0)ga();b=h+16|0;if((c[b>>2]|0)==(l|0))c[b>>2]=k;else c[h+20>>2]=k;if(!k){u=l;g=m;break}}d=c[61]|0;if(k>>>0<d>>>0)ga();c[k+24>>2]=h;b=c[a+(j+16)>>2]|0;do{if(b)if(b>>>0<d>>>0)ga();else{c[k+16>>2]=b;c[b+24>>2]=k;break}}while(0);b=c[a+(j+20)>>2]|0;if(b)if(b>>>0<(c[61]|0)>>>0)ga();else{c[k+20>>2]=b;c[b+24>>2]=k;u=l;g=m;break}else{u=l;g=m}}else{u=l;g=m}}else{u=b;g=o}}while(0);if(u>>>0>=q>>>0)ga();b=a+(o+-4)|0;d=c[b>>2]|0;if(!(d&1))ga();if(!(d&2)){if((q|0)==(c[63]|0)){t=(c[60]|0)+g|0;c[60]=t;c[63]=u;c[u+4>>2]=t|1;if((u|0)!=(c[62]|0))return;c[62]=0;c[59]=0;return}if((q|0)==(c[62]|0)){t=(c[59]|0)+g|0;c[59]=t;c[62]=u;c[u+4>>2]=t|1;c[u+t>>2]=t;return}g=(d&-8)+g|0;f=d>>>3;do{if(d>>>0>=256){h=c[a+(o+16)>>2]|0;b=c[a+(o|4)>>2]|0;do{if((b|0)==(q|0)){d=a+(o+12)|0;b=c[d>>2]|0;if(!b){d=a+(o+8)|0;b=c[d>>2]|0;if(!b){p=0;break}}while(1){e=b+20|0;f=c[e>>2]|0;if(f){b=f;d=e;continue}e=b+16|0;f=c[e>>2]|0;if(!f)break;else{b=f;d=e}}if(d>>>0<(c[61]|0)>>>0)ga();else{c[d>>2]=0;p=b;break}}else{d=c[a+o>>2]|0;if(d>>>0<(c[61]|0)>>>0)ga();e=d+12|0;if((c[e>>2]|0)!=(q|0))ga();f=b+8|0;if((c[f>>2]|0)==(q|0)){c[e>>2]=b;c[f>>2]=d;p=b;break}else ga()}}while(0);if(h){b=c[a+(o+20)>>2]|0;d=532+(b<<2)|0;if((q|0)==(c[d>>2]|0)){c[d>>2]=p;if(!p){c[58]=c[58]&~(1<<b);break}}else{if(h>>>0<(c[61]|0)>>>0)ga();b=h+16|0;if((c[b>>2]|0)==(q|0))c[b>>2]=p;else c[h+20>>2]=p;if(!p)break}d=c[61]|0;if(p>>>0<d>>>0)ga();c[p+24>>2]=h;b=c[a+(o+8)>>2]|0;do{if(b)if(b>>>0<d>>>0)ga();else{c[p+16>>2]=b;c[b+24>>2]=p;break}}while(0);b=c[a+(o+12)>>2]|0;if(b)if(b>>>0<(c[61]|0)>>>0)ga();else{c[p+20>>2]=b;c[b+24>>2]=p;break}}}else{e=c[a+o>>2]|0;d=c[a+(o|4)>>2]|0;b=268+(f<<1<<2)|0;if((e|0)!=(b|0)){if(e>>>0<(c[61]|0)>>>0)ga();if((c[e+12>>2]|0)!=(q|0))ga()}if((d|0)==(e|0)){c[57]=c[57]&~(1<<f);break}if((d|0)!=(b|0)){if(d>>>0<(c[61]|0)>>>0)ga();b=d+8|0;if((c[b>>2]|0)==(q|0))n=b;else ga()}else n=d+8|0;c[e+12>>2]=d;c[n>>2]=e}}while(0);c[u+4>>2]=g|1;c[u+g>>2]=g;if((u|0)==(c[62]|0)){c[59]=g;return}}else{c[b>>2]=d&-2;c[u+4>>2]=g|1;c[u+g>>2]=g}b=g>>>3;if(g>>>0<256){d=b<<1;f=268+(d<<2)|0;e=c[57]|0;b=1<<b;if(e&b){b=268+(d+2<<2)|0;d=c[b>>2]|0;if(d>>>0<(c[61]|0)>>>0)ga();else{r=b;s=d}}else{c[57]=e|b;r=268+(d+2<<2)|0;s=f}c[r>>2]=u;c[s+12>>2]=u;c[u+8>>2]=s;c[u+12>>2]=f;return}b=g>>>8;if(b)if(g>>>0>16777215)f=31;else{r=(b+1048320|0)>>>16&8;s=b<<r;q=(s+520192|0)>>>16&4;s=s<<q;f=(s+245760|0)>>>16&2;f=14-(q|r|f)+(s<<f>>>15)|0;f=g>>>(f+7|0)&1|f<<1}else f=0;b=532+(f<<2)|0;c[u+28>>2]=f;c[u+20>>2]=0;c[u+16>>2]=0;d=c[58]|0;e=1<<f;a:do{if(d&e){b=c[b>>2]|0;b:do{if((c[b+4>>2]&-8|0)!=(g|0)){f=g<<((f|0)==31?0:25-(f>>>1)|0);while(1){e=b+16+(f>>>31<<2)|0;d=c[e>>2]|0;if(!d)break;if((c[d+4>>2]&-8|0)==(g|0)){t=d;break b}else{f=f<<1;b=d}}if(e>>>0<(c[61]|0)>>>0)ga();else{c[e>>2]=u;c[u+24>>2]=b;c[u+12>>2]=u;c[u+8>>2]=u;break a}}else t=b}while(0);b=t+8|0;d=c[b>>2]|0;s=c[61]|0;if(d>>>0>=s>>>0&t>>>0>=s>>>0){c[d+12>>2]=u;c[b>>2]=u;c[u+8>>2]=d;c[u+12>>2]=t;c[u+24>>2]=0;break}else ga()}else{c[58]=d|e;c[b>>2]=u;c[u+24>>2]=b;c[u+12>>2]=u;c[u+8>>2]=u}}while(0);u=(c[65]|0)+-1|0;c[65]=u;if(!u)b=684;else return;while(1){b=c[b>>2]|0;if(!b)break;else b=b+8|0}c[65]=-1;return}function ab(){}function bb(a,b,c,d){a=a|0;b=b|0;c=c|0;d=d|0;d=b-d-(c>>>0>a>>>0|0)>>>0;return(C=d,a-c>>>0|0)|0}function cb(a,b,c,d){a=a|0;b=b|0;c=c|0;d=d|0;c=a+c>>>0;return(C=b+d+(c>>>0<a>>>0|0)>>>0,c|0)|0}function db(b,d,e){b=b|0;d=d|0;e=e|0;var f=0,g=0,h=0,i=0;f=b+e|0;if((e|0)>=20){d=d&255;h=b&3;i=d|d<<8|d<<16|d<<24;g=f&~3;if(h){h=b+4-h|0;while((b|0)<(h|0)){a[b>>0]=d;b=b+1|0}}while((b|0)<(g|0)){c[b>>2]=i;b=b+4|0}}while((b|0)<(f|0)){a[b>>0]=d;b=b+1|0}return b-e|0}function eb(a,b,c){a=a|0;b=b|0;c=c|0;if((c|0)<32){C=b>>>c;return a>>>c|(b&(1<<c)-1)<<32-c}C=0;return b>>>c-32|0}function fb(a,b,c){a=a|0;b=b|0;c=c|0;if((c|0)<32){C=b<<c|(a&(1<<c)-1<<32-c)>>>32-c;return a<<c}C=a<<c-32;return 0}function gb(b,d,e){b=b|0;d=d|0;e=e|0;var f=0;if((e|0)>=4096)return ka(b|0,d|0,e|0)|0;f=b|0;if((b&3)==(d&3)){while(b&3){if(!e)return f|0;a[b>>0]=a[d>>0]|0;b=b+1|0;d=d+1|0;e=e-1|0}while((e|0)>=4){c[b>>2]=c[d>>2];b=b+4|0;d=d+4|0;e=e-4|0}}while((e|0)>0){a[b>>0]=a[d>>0]|0;b=b+1|0;d=d+1|0;e=e-1|0}return f|0}function hb(b,c,d){b=b|0;c=c|0;d=d|0;var e=0;if((c|0)<(b|0)&(b|0)<(c+d|0)){e=b;c=c+d|0;b=b+d|0;while((d|0)>0){b=b-1|0;c=c-1|0;d=d-1|0;a[b>>0]=a[c>>0]|0}b=e}else gb(b,c,d)|0;return b|0}function ib(b){b=b|0;var c=0;c=a[m+(b&255)>>0]|0;if((c|0)<8)return c|0;c=a[m+(b>>8&255)>>0]|0;if((c|0)<8)return c+8|0;c=a[m+(b>>16&255)>>0]|0;if((c|0)<8)return c+16|0;return(a[m+(b>>>24)>>0]|0)+24|0}function jb(a,b,c){a=a|0;b=b|0;c=c|0;if((c|0)<32){C=b>>c;return a>>>c|(b&(1<<c)-1)<<32-c}C=(b|0)<0?-1:0;return b>>c-32|0}function kb(a,b){a=a|0;b=b|0;var c=0,d=0,e=0,f=0;f=a&65535;e=b&65535;c=_(e,f)|0;d=a>>>16;a=(c>>>16)+(_(e,d)|0)|0;e=b>>>16;b=_(e,f)|0;return(C=(a>>>16)+(_(e,d)|0)+(((a&65535)+b|0)>>>16)|0,a+b<<16|c&65535|0)|0}function lb(a,b,c,d){a=a|0;b=b|0;c=c|0;d=d|0;var e=0,f=0,g=0,h=0,i=0,j=0;j=b>>31|((b|0)<0?-1:0)<<1;i=((b|0)<0?-1:0)>>31|((b|0)<0?-1:0)<<1;f=d>>31|((d|0)<0?-1:0)<<1;e=((d|0)<0?-1:0)>>31|((d|0)<0?-1:0)<<1;h=bb(j^a,i^b,j,i)|0;g=C;a=f^j;b=e^i;return bb((qb(h,g,bb(f^c,e^d,f,e)|0,C,0)|0)^a,C^b,a,b)|0}function mb(a,b,d,e){a=a|0;b=b|0;d=d|0;e=e|0;var f=0,g=0,h=0,j=0,k=0,l=0;f=i;i=i+16|0;j=f|0;h=b>>31|((b|0)<0?-1:0)<<1;g=((b|0)<0?-1:0)>>31|((b|0)<0?-1:0)<<1;l=e>>31|((e|0)<0?-1:0)<<1;k=((e|0)<0?-1:0)>>31|((e|0)<0?-1:0)<<1;a=bb(h^a,g^b,h,g)|0;b=C;qb(a,b,bb(l^d,k^e,l,k)|0,C,j)|0;e=bb(c[j>>2]^h,c[j+4>>2]^g,h,g)|0;d=C;i=f;return(C=d,e)|0}function nb(a,b,c,d){a=a|0;b=b|0;c=c|0;d=d|0;var e=0,f=0;e=a;f=c;c=kb(e,f)|0;a=C;return(C=(_(b,f)|0)+(_(d,e)|0)+a|a&0,c|0|0)|0}function ob(a,b,c,d){a=a|0;b=b|0;c=c|0;d=d|0;return qb(a,b,c,d,0)|0}function pb(a,b,d,e){a=a|0;b=b|0;d=d|0;e=e|0;var f=0,g=0;g=i;i=i+16|0;f=g|0;qb(a,b,d,e,f)|0;i=g;return(C=c[f+4>>2]|0,c[f>>2]|0)|0}function qb(a,b,d,e,f){a=a|0;b=b|0;d=d|0;e=e|0;f=f|0;var g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0;l=a;j=b;k=j;h=d;n=e;i=n;if(!k){g=(f|0)!=0;if(!i){if(g){c[f>>2]=(l>>>0)%(h>>>0);c[f+4>>2]=0}n=0;f=(l>>>0)/(h>>>0)>>>0;return(C=n,f)|0}else{if(!g){n=0;f=0;return(C=n,f)|0}c[f>>2]=a|0;c[f+4>>2]=b&0;n=0;f=0;return(C=n,f)|0}}g=(i|0)==0;do{if(h){if(!g){g=(aa(i|0)|0)-(aa(k|0)|0)|0;if(g>>>0<=31){m=g+1|0;i=31-g|0;b=g-31>>31;h=m;a=l>>>(m>>>0)&b|k<<i;b=k>>>(m>>>0)&b;g=0;i=l<<i;break}if(!f){n=0;f=0;return(C=n,f)|0}c[f>>2]=a|0;c[f+4>>2]=j|b&0;n=0;f=0;return(C=n,f)|0}g=h-1|0;if(g&h){i=(aa(h|0)|0)+33-(aa(k|0)|0)|0;p=64-i|0;m=32-i|0;j=m>>31;o=i-32|0;b=o>>31;h=i;a=m-1>>31&k>>>(o>>>0)|(k<<m|l>>>(i>>>0))&b;b=b&k>>>(i>>>0);g=l<<p&j;i=(k<<p|l>>>(o>>>0))&j|l<<m&i-33>>31;break}if(f){c[f>>2]=g&l;c[f+4>>2]=0}if((h|0)==1){o=j|b&0;p=a|0|0;return(C=o,p)|0}else{p=ib(h|0)|0;o=k>>>(p>>>0)|0;p=k<<32-p|l>>>(p>>>0)|0;return(C=o,p)|0}}else{if(g){if(f){c[f>>2]=(k>>>0)%(h>>>0);c[f+4>>2]=0}o=0;p=(k>>>0)/(h>>>0)>>>0;return(C=o,p)|0}if(!l){if(f){c[f>>2]=0;c[f+4>>2]=(k>>>0)%(i>>>0)}o=0;p=(k>>>0)/(i>>>0)>>>0;return(C=o,p)|0}g=i-1|0;if(!(g&i)){if(f){c[f>>2]=a|0;c[f+4>>2]=g&k|b&0}o=0;p=k>>>((ib(i|0)|0)>>>0);return(C=o,p)|0}g=(aa(i|0)|0)-(aa(k|0)|0)|0;if(g>>>0<=30){b=g+1|0;i=31-g|0;h=b;a=k<<i|l>>>(b>>>0);b=k>>>(b>>>0);g=0;i=l<<i;break}if(!f){o=0;p=0;return(C=o,p)|0}c[f>>2]=a|0;c[f+4>>2]=j|b&0;o=0;p=0;return(C=o,p)|0}}while(0);if(!h){k=i;j=0;i=0}else{m=d|0|0;l=n|e&0;k=cb(m|0,l|0,-1,-1)|0;d=C;j=i;i=0;do{e=j;j=g>>>31|j<<1;g=i|g<<1;e=a<<1|e>>>31|0;n=a>>>31|b<<1|0;bb(k,d,e,n)|0;p=C;o=p>>31|((p|0)<0?-1:0)<<1;i=o&1;a=bb(e,n,o&m,(((p|0)<0?-1:0)>>31|((p|0)<0?-1:0)<<1)&l)|0;b=C;h=h-1|0}while((h|0)!=0);k=j;j=0}h=0;if(f){c[f>>2]=a;c[f+4>>2]=b}o=(g|0)>>>31|(k|h)<<1|(h<<1|g>>>31)&0|j;p=(g<<1|0>>>31)&-2|i;return(C=o,p)|0}function rb(a,b,c,d,e,f,g){a=a|0;b=b|0;c=c|0;d=d|0;e=e|0;f=f|0;g=g|0;return oa[a&7](b|0,c|0,d|0,e|0,f|0,g|0)|0}function sb(a,b,c,d,e,f){a=a|0;b=b|0;c=c|0;d=d|0;e=e|0;f=f|0;ba(0);return 0}var oa=[sb,Oa,Pa,Wa,Qa,Ta,Na,sb];return{_memmove:hb,_malloc:_a,_i64Subtract:bb,_free:$a,_memcpy:gb,_LZ4JS_compressBegin:Ba,_LZ4JS_freeCompressionContext:Aa,_LZ4JS_freeDecompressionContext:Fa,_memset:db,_llvm_cttz_i32:ib,_LZ4JS_init:ya,_i64Add:cb,_LZ4JS_compressEnd:Da,_LZ4JS_compressUpdate:Ca,_LZ4JS_decompress:Ga,_bitshift64Lshr:eb,_LZ4JS_createDecompressionContext:Ea,_LZ4JS_createCompressionContext:za,_bitshift64Shl:fb,runPostSets:ab,stackAlloc:pa,stackSave:qa,stackRestore:ra,establishStackSpace:sa,setThrew:ta,setTempRet0:wa,getTempRet0:xa,dynCall_iiiiiii:rb}}(c.W,c.X,buffer),Oa=c._LZ4JS_init=Z._LZ4JS_init,Ea=c._i64Subtract=Z._i64Subtract,Q=c._free=Z._free;c.runPostSets=Z.runPostSets;var Pa=c._LZ4JS_compressBegin=Z._LZ4JS_compressBegin,La=c._memmove=Z._memmove,Qa=c._LZ4JS_freeDecompressionContext=Z._LZ4JS_freeDecompressionContext,Ra=c._LZ4JS_decompress=Z._LZ4JS_decompress,Ga=c._memset=Z._memset,Sa=c._LZ4JS_compressUpdate=Z._LZ4JS_compressUpdate,Na=c._llvm_cttz_i32=Z._llvm_cttz_i32,O=c._malloc=Z._malloc,Fa=c._i64Add=Z._i64Add,Ta=c._LZ4JS_compressEnd=Z._LZ4JS_compressEnd,Ja=c._memcpy=Z._memcpy,Ua=c._LZ4JS_freeCompressionContext=Z._LZ4JS_freeCompressionContext,Ha=c._bitshift64Lshr=Z._bitshift64Lshr,Va=c._LZ4JS_createDecompressionContext=Z._LZ4JS_createDecompressionContext,Wa=c._LZ4JS_createCompressionContext=Z._LZ4JS_createCompressionContext,Ia=c._bitshift64Shl=Z._bitshift64Shl;function x(a){this.name="ExitStatus",this.message="Program terminated with exit("+a+")",this.status=a}c.dynCall_iiiiiii=Z.dynCall_iiiiiii,z.D=Z.stackAlloc,z.T=Z.stackSave,z.S=Z.stackRestore,z.pa=Z.establishStackSpace,z.ja=Z.setTempRet0,z.ha=Z.getTempRet0,x.prototype=Error(),x.prototype.constructor=x;var Xa=null;function Za(a){function b(){if(!c.calledRun&&(c.calledRun=!0,!F)){if(W||(W=!0,T(V)),T(xa),c.onRuntimeInitialized&&c.onRuntimeInitialized(),c._main&&$a&&c.callMain(a),c.postRun)for("function"==typeof c.postRun&&(c.postRun=[c.postRun]);c.postRun.length;){var b=c.postRun.shift();za.unshift(b)}T(za)}}if(a=a||c.arguments,null===Xa&&(Xa=Date.now()),c.preRun)for("function"==typeof c.preRun&&(c.preRun=[c.preRun]);c.preRun.length;)Aa();T(U),c.calledRun||(c.setStatus?(c.setStatus("Running..."),setTimeout((function(){setTimeout((function(){c.setStatus("")}),1),b()}),1)):b())}function Ya(a,b){if(!b||!c.noExitRuntime)throw!c.noExitRuntime&&(F=!0,y=void 0,T(ya),c.onExit)&&c.onExit(a),w?(process.stdout.once("drain",(function(){process.exit(a)})),console.log(" "),setTimeout((function(){process.exit(a)}),500)):aa&&"function"==typeof quit&&quit(a),new x(a)}c.callMain=c.na=function(a){function b(){for(var a=0;3>a;a++)e.push(0)}assert(!0,"cannot call main when async dependencies remain! (listen on __ATMAIN__)"),assert(0==U.length,"cannot call main when preRun functions remain to be called"),a=a||[],W||(W=!0,T(V));var d=a.length+1,e=[N(Ba(c.thisProgram),"i8",0)];b();for(var g=0;g<d-1;g+=1)e.push(N(Ba(a[g]),"i8",0)),b();e.push(0),e=N(e,"i32",0);try{Ya(c._main(d,e,0),!0)}catch(h){if(!(h instanceof x)){if("SimulateInfiniteLoop"!=h)throw h&&"object"==typeof h&&h.stack&&c.K("exception thrown: "+[h,h.stack]),h;c.noExitRuntime=!0}}},c.run=c.run=Za,c.exit=c.exit=Ya;var ab=[];function E(a){void 0!==a?(c.print(a),c.K(a),a=JSON.stringify(a)):a="",F=!0;var b="abort("+a+") at "+oa()+"\nIf this abort() is unexpected, build with -s ASSERTIONS=1 which can give more information.";throw ab&&ab.forEach((function(d){b=d(b,a)})),b}if(c.abort=c.abort=E,c.preInit)for("function"==typeof c.preInit&&(c.preInit=[c.preInit]);0<c.preInit.length;)c.preInit.pop()();var $a=!0;c.noInitialRun&&($a=!1),Za();var X={};(function(){function a(a){return Array.prototype.slice.call(arguments,1).forEach((function(b){null!=b&&"object"==typeof b&&Object.keys(b).forEach((function(d){a[d]=b[d]}))})),a}function b(a){var b,d,e=0;return b=a.map((function(a){return a.length})).reduce((function(a,b){return a+b}),0),d=new Uint8Array(b),a.forEach((function(a){d.set(a,e),e+=a.length})),d}function d(a){return function(b){var d=a.apply(null,arguments);return Buffer.isBuffer(b)?new Buffer(d.buffer,d.byteOffset,d.byteOffset+d.length):d}}function e(b){if(this.options=a({},p,b),this.g=Wa(this.options.Z,+this.options.Y,+this.options.ba,this.options.aa),!this.g)throw Error("LZ4JS_createCompressionContext");X[this.g]=this,this.n=null}function g(){if(this.p=Va(),!this.p)throw Error("LZ4JS_createDecompressionContext");X[this.p]=this}function k(a,b){e.call(this,b),this.src=a,this.offset=0,this.o=[],this.e=0}function h(a,d){var e=new k(a,d);return e.M(),e.$(),e.N(),b(e.o)}function f(a){g.call(this),this.src=a,this.offset=0,this.o=[],this.e=0}function u(a){var d=new f(a);return d.da(),d=b(d.o),a instanceof Uint8Array?d:new Buffer(d.buffer)}var m=this;"function"==typeof define&&define.amd?define("lz4",(function(){return m})):w&&(module.exports=m),Oa(),m.BLOCK_MAX_SIZE_64KB=4,m.BLOCK_MAX_SIZE_256KB=5,m.BLOCK_MAX_SIZE_1MB=6;var p={Z:m.BLOCK_MAX_SIZE_4MB=7,Y:!1,ba:!1,aa:0};e.prototype.M=function(){Pa(this.g)||this.k()},e.prototype.O=function(){Sa(this.g)||this.k()},e.prototype.N=function(){Ta(this.g),this.k()},e.prototype.k=function(){if(Ua(this.g),delete X[this.g],this.n)throw this.n},g.prototype.P=function(){Ra(this.p)||this.k()},g.prototype.k=function(){if(Qa(this.p),delete X[this.p],this.n)throw this.n},w&&function(){function b(a){e.call(this,a),f.call(this,this.options),this.R=!1,this.e=0,this.src=new Buffer(0),this.q=new Buffer(0)}function d(){g.call(this),f.call(this,{}),this.e=0,this.src=new Buffer(0),this.q=new Buffer(0)}var f=require("stream").Transform,h=require("util").inherits;h(b,f),a(b.prototype,e.prototype),b.prototype.u=function(a){return P.set(new Uint8Array(this.src.buffer,this.src.byteOffset,this.e),a),this.e},b.prototype.A=function(a,b){this.q=new Buffer(P.buffer).slice(a,a+b),this.push(new Buffer(this.q))},b.prototype._transform=function(a,b,d){try{var e;for(this.R||(this.M(),this.R=!0),e=0;e<a.length;e+=8192)this.e=Math.min(a.length-e,8192),this.src=a.slice(e,e+this.e),this.O();d()}catch(f){d(f)}},b.prototype._flush=function(a){try{this.N(),a()}catch(b){a(b)}},m.createCompressStream=function(a){return new b(a)},h(d,f),a(d.prototype,g.prototype),d.prototype.u=function(a){return P.set(new Uint8Array(this.src.buffer,this.src.byteOffset,this.e),a),this.e},d.prototype.A=function(a,b){this.q=new Buffer(P.buffer).slice(a,a+b),this.push(new Buffer(this.q))},d.prototype._transform=function(a,b,d){try{var e;for(e=0;e<a.length;e+=8192)this.e=Math.min(a.length-e,8192),this.src=a.slice(e,e+this.e),this.P();d()}catch(f){d(f)}},d.prototype._flush=function(a){this.k(),a()},m.createDecompressStream=function(){return new d}}(),a(k.prototype,e.prototype),k.prototype.A=function(a,b){this.o.push(new Uint8Array(P.subarray(a,a+b)))},k.prototype.u=function(a){return P.set(this.src.subarray(this.offset,this.offset+this.e),a),this.e},k.prototype.$=function(){for(;this.offset<this.src.length;this.offset+=8192)this.e=Math.min(this.src.length-this.offset,8192),this.O()},m.compress=w?d(h):h,a(f.prototype,g.prototype),f.prototype.A=function(a,b){this.o.push(new Uint8Array(P.subarray(a,a+b)))},f.prototype.u=function(a){return P.set(this.src.subarray(this.offset,this.offset+this.e),a),this.e},f.prototype.da=function(){for(;this.offset<this.src.length;this.offset+=8192)this.e=Math.min(this.src.length-this.offset,8192),this.P();this.k()},m.decompress=w?d(u):u}).call(this)}).call(lz4),function(i,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((i||self).preactSignalsCore={})}(this,(function(i){function t(){throw new Error("Cycle detected")}var n=Symbol.for("preact-signals");function o(){if(s>1)s--;else{for(var i,t=!1;void 0!==h;){var n=h;for(h=void 0,e++;void 0!==n;){var o=n.o;if(n.o=void 0,n.f&=-3,!(8&n.f)&&c(n))try{n.c()}catch(n){t||(i=n,t=!0)}n=o}}if(e=0,s--,t)throw i}}var r=void 0,f=0,h=void 0,s=0,e=0,v=0;function u(i){if(void 0!==r){var t=i.n;if(void 0===t||t.t!==r)return t={i:0,S:i,p:r.s,n:void 0,t:r,e:void 0,x:void 0,r:t},void 0!==r.s&&(r.s.n=t),r.s=t,i.n=t,32&r.f&&i.S(t),t;if(-1===t.i)return t.i=0,void 0!==t.n&&(t.n.p=t.p,void 0!==t.p&&(t.p.n=t.n),t.p=r.s,t.n=void 0,r.s.n=t,r.s=t),t}}function d(i){this.v=i,this.i=0,this.n=void 0,this.t=void 0}function c(i){for(var t=i.s;void 0!==t;t=t.n)if(t.S.i!==t.i||!t.S.h()||t.S.i!==t.i)return!0;return!1}function a(i){for(var t=i.s;void 0!==t;t=t.n){var n=t.S.n;if(void 0!==n&&(t.r=n),t.S.n=t,t.i=-1,void 0===t.n){i.s=t;break}}}function l(i){for(var t=i.s,n=void 0;void 0!==t;){var o=t.p;-1===t.i?(t.S.U(t),void 0!==o&&(o.n=t.n),void 0!==t.n&&(t.n.p=o)):n=t,t.S.n=t.r,void 0!==t.r&&(t.r=void 0),t=o}i.s=n}function y(i){d.call(this,void 0),this.x=i,this.s=void 0,this.g=v-1,this.f=4}function w(i){var t=i.u;if(i.u=void 0,"function"==typeof t){s++;var n=r;r=void 0;try{t()}catch(t){throw i.f&=-2,i.f|=8,p(i),t}finally{r=n,o()}}}function p(i){for(var t=i.s;void 0!==t;t=t.n)t.S.U(t);i.x=void 0,i.s=void 0,w(i)}function b(i){if(r!==this)throw new Error("Out-of-order effect");l(this),r=i,this.f&=-2,8&this.f&&p(this),o()}function g(i){this.x=i,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32}function _(i){var t=new g(i);try{t.c()}catch(i){throw t.d(),i}return t.d.bind(t)}d.prototype.brand=n,d.prototype.h=function(){return!0},d.prototype.S=function(i){this.t!==i&&void 0===i.e&&(i.x=this.t,void 0!==this.t&&(this.t.e=i),this.t=i)},d.prototype.U=function(i){if(void 0!==this.t){var t=i.e,n=i.x;void 0!==t&&(t.x=n,i.e=void 0),void 0!==n&&(n.e=t,i.x=void 0),i===this.t&&(this.t=n)}},d.prototype.subscribe=function(i){var t=this;return _((function(){var n=t.value,o=32&this.f;this.f&=-33;try{i(n)}finally{this.f|=o}}))},d.prototype.valueOf=function(){return this.value},d.prototype.toString=function(){return this.value+""},d.prototype.toJSON=function(){return this.value},d.prototype.peek=function(){return this.v},Object.defineProperty(d.prototype,"value",{get:function(){var i=u(this);return void 0!==i&&(i.i=this.i),this.v},set:function(i){if(r instanceof y&&function(){throw new Error("Computed cannot have side-effects")}(),i!==this.v){e>100&&t(),this.v=i,this.i++,v++,s++;try{for(var n=this.t;void 0!==n;n=n.x)n.t.N()}finally{o()}}}}),(y.prototype=new d).h=function(){if(this.f&=-3,1&this.f)return!1;if(32==(36&this.f))return!0;if(this.f&=-5,this.g===v)return!0;if(this.g=v,this.f|=1,this.i>0&&!c(this))return this.f&=-2,!0;var i=r;try{a(this),r=this;var t=this.x();(16&this.f||this.v!==t||0===this.i)&&(this.v=t,this.f&=-17,this.i++)}catch(i){this.v=i,this.f|=16,this.i++}return r=i,l(this),this.f&=-2,!0},y.prototype.S=function(i){if(void 0===this.t){this.f|=36;for(var t=this.s;void 0!==t;t=t.n)t.S.S(t)}d.prototype.S.call(this,i)},y.prototype.U=function(i){if(void 0!==this.t&&(d.prototype.U.call(this,i),void 0===this.t)){this.f&=-33;for(var t=this.s;void 0!==t;t=t.n)t.S.U(t)}},y.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var i=this.t;void 0!==i;i=i.x)i.t.N()}},y.prototype.peek=function(){if(this.h()||t(),16&this.f)throw this.v;return this.v},Object.defineProperty(y.prototype,"value",{get:function(){1&this.f&&t();var i=u(this);if(this.h(),void 0!==i&&(i.i=this.i),16&this.f)throw this.v;return this.v}}),g.prototype.c=function(){var i=this.S();try{if(8&this.f)return;if(void 0===this.x)return;var t=this.x();"function"==typeof t&&(this.u=t)}finally{i()}},g.prototype.S=function(){1&this.f&&t(),this.f|=1,this.f&=-9,w(this),a(this),s++;var i=r;return r=this,b.bind(this,i)},g.prototype.N=function(){2&this.f||(this.f|=2,this.o=h,h=this)},g.prototype.d=function(){this.f|=8,1&this.f||p(this)},i.Signal=d,i.batch=function(i){if(s>0)return i();s++;try{return i()}finally{o()}},i.computed=function(i){return new y(i)},i.effect=_,i.signal=function(i){return new d(i)},i.untracked=function(i){if(f>0)return i();var t=r;r=void 0,f++;try{return i()}finally{f--,r=t}}}));var hortis=fluid.registerNamespace("hortis");fluid.setLogging(!0),fluid.defaults("hortis.configHolder",{gradeNames:"fluid.component"}),fluid.defaults("hortis.sunburstLoader",{gradeNames:["fluid.viewComponent","fluid.resourceLoader","hortis.configHolder"],sunburstPixels:1002,markupTemplate:"%resourceBase/html/imerss-viz.html",phyloMap:"%resourceBase/json/phyloMap.json",resourceBase:"src/client",queryOnStartup:"",selectOnStartup:"",showObsListInTooltip:!0,gridResolution:void 0,friendlyNames:void 0,initialTab:"simpleChecklist",distributeOptions:{gridResolution:{source:"{that}.options.gridResolution",target:"{that hortis.quantiser}.options.model.longResolution"},friendlyNames:{source:"{that}.options.friendlyNames",target:"{that hortis.sunburst}.options.friendlyNames"},initialTab:{source:"{that}.options.initialTab",target:"{that hortis.imerssTabs}.options.model.selectedTab"}},resourceOptions:{terms:{resourceBase:"{that}.options.resourceBase"}},resources:{viz:{url:"{that}.options.vizFile",dataType:"binary",options:{processData:!1,responseType:"arraybuffer"}},markup:{url:"{that}.options.markupTemplate",dataType:"text"},phyloMap:{url:"{that}.options.phyloMap",dataType:"json"}},invokers:{resolveColourStrategy:"hortis.resolveColourStrategy({that}.options.colourCount)"},listeners:{"onResourcesLoaded.renderMarkup":{priority:"first",listener:"hortis.sunburstLoader.renderMarkup",args:["{that}.container","{that}.resources.markup.resourceText","{that}.options.renderMarkup",{sunburstPixels:"{that}.options.sunburstPixels"}]}},components:{sunburst:{type:"hortis.sunburst",createOnEvent:"onResourcesLoaded",options:{container:"{sunburstLoader}.container",gradeNames:"{sunburstLoader}.resolveColourStrategy",colourCount:"{sunburstLoader}.options.colourCount",culturalValues:"{sunburstLoader}.options.culturalValues",suppressObsAuthors:"{sunburstLoader}.options.suppressObsAuthors",queryOnStartup:"{sunburstLoader}.options.queryOnStartup",selectOnStartup:"{sunburstLoader}.options.selectOnStartup",members:{viz:"@expand:hortis.decompressLZ4({sunburstLoader}.resources.viz.resourceText)",tree:"{that}.viz.tree"},model:{commonNames:"{sunburstLoader}.options.commonNames",nativeDataOnly:"{sunburstLoader}.options.nativeDataOnly"}}}}}),hortis.resolveResources=function(resources,terms){return fluid.transform(resources,(function(oneResource){return fluid.extend(!0,{},oneResource,{url:fluid.stringTemplate(oneResource.url,terms)})}))},hortis.decompressLZ4=function(arrayBuffer){const uint8in=new Uint8Array(arrayBuffer),uint8out=lz4.decompress(uint8in),text=new TextDecoder("utf-8").decode(uint8out);return JSON.parse(text)},hortis.combineSelectors=function(){return fluid.makeArray(arguments).join(", ")},hortis.sunburstLoader.renderMarkup=function(container,template,renderMarkup,terms){if(renderMarkup){const rendered=fluid.stringTemplate(template,terms),root=document.createRange().createContextualFragment(rendered).firstElementChild;for(;root.firstChild;)container[0].appendChild(root.firstChild)}},hortis.colouringGrades={undocumentedCount:"fluid.component",observationCount:"hortis.sunburstWithObsColour"},hortis.resolveColourStrategy=function(countField){return hortis.colouringGrades[countField]},fluid.defaults("hortis.sunburstWithObsColour",{gradeNames:"fluid.component",invokers:{fillColourForRow:"hortis.obsColourForRow({that}.options.parsedColours, {arguments}.0, {that}.flatTree.0)"}}),fluid.defaults("hortis.imerssTabs",{gradeNames:"hortis.tabs",tabIds:{simpleChecklist:"fli-tab-simple-checklist",checklist:"fli-tab-checklist",sunburst:"fli-tab-sunburst"},model:{}}),fluid.defaults("hortis.layoutHolder",{gradeNames:"fluid.modelComponent",members:{taxonHistory:[]},events:{changeLayoutId:null},model:{rowFocus:{},layoutId:null,selectedId:null,hoverId:null,historyIndex:0},invokers:{filterEntries:"fluid.notImplemented"}}),fluid.defaults("hortis.withPanelLabel",{gradeNames:"fluid.viewComponent",selectors:{panelLabel:".imerss-panel-label"},model:{panelLabel:""},modelRelay:{panelLabel:{source:"panelLabel",target:"dom.panelLabel.text"}}}),fluid.defaults("hortis.sunburst",{gradeNames:["hortis.layoutHolder","hortis.withPanelLabel","fluid.viewComponent"],selectors:{panelLabel:"#fli-tab-sunburst .imerss-panel-label",svg:".imerss-svg",back:".imerss-back",tabs:".imerss-tabs",taxonDisplay:".imerss-taxonDisplay",autocomplete:".imerss-autocomplete",checklist:".imerss-full-checklist-holder",simpleChecklist:".imerss-simple-checklist-holder",segment:".imerss-segment",label:".imerss-label",phyloPic:".imerss-phyloPic"},styles:{segment:"imerss-segment",label:"imerss-label",phyloPic:"imerss-phyloPic",layoutRoot:"imerss-layoutRoot",labelPath:"imerss-labelPath",clickable:"imerss-clickable"},openTaxonPanels:{observationData:!0,media:!0},components:{autocomplete:{type:"hortis.autocomplete",options:{container:"{sunburst}.dom.autocomplete",id:"fli-imerss-autocomplete",listeners:{onConfirm:"hortis.confirmAutocomplete({sunburst}, {arguments}.0)"},invokers:{query:"hortis.queryAutocomplete({that}.lookupTaxon, {arguments}.0, {arguments}.1)",lookupTaxon:"{sunburst}.lookupTaxon({arguments}.0, {that}.options.maxSuggestions)",renderInputValue:"hortis.autocompleteInputForRow",renderSuggestion:"hortis.autocompleteSuggestionForRow"}}},tabs:{type:"hortis.imerssTabs",options:{container:"{sunburst}.dom.tabs",modelRelay:{sunburstVisible:{target:"{sunburst}.model.visible",func:tab=>"sunburst"===tab,args:"{tabs}.model.selectedTab"}}}},checklist:{type:"hortis.checklist",options:{container:"{sunburst}.dom.checklist"}},simpleChecklist:{type:"hortis.checklist",options:{container:"{sunburst}.dom.simpleChecklist",filterRanks:["phylum","class","order","family","species"]}}},colours:{lowColour:"#9ecae1",highColour:"#e7969c",unfocusedColour:"#ddd"},zoomDuration:1250,scaleConfig:{innerDepth:1/22,outerDepth:13/22,rootRadii:[3/22,3/22,3/22,13/22],maxNodes:200},parsedColours:"@expand:hortis.parseColours({that}.options.colours)",colourCount:"undocumentedCount",culturalValues:!0,friendlyNames:!1,suppressObsAuthors:!1,model:{scale:{left:0,right:0,radiusScale:[]},visible:!1,commonNames:!0,nativeDataOnly:!1},modelRelay:{isAtRoot:{target:"isAtRoot",func:"hortis.isAtRoot",args:["{that}","{that}.model.layoutId"]},backEnabled:{target:"dom.back.attr.aria-disabled",func:index=>index<2,args:"{that}.model.historyIndex"}},markup:{segmentHeader:'<g xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">',segment:'<path id="%id" d="%path" visibility="%visibility" class="%clazz" vector-effect="non-scaling-stroke" style="%style"></path>',label:'<path id="%labelPathId" d="%textPath" visibility="%labelVisibility" class="%labelPathClass" vector-effect="non-scaling-stroke"></path><text id="%labelId" dy="0.25em" class="%labelClass" visibility="%labelVisibility" style="%labelStyle"><textPath xlink:href="#%labelPathId" startOffset="50%" style="text-anchor: middle">%label</textPath></text>',phyloPic:'<image id="%phyloPicId" class="%phyloPicClass imerss-clickable" xlink:href="%phyloPicUrl" height="%picDiameter" width="%picDiameter" x="%phyloPicX" y="%phyloPicY" />',segmentFooter:"</g>",taxonDisplayHeader:"<div>",taxonDisplayRow:'<div %rootAttrs><span class="taxonDisplay-key">%key</span><span class="taxonDisplay-value %valueClazz">%value</span></div>',taxonDisplayFooter:"</div>"},events:{changeLayoutId:null,doLayout:null},invokers:{render:"hortis.render({that})",renderLight:"hortis.renderLight({that})",renderSegment:"hortis.renderSegment({that}, {arguments}.0)",angleScale:"hortis.angleScale({arguments}.0, {that}.model.scale)",segmentClicked:"hortis.segmentClicked({that}, {arguments}.0)",fillColourForRow:"hortis.undocColourForRow({that}.options.parsedColours, {arguments}.0)",getMousable:"hortis.combineSelectors({that}.options.selectors.segment, {that}.options.selectors.label, {that}.options.selectors.phyloPic)",lookupTaxon:"hortis.lookupTaxon({that}.entries, {arguments}.0, {arguments}.1)",applyPhyloMap:{funcName:"hortis.applyPhyloMap",args:["{sunburstLoader}.resources.phyloMap.parsed","{arguments}.0","{sunburstLoader}.options.resourceOptions.terms"]},filterEntries:"hortis.filterEntries({that}, {arguments}.0)"},modelListeners:{scale:{excludeSource:"init",func:"{that}.renderLight"},selectedId:[{namespace:"updateTaxonDisplay",excludeSource:"init",funcName:"hortis.updateTaxonDisplay",args:["{that}","{change}.value"]},{namespace:"renderLight",excludeSource:"init",func:"{that}.renderLight"}],hoverId:{excludeSource:"init",funcName:"hortis.updateTooltip",args:["{that}","{change}.value"]},rowFocus:{excludeSource:"init",funcName:"hortis.updateRowFocus",args:["{that}","{change}.value","{change}.transaction"]},backClick:{path:"dom.back.click",funcName:"hortis.backTaxon",args:["{that}"]},nativeDataOnly:{namespace:"computeSunburstEntries",funcName:"hortis.computeSunburstEntriesAndRender",args:"{that}"}},listeners:{"onCreate.doLayout":{func:"{that}.events.doLayout.fire"},"doLayout.impl":{func:"hortis.doLayout",args:["{that}.entries"]},"doLayout.computeInitialScale":{funcName:"hortis.computeInitialScale",args:["{that}"],priority:"after:doLayout"},"doLayout.boundNodes":{funcName:"hortis.boundNodes",args:["{that}","{that}.model.layoutId",!0],priority:"before:render"},"doLayout.render":{func:"{that}.render",priority:"after:computeInitialScale"},"onCreate.bindSunburstMouse":{funcName:"hortis.bindSunburstMouse",args:["{that}"]},"onCreate.bindRowExpander":{funcName:"hortis.bindRowExpander",args:["{that}"]},"changeLayoutId.updateModel":"hortis.changeLayoutId({that}, {arguments}.0, {arguments}.1)"},members:{visMap:[],tree:null,flatTree:"@expand:hortis.flattenTree({that}, {that}.tree)",index:"@expand:hortis.indexTree({that}.flatTree)"}}),hortis.capitalize=function(string){return string.charAt(0).toUpperCase()+string.slice(1)},hortis.autocompleteInputForRow=function(row){return row?hortis.labelForRow(row)+(row.commonName?" ("+row.commonName+")":""):row},hortis.autocompleteSuggestionForRow=function(row){return hortis.autocompleteInputForRow(row)+(row.childCount>1?" ("+row.childCount+" species)":"")},hortis.lookupTaxon=function(entries,query,maxSuggestions){maxSuggestions=maxSuggestions||1;const output=[];query=query.toLowerCase();for(let i=0;i<entries.length;++i){const row=entries[i].row;if(-1!==hortis.autocompleteInputForRow(row).toLowerCase().indexOf(query)&&output.push(row),output.length>=maxSuggestions)break}return 1===maxSuggestions?output[0]:output},hortis.queryAutocomplete=function(lookupTaxon,query,callback){callback(lookupTaxon(query))},hortis.confirmAutocomplete=function(that,row){row&&that.events.changeLayoutId.fire(row.id,"autocomplete")},hortis.rowToPhyloIndex=function(row){return row.rank+":"+row.iNaturalistTaxonName},hortis.colourChildren=function(row,parsed){row.lowColour=parsed.lowColour,row.highColour=parsed.highColour,row.children.forEach((function(child){hortis.colourChildren(child,parsed)}))},hortis.applyPhyloMap=function(phyloMap,rows,terms){const parsedMap=fluid.transform(phyloMap,(function(onePhylo){const togo={};if(onePhylo.pic&&(togo.phyloPicUrl=fluid.stringTemplate(onePhylo.pic,terms)),onePhylo.taxonPic&&(togo.taxonPic=fluid.stringTemplate(onePhylo.taxonPic,terms)),togo.taxonPicDescription=onePhylo.taxonPicDescription,onePhylo.colour){const parsedColour=fluid.colour.hexToArray(onePhylo.colour),hsl=fluid.colour.rgbToHsl(parsedColour);togo.lowColour=fluid.colour.hslToRgb([hsl[0],hsl[1],.2*hsl[2]+.8]),togo.highColour=fluid.colour.hslToRgb([hsl[0],hsl[1],.8*hsl[2]+.2])}return togo}));rows.forEach((function(row){const phyloIndex=hortis.rowToPhyloIndex(row),parsed=parsedMap[phyloIndex];parsed&&(row.phyloPicUrl=parsed.phyloPicUrl,row.taxonPic=parsed.taxonPic,row.taxonPicDescription=parsed.taxonPicDescription,hortis.colourChildren(row,parsed))}))},hortis.taxonDisplayLookup={iNaturalistTaxonName:"Taxon Name:",observationCount:"Observation Count:",iNaturalistObsLink:"Observation:",taxonLink:"iNaturalist Taxon:",commonName:"Common Name:",reportingStatus:"Status:",hulqName:"Hul'qumi'num name:",wikipediaSummary:"Wikipedia Summary",media:"Media",observationData:"Observation Data",iNaturalistTaxonImage:"iNaturalist Taxon Image:",phyloPic:"Taxon Icon:",taxonPic:"Taxon Picture:",taxonPicDescription:"Taxon Picture Description:"},hortis.friendlyDisplayLookup={...hortis.taxonDisplayLookup,iNaturalistTaxonName:"Species:"},hortis.commonFields=["commonName","wikipediaSummary"],hortis.dumpRow=function(key,value,markup,extraClazz,valueClazz,options){if(value){const toLook=options?.friendlyNames?hortis.friendlyDisplayLookup:hortis.taxonDisplayLookup,keyName=key?toLook[key]||hortis.capitalize(key):"";valueClazz=valueClazz||"";const openPanel=options?.openTaxonPanels[key],isRemainder=extraClazz&&extraClazz.includes("taxonDisplay-expandable-remainder"),clazz="taxonDisplay-row "+(extraClazz||"")+(openPanel?" taxonDisplay-expanded":" taxonDisplay-unexpanded");return fluid.stringTemplate(markup.taxonDisplayRow,{key:isRemainder?"":keyName,value:value,rootAttrs:'class="'+clazz+'"',valueClazz:valueClazz})}return""},hortis.renderDate=function(date){return new Date(date).toISOString().substring(0,10)},hortis.expandButtonMarkup='<span class="taxonDisplay-expand"></span>',hortis.expandableBlock='<div class="%blockClazz taxonDisplay-expandable-header taxonDisplay-runon-header %state">%blockName'+hortis.expandButtonMarkup+'</div><div class="taxonDisplay-expandable-remainder taxonDisplay-runon-remainder %state">%block</div>',hortis.sourceTable={iNat:"iNaturalist",PMLS:"Pacific Marine Life Surveys",RBCM:"Royal British Columbia Museum",CMN:"Canadian Museum of Nature",BCCSN:"British Columbia Cetacean Sightings Network","Gal-Salm":"Erickson",CHU2010:"Chu and Leys (2010)",CHU2012:"Chu and Leys (2012)",Hunterston:"Hunterston Farms BioBlitz 2010"},hortis.sourceFromId=function(obsId){const colpos=obsId?obsId.indexOf(":"):-1;return-1===colpos?null:obsId.substring(0,colpos)},hortis.datasetIdFromObs=function(obsId){const colpos=obsId.indexOf(":");return obsId.substring(0,colpos)},hortis.localIdFromObs=function(obsId){const colpos=obsId.indexOf(":");return obsId.substring(colpos+1)},hortis.renderObsId=function(obsId){if("iNat"===hortis.datasetIdFromObs(obsId)){const localId=hortis.localIdFromObs(obsId);return fluid.stringTemplate(' (<a target="_blank" href="https://www.inaturalist.org/observations/%obsId">%obsId</a>)',{obsId:localId})}return obsId},hortis.renderObsBound=function(row,prefix,markup,options){if(row[prefix+"Timestamp"]){const capPrefix="since"===prefix?"":hortis.capitalize(prefix),recordedBy=row[prefix+"RecordedBy"],catalogueNumber=row[prefix+"CatalogueNumber"],value=hortis.renderDate(row[prefix+"Timestamp"])+(recordedBy&&!options.suppressObsAuthors?" by "+recordedBy:""),row1=hortis.dumpRow(capPrefix+("since"===prefix?"First Observed:":" Reported:"),value,markup),obsId=row[prefix+"ObservationId"],collection=row[prefix+"Collection"],institutionCode=row[prefix+"InstitutionCode"],obsIdCollection=hortis.sourceFromId(row[prefix+"ObservationId"]);let source=(institutionCode||hortis.sourceTable[obsIdCollection||collection]||collection)+(catalogueNumber&&"iNaturalist"!==institutionCode?" ("+catalogueNumber+")":"");obsId&&"iNat"===obsIdCollection&&(source+=hortis.renderObsId(obsId)),catalogueNumber&&"iNaturalist"===institutionCode&&(source+=hortis.renderObsId("iNat:"+catalogueNumber));return row1+hortis.dumpRow("Source:",source,markup)}return""},hortis.mediaBlock='<div class="imerss-media-name">%mediaName</div><div class="imerss-media-image"><a href="%mediaTarget"><img src="%mediaImage"/></a></div><div class="imerss-media-text">%mediaText</div>',hortis.renderOneMedium=function(medium){return fluid.stringTemplate(hortis.mediaBlock,{mediaName:medium.Name,mediaTarget:medium.URL,mediaImage:medium.Thumbnail,mediaText:medium.Description})},hortis.renderExpandable=function(terms,expanded){const allTerms={...terms,state:expanded?"taxonDisplay-expanded":"taxonDisplay-unexpanded"};return fluid.stringTemplate(hortis.expandableBlock,allTerms)},hortis.renderMedia=function(media){return media.map((oneMedium=>hortis.renderOneMedium(oneMedium))).join("\n")},hortis.drivePlayer='<iframe frameborder="0" width="360" height="55" src="%url"></iframe>',hortis.driveToPreview=function(url){const lastSlash=url.lastIndexOf("/");return url.substring(0,lastSlash)+"/preview"},hortis.hulqValues=["food","medicinal","spiritual","material","trade","indicator"],hortis.hulqValueItem='<div class="imerss-cultural-value"><div role="img" class="imerss-value-%img imerss-cultural-value-img"></div><div class="imerss-cultural-value-text">%label</div></div>',hortis.hulqValueBlock='<div class="imerss-cultural-values">%valueBlocks</div>',hortis.dumpHulqName=function(row,markup){const player=row.audioLink?fluid.stringTemplate(hortis.drivePlayer,{url:hortis.driveToPreview(row.audioLink)}):"";return hortis.dumpRow("hulqName",row.hulqName+player,markup)},hortis.dumpHulqValues=function(row,markup){const valueBlocks=hortis.hulqValues.map((function(value){return"1"===row[value+"Value"]?value:"missing"})).map((function(img,index){return fluid.stringTemplate(hortis.hulqValueItem,{img:img,label:hortis.hulqValues[index]})})),valueBlock=fluid.stringTemplate(hortis.hulqValueBlock,{valueBlocks:valueBlocks.join("\n")});return hortis.dumpRow("Cultural values"," ",markup,"taxonDisplay-empty-header")+hortis.dumpRow("",valueBlock,markup,"taxonDisplay-empty-row")},hortis.iNatExtern='<a href="%iNatLink" target="_blank" class="taxonDisplay-iNat-extern">iNaturalist<span class="external-link"></span></a>',hortis.imageTemplate='<div class="taxonDisplay-image-holder"><div class="imerss-photo" style="background-image: url(%imgUrl)"/>%iNatExtern</div></div>',hortis.idToTaxonLink=function(taxonId){return"https://www.inaturalist.org/taxa/"+taxonId},hortis.rowToScientific=function(row){return row.taxonName||row.iNaturalistTaxonName},hortis.renderTaxonDisplay=function(row,markup,options){if(!row)return null;let togo=markup.taxonDisplayHeader;const dumpRow=function(keyName,value,extraClazz,options){if("wikipediaSummary"===keyName&&value){const row1=hortis.dumpRow("Wikipedia Summary",hortis.expandButtonMarkup,markup,"taxonDisplay-expandable-header taxonDisplay-unexpanded taxonDisplay-runon-header"),row2=hortis.dumpRow("",value,markup,"taxonDisplay-expandable-remainder taxonDisplay-unexpanded taxonDisplay-runon-remainder","taxonDisplay-wikipediaSummary");togo+=row1+row2}else togo+=hortis.dumpRow(keyName,value,markup,extraClazz,void 0,options)},dumpImage=function(keyName,url,taxonId){const imageMarkup=fluid.stringTemplate(hortis.imageTemplate,{imgUrl:url,iNatExtern:taxonId?fluid.stringTemplate(hortis.iNatExtern,{iNatLink:hortis.idToTaxonLink(taxonId)}):""});togo+=imageMarkup};if(row.rank)row.iNaturalistTaxonImage&&!row.taxonPic?dumpImage(0,row.iNaturalistTaxonImage,row.iNaturalistTaxonId):row.taxonPic&&dumpImage(0,row.taxonPic),row.phyloPicUrl&&(keyName="phyloPic",url=row.phyloPicUrl,togo+=hortis.dumpRow(keyName,'<div><img alt="Taxon photo" height="150" width="150" class="imerss-photo" src="'+url+'"/></div>',markup)),dumpRow(row.rank,hortis.rowToScientific(row),"taxonDisplay-rank"),hortis.commonFields.forEach((function(field){dumpRow(field,row[field])})),dumpRow("taxonPicDescription",row.taxonPicDescription),dumpRow("Species:",row.childCount),dumpRow("observationCount",row.observationCount);else{if(row.iNaturalistTaxonImage&&!row.obsPhotoLink&&dumpImage(0,row.iNaturalistTaxonImage,row.iNaturalistTaxonId),row.species&&dumpRow("iNaturalistTaxonName",(row.taxonName||row.iNaturalistTaxonName)+(row.authority?" "+row.authority:""),"taxonDisplay-rank",options),row.hulqName&&(togo+=hortis.dumpHulqName(row,markup)),dumpRow("commonName",row.commonName&&hortis.capitalize(row.commonName)),row.hulqName&&options.culturalValues&&(togo+=hortis.dumpHulqValues(row,markup)),row.media){const mediaPanel=hortis.renderMedia(row.media,"");togo+=hortis.dumpRow("media",hortis.expandButtonMarkup,markup,"taxonDisplay-expandable-header",null,options),togo+=hortis.dumpRow("media",mediaPanel,markup,"taxonDisplay-expandable-remainder taxonDisplay-runon-remainder",null,options)}dumpRow("wikipediaSummary",row.wikipediaSummary);let obsPanel="";obsPanel+=hortis.dumpRow("reportingStatus",row.reportingStatus&&hortis.capitalize(row.reportingStatus),markup),obsPanel+=hortis.renderObsBound(row,"first",markup,options),obsPanel+=hortis.renderObsBound(row,"last",markup,options),obsPanel+=hortis.renderObsBound(row,"since",markup,options),row.iNaturalistObsLink&&(obsPanel+=hortis.dumpRow("iNaturalistObsLink",'<a href="'+row.iNaturalistObsLink+'">'+row.iNaturalistObsLink+"</a>",markup)),obsPanel+=hortis.dumpRow("observationCount",row.observationCount,markup),togo+=hortis.dumpRow("observationData",hortis.expandButtonMarkup,markup,"taxonDisplay-expandable-header",null,options),togo+=hortis.dumpRow("observationData",obsPanel,markup,"taxonDisplay-expandable-remainder taxonDisplay-runon-remainder",null,options),row.obsPhotoLink&&dumpImage(0,row.obsPhotoLink)}var keyName,url;return togo+=markup.taxonDisplayFooter,togo},hortis.bindRowExpander=function(that){that.container.on("click",".taxonDisplay-expand",(function(e){const header=$(e.target).closest(".taxonDisplay-expandable-header");header.toggleClass("taxonDisplay-expanded"),header.toggleClass("taxonDisplay-unexpanded");const showing=header.hasClass("taxonDisplay-expanded"),siblings=header.parent().children(),ownIndex=header.index(),next=$(siblings[ownIndex+1]);next.hasClass("taxonDisplay-expandable-remainder")&&(next.toggleClass("taxonDisplay-expanded",showing),next.toggleClass("taxonDisplay-unexpanded",!showing))}))},hortis.updateTaxonDisplay=function(that,id){const content=id?hortis.renderTaxonDisplay(that.index[id],that.options.markup,that.options):null,taxonDisplay=that.locate("taxonDisplay");content&&(taxonDisplay.empty(),taxonDisplay.html(content))},hortis.tooltipTemplate='<div class="imerss-tooltip"><div class="imerss-photo" style="background-image: url(%imgUrl)"></div><div class="text"><b>%taxonRank:</b> %taxonNames</div></div>',hortis.renderTooltip=function(row){const terms={imgUrl:row.iNaturalistTaxonImage||""};row.rank?terms.taxonRank=hortis.capitalize(row.rank):terms.taxonRank="Species";const names=[row.taxonName||row.iNaturalistTaxonName,row.commonName,row.hulqName].filter((name=>name));return terms.taxonNames=names.join(" / "),fluid.stringTemplate(hortis.tooltipTemplate,terms)},hortis.isInDocument=function(node){const dokkument=fluid.getDocument(node),container=node[0];return $.contains(dokkument,container)||dokkument===container},hortis.clearAllTooltips=function(that){hortis.clearTooltip(that),$(".ui-tooltip").remove(),that.applier.change("hoverId",null)},hortis.clearTooltip=function(that){const tooltipTarget=that.tooltipTarget;tooltipTarget&&(that.tooltipTarget=null,hortis.isInDocument(tooltipTarget)?tooltipTarget.tooltip("destroy"):hortis.clearAllTooltips(that))},hortis.updateTooltip=function(that,id){const content=id?hortis.renderTooltip(that.index[id],that.options.markup):null,target=$(that.mouseEvent.target);hortis.clearTooltip(that),content?(target.tooltip({items:target}),target.tooltip("option","content",content||""),target.tooltip("option","track",!0),target.tooltip("open",that.mouseEvent),that.tooltipTarget=target):that.mouseEvent=null},hortis.isAtRoot=function(that,layoutId){return layoutId===that.flatTree[0].id},hortis.bindSunburstMouse=function(that){const svg=that.locate("svg"),mousable=that.getMousable();svg.on("click",mousable,(function(){const id=hortis.elementToId(this);let entry=that.entryIndex[id];!hortis.isAboveLayoutRoot(entry,that)&&entry.row.phyloPicUrl&&(entry=that.entries[0]),that.segmentClicked(entry.row)})),svg.on("mouseenter",mousable,(function(e){const id=hortis.elementToId(this);that.mouseEvent=e,that.applier.change("hoverId",id)})),svg.on("mouseleave",mousable,(function(){that.applier.change("hoverId",null)}))},hortis.parseColours=function(colours){return fluid.transform(colours,(function(colour){return fluid.colour.hexToArray(colour)}))},hortis.angleScale=function(index,scale){const angle=2*Math.PI*(index-scale.left)/(scale.right-scale.left);return fluid.transforms.limitRange(angle,{min:0,max:2*Math.PI})},hortis.outRings=function(array,count,width){let lastRing=array[array.length-1];for(let i=0;i<count;++i)lastRing+=width,array.push(lastRing)},hortis.makeRadiusScale=function(innerRings,visRings,totalRings,scaleConfig,isAtRoot){console.log("makeRadiusScale with innerRings ",innerRings," visRings ",visRings);const togo=[0];if(isAtRoot&&scaleConfig.rootRadii)scaleConfig.rootRadii.forEach((function(radius){hortis.outRings(togo,1,1e3*radius)})),hortis.outRings(togo,1+totalRings-togo.length,0);else{const outerRings=Math.floor((1-visRings*scaleConfig.innerDepth)/(scaleConfig.outerDepth-scaleConfig.innerDepth));console.log("outerRings determined as ",outerRings);const middleRings=visRings-outerRings-innerRings,middleDepth=(1-outerRings*scaleConfig.outerDepth-innerRings*scaleConfig.innerDepth)/middleRings;hortis.outRings(togo,innerRings,1e3*scaleConfig.innerDepth),hortis.outRings(togo,middleRings,1e3*middleDepth),hortis.outRings(togo,outerRings,1e3*scaleConfig.outerDepth),hortis.outRings(togo,totalRings-visRings,0)}return console.log("makeRadiusScale returning ",togo),togo},hortis.boundNodes=function(that,layoutId,isInit){console.log("boundNodes beginning for node ",layoutId);const layoutRoot=that.entryIndex[layoutId],visMap=[];for(let i=0;i<that.entries.length;++i)visMap[i]=0;for(let visUp=layoutRoot;visUp;visUp=visUp.parent)visMap[visUp.flatIndex]=1;const maxDepth=fluid.peek(that.entries).depth;let depth,totalNodes=1,parents=[layoutRoot];for(depth=layoutRoot.depth;depth<maxDepth;++depth){let directChildren=0;if(parents.forEach((function(parent){directChildren+=parent.children.length})),!(directChildren>0&&totalNodes+directChildren<that.options.scaleConfig.maxNodes))break;{const newParents=[];parents.forEach((function(parent){parent.children.forEach((function(child){visMap[child.flatIndex]=1})),newParents.push.apply(newParents,parent.children)})),parents=newParents,totalNodes+=directChildren}}const isAtRoot=hortis.isAtRoot(that,layoutId),radiusScale=hortis.makeRadiusScale(layoutRoot.depth,depth+1,maxDepth+1,that.options.scaleConfig,isAtRoot),togo={visMap:visMap,scale:{left:layoutRoot.leftIndex,right:layoutRoot.leftIndex+layoutRoot.childCount,radiusScale:radiusScale}};return console.log("boundNodes returning ",togo),isInit&&(that.visMap=visMap,that.applier.change("scale",togo.scale)),togo},hortis.isClickable=function(entry){const row=entry.row;return entry.children.length>0||row.iNaturalistLink||row.iNaturalistTaxonId},hortis.elementClass=function(entry,isSelected,styles,baseStyle){return styles[baseStyle]+(hortis.isClickable(entry)?" "+styles.clickable:"")+(isSelected?" "+styles.layoutRoot:"")},hortis.elementStyle=function(attrs,elementType){const opacity=void 0===attrs.opacity?"":" opacity: "+attrs.opacity+";";return"segment"===elementType?"fill: "+attrs.fillColour+";"+opacity:opacity},hortis.phyloPicAttrMap={visibility:"visibility",x:"phyloPicX",y:"phyloPicY",height:"picDiameter",width:"pidDiameter"},hortis.renderLight=function(that){that.entries.forEach((function(entry,index){if(that.visMap[index]||that.oldVisMap&&that.oldVisMap[index]){const row=entry.row,attrs=hortis.attrsForEntry(that,entry);attrs.fillColour=that.fillColourForRow(row);const isSelected=row.id===that.model.selectedId,segment=fluid.byId("hortis-segment:"+row.id);segment&&(segment.setAttribute("d",attrs.path),segment.setAttribute("visibility",attrs.visibility),segment.setAttribute("class",hortis.elementClass(entry,isSelected,that.options.styles,"segment")),segment.setAttribute("style",hortis.elementStyle(attrs,"segment")));const labelPath=fluid.byId("hortis-labelPath:"+row.id);labelPath&&(labelPath.setAttribute("d",attrs.textPath),labelPath.setAttribute("visibility",attrs.labelVisibility));const label=fluid.byId("hortis-label:"+row.id);label&&(label.setAttribute("visibility",attrs.labelVisibility),label.setAttribute("class",hortis.elementClass(entry,isSelected,that.options.styles,"label")),label.setAttribute("style",hortis.elementStyle(attrs,"label")));const pic=fluid.byId("hortis-phyloPic:"+row.id);pic&&fluid.each(hortis.phyloPicAttrMap,(function(source,target){pic.setAttribute(target,attrs[source])}))}}))},hortis.renderSVGTemplate=function(template,terms){return fluid.stringTemplate(template,terms)},hortis.interpolateModels=function(f,m1,m2){return fluid.transform(m1,(function(value,key){return"number"==typeof value?(1-f)*value+f*m2[key]:fluid.isPlainObject(value)?hortis.interpolateModels(f,value,m2[key]):value}))},hortis.undocColourForRow=function(parsedColours,row){const undocFraction=1-row.undocumentedCount/row.childCount,interp=fluid.colour.interpolate(undocFraction,row.highColour||parsedColours.highColour,row.lowColour||parsedColours.lowColour);return fluid.colour.arrayToString(interp)},hortis.obsColourForRow=function(parsedColours,row,rootRow){const fraction=Math.pow(row.observationCount/rootRow.observationCount,.2),interp=fluid.colour.interpolate(fraction,row.lowColour||parsedColours.lowColour,row.highColour||parsedColours.highColour),focusProp=row.focusCount/row.childCount,interp2=fluid.colour.interpolate(focusProp,parsedColours.unfocusedColour,interp);return fluid.colour.arrayToString(interp2)},hortis.pathFromRoot=function(row){const togo=[];for(;row;)togo.unshift(row),row=row.parent;return togo},hortis.lcaRoot=function(parents){let lcaRoot;for(let i=0;;++i){let commonValue=null;for(const key in parents){const seg=parents[key][i];if(void 0===seg){commonValue=null;break}if(null===commonValue)commonValue=seg;else if(commonValue!==seg){commonValue=null;break}}if(null===commonValue)break;lcaRoot=commonValue}return lcaRoot},hortis.updateRowFocus=function(that,rowFocus,transaction){const entries=that.entries,focusAll=$.isEmptyObject(rowFocus);for(let i=entries.length-1;i>=0;--i){const entry=entries[i];let focusCount;focusCount=focusAll||rowFocus[entry.row.id]?entry.childCount:entry.children.reduce((function(sum,child){return sum+child.focusCount}),0),entry.focusCount=focusCount}let target;if(focusAll)target=entries[0];else{const parents=fluid.transform(rowFocus,(function(troo,key){const entry=that.entryIndex[key];return entry?hortis.pathFromRoot(entry):fluid.NO_VALUE})),lca=hortis.lcaRoot(parents);target=1===Object.keys(parents).length?lca.parent:lca}void 0!==target.leftIndex&&(transaction.fullSources.map&&focusAll||that.events.changeLayoutId.fire(target.row.id,"rowFocus"))},hortis.elementToId=function(element){const id=element.id;return id.substring(id.indexOf(":")+1)},hortis.backTaxon=function(that){that.model.historyIndex>1&&(that.applier.change("historyIndex",that.model.historyIndex-1),that.events.changeLayoutId.fire(that.taxonHistory[that.model.historyIndex-1],"history"))},hortis.changeLayoutId=function(that,layoutId,source){console.log("changeLayoutId to layoutId ",layoutId),that.applier.change("selectedId",layoutId),"history"!==source&&(that.taxonHistory[that.model.historyIndex]=layoutId,that.applier.change("historyIndex",that.model.historyIndex+1));const entry=that.entryIndex[layoutId];if(0===entry.children.length&&(layoutId="autocomplete"===source?entry.parent.row.id:that.model.layoutId),layoutId!==that.model.layoutId||source){if(that.model.layoutId)return hortis.beginZoom(that,layoutId);that.applier.change("layoutId",layoutId)}return fluid.promise().resolve()},hortis.beginZoom=function(that,rowId){that.container.stop(!0,!0),hortis.clearAllTooltips(that);const initialScale=fluid.copy(that.model.scale),newBound=hortis.boundNodes(that,rowId);newBound.scale.zoomProgress=1,console.log("Begin zoom to rowId "+rowId);const togo=fluid.promise();return that.oldVisMap=that.visMap,that.visMap=newBound.visMap,that.render(),that.container.animate({zoomProgress:1},{easing:"swing",duration:that.model.visible?that.options.zoomDuration:0,step:function(zoomProgress){const interpScale=hortis.interpolateModels(zoomProgress,initialScale,newBound.scale);that.applier.change("scale",interpScale)},complete:function(){console.log("Zoom complete"),delete that.oldVisMap,that.container[0].zoomProgress=0,that.applier.change("layoutId",rowId),that.applier.change("scale.zoomProgress",0),that.render(),togo.resolve()}}),togo},hortis.segmentClicked=function(that,row){that.events.changeLayoutId.fire(row.id)},hortis.nameOverrides={Chromista:"Chromists"},hortis.labelForRow=function(row,commonNames){let name=commonNames&&row.commonName?row.commonName:row.iNaturalistTaxonName;return row.hulqName&&(name+=" - "+row.hulqName),name=hortis.nameOverrides[row.iNaturalistTaxonName]||name,hortis.capitalize(name)},hortis.isAboveLayoutRoot=function(entry,that){const layoutId=that.model.layoutId;let layoutEntry=that.entryIndex[layoutId];for(;layoutEntry;){if(layoutEntry.row.id===entry.row.id)return!1;layoutEntry=layoutEntry.parent}return!0},hortis.truncateLabel=function(label,chars){return label.length>chars?label.substring(0,chars)+"":label},hortis.attrsForEntry=function(that,entry){let leftAngle=that.angleScale(entry.leftIndex),rightAngle=that.angleScale(entry.leftIndex+entry.childCount),midAngle=(leftAngle+rightAngle)/2,innerRadius=that.model.scale.radiusScale[entry.depth],outerRadius=that.model.scale.radiusScale[entry.depth+1];const isAboveLayoutRoot=hortis.isAboveLayoutRoot(entry,that),isComplete=fluid.model.isSameValue(leftAngle,0)&&fluid.model.isSameValue(rightAngle,2*Math.PI),isCircle=fluid.model.isSameValue(innerRadius,0)&&isComplete,isVisible=!fluid.model.isSameValue(leftAngle,rightAngle)&&!fluid.model.isSameValue(innerRadius,outerRadius),isOuterSegment=fluid.model.isSameValue(outerRadius-innerRadius,1e3*that.options.scaleConfig.outerDepth),label=hortis.labelForRow(entry.row,that.model.commonNames),outerLength=outerRadius*(rightAngle-leftAngle),midRadius=isCircle||!isAboveLayoutRoot?0:(innerRadius+outerRadius)/2,picRadius=outerRadius-midRadius,radiusSpan=outerRadius-innerRadius;fluid.model.isSameValue(leftAngle,Math.PI)&&(leftAngle+=1e-4);const outerLabelChars=isOuterSegment?radiusSpan/22:Math.INFINITY,labelVisibility=isOuterSegment?outerLength>45:outerLength>22*label.length,togo={visibility:isVisible?"visible":"hidden",labelVisibility:isVisible&&labelVisibility?"visible":"hidden",label:hortis.encodeHTML(hortis.truncateLabel(label,outerLabelChars)),phyloPicX:Math.cos(midAngle)*midRadius-picRadius,phyloPicY:-Math.sin(midAngle)*midRadius-picRadius,phyloPicUrl:entry.row.phyloPicUrl,picDiameter:2*picRadius};if(isComplete?(togo.textPath=hortis.circularTextPath(outerRadius),togo.path=isCircle?hortis.circularPath(outerRadius):hortis.annularPath(innerRadius,outerRadius)):(togo.textPath=isOuterSegment?hortis.linearTextPath(leftAngle,rightAngle,innerRadius,outerRadius):hortis.segmentTextPath(leftAngle,rightAngle,outerRadius),togo.path=hortis.segmentPath(leftAngle,rightAngle,innerRadius,outerRadius)),that.oldVisMap){const index=entry.flatIndex;!that.oldVisMap[index]&&that.visMap[index]?togo.opacity=that.model.scale.zoomProgress:that.oldVisMap[index]&&!that.visMap[index]&&(togo.opacity=1-that.model.scale.zoomProgress)}return togo},hortis.renderSegment=function(that,entry){const row=entry.row,isSelected=row.id===that.model.selectedId,terms=$.extend({id:"hortis-segment:"+row.id,labelPathId:"hortis-labelPath:"+row.id,labelId:"hortis-label:"+row.id,phyloPicId:"hortis-phyloPic:"+row.id,clazz:hortis.elementClass(entry,isSelected,that.options.styles,"segment"),labelPathClass:that.options.styles.labelPath,phyloPicClass:that.options.styles.phyloPic,labelClass:hortis.elementClass(entry,isSelected,that.options.styles,"label"),fillColour:that.fillColourForRow(row)},hortis.attrsForEntry(that,entry));terms.style=hortis.elementStyle(terms,"segment"),terms.labelStyle=hortis.elementStyle(terms,"label");const togo=[{position:0,markup:hortis.renderSVGTemplate(that.options.markup.segment,terms)},{position:2,markup:hortis.renderSVGTemplate(that.options.markup.label,terms)}];return terms.phyloPicUrl&&togo.push({position:1,markup:hortis.renderSVGTemplate(that.options.markup.phyloPic,terms)}),togo},hortis.elementComparator=function(element1,element2){return element1.position-element2.position},hortis.render=function(that){let markup=that.options.markup.segmentHeader,elements=[];for(let i=0;i<that.entries.length;++i)if(that.visMap[i]||that.oldVisMap&&that.oldVisMap[i]){const entry=that.entries[i];elements=elements.concat(that.renderSegment(entry))}elements.sort(hortis.elementComparator),markup+=fluid.getMembers(elements,"markup").join(""),markup+=that.options.markup.segmentFooter;const container=that.locate("svg");container.empty(),hortis.renderSVGElement(markup,container)},hortis.depthComparator=function(rowa,rowb){return rowa.depth-rowb.depth},hortis.hasNativeData=function(row){return row.hulqName||row.culturalValues},hortis.assignNativeDataFlags=function(flatTree){flatTree.forEach((function(row){if(hortis.hasNativeData(row)){let move=row;for(;move;)move.hasNativeData=!0,move=move.parent}else row.hasNativeData=!1}))},hortis.flattenTreeRecurse=function(tree,toAppend,depth){let childCount=0;tree.children.forEach((function(child){child.parent=tree,toAppend.push(child),hortis.flattenTreeRecurse(child,toAppend,depth+1),childCount+=child.childCount})),void 0===tree.childCount&&(tree.childCount=childCount||1),tree.focusCount=tree.childCount,void 0===tree.depth&&(tree.depth=depth)},hortis.flattenTree=function(that,tree){const flat=[];return flat.push(tree),hortis.flattenTreeRecurse(tree,flat,0),flat.sort(hortis.depthComparator),flat.forEach((function(row,flatIndex){row.flatIndex=flatIndex})),hortis.assignNativeDataFlags(flat),that.applyPhyloMap(flat),flat},hortis.indexTree=function(flatTree){const index={};return flatTree.forEach((function(row){index[row.id]=row})),index},hortis.indexEntries=function(entries){const index={};return entries.forEach((function(entry){index[entry.row.id]=entry})),index},hortis.filterEntries=function(that,entries){return fluid.transform(entries,(function(entry){const id=entry.row.id,ourEntry=that.entryIndex[id];return ourEntry&&ourEntry.focusCount>0?{row:entry.row,children:hortis.filterEntries(that,entry.children)}:fluid.NO_VALUE}))||[]},hortis.acceptSunburstRow=function(row,nativeDataOnly){return!nativeDataOnly||row.hasNativeData},hortis.computeSunburstEntries=function(rows,nativeDataOnly){const togo=[];return fluid.each(rows,(function(row){if(hortis.acceptSunburstRow(row,nativeDataOnly))togo.push({row:row,children:hortis.computeSunburstEntries(row.children,nativeDataOnly)});else{const dChildren=hortis.computeSunburstEntries(row.children,nativeDataOnly);Array.prototype.push.apply(togo,dChildren)}})),hortis.sortChecklistLevel(togo)},hortis.flattenEntries=function(rootEntry){const flat=[];return flat.push(rootEntry),hortis.flattenTreeRecurse(rootEntry,flat,0),flat.sort(hortis.depthComparator),flat.forEach((function(row,flatIndex){row.flatIndex=flatIndex})),flat},hortis.computeSunburstEntriesAndRender=function(that){that.entryRoot=hortis.computeSunburstEntries([that.flatTree[0]],that.model.nativeDataOnly)[0],that.entries=hortis.flattenEntries(that.entryRoot),that.entryIndex=hortis.indexEntries(that.entries),that.events.doLayout.fire(that),hortis.doLayout(that.entries)},hortis.doLayout=function(flatTree){fluid.each(flatTree,(function(node){0===node.depth&&(node.leftIndex=0);let thisLeft=node.leftIndex;node.children.forEach((function(child){child.leftIndex=thisLeft,thisLeft+=child.childCount}))}))},hortis.doInitialQuery=function(that){const toSelect=that.options.queryOnStartup||that.options.selectOnStartup;return toSelect?that.lookupTaxon(toSelect):that.flatTree[0]},hortis.computeInitialScale=function(that){const root=hortis.doInitialQuery(that);that.events.changeLayoutId.fire(root.id)};var hortis=fluid.registerNamespace("hortis");fluid.defaults("hortis.autocomplete",{gradeNames:["fluid.newViewComponent"],listeners:{"onCreate.render":"hortis.autocomplete.render"},events:{onConfirm:null},maxSuggestions:20,invokers:{query:"hortis.autocomplete.emptyQuery",renderSuggestion:"fluid.identity",renderInputValue:"fluid.identity"},widgetOptions:{displayMenu:"overlay",confirmOnBlur:!1}}),hortis.autocomplete.emptyQuery=function(query,callback){callback("")},hortis.autocomplete.render=function(that){const widgetOptions=$.extend({element:that.container[0],id:that.options.id,source:that.query,templates:{suggestion:that.renderSuggestion,inputValue:that.renderInputValue},onConfirm:that.events.onConfirm.fire},that.options.widgetOptions);that.widget=accessibleAutocomplete(widgetOptions),$("input",that.container).attr("spellcheck",!1)},fluid.registerNamespace("fluid.colour"),fluid.colour.hexIndirect={3:"001122",4:"00112233",6:"012345",8:"01234567"},fluid.colour.hexToArray=function(hex){"#"!==hex.charAt(0)&&fluid.fail("hex colour must begin with # - "+hex),hex=hex.substring(1);const digits=fluid.transform(hex.split(""),(function(ch){return parseInt(ch,16)})),indirect=fluid.colour.hexIndirect[hex.length];indirect||fluid.fail("Unsupported number of hex digits in "+hex+": can only supply "+Object.keys(fluid.colour.hexIndirect).join(", ")+" digits");const array=[];for(let i=0;i<indirect.length;i+=2){const colour=(16*digits[indirect[i]]+digits[indirect[i+1]])/(6===i?255:1);array.push(colour)}return array},fluid.colour.arrayToString=function(array){return(3===array.length?"rgb(":"rgba(")+array.join(", ")+")"},fluid.colour.interpolate=function(f,c1,c2){return fluid.transform([(1-f)*c1[0]+f*c2[0],(1-f)*c1[1]+f*c2[1],(1-f)*c1[2]+f*c2[2]],Math.round)},fluid.colour.interpolateStops=function(stops,value){const binIndex=stops.findIndex((stop=>value<=stop[0])),bin=stops[binIndex];if(-1===binIndex)return stops[stops.length-1][1];if(0===binIndex)return bin[1];const lowerStop=stops[binIndex-1],upperStop=bin,t=(value-lowerStop[0])/(upperStop[0]-lowerStop[0]),interpolatedColor=fluid.colour.interpolate(t,fluid.colour.hexToArray(lowerStop[1]),fluid.colour.hexToArray(upperStop[1]));return fluid.colour.arrayToString(interpolatedColor)},fluid.colour.memoStops=function(stops,steps){const colours=[];for(let i=0;i<=steps;++i)colours.push(fluid.colour.interpolateStops(stops,i/steps));return colours},fluid.colour.lookupStop=function(steps,prop){return steps[Math.floor(prop*(steps.length-1))]},fluid.colour.average=function(ca){return ca.reduce((function(total,c){return total[0]+=c[0],total[1]+=c[1],total[2]+=c[2],total}),[0,0,0]).map((function(e){return e/ca.length}))},fluid.colour.rgbToHsl=function(c){const r=c[0]/255,g=c[1]/255,b=c[2]/255,max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;if(max===min)h=s=0;else{const d=max-min;s=l>.5?d/(2-max-min):d/(max+min),h=max===r?(g-b)/d+(g<b?6:0):max===g?(b-r)/d+2:(r-g)/d+4,h/=6}return[h,s,l]},fluid.colour.hue2rgb=function(p,q,t){return t<0?t+=1:t>1&&(t-=1),t<1/6?p+6*(q-p)*t:t<.5?q:t<2/3?p+(q-p)*(2/3-t)*6:p},fluid.colour.hslToRgb=function(hsl){const h=hsl[0],s=hsl[1],l=hsl[2];let r,g,b;if(0===s)r=g=b=l;else{const q=l<.5?l*(1+s):l+s-l*s,p=2*l-q;r=fluid.colour.hue2rgb(p,q,h+1/3),g=fluid.colour.hue2rgb(p,q,h),b=fluid.colour.hue2rgb(p,q,h-1/3)}return[Math.round(255*r),Math.round(255*g),Math.round(255*b)]};var hortis=fluid.registerNamespace("hortis");L.Map.include({latLngToLayerPoint:function(latlng){const togo=this.project(L.latLng(latlng))._subtract(this.getPixelOrigin());return togo.x=fluid.roundToDecimal(togo.x,3),togo.y=fluid.roundToDecimal(togo.y,3),togo}}),fluid.defaults("hortis.leafletMap",{gradeNames:["fluid.viewComponent","{sunburstLoader}.options.mapFlavourGrade"],selectors:{map:".imerss-map",tooltip:".imerss-map-tooltip"},mergePolicy:{"members.map":"replace"},members:{toPlot:{},map:"@expand:L.map({that}.dom.map.0, {that}.options.mapOptions)"},datasets:{},selectionTransactionSource:null,model:{mapInitialised:"@expand:{that}.events.buildMap.fire()",datasetEnabled:"@expand:hortis.datasetEnabledModel({that}.options.datasets)",mapBlockTooltipId:null},events:{buildMap:null,clearMapSelection:null},markup:{tooltip:'<div class="imerss-map-tooltip"></div>',grid:'<div class="imerss-map-grid"></div>',tooltipHeader:"<table>",tooltipRow:'<tr><td class="taxonDisplay-key">%key: </td><td class="taxonDisplay-value">%value</td>',tooltipFooter:"</table>"},listeners:{"buildMap.bindZoom":"hortis.leafletMap.bindZoom({that})","buildMap.fitBounds":"hortis.leafletMap.fitBounds({that}, {that}.options.fitBounds)","buildMap.createTooltip":"hortis.leafletMap.createTooltip({that}, {that}.options.markup)","buildMap.addTiles":"hortis.leafletMap.addTileLayer({that}.map, {that}.options.tileOptions)","clearMapSelection.mapBlock":{changePath:"mapBlockTooltipId",value:null,source:"{arguments}.0"}},invokers:{acquireZoom:"hortis.leafletMap.acquireZoom({that})",fitBounds:"hortis.leafletMap.fitBounds({that}, {arguments}.0, {arguments}.1)"},dynamicComponents:{geoJSONLayers:{sources:"{that}.options.geoJSONMapLayers",type:"hortis.geoJSONMapLayer",options:{layer:"{source}"}}},mapOptions:{zoomSnap:.1},heatLow:"#ffffff"}),fluid.defaults("hortis.leafletMapWithWE",{selectors:{WEOverlay:".imerss-we-overlay"},listeners:{"buildMap.bindWEClick":"hortis.leafletMap.bindWEClick({that})"}}),hortis.leafletMap.bindWEClick=function(map){const overlay=map.locate("WEOverlay");overlay.click((function(){map.map.flyToBounds(hortis.projectBounds.Pepiowelh,{duration:2}),overlay.css("opacity",0),overlay.css("pointer-events","none")}))},hortis.leafletMap.acquireZoom=function(map){map.applier.change("zoom",map.map.getZoom())},hortis.leafletMap.bindZoom=function(map){const leafletMap=map.map;leafletMap.on("zoomend",(function(){map.acquireZoom()})),leafletMap.on("moveend",(function(){console.log("Bounds now ",leafletMap.getBounds())}))},fluid.defaults("hortis.streetmapTiles",{tileOptions:{tileUrl:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",tileAttribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}}),fluid.defaults("hortis.GBIFTiles",{tileOptions:{tileUrl:"https://tile.gbif.org/3857/omt/{z}/{x}/{y}@1x.png?style=gbif-classic",tileAttribution:'&copy <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors,  <a href="https://openmaptiles.org/">OpenMapTiles</a>, <a href="/citation-guidelines">GBIF</a>'}}),fluid.defaults("hortis.MtbTiles",{tileOptions:{tileUrl:"http://tile.mtbmap.cz/mtbmap_tiles/{z}/{x}/{y}.png",tileAttribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &amp; USGS'}}),hortis.leafletMap.addTileLayer=function(map,tileOptions){tileOptions&&tileOptions.tileUrl&&L.tileLayer(tileOptions.tileUrl,{attribution:tileOptions.tileAttribution}).addTo(map)},hortis.datasetEnabledModel=function(datasets){return fluid.transform(datasets,(function(){return!0}))},fluid.defaults("hortis.geoJSONMapLayer",{gradeNames:"fluid.component",style:{color:"black",weight:1},listeners:{"onCreate.applyLayer":"hortis.applyGeoJSONMapLayer({that}, {hortis.leafletMap})"}}),hortis.applyGeoJSONMapLayer=function(mapLayer,map){L.geoJSON(mapLayer.options.layer,{style:mapLayer.options.style}).addTo(map.map)},hortis.leafletMap.fitBounds=function(map,fitBounds){fitBounds&&(map.map.fitBounds(fitBounds),map.acquireZoom())},hortis.leafletMap.createTooltip=function(that,markup){const tooltip=$(markup.tooltip).appendTo(that.locate("map"));tooltip.hide(),that.map.createPane("hortis-tooltip",tooltip[0]);const container=that.map.getContainer();$(container).on("click",(function(event){event.target===container&&that.events.clearMapSelection.fire()})),$(document).on("click",(function(event){!event.target.closest(".imerss-nodismiss-map")&&event.target.closest("body")&&that.events.clearMapSelection.fire()}))},hortis.projectBounds={Galiano:[[48.855,-123.65],[49.005,-123.25]],Valdes:[[49,-123.798],[49.144,-123.504]],Xetthecum:[[48.93713,-123.511],[48.9511,-123.498]],Pepiowelh:[[48.565,-123.1575],[48.598,-123.1266]],HoweSound:[[49.16,-124.281],[50.17,-122.05]],SalishSea:[[47.568,-124.2],[49.134,-122.059]]},fluid.defaults("hortis.sunburstLoaderWithMap",{gradeNames:"hortis.sunburstLoader",selectors:{mapHolder:".imerss-map-holder"},events:{sunburstLoaded:null},mapBounds:hortis.projectBounds.Galiano,mapGrades:[],mapFlavourGrade:"hortis.leafletMap.withGrid",markupTemplate:"%resourceBase/html/imerss-viz-map.html",distributeOptions:{sunburstLoaded:{target:"{that sunburst}.options.listeners.onCreate",record:"{hortis.sunburstLoaderWithMap}.events.sunburstLoaded.fire"},flatTree:{target:"{that quantiser}.options.members.flatTree",record:"@expand:fluid.identity({sunburst}.flatTree)"},mapGrades:{target:"{that map}.options.gradeNames",source:"{that}.options.mapGrades"}},components:{map:{type:"hortis.leafletMap",container:"{sunburstLoaderWithMap}.dom.mapHolder",createOnEvent:"sunburstLoaded",options:{gradeNames:"hortis.mapWithSunburst",fitBounds:"{hortis.configHolder}.options.mapBounds",showObsListInTooltip:"{hortis.configHolder}.options.showObsListInTooltip"}}}}),fluid.defaults("hortis.scrollyMapLoader",{gradeNames:"hortis.sunburstLoaderWithMap",mapFlavourGrade:"hortis.leafletMap.withBareRegions",selectors:{mapHolder:"{sunburstLoader}.container"},markupTemplate:"%resourceBase/html/imerss-viz-map-scrolly.html",checklistRanks:["family","phylum","class","order","species"],distributeOptions:{checklistRanks:{target:"{that sunburst > checklist}.options.filterRanks",record:"{hortis.scrollyMapLoader}.options.checklistRanks"}}}),fluid.defaults("hortis.svgPatternLoader",{svgPatterns:"%resourceBase/html/xetthecum-patterns.html",resources:{svgPatterns:{url:"{that}.options.svgPatterns",dataType:"text"}},listeners:{"onResourcesLoaded.injectPatterns":{funcName:"hortis.injectSvgPatterns",args:["{svgPatternLoader}.resources.svgPatterns.resourceText","{that}.options.resourceBase","{that}.container"]}}}),hortis.injectSvgPatterns=function(patternText,resourceBase,container){const expanded=patternText.replace(/%resourceBase/g,resourceBase),patterns=$(expanded);container.append(patterns)},fluid.defaults("hortis.mapLoaderWithoutSunburst",{gradeNames:"hortis.sunburstLoaderWithMap",markupTemplate:"%resourceBase/html/imerss-viz-map-only.html",components:{sunburst:{options:{model:{visible:!1},components:{autocomplete:{type:"fluid.emptySubcomponent"},tabs:{type:"fluid.emptySubcomponent"},checklist:{type:"fluid.emptySubcomponent"}}}}}}),fluid.defaults("hortis.mapWithSunburst",{modelListeners:{mapFocusedTooltipToSunburst:{path:"{map}.model.mapBlockTooltipId",func:"hortis.mapBlockToFocusedTaxa",args:["{change}.value","{map}","{sunburst}"]}},datasets:"{sunburst}.viz.datasets",geoJSONMapLayers:"{sunburstLoaderWithMap}.options.geoJSONMapLayers"}),hortis.mapBlockToFocusedTaxa=function(mapBlockTooltipId,map,sunburst){const togo={};if(mapBlockTooltipId){const bucket=map.toPlot[mapBlockTooltipId];bucket&&fluid.each(bucket.byTaxonId,(function(obs,taxonId){togo[taxonId]=!0}))}const source=map.options.selectionTransactionSource,trans=sunburst.applier.initiate(source);trans.change("rowFocus",null,"DELETE",source),trans.change("rowFocus",togo,null,source),trans.commit()},hortis.WGS84a=6378137,hortis.WGS84b=6356752.3142,hortis.WGS84e2=(hortis.WGS84a*hortis.WGS84a-hortis.WGS84b*hortis.WGS84b)/(hortis.WGS84a*hortis.WGS84a),hortis.longitudeLength=function(latitude){const latrad=Math.PI*latitude/180,sinrad=Math.sin(latrad);return Math.PI*hortis.WGS84a*Math.cos(latrad)/(180*Math.sqrt(1-hortis.WGS84e2*sinrad*sinrad))},hortis.latitudeLength=function(latitude){const latrad=Math.PI*latitude/180,sinrad=Math.sin(latrad);return Math.PI*hortis.WGS84a*(1-hortis.WGS84e2)/(180*Math.pow(1-hortis.WGS84e2*sinrad*sinrad,1.5))},hortis.longToLat=function(lng,lat){return lng*hortis.longitudeLength(lat)/hortis.latitudeLength(lat)},hortis.quantiserDataset=function(){return{maxCount:0,totalCount:0,buckets:{},byTaxonId:{}}};var hortis=fluid.registerNamespace("hortis");hortis.intersect=function(target,source){fluid.each(target,(function(value,key){key in source||delete target[key]}))},hortis.combineDatasets=function(enabledList,quantiserDatasets){let intersect;const union={obsCount:0,buckets:{},byTaxonId:{}};return enabledList.forEach((function(enabled){const dataset=quantiserDatasets[enabled];intersect?(hortis.intersect(intersect.buckets,dataset.buckets),hortis.intersect(intersect.byTaxonId,dataset.byTaxonId)):intersect={buckets:fluid.extend({},dataset.buckets),byTaxonId:fluid.extend({},dataset.byTaxonId)},fluid.extend(union.buckets,dataset.buckets),fluid.extend(union.byTaxonId,dataset.byTaxonId),union.obsCount+=dataset.totalCount})),{intersect:intersect,union:union}},hortis.renderDatasetControls=function(datasetEnabled,squareSide,datasets,quantiser,indexVersion){console.log("renderDatasetControls executing for indexVersion "+indexVersion);const togo=[{type:"hortis.datasetControlHeader"}];fluid.each(datasets,(function(dataset,datasetId){togo.push({type:"hortis.datasetControl",datasetId:datasetId,dataset:dataset,quantiserDataset:quantiser.datasets[datasetId]})}));const enabledList=fluid.transforms.setMembershipToArray(datasetEnabled),createFooter=function(prefix,dataset){prefix?(hortis.quantiser.datasetToSummary(dataset,squareSide),dataset.obsCount="Union"===prefix?dataset.obsCount:""):dataset.taxaCount=dataset.area=dataset.obsCount="",togo.push(fluid.extend({type:"hortis.datasetControlFooter",text:prefix?prefix+" of "+enabledList.length+" datasets":""},dataset))};if(enabledList.length>1&&Object.keys(quantiser.datasets).length>0){const combinedDatasets=hortis.combineDatasets(enabledList,quantiser.datasets);createFooter("Intersection",combinedDatasets.intersect),createFooter("Union",combinedDatasets.union)}else createFooter("",{}),createFooter("",{});return togo},fluid.defaults("hortis.datasetControlBase",{gradeNames:"fluid.containerRenderingView",parentContainer:"{leafletMap}.dom.datasetControls"}),fluid.defaults("hortis.datasetControlHeader",{gradeNames:"hortis.datasetControlBase",markup:{container:'<tr class="imerss-dataset-control"><td imerss-dataset-legend-column></td><td imerss-dataset-checkbox-column></td><td imerss-dataset-name-column></td>%extraColumns</tr>',cell:'<td class="%columnClass">%text</td>'},invokers:{renderMarkup:"hortis.datasetControl.renderMarkup({that}.options.markup, true)"}}),fluid.defaults("hortis.datasetControl",{gradeNames:"hortis.datasetControlBase",selectors:{legend:".imerss-dataset-legend",enable:".imerss-dataset-checkbox",name:".imerss-dataset-name"},datasetId:"{source}.datasetId",model:{datasetEnabled:!0},modelRelay:{checkbox:{source:"dom.enable.value",target:"datasetEnabled"},name:{source:"datasetControl.dataset.name",target:"dom.name.text"},datasetEnabled:{target:"datasetEnabled",source:{context:"hortis.leafletMap",segs:["datasetEnabled","{that}.options.datasetId"]}},colour:{source:"datasetControl.dataset.colour",target:"dom.legend.style.backgroundColor"}},invokers:{renderMarkup:"hortis.datasetControl.renderMarkup({that}.options.markup, false, {that}.model.dataset, {quantiser}.datasets, {that}.options.datasetId)"},markup:{container:'<tr class="imerss-dataset-control"><td imerss-dataset-legend-column><span class="imerss-dataset-legend"></span></td><td imerss-dataset-checkbox-column><input class="imerss-dataset-checkbox" type="checkbox" value="true"/></td><td imerss-dataset-name-column><span class="imerss-dataset-name"></span></td>%extraColumns</tr>',cell:'<td class="%columnClass">%text</td>'}}),fluid.defaults("hortis.datasetControlFooter",{gradeNames:"hortis.datasetControlBase",selectors:{text:".imerss-dataset-text",obsCount:".imerss-dataset-obs",taxaCount:".imerss-dataset-taxa",area:".imerss-dataset-area"},markup:{container:'<tr><td></td><td></td><td class="imerss-dataset-text"></td><td class="imerss-dataset-obs"></td><td class="imerss-dataset-taxa"></td></tr>'},modelRelay:{text:{source:"datasetControl.text",target:"dom.text.text"},obsCount:{source:"datasetControl.obsCount",target:"dom.obsCount.text"},taxaCount:{source:"datasetControl.taxaCount",target:"dom.taxaCount.text"}}}),hortis.datasetControl.columnNames={totalCount:{name:"Observations",clazz:"imerss-obs-count-column"},taxaCount:{name:"Taxa",clazz:"imerss-taxa-count-column"}},hortis.datasetControl.renderExtraColumns=function(markup,isHeader,dataset,quantiserDataset){const extraColumns=fluid.transform(hortis.datasetControl.columnNames,(function(columnInfo,key){return fluid.stringTemplate(markup,{columnClass:columnInfo.clazz,text:isHeader?columnInfo.name:quantiserDataset[key]})}));return Object.values(extraColumns).join("\n")},hortis.datasetControl.renderMarkup=function(markup,isHeader,dataset,quantiserDatasets,datasetId){const quantiserDataset=quantiserDatasets&&quantiserDatasets[datasetId],extraColumns=hortis.datasetControl.renderExtraColumns(markup.cell,isHeader,dataset,quantiserDataset);return fluid.stringTemplate(markup.container,{extraColumns:extraColumns})};var hortis=fluid.registerNamespace("hortis");fluid.defaults("hortis.leafletMap.withGrid",{selectors:{grid:".imerss-map-grid",datasetControls:".imerss-dataset-controls",datasetsLabel:".imerss-datasets-label"},baseZoomForOutline:11.9,model:{datasetsLabel:"Data Sources:"},modelListeners:{drawGrid:{path:["indexVersion","datasetEnabled"],func:"{that}.drawGrid"},zoomToOutline:{path:"zoom",listener:"hortis.leafletMap.updateOutlineWidth",args:["{change}.value","{that}.options.baseZoomForOutline","{that}.container.0"]},drawScale:{path:"{quantiser}.model.squareSide",func:"hortis.leafletMap.drawScale",args:["{that}","{change}.value"]},updateTooltip:{path:["mapBlockTooltipId","indexVersion","datasetEnabled"],priority:"after:drawGrid",excludeSource:"init",func:"hortis.leafletMap.withGrid.updateTooltip",args:["{that}","{that}.model.mapBlockTooltipId"]},updateTooltipHighlight:{path:"mapBlockTooltipId",excludeSource:"init",func:"hortis.leafletMap.withGrid.updateTooltipHighlight",args:["{that}","{change}.oldValue"]}},invokers:{drawGrid:"hortis.leafletMap.drawGrid({that}, {that}.quantiser, {that}.model.datasetEnabled)"},gridStyle:{className:"imerss-map-region"},listeners:{"buildMap.addGrid":"hortis.leafletMap.withGrid.addGrid({that})"},modelRelay:{renderDatasetControls:{target:"datasetControls",func:"hortis.renderDatasetControls",args:["{that}.model.datasetEnabled","{that}.quantiser.model.squareSide","{that}.options.datasets","{that}.quantiser","{that}.model.indexVersion"]},datasetsLabel:{source:"datasetsLabel",target:"dom.datasetsLabel.text"}},components:{quantiser:{type:"hortis.quantiser",options:{baseLatitude:"{leafletMap}.options.fitBounds.0.0",datasets:"{leafletMap}.options.datasets",model:{indexVersion:"{leafletMap}.model.indexVersion"}}}},dynamicComponents:{datasetControls:{sources:"{that}.model.datasetControls",type:"{source}.type",options:{model:{datasetControl:"{source}"}}}}}),hortis.leafletMap.updateOutlineWidth=function(zoom,baseZoom,container){const relativeZoom=Math.min(1,Math.pow(2,2*(zoom-baseZoom)));container.style.setProperty("--imerss-stroke-width",2*relativeZoom)},hortis.leafletMap.withGrid.addGrid=function(that){that.map.createPane("hortis-grid"),that.gridGroup=L.layerGroup({pane:"hortis-grid"}).addTo(that.map)},hortis.leafletMap.drawScale=function(map,squareSide){const dimText=squareSide.toFixed(0)+"m";map.container.find(".leaflet-bottom.leaflet-left").text("Block size: "+dimText+" x "+dimText)},hortis.rectFromCorner=function(tl,latres,longres){return[[tl[0],tl[1]],[tl[0],tl[1]+longres],[tl[0]+latres,tl[1]+longres],[tl[0]+latres,tl[1]]]},hortis.leafletMap.drawGrid=function(map,quantiser,datasetEnabled){map.gridGroup.clearLayers();const latres=quantiser.model.latResolution,longres=quantiser.model.longResolution,heatLow=fluid.colour.hexToArray(map.options.heatLow),toPlot=map.toPlot={};fluid.each(quantiser.datasets,(function(dataset,datasetId){if(datasetEnabled[datasetId]){const mapDataset=map.options.datasets[datasetId],heatHigh=fluid.colour.hexToArray(mapDataset.colour);fluid.each(dataset.buckets,(function(bucket,key){const prop=Math.pow(bucket.count/dataset.maxCount,.25),fillColour=fluid.colour.interpolate(prop,heatLow,heatHigh);fluid.model.setSimple(toPlot,[key,"colours",datasetId],fillColour);const plotBucket=toPlot[key];plotBucket.count=plotBucket.count||0,plotBucket.count+=bucket.count,plotBucket.byTaxonId=fluid.extend({},plotBucket.byTaxonId,bucket.byTaxonId)}))}})),fluid.each(toPlot,(function(bucket,key){const colours=fluid.values(bucket.colours),colour=fluid.colour.average(colours),topLeft=hortis.quantiser.indexToCoord(key,latres,longres);bucket.polygon=hortis.rectFromCorner(topLeft,latres,longres),bucket.Lpolygon=L.polygon(bucket.polygon,fluid.extend({},map.options.gridStyle,{fillColor:fluid.colour.arrayToString(colour),pane:"hortis-grid"})),map.gridGroup.addLayer(bucket.Lpolygon),bucket.Lpolygon.on("click",(function(){console.log("Map clicked on key ",key),map.applier.change("mapBlockTooltipId",key)}))})),toPlot[map.model.mapBlockTooltipId]||map.applier.change("mapBlockTooltipId",null)},hortis.leafletMap.tooltipRow=function(map,key,value){return fluid.stringTemplate(map.options.markup.tooltipRow,{key:key,value:value})},hortis.leafletMap.withGrid.updateTooltipHighlight=function(map,oldKey){if(oldKey){const oldBucket=map.toPlot[oldKey];if(oldBucket){oldBucket.Lpolygon.getElement().classList.remove("imerss-highlightBlock")}}},hortis.leafletMap.withGrid.updateTooltip=function(map,key){const tooltip=map.locate("tooltip"),bucket=map.toPlot[key];if(bucket){let text=map.options.markup.tooltipHeader;const dumpRow=function(key,value){text+=hortis.leafletMap.tooltipRow(map,key,value)},resolution=map.quantiser.model.longResolution,dp=Math.max(3,1-Math.log10(resolution)),c=function(value){return value.toFixed(dp)};dumpRow("Observation Count",bucket.count),dumpRow("Species Richness",Object.values(bucket.byTaxonId).length);const p=bucket.polygon,lat0=p[0][0],lat1=p[2][0],lng0=p[0][1],lng1=p[1][1];if(dumpRow("Latitude",c(lat0)+" to "+c(lat1)),dumpRow("Longitude",c(lng0)+" to "+c(lng1)),bucket.count<5&&map.options.showObsListInTooltip){const obs=fluid.flatten(Object.values(bucket.byTaxonId));dumpRow("Observations",fluid.transform(obs,hortis.renderObsId).map((s=>"iNaturalist: "+s)).join("<br/>"))}text+=map.options.markup.tooltipFooter,tooltip[0].innerHTML=text,tooltip.show();const element=bucket.Lpolygon.getElement();element.classList.add("imerss-highlightBlock");element.parentNode.insertBefore(element,null)}else tooltip.hide()},fluid.defaults("hortis.quantiser",{gradeNames:"fluid.modelComponent",baseLatitude:51,model:{longResolution:.005,indexVersion:0},modelRelay:{latResolution:{target:"latResolution",singleTransform:{type:"fluid.transforms.free",args:["{that}.model.longResolution","{that}.options.baseLatitude"],func:"hortis.longToLat"}},squareSide:{target:"squareSide",singleTransform:{type:"fluid.transforms.free",func:"hortis.quantiser.squareSide",args:["{that}.options.baseLatitude","{that}.model.latResolution"]}},index:{target:"indexVersion",singleTransform:{type:"fluid.transforms.free",args:["{that}","{that}.options.datasets","{that}.model.latResolution","{that}.model.longResolution","{that}.model.squareSide","{that}.model.indexVersion"],func:"hortis.quantiser.indexTree"}}},members:{datasets:{}},events:{indexUpdated:null},invokers:{datasetToSummary:"hortis.quantiser.datasetToSummary({arguments}.0, {arguments}.1)",indexObs:"hortis.quantiser.indexObs({that}, {arguments}.0, {arguments}.1, {arguments}.2, {arguments}.3, {arguments}.4)"}}),hortis.quantiser.squareSide=function(baseLatitude,latResolution){return hortis.latitudeLength(baseLatitude)*latResolution},hortis.quantiser.indexToCoord=function(index,latres,longres){const coords=index.split("|");return[coords[0]*latres,coords[1]*longres]},hortis.quantiser.coordToIndex=function(coord,latres,longres){if(coord){return Math.floor(coord[0]/latres)+"|"+Math.floor(coord[1]/longres)}return"null"},hortis.quantiser.indexObs=function(that,coord,obsId,rowId,latResolution,longResolution){const coordIndex=hortis.quantiser.coordToIndex(coord,latResolution,longResolution),datasetId=hortis.datasetIdFromObs(obsId),dataset=that.datasets[datasetId];if(dataset||fluid.fail("Found observation with unknown dataset "+datasetId),dataset.byTaxonId[rowId]=!0,dataset.totalCount++,"null"!==coordIndex){let bucket=dataset.buckets[coordIndex];bucket||(bucket=dataset.buckets[coordIndex]={count:0,byTaxonId:{}}),bucket.count++,dataset.maxCount=Math.max(dataset.maxCount,bucket.count),fluid.pushArray(bucket.byTaxonId,rowId,obsId)}},hortis.quantiser.datasetToSummary=function(dataset,squareSide){const squareArea=squareSide*squareSide/1e6;dataset.taxaCount=Object.keys(dataset.byTaxonId).length,dataset.area=(Object.keys(dataset.buckets).length*squareArea).toFixed(2)},hortis.quantiser.indexTree=function(that,datasets,latResolution,longResolution,squareSide,indexVersion){that.datasets=fluid.transform(datasets,hortis.quantiserDataset);for(let i=that.flatTree.length-1;i>=0;--i){const row=that.flatTree[i];if(row.coords){const coords=JSON.parse(row.coords);fluid.each(coords,(function(coord,obsId){that.indexObs(coord,obsId,row.id,latResolution,longResolution)}))}}return fluid.each(that.datasets,(function(dataset){that.datasetToSummary(dataset,squareSide)})),indexVersion+1};var hortis=fluid.registerNamespace("hortis");hortis.addStyle=function(text){const style=document.createElement("style");style.type="text/css",style.innerText=text,document.getElementsByTagName("head")[0].appendChild(style)},fluid.defaults("hortis.leafletMap.withRegionsBase",{regionStyles:{strokeWeight:2,noSelectionOpacity:.6,selectedOpacity:.8,unselectedOpacity:.5},modelListeners:{selectedRegions:[{namespace:"map",path:"selectedRegions",func:"hortis.leafletMap.showSelectedRegions",args:["{that}","{change}.value"]}]},events:{selectRegion:null},members:{classes:"{sunburst}.viz.classes",communities:"{sunburst}.viz.communities",toPlot:"{sunburst}.viz.communities",regions:"{sunburst}.viz.classes"},listeners:{"clearMapSelection.regions":"hortis.clearSelectedRegions({that}, {arguments}.0)","selectRegion.regionSelection":"hortis.leafletMap.regionSelection({that}, {arguments}.0, {arguments}.1, {arguments}.2)"}}),fluid.defaults("hortis.leafletMap.withBareRegions",{gradeNames:"hortis.leafletMap.withRegionsBase",members:{map:null},model:{},events:{},listeners:{"buildMap.bindZoom":"fluid.identity","buildMap.fitBounds":"fluid.identity","buildMap.createTooltip":"fluid.identity","buildMap.addTiles":"fluid.identity"}}),hortis.regionOpacity=function(region){return"--imerss-"+hortis.normaliseToClass(region)+"-opacity"},hortis.regionBorder=function(region){return"--imerss-"+hortis.normaliseToClass(region)+"-stroke"},hortis.leafletMap.showSelectedRegions=function(map,selectedRegions){const style=map.container[0].style,noSelection=null===map.model.mapBlockTooltipId;Object.keys(map.regions).forEach((function(key){const lineFeature=map.classes[key].color;style.setProperty(hortis.regionOpacity(key),selectedRegions[key]||noSelection?"0.8":"0.5"),style.setProperty(hortis.regionBorder(key),selectedRegions[key]?"#FEF410":lineFeature?fluid.colour.arrayToString(lineFeature):"none")}))},hortis.leafletMap.selectedRegions=function(selectedRegion,regions){return fluid.transform(regions,(function(junk,key){return!!selectedRegion&&key===selectedRegion}))},hortis.leafletMap.regionSelection=function(map,className,community,source){map.applier.change("mapBlockTooltipId",community,"ADD",source),map.applier.change("selectedRegions",hortis.leafletMap.selectedRegions(className,map.classes),"ADD",source),map.applier.change("selectedCommunities",hortis.leafletMap.selectedRegions(community,map.communities),"ADD",source)},hortis.clearSelectedRegions=function(map,source){map.applier.change("selectedRegions",hortis.leafletMap.selectedRegions(null,map.classes),"ADD",source),map.applier.change("selectedCommunities",hortis.leafletMap.selectedRegions(null,map.communities),"ADD",source)};var hortis=fluid.registerNamespace("hortis");fluid.defaults("hortis.leafletMap.withRegions",{gradeNames:"hortis.leafletMap.withRegionsBase",selectors:{legendKeys:".imerss-map-legend-keys"},modelListeners:{legend:{path:"selectedRegions.*",func:"hortis.legendKey.selectRegion",args:["{that}","{change}.value","{change}.path"]}},selectionTransactionSource:"map",model:{selectionRoute:"map"},members:{features:"{sunburst}.viz.features",outerPanel:"{sunburst}.dom.mapOuterPanel"},listeners:{"buildMap.addRegions":"hortis.leafletMap.withRegions.addRegions({that})","buildMap.drawRegions":"hortis.leafletMap.withRegions.drawRegions({that})","buildMap.drawLegend":"hortis.legendKey.drawLegend({that})","onCreate.listenTaxonLinks":"hortis.listenTaxonLinks({sunburst})","onCreate.validateTaxonLinks":"hortis.validateTaxonLinks({sunburst}, {that})","selectRegion.renderOuterPanel":"hortis.leafletMap.renderOuterPanel({that})"},components:{bannerManager:{type:"hortis.bannerManager",container:"body",options:{model:{selectedCommunities:"{hortis.leafletMap}.model.selectedCommunities"}}}}}),fluid.registerNamespace("hortis.legendKey"),hortis.legendKey.rowTemplate='<div class="imerss-legend-row imerss-nodismiss-map %rowClass"><span class="imerss-legend-icon"></span><span class="imerss-legend-preview %previewClass" style="%previewStyle"></span><span class="imerss-legend-label">%keyLabel</span></div>',hortis.legendKey.blockTemplate='<div class="imerss-legend-block"><span class="imerss-legend-block-name imerss-nodismiss-map">%community</span>%rows</div>',hortis.legendKey.renderMarkup=function(markup,clazz,className){const style=hortis.fillColorToStyle(clazz.fillColor||clazz.color),normal=hortis.normaliseToClass(className);return fluid.stringTemplate(markup,{rowClass:"imerss-legend-row-"+normal,previewClass:"imerss-class-"+normal,previewStyle:"background-color: "+style.fillColor,keyLabel:className})},hortis.legendKey.drawLegend=function(map){const blocks=fluid.transform(map.communities,(function(community,key){const clazzRows=fluid.transform(community.classes,(function(troo,className){return hortis.legendKey.renderMarkup(hortis.legendKey.rowTemplate,map.classes[className],className)}));return fluid.stringTemplate(hortis.legendKey.blockTemplate,{community:key,rows:Object.values(clazzRows).join("\n")})})),markup=Object.values(blocks).join("\n"),legendKeys=map.locate("legendKeys");legendKeys.html(markup),map.clazzToLegendNodes=fluid.transform(map.classes,(function(troo,className){const rowSel=".imerss-legend-row-"+hortis.normaliseToClass(className);legendKeys.find(rowSel).click((function(){map.events.selectRegion.fire(className,map.classes[className].community)}))}))},hortis.legendKey.selectRegion=function(map,value,path){const className=fluid.peek(path);map.locate("legendKeys").find(".imerss-legend-row-"+hortis.normaliseToClass(className)).toggleClass("imerss-selected",value)},hortis.fillColorToStyle=function(fillColor){return{fillColor:fluid.colour.arrayToString(fillColor),fillOpacity:1}},fluid.defaults("hortis.bannerManager",{gradeNames:"fluid.viewComponent",selectors:{banner:".xetthecum-banner"},modelListeners:{"selectedCommunities.*":{func:"hortis.bannerManager.toggleClass",args:["{that}.dom.banner","{change}.value","{change}.path"]}}}),hortis.normaliseToClass=function(str){return str.toLowerCase().replace(/[| ]/g,"-")},hortis.bannerManager.toggleClass=function(banner,state,path){const community=fluid.peek(path);banner.toggleClass("imerss-banner-"+hortis.normaliseToClass(community),state)},hortis.leafletMap.seColumns=["What","Where","Importance","Protection","Source"],hortis.leafletMap.hulqNameTemplate=' / <span aria-label="%label" title="%label" class="imerss-hulq-name">%hulqName</span>',hortis.leafletMap.outerPanelPhoto='<div class="imerss-photo %photoClass"></div>',hortis.leafletMap.outerPanelCommunity='<div class="imerss-map-community">Community:<br/>%community%hulqBlock</div>',hortis.leafletMap.outerPanelClass='<div class="imerss-map-class">%clazz%hulqBlock</div>',hortis.leafletMap.renderHulqName=function(row){return fluid.stringTemplate(hortis.leafletMap.hulqNameTemplate,{hulqName:row.hulqName,label:"Meaning: "+hortis.encodeHTML(row.hulqMeaning)+" Source: "+hortis.encodeHTML(row.hulqSource)})},hortis.textToMarkup=function(text){return hortis.encodeHTML(text).replace(/\n/g,"<br/>")},hortis.taxonLinkRegex=/\[([^\[]+)\]\(([^\)]*)\)/gm,hortis.convertTaxonLinks=function(text){return text.replace(hortis.taxonLinkRegex,(function(match,p1,p2){return'<a class="imerss-taxon-link" href="'+p2+'">'+p1+"</a>"}))},hortis.linkToTaxon=function(sunburst,taxonLink){const targetTaxon=taxonLink.substring(7);return sunburst.lookupTaxon(targetTaxon)},hortis.validateTaxonLinks=function(sunburst,map){fluid.each(map.communities,(function(community,key){const text=community.culturalValues;let match;do{if(match=hortis.taxonLinkRegex.exec(text),match){const taxonLink=match[2];hortis.linkToTaxon(sunburst,taxonLink)||console.log("Failed to look up taxon "+taxonLink+" for community key "+key)}}while(match)}))},hortis.withTaxonLink=function(sunburst,e,func){const target=e.target.getAttribute("href");if(e.preventDefault(),console.log("Got event target ",target),target.startsWith("#taxon:")){const row=hortis.linkToTaxon(sunburst,target);row&&func(row)}},hortis.listenTaxonLinks=function(sunburst){$(document).on("click",".imerss-taxon-link",(function(e){hortis.withTaxonLink(sunburst,e,(function(row){sunburst.events.changeLayoutId.fire(row.id)}))})),$(document).on("mouseenter",".imerss-taxon-link",(function(e){hortis.withTaxonLink(sunburst,e,(function(row){sunburst.mouseEvent=e,sunburst.applier.change("hoverId",row.id)}))})),$(document).on("mouseleave",".imerss-taxon-link",(function(){sunburst.applier.change("hoverId",null)}))},hortis.renderMediaExpander=function(media,blockClazz){const mediaBlock=hortis.renderMedia(media);return hortis.renderExpandable({blockName:"Media",block:mediaBlock,blockClazz:blockClazz},!0)},hortis.leafletMap.renderMapOuterPanel=function(map){const selectedClazz=fluid.keyForValue(map.model.selectedRegions,!0),clazz=map.classes[selectedClazz];let topPanel="";clazz.hasImage&&(topPanel+=fluid.stringTemplate(hortis.leafletMap.outerPanelPhoto,{photoClass:"imerss-class-image-"+hortis.normaliseToClass(selectedClazz)}));const communityName=map.model.mapBlockTooltipId,community=map.communities[communityName];topPanel+=fluid.stringTemplate(hortis.leafletMap.outerPanelCommunity,{community:map.model.mapBlockTooltipId,hulqBlock:community.hulqName?hortis.leafletMap.renderHulqName(community):""}),topPanel+=fluid.stringTemplate(hortis.leafletMap.outerPanelClass,{clazz:selectedClazz,hulqBlock:clazz.hulqName?hortis.leafletMap.renderHulqName(clazz):""}),clazz.media&&(topPanel+=hortis.renderMediaExpander(clazz.media,"imerss-map-panel-block",!0));let bottomPanel="";if(community.culturalValues){const cultureBlock=hortis.convertTaxonLinks(hortis.textToMarkup(community.culturalValues))+'<br/><br/><div class="imerss-map-class-se-col">Sources:</div>'+hortis.textToMarkup(community.culturalValuesSources);bottomPanel+=hortis.renderExpandable({blockName:"Cultural Values",block:cultureBlock,blockClazz:"imerss-map-panel-block"},!0)}if(clazz["sE-Tagline"]){let ecoBlock='<div class="imerss-map-class-tagline">'+clazz["sE-Tagline"]+"</div>";hortis.leafletMap.seColumns.forEach((function(col){ecoBlock+='<div class="imerss-map-class-se-col">'+col+": </div>",ecoBlock+='<div class="imerss-map-class-se-val">'+clazz["sE-"+col]+"</div>"}));bottomPanel+=hortis.renderExpandable({blockName:"Ecological Values",block:ecoBlock,blockClazz:"imerss-map-panel-block"},!0)}return topPanel+bottomPanel},hortis.leafletMap.renderOuterPanel=function(map){map.outerPanel.html(hortis.leafletMap.renderMapOuterPanel(map))},hortis.leafletMap.withRegions.addRegions=function(that){that.map.createPane("hortis-regions"),that.regionGroup=L.layerGroup({pane:"hortis-regions"}).addTo(that.map)},hortis.leafletMap.withRegions.drawRegions=function(map){const regionClass=function(className){return"imerss-region-"+hortis.normaliseToClass(className)};map.applier.change("selectedRegions",hortis.leafletMap.selectedRegions(null,map.classes)),map.regionGroup.clearLayers(),map.liveFeatures=map.features.map((function(feature){const className=feature.properties.clazz,community=feature.properties.COMMUNITY,clazz=map.classes[className],options=clazz.fillColor?{style:hortis.fillColorToStyle(clazz.fillColor),weight:3,stroke:"yellow"}:{style:{color:fluid.colour.arrayToString(clazz.color),weight:3}};options.className=regionClass(className)+" imerss-region";const Lpolygon=L.geoJSON(feature,options);return map.regionGroup.addLayer(Lpolygon),Lpolygon.on("click",(function(){console.log("Map clicked on community ",community," region ",className),map.events.selectRegion.fire(className,community)})),{Lpolygon:Lpolygon,properties:feature.properties}}));const highlightStyle=Object.keys(map.regions).map((function(key){return"."+regionClass(key)+" {\n  fill-opacity: var("+hortis.regionOpacity(key)+");\n  stroke: var("+hortis.regionBorder(key)+");\n}\n"}));hortis.addStyle(highlightStyle.join("\n"))};var hortis=fluid.registerNamespace("hortis");hortis.encodeHTML=function(str){return str.replace(/[&<>'"]/g,(function(tag){return{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[tag]}))},hortis.renderSVGElement=function(markup,parentContainer){const element=$.parseXML(markup).documentElement;return parentContainer.append(element),element},hortis.renderNumber=function(number){return Math.abs(number)<1e-5?"0":number.toFixed(3)},hortis.emitPath=function(elements){let togo="";return elements.forEach((function(elem){togo+="string"==typeof elem?elem:hortis.renderNumber(elem)})),togo},hortis.circularPath=function(radius){const r=radius;return hortis.emitPath(["M",-r," ",0,"A",r," ",r," 0 1 0 ",r," ",0,"A",r," ",r," 0 1 0 ",-r," ",0])},hortis.annularPath=function(innerRadius,outerRadius){const ir=innerRadius,or=outerRadius;return hortis.emitPath(["M",-or," ",0,"A",or," ",or," 0 1 0 ",or," ",0,"A",or," ",or," 0 1 0 ",-or," ",0,"Z","M",-ir," ",0,"A",ir," ",ir," 0 1 1 ",ir," ",0,"A",ir," ",ir," 0 1 1 ",-ir," ",0,"Z"])},hortis.segmentPath=function(startAngle,endAngle,innerRadius,outerRadius){const cs=Math.cos(startAngle),ss=-Math.sin(startAngle),ce=Math.cos(endAngle),se=-Math.sin(endAngle),i=innerRadius,o=outerRadius,lfa=(+(endAngle-startAngle>=Math.PI)).toString();return hortis.emitPath(["M",cs*i," ",ss*i,"A",i," ",i," 0 ",lfa," 0 ",ce*i," ",se*i,"L",ce*o," ",se*o,"A",o," ",o," 0 ",lfa," 1 ",cs*o," ",ss*o,"Z"])},hortis.linearTextPath=function(leftAngle,rightAngle,innerRadius,outerRadius){const midAngle=(leftAngle+rightAngle)/2,c=Math.cos(midAngle),s=-Math.sin(midAngle),sr=c>0?innerRadius:outerRadius,fr=c>0?outerRadius:innerRadius;return hortis.emitPath(["M",c*sr," ",s*sr,"L",c*fr," ",s*fr])},hortis.segmentTextPath=function(startAngle,endAngle,outerRadius){const cs=Math.cos(startAngle),ss=-Math.sin(startAngle),ce=Math.cos(endAngle),se=-Math.sin(endAngle),ar=outerRadius-20,lfa=(+(endAngle-startAngle>=Math.PI)).toString();return hortis.emitPath(["M",cs*ar," ",ss*ar,"A",ar," ",ar," 0 ",lfa," 0 ",ce*ar," ",se*ar])},hortis.circularTextPath=function(outerRadius){const ar=outerRadius-20;return hortis.emitPath(["M","-0.1 ",-ar,"A",ar," ",ar," 0 1 0 ","0.1 ",-ar])};var hortis=fluid.registerNamespace("hortis");fluid.defaults("hortis.tabs",{gradeNames:["fluid.viewComponent"],tabOptions:{},tabIds:{},model:{selectedTab:null},listeners:{"onCreate.initTabs":{this:"{that}.container",method:"tabs",args:"{that}.options.tabOptions"},"onCreate.bindEvents":{funcName:"hortis.tabs.bindEvents"}}}),hortis.tabs.findTab=function(that,tabId){return fluid.find(that.options.tabIds,(function(id,key){return id===tabId?key:void 0}))},hortis.tabs.bindEvents=function(that){that.container.on("tabsactivate",(function(event,ui){const tabId=ui.newTab.find("a").attr("href").substring(1),tab=hortis.tabs.findTab(that,tabId);that.applier.change("selectedTab",tab)}));const initialIndex=Object.keys(that.options.tabIds).indexOf(that.model.selectedTab);-1!==initialIndex&&that.container.tabs("option","active",initialIndex)};var hortis=fluid.registerNamespace("hortis");hortis.sppAnnotations=["agg.","aff.","s.lat.","cf","sp.nov.","var.","sp.","ssp.","spp.","complex"],hortis.annoteRegex=new RegExp("("+hortis.sppAnnotations.map((annot=>annot.replace(".","\\."))).join("|")+")","g"),hortis.renderSpeciesName=function(name){return name.replace(hortis.annoteRegex,'<span class="checklist-annote">$1</span>')},hortis.checklistItem=function(entry,selectedId,simple){const record=entry.row,rowid=' data-row-id="'+record.id+'"',rank=!record.rank||simple&&record.taxonName?"species":record.rank,header="<li "+("species"===rank&&record.id===selectedId?' class="checklist-selected"':"")+">";let name="<p "+rowid+' class="checklist-rank-'+rank+'">'+("species"===rank?hortis.renderSpeciesName:fluid.identity)(hortis.encodeHTML(hortis.rowToScientific(record)))+"</p>";record.commonName&&(name+=" - <p "+rowid+' class="checklist-common-name">'+record.commonName+"</p>"),record.hulqName&&(name+=" - <p "+rowid+' class="checklist-hulq-name"><em>'+record.hulqName+"</em></p>");return header+name+hortis.checklistList(entry.children,selectedId,simple)+"</li>"},hortis.checklistList=function(entries,selectedId,simple){return entries.length?"<ul>"+entries.map((function(entry){return hortis.checklistItem(entry,selectedId,simple)})).join("")+"</ul>":""},hortis.checklistRowForId=function(that,id){return that.container.find("[data-row-id="+id+"]").closest("li")},hortis.updateChecklistSelection=function(that,newSelectedId,oldSelectedId,entryIndex){if(null===newSelectedId)return;hortis.checklistRowForId(that,oldSelectedId).removeClass("checklist-selected");const row=entryIndex[newSelectedId].row;if(row&&row.species){hortis.checklistRowForId(that,newSelectedId).addClass("checklist-selected")}},hortis.alwaysRejectRanks=["subfamily","tribe","genus"],hortis.acceptChecklistRow=function(row,filterRanks){const acceptBasic=!filterRanks||filterRanks.includes(row.rank)||row.species,alwaysReject=hortis.alwaysRejectRanks.includes(row.rank),rejectSpecies="species"===row.rank&&row.children.length>0,acceptChecklist=row.taxonName;return acceptBasic&&!rejectSpecies&&!alwaysReject||acceptChecklist},hortis.scientificComparator=function(entrya,entryb){return hortis.rowToScientific(entrya.row)>hortis.rowToScientific(entryb.row)?1:-1},hortis.sortChecklistLevel=function(entries){return entries.sort(hortis.scientificComparator)},hortis.filterRanks=function(rows,filterRanks,depth){const togo=[];return fluid.each(rows,(function(row){if(hortis.acceptChecklistRow(row,filterRanks)||0===depth)togo.push({row:row,children:hortis.filterRanks(row.children,filterRanks,depth+1)});else{const dChildren=hortis.filterRanks(row.children,filterRanks,depth+1);Array.prototype.push.apply(togo,dChildren)}})),hortis.sortChecklistLevel(togo)},hortis.generateChecklist=function(element,rootId,selectedId,entryIndex,filterEntries,filterRanks){console.log("Generating checklist for id "+rootId);const rootChildren=rootId?[entryIndex[rootId].row]:[],filteredEntries=filterEntries(hortis.filterRanks(rootChildren,filterRanks,0)),markup=hortis.checklistList(filteredEntries,selectedId,filterRanks);element[0].innerHTML=markup},fluid.defaults("hortis.checklist",{gradeNames:["hortis.withPanelLabel","fluid.viewComponent"],filterRanks:!1,selectors:{hoverable:"p",checklist:".imerss-checklist",upArrow:".imerss-checklist-up"},invokers:{generateChecklist:{funcName:"hortis.generateChecklist",args:["{that}.dom.checklist","{layoutHolder}.model.layoutId","{layoutHolder}.model.selectedId","{layoutHolder}.entryIndex","{layoutHolder}.filterEntries","{that}.options.filterRanks"]}},modelListeners:{updateSelected:{path:["{layoutHolder}.model.selectedId"],args:["{that}","{change}.value","{change}.oldValue","{layoutHolder}.entryIndex"],func:"hortis.updateChecklistSelection"},generateChecklist:{path:["{layoutHolder}.model.layoutId","{layoutHolder}.model.rowFocus"],func:"{that}.generateChecklist"},arrowClick:{path:"dom.upArrow.click",funcName:"hortis.checklist.moveUp",args:["{layoutHolder}"]}},modelRelay:{source:"{layoutHolder}.model.isAtRoot",target:"dom.upArrow.visible",func:function(x){return!x}},listeners:{"onCreate.bindHover":"hortis.checklist.bindHover({that}, {layoutHolder})"}}),hortis.checklist.focusedColour=fluid.colour.hexToArray("#333"),hortis.checklist.unfocusedColour=fluid.colour.hexToArray("#ccc"),hortis.checklist.moveUp=function(layoutHolder){const layoutId=layoutHolder.model.layoutId,entry=layoutId?layoutHolder.entryIndex[layoutId]:null,parentId=entry&&entry.parent&&entry.parent.row.id;layoutHolder.events.changeLayoutId.fire(parentId)},hortis.checklist.bindHover=function(that,layoutHolder){const hoverable=that.options.selectors.hoverable;that.container.on("mouseenter",hoverable,(function(e){const id=this.dataset.rowId;layoutHolder.mouseEvent=e,layoutHolder.applier.change("hoverId",id)})),that.container.on("mouseleave",hoverable,(function(){layoutHolder.applier.change("hoverId",null)})),that.container.on("click",hoverable,(function(){const id=this.dataset.rowId;layoutHolder.events.changeLayoutId.fire(id)}))};var hortis=fluid.registerNamespace("hortis");fluid.defaults("hortis.xetthecumSunburstLoader",{gradeNames:"fluid.viewComponent",bioPanelLabel:"Biodiversity",mapPanelLabel:"Ecological Communities",distributeOptions:{sunburstLabel:{target:"{that hortis.sunburst}.options.model.panelLabel",source:"{that}.options.bioPanelLabel"},checklistLabel:{target:"{that hortis.checklist}.options.model.panelLabel",source:"{that}.options.bioPanelLabel"},mapWithLabel:{record:"hortis.withPanelLabel",target:"{that hortis.leafletMap}.options.gradeNames"},mapLabel:{target:"{that hortis.leafletMap}.options.model.panelLabel",source:"{that}.options.mapPanelLabel"},outerPanelSelector:{target:"{that hortis.sunburst}.options.selectors.mapOuterPanel",record:".imerss-map-outer-panel"},openPanels:{target:"{that hortis.sunburst}.options.openTaxonPanels.observationData",record:!1}},components:{infoPanelManager:{type:"hortis.infoPanelManager",container:"{sunburstLoader}.container",createOnEvent:"sunburstLoaded",options:{listeners:{"{hortis.leafletMap}.events.selectRegion":{namespace:"updateInfoPanel",changePath:"{infoPanelManager}.model.visiblePanel",value:"map"},"{sunburst}.events.changeLayoutId":[{namespace:"clearMapSelection",listener:"hortis.clearMapSelectionConditionally",args:["{hortis.leafletMap}","{arguments}.0","{arguments}.1"]},{namespace:"changeLayoutId",changePath:"{infoPanelManager}.model.visiblePanel",value:"taxa"}]}}}}}),hortis.clearMapSelectionConditionally=function(map,layoutId,source){console.log("ClearMapSelectionConditionally with layoutId ",layoutId," source "+source),"rowFocus"!==source&&map.events.clearMapSelection.fire()},fluid.defaults("hortis.infoPanelManager",{gradeNames:"fluid.viewComponent",selectors:{map:".imerss-map-outer-panel-wrapper",taxa:".imerss-taxonDisplay-wrapper"},panels:{map:!0,taxa:!0},model:{visiblePanel:"taxa",visiblePanels:{}},modelRelay:{visiblePanels:{target:"visiblePanels",func:(panel,panels)=>fluid.transform(panels,((troo,thisPanel)=>panel===thisPanel)),args:["{that}.model.visiblePanel","{that}.options.panels"]},visibleMap:{target:"dom.map.visible",source:"visiblePanels.map"},visibleTaxa:{target:"dom.taxa.visible",source:"visiblePanels.taxa"}}});
//# sourceMappingURL=imerss-viz-all.js.map