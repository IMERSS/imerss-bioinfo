/*!
 * jQuery JavaScript Library v3.6.0
 * https://jquery.com/
 *
 * Includes Sizzle.js
 * https://sizzlejs.com/
 *
 * Copyright OpenJS Foundation and other contributors
 * Released under the MIT license
 * https://jquery.org/license
 *
 * Date: 2021-03-02T17:08Z
 */
(function(global,factory){"use strict";if(typeof module==="object"&&typeof module.exports==="object"){module.exports=global.document?factory(global,true):function(w){if(!w.document){throw new Error("jQuery requires a window with a document")}return factory(w)}}else{factory(global)}})(typeof window!=="undefined"?window:this,(function(window,noGlobal){"use strict";var arr=[];var getProto=Object.getPrototypeOf;var slice=arr.slice;var flat=arr.flat?function(array){return arr.flat.call(array)}:function(array){return arr.concat.apply([],array)};var push=arr.push;var indexOf=arr.indexOf;var class2type={};var toString=class2type.toString;var hasOwn=class2type.hasOwnProperty;var fnToString=hasOwn.toString;var ObjectFunctionString=fnToString.call(Object);var support={};var isFunction=function isFunction(obj){return typeof obj==="function"&&typeof obj.nodeType!=="number"&&typeof obj.item!=="function"};var isWindow=function isWindow(obj){return obj!=null&&obj===obj.window};var document=window.document;var preservedScriptAttributes={type:true,src:true,nonce:true,noModule:true};function DOMEval(code,node,doc){doc=doc||document;var i,val,script=doc.createElement("script");script.text=code;if(node){for(i in preservedScriptAttributes){val=node[i]||node.getAttribute&&node.getAttribute(i);if(val){script.setAttribute(i,val)}}}doc.head.appendChild(script).parentNode.removeChild(script)}function toType(obj){if(obj==null){return obj+""}return typeof obj==="object"||typeof obj==="function"?class2type[toString.call(obj)]||"object":typeof obj}var version="3.6.0",jQuery=function(selector,context){return new jQuery.fn.init(selector,context)};jQuery.fn=jQuery.prototype={jquery:version,constructor:jQuery,length:0,toArray:function(){return slice.call(this)},get:function(num){if(num==null){return slice.call(this)}return num<0?this[num+this.length]:this[num]},pushStack:function(elems){var ret=jQuery.merge(this.constructor(),elems);ret.prevObject=this;return ret},each:function(callback){return jQuery.each(this,callback)},map:function(callback){return this.pushStack(jQuery.map(this,(function(elem,i){return callback.call(elem,i,elem)})))},slice:function(){return this.pushStack(slice.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(jQuery.grep(this,(function(_elem,i){return(i+1)%2})))},odd:function(){return this.pushStack(jQuery.grep(this,(function(_elem,i){return i%2})))},eq:function(i){var len=this.length,j=+i+(i<0?len:0);return this.pushStack(j>=0&&j<len?[this[j]]:[])},end:function(){return this.prevObject||this.constructor()},push:push,sort:arr.sort,splice:arr.splice};jQuery.extend=jQuery.fn.extend=function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[i]||{};i++}if(typeof target!=="object"&&!isFunction(target)){target={}}if(i===length){target=this;i--}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){copy=options[name];if(name==="__proto__"||target===copy){continue}if(deep&&copy&&(jQuery.isPlainObject(copy)||(copyIsArray=Array.isArray(copy)))){src=target[name];if(copyIsArray&&!Array.isArray(src)){clone=[]}else if(!copyIsArray&&!jQuery.isPlainObject(src)){clone={}}else{clone=src}copyIsArray=false;target[name]=jQuery.extend(deep,clone,copy)}else if(copy!==undefined){target[name]=copy}}}}return target};jQuery.extend({expando:"jQuery"+(version+Math.random()).replace(/\D/g,""),isReady:true,error:function(msg){throw new Error(msg)},noop:function(){},isPlainObject:function(obj){var proto,Ctor;if(!obj||toString.call(obj)!=="[object Object]"){return false}proto=getProto(obj);if(!proto){return true}Ctor=hasOwn.call(proto,"constructor")&&proto.constructor;return typeof Ctor==="function"&&fnToString.call(Ctor)===ObjectFunctionString},isEmptyObject:function(obj){var name;for(name in obj){return false}return true},globalEval:function(code,options,doc){DOMEval(code,{nonce:options&&options.nonce},doc)},each:function(obj,callback){var length,i=0;if(isArrayLike(obj)){length=obj.length;for(;i<length;i++){if(callback.call(obj[i],i,obj[i])===false){break}}}else{for(i in obj){if(callback.call(obj[i],i,obj[i])===false){break}}}return obj},makeArray:function(arr,results){var ret=results||[];if(arr!=null){if(isArrayLike(Object(arr))){jQuery.merge(ret,typeof arr==="string"?[arr]:arr)}else{push.call(ret,arr)}}return ret},inArray:function(elem,arr,i){return arr==null?-1:indexOf.call(arr,elem,i)},merge:function(first,second){var len=+second.length,j=0,i=first.length;for(;j<len;j++){first[i++]=second[j]}first.length=i;return first},grep:function(elems,callback,invert){var callbackInverse,matches=[],i=0,length=elems.length,callbackExpect=!invert;for(;i<length;i++){callbackInverse=!callback(elems[i],i);if(callbackInverse!==callbackExpect){matches.push(elems[i])}}return matches},map:function(elems,callback,arg){var length,value,i=0,ret=[];if(isArrayLike(elems)){length=elems.length;for(;i<length;i++){value=callback(elems[i],i,arg);if(value!=null){ret.push(value)}}}else{for(i in elems){value=callback(elems[i],i,arg);if(value!=null){ret.push(value)}}}return flat(ret)},guid:1,support:support});if(typeof Symbol==="function"){jQuery.fn[Symbol.iterator]=arr[Symbol.iterator]}jQuery.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),(function(_i,name){class2type["[object "+name+"]"]=name.toLowerCase()}));function isArrayLike(obj){var length=!!obj&&"length"in obj&&obj.length,type=toType(obj);if(isFunction(obj)||isWindow(obj)){return false}return type==="array"||length===0||typeof length==="number"&&length>0&&length-1 in obj}var Sizzle=
/*!
 * Sizzle CSS Selector Engine v2.3.6
 * https://sizzlejs.com/
 *
 * Copyright JS Foundation and other contributors
 * Released under the MIT license
 * https://js.foundation/
 *
 * Date: 2021-02-16
 */
function(window){var i,support,Expr,getText,isXML,tokenize,compile,select,outermostContext,sortInput,hasDuplicate,setDocument,document,docElem,documentIsHTML,rbuggyQSA,rbuggyMatches,matches,contains,expando="sizzle"+1*new Date,preferredDoc=window.document,dirruns=0,done=0,classCache=createCache(),tokenCache=createCache(),compilerCache=createCache(),nonnativeSelectorCache=createCache(),sortOrder=function(a,b){if(a===b){hasDuplicate=true}return 0},hasOwn={}.hasOwnProperty,arr=[],pop=arr.pop,pushNative=arr.push,push=arr.push,slice=arr.slice,indexOf=function(list,elem){var i=0,len=list.length;for(;i<len;i++){if(list[i]===elem){return i}}return-1},booleans="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|"+"ismap|loop|multiple|open|readonly|required|scoped",whitespace="[\\x20\\t\\r\\n\\f]",identifier="(?:\\\\[\\da-fA-F]{1,6}"+whitespace+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",attributes="\\["+whitespace+"*("+identifier+")(?:"+whitespace+"*([*^$|!~]?=)"+whitespace+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+identifier+"))|)"+whitespace+"*\\]",pseudos=":("+identifier+")(?:\\(("+"('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|"+"((?:\\\\.|[^\\\\()[\\]]|"+attributes+")*)|"+".*"+")\\)|)",rwhitespace=new RegExp(whitespace+"+","g"),rtrim=new RegExp("^"+whitespace+"+|((?:^|[^\\\\])(?:\\\\.)*)"+whitespace+"+$","g"),rcomma=new RegExp("^"+whitespace+"*,"+whitespace+"*"),rcombinators=new RegExp("^"+whitespace+"*([>+~]|"+whitespace+")"+whitespace+"*"),rdescend=new RegExp(whitespace+"|>"),rpseudo=new RegExp(pseudos),ridentifier=new RegExp("^"+identifier+"$"),matchExpr={ID:new RegExp("^#("+identifier+")"),CLASS:new RegExp("^\\.("+identifier+")"),TAG:new RegExp("^("+identifier+"|[*])"),ATTR:new RegExp("^"+attributes),PSEUDO:new RegExp("^"+pseudos),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+whitespace+"*(even|odd|(([+-]|)(\\d*)n|)"+whitespace+"*(?:([+-]|)"+whitespace+"*(\\d+)|))"+whitespace+"*\\)|)","i"),bool:new RegExp("^(?:"+booleans+")$","i"),needsContext:new RegExp("^"+whitespace+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+whitespace+"*((?:-\\d)?\\d*)"+whitespace+"*\\)|)(?=[^-]|$)","i")},rhtml=/HTML$/i,rinputs=/^(?:input|select|textarea|button)$/i,rheader=/^h\d$/i,rnative=/^[^{]+\{\s*\[native \w/,rquickExpr=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,rsibling=/[+~]/,runescape=new RegExp("\\\\[\\da-fA-F]{1,6}"+whitespace+"?|\\\\([^\\r\\n\\f])","g"),funescape=function(escape,nonHex){var high="0x"+escape.slice(1)-65536;return nonHex?nonHex:high<0?String.fromCharCode(high+65536):String.fromCharCode(high>>10|55296,high&1023|56320)},rcssescape=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,fcssescape=function(ch,asCodePoint){if(asCodePoint){if(ch==="\0"){return"ï¿½"}return ch.slice(0,-1)+"\\"+ch.charCodeAt(ch.length-1).toString(16)+" "}return"\\"+ch},unloadHandler=function(){setDocument()},inDisabledFieldset=addCombinator((function(elem){return elem.disabled===true&&elem.nodeName.toLowerCase()==="fieldset"}),{dir:"parentNode",next:"legend"});try{push.apply(arr=slice.call(preferredDoc.childNodes),preferredDoc.childNodes);arr[preferredDoc.childNodes.length].nodeType}catch(e){push={apply:arr.length?function(target,els){pushNative.apply(target,slice.call(els))}:function(target,els){var j=target.length,i=0;while(target[j++]=els[i++]){}target.length=j-1}}}function Sizzle(selector,context,results,seed){var m,i,elem,nid,match,groups,newSelector,newContext=context&&context.ownerDocument,nodeType=context?context.nodeType:9;results=results||[];if(typeof selector!=="string"||!selector||nodeType!==1&&nodeType!==9&&nodeType!==11){return results}if(!seed){setDocument(context);context=context||document;if(documentIsHTML){if(nodeType!==11&&(match=rquickExpr.exec(selector))){if(m=match[1]){if(nodeType===9){if(elem=context.getElementById(m)){if(elem.id===m){results.push(elem);return results}}else{return results}}else{if(newContext&&(elem=newContext.getElementById(m))&&contains(context,elem)&&elem.id===m){results.push(elem);return results}}}else if(match[2]){push.apply(results,context.getElementsByTagName(selector));return results}else if((m=match[3])&&support.getElementsByClassName&&context.getElementsByClassName){push.apply(results,context.getElementsByClassName(m));return results}}if(support.qsa&&!nonnativeSelectorCache[selector+" "]&&(!rbuggyQSA||!rbuggyQSA.test(selector))&&(nodeType!==1||context.nodeName.toLowerCase()!=="object")){newSelector=selector;newContext=context;if(nodeType===1&&(rdescend.test(selector)||rcombinators.test(selector))){newContext=rsibling.test(selector)&&testContext(context.parentNode)||context;if(newContext!==context||!support.scope){if(nid=context.getAttribute("id")){nid=nid.replace(rcssescape,fcssescape)}else{context.setAttribute("id",nid=expando)}}groups=tokenize(selector);i=groups.length;while(i--){groups[i]=(nid?"#"+nid:":scope")+" "+toSelector(groups[i])}newSelector=groups.join(",")}try{push.apply(results,newContext.querySelectorAll(newSelector));return results}catch(qsaError){nonnativeSelectorCache(selector,true)}finally{if(nid===expando){context.removeAttribute("id")}}}}}return select(selector.replace(rtrim,"$1"),context,results,seed)}function createCache(){var keys=[];function cache(key,value){if(keys.push(key+" ")>Expr.cacheLength){delete cache[keys.shift()]}return cache[key+" "]=value}return cache}function markFunction(fn){fn[expando]=true;return fn}function assert(fn){var el=document.createElement("fieldset");try{return!!fn(el)}catch(e){return false}finally{if(el.parentNode){el.parentNode.removeChild(el)}el=null}}function addHandle(attrs,handler){var arr=attrs.split("|"),i=arr.length;while(i--){Expr.attrHandle[arr[i]]=handler}}function siblingCheck(a,b){var cur=b&&a,diff=cur&&a.nodeType===1&&b.nodeType===1&&a.sourceIndex-b.sourceIndex;if(diff){return diff}if(cur){while(cur=cur.nextSibling){if(cur===b){return-1}}}return a?1:-1}function createInputPseudo(type){return function(elem){var name=elem.nodeName.toLowerCase();return name==="input"&&elem.type===type}}function createButtonPseudo(type){return function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||name==="button")&&elem.type===type}}function createDisabledPseudo(disabled){return function(elem){if("form"in elem){if(elem.parentNode&&elem.disabled===false){if("label"in elem){if("label"in elem.parentNode){return elem.parentNode.disabled===disabled}else{return elem.disabled===disabled}}return elem.isDisabled===disabled||elem.isDisabled!==!disabled&&inDisabledFieldset(elem)===disabled}return elem.disabled===disabled}else if("label"in elem){return elem.disabled===disabled}return false}}function createPositionalPseudo(fn){return markFunction((function(argument){argument=+argument;return markFunction((function(seed,matches){var j,matchIndexes=fn([],seed.length,argument),i=matchIndexes.length;while(i--){if(seed[j=matchIndexes[i]]){seed[j]=!(matches[j]=seed[j])}}}))}))}function testContext(context){return context&&typeof context.getElementsByTagName!=="undefined"&&context}support=Sizzle.support={};isXML=Sizzle.isXML=function(elem){var namespace=elem&&elem.namespaceURI,docElem=elem&&(elem.ownerDocument||elem).documentElement;return!rhtml.test(namespace||docElem&&docElem.nodeName||"HTML")};setDocument=Sizzle.setDocument=function(node){var hasCompare,subWindow,doc=node?node.ownerDocument||node:preferredDoc;if(doc==document||doc.nodeType!==9||!doc.documentElement){return document}document=doc;docElem=document.documentElement;documentIsHTML=!isXML(document);if(preferredDoc!=document&&(subWindow=document.defaultView)&&subWindow.top!==subWindow){if(subWindow.addEventListener){subWindow.addEventListener("unload",unloadHandler,false)}else if(subWindow.attachEvent){subWindow.attachEvent("onunload",unloadHandler)}}support.scope=assert((function(el){docElem.appendChild(el).appendChild(document.createElement("div"));return typeof el.querySelectorAll!=="undefined"&&!el.querySelectorAll(":scope fieldset div").length}));support.attributes=assert((function(el){el.className="i";return!el.getAttribute("className")}));support.getElementsByTagName=assert((function(el){el.appendChild(document.createComment(""));return!el.getElementsByTagName("*").length}));support.getElementsByClassName=rnative.test(document.getElementsByClassName);support.getById=assert((function(el){docElem.appendChild(el).id=expando;return!document.getElementsByName||!document.getElementsByName(expando).length}));if(support.getById){Expr.filter["ID"]=function(id){var attrId=id.replace(runescape,funescape);return function(elem){return elem.getAttribute("id")===attrId}};Expr.find["ID"]=function(id,context){if(typeof context.getElementById!=="undefined"&&documentIsHTML){var elem=context.getElementById(id);return elem?[elem]:[]}}}else{Expr.filter["ID"]=function(id){var attrId=id.replace(runescape,funescape);return function(elem){var node=typeof elem.getAttributeNode!=="undefined"&&elem.getAttributeNode("id");return node&&node.value===attrId}};Expr.find["ID"]=function(id,context){if(typeof context.getElementById!=="undefined"&&documentIsHTML){var node,i,elems,elem=context.getElementById(id);if(elem){node=elem.getAttributeNode("id");if(node&&node.value===id){return[elem]}elems=context.getElementsByName(id);i=0;while(elem=elems[i++]){node=elem.getAttributeNode("id");if(node&&node.value===id){return[elem]}}}return[]}}}Expr.find["TAG"]=support.getElementsByTagName?function(tag,context){if(typeof context.getElementsByTagName!=="undefined"){return context.getElementsByTagName(tag)}else if(support.qsa){return context.querySelectorAll(tag)}}:function(tag,context){var elem,tmp=[],i=0,results=context.getElementsByTagName(tag);if(tag==="*"){while(elem=results[i++]){if(elem.nodeType===1){tmp.push(elem)}}return tmp}return results};Expr.find["CLASS"]=support.getElementsByClassName&&function(className,context){if(typeof context.getElementsByClassName!=="undefined"&&documentIsHTML){return context.getElementsByClassName(className)}};rbuggyMatches=[];rbuggyQSA=[];if(support.qsa=rnative.test(document.querySelectorAll)){assert((function(el){var input;docElem.appendChild(el).innerHTML="<a id='"+expando+"'></a>"+"<select id='"+expando+"-\r\\' msallowcapture=''>"+"<option selected=''></option></select>";if(el.querySelectorAll("[msallowcapture^='']").length){rbuggyQSA.push("[*^$]="+whitespace+"*(?:''|\"\")")}if(!el.querySelectorAll("[selected]").length){rbuggyQSA.push("\\["+whitespace+"*(?:value|"+booleans+")")}if(!el.querySelectorAll("[id~="+expando+"-]").length){rbuggyQSA.push("~=")}input=document.createElement("input");input.setAttribute("name","");el.appendChild(input);if(!el.querySelectorAll("[name='']").length){rbuggyQSA.push("\\["+whitespace+"*name"+whitespace+"*="+whitespace+"*(?:''|\"\")")}if(!el.querySelectorAll(":checked").length){rbuggyQSA.push(":checked")}if(!el.querySelectorAll("a#"+expando+"+*").length){rbuggyQSA.push(".#.+[+~]")}el.querySelectorAll("\\\f");rbuggyQSA.push("[\\r\\n\\f]")}));assert((function(el){el.innerHTML="<a href='' disabled='disabled'></a>"+"<select disabled='disabled'><option/></select>";var input=document.createElement("input");input.setAttribute("type","hidden");el.appendChild(input).setAttribute("name","D");if(el.querySelectorAll("[name=d]").length){rbuggyQSA.push("name"+whitespace+"*[*^$|!~]?=")}if(el.querySelectorAll(":enabled").length!==2){rbuggyQSA.push(":enabled",":disabled")}docElem.appendChild(el).disabled=true;if(el.querySelectorAll(":disabled").length!==2){rbuggyQSA.push(":enabled",":disabled")}el.querySelectorAll("*,:x");rbuggyQSA.push(",.*:")}))}if(support.matchesSelector=rnative.test(matches=docElem.matches||docElem.webkitMatchesSelector||docElem.mozMatchesSelector||docElem.oMatchesSelector||docElem.msMatchesSelector)){assert((function(el){support.disconnectedMatch=matches.call(el,"*");matches.call(el,"[s!='']:x");rbuggyMatches.push("!=",pseudos)}))}rbuggyQSA=rbuggyQSA.length&&new RegExp(rbuggyQSA.join("|"));rbuggyMatches=rbuggyMatches.length&&new RegExp(rbuggyMatches.join("|"));hasCompare=rnative.test(docElem.compareDocumentPosition);contains=hasCompare||rnative.test(docElem.contains)?function(a,b){var adown=a.nodeType===9?a.documentElement:a,bup=b&&b.parentNode;return a===bup||!!(bup&&bup.nodeType===1&&(adown.contains?adown.contains(bup):a.compareDocumentPosition&&a.compareDocumentPosition(bup)&16))}:function(a,b){if(b){while(b=b.parentNode){if(b===a){return true}}}return false};sortOrder=hasCompare?function(a,b){if(a===b){hasDuplicate=true;return 0}var compare=!a.compareDocumentPosition-!b.compareDocumentPosition;if(compare){return compare}compare=(a.ownerDocument||a)==(b.ownerDocument||b)?a.compareDocumentPosition(b):1;if(compare&1||!support.sortDetached&&b.compareDocumentPosition(a)===compare){if(a==document||a.ownerDocument==preferredDoc&&contains(preferredDoc,a)){return-1}if(b==document||b.ownerDocument==preferredDoc&&contains(preferredDoc,b)){return 1}return sortInput?indexOf(sortInput,a)-indexOf(sortInput,b):0}return compare&4?-1:1}:function(a,b){if(a===b){hasDuplicate=true;return 0}var cur,i=0,aup=a.parentNode,bup=b.parentNode,ap=[a],bp=[b];if(!aup||!bup){return a==document?-1:b==document?1:aup?-1:bup?1:sortInput?indexOf(sortInput,a)-indexOf(sortInput,b):0}else if(aup===bup){return siblingCheck(a,b)}cur=a;while(cur=cur.parentNode){ap.unshift(cur)}cur=b;while(cur=cur.parentNode){bp.unshift(cur)}while(ap[i]===bp[i]){i++}return i?siblingCheck(ap[i],bp[i]):ap[i]==preferredDoc?-1:bp[i]==preferredDoc?1:0};return document};Sizzle.matches=function(expr,elements){return Sizzle(expr,null,null,elements)};Sizzle.matchesSelector=function(elem,expr){setDocument(elem);if(support.matchesSelector&&documentIsHTML&&!nonnativeSelectorCache[expr+" "]&&(!rbuggyMatches||!rbuggyMatches.test(expr))&&(!rbuggyQSA||!rbuggyQSA.test(expr))){try{var ret=matches.call(elem,expr);if(ret||support.disconnectedMatch||elem.document&&elem.document.nodeType!==11){return ret}}catch(e){nonnativeSelectorCache(expr,true)}}return Sizzle(expr,document,null,[elem]).length>0};Sizzle.contains=function(context,elem){if((context.ownerDocument||context)!=document){setDocument(context)}return contains(context,elem)};Sizzle.attr=function(elem,name){if((elem.ownerDocument||elem)!=document){setDocument(elem)}var fn=Expr.attrHandle[name.toLowerCase()],val=fn&&hasOwn.call(Expr.attrHandle,name.toLowerCase())?fn(elem,name,!documentIsHTML):undefined;return val!==undefined?val:support.attributes||!documentIsHTML?elem.getAttribute(name):(val=elem.getAttributeNode(name))&&val.specified?val.value:null};Sizzle.escape=function(sel){return(sel+"").replace(rcssescape,fcssescape)};Sizzle.error=function(msg){throw new Error("Syntax error, unrecognized expression: "+msg)};Sizzle.uniqueSort=function(results){var elem,duplicates=[],j=0,i=0;hasDuplicate=!support.detectDuplicates;sortInput=!support.sortStable&&results.slice(0);results.sort(sortOrder);if(hasDuplicate){while(elem=results[i++]){if(elem===results[i]){j=duplicates.push(i)}}while(j--){results.splice(duplicates[j],1)}}sortInput=null;return results};getText=Sizzle.getText=function(elem){var node,ret="",i=0,nodeType=elem.nodeType;if(!nodeType){while(node=elem[i++]){ret+=getText(node)}}else if(nodeType===1||nodeType===9||nodeType===11){if(typeof elem.textContent==="string"){return elem.textContent}else{for(elem=elem.firstChild;elem;elem=elem.nextSibling){ret+=getText(elem)}}}else if(nodeType===3||nodeType===4){return elem.nodeValue}return ret};Expr=Sizzle.selectors={cacheLength:50,createPseudo:markFunction,match:matchExpr,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:true}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:true},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(match){match[1]=match[1].replace(runescape,funescape);match[3]=(match[3]||match[4]||match[5]||"").replace(runescape,funescape);if(match[2]==="~="){match[3]=" "+match[3]+" "}return match.slice(0,4)},CHILD:function(match){match[1]=match[1].toLowerCase();if(match[1].slice(0,3)==="nth"){if(!match[3]){Sizzle.error(match[0])}match[4]=+(match[4]?match[5]+(match[6]||1):2*(match[3]==="even"||match[3]==="odd"));match[5]=+(match[7]+match[8]||match[3]==="odd")}else if(match[3]){Sizzle.error(match[0])}return match},PSEUDO:function(match){var excess,unquoted=!match[6]&&match[2];if(matchExpr["CHILD"].test(match[0])){return null}if(match[3]){match[2]=match[4]||match[5]||""}else if(unquoted&&rpseudo.test(unquoted)&&(excess=tokenize(unquoted,true))&&(excess=unquoted.indexOf(")",unquoted.length-excess)-unquoted.length)){match[0]=match[0].slice(0,excess);match[2]=unquoted.slice(0,excess)}return match.slice(0,3)}},filter:{TAG:function(nodeNameSelector){var nodeName=nodeNameSelector.replace(runescape,funescape).toLowerCase();return nodeNameSelector==="*"?function(){return true}:function(elem){return elem.nodeName&&elem.nodeName.toLowerCase()===nodeName}},CLASS:function(className){var pattern=classCache[className+" "];return pattern||(pattern=new RegExp("(^|"+whitespace+")"+className+"("+whitespace+"|$)"))&&classCache(className,(function(elem){return pattern.test(typeof elem.className==="string"&&elem.className||typeof elem.getAttribute!=="undefined"&&elem.getAttribute("class")||"")}))},ATTR:function(name,operator,check){return function(elem){var result=Sizzle.attr(elem,name);if(result==null){return operator==="!="}if(!operator){return true}result+="";return operator==="="?result===check:operator==="!="?result!==check:operator==="^="?check&&result.indexOf(check)===0:operator==="*="?check&&result.indexOf(check)>-1:operator==="$="?check&&result.slice(-check.length)===check:operator==="~="?(" "+result.replace(rwhitespace," ")+" ").indexOf(check)>-1:operator==="|="?result===check||result.slice(0,check.length+1)===check+"-":false}},CHILD:function(type,what,_argument,first,last){var simple=type.slice(0,3)!=="nth",forward=type.slice(-4)!=="last",ofType=what==="of-type";return first===1&&last===0?function(elem){return!!elem.parentNode}:function(elem,_context,xml){var cache,uniqueCache,outerCache,node,nodeIndex,start,dir=simple!==forward?"nextSibling":"previousSibling",parent=elem.parentNode,name=ofType&&elem.nodeName.toLowerCase(),useCache=!xml&&!ofType,diff=false;if(parent){if(simple){while(dir){node=elem;while(node=node[dir]){if(ofType?node.nodeName.toLowerCase()===name:node.nodeType===1){return false}}start=dir=type==="only"&&!start&&"nextSibling"}return true}start=[forward?parent.firstChild:parent.lastChild];if(forward&&useCache){node=parent;outerCache=node[expando]||(node[expando]={});uniqueCache=outerCache[node.uniqueID]||(outerCache[node.uniqueID]={});cache=uniqueCache[type]||[];nodeIndex=cache[0]===dirruns&&cache[1];diff=nodeIndex&&cache[2];node=nodeIndex&&parent.childNodes[nodeIndex];while(node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop()){if(node.nodeType===1&&++diff&&node===elem){uniqueCache[type]=[dirruns,nodeIndex,diff];break}}}else{if(useCache){node=elem;outerCache=node[expando]||(node[expando]={});uniqueCache=outerCache[node.uniqueID]||(outerCache[node.uniqueID]={});cache=uniqueCache[type]||[];nodeIndex=cache[0]===dirruns&&cache[1];diff=nodeIndex}if(diff===false){while(node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop()){if((ofType?node.nodeName.toLowerCase()===name:node.nodeType===1)&&++diff){if(useCache){outerCache=node[expando]||(node[expando]={});uniqueCache=outerCache[node.uniqueID]||(outerCache[node.uniqueID]={});uniqueCache[type]=[dirruns,diff]}if(node===elem){break}}}}}diff-=last;return diff===first||diff%first===0&&diff/first>=0}}},PSEUDO:function(pseudo,argument){var args,fn=Expr.pseudos[pseudo]||Expr.setFilters[pseudo.toLowerCase()]||Sizzle.error("unsupported pseudo: "+pseudo);if(fn[expando]){return fn(argument)}if(fn.length>1){args=[pseudo,pseudo,"",argument];return Expr.setFilters.hasOwnProperty(pseudo.toLowerCase())?markFunction((function(seed,matches){var idx,matched=fn(seed,argument),i=matched.length;while(i--){idx=indexOf(seed,matched[i]);seed[idx]=!(matches[idx]=matched[i])}})):function(elem){return fn(elem,0,args)}}return fn}},pseudos:{not:markFunction((function(selector){var input=[],results=[],matcher=compile(selector.replace(rtrim,"$1"));return matcher[expando]?markFunction((function(seed,matches,_context,xml){var elem,unmatched=matcher(seed,null,xml,[]),i=seed.length;while(i--){if(elem=unmatched[i]){seed[i]=!(matches[i]=elem)}}})):function(elem,_context,xml){input[0]=elem;matcher(input,null,xml,results);input[0]=null;return!results.pop()}})),has:markFunction((function(selector){return function(elem){return Sizzle(selector,elem).length>0}})),contains:markFunction((function(text){text=text.replace(runescape,funescape);return function(elem){return(elem.textContent||getText(elem)).indexOf(text)>-1}})),lang:markFunction((function(lang){if(!ridentifier.test(lang||"")){Sizzle.error("unsupported lang: "+lang)}lang=lang.replace(runescape,funescape).toLowerCase();return function(elem){var elemLang;do{if(elemLang=documentIsHTML?elem.lang:elem.getAttribute("xml:lang")||elem.getAttribute("lang")){elemLang=elemLang.toLowerCase();return elemLang===lang||elemLang.indexOf(lang+"-")===0}}while((elem=elem.parentNode)&&elem.nodeType===1);return false}})),target:function(elem){var hash=window.location&&window.location.hash;return hash&&hash.slice(1)===elem.id},root:function(elem){return elem===docElem},focus:function(elem){return elem===document.activeElement&&(!document.hasFocus||document.hasFocus())&&!!(elem.type||elem.href||~elem.tabIndex)},enabled:createDisabledPseudo(false),disabled:createDisabledPseudo(true),checked:function(elem){var nodeName=elem.nodeName.toLowerCase();return nodeName==="input"&&!!elem.checked||nodeName==="option"&&!!elem.selected},selected:function(elem){if(elem.parentNode){elem.parentNode.selectedIndex}return elem.selected===true},empty:function(elem){for(elem=elem.firstChild;elem;elem=elem.nextSibling){if(elem.nodeType<6){return false}}return true},parent:function(elem){return!Expr.pseudos["empty"](elem)},header:function(elem){return rheader.test(elem.nodeName)},input:function(elem){return rinputs.test(elem.nodeName)},button:function(elem){var name=elem.nodeName.toLowerCase();return name==="input"&&elem.type==="button"||name==="button"},text:function(elem){var attr;return elem.nodeName.toLowerCase()==="input"&&elem.type==="text"&&((attr=elem.getAttribute("type"))==null||attr.toLowerCase()==="text")},first:createPositionalPseudo((function(){return[0]})),last:createPositionalPseudo((function(_matchIndexes,length){return[length-1]})),eq:createPositionalPseudo((function(_matchIndexes,length,argument){return[argument<0?argument+length:argument]})),even:createPositionalPseudo((function(matchIndexes,length){var i=0;for(;i<length;i+=2){matchIndexes.push(i)}return matchIndexes})),odd:createPositionalPseudo((function(matchIndexes,length){var i=1;for(;i<length;i+=2){matchIndexes.push(i)}return matchIndexes})),lt:createPositionalPseudo((function(matchIndexes,length,argument){var i=argument<0?argument+length:argument>length?length:argument;for(;--i>=0;){matchIndexes.push(i)}return matchIndexes})),gt:createPositionalPseudo((function(matchIndexes,length,argument){var i=argument<0?argument+length:argument;for(;++i<length;){matchIndexes.push(i)}return matchIndexes}))}};Expr.pseudos["nth"]=Expr.pseudos["eq"];for(i in{radio:true,checkbox:true,file:true,password:true,image:true}){Expr.pseudos[i]=createInputPseudo(i)}for(i in{submit:true,reset:true}){Expr.pseudos[i]=createButtonPseudo(i)}function setFilters(){}setFilters.prototype=Expr.filters=Expr.pseudos;Expr.setFilters=new setFilters;tokenize=Sizzle.tokenize=function(selector,parseOnly){var matched,match,tokens,type,soFar,groups,preFilters,cached=tokenCache[selector+" "];if(cached){return parseOnly?0:cached.slice(0)}soFar=selector;groups=[];preFilters=Expr.preFilter;while(soFar){if(!matched||(match=rcomma.exec(soFar))){if(match){soFar=soFar.slice(match[0].length)||soFar}groups.push(tokens=[])}matched=false;if(match=rcombinators.exec(soFar)){matched=match.shift();tokens.push({value:matched,type:match[0].replace(rtrim," ")});soFar=soFar.slice(matched.length)}for(type in Expr.filter){if((match=matchExpr[type].exec(soFar))&&(!preFilters[type]||(match=preFilters[type](match)))){matched=match.shift();tokens.push({value:matched,type:type,matches:match});soFar=soFar.slice(matched.length)}}if(!matched){break}}return parseOnly?soFar.length:soFar?Sizzle.error(selector):tokenCache(selector,groups).slice(0)};function toSelector(tokens){var i=0,len=tokens.length,selector="";for(;i<len;i++){selector+=tokens[i].value}return selector}function addCombinator(matcher,combinator,base){var dir=combinator.dir,skip=combinator.next,key=skip||dir,checkNonElements=base&&key==="parentNode",doneName=done++;return combinator.first?function(elem,context,xml){while(elem=elem[dir]){if(elem.nodeType===1||checkNonElements){return matcher(elem,context,xml)}}return false}:function(elem,context,xml){var oldCache,uniqueCache,outerCache,newCache=[dirruns,doneName];if(xml){while(elem=elem[dir]){if(elem.nodeType===1||checkNonElements){if(matcher(elem,context,xml)){return true}}}}else{while(elem=elem[dir]){if(elem.nodeType===1||checkNonElements){outerCache=elem[expando]||(elem[expando]={});uniqueCache=outerCache[elem.uniqueID]||(outerCache[elem.uniqueID]={});if(skip&&skip===elem.nodeName.toLowerCase()){elem=elem[dir]||elem}else if((oldCache=uniqueCache[key])&&oldCache[0]===dirruns&&oldCache[1]===doneName){return newCache[2]=oldCache[2]}else{uniqueCache[key]=newCache;if(newCache[2]=matcher(elem,context,xml)){return true}}}}}return false}}function elementMatcher(matchers){return matchers.length>1?function(elem,context,xml){var i=matchers.length;while(i--){if(!matchers[i](elem,context,xml)){return false}}return true}:matchers[0]}function multipleContexts(selector,contexts,results){var i=0,len=contexts.length;for(;i<len;i++){Sizzle(selector,contexts[i],results)}return results}function condense(unmatched,map,filter,context,xml){var elem,newUnmatched=[],i=0,len=unmatched.length,mapped=map!=null;for(;i<len;i++){if(elem=unmatched[i]){if(!filter||filter(elem,context,xml)){newUnmatched.push(elem);if(mapped){map.push(i)}}}}return newUnmatched}function setMatcher(preFilter,selector,matcher,postFilter,postFinder,postSelector){if(postFilter&&!postFilter[expando]){postFilter=setMatcher(postFilter)}if(postFinder&&!postFinder[expando]){postFinder=setMatcher(postFinder,postSelector)}return markFunction((function(seed,results,context,xml){var temp,i,elem,preMap=[],postMap=[],preexisting=results.length,elems=seed||multipleContexts(selector||"*",context.nodeType?[context]:context,[]),matcherIn=preFilter&&(seed||!selector)?condense(elems,preMap,preFilter,context,xml):elems,matcherOut=matcher?postFinder||(seed?preFilter:preexisting||postFilter)?[]:results:matcherIn;if(matcher){matcher(matcherIn,matcherOut,context,xml)}if(postFilter){temp=condense(matcherOut,postMap);postFilter(temp,[],context,xml);i=temp.length;while(i--){if(elem=temp[i]){matcherOut[postMap[i]]=!(matcherIn[postMap[i]]=elem)}}}if(seed){if(postFinder||preFilter){if(postFinder){temp=[];i=matcherOut.length;while(i--){if(elem=matcherOut[i]){temp.push(matcherIn[i]=elem)}}postFinder(null,matcherOut=[],temp,xml)}i=matcherOut.length;while(i--){if((elem=matcherOut[i])&&(temp=postFinder?indexOf(seed,elem):preMap[i])>-1){seed[temp]=!(results[temp]=elem)}}}}else{matcherOut=condense(matcherOut===results?matcherOut.splice(preexisting,matcherOut.length):matcherOut);if(postFinder){postFinder(null,results,matcherOut,xml)}else{push.apply(results,matcherOut)}}}))}function matcherFromTokens(tokens){var checkContext,matcher,j,len=tokens.length,leadingRelative=Expr.relative[tokens[0].type],implicitRelative=leadingRelative||Expr.relative[" "],i=leadingRelative?1:0,matchContext=addCombinator((function(elem){return elem===checkContext}),implicitRelative,true),matchAnyContext=addCombinator((function(elem){return indexOf(checkContext,elem)>-1}),implicitRelative,true),matchers=[function(elem,context,xml){var ret=!leadingRelative&&(xml||context!==outermostContext)||((checkContext=context).nodeType?matchContext(elem,context,xml):matchAnyContext(elem,context,xml));checkContext=null;return ret}];for(;i<len;i++){if(matcher=Expr.relative[tokens[i].type]){matchers=[addCombinator(elementMatcher(matchers),matcher)]}else{matcher=Expr.filter[tokens[i].type].apply(null,tokens[i].matches);if(matcher[expando]){j=++i;for(;j<len;j++){if(Expr.relative[tokens[j].type]){break}}return setMatcher(i>1&&elementMatcher(matchers),i>1&&toSelector(tokens.slice(0,i-1).concat({value:tokens[i-2].type===" "?"*":""})).replace(rtrim,"$1"),matcher,i<j&&matcherFromTokens(tokens.slice(i,j)),j<len&&matcherFromTokens(tokens=tokens.slice(j)),j<len&&toSelector(tokens))}matchers.push(matcher)}}return elementMatcher(matchers)}function matcherFromGroupMatchers(elementMatchers,setMatchers){var bySet=setMatchers.length>0,byElement=elementMatchers.length>0,superMatcher=function(seed,context,xml,results,outermost){var elem,j,matcher,matchedCount=0,i="0",unmatched=seed&&[],setMatched=[],contextBackup=outermostContext,elems=seed||byElement&&Expr.find["TAG"]("*",outermost),dirrunsUnique=dirruns+=contextBackup==null?1:Math.random()||.1,len=elems.length;if(outermost){outermostContext=context==document||context||outermost}for(;i!==len&&(elem=elems[i])!=null;i++){if(byElement&&elem){j=0;if(!context&&elem.ownerDocument!=document){setDocument(elem);xml=!documentIsHTML}while(matcher=elementMatchers[j++]){if(matcher(elem,context||document,xml)){results.push(elem);break}}if(outermost){dirruns=dirrunsUnique}}if(bySet){if(elem=!matcher&&elem){matchedCount--}if(seed){unmatched.push(elem)}}}matchedCount+=i;if(bySet&&i!==matchedCount){j=0;while(matcher=setMatchers[j++]){matcher(unmatched,setMatched,context,xml)}if(seed){if(matchedCount>0){while(i--){if(!(unmatched[i]||setMatched[i])){setMatched[i]=pop.call(results)}}}setMatched=condense(setMatched)}push.apply(results,setMatched);if(outermost&&!seed&&setMatched.length>0&&matchedCount+setMatchers.length>1){Sizzle.uniqueSort(results)}}if(outermost){dirruns=dirrunsUnique;outermostContext=contextBackup}return unmatched};return bySet?markFunction(superMatcher):superMatcher}compile=Sizzle.compile=function(selector,match){var i,setMatchers=[],elementMatchers=[],cached=compilerCache[selector+" "];if(!cached){if(!match){match=tokenize(selector)}i=match.length;while(i--){cached=matcherFromTokens(match[i]);if(cached[expando]){setMatchers.push(cached)}else{elementMatchers.push(cached)}}cached=compilerCache(selector,matcherFromGroupMatchers(elementMatchers,setMatchers));cached.selector=selector}return cached};select=Sizzle.select=function(selector,context,results,seed){var i,tokens,token,type,find,compiled=typeof selector==="function"&&selector,match=!seed&&tokenize(selector=compiled.selector||selector);results=results||[];if(match.length===1){tokens=match[0]=match[0].slice(0);if(tokens.length>2&&(token=tokens[0]).type==="ID"&&context.nodeType===9&&documentIsHTML&&Expr.relative[tokens[1].type]){context=(Expr.find["ID"](token.matches[0].replace(runescape,funescape),context)||[])[0];if(!context){return results}else if(compiled){context=context.parentNode}selector=selector.slice(tokens.shift().value.length)}i=matchExpr["needsContext"].test(selector)?0:tokens.length;while(i--){token=tokens[i];if(Expr.relative[type=token.type]){break}if(find=Expr.find[type]){if(seed=find(token.matches[0].replace(runescape,funescape),rsibling.test(tokens[0].type)&&testContext(context.parentNode)||context)){tokens.splice(i,1);selector=seed.length&&toSelector(tokens);if(!selector){push.apply(results,seed);return results}break}}}}(compiled||compile(selector,match))(seed,context,!documentIsHTML,results,!context||rsibling.test(selector)&&testContext(context.parentNode)||context);return results};support.sortStable=expando.split("").sort(sortOrder).join("")===expando;support.detectDuplicates=!!hasDuplicate;setDocument();support.sortDetached=assert((function(el){return el.compareDocumentPosition(document.createElement("fieldset"))&1}));if(!assert((function(el){el.innerHTML="<a href='#'></a>";return el.firstChild.getAttribute("href")==="#"}))){addHandle("type|href|height|width",(function(elem,name,isXML){if(!isXML){return elem.getAttribute(name,name.toLowerCase()==="type"?1:2)}}))}if(!support.attributes||!assert((function(el){el.innerHTML="<input/>";el.firstChild.setAttribute("value","");return el.firstChild.getAttribute("value")===""}))){addHandle("value",(function(elem,_name,isXML){if(!isXML&&elem.nodeName.toLowerCase()==="input"){return elem.defaultValue}}))}if(!assert((function(el){return el.getAttribute("disabled")==null}))){addHandle(booleans,(function(elem,name,isXML){var val;if(!isXML){return elem[name]===true?name.toLowerCase():(val=elem.getAttributeNode(name))&&val.specified?val.value:null}}))}return Sizzle}(window);jQuery.find=Sizzle;jQuery.expr=Sizzle.selectors;jQuery.expr[":"]=jQuery.expr.pseudos;jQuery.uniqueSort=jQuery.unique=Sizzle.uniqueSort;jQuery.text=Sizzle.getText;jQuery.isXMLDoc=Sizzle.isXML;jQuery.contains=Sizzle.contains;jQuery.escapeSelector=Sizzle.escape;var dir=function(elem,dir,until){var matched=[],truncate=until!==undefined;while((elem=elem[dir])&&elem.nodeType!==9){if(elem.nodeType===1){if(truncate&&jQuery(elem).is(until)){break}matched.push(elem)}}return matched};var siblings=function(n,elem){var matched=[];for(;n;n=n.nextSibling){if(n.nodeType===1&&n!==elem){matched.push(n)}}return matched};var rneedsContext=jQuery.expr.match.needsContext;function nodeName(elem,name){return elem.nodeName&&elem.nodeName.toLowerCase()===name.toLowerCase()}var rsingleTag=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function winnow(elements,qualifier,not){if(isFunction(qualifier)){return jQuery.grep(elements,(function(elem,i){return!!qualifier.call(elem,i,elem)!==not}))}if(qualifier.nodeType){return jQuery.grep(elements,(function(elem){return elem===qualifier!==not}))}if(typeof qualifier!=="string"){return jQuery.grep(elements,(function(elem){return indexOf.call(qualifier,elem)>-1!==not}))}return jQuery.filter(qualifier,elements,not)}jQuery.filter=function(expr,elems,not){var elem=elems[0];if(not){expr=":not("+expr+")"}if(elems.length===1&&elem.nodeType===1){return jQuery.find.matchesSelector(elem,expr)?[elem]:[]}return jQuery.find.matches(expr,jQuery.grep(elems,(function(elem){return elem.nodeType===1})))};jQuery.fn.extend({find:function(selector){var i,ret,len=this.length,self=this;if(typeof selector!=="string"){return this.pushStack(jQuery(selector).filter((function(){for(i=0;i<len;i++){if(jQuery.contains(self[i],this)){return true}}})))}ret=this.pushStack([]);for(i=0;i<len;i++){jQuery.find(selector,self[i],ret)}return len>1?jQuery.uniqueSort(ret):ret},filter:function(selector){return this.pushStack(winnow(this,selector||[],false))},not:function(selector){return this.pushStack(winnow(this,selector||[],true))},is:function(selector){return!!winnow(this,typeof selector==="string"&&rneedsContext.test(selector)?jQuery(selector):selector||[],false).length}});var rootjQuery,rquickExpr=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/,init=jQuery.fn.init=function(selector,context,root){var match,elem;if(!selector){return this}root=root||rootjQuery;if(typeof selector==="string"){if(selector[0]==="<"&&selector[selector.length-1]===">"&&selector.length>=3){match=[null,selector,null]}else{match=rquickExpr.exec(selector)}if(match&&(match[1]||!context)){if(match[1]){context=context instanceof jQuery?context[0]:context;jQuery.merge(this,jQuery.parseHTML(match[1],context&&context.nodeType?context.ownerDocument||context:document,true));if(rsingleTag.test(match[1])&&jQuery.isPlainObject(context)){for(match in context){if(isFunction(this[match])){this[match](context[match])}else{this.attr(match,context[match])}}}return this}else{elem=document.getElementById(match[2]);if(elem){this[0]=elem;this.length=1}return this}}else if(!context||context.jquery){return(context||root).find(selector)}else{return this.constructor(context).find(selector)}}else if(selector.nodeType){this[0]=selector;this.length=1;return this}else if(isFunction(selector)){return root.ready!==undefined?root.ready(selector):selector(jQuery)}return jQuery.makeArray(selector,this)};init.prototype=jQuery.fn;rootjQuery=jQuery(document);var rparentsprev=/^(?:parents|prev(?:Until|All))/,guaranteedUnique={children:true,contents:true,next:true,prev:true};jQuery.fn.extend({has:function(target){var targets=jQuery(target,this),l=targets.length;return this.filter((function(){var i=0;for(;i<l;i++){if(jQuery.contains(this,targets[i])){return true}}}))},closest:function(selectors,context){var cur,i=0,l=this.length,matched=[],targets=typeof selectors!=="string"&&jQuery(selectors);if(!rneedsContext.test(selectors)){for(;i<l;i++){for(cur=this[i];cur&&cur!==context;cur=cur.parentNode){if(cur.nodeType<11&&(targets?targets.index(cur)>-1:cur.nodeType===1&&jQuery.find.matchesSelector(cur,selectors))){matched.push(cur);break}}}}return this.pushStack(matched.length>1?jQuery.uniqueSort(matched):matched)},index:function(elem){if(!elem){return this[0]&&this[0].parentNode?this.first().prevAll().length:-1}if(typeof elem==="string"){return indexOf.call(jQuery(elem),this[0])}return indexOf.call(this,elem.jquery?elem[0]:elem)},add:function(selector,context){return this.pushStack(jQuery.uniqueSort(jQuery.merge(this.get(),jQuery(selector,context))))},addBack:function(selector){return this.add(selector==null?this.prevObject:this.prevObject.filter(selector))}});function sibling(cur,dir){while((cur=cur[dir])&&cur.nodeType!==1){}return cur}jQuery.each({parent:function(elem){var parent=elem.parentNode;return parent&&parent.nodeType!==11?parent:null},parents:function(elem){return dir(elem,"parentNode")},parentsUntil:function(elem,_i,until){return dir(elem,"parentNode",until)},next:function(elem){return sibling(elem,"nextSibling")},prev:function(elem){return sibling(elem,"previousSibling")},nextAll:function(elem){return dir(elem,"nextSibling")},prevAll:function(elem){return dir(elem,"previousSibling")},nextUntil:function(elem,_i,until){return dir(elem,"nextSibling",until)},prevUntil:function(elem,_i,until){return dir(elem,"previousSibling",until)},siblings:function(elem){return siblings((elem.parentNode||{}).firstChild,elem)},children:function(elem){return siblings(elem.firstChild)},contents:function(elem){if(elem.contentDocument!=null&&getProto(elem.contentDocument)){return elem.contentDocument}if(nodeName(elem,"template")){elem=elem.content||elem}return jQuery.merge([],elem.childNodes)}},(function(name,fn){jQuery.fn[name]=function(until,selector){var matched=jQuery.map(this,fn,until);if(name.slice(-5)!=="Until"){selector=until}if(selector&&typeof selector==="string"){matched=jQuery.filter(selector,matched)}if(this.length>1){if(!guaranteedUnique[name]){jQuery.uniqueSort(matched)}if(rparentsprev.test(name)){matched.reverse()}}return this.pushStack(matched)}}));var rnothtmlwhite=/[^\x20\t\r\n\f]+/g;function createOptions(options){var object={};jQuery.each(options.match(rnothtmlwhite)||[],(function(_,flag){object[flag]=true}));return object}jQuery.Callbacks=function(options){options=typeof options==="string"?createOptions(options):jQuery.extend({},options);var firing,memory,fired,locked,list=[],queue=[],firingIndex=-1,fire=function(){locked=locked||options.once;fired=firing=true;for(;queue.length;firingIndex=-1){memory=queue.shift();while(++firingIndex<list.length){if(list[firingIndex].apply(memory[0],memory[1])===false&&options.stopOnFalse){firingIndex=list.length;memory=false}}}if(!options.memory){memory=false}firing=false;if(locked){if(memory){list=[]}else{list=""}}},self={add:function(){if(list){if(memory&&!firing){firingIndex=list.length-1;queue.push(memory)}(function add(args){jQuery.each(args,(function(_,arg){if(isFunction(arg)){if(!options.unique||!self.has(arg)){list.push(arg)}}else if(arg&&arg.length&&toType(arg)!=="string"){add(arg)}}))})(arguments);if(memory&&!firing){fire()}}return this},remove:function(){jQuery.each(arguments,(function(_,arg){var index;while((index=jQuery.inArray(arg,list,index))>-1){list.splice(index,1);if(index<=firingIndex){firingIndex--}}}));return this},has:function(fn){return fn?jQuery.inArray(fn,list)>-1:list.length>0},empty:function(){if(list){list=[]}return this},disable:function(){locked=queue=[];list=memory="";return this},disabled:function(){return!list},lock:function(){locked=queue=[];if(!memory&&!firing){list=memory=""}return this},locked:function(){return!!locked},fireWith:function(context,args){if(!locked){args=args||[];args=[context,args.slice?args.slice():args];queue.push(args);if(!firing){fire()}}return this},fire:function(){self.fireWith(this,arguments);return this},fired:function(){return!!fired}};return self};function Identity(v){return v}function Thrower(ex){throw ex}function adoptValue(value,resolve,reject,noValue){var method;try{if(value&&isFunction(method=value.promise)){method.call(value).done(resolve).fail(reject)}else if(value&&isFunction(method=value.then)){method.call(value,resolve,reject)}else{resolve.apply(undefined,[value].slice(noValue))}}catch(value){reject.apply(undefined,[value])}}jQuery.extend({Deferred:function(func){var tuples=[["notify","progress",jQuery.Callbacks("memory"),jQuery.Callbacks("memory"),2],["resolve","done",jQuery.Callbacks("once memory"),jQuery.Callbacks("once memory"),0,"resolved"],["reject","fail",jQuery.Callbacks("once memory"),jQuery.Callbacks("once memory"),1,"rejected"]],state="pending",promise={state:function(){return state},always:function(){deferred.done(arguments).fail(arguments);return this},catch:function(fn){return promise.then(null,fn)},pipe:function(){var fns=arguments;return jQuery.Deferred((function(newDefer){jQuery.each(tuples,(function(_i,tuple){var fn=isFunction(fns[tuple[4]])&&fns[tuple[4]];deferred[tuple[1]]((function(){var returned=fn&&fn.apply(this,arguments);if(returned&&isFunction(returned.promise)){returned.promise().progress(newDefer.notify).done(newDefer.resolve).fail(newDefer.reject)}else{newDefer[tuple[0]+"With"](this,fn?[returned]:arguments)}}))}));fns=null})).promise()},then:function(onFulfilled,onRejected,onProgress){var maxDepth=0;function resolve(depth,deferred,handler,special){return function(){var that=this,args=arguments,mightThrow=function(){var returned,then;if(depth<maxDepth){return}returned=handler.apply(that,args);if(returned===deferred.promise()){throw new TypeError("Thenable self-resolution")}then=returned&&(typeof returned==="object"||typeof returned==="function")&&returned.then;if(isFunction(then)){if(special){then.call(returned,resolve(maxDepth,deferred,Identity,special),resolve(maxDepth,deferred,Thrower,special))}else{maxDepth++;then.call(returned,resolve(maxDepth,deferred,Identity,special),resolve(maxDepth,deferred,Thrower,special),resolve(maxDepth,deferred,Identity,deferred.notifyWith))}}else{if(handler!==Identity){that=undefined;args=[returned]}(special||deferred.resolveWith)(that,args)}},process=special?mightThrow:function(){try{mightThrow()}catch(e){if(jQuery.Deferred.exceptionHook){jQuery.Deferred.exceptionHook(e,process.stackTrace)}if(depth+1>=maxDepth){if(handler!==Thrower){that=undefined;args=[e]}deferred.rejectWith(that,args)}}};if(depth){process()}else{if(jQuery.Deferred.getStackHook){process.stackTrace=jQuery.Deferred.getStackHook()}window.setTimeout(process)}}}return jQuery.Deferred((function(newDefer){tuples[0][3].add(resolve(0,newDefer,isFunction(onProgress)?onProgress:Identity,newDefer.notifyWith));tuples[1][3].add(resolve(0,newDefer,isFunction(onFulfilled)?onFulfilled:Identity));tuples[2][3].add(resolve(0,newDefer,isFunction(onRejected)?onRejected:Thrower))})).promise()},promise:function(obj){return obj!=null?jQuery.extend(obj,promise):promise}},deferred={};jQuery.each(tuples,(function(i,tuple){var list=tuple[2],stateString=tuple[5];promise[tuple[1]]=list.add;if(stateString){list.add((function(){state=stateString}),tuples[3-i][2].disable,tuples[3-i][3].disable,tuples[0][2].lock,tuples[0][3].lock)}list.add(tuple[3].fire);deferred[tuple[0]]=function(){deferred[tuple[0]+"With"](this===deferred?undefined:this,arguments);return this};deferred[tuple[0]+"With"]=list.fireWith}));promise.promise(deferred);if(func){func.call(deferred,deferred)}return deferred},when:function(singleValue){var remaining=arguments.length,i=remaining,resolveContexts=Array(i),resolveValues=slice.call(arguments),primary=jQuery.Deferred(),updateFunc=function(i){return function(value){resolveContexts[i]=this;resolveValues[i]=arguments.length>1?slice.call(arguments):value;if(! --remaining){primary.resolveWith(resolveContexts,resolveValues)}}};if(remaining<=1){adoptValue(singleValue,primary.done(updateFunc(i)).resolve,primary.reject,!remaining);if(primary.state()==="pending"||isFunction(resolveValues[i]&&resolveValues[i].then)){return primary.then()}}while(i--){adoptValue(resolveValues[i],updateFunc(i),primary.reject)}return primary.promise()}});var rerrorNames=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;jQuery.Deferred.exceptionHook=function(error,stack){if(window.console&&window.console.warn&&error&&rerrorNames.test(error.name)){window.console.warn("jQuery.Deferred exception: "+error.message,error.stack,stack)}};jQuery.readyException=function(error){window.setTimeout((function(){throw error}))};var readyList=jQuery.Deferred();jQuery.fn.ready=function(fn){readyList.then(fn).catch((function(error){jQuery.readyException(error)}));return this};jQuery.extend({isReady:false,readyWait:1,ready:function(wait){if(wait===true?--jQuery.readyWait:jQuery.isReady){return}jQuery.isReady=true;if(wait!==true&&--jQuery.readyWait>0){return}readyList.resolveWith(document,[jQuery])}});jQuery.ready.then=readyList.then;function completed(){document.removeEventListener("DOMContentLoaded",completed);window.removeEventListener("load",completed);jQuery.ready()}if(document.readyState==="complete"||document.readyState!=="loading"&&!document.documentElement.doScroll){window.setTimeout(jQuery.ready)}else{document.addEventListener("DOMContentLoaded",completed);window.addEventListener("load",completed)}var access=function(elems,fn,key,value,chainable,emptyGet,raw){var i=0,len=elems.length,bulk=key==null;if(toType(key)==="object"){chainable=true;for(i in key){access(elems,fn,i,key[i],true,emptyGet,raw)}}else if(value!==undefined){chainable=true;if(!isFunction(value)){raw=true}if(bulk){if(raw){fn.call(elems,value);fn=null}else{bulk=fn;fn=function(elem,_key,value){return bulk.call(jQuery(elem),value)}}}if(fn){for(;i<len;i++){fn(elems[i],key,raw?value:value.call(elems[i],i,fn(elems[i],key)))}}}if(chainable){return elems}if(bulk){return fn.call(elems)}return len?fn(elems[0],key):emptyGet};var rmsPrefix=/^-ms-/,rdashAlpha=/-([a-z])/g;function fcamelCase(_all,letter){return letter.toUpperCase()}function camelCase(string){return string.replace(rmsPrefix,"ms-").replace(rdashAlpha,fcamelCase)}var acceptData=function(owner){return owner.nodeType===1||owner.nodeType===9||!+owner.nodeType};function Data(){this.expando=jQuery.expando+Data.uid++}Data.uid=1;Data.prototype={cache:function(owner){var value=owner[this.expando];if(!value){value={};if(acceptData(owner)){if(owner.nodeType){owner[this.expando]=value}else{Object.defineProperty(owner,this.expando,{value:value,configurable:true})}}}return value},set:function(owner,data,value){var prop,cache=this.cache(owner);if(typeof data==="string"){cache[camelCase(data)]=value}else{for(prop in data){cache[camelCase(prop)]=data[prop]}}return cache},get:function(owner,key){return key===undefined?this.cache(owner):owner[this.expando]&&owner[this.expando][camelCase(key)]},access:function(owner,key,value){if(key===undefined||key&&typeof key==="string"&&value===undefined){return this.get(owner,key)}this.set(owner,key,value);return value!==undefined?value:key},remove:function(owner,key){var i,cache=owner[this.expando];if(cache===undefined){return}if(key!==undefined){if(Array.isArray(key)){key=key.map(camelCase)}else{key=camelCase(key);key=key in cache?[key]:key.match(rnothtmlwhite)||[]}i=key.length;while(i--){delete cache[key[i]]}}if(key===undefined||jQuery.isEmptyObject(cache)){if(owner.nodeType){owner[this.expando]=undefined}else{delete owner[this.expando]}}},hasData:function(owner){var cache=owner[this.expando];return cache!==undefined&&!jQuery.isEmptyObject(cache)}};var dataPriv=new Data;var dataUser=new Data;var rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,rmultiDash=/[A-Z]/g;function getData(data){if(data==="true"){return true}if(data==="false"){return false}if(data==="null"){return null}if(data===+data+""){return+data}if(rbrace.test(data)){return JSON.parse(data)}return data}function dataAttr(elem,key,data){var name;if(data===undefined&&elem.nodeType===1){name="data-"+key.replace(rmultiDash,"-$&").toLowerCase();data=elem.getAttribute(name);if(typeof data==="string"){try{data=getData(data)}catch(e){}dataUser.set(elem,key,data)}else{data=undefined}}return data}jQuery.extend({hasData:function(elem){return dataUser.hasData(elem)||dataPriv.hasData(elem)},data:function(elem,name,data){return dataUser.access(elem,name,data)},removeData:function(elem,name){dataUser.remove(elem,name)},_data:function(elem,name,data){return dataPriv.access(elem,name,data)},_removeData:function(elem,name){dataPriv.remove(elem,name)}});jQuery.fn.extend({data:function(key,value){var i,name,data,elem=this[0],attrs=elem&&elem.attributes;if(key===undefined){if(this.length){data=dataUser.get(elem);if(elem.nodeType===1&&!dataPriv.get(elem,"hasDataAttrs")){i=attrs.length;while(i--){if(attrs[i]){name=attrs[i].name;if(name.indexOf("data-")===0){name=camelCase(name.slice(5));dataAttr(elem,name,data[name])}}}dataPriv.set(elem,"hasDataAttrs",true)}}return data}if(typeof key==="object"){return this.each((function(){dataUser.set(this,key)}))}return access(this,(function(value){var data;if(elem&&value===undefined){data=dataUser.get(elem,key);if(data!==undefined){return data}data=dataAttr(elem,key);if(data!==undefined){return data}return}this.each((function(){dataUser.set(this,key,value)}))}),null,value,arguments.length>1,null,true)},removeData:function(key){return this.each((function(){dataUser.remove(this,key)}))}});jQuery.extend({queue:function(elem,type,data){var queue;if(elem){type=(type||"fx")+"queue";queue=dataPriv.get(elem,type);if(data){if(!queue||Array.isArray(data)){queue=dataPriv.access(elem,type,jQuery.makeArray(data))}else{queue.push(data)}}return queue||[]}},dequeue:function(elem,type){type=type||"fx";var queue=jQuery.queue(elem,type),startLength=queue.length,fn=queue.shift(),hooks=jQuery._queueHooks(elem,type),next=function(){jQuery.dequeue(elem,type)};if(fn==="inprogress"){fn=queue.shift();startLength--}if(fn){if(type==="fx"){queue.unshift("inprogress")}delete hooks.stop;fn.call(elem,next,hooks)}if(!startLength&&hooks){hooks.empty.fire()}},_queueHooks:function(elem,type){var key=type+"queueHooks";return dataPriv.get(elem,key)||dataPriv.access(elem,key,{empty:jQuery.Callbacks("once memory").add((function(){dataPriv.remove(elem,[type+"queue",key])}))})}});jQuery.fn.extend({queue:function(type,data){var setter=2;if(typeof type!=="string"){data=type;type="fx";setter--}if(arguments.length<setter){return jQuery.queue(this[0],type)}return data===undefined?this:this.each((function(){var queue=jQuery.queue(this,type,data);jQuery._queueHooks(this,type);if(type==="fx"&&queue[0]!=="inprogress"){jQuery.dequeue(this,type)}}))},dequeue:function(type){return this.each((function(){jQuery.dequeue(this,type)}))},clearQueue:function(type){return this.queue(type||"fx",[])},promise:function(type,obj){var tmp,count=1,defer=jQuery.Deferred(),elements=this,i=this.length,resolve=function(){if(! --count){defer.resolveWith(elements,[elements])}};if(typeof type!=="string"){obj=type;type=undefined}type=type||"fx";while(i--){tmp=dataPriv.get(elements[i],type+"queueHooks");if(tmp&&tmp.empty){count++;tmp.empty.add(resolve)}}resolve();return defer.promise(obj)}});var pnum=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source;var rcssNum=new RegExp("^(?:([+-])=|)("+pnum+")([a-z%]*)$","i");var cssExpand=["Top","Right","Bottom","Left"];var documentElement=document.documentElement;var isAttached=function(elem){return jQuery.contains(elem.ownerDocument,elem)},composed={composed:true};if(documentElement.getRootNode){isAttached=function(elem){return jQuery.contains(elem.ownerDocument,elem)||elem.getRootNode(composed)===elem.ownerDocument}}var isHiddenWithinTree=function(elem,el){elem=el||elem;return elem.style.display==="none"||elem.style.display===""&&isAttached(elem)&&jQuery.css(elem,"display")==="none"};function adjustCSS(elem,prop,valueParts,tween){var adjusted,scale,maxIterations=20,currentValue=tween?function(){return tween.cur()}:function(){return jQuery.css(elem,prop,"")},initial=currentValue(),unit=valueParts&&valueParts[3]||(jQuery.cssNumber[prop]?"":"px"),initialInUnit=elem.nodeType&&(jQuery.cssNumber[prop]||unit!=="px"&&+initial)&&rcssNum.exec(jQuery.css(elem,prop));if(initialInUnit&&initialInUnit[3]!==unit){initial=initial/2;unit=unit||initialInUnit[3];initialInUnit=+initial||1;while(maxIterations--){jQuery.style(elem,prop,initialInUnit+unit);if((1-scale)*(1-(scale=currentValue()/initial||.5))<=0){maxIterations=0}initialInUnit=initialInUnit/scale}initialInUnit=initialInUnit*2;jQuery.style(elem,prop,initialInUnit+unit);valueParts=valueParts||[]}if(valueParts){initialInUnit=+initialInUnit||+initial||0;adjusted=valueParts[1]?initialInUnit+(valueParts[1]+1)*valueParts[2]:+valueParts[2];if(tween){tween.unit=unit;tween.start=initialInUnit;tween.end=adjusted}}return adjusted}var defaultDisplayMap={};function getDefaultDisplay(elem){var temp,doc=elem.ownerDocument,nodeName=elem.nodeName,display=defaultDisplayMap[nodeName];if(display){return display}temp=doc.body.appendChild(doc.createElement(nodeName));display=jQuery.css(temp,"display");temp.parentNode.removeChild(temp);if(display==="none"){display="block"}defaultDisplayMap[nodeName]=display;return display}function showHide(elements,show){var display,elem,values=[],index=0,length=elements.length;for(;index<length;index++){elem=elements[index];if(!elem.style){continue}display=elem.style.display;if(show){if(display==="none"){values[index]=dataPriv.get(elem,"display")||null;if(!values[index]){elem.style.display=""}}if(elem.style.display===""&&isHiddenWithinTree(elem)){values[index]=getDefaultDisplay(elem)}}else{if(display!=="none"){values[index]="none";dataPriv.set(elem,"display",display)}}}for(index=0;index<length;index++){if(values[index]!=null){elements[index].style.display=values[index]}}return elements}jQuery.fn.extend({show:function(){return showHide(this,true)},hide:function(){return showHide(this)},toggle:function(state){if(typeof state==="boolean"){return state?this.show():this.hide()}return this.each((function(){if(isHiddenWithinTree(this)){jQuery(this).show()}else{jQuery(this).hide()}}))}});var rcheckableType=/^(?:checkbox|radio)$/i;var rtagName=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i;var rscriptType=/^$|^module$|\/(?:java|ecma)script/i;(function(){var fragment=document.createDocumentFragment(),div=fragment.appendChild(document.createElement("div")),input=document.createElement("input");input.setAttribute("type","radio");input.setAttribute("checked","checked");input.setAttribute("name","t");div.appendChild(input);support.checkClone=div.cloneNode(true).cloneNode(true).lastChild.checked;div.innerHTML="<textarea>x</textarea>";support.noCloneChecked=!!div.cloneNode(true).lastChild.defaultValue;div.innerHTML="<option></option>";support.option=!!div.lastChild})();var wrapMap={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};wrapMap.tbody=wrapMap.tfoot=wrapMap.colgroup=wrapMap.caption=wrapMap.thead;wrapMap.th=wrapMap.td;if(!support.option){wrapMap.optgroup=wrapMap.option=[1,"<select multiple='multiple'>","</select>"]}function getAll(context,tag){var ret;if(typeof context.getElementsByTagName!=="undefined"){ret=context.getElementsByTagName(tag||"*")}else if(typeof context.querySelectorAll!=="undefined"){ret=context.querySelectorAll(tag||"*")}else{ret=[]}if(tag===undefined||tag&&nodeName(context,tag)){return jQuery.merge([context],ret)}return ret}function setGlobalEval(elems,refElements){var i=0,l=elems.length;for(;i<l;i++){dataPriv.set(elems[i],"globalEval",!refElements||dataPriv.get(refElements[i],"globalEval"))}}var rhtml=/<|&#?\w+;/;function buildFragment(elems,context,scripts,selection,ignored){var elem,tmp,tag,wrap,attached,j,fragment=context.createDocumentFragment(),nodes=[],i=0,l=elems.length;for(;i<l;i++){elem=elems[i];if(elem||elem===0){if(toType(elem)==="object"){jQuery.merge(nodes,elem.nodeType?[elem]:elem)}else if(!rhtml.test(elem)){nodes.push(context.createTextNode(elem))}else{tmp=tmp||fragment.appendChild(context.createElement("div"));tag=(rtagName.exec(elem)||["",""])[1].toLowerCase();wrap=wrapMap[tag]||wrapMap._default;tmp.innerHTML=wrap[1]+jQuery.htmlPrefilter(elem)+wrap[2];j=wrap[0];while(j--){tmp=tmp.lastChild}jQuery.merge(nodes,tmp.childNodes);tmp=fragment.firstChild;tmp.textContent=""}}}fragment.textContent="";i=0;while(elem=nodes[i++]){if(selection&&jQuery.inArray(elem,selection)>-1){if(ignored){ignored.push(elem)}continue}attached=isAttached(elem);tmp=getAll(fragment.appendChild(elem),"script");if(attached){setGlobalEval(tmp)}if(scripts){j=0;while(elem=tmp[j++]){if(rscriptType.test(elem.type||"")){scripts.push(elem)}}}}return fragment}var rtypenamespace=/^([^.]*)(?:\.(.+)|)/;function returnTrue(){return true}function returnFalse(){return false}function expectSync(elem,type){return elem===safeActiveElement()===(type==="focus")}function safeActiveElement(){try{return document.activeElement}catch(err){}}function on(elem,types,selector,data,fn,one){var origFn,type;if(typeof types==="object"){if(typeof selector!=="string"){data=data||selector;selector=undefined}for(type in types){on(elem,type,selector,data,types[type],one)}return elem}if(data==null&&fn==null){fn=selector;data=selector=undefined}else if(fn==null){if(typeof selector==="string"){fn=data;data=undefined}else{fn=data;data=selector;selector=undefined}}if(fn===false){fn=returnFalse}else if(!fn){return elem}if(one===1){origFn=fn;fn=function(event){jQuery().off(event);return origFn.apply(this,arguments)};fn.guid=origFn.guid||(origFn.guid=jQuery.guid++)}return elem.each((function(){jQuery.event.add(this,types,fn,data,selector)}))}jQuery.event={global:{},add:function(elem,types,handler,data,selector){var handleObjIn,eventHandle,tmp,events,t,handleObj,special,handlers,type,namespaces,origType,elemData=dataPriv.get(elem);if(!acceptData(elem)){return}if(handler.handler){handleObjIn=handler;handler=handleObjIn.handler;selector=handleObjIn.selector}if(selector){jQuery.find.matchesSelector(documentElement,selector)}if(!handler.guid){handler.guid=jQuery.guid++}if(!(events=elemData.events)){events=elemData.events=Object.create(null)}if(!(eventHandle=elemData.handle)){eventHandle=elemData.handle=function(e){return typeof jQuery!=="undefined"&&jQuery.event.triggered!==e.type?jQuery.event.dispatch.apply(elem,arguments):undefined}}types=(types||"").match(rnothtmlwhite)||[""];t=types.length;while(t--){tmp=rtypenamespace.exec(types[t])||[];type=origType=tmp[1];namespaces=(tmp[2]||"").split(".").sort();if(!type){continue}special=jQuery.event.special[type]||{};type=(selector?special.delegateType:special.bindType)||type;special=jQuery.event.special[type]||{};handleObj=jQuery.extend({type:type,origType:origType,data:data,handler:handler,guid:handler.guid,selector:selector,needsContext:selector&&jQuery.expr.match.needsContext.test(selector),namespace:namespaces.join(".")},handleObjIn);if(!(handlers=events[type])){handlers=events[type]=[];handlers.delegateCount=0;if(!special.setup||special.setup.call(elem,data,namespaces,eventHandle)===false){if(elem.addEventListener){elem.addEventListener(type,eventHandle)}}}if(special.add){special.add.call(elem,handleObj);if(!handleObj.handler.guid){handleObj.handler.guid=handler.guid}}if(selector){handlers.splice(handlers.delegateCount++,0,handleObj)}else{handlers.push(handleObj)}jQuery.event.global[type]=true}},remove:function(elem,types,handler,selector,mappedTypes){var j,origCount,tmp,events,t,handleObj,special,handlers,type,namespaces,origType,elemData=dataPriv.hasData(elem)&&dataPriv.get(elem);if(!elemData||!(events=elemData.events)){return}types=(types||"").match(rnothtmlwhite)||[""];t=types.length;while(t--){tmp=rtypenamespace.exec(types[t])||[];type=origType=tmp[1];namespaces=(tmp[2]||"").split(".").sort();if(!type){for(type in events){jQuery.event.remove(elem,type+types[t],handler,selector,true)}continue}special=jQuery.event.special[type]||{};type=(selector?special.delegateType:special.bindType)||type;handlers=events[type]||[];tmp=tmp[2]&&new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)");origCount=j=handlers.length;while(j--){handleObj=handlers[j];if((mappedTypes||origType===handleObj.origType)&&(!handler||handler.guid===handleObj.guid)&&(!tmp||tmp.test(handleObj.namespace))&&(!selector||selector===handleObj.selector||selector==="**"&&handleObj.selector)){handlers.splice(j,1);if(handleObj.selector){handlers.delegateCount--}if(special.remove){special.remove.call(elem,handleObj)}}}if(origCount&&!handlers.length){if(!special.teardown||special.teardown.call(elem,namespaces,elemData.handle)===false){jQuery.removeEvent(elem,type,elemData.handle)}delete events[type]}}if(jQuery.isEmptyObject(events)){dataPriv.remove(elem,"handle events")}},dispatch:function(nativeEvent){var i,j,ret,matched,handleObj,handlerQueue,args=new Array(arguments.length),event=jQuery.event.fix(nativeEvent),handlers=(dataPriv.get(this,"events")||Object.create(null))[event.type]||[],special=jQuery.event.special[event.type]||{};args[0]=event;for(i=1;i<arguments.length;i++){args[i]=arguments[i]}event.delegateTarget=this;if(special.preDispatch&&special.preDispatch.call(this,event)===false){return}handlerQueue=jQuery.event.handlers.call(this,event,handlers);i=0;while((matched=handlerQueue[i++])&&!event.isPropagationStopped()){event.currentTarget=matched.elem;j=0;while((handleObj=matched.handlers[j++])&&!event.isImmediatePropagationStopped()){if(!event.rnamespace||handleObj.namespace===false||event.rnamespace.test(handleObj.namespace)){event.handleObj=handleObj;event.data=handleObj.data;ret=((jQuery.event.special[handleObj.origType]||{}).handle||handleObj.handler).apply(matched.elem,args);if(ret!==undefined){if((event.result=ret)===false){event.preventDefault();event.stopPropagation()}}}}}if(special.postDispatch){special.postDispatch.call(this,event)}return event.result},handlers:function(event,handlers){var i,handleObj,sel,matchedHandlers,matchedSelectors,handlerQueue=[],delegateCount=handlers.delegateCount,cur=event.target;if(delegateCount&&cur.nodeType&&!(event.type==="click"&&event.button>=1)){for(;cur!==this;cur=cur.parentNode||this){if(cur.nodeType===1&&!(event.type==="click"&&cur.disabled===true)){matchedHandlers=[];matchedSelectors={};for(i=0;i<delegateCount;i++){handleObj=handlers[i];sel=handleObj.selector+" ";if(matchedSelectors[sel]===undefined){matchedSelectors[sel]=handleObj.needsContext?jQuery(sel,this).index(cur)>-1:jQuery.find(sel,this,null,[cur]).length}if(matchedSelectors[sel]){matchedHandlers.push(handleObj)}}if(matchedHandlers.length){handlerQueue.push({elem:cur,handlers:matchedHandlers})}}}}cur=this;if(delegateCount<handlers.length){handlerQueue.push({elem:cur,handlers:handlers.slice(delegateCount)})}return handlerQueue},addProp:function(name,hook){Object.defineProperty(jQuery.Event.prototype,name,{enumerable:true,configurable:true,get:isFunction(hook)?function(){if(this.originalEvent){return hook(this.originalEvent)}}:function(){if(this.originalEvent){return this.originalEvent[name]}},set:function(value){Object.defineProperty(this,name,{enumerable:true,configurable:true,writable:true,value:value})}})},fix:function(originalEvent){return originalEvent[jQuery.expando]?originalEvent:new jQuery.Event(originalEvent)},special:{load:{noBubble:true},click:{setup:function(data){var el=this||data;if(rcheckableType.test(el.type)&&el.click&&nodeName(el,"input")){leverageNative(el,"click",returnTrue)}return false},trigger:function(data){var el=this||data;if(rcheckableType.test(el.type)&&el.click&&nodeName(el,"input")){leverageNative(el,"click")}return true},_default:function(event){var target=event.target;return rcheckableType.test(target.type)&&target.click&&nodeName(target,"input")&&dataPriv.get(target,"click")||nodeName(target,"a")}},beforeunload:{postDispatch:function(event){if(event.result!==undefined&&event.originalEvent){event.originalEvent.returnValue=event.result}}}}};function leverageNative(el,type,expectSync){if(!expectSync){if(dataPriv.get(el,type)===undefined){jQuery.event.add(el,type,returnTrue)}return}dataPriv.set(el,type,false);jQuery.event.add(el,type,{namespace:false,handler:function(event){var notAsync,result,saved=dataPriv.get(this,type);if(event.isTrigger&1&&this[type]){if(!saved.length){saved=slice.call(arguments);dataPriv.set(this,type,saved);notAsync=expectSync(this,type);this[type]();result=dataPriv.get(this,type);if(saved!==result||notAsync){dataPriv.set(this,type,false)}else{result={}}if(saved!==result){event.stopImmediatePropagation();event.preventDefault();return result&&result.value}}else if((jQuery.event.special[type]||{}).delegateType){event.stopPropagation()}}else if(saved.length){dataPriv.set(this,type,{value:jQuery.event.trigger(jQuery.extend(saved[0],jQuery.Event.prototype),saved.slice(1),this)});event.stopImmediatePropagation()}}})}jQuery.removeEvent=function(elem,type,handle){if(elem.removeEventListener){elem.removeEventListener(type,handle)}};jQuery.Event=function(src,props){if(!(this instanceof jQuery.Event)){return new jQuery.Event(src,props)}if(src&&src.type){this.originalEvent=src;this.type=src.type;this.isDefaultPrevented=src.defaultPrevented||src.defaultPrevented===undefined&&src.returnValue===false?returnTrue:returnFalse;this.target=src.target&&src.target.nodeType===3?src.target.parentNode:src.target;this.currentTarget=src.currentTarget;this.relatedTarget=src.relatedTarget}else{this.type=src}if(props){jQuery.extend(this,props)}this.timeStamp=src&&src.timeStamp||Date.now();this[jQuery.expando]=true};jQuery.Event.prototype={constructor:jQuery.Event,isDefaultPrevented:returnFalse,isPropagationStopped:returnFalse,isImmediatePropagationStopped:returnFalse,isSimulated:false,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=returnTrue;if(e&&!this.isSimulated){e.preventDefault()}},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=returnTrue;if(e&&!this.isSimulated){e.stopPropagation()}},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=returnTrue;if(e&&!this.isSimulated){e.stopImmediatePropagation()}this.stopPropagation()}};jQuery.each({altKey:true,bubbles:true,cancelable:true,changedTouches:true,ctrlKey:true,detail:true,eventPhase:true,metaKey:true,pageX:true,pageY:true,shiftKey:true,view:true,char:true,code:true,charCode:true,key:true,keyCode:true,button:true,buttons:true,clientX:true,clientY:true,offsetX:true,offsetY:true,pointerId:true,pointerType:true,screenX:true,screenY:true,targetTouches:true,toElement:true,touches:true,which:true},jQuery.event.addProp);jQuery.each({focus:"focusin",blur:"focusout"},(function(type,delegateType){jQuery.event.special[type]={setup:function(){leverageNative(this,type,expectSync);return false},trigger:function(){leverageNative(this,type);return true},_default:function(){return true},delegateType:delegateType}}));jQuery.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},(function(orig,fix){jQuery.event.special[orig]={delegateType:fix,bindType:fix,handle:function(event){var ret,target=this,related=event.relatedTarget,handleObj=event.handleObj;if(!related||related!==target&&!jQuery.contains(target,related)){event.type=handleObj.origType;ret=handleObj.handler.apply(this,arguments);event.type=fix}return ret}}}));jQuery.fn.extend({on:function(types,selector,data,fn){return on(this,types,selector,data,fn)},one:function(types,selector,data,fn){return on(this,types,selector,data,fn,1)},off:function(types,selector,fn){var handleObj,type;if(types&&types.preventDefault&&types.handleObj){handleObj=types.handleObj;jQuery(types.delegateTarget).off(handleObj.namespace?handleObj.origType+"."+handleObj.namespace:handleObj.origType,handleObj.selector,handleObj.handler);return this}if(typeof types==="object"){for(type in types){this.off(type,selector,types[type])}return this}if(selector===false||typeof selector==="function"){fn=selector;selector=undefined}if(fn===false){fn=returnFalse}return this.each((function(){jQuery.event.remove(this,types,fn,selector)}))}});var rnoInnerhtml=/<script|<style|<link/i,rchecked=/checked\s*(?:[^=]|=\s*.checked.)/i,rcleanScript=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function manipulationTarget(elem,content){if(nodeName(elem,"table")&&nodeName(content.nodeType!==11?content:content.firstChild,"tr")){return jQuery(elem).children("tbody")[0]||elem}return elem}function disableScript(elem){elem.type=(elem.getAttribute("type")!==null)+"/"+elem.type;return elem}function restoreScript(elem){if((elem.type||"").slice(0,5)==="true/"){elem.type=elem.type.slice(5)}else{elem.removeAttribute("type")}return elem}function cloneCopyEvent(src,dest){var i,l,type,pdataOld,udataOld,udataCur,events;if(dest.nodeType!==1){return}if(dataPriv.hasData(src)){pdataOld=dataPriv.get(src);events=pdataOld.events;if(events){dataPriv.remove(dest,"handle events");for(type in events){for(i=0,l=events[type].length;i<l;i++){jQuery.event.add(dest,type,events[type][i])}}}}if(dataUser.hasData(src)){udataOld=dataUser.access(src);udataCur=jQuery.extend({},udataOld);dataUser.set(dest,udataCur)}}function fixInput(src,dest){var nodeName=dest.nodeName.toLowerCase();if(nodeName==="input"&&rcheckableType.test(src.type)){dest.checked=src.checked}else if(nodeName==="input"||nodeName==="textarea"){dest.defaultValue=src.defaultValue}}function domManip(collection,args,callback,ignored){args=flat(args);var fragment,first,scripts,hasScripts,node,doc,i=0,l=collection.length,iNoClone=l-1,value=args[0],valueIsFunction=isFunction(value);if(valueIsFunction||l>1&&typeof value==="string"&&!support.checkClone&&rchecked.test(value)){return collection.each((function(index){var self=collection.eq(index);if(valueIsFunction){args[0]=value.call(this,index,self.html())}domManip(self,args,callback,ignored)}))}if(l){fragment=buildFragment(args,collection[0].ownerDocument,false,collection,ignored);first=fragment.firstChild;if(fragment.childNodes.length===1){fragment=first}if(first||ignored){scripts=jQuery.map(getAll(fragment,"script"),disableScript);hasScripts=scripts.length;for(;i<l;i++){node=fragment;if(i!==iNoClone){node=jQuery.clone(node,true,true);if(hasScripts){jQuery.merge(scripts,getAll(node,"script"))}}callback.call(collection[i],node,i)}if(hasScripts){doc=scripts[scripts.length-1].ownerDocument;jQuery.map(scripts,restoreScript);for(i=0;i<hasScripts;i++){node=scripts[i];if(rscriptType.test(node.type||"")&&!dataPriv.access(node,"globalEval")&&jQuery.contains(doc,node)){if(node.src&&(node.type||"").toLowerCase()!=="module"){if(jQuery._evalUrl&&!node.noModule){jQuery._evalUrl(node.src,{nonce:node.nonce||node.getAttribute("nonce")},doc)}}else{DOMEval(node.textContent.replace(rcleanScript,""),node,doc)}}}}}}return collection}function remove(elem,selector,keepData){var node,nodes=selector?jQuery.filter(selector,elem):elem,i=0;for(;(node=nodes[i])!=null;i++){if(!keepData&&node.nodeType===1){jQuery.cleanData(getAll(node))}if(node.parentNode){if(keepData&&isAttached(node)){setGlobalEval(getAll(node,"script"))}node.parentNode.removeChild(node)}}return elem}jQuery.extend({htmlPrefilter:function(html){return html},clone:function(elem,dataAndEvents,deepDataAndEvents){var i,l,srcElements,destElements,clone=elem.cloneNode(true),inPage=isAttached(elem);if(!support.noCloneChecked&&(elem.nodeType===1||elem.nodeType===11)&&!jQuery.isXMLDoc(elem)){destElements=getAll(clone);srcElements=getAll(elem);for(i=0,l=srcElements.length;i<l;i++){fixInput(srcElements[i],destElements[i])}}if(dataAndEvents){if(deepDataAndEvents){srcElements=srcElements||getAll(elem);destElements=destElements||getAll(clone);for(i=0,l=srcElements.length;i<l;i++){cloneCopyEvent(srcElements[i],destElements[i])}}else{cloneCopyEvent(elem,clone)}}destElements=getAll(clone,"script");if(destElements.length>0){setGlobalEval(destElements,!inPage&&getAll(elem,"script"))}return clone},cleanData:function(elems){var data,elem,type,special=jQuery.event.special,i=0;for(;(elem=elems[i])!==undefined;i++){if(acceptData(elem)){if(data=elem[dataPriv.expando]){if(data.events){for(type in data.events){if(special[type]){jQuery.event.remove(elem,type)}else{jQuery.removeEvent(elem,type,data.handle)}}}elem[dataPriv.expando]=undefined}if(elem[dataUser.expando]){elem[dataUser.expando]=undefined}}}}});jQuery.fn.extend({detach:function(selector){return remove(this,selector,true)},remove:function(selector){return remove(this,selector)},text:function(value){return access(this,(function(value){return value===undefined?jQuery.text(this):this.empty().each((function(){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){this.textContent=value}}))}),null,value,arguments.length)},append:function(){return domManip(this,arguments,(function(elem){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){var target=manipulationTarget(this,elem);target.appendChild(elem)}}))},prepend:function(){return domManip(this,arguments,(function(elem){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){var target=manipulationTarget(this,elem);target.insertBefore(elem,target.firstChild)}}))},before:function(){return domManip(this,arguments,(function(elem){if(this.parentNode){this.parentNode.insertBefore(elem,this)}}))},after:function(){return domManip(this,arguments,(function(elem){if(this.parentNode){this.parentNode.insertBefore(elem,this.nextSibling)}}))},empty:function(){var elem,i=0;for(;(elem=this[i])!=null;i++){if(elem.nodeType===1){jQuery.cleanData(getAll(elem,false));elem.textContent=""}}return this},clone:function(dataAndEvents,deepDataAndEvents){dataAndEvents=dataAndEvents==null?false:dataAndEvents;deepDataAndEvents=deepDataAndEvents==null?dataAndEvents:deepDataAndEvents;return this.map((function(){return jQuery.clone(this,dataAndEvents,deepDataAndEvents)}))},html:function(value){return access(this,(function(value){var elem=this[0]||{},i=0,l=this.length;if(value===undefined&&elem.nodeType===1){return elem.innerHTML}if(typeof value==="string"&&!rnoInnerhtml.test(value)&&!wrapMap[(rtagName.exec(value)||["",""])[1].toLowerCase()]){value=jQuery.htmlPrefilter(value);try{for(;i<l;i++){elem=this[i]||{};if(elem.nodeType===1){jQuery.cleanData(getAll(elem,false));elem.innerHTML=value}}elem=0}catch(e){}}if(elem){this.empty().append(value)}}),null,value,arguments.length)},replaceWith:function(){var ignored=[];return domManip(this,arguments,(function(elem){var parent=this.parentNode;if(jQuery.inArray(this,ignored)<0){jQuery.cleanData(getAll(this));if(parent){parent.replaceChild(elem,this)}}}),ignored)}});jQuery.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},(function(name,original){jQuery.fn[name]=function(selector){var elems,ret=[],insert=jQuery(selector),last=insert.length-1,i=0;for(;i<=last;i++){elems=i===last?this:this.clone(true);jQuery(insert[i])[original](elems);push.apply(ret,elems.get())}return this.pushStack(ret)}}));var rnumnonpx=new RegExp("^("+pnum+")(?!px)[a-z%]+$","i");var getStyles=function(elem){var view=elem.ownerDocument.defaultView;if(!view||!view.opener){view=window}return view.getComputedStyle(elem)};var swap=function(elem,options,callback){var ret,name,old={};for(name in options){old[name]=elem.style[name];elem.style[name]=options[name]}ret=callback.call(elem);for(name in options){elem.style[name]=old[name]}return ret};var rboxStyle=new RegExp(cssExpand.join("|"),"i");(function(){function computeStyleTests(){if(!div){return}container.style.cssText="position:absolute;left:-11111px;width:60px;"+"margin-top:1px;padding:0;border:0";div.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;"+"margin:auto;border:1px;padding:1px;"+"width:60%;top:1%";documentElement.appendChild(container).appendChild(div);var divStyle=window.getComputedStyle(div);pixelPositionVal=divStyle.top!=="1%";reliableMarginLeftVal=roundPixelMeasures(divStyle.marginLeft)===12;div.style.right="60%";pixelBoxStylesVal=roundPixelMeasures(divStyle.right)===36;boxSizingReliableVal=roundPixelMeasures(divStyle.width)===36;div.style.position="absolute";scrollboxSizeVal=roundPixelMeasures(div.offsetWidth/3)===12;documentElement.removeChild(container);div=null}function roundPixelMeasures(measure){return Math.round(parseFloat(measure))}var pixelPositionVal,boxSizingReliableVal,scrollboxSizeVal,pixelBoxStylesVal,reliableTrDimensionsVal,reliableMarginLeftVal,container=document.createElement("div"),div=document.createElement("div");if(!div.style){return}div.style.backgroundClip="content-box";div.cloneNode(true).style.backgroundClip="";support.clearCloneStyle=div.style.backgroundClip==="content-box";jQuery.extend(support,{boxSizingReliable:function(){computeStyleTests();return boxSizingReliableVal},pixelBoxStyles:function(){computeStyleTests();return pixelBoxStylesVal},pixelPosition:function(){computeStyleTests();return pixelPositionVal},reliableMarginLeft:function(){computeStyleTests();return reliableMarginLeftVal},scrollboxSize:function(){computeStyleTests();return scrollboxSizeVal},reliableTrDimensions:function(){var table,tr,trChild,trStyle;if(reliableTrDimensionsVal==null){table=document.createElement("table");tr=document.createElement("tr");trChild=document.createElement("div");table.style.cssText="position:absolute;left:-11111px;border-collapse:separate";tr.style.cssText="border:1px solid";tr.style.height="1px";trChild.style.height="9px";trChild.style.display="block";documentElement.appendChild(table).appendChild(tr).appendChild(trChild);trStyle=window.getComputedStyle(tr);reliableTrDimensionsVal=parseInt(trStyle.height,10)+parseInt(trStyle.borderTopWidth,10)+parseInt(trStyle.borderBottomWidth,10)===tr.offsetHeight;documentElement.removeChild(table)}return reliableTrDimensionsVal}})})();function curCSS(elem,name,computed){var width,minWidth,maxWidth,ret,style=elem.style;computed=computed||getStyles(elem);if(computed){ret=computed.getPropertyValue(name)||computed[name];if(ret===""&&!isAttached(elem)){ret=jQuery.style(elem,name)}if(!support.pixelBoxStyles()&&rnumnonpx.test(ret)&&rboxStyle.test(name)){width=style.width;minWidth=style.minWidth;maxWidth=style.maxWidth;style.minWidth=style.maxWidth=style.width=ret;ret=computed.width;style.width=width;style.minWidth=minWidth;style.maxWidth=maxWidth}}return ret!==undefined?ret+"":ret}function addGetHookIf(conditionFn,hookFn){return{get:function(){if(conditionFn()){delete this.get;return}return(this.get=hookFn).apply(this,arguments)}}}var cssPrefixes=["Webkit","Moz","ms"],emptyStyle=document.createElement("div").style,vendorProps={};function vendorPropName(name){var capName=name[0].toUpperCase()+name.slice(1),i=cssPrefixes.length;while(i--){name=cssPrefixes[i]+capName;if(name in emptyStyle){return name}}}function finalPropName(name){var final=jQuery.cssProps[name]||vendorProps[name];if(final){return final}if(name in emptyStyle){return name}return vendorProps[name]=vendorPropName(name)||name}var rdisplayswap=/^(none|table(?!-c[ea]).+)/,rcustomProp=/^--/,cssShow={position:"absolute",visibility:"hidden",display:"block"},cssNormalTransform={letterSpacing:"0",fontWeight:"400"};function setPositiveNumber(_elem,value,subtract){var matches=rcssNum.exec(value);return matches?Math.max(0,matches[2]-(subtract||0))+(matches[3]||"px"):value}function boxModelAdjustment(elem,dimension,box,isBorderBox,styles,computedVal){var i=dimension==="width"?1:0,extra=0,delta=0;if(box===(isBorderBox?"border":"content")){return 0}for(;i<4;i+=2){if(box==="margin"){delta+=jQuery.css(elem,box+cssExpand[i],true,styles)}if(!isBorderBox){delta+=jQuery.css(elem,"padding"+cssExpand[i],true,styles);if(box!=="padding"){delta+=jQuery.css(elem,"border"+cssExpand[i]+"Width",true,styles)}else{extra+=jQuery.css(elem,"border"+cssExpand[i]+"Width",true,styles)}}else{if(box==="content"){delta-=jQuery.css(elem,"padding"+cssExpand[i],true,styles)}if(box!=="margin"){delta-=jQuery.css(elem,"border"+cssExpand[i]+"Width",true,styles)}}}if(!isBorderBox&&computedVal>=0){delta+=Math.max(0,Math.ceil(elem["offset"+dimension[0].toUpperCase()+dimension.slice(1)]-computedVal-delta-extra-.5))||0}return delta}function getWidthOrHeight(elem,dimension,extra){var styles=getStyles(elem),boxSizingNeeded=!support.boxSizingReliable()||extra,isBorderBox=boxSizingNeeded&&jQuery.css(elem,"boxSizing",false,styles)==="border-box",valueIsBorderBox=isBorderBox,val=curCSS(elem,dimension,styles),offsetProp="offset"+dimension[0].toUpperCase()+dimension.slice(1);if(rnumnonpx.test(val)){if(!extra){return val}val="auto"}if((!support.boxSizingReliable()&&isBorderBox||!support.reliableTrDimensions()&&nodeName(elem,"tr")||val==="auto"||!parseFloat(val)&&jQuery.css(elem,"display",false,styles)==="inline")&&elem.getClientRects().length){isBorderBox=jQuery.css(elem,"boxSizing",false,styles)==="border-box";valueIsBorderBox=offsetProp in elem;if(valueIsBorderBox){val=elem[offsetProp]}}val=parseFloat(val)||0;return val+boxModelAdjustment(elem,dimension,extra||(isBorderBox?"border":"content"),valueIsBorderBox,styles,val)+"px"}jQuery.extend({cssHooks:{opacity:{get:function(elem,computed){if(computed){var ret=curCSS(elem,"opacity");return ret===""?"1":ret}}}},cssNumber:{animationIterationCount:true,columnCount:true,fillOpacity:true,flexGrow:true,flexShrink:true,fontWeight:true,gridArea:true,gridColumn:true,gridColumnEnd:true,gridColumnStart:true,gridRow:true,gridRowEnd:true,gridRowStart:true,lineHeight:true,opacity:true,order:true,orphans:true,widows:true,zIndex:true,zoom:true},cssProps:{},style:function(elem,name,value,extra){if(!elem||elem.nodeType===3||elem.nodeType===8||!elem.style){return}var ret,type,hooks,origName=camelCase(name),isCustomProp=rcustomProp.test(name),style=elem.style;if(!isCustomProp){name=finalPropName(origName)}hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName];if(value!==undefined){type=typeof value;if(type==="string"&&(ret=rcssNum.exec(value))&&ret[1]){value=adjustCSS(elem,name,ret);type="number"}if(value==null||value!==value){return}if(type==="number"&&!isCustomProp){value+=ret&&ret[3]||(jQuery.cssNumber[origName]?"":"px")}if(!support.clearCloneStyle&&value===""&&name.indexOf("background")===0){style[name]="inherit"}if(!hooks||!("set"in hooks)||(value=hooks.set(elem,value,extra))!==undefined){if(isCustomProp){style.setProperty(name,value)}else{style[name]=value}}}else{if(hooks&&"get"in hooks&&(ret=hooks.get(elem,false,extra))!==undefined){return ret}return style[name]}},css:function(elem,name,extra,styles){var val,num,hooks,origName=camelCase(name),isCustomProp=rcustomProp.test(name);if(!isCustomProp){name=finalPropName(origName)}hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName];if(hooks&&"get"in hooks){val=hooks.get(elem,true,extra)}if(val===undefined){val=curCSS(elem,name,styles)}if(val==="normal"&&name in cssNormalTransform){val=cssNormalTransform[name]}if(extra===""||extra){num=parseFloat(val);return extra===true||isFinite(num)?num||0:val}return val}});jQuery.each(["height","width"],(function(_i,dimension){jQuery.cssHooks[dimension]={get:function(elem,computed,extra){if(computed){return rdisplayswap.test(jQuery.css(elem,"display"))&&(!elem.getClientRects().length||!elem.getBoundingClientRect().width)?swap(elem,cssShow,(function(){return getWidthOrHeight(elem,dimension,extra)})):getWidthOrHeight(elem,dimension,extra)}},set:function(elem,value,extra){var matches,styles=getStyles(elem),scrollboxSizeBuggy=!support.scrollboxSize()&&styles.position==="absolute",boxSizingNeeded=scrollboxSizeBuggy||extra,isBorderBox=boxSizingNeeded&&jQuery.css(elem,"boxSizing",false,styles)==="border-box",subtract=extra?boxModelAdjustment(elem,dimension,extra,isBorderBox,styles):0;if(isBorderBox&&scrollboxSizeBuggy){subtract-=Math.ceil(elem["offset"+dimension[0].toUpperCase()+dimension.slice(1)]-parseFloat(styles[dimension])-boxModelAdjustment(elem,dimension,"border",false,styles)-.5)}if(subtract&&(matches=rcssNum.exec(value))&&(matches[3]||"px")!=="px"){elem.style[dimension]=value;value=jQuery.css(elem,dimension)}return setPositiveNumber(elem,value,subtract)}}}));jQuery.cssHooks.marginLeft=addGetHookIf(support.reliableMarginLeft,(function(elem,computed){if(computed){return(parseFloat(curCSS(elem,"marginLeft"))||elem.getBoundingClientRect().left-swap(elem,{marginLeft:0},(function(){return elem.getBoundingClientRect().left})))+"px"}}));jQuery.each({margin:"",padding:"",border:"Width"},(function(prefix,suffix){jQuery.cssHooks[prefix+suffix]={expand:function(value){var i=0,expanded={},parts=typeof value==="string"?value.split(" "):[value];for(;i<4;i++){expanded[prefix+cssExpand[i]+suffix]=parts[i]||parts[i-2]||parts[0]}return expanded}};if(prefix!=="margin"){jQuery.cssHooks[prefix+suffix].set=setPositiveNumber}}));jQuery.fn.extend({css:function(name,value){return access(this,(function(elem,name,value){var styles,len,map={},i=0;if(Array.isArray(name)){styles=getStyles(elem);len=name.length;for(;i<len;i++){map[name[i]]=jQuery.css(elem,name[i],false,styles)}return map}return value!==undefined?jQuery.style(elem,name,value):jQuery.css(elem,name)}),name,value,arguments.length>1)}});function Tween(elem,options,prop,end,easing){return new Tween.prototype.init(elem,options,prop,end,easing)}jQuery.Tween=Tween;Tween.prototype={constructor:Tween,init:function(elem,options,prop,end,easing,unit){this.elem=elem;this.prop=prop;this.easing=easing||jQuery.easing._default;this.options=options;this.start=this.now=this.cur();this.end=end;this.unit=unit||(jQuery.cssNumber[prop]?"":"px")},cur:function(){var hooks=Tween.propHooks[this.prop];return hooks&&hooks.get?hooks.get(this):Tween.propHooks._default.get(this)},run:function(percent){var eased,hooks=Tween.propHooks[this.prop];if(this.options.duration){this.pos=eased=jQuery.easing[this.easing](percent,this.options.duration*percent,0,1,this.options.duration)}else{this.pos=eased=percent}this.now=(this.end-this.start)*eased+this.start;if(this.options.step){this.options.step.call(this.elem,this.now,this)}if(hooks&&hooks.set){hooks.set(this)}else{Tween.propHooks._default.set(this)}return this}};Tween.prototype.init.prototype=Tween.prototype;Tween.propHooks={_default:{get:function(tween){var result;if(tween.elem.nodeType!==1||tween.elem[tween.prop]!=null&&tween.elem.style[tween.prop]==null){return tween.elem[tween.prop]}result=jQuery.css(tween.elem,tween.prop,"");return!result||result==="auto"?0:result},set:function(tween){if(jQuery.fx.step[tween.prop]){jQuery.fx.step[tween.prop](tween)}else if(tween.elem.nodeType===1&&(jQuery.cssHooks[tween.prop]||tween.elem.style[finalPropName(tween.prop)]!=null)){jQuery.style(tween.elem,tween.prop,tween.now+tween.unit)}else{tween.elem[tween.prop]=tween.now}}}};Tween.propHooks.scrollTop=Tween.propHooks.scrollLeft={set:function(tween){if(tween.elem.nodeType&&tween.elem.parentNode){tween.elem[tween.prop]=tween.now}}};jQuery.easing={linear:function(p){return p},swing:function(p){return.5-Math.cos(p*Math.PI)/2},_default:"swing"};jQuery.fx=Tween.prototype.init;jQuery.fx.step={};var fxNow,inProgress,rfxtypes=/^(?:toggle|show|hide)$/,rrun=/queueHooks$/;function schedule(){if(inProgress){if(document.hidden===false&&window.requestAnimationFrame){window.requestAnimationFrame(schedule)}else{window.setTimeout(schedule,jQuery.fx.interval)}jQuery.fx.tick()}}function createFxNow(){window.setTimeout((function(){fxNow=undefined}));return fxNow=Date.now()}function genFx(type,includeWidth){var which,i=0,attrs={height:type};includeWidth=includeWidth?1:0;for(;i<4;i+=2-includeWidth){which=cssExpand[i];attrs["margin"+which]=attrs["padding"+which]=type}if(includeWidth){attrs.opacity=attrs.width=type}return attrs}function createTween(value,prop,animation){var tween,collection=(Animation.tweeners[prop]||[]).concat(Animation.tweeners["*"]),index=0,length=collection.length;for(;index<length;index++){if(tween=collection[index].call(animation,prop,value)){return tween}}}function defaultPrefilter(elem,props,opts){var prop,value,toggle,hooks,oldfire,propTween,restoreDisplay,display,isBox="width"in props||"height"in props,anim=this,orig={},style=elem.style,hidden=elem.nodeType&&isHiddenWithinTree(elem),dataShow=dataPriv.get(elem,"fxshow");if(!opts.queue){hooks=jQuery._queueHooks(elem,"fx");if(hooks.unqueued==null){hooks.unqueued=0;oldfire=hooks.empty.fire;hooks.empty.fire=function(){if(!hooks.unqueued){oldfire()}}}hooks.unqueued++;anim.always((function(){anim.always((function(){hooks.unqueued--;if(!jQuery.queue(elem,"fx").length){hooks.empty.fire()}}))}))}for(prop in props){value=props[prop];if(rfxtypes.test(value)){delete props[prop];toggle=toggle||value==="toggle";if(value===(hidden?"hide":"show")){if(value==="show"&&dataShow&&dataShow[prop]!==undefined){hidden=true}else{continue}}orig[prop]=dataShow&&dataShow[prop]||jQuery.style(elem,prop)}}propTween=!jQuery.isEmptyObject(props);if(!propTween&&jQuery.isEmptyObject(orig)){return}if(isBox&&elem.nodeType===1){opts.overflow=[style.overflow,style.overflowX,style.overflowY];restoreDisplay=dataShow&&dataShow.display;if(restoreDisplay==null){restoreDisplay=dataPriv.get(elem,"display")}display=jQuery.css(elem,"display");if(display==="none"){if(restoreDisplay){display=restoreDisplay}else{showHide([elem],true);restoreDisplay=elem.style.display||restoreDisplay;display=jQuery.css(elem,"display");showHide([elem])}}if(display==="inline"||display==="inline-block"&&restoreDisplay!=null){if(jQuery.css(elem,"float")==="none"){if(!propTween){anim.done((function(){style.display=restoreDisplay}));if(restoreDisplay==null){display=style.display;restoreDisplay=display==="none"?"":display}}style.display="inline-block"}}}if(opts.overflow){style.overflow="hidden";anim.always((function(){style.overflow=opts.overflow[0];style.overflowX=opts.overflow[1];style.overflowY=opts.overflow[2]}))}propTween=false;for(prop in orig){if(!propTween){if(dataShow){if("hidden"in dataShow){hidden=dataShow.hidden}}else{dataShow=dataPriv.access(elem,"fxshow",{display:restoreDisplay})}if(toggle){dataShow.hidden=!hidden}if(hidden){showHide([elem],true)}anim.done((function(){if(!hidden){showHide([elem])}dataPriv.remove(elem,"fxshow");for(prop in orig){jQuery.style(elem,prop,orig[prop])}}))}propTween=createTween(hidden?dataShow[prop]:0,prop,anim);if(!(prop in dataShow)){dataShow[prop]=propTween.start;if(hidden){propTween.end=propTween.start;propTween.start=0}}}}function propFilter(props,specialEasing){var index,name,easing,value,hooks;for(index in props){name=camelCase(index);easing=specialEasing[name];value=props[index];if(Array.isArray(value)){easing=value[1];value=props[index]=value[0]}if(index!==name){props[name]=value;delete props[index]}hooks=jQuery.cssHooks[name];if(hooks&&"expand"in hooks){value=hooks.expand(value);delete props[name];for(index in value){if(!(index in props)){props[index]=value[index];specialEasing[index]=easing}}}else{specialEasing[name]=easing}}}function Animation(elem,properties,options){var result,stopped,index=0,length=Animation.prefilters.length,deferred=jQuery.Deferred().always((function(){delete tick.elem})),tick=function(){if(stopped){return false}var currentTime=fxNow||createFxNow(),remaining=Math.max(0,animation.startTime+animation.duration-currentTime),temp=remaining/animation.duration||0,percent=1-temp,index=0,length=animation.tweens.length;for(;index<length;index++){animation.tweens[index].run(percent)}deferred.notifyWith(elem,[animation,percent,remaining]);if(percent<1&&length){return remaining}if(!length){deferred.notifyWith(elem,[animation,1,0])}deferred.resolveWith(elem,[animation]);return false},animation=deferred.promise({elem:elem,props:jQuery.extend({},properties),opts:jQuery.extend(true,{specialEasing:{},easing:jQuery.easing._default},options),originalProperties:properties,originalOptions:options,startTime:fxNow||createFxNow(),duration:options.duration,tweens:[],createTween:function(prop,end){var tween=jQuery.Tween(elem,animation.opts,prop,end,animation.opts.specialEasing[prop]||animation.opts.easing);animation.tweens.push(tween);return tween},stop:function(gotoEnd){var index=0,length=gotoEnd?animation.tweens.length:0;if(stopped){return this}stopped=true;for(;index<length;index++){animation.tweens[index].run(1)}if(gotoEnd){deferred.notifyWith(elem,[animation,1,0]);deferred.resolveWith(elem,[animation,gotoEnd])}else{deferred.rejectWith(elem,[animation,gotoEnd])}return this}}),props=animation.props;propFilter(props,animation.opts.specialEasing);for(;index<length;index++){result=Animation.prefilters[index].call(animation,elem,props,animation.opts);if(result){if(isFunction(result.stop)){jQuery._queueHooks(animation.elem,animation.opts.queue).stop=result.stop.bind(result)}return result}}jQuery.map(props,createTween,animation);if(isFunction(animation.opts.start)){animation.opts.start.call(elem,animation)}animation.progress(animation.opts.progress).done(animation.opts.done,animation.opts.complete).fail(animation.opts.fail).always(animation.opts.always);jQuery.fx.timer(jQuery.extend(tick,{elem:elem,anim:animation,queue:animation.opts.queue}));return animation}jQuery.Animation=jQuery.extend(Animation,{tweeners:{"*":[function(prop,value){var tween=this.createTween(prop,value);adjustCSS(tween.elem,prop,rcssNum.exec(value),tween);return tween}]},tweener:function(props,callback){if(isFunction(props)){callback=props;props=["*"]}else{props=props.match(rnothtmlwhite)}var prop,index=0,length=props.length;for(;index<length;index++){prop=props[index];Animation.tweeners[prop]=Animation.tweeners[prop]||[];Animation.tweeners[prop].unshift(callback)}},prefilters:[defaultPrefilter],prefilter:function(callback,prepend){if(prepend){Animation.prefilters.unshift(callback)}else{Animation.prefilters.push(callback)}}});jQuery.speed=function(speed,easing,fn){var opt=speed&&typeof speed==="object"?jQuery.extend({},speed):{complete:fn||!fn&&easing||isFunction(speed)&&speed,duration:speed,easing:fn&&easing||easing&&!isFunction(easing)&&easing};if(jQuery.fx.off){opt.duration=0}else{if(typeof opt.duration!=="number"){if(opt.duration in jQuery.fx.speeds){opt.duration=jQuery.fx.speeds[opt.duration]}else{opt.duration=jQuery.fx.speeds._default}}}if(opt.queue==null||opt.queue===true){opt.queue="fx"}opt.old=opt.complete;opt.complete=function(){if(isFunction(opt.old)){opt.old.call(this)}if(opt.queue){jQuery.dequeue(this,opt.queue)}};return opt};jQuery.fn.extend({fadeTo:function(speed,to,easing,callback){return this.filter(isHiddenWithinTree).css("opacity",0).show().end().animate({opacity:to},speed,easing,callback)},animate:function(prop,speed,easing,callback){var empty=jQuery.isEmptyObject(prop),optall=jQuery.speed(speed,easing,callback),doAnimation=function(){var anim=Animation(this,jQuery.extend({},prop),optall);if(empty||dataPriv.get(this,"finish")){anim.stop(true)}};doAnimation.finish=doAnimation;return empty||optall.queue===false?this.each(doAnimation):this.queue(optall.queue,doAnimation)},stop:function(type,clearQueue,gotoEnd){var stopQueue=function(hooks){var stop=hooks.stop;delete hooks.stop;stop(gotoEnd)};if(typeof type!=="string"){gotoEnd=clearQueue;clearQueue=type;type=undefined}if(clearQueue){this.queue(type||"fx",[])}return this.each((function(){var dequeue=true,index=type!=null&&type+"queueHooks",timers=jQuery.timers,data=dataPriv.get(this);if(index){if(data[index]&&data[index].stop){stopQueue(data[index])}}else{for(index in data){if(data[index]&&data[index].stop&&rrun.test(index)){stopQueue(data[index])}}}for(index=timers.length;index--;){if(timers[index].elem===this&&(type==null||timers[index].queue===type)){timers[index].anim.stop(gotoEnd);dequeue=false;timers.splice(index,1)}}if(dequeue||!gotoEnd){jQuery.dequeue(this,type)}}))},finish:function(type){if(type!==false){type=type||"fx"}return this.each((function(){var index,data=dataPriv.get(this),queue=data[type+"queue"],hooks=data[type+"queueHooks"],timers=jQuery.timers,length=queue?queue.length:0;data.finish=true;jQuery.queue(this,type,[]);if(hooks&&hooks.stop){hooks.stop.call(this,true)}for(index=timers.length;index--;){if(timers[index].elem===this&&timers[index].queue===type){timers[index].anim.stop(true);timers.splice(index,1)}}for(index=0;index<length;index++){if(queue[index]&&queue[index].finish){queue[index].finish.call(this)}}delete data.finish}))}});jQuery.each(["toggle","show","hide"],(function(_i,name){var cssFn=jQuery.fn[name];jQuery.fn[name]=function(speed,easing,callback){return speed==null||typeof speed==="boolean"?cssFn.apply(this,arguments):this.animate(genFx(name,true),speed,easing,callback)}}));jQuery.each({slideDown:genFx("show"),slideUp:genFx("hide"),slideToggle:genFx("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},(function(name,props){jQuery.fn[name]=function(speed,easing,callback){return this.animate(props,speed,easing,callback)}}));jQuery.timers=[];jQuery.fx.tick=function(){var timer,i=0,timers=jQuery.timers;fxNow=Date.now();for(;i<timers.length;i++){timer=timers[i];if(!timer()&&timers[i]===timer){timers.splice(i--,1)}}if(!timers.length){jQuery.fx.stop()}fxNow=undefined};jQuery.fx.timer=function(timer){jQuery.timers.push(timer);jQuery.fx.start()};jQuery.fx.interval=13;jQuery.fx.start=function(){if(inProgress){return}inProgress=true;schedule()};jQuery.fx.stop=function(){inProgress=null};jQuery.fx.speeds={slow:600,fast:200,_default:400};jQuery.fn.delay=function(time,type){time=jQuery.fx?jQuery.fx.speeds[time]||time:time;type=type||"fx";return this.queue(type,(function(next,hooks){var timeout=window.setTimeout(next,time);hooks.stop=function(){window.clearTimeout(timeout)}}))};(function(){var input=document.createElement("input"),select=document.createElement("select"),opt=select.appendChild(document.createElement("option"));input.type="checkbox";support.checkOn=input.value!=="";support.optSelected=opt.selected;input=document.createElement("input");input.value="t";input.type="radio";support.radioValue=input.value==="t"})();var boolHook,attrHandle=jQuery.expr.attrHandle;jQuery.fn.extend({attr:function(name,value){return access(this,jQuery.attr,name,value,arguments.length>1)},removeAttr:function(name){return this.each((function(){jQuery.removeAttr(this,name)}))}});jQuery.extend({attr:function(elem,name,value){var ret,hooks,nType=elem.nodeType;if(nType===3||nType===8||nType===2){return}if(typeof elem.getAttribute==="undefined"){return jQuery.prop(elem,name,value)}if(nType!==1||!jQuery.isXMLDoc(elem)){hooks=jQuery.attrHooks[name.toLowerCase()]||(jQuery.expr.match.bool.test(name)?boolHook:undefined)}if(value!==undefined){if(value===null){jQuery.removeAttr(elem,name);return}if(hooks&&"set"in hooks&&(ret=hooks.set(elem,value,name))!==undefined){return ret}elem.setAttribute(name,value+"");return value}if(hooks&&"get"in hooks&&(ret=hooks.get(elem,name))!==null){return ret}ret=jQuery.find.attr(elem,name);return ret==null?undefined:ret},attrHooks:{type:{set:function(elem,value){if(!support.radioValue&&value==="radio"&&nodeName(elem,"input")){var val=elem.value;elem.setAttribute("type",value);if(val){elem.value=val}return value}}}},removeAttr:function(elem,value){var name,i=0,attrNames=value&&value.match(rnothtmlwhite);if(attrNames&&elem.nodeType===1){while(name=attrNames[i++]){elem.removeAttribute(name)}}}});boolHook={set:function(elem,value,name){if(value===false){jQuery.removeAttr(elem,name)}else{elem.setAttribute(name,name)}return name}};jQuery.each(jQuery.expr.match.bool.source.match(/\w+/g),(function(_i,name){var getter=attrHandle[name]||jQuery.find.attr;attrHandle[name]=function(elem,name,isXML){var ret,handle,lowercaseName=name.toLowerCase();if(!isXML){handle=attrHandle[lowercaseName];attrHandle[lowercaseName]=ret;ret=getter(elem,name,isXML)!=null?lowercaseName:null;attrHandle[lowercaseName]=handle}return ret}}));var rfocusable=/^(?:input|select|textarea|button)$/i,rclickable=/^(?:a|area)$/i;jQuery.fn.extend({prop:function(name,value){return access(this,jQuery.prop,name,value,arguments.length>1)},removeProp:function(name){return this.each((function(){delete this[jQuery.propFix[name]||name]}))}});jQuery.extend({prop:function(elem,name,value){var ret,hooks,nType=elem.nodeType;if(nType===3||nType===8||nType===2){return}if(nType!==1||!jQuery.isXMLDoc(elem)){name=jQuery.propFix[name]||name;hooks=jQuery.propHooks[name]}if(value!==undefined){if(hooks&&"set"in hooks&&(ret=hooks.set(elem,value,name))!==undefined){return ret}return elem[name]=value}if(hooks&&"get"in hooks&&(ret=hooks.get(elem,name))!==null){return ret}return elem[name]},propHooks:{tabIndex:{get:function(elem){var tabindex=jQuery.find.attr(elem,"tabindex");if(tabindex){return parseInt(tabindex,10)}if(rfocusable.test(elem.nodeName)||rclickable.test(elem.nodeName)&&elem.href){return 0}return-1}}},propFix:{for:"htmlFor",class:"className"}});if(!support.optSelected){jQuery.propHooks.selected={get:function(elem){var parent=elem.parentNode;if(parent&&parent.parentNode){parent.parentNode.selectedIndex}return null},set:function(elem){var parent=elem.parentNode;if(parent){parent.selectedIndex;if(parent.parentNode){parent.parentNode.selectedIndex}}}}}jQuery.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],(function(){jQuery.propFix[this.toLowerCase()]=this}));function stripAndCollapse(value){var tokens=value.match(rnothtmlwhite)||[];return tokens.join(" ")}function getClass(elem){return elem.getAttribute&&elem.getAttribute("class")||""}function classesToArray(value){if(Array.isArray(value)){return value}if(typeof value==="string"){return value.match(rnothtmlwhite)||[]}return[]}jQuery.fn.extend({addClass:function(value){var classes,elem,cur,curValue,clazz,j,finalValue,i=0;if(isFunction(value)){return this.each((function(j){jQuery(this).addClass(value.call(this,j,getClass(this)))}))}classes=classesToArray(value);if(classes.length){while(elem=this[i++]){curValue=getClass(elem);cur=elem.nodeType===1&&" "+stripAndCollapse(curValue)+" ";if(cur){j=0;while(clazz=classes[j++]){if(cur.indexOf(" "+clazz+" ")<0){cur+=clazz+" "}}finalValue=stripAndCollapse(cur);if(curValue!==finalValue){elem.setAttribute("class",finalValue)}}}}return this},removeClass:function(value){var classes,elem,cur,curValue,clazz,j,finalValue,i=0;if(isFunction(value)){return this.each((function(j){jQuery(this).removeClass(value.call(this,j,getClass(this)))}))}if(!arguments.length){return this.attr("class","")}classes=classesToArray(value);if(classes.length){while(elem=this[i++]){curValue=getClass(elem);cur=elem.nodeType===1&&" "+stripAndCollapse(curValue)+" ";if(cur){j=0;while(clazz=classes[j++]){while(cur.indexOf(" "+clazz+" ")>-1){cur=cur.replace(" "+clazz+" "," ")}}finalValue=stripAndCollapse(cur);if(curValue!==finalValue){elem.setAttribute("class",finalValue)}}}}return this},toggleClass:function(value,stateVal){var type=typeof value,isValidValue=type==="string"||Array.isArray(value);if(typeof stateVal==="boolean"&&isValidValue){return stateVal?this.addClass(value):this.removeClass(value)}if(isFunction(value)){return this.each((function(i){jQuery(this).toggleClass(value.call(this,i,getClass(this),stateVal),stateVal)}))}return this.each((function(){var className,i,self,classNames;if(isValidValue){i=0;self=jQuery(this);classNames=classesToArray(value);while(className=classNames[i++]){if(self.hasClass(className)){self.removeClass(className)}else{self.addClass(className)}}}else if(value===undefined||type==="boolean"){className=getClass(this);if(className){dataPriv.set(this,"__className__",className)}if(this.setAttribute){this.setAttribute("class",className||value===false?"":dataPriv.get(this,"__className__")||"")}}}))},hasClass:function(selector){var className,elem,i=0;className=" "+selector+" ";while(elem=this[i++]){if(elem.nodeType===1&&(" "+stripAndCollapse(getClass(elem))+" ").indexOf(className)>-1){return true}}return false}});var rreturn=/\r/g;jQuery.fn.extend({val:function(value){var hooks,ret,valueIsFunction,elem=this[0];if(!arguments.length){if(elem){hooks=jQuery.valHooks[elem.type]||jQuery.valHooks[elem.nodeName.toLowerCase()];if(hooks&&"get"in hooks&&(ret=hooks.get(elem,"value"))!==undefined){return ret}ret=elem.value;if(typeof ret==="string"){return ret.replace(rreturn,"")}return ret==null?"":ret}return}valueIsFunction=isFunction(value);return this.each((function(i){var val;if(this.nodeType!==1){return}if(valueIsFunction){val=value.call(this,i,jQuery(this).val())}else{val=value}if(val==null){val=""}else if(typeof val==="number"){val+=""}else if(Array.isArray(val)){val=jQuery.map(val,(function(value){return value==null?"":value+""}))}hooks=jQuery.valHooks[this.type]||jQuery.valHooks[this.nodeName.toLowerCase()];if(!hooks||!("set"in hooks)||hooks.set(this,val,"value")===undefined){this.value=val}}))}});jQuery.extend({valHooks:{option:{get:function(elem){var val=jQuery.find.attr(elem,"value");return val!=null?val:stripAndCollapse(jQuery.text(elem))}},select:{get:function(elem){var value,option,i,options=elem.options,index=elem.selectedIndex,one=elem.type==="select-one",values=one?null:[],max=one?index+1:options.length;if(index<0){i=max}else{i=one?index:0}for(;i<max;i++){option=options[i];if((option.selected||i===index)&&!option.disabled&&(!option.parentNode.disabled||!nodeName(option.parentNode,"optgroup"))){value=jQuery(option).val();if(one){return value}values.push(value)}}return values},set:function(elem,value){var optionSet,option,options=elem.options,values=jQuery.makeArray(value),i=options.length;while(i--){option=options[i];if(option.selected=jQuery.inArray(jQuery.valHooks.option.get(option),values)>-1){optionSet=true}}if(!optionSet){elem.selectedIndex=-1}return values}}}});jQuery.each(["radio","checkbox"],(function(){jQuery.valHooks[this]={set:function(elem,value){if(Array.isArray(value)){return elem.checked=jQuery.inArray(jQuery(elem).val(),value)>-1}}};if(!support.checkOn){jQuery.valHooks[this].get=function(elem){return elem.getAttribute("value")===null?"on":elem.value}}}));support.focusin="onfocusin"in window;var rfocusMorph=/^(?:focusinfocus|focusoutblur)$/,stopPropagationCallback=function(e){e.stopPropagation()};jQuery.extend(jQuery.event,{trigger:function(event,data,elem,onlyHandlers){var i,cur,tmp,bubbleType,ontype,handle,special,lastElement,eventPath=[elem||document],type=hasOwn.call(event,"type")?event.type:event,namespaces=hasOwn.call(event,"namespace")?event.namespace.split("."):[];cur=lastElement=tmp=elem=elem||document;if(elem.nodeType===3||elem.nodeType===8){return}if(rfocusMorph.test(type+jQuery.event.triggered)){return}if(type.indexOf(".")>-1){namespaces=type.split(".");type=namespaces.shift();namespaces.sort()}ontype=type.indexOf(":")<0&&"on"+type;event=event[jQuery.expando]?event:new jQuery.Event(type,typeof event==="object"&&event);event.isTrigger=onlyHandlers?2:3;event.namespace=namespaces.join(".");event.rnamespace=event.namespace?new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"):null;event.result=undefined;if(!event.target){event.target=elem}data=data==null?[event]:jQuery.makeArray(data,[event]);special=jQuery.event.special[type]||{};if(!onlyHandlers&&special.trigger&&special.trigger.apply(elem,data)===false){return}if(!onlyHandlers&&!special.noBubble&&!isWindow(elem)){bubbleType=special.delegateType||type;if(!rfocusMorph.test(bubbleType+type)){cur=cur.parentNode}for(;cur;cur=cur.parentNode){eventPath.push(cur);tmp=cur}if(tmp===(elem.ownerDocument||document)){eventPath.push(tmp.defaultView||tmp.parentWindow||window)}}i=0;while((cur=eventPath[i++])&&!event.isPropagationStopped()){lastElement=cur;event.type=i>1?bubbleType:special.bindType||type;handle=(dataPriv.get(cur,"events")||Object.create(null))[event.type]&&dataPriv.get(cur,"handle");if(handle){handle.apply(cur,data)}handle=ontype&&cur[ontype];if(handle&&handle.apply&&acceptData(cur)){event.result=handle.apply(cur,data);if(event.result===false){event.preventDefault()}}}event.type=type;if(!onlyHandlers&&!event.isDefaultPrevented()){if((!special._default||special._default.apply(eventPath.pop(),data)===false)&&acceptData(elem)){if(ontype&&isFunction(elem[type])&&!isWindow(elem)){tmp=elem[ontype];if(tmp){elem[ontype]=null}jQuery.event.triggered=type;if(event.isPropagationStopped()){lastElement.addEventListener(type,stopPropagationCallback)}elem[type]();if(event.isPropagationStopped()){lastElement.removeEventListener(type,stopPropagationCallback)}jQuery.event.triggered=undefined;if(tmp){elem[ontype]=tmp}}}}return event.result},simulate:function(type,elem,event){var e=jQuery.extend(new jQuery.Event,event,{type:type,isSimulated:true});jQuery.event.trigger(e,null,elem)}});jQuery.fn.extend({trigger:function(type,data){return this.each((function(){jQuery.event.trigger(type,data,this)}))},triggerHandler:function(type,data){var elem=this[0];if(elem){return jQuery.event.trigger(type,data,elem,true)}}});if(!support.focusin){jQuery.each({focus:"focusin",blur:"focusout"},(function(orig,fix){var handler=function(event){jQuery.event.simulate(fix,event.target,jQuery.event.fix(event))};jQuery.event.special[fix]={setup:function(){var doc=this.ownerDocument||this.document||this,attaches=dataPriv.access(doc,fix);if(!attaches){doc.addEventListener(orig,handler,true)}dataPriv.access(doc,fix,(attaches||0)+1)},teardown:function(){var doc=this.ownerDocument||this.document||this,attaches=dataPriv.access(doc,fix)-1;if(!attaches){doc.removeEventListener(orig,handler,true);dataPriv.remove(doc,fix)}else{dataPriv.access(doc,fix,attaches)}}}}))}var location=window.location;var nonce={guid:Date.now()};var rquery=/\?/;jQuery.parseXML=function(data){var xml,parserErrorElem;if(!data||typeof data!=="string"){return null}try{xml=(new window.DOMParser).parseFromString(data,"text/xml")}catch(e){}parserErrorElem=xml&&xml.getElementsByTagName("parsererror")[0];if(!xml||parserErrorElem){jQuery.error("Invalid XML: "+(parserErrorElem?jQuery.map(parserErrorElem.childNodes,(function(el){return el.textContent})).join("\n"):data))}return xml};var rbracket=/\[\]$/,rCRLF=/\r?\n/g,rsubmitterTypes=/^(?:submit|button|image|reset|file)$/i,rsubmittable=/^(?:input|select|textarea|keygen)/i;function buildParams(prefix,obj,traditional,add){var name;if(Array.isArray(obj)){jQuery.each(obj,(function(i,v){if(traditional||rbracket.test(prefix)){add(prefix,v)}else{buildParams(prefix+"["+(typeof v==="object"&&v!=null?i:"")+"]",v,traditional,add)}}))}else if(!traditional&&toType(obj)==="object"){for(name in obj){buildParams(prefix+"["+name+"]",obj[name],traditional,add)}}else{add(prefix,obj)}}jQuery.param=function(a,traditional){var prefix,s=[],add=function(key,valueOrFunction){var value=isFunction(valueOrFunction)?valueOrFunction():valueOrFunction;s[s.length]=encodeURIComponent(key)+"="+encodeURIComponent(value==null?"":value)};if(a==null){return""}if(Array.isArray(a)||a.jquery&&!jQuery.isPlainObject(a)){jQuery.each(a,(function(){add(this.name,this.value)}))}else{for(prefix in a){buildParams(prefix,a[prefix],traditional,add)}}return s.join("&")};jQuery.fn.extend({serialize:function(){return jQuery.param(this.serializeArray())},serializeArray:function(){return this.map((function(){var elements=jQuery.prop(this,"elements");return elements?jQuery.makeArray(elements):this})).filter((function(){var type=this.type;return this.name&&!jQuery(this).is(":disabled")&&rsubmittable.test(this.nodeName)&&!rsubmitterTypes.test(type)&&(this.checked||!rcheckableType.test(type))})).map((function(_i,elem){var val=jQuery(this).val();if(val==null){return null}if(Array.isArray(val)){return jQuery.map(val,(function(val){return{name:elem.name,value:val.replace(rCRLF,"\r\n")}}))}return{name:elem.name,value:val.replace(rCRLF,"\r\n")}})).get()}});var r20=/%20/g,rhash=/#.*$/,rantiCache=/([?&])_=[^&]*/,rheaders=/^(.*?):[ \t]*([^\r\n]*)$/gm,rlocalProtocol=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,rnoContent=/^(?:GET|HEAD)$/,rprotocol=/^\/\//,prefilters={},transports={},allTypes="*/".concat("*"),originAnchor=document.createElement("a");originAnchor.href=location.href;function addToPrefiltersOrTransports(structure){return function(dataTypeExpression,func){if(typeof dataTypeExpression!=="string"){func=dataTypeExpression;dataTypeExpression="*"}var dataType,i=0,dataTypes=dataTypeExpression.toLowerCase().match(rnothtmlwhite)||[];if(isFunction(func)){while(dataType=dataTypes[i++]){if(dataType[0]==="+"){dataType=dataType.slice(1)||"*";(structure[dataType]=structure[dataType]||[]).unshift(func)}else{(structure[dataType]=structure[dataType]||[]).push(func)}}}}}function inspectPrefiltersOrTransports(structure,options,originalOptions,jqXHR){var inspected={},seekingTransport=structure===transports;function inspect(dataType){var selected;inspected[dataType]=true;jQuery.each(structure[dataType]||[],(function(_,prefilterOrFactory){var dataTypeOrTransport=prefilterOrFactory(options,originalOptions,jqXHR);if(typeof dataTypeOrTransport==="string"&&!seekingTransport&&!inspected[dataTypeOrTransport]){options.dataTypes.unshift(dataTypeOrTransport);inspect(dataTypeOrTransport);return false}else if(seekingTransport){return!(selected=dataTypeOrTransport)}}));return selected}return inspect(options.dataTypes[0])||!inspected["*"]&&inspect("*")}function ajaxExtend(target,src){var key,deep,flatOptions=jQuery.ajaxSettings.flatOptions||{};for(key in src){if(src[key]!==undefined){(flatOptions[key]?target:deep||(deep={}))[key]=src[key]}}if(deep){jQuery.extend(true,target,deep)}return target}function ajaxHandleResponses(s,jqXHR,responses){var ct,type,finalDataType,firstDataType,contents=s.contents,dataTypes=s.dataTypes;while(dataTypes[0]==="*"){dataTypes.shift();if(ct===undefined){ct=s.mimeType||jqXHR.getResponseHeader("Content-Type")}}if(ct){for(type in contents){if(contents[type]&&contents[type].test(ct)){dataTypes.unshift(type);break}}}if(dataTypes[0]in responses){finalDataType=dataTypes[0]}else{for(type in responses){if(!dataTypes[0]||s.converters[type+" "+dataTypes[0]]){finalDataType=type;break}if(!firstDataType){firstDataType=type}}finalDataType=finalDataType||firstDataType}if(finalDataType){if(finalDataType!==dataTypes[0]){dataTypes.unshift(finalDataType)}return responses[finalDataType]}}function ajaxConvert(s,response,jqXHR,isSuccess){var conv2,current,conv,tmp,prev,converters={},dataTypes=s.dataTypes.slice();if(dataTypes[1]){for(conv in s.converters){converters[conv.toLowerCase()]=s.converters[conv]}}current=dataTypes.shift();while(current){if(s.responseFields[current]){jqXHR[s.responseFields[current]]=response}if(!prev&&isSuccess&&s.dataFilter){response=s.dataFilter(response,s.dataType)}prev=current;current=dataTypes.shift();if(current){if(current==="*"){current=prev}else if(prev!=="*"&&prev!==current){conv=converters[prev+" "+current]||converters["* "+current];if(!conv){for(conv2 in converters){tmp=conv2.split(" ");if(tmp[1]===current){conv=converters[prev+" "+tmp[0]]||converters["* "+tmp[0]];if(conv){if(conv===true){conv=converters[conv2]}else if(converters[conv2]!==true){current=tmp[0];dataTypes.unshift(tmp[1])}break}}}}if(conv!==true){if(conv&&s.throws){response=conv(response)}else{try{response=conv(response)}catch(e){return{state:"parsererror",error:conv?e:"No conversion from "+prev+" to "+current}}}}}}}return{state:"success",data:response}}jQuery.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:location.href,type:"GET",isLocal:rlocalProtocol.test(location.protocol),global:true,processData:true,async:true,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":allTypes,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":true,"text json":JSON.parse,"text xml":jQuery.parseXML},flatOptions:{url:true,context:true}},ajaxSetup:function(target,settings){return settings?ajaxExtend(ajaxExtend(target,jQuery.ajaxSettings),settings):ajaxExtend(jQuery.ajaxSettings,target)},ajaxPrefilter:addToPrefiltersOrTransports(prefilters),ajaxTransport:addToPrefiltersOrTransports(transports),ajax:function(url,options){if(typeof url==="object"){options=url;url=undefined}options=options||{};var transport,cacheURL,responseHeadersString,responseHeaders,timeoutTimer,urlAnchor,completed,fireGlobals,i,uncached,s=jQuery.ajaxSetup({},options),callbackContext=s.context||s,globalEventContext=s.context&&(callbackContext.nodeType||callbackContext.jquery)?jQuery(callbackContext):jQuery.event,deferred=jQuery.Deferred(),completeDeferred=jQuery.Callbacks("once memory"),statusCode=s.statusCode||{},requestHeaders={},requestHeadersNames={},strAbort="canceled",jqXHR={readyState:0,getResponseHeader:function(key){var match;if(completed){if(!responseHeaders){responseHeaders={};while(match=rheaders.exec(responseHeadersString)){responseHeaders[match[1].toLowerCase()+" "]=(responseHeaders[match[1].toLowerCase()+" "]||[]).concat(match[2])}}match=responseHeaders[key.toLowerCase()+" "]}return match==null?null:match.join(", ")},getAllResponseHeaders:function(){return completed?responseHeadersString:null},setRequestHeader:function(name,value){if(completed==null){name=requestHeadersNames[name.toLowerCase()]=requestHeadersNames[name.toLowerCase()]||name;requestHeaders[name]=value}return this},overrideMimeType:function(type){if(completed==null){s.mimeType=type}return this},statusCode:function(map){var code;if(map){if(completed){jqXHR.always(map[jqXHR.status])}else{for(code in map){statusCode[code]=[statusCode[code],map[code]]}}}return this},abort:function(statusText){var finalText=statusText||strAbort;if(transport){transport.abort(finalText)}done(0,finalText);return this}};deferred.promise(jqXHR);s.url=((url||s.url||location.href)+"").replace(rprotocol,location.protocol+"//");s.type=options.method||options.type||s.method||s.type;s.dataTypes=(s.dataType||"*").toLowerCase().match(rnothtmlwhite)||[""];if(s.crossDomain==null){urlAnchor=document.createElement("a");try{urlAnchor.href=s.url;urlAnchor.href=urlAnchor.href;s.crossDomain=originAnchor.protocol+"//"+originAnchor.host!==urlAnchor.protocol+"//"+urlAnchor.host}catch(e){s.crossDomain=true}}if(s.data&&s.processData&&typeof s.data!=="string"){s.data=jQuery.param(s.data,s.traditional)}inspectPrefiltersOrTransports(prefilters,s,options,jqXHR);if(completed){return jqXHR}fireGlobals=jQuery.event&&s.global;if(fireGlobals&&jQuery.active++===0){jQuery.event.trigger("ajaxStart")}s.type=s.type.toUpperCase();s.hasContent=!rnoContent.test(s.type);cacheURL=s.url.replace(rhash,"");if(!s.hasContent){uncached=s.url.slice(cacheURL.length);if(s.data&&(s.processData||typeof s.data==="string")){cacheURL+=(rquery.test(cacheURL)?"&":"?")+s.data;delete s.data}if(s.cache===false){cacheURL=cacheURL.replace(rantiCache,"$1");uncached=(rquery.test(cacheURL)?"&":"?")+"_="+nonce.guid+++uncached}s.url=cacheURL+uncached}else if(s.data&&s.processData&&(s.contentType||"").indexOf("application/x-www-form-urlencoded")===0){s.data=s.data.replace(r20,"+")}if(s.ifModified){if(jQuery.lastModified[cacheURL]){jqXHR.setRequestHeader("If-Modified-Since",jQuery.lastModified[cacheURL])}if(jQuery.etag[cacheURL]){jqXHR.setRequestHeader("If-None-Match",jQuery.etag[cacheURL])}}if(s.data&&s.hasContent&&s.contentType!==false||options.contentType){jqXHR.setRequestHeader("Content-Type",s.contentType)}jqXHR.setRequestHeader("Accept",s.dataTypes[0]&&s.accepts[s.dataTypes[0]]?s.accepts[s.dataTypes[0]]+(s.dataTypes[0]!=="*"?", "+allTypes+"; q=0.01":""):s.accepts["*"]);for(i in s.headers){jqXHR.setRequestHeader(i,s.headers[i])}if(s.beforeSend&&(s.beforeSend.call(callbackContext,jqXHR,s)===false||completed)){return jqXHR.abort()}strAbort="abort";completeDeferred.add(s.complete);jqXHR.done(s.success);jqXHR.fail(s.error);transport=inspectPrefiltersOrTransports(transports,s,options,jqXHR);if(!transport){done(-1,"No Transport")}else{jqXHR.readyState=1;if(fireGlobals){globalEventContext.trigger("ajaxSend",[jqXHR,s])}if(completed){return jqXHR}if(s.async&&s.timeout>0){timeoutTimer=window.setTimeout((function(){jqXHR.abort("timeout")}),s.timeout)}try{completed=false;transport.send(requestHeaders,done)}catch(e){if(completed){throw e}done(-1,e)}}function done(status,nativeStatusText,responses,headers){var isSuccess,success,error,response,modified,statusText=nativeStatusText;if(completed){return}completed=true;if(timeoutTimer){window.clearTimeout(timeoutTimer)}transport=undefined;responseHeadersString=headers||"";jqXHR.readyState=status>0?4:0;isSuccess=status>=200&&status<300||status===304;if(responses){response=ajaxHandleResponses(s,jqXHR,responses)}if(!isSuccess&&jQuery.inArray("script",s.dataTypes)>-1&&jQuery.inArray("json",s.dataTypes)<0){s.converters["text script"]=function(){}}response=ajaxConvert(s,response,jqXHR,isSuccess);if(isSuccess){if(s.ifModified){modified=jqXHR.getResponseHeader("Last-Modified");if(modified){jQuery.lastModified[cacheURL]=modified}modified=jqXHR.getResponseHeader("etag");if(modified){jQuery.etag[cacheURL]=modified}}if(status===204||s.type==="HEAD"){statusText="nocontent"}else if(status===304){statusText="notmodified"}else{statusText=response.state;success=response.data;error=response.error;isSuccess=!error}}else{error=statusText;if(status||!statusText){statusText="error";if(status<0){status=0}}}jqXHR.status=status;jqXHR.statusText=(nativeStatusText||statusText)+"";if(isSuccess){deferred.resolveWith(callbackContext,[success,statusText,jqXHR])}else{deferred.rejectWith(callbackContext,[jqXHR,statusText,error])}jqXHR.statusCode(statusCode);statusCode=undefined;if(fireGlobals){globalEventContext.trigger(isSuccess?"ajaxSuccess":"ajaxError",[jqXHR,s,isSuccess?success:error])}completeDeferred.fireWith(callbackContext,[jqXHR,statusText]);if(fireGlobals){globalEventContext.trigger("ajaxComplete",[jqXHR,s]);if(! --jQuery.active){jQuery.event.trigger("ajaxStop")}}}return jqXHR},getJSON:function(url,data,callback){return jQuery.get(url,data,callback,"json")},getScript:function(url,callback){return jQuery.get(url,undefined,callback,"script")}});jQuery.each(["get","post"],(function(_i,method){jQuery[method]=function(url,data,callback,type){if(isFunction(data)){type=type||callback;callback=data;data=undefined}return jQuery.ajax(jQuery.extend({url:url,type:method,dataType:type,data:data,success:callback},jQuery.isPlainObject(url)&&url))}}));jQuery.ajaxPrefilter((function(s){var i;for(i in s.headers){if(i.toLowerCase()==="content-type"){s.contentType=s.headers[i]||""}}}));jQuery._evalUrl=function(url,options,doc){return jQuery.ajax({url:url,type:"GET",dataType:"script",cache:true,async:false,global:false,converters:{"text script":function(){}},dataFilter:function(response){jQuery.globalEval(response,options,doc)}})};jQuery.fn.extend({wrapAll:function(html){var wrap;if(this[0]){if(isFunction(html)){html=html.call(this[0])}wrap=jQuery(html,this[0].ownerDocument).eq(0).clone(true);if(this[0].parentNode){wrap.insertBefore(this[0])}wrap.map((function(){var elem=this;while(elem.firstElementChild){elem=elem.firstElementChild}return elem})).append(this)}return this},wrapInner:function(html){if(isFunction(html)){return this.each((function(i){jQuery(this).wrapInner(html.call(this,i))}))}return this.each((function(){var self=jQuery(this),contents=self.contents();if(contents.length){contents.wrapAll(html)}else{self.append(html)}}))},wrap:function(html){var htmlIsFunction=isFunction(html);return this.each((function(i){jQuery(this).wrapAll(htmlIsFunction?html.call(this,i):html)}))},unwrap:function(selector){this.parent(selector).not("body").each((function(){jQuery(this).replaceWith(this.childNodes)}));return this}});jQuery.expr.pseudos.hidden=function(elem){return!jQuery.expr.pseudos.visible(elem)};jQuery.expr.pseudos.visible=function(elem){return!!(elem.offsetWidth||elem.offsetHeight||elem.getClientRects().length)};jQuery.ajaxSettings.xhr=function(){try{return new window.XMLHttpRequest}catch(e){}};var xhrSuccessStatus={0:200,1223:204},xhrSupported=jQuery.ajaxSettings.xhr();support.cors=!!xhrSupported&&"withCredentials"in xhrSupported;support.ajax=xhrSupported=!!xhrSupported;jQuery.ajaxTransport((function(options){var callback,errorCallback;if(support.cors||xhrSupported&&!options.crossDomain){return{send:function(headers,complete){var i,xhr=options.xhr();xhr.open(options.type,options.url,options.async,options.username,options.password);if(options.xhrFields){for(i in options.xhrFields){xhr[i]=options.xhrFields[i]}}if(options.mimeType&&xhr.overrideMimeType){xhr.overrideMimeType(options.mimeType)}if(!options.crossDomain&&!headers["X-Requested-With"]){headers["X-Requested-With"]="XMLHttpRequest"}for(i in headers){xhr.setRequestHeader(i,headers[i])}callback=function(type){return function(){if(callback){callback=errorCallback=xhr.onload=xhr.onerror=xhr.onabort=xhr.ontimeout=xhr.onreadystatechange=null;if(type==="abort"){xhr.abort()}else if(type==="error"){if(typeof xhr.status!=="number"){complete(0,"error")}else{complete(xhr.status,xhr.statusText)}}else{complete(xhrSuccessStatus[xhr.status]||xhr.status,xhr.statusText,(xhr.responseType||"text")!=="text"||typeof xhr.responseText!=="string"?{binary:xhr.response}:{text:xhr.responseText},xhr.getAllResponseHeaders())}}}};xhr.onload=callback();errorCallback=xhr.onerror=xhr.ontimeout=callback("error");if(xhr.onabort!==undefined){xhr.onabort=errorCallback}else{xhr.onreadystatechange=function(){if(xhr.readyState===4){window.setTimeout((function(){if(callback){errorCallback()}}))}}}callback=callback("abort");try{xhr.send(options.hasContent&&options.data||null)}catch(e){if(callback){throw e}}},abort:function(){if(callback){callback()}}}}}));jQuery.ajaxPrefilter((function(s){if(s.crossDomain){s.contents.script=false}}));jQuery.ajaxSetup({accepts:{script:"text/javascript, application/javascript, "+"application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(text){jQuery.globalEval(text);return text}}});jQuery.ajaxPrefilter("script",(function(s){if(s.cache===undefined){s.cache=false}if(s.crossDomain){s.type="GET"}}));jQuery.ajaxTransport("script",(function(s){if(s.crossDomain||s.scriptAttrs){var script,callback;return{send:function(_,complete){script=jQuery("<script>").attr(s.scriptAttrs||{}).prop({charset:s.scriptCharset,src:s.url}).on("load error",callback=function(evt){script.remove();callback=null;if(evt){complete(evt.type==="error"?404:200,evt.type)}});document.head.appendChild(script[0])},abort:function(){if(callback){callback()}}}}}));var oldCallbacks=[],rjsonp=/(=)\?(?=&|$)|\?\?/;jQuery.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var callback=oldCallbacks.pop()||jQuery.expando+"_"+nonce.guid++;this[callback]=true;return callback}});jQuery.ajaxPrefilter("json jsonp",(function(s,originalSettings,jqXHR){var callbackName,overwritten,responseContainer,jsonProp=s.jsonp!==false&&(rjsonp.test(s.url)?"url":typeof s.data==="string"&&(s.contentType||"").indexOf("application/x-www-form-urlencoded")===0&&rjsonp.test(s.data)&&"data");if(jsonProp||s.dataTypes[0]==="jsonp"){callbackName=s.jsonpCallback=isFunction(s.jsonpCallback)?s.jsonpCallback():s.jsonpCallback;if(jsonProp){s[jsonProp]=s[jsonProp].replace(rjsonp,"$1"+callbackName)}else if(s.jsonp!==false){s.url+=(rquery.test(s.url)?"&":"?")+s.jsonp+"="+callbackName}s.converters["script json"]=function(){if(!responseContainer){jQuery.error(callbackName+" was not called")}return responseContainer[0]};s.dataTypes[0]="json";overwritten=window[callbackName];window[callbackName]=function(){responseContainer=arguments};jqXHR.always((function(){if(overwritten===undefined){jQuery(window).removeProp(callbackName)}else{window[callbackName]=overwritten}if(s[callbackName]){s.jsonpCallback=originalSettings.jsonpCallback;oldCallbacks.push(callbackName)}if(responseContainer&&isFunction(overwritten)){overwritten(responseContainer[0])}responseContainer=overwritten=undefined}));return"script"}}));support.createHTMLDocument=function(){var body=document.implementation.createHTMLDocument("").body;body.innerHTML="<form></form><form></form>";return body.childNodes.length===2}();jQuery.parseHTML=function(data,context,keepScripts){if(typeof data!=="string"){return[]}if(typeof context==="boolean"){keepScripts=context;context=false}var base,parsed,scripts;if(!context){if(support.createHTMLDocument){context=document.implementation.createHTMLDocument("");base=context.createElement("base");base.href=document.location.href;context.head.appendChild(base)}else{context=document}}parsed=rsingleTag.exec(data);scripts=!keepScripts&&[];if(parsed){return[context.createElement(parsed[1])]}parsed=buildFragment([data],context,scripts);if(scripts&&scripts.length){jQuery(scripts).remove()}return jQuery.merge([],parsed.childNodes)};jQuery.fn.load=function(url,params,callback){var selector,type,response,self=this,off=url.indexOf(" ");if(off>-1){selector=stripAndCollapse(url.slice(off));url=url.slice(0,off)}if(isFunction(params)){callback=params;params=undefined}else if(params&&typeof params==="object"){type="POST"}if(self.length>0){jQuery.ajax({url:url,type:type||"GET",dataType:"html",data:params}).done((function(responseText){response=arguments;self.html(selector?jQuery("<div>").append(jQuery.parseHTML(responseText)).find(selector):responseText)})).always(callback&&function(jqXHR,status){self.each((function(){callback.apply(this,response||[jqXHR.responseText,status,jqXHR])}))})}return this};jQuery.expr.pseudos.animated=function(elem){return jQuery.grep(jQuery.timers,(function(fn){return elem===fn.elem})).length};jQuery.offset={setOffset:function(elem,options,i){var curPosition,curLeft,curCSSTop,curTop,curOffset,curCSSLeft,calculatePosition,position=jQuery.css(elem,"position"),curElem=jQuery(elem),props={};if(position==="static"){elem.style.position="relative"}curOffset=curElem.offset();curCSSTop=jQuery.css(elem,"top");curCSSLeft=jQuery.css(elem,"left");calculatePosition=(position==="absolute"||position==="fixed")&&(curCSSTop+curCSSLeft).indexOf("auto")>-1;if(calculatePosition){curPosition=curElem.position();curTop=curPosition.top;curLeft=curPosition.left}else{curTop=parseFloat(curCSSTop)||0;curLeft=parseFloat(curCSSLeft)||0}if(isFunction(options)){options=options.call(elem,i,jQuery.extend({},curOffset))}if(options.top!=null){props.top=options.top-curOffset.top+curTop}if(options.left!=null){props.left=options.left-curOffset.left+curLeft}if("using"in options){options.using.call(elem,props)}else{curElem.css(props)}}};jQuery.fn.extend({offset:function(options){if(arguments.length){return options===undefined?this:this.each((function(i){jQuery.offset.setOffset(this,options,i)}))}var rect,win,elem=this[0];if(!elem){return}if(!elem.getClientRects().length){return{top:0,left:0}}rect=elem.getBoundingClientRect();win=elem.ownerDocument.defaultView;return{top:rect.top+win.pageYOffset,left:rect.left+win.pageXOffset}},position:function(){if(!this[0]){return}var offsetParent,offset,doc,elem=this[0],parentOffset={top:0,left:0};if(jQuery.css(elem,"position")==="fixed"){offset=elem.getBoundingClientRect()}else{offset=this.offset();doc=elem.ownerDocument;offsetParent=elem.offsetParent||doc.documentElement;while(offsetParent&&(offsetParent===doc.body||offsetParent===doc.documentElement)&&jQuery.css(offsetParent,"position")==="static"){offsetParent=offsetParent.parentNode}if(offsetParent&&offsetParent!==elem&&offsetParent.nodeType===1){parentOffset=jQuery(offsetParent).offset();parentOffset.top+=jQuery.css(offsetParent,"borderTopWidth",true);parentOffset.left+=jQuery.css(offsetParent,"borderLeftWidth",true)}}return{top:offset.top-parentOffset.top-jQuery.css(elem,"marginTop",true),left:offset.left-parentOffset.left-jQuery.css(elem,"marginLeft",true)}},offsetParent:function(){return this.map((function(){var offsetParent=this.offsetParent;while(offsetParent&&jQuery.css(offsetParent,"position")==="static"){offsetParent=offsetParent.offsetParent}return offsetParent||documentElement}))}});jQuery.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},(function(method,prop){var top="pageYOffset"===prop;jQuery.fn[method]=function(val){return access(this,(function(elem,method,val){var win;if(isWindow(elem)){win=elem}else if(elem.nodeType===9){win=elem.defaultView}if(val===undefined){return win?win[prop]:elem[method]}if(win){win.scrollTo(!top?val:win.pageXOffset,top?val:win.pageYOffset)}else{elem[method]=val}}),method,val,arguments.length)}}));jQuery.each(["top","left"],(function(_i,prop){jQuery.cssHooks[prop]=addGetHookIf(support.pixelPosition,(function(elem,computed){if(computed){computed=curCSS(elem,prop);return rnumnonpx.test(computed)?jQuery(elem).position()[prop]+"px":computed}}))}));jQuery.each({Height:"height",Width:"width"},(function(name,type){jQuery.each({padding:"inner"+name,content:type,"":"outer"+name},(function(defaultExtra,funcName){jQuery.fn[funcName]=function(margin,value){var chainable=arguments.length&&(defaultExtra||typeof margin!=="boolean"),extra=defaultExtra||(margin===true||value===true?"margin":"border");return access(this,(function(elem,type,value){var doc;if(isWindow(elem)){return funcName.indexOf("outer")===0?elem["inner"+name]:elem.document.documentElement["client"+name]}if(elem.nodeType===9){doc=elem.documentElement;return Math.max(elem.body["scroll"+name],doc["scroll"+name],elem.body["offset"+name],doc["offset"+name],doc["client"+name])}return value===undefined?jQuery.css(elem,type,extra):jQuery.style(elem,type,value,extra)}),type,chainable?margin:undefined,chainable)}}))}));jQuery.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],(function(_i,type){jQuery.fn[type]=function(fn){return this.on(type,fn)}}));jQuery.fn.extend({bind:function(types,data,fn){return this.on(types,null,data,fn)},unbind:function(types,fn){return this.off(types,null,fn)},delegate:function(selector,types,data,fn){return this.on(types,selector,data,fn)},undelegate:function(selector,types,fn){return arguments.length===1?this.off(selector,"**"):this.off(types,selector||"**",fn)},hover:function(fnOver,fnOut){return this.mouseenter(fnOver).mouseleave(fnOut||fnOver)}});jQuery.each(("blur focus focusin focusout resize scroll click dblclick "+"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave "+"change select submit keydown keypress keyup contextmenu").split(" "),(function(_i,name){jQuery.fn[name]=function(data,fn){return arguments.length>0?this.on(name,null,data,fn):this.trigger(name)}}));var rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;jQuery.proxy=function(fn,context){var tmp,args,proxy;if(typeof context==="string"){tmp=fn[context];context=fn;fn=tmp}if(!isFunction(fn)){return undefined}args=slice.call(arguments,2);proxy=function(){return fn.apply(context||this,args.concat(slice.call(arguments)))};proxy.guid=fn.guid=fn.guid||jQuery.guid++;return proxy};jQuery.holdReady=function(hold){if(hold){jQuery.readyWait++}else{jQuery.ready(true)}};jQuery.isArray=Array.isArray;jQuery.parseJSON=JSON.parse;jQuery.nodeName=nodeName;jQuery.isFunction=isFunction;jQuery.isWindow=isWindow;jQuery.camelCase=camelCase;jQuery.type=toType;jQuery.now=Date.now;jQuery.isNumeric=function(obj){var type=jQuery.type(obj);return(type==="number"||type==="string")&&!isNaN(obj-parseFloat(obj))};jQuery.trim=function(text){return text==null?"":(text+"").replace(rtrim,"")};if(typeof define==="function"&&define.amd){define("jquery",[],(function(){return jQuery}))}var _jQuery=window.jQuery,_$=window.$;jQuery.noConflict=function(deep){if(window.$===jQuery){window.$=_$}if(deep&&window.jQuery===jQuery){window.jQuery=_jQuery}return jQuery};if(typeof noGlobal==="undefined"){window.jQuery=window.$=jQuery}return jQuery}));(function(factory){"use strict";if(typeof define==="function"&&define.amd){define(["jquery"],factory)}else{factory(jQuery)}})((function($){"use strict";$.ui=$.ui||{};return $.ui.version="1.13.0"}));
/*!
 * jQuery UI Keycode 1.13.0
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
(function(factory){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","./version"],factory)}else{factory(jQuery)}})((function($){"use strict";return $.ui.keyCode={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}));(function(factory){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","./version"],factory)}else{factory(jQuery)}})((function($){"use strict";return $.ui.safeActiveElement=function(document){var activeElement;try{activeElement=document.activeElement}catch(error){activeElement=document.body}if(!activeElement){activeElement=document.body}if(!activeElement.nodeName){activeElement=document.body}return activeElement}}));
/*!
 * jQuery UI Widget 1.13.2
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
(function(factory){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","./version"],factory)}else{factory(jQuery)}})((function($){"use strict";var widgetUuid=0;var widgetHasOwnProperty=Array.prototype.hasOwnProperty;var widgetSlice=Array.prototype.slice;$.cleanData=function(orig){return function(elems){var events,elem,i;for(i=0;(elem=elems[i])!=null;i++){events=$._data(elem,"events");if(events&&events.remove){$(elem).triggerHandler("remove")}}orig(elems)}}($.cleanData);$.widget=function(name,base,prototype){var existingConstructor,constructor,basePrototype;var proxiedPrototype={};var namespace=name.split(".")[0];name=name.split(".")[1];var fullName=namespace+"-"+name;if(!prototype){prototype=base;base=$.Widget}if(Array.isArray(prototype)){prototype=$.extend.apply(null,[{}].concat(prototype))}$.expr.pseudos[fullName.toLowerCase()]=function(elem){return!!$.data(elem,fullName)};$[namespace]=$[namespace]||{};existingConstructor=$[namespace][name];constructor=$[namespace][name]=function(options,element){if(!this||!this._createWidget){return new constructor(options,element)}if(arguments.length){this._createWidget(options,element)}};$.extend(constructor,existingConstructor,{version:prototype.version,_proto:$.extend({},prototype),_childConstructors:[]});basePrototype=new base;basePrototype.options=$.widget.extend({},basePrototype.options);$.each(prototype,(function(prop,value){if(typeof value!=="function"){proxiedPrototype[prop]=value;return}proxiedPrototype[prop]=function(){function _super(){return base.prototype[prop].apply(this,arguments)}function _superApply(args){return base.prototype[prop].apply(this,args)}return function(){var __super=this._super;var __superApply=this._superApply;var returnValue;this._super=_super;this._superApply=_superApply;returnValue=value.apply(this,arguments);this._super=__super;this._superApply=__superApply;return returnValue}}()}));constructor.prototype=$.widget.extend(basePrototype,{widgetEventPrefix:existingConstructor?basePrototype.widgetEventPrefix||name:name},proxiedPrototype,{constructor:constructor,namespace:namespace,widgetName:name,widgetFullName:fullName});if(existingConstructor){$.each(existingConstructor._childConstructors,(function(i,child){var childPrototype=child.prototype;$.widget(childPrototype.namespace+"."+childPrototype.widgetName,constructor,child._proto)}));delete existingConstructor._childConstructors}else{base._childConstructors.push(constructor)}$.widget.bridge(name,constructor);return constructor};$.widget.extend=function(target){var input=widgetSlice.call(arguments,1);var inputIndex=0;var inputLength=input.length;var key;var value;for(;inputIndex<inputLength;inputIndex++){for(key in input[inputIndex]){value=input[inputIndex][key];if(widgetHasOwnProperty.call(input[inputIndex],key)&&value!==undefined){if($.isPlainObject(value)){target[key]=$.isPlainObject(target[key])?$.widget.extend({},target[key],value):$.widget.extend({},value)}else{target[key]=value}}}}return target};$.widget.bridge=function(name,object){var fullName=object.prototype.widgetFullName||name;$.fn[name]=function(options){var isMethodCall=typeof options==="string";var args=widgetSlice.call(arguments,1);var returnValue=this;if(isMethodCall){if(!this.length&&options==="instance"){returnValue=undefined}else{this.each((function(){var methodValue;var instance=$.data(this,fullName);if(options==="instance"){returnValue=instance;return false}if(!instance){return $.error("cannot call methods on "+name+" prior to initialization; "+"attempted to call method '"+options+"'")}if(typeof instance[options]!=="function"||options.charAt(0)==="_"){return $.error("no such method '"+options+"' for "+name+" widget instance")}methodValue=instance[options].apply(instance,args);if(methodValue!==instance&&methodValue!==undefined){returnValue=methodValue&&methodValue.jquery?returnValue.pushStack(methodValue.get()):methodValue;return false}}))}}else{if(args.length){options=$.widget.extend.apply(null,[options].concat(args))}this.each((function(){var instance=$.data(this,fullName);if(instance){instance.option(options||{});if(instance._init){instance._init()}}else{$.data(this,fullName,new object(options,this))}}))}return returnValue}};$.Widget=function(){};$.Widget._childConstructors=[];$.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{classes:{},disabled:false,create:null},_createWidget:function(options,element){element=$(element||this.defaultElement||this)[0];this.element=$(element);this.uuid=widgetUuid++;this.eventNamespace="."+this.widgetName+this.uuid;this.bindings=$();this.hoverable=$();this.focusable=$();this.classesElementLookup={};if(element!==this){$.data(element,this.widgetFullName,this);this._on(true,this.element,{remove:function(event){if(event.target===element){this.destroy()}}});this.document=$(element.style?element.ownerDocument:element.document||element);this.window=$(this.document[0].defaultView||this.document[0].parentWindow)}this.options=$.widget.extend({},this.options,this._getCreateOptions(),options);this._create();if(this.options.disabled){this._setOptionDisabled(this.options.disabled)}this._trigger("create",null,this._getCreateEventData());this._init()},_getCreateOptions:function(){return{}},_getCreateEventData:$.noop,_create:$.noop,_init:$.noop,destroy:function(){var that=this;this._destroy();$.each(this.classesElementLookup,(function(key,value){that._removeClass(value,key)}));this.element.off(this.eventNamespace).removeData(this.widgetFullName);this.widget().off(this.eventNamespace).removeAttr("aria-disabled");this.bindings.off(this.eventNamespace)},_destroy:$.noop,widget:function(){return this.element},option:function(key,value){var options=key;var parts;var curOption;var i;if(arguments.length===0){return $.widget.extend({},this.options)}if(typeof key==="string"){options={};parts=key.split(".");key=parts.shift();if(parts.length){curOption=options[key]=$.widget.extend({},this.options[key]);for(i=0;i<parts.length-1;i++){curOption[parts[i]]=curOption[parts[i]]||{};curOption=curOption[parts[i]]}key=parts.pop();if(arguments.length===1){return curOption[key]===undefined?null:curOption[key]}curOption[key]=value}else{if(arguments.length===1){return this.options[key]===undefined?null:this.options[key]}options[key]=value}}this._setOptions(options);return this},_setOptions:function(options){var key;for(key in options){this._setOption(key,options[key])}return this},_setOption:function(key,value){if(key==="classes"){this._setOptionClasses(value)}this.options[key]=value;if(key==="disabled"){this._setOptionDisabled(value)}return this},_setOptionClasses:function(value){var classKey,elements,currentElements;for(classKey in value){currentElements=this.classesElementLookup[classKey];if(value[classKey]===this.options.classes[classKey]||!currentElements||!currentElements.length){continue}elements=$(currentElements.get());this._removeClass(currentElements,classKey);elements.addClass(this._classes({element:elements,keys:classKey,classes:value,add:true}))}},_setOptionDisabled:function(value){this._toggleClass(this.widget(),this.widgetFullName+"-disabled",null,!!value);if(value){this._removeClass(this.hoverable,null,"ui-state-hover");this._removeClass(this.focusable,null,"ui-state-focus")}},enable:function(){return this._setOptions({disabled:false})},disable:function(){return this._setOptions({disabled:true})},_classes:function(options){var full=[];var that=this;options=$.extend({element:this.element,classes:this.options.classes||{}},options);function bindRemoveEvent(){var nodesToBind=[];options.element.each((function(_,element){var isTracked=$.map(that.classesElementLookup,(function(elements){return elements})).some((function(elements){return elements.is(element)}));if(!isTracked){nodesToBind.push(element)}}));that._on($(nodesToBind),{remove:"_untrackClassesElement"})}function processClassString(classes,checkOption){var current,i;for(i=0;i<classes.length;i++){current=that.classesElementLookup[classes[i]]||$();if(options.add){bindRemoveEvent();current=$($.uniqueSort(current.get().concat(options.element.get())))}else{current=$(current.not(options.element).get())}that.classesElementLookup[classes[i]]=current;full.push(classes[i]);if(checkOption&&options.classes[classes[i]]){full.push(options.classes[classes[i]])}}}if(options.keys){processClassString(options.keys.match(/\S+/g)||[],true)}if(options.extra){processClassString(options.extra.match(/\S+/g)||[])}return full.join(" ")},_untrackClassesElement:function(event){var that=this;$.each(that.classesElementLookup,(function(key,value){if($.inArray(event.target,value)!==-1){that.classesElementLookup[key]=$(value.not(event.target).get())}}));this._off($(event.target))},_removeClass:function(element,keys,extra){return this._toggleClass(element,keys,extra,false)},_addClass:function(element,keys,extra){return this._toggleClass(element,keys,extra,true)},_toggleClass:function(element,keys,extra,add){add=typeof add==="boolean"?add:extra;var shift=typeof element==="string"||element===null,options={extra:shift?keys:extra,keys:shift?element:keys,element:shift?this.element:element,add:add};options.element.toggleClass(this._classes(options),add);return this},_on:function(suppressDisabledCheck,element,handlers){var delegateElement;var instance=this;if(typeof suppressDisabledCheck!=="boolean"){handlers=element;element=suppressDisabledCheck;suppressDisabledCheck=false}if(!handlers){handlers=element;element=this.element;delegateElement=this.widget()}else{element=delegateElement=$(element);this.bindings=this.bindings.add(element)}$.each(handlers,(function(event,handler){function handlerProxy(){if(!suppressDisabledCheck&&(instance.options.disabled===true||$(this).hasClass("ui-state-disabled"))){return}return(typeof handler==="string"?instance[handler]:handler).apply(instance,arguments)}if(typeof handler!=="string"){handlerProxy.guid=handler.guid=handler.guid||handlerProxy.guid||$.guid++}var match=event.match(/^([\w:-]*)\s*(.*)$/);var eventName=match[1]+instance.eventNamespace;var selector=match[2];if(selector){delegateElement.on(eventName,selector,handlerProxy)}else{element.on(eventName,handlerProxy)}}))},_off:function(element,eventName){eventName=(eventName||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace;element.off(eventName);this.bindings=$(this.bindings.not(element).get());this.focusable=$(this.focusable.not(element).get());this.hoverable=$(this.hoverable.not(element).get())},_delay:function(handler,delay){function handlerProxy(){return(typeof handler==="string"?instance[handler]:handler).apply(instance,arguments)}var instance=this;return setTimeout(handlerProxy,delay||0)},_hoverable:function(element){this.hoverable=this.hoverable.add(element);this._on(element,{mouseenter:function(event){this._addClass($(event.currentTarget),null,"ui-state-hover")},mouseleave:function(event){this._removeClass($(event.currentTarget),null,"ui-state-hover")}})},_focusable:function(element){this.focusable=this.focusable.add(element);this._on(element,{focusin:function(event){this._addClass($(event.currentTarget),null,"ui-state-focus")},focusout:function(event){this._removeClass($(event.currentTarget),null,"ui-state-focus")}})},_trigger:function(type,event,data){var prop,orig;var callback=this.options[type];data=data||{};event=$.Event(event);event.type=(type===this.widgetEventPrefix?type:this.widgetEventPrefix+type).toLowerCase();event.target=this.element[0];orig=event.originalEvent;if(orig){for(prop in orig){if(!(prop in event)){event[prop]=orig[prop]}}}this.element.trigger(event,data);return!(typeof callback==="function"&&callback.apply(this.element[0],[event].concat(data))===false||event.isDefaultPrevented())}};$.each({show:"fadeIn",hide:"fadeOut"},(function(method,defaultEffect){$.Widget.prototype["_"+method]=function(element,options,callback){if(typeof options==="string"){options={effect:options}}var hasOptions;var effectName=!options?method:options===true||typeof options==="number"?defaultEffect:options.effect||defaultEffect;options=options||{};if(typeof options==="number"){options={duration:options}}else if(options===true){options={}}hasOptions=!$.isEmptyObject(options);options.complete=callback;if(options.delay){element.delay(options.delay)}if(hasOptions&&$.effects&&$.effects.effect[effectName]){element[method](options)}else if(effectName!==method&&element[effectName]){element[effectName](options.duration,options.easing,callback)}else{element.queue((function(next){$(this)[method]();if(callback){callback.call(element[0])}next()}))}}}));return $.widget}));
/*!
 * jQuery UI Unique ID 1.13.2
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
(function(factory){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","./version"],factory)}else{factory(jQuery)}})((function($){"use strict";return $.fn.extend({uniqueId:function(){var uuid=0;return function(){return this.each((function(){if(!this.id){this.id="ui-id-"+ ++uuid}}))}}(),removeUniqueId:function(){return this.each((function(){if(/^ui-id-\d+$/.test(this.id)){$(this).removeAttr("id")}}))}})}));
/*!
 * jQuery UI Position 1.13.2
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/position/
 */
(function(factory){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","./version"],factory)}else{factory(jQuery)}})((function($){"use strict";(function(){var cachedScrollbarWidth,max=Math.max,abs=Math.abs,rhorizontal=/left|center|right/,rvertical=/top|center|bottom/,roffset=/[\+\-]\d+(\.[\d]+)?%?/,rposition=/^\w+/,rpercent=/%$/,_position=$.fn.position;function getOffsets(offsets,width,height){return[parseFloat(offsets[0])*(rpercent.test(offsets[0])?width/100:1),parseFloat(offsets[1])*(rpercent.test(offsets[1])?height/100:1)]}function parseCss(element,property){return parseInt($.css(element,property),10)||0}function isWindow(obj){return obj!=null&&obj===obj.window}function getDimensions(elem){var raw=elem[0];if(raw.nodeType===9){return{width:elem.width(),height:elem.height(),offset:{top:0,left:0}}}if(isWindow(raw)){return{width:elem.width(),height:elem.height(),offset:{top:elem.scrollTop(),left:elem.scrollLeft()}}}if(raw.preventDefault){return{width:0,height:0,offset:{top:raw.pageY,left:raw.pageX}}}return{width:elem.outerWidth(),height:elem.outerHeight(),offset:elem.offset()}}$.position={scrollbarWidth:function(){if(cachedScrollbarWidth!==undefined){return cachedScrollbarWidth}var w1,w2,div=$("<div style="+"'display:block;position:absolute;width:200px;height:200px;overflow:hidden;'>"+"<div style='height:300px;width:auto;'></div></div>"),innerDiv=div.children()[0];$("body").append(div);w1=innerDiv.offsetWidth;div.css("overflow","scroll");w2=innerDiv.offsetWidth;if(w1===w2){w2=div[0].clientWidth}div.remove();return cachedScrollbarWidth=w1-w2},getScrollInfo:function(within){var overflowX=within.isWindow||within.isDocument?"":within.element.css("overflow-x"),overflowY=within.isWindow||within.isDocument?"":within.element.css("overflow-y"),hasOverflowX=overflowX==="scroll"||overflowX==="auto"&&within.width<within.element[0].scrollWidth,hasOverflowY=overflowY==="scroll"||overflowY==="auto"&&within.height<within.element[0].scrollHeight;return{width:hasOverflowY?$.position.scrollbarWidth():0,height:hasOverflowX?$.position.scrollbarWidth():0}},getWithinInfo:function(element){var withinElement=$(element||window),isElemWindow=isWindow(withinElement[0]),isDocument=!!withinElement[0]&&withinElement[0].nodeType===9,hasOffset=!isElemWindow&&!isDocument;return{element:withinElement,isWindow:isElemWindow,isDocument:isDocument,offset:hasOffset?$(element).offset():{left:0,top:0},scrollLeft:withinElement.scrollLeft(),scrollTop:withinElement.scrollTop(),width:withinElement.outerWidth(),height:withinElement.outerHeight()}}};$.fn.position=function(options){if(!options||!options.of){return _position.apply(this,arguments)}options=$.extend({},options);var atOffset,targetWidth,targetHeight,targetOffset,basePosition,dimensions,target=typeof options.of==="string"?$(document).find(options.of):$(options.of),within=$.position.getWithinInfo(options.within),scrollInfo=$.position.getScrollInfo(within),collision=(options.collision||"flip").split(" "),offsets={};dimensions=getDimensions(target);if(target[0].preventDefault){options.at="left top"}targetWidth=dimensions.width;targetHeight=dimensions.height;targetOffset=dimensions.offset;basePosition=$.extend({},targetOffset);$.each(["my","at"],(function(){var pos=(options[this]||"").split(" "),horizontalOffset,verticalOffset;if(pos.length===1){pos=rhorizontal.test(pos[0])?pos.concat(["center"]):rvertical.test(pos[0])?["center"].concat(pos):["center","center"]}pos[0]=rhorizontal.test(pos[0])?pos[0]:"center";pos[1]=rvertical.test(pos[1])?pos[1]:"center";horizontalOffset=roffset.exec(pos[0]);verticalOffset=roffset.exec(pos[1]);offsets[this]=[horizontalOffset?horizontalOffset[0]:0,verticalOffset?verticalOffset[0]:0];options[this]=[rposition.exec(pos[0])[0],rposition.exec(pos[1])[0]]}));if(collision.length===1){collision[1]=collision[0]}if(options.at[0]==="right"){basePosition.left+=targetWidth}else if(options.at[0]==="center"){basePosition.left+=targetWidth/2}if(options.at[1]==="bottom"){basePosition.top+=targetHeight}else if(options.at[1]==="center"){basePosition.top+=targetHeight/2}atOffset=getOffsets(offsets.at,targetWidth,targetHeight);basePosition.left+=atOffset[0];basePosition.top+=atOffset[1];return this.each((function(){var collisionPosition,using,elem=$(this),elemWidth=elem.outerWidth(),elemHeight=elem.outerHeight(),marginLeft=parseCss(this,"marginLeft"),marginTop=parseCss(this,"marginTop"),collisionWidth=elemWidth+marginLeft+parseCss(this,"marginRight")+scrollInfo.width,collisionHeight=elemHeight+marginTop+parseCss(this,"marginBottom")+scrollInfo.height,position=$.extend({},basePosition),myOffset=getOffsets(offsets.my,elem.outerWidth(),elem.outerHeight());if(options.my[0]==="right"){position.left-=elemWidth}else if(options.my[0]==="center"){position.left-=elemWidth/2}if(options.my[1]==="bottom"){position.top-=elemHeight}else if(options.my[1]==="center"){position.top-=elemHeight/2}position.left+=myOffset[0];position.top+=myOffset[1];collisionPosition={marginLeft:marginLeft,marginTop:marginTop};$.each(["left","top"],(function(i,dir){if($.ui.position[collision[i]]){$.ui.position[collision[i]][dir](position,{targetWidth:targetWidth,targetHeight:targetHeight,elemWidth:elemWidth,elemHeight:elemHeight,collisionPosition:collisionPosition,collisionWidth:collisionWidth,collisionHeight:collisionHeight,offset:[atOffset[0]+myOffset[0],atOffset[1]+myOffset[1]],my:options.my,at:options.at,within:within,elem:elem})}}));if(options.using){using=function(props){var left=targetOffset.left-position.left,right=left+targetWidth-elemWidth,top=targetOffset.top-position.top,bottom=top+targetHeight-elemHeight,feedback={target:{element:target,left:targetOffset.left,top:targetOffset.top,width:targetWidth,height:targetHeight},element:{element:elem,left:position.left,top:position.top,width:elemWidth,height:elemHeight},horizontal:right<0?"left":left>0?"right":"center",vertical:bottom<0?"top":top>0?"bottom":"middle"};if(targetWidth<elemWidth&&abs(left+right)<targetWidth){feedback.horizontal="center"}if(targetHeight<elemHeight&&abs(top+bottom)<targetHeight){feedback.vertical="middle"}if(max(abs(left),abs(right))>max(abs(top),abs(bottom))){feedback.important="horizontal"}else{feedback.important="vertical"}options.using.call(this,props,feedback)}}elem.offset($.extend(position,{using:using}))}))};$.ui.position={fit:{left:function(position,data){var within=data.within,withinOffset=within.isWindow?within.scrollLeft:within.offset.left,outerWidth=within.width,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=withinOffset-collisionPosLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-withinOffset,newOverRight;if(data.collisionWidth>outerWidth){if(overLeft>0&&overRight<=0){newOverRight=position.left+overLeft+data.collisionWidth-outerWidth-withinOffset;position.left+=overLeft-newOverRight}else if(overRight>0&&overLeft<=0){position.left=withinOffset}else{if(overLeft>overRight){position.left=withinOffset+outerWidth-data.collisionWidth}else{position.left=withinOffset}}}else if(overLeft>0){position.left+=overLeft}else if(overRight>0){position.left-=overRight}else{position.left=max(position.left-collisionPosLeft,position.left)}},top:function(position,data){var within=data.within,withinOffset=within.isWindow?within.scrollTop:within.offset.top,outerHeight=data.within.height,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=withinOffset-collisionPosTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-withinOffset,newOverBottom;if(data.collisionHeight>outerHeight){if(overTop>0&&overBottom<=0){newOverBottom=position.top+overTop+data.collisionHeight-outerHeight-withinOffset;position.top+=overTop-newOverBottom}else if(overBottom>0&&overTop<=0){position.top=withinOffset}else{if(overTop>overBottom){position.top=withinOffset+outerHeight-data.collisionHeight}else{position.top=withinOffset}}}else if(overTop>0){position.top+=overTop}else if(overBottom>0){position.top-=overBottom}else{position.top=max(position.top-collisionPosTop,position.top)}}},flip:{left:function(position,data){var within=data.within,withinOffset=within.offset.left+within.scrollLeft,outerWidth=within.width,offsetLeft=within.isWindow?within.scrollLeft:within.offset.left,collisionPosLeft=position.left-data.collisionPosition.marginLeft,overLeft=collisionPosLeft-offsetLeft,overRight=collisionPosLeft+data.collisionWidth-outerWidth-offsetLeft,myOffset=data.my[0]==="left"?-data.elemWidth:data.my[0]==="right"?data.elemWidth:0,atOffset=data.at[0]==="left"?data.targetWidth:data.at[0]==="right"?-data.targetWidth:0,offset=-2*data.offset[0],newOverRight,newOverLeft;if(overLeft<0){newOverRight=position.left+myOffset+atOffset+offset+data.collisionWidth-outerWidth-withinOffset;if(newOverRight<0||newOverRight<abs(overLeft)){position.left+=myOffset+atOffset+offset}}else if(overRight>0){newOverLeft=position.left-data.collisionPosition.marginLeft+myOffset+atOffset+offset-offsetLeft;if(newOverLeft>0||abs(newOverLeft)<overRight){position.left+=myOffset+atOffset+offset}}},top:function(position,data){var within=data.within,withinOffset=within.offset.top+within.scrollTop,outerHeight=within.height,offsetTop=within.isWindow?within.scrollTop:within.offset.top,collisionPosTop=position.top-data.collisionPosition.marginTop,overTop=collisionPosTop-offsetTop,overBottom=collisionPosTop+data.collisionHeight-outerHeight-offsetTop,top=data.my[1]==="top",myOffset=top?-data.elemHeight:data.my[1]==="bottom"?data.elemHeight:0,atOffset=data.at[1]==="top"?data.targetHeight:data.at[1]==="bottom"?-data.targetHeight:0,offset=-2*data.offset[1],newOverTop,newOverBottom;if(overTop<0){newOverBottom=position.top+myOffset+atOffset+offset+data.collisionHeight-outerHeight-withinOffset;if(newOverBottom<0||newOverBottom<abs(overTop)){position.top+=myOffset+atOffset+offset}}else if(overBottom>0){newOverTop=position.top-data.collisionPosition.marginTop+myOffset+atOffset+offset-offsetTop;if(newOverTop>0||abs(newOverTop)<overBottom){position.top+=myOffset+atOffset+offset}}}},flipfit:{left:function(){$.ui.position.flip.left.apply(this,arguments);$.ui.position.fit.left.apply(this,arguments)},top:function(){$.ui.position.flip.top.apply(this,arguments);$.ui.position.fit.top.apply(this,arguments)}}}})();return $.ui.position}));
/*!
 * jQuery UI Tooltip 1.13.2
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
(function(factory){"use strict";if(typeof define==="function"&&define.amd){define(["jquery","../keycode","../position","../unique-id","../version","../widget"],factory)}else{factory(jQuery)}})((function($){"use strict";$.widget("ui.tooltip",{version:"1.13.2",options:{classes:{"ui-tooltip":"ui-corner-all ui-widget-shadow"},content:function(){var title=$(this).attr("title");return $("<a>").text(title).html()},hide:true,items:"[title]:not([disabled])",position:{my:"left top+15",at:"left bottom",collision:"flipfit flip"},show:true,track:false,close:null,open:null},_addDescribedBy:function(elem,id){var describedby=(elem.attr("aria-describedby")||"").split(/\s+/);describedby.push(id);elem.data("ui-tooltip-id",id).attr("aria-describedby",String.prototype.trim.call(describedby.join(" ")))},_removeDescribedBy:function(elem){var id=elem.data("ui-tooltip-id"),describedby=(elem.attr("aria-describedby")||"").split(/\s+/),index=$.inArray(id,describedby);if(index!==-1){describedby.splice(index,1)}elem.removeData("ui-tooltip-id");describedby=String.prototype.trim.call(describedby.join(" "));if(describedby){elem.attr("aria-describedby",describedby)}else{elem.removeAttr("aria-describedby")}},_create:function(){this._on({mouseover:"open",focusin:"open"});this.tooltips={};this.parents={};this.liveRegion=$("<div>").attr({role:"log","aria-live":"assertive","aria-relevant":"additions"}).appendTo(this.document[0].body);this._addClass(this.liveRegion,null,"ui-helper-hidden-accessible");this.disabledTitles=$([])},_setOption:function(key,value){var that=this;this._super(key,value);if(key==="content"){$.each(this.tooltips,(function(id,tooltipData){that._updateContent(tooltipData.element)}))}},_setOptionDisabled:function(value){this[value?"_disable":"_enable"]()},_disable:function(){var that=this;$.each(this.tooltips,(function(id,tooltipData){var event=$.Event("blur");event.target=event.currentTarget=tooltipData.element[0];that.close(event,true)}));this.disabledTitles=this.disabledTitles.add(this.element.find(this.options.items).addBack().filter((function(){var element=$(this);if(element.is("[title]")){return element.data("ui-tooltip-title",element.attr("title")).removeAttr("title")}})))},_enable:function(){this.disabledTitles.each((function(){var element=$(this);if(element.data("ui-tooltip-title")){element.attr("title",element.data("ui-tooltip-title"))}}));this.disabledTitles=$([])},open:function(event){var that=this,target=$(event?event.target:this.element).closest(this.options.items);if(!target.length||target.data("ui-tooltip-id")){return}if(target.attr("title")){target.data("ui-tooltip-title",target.attr("title"))}target.data("ui-tooltip-open",true);if(event&&event.type==="mouseover"){target.parents().each((function(){var parent=$(this),blurEvent;if(parent.data("ui-tooltip-open")){blurEvent=$.Event("blur");blurEvent.target=blurEvent.currentTarget=this;that.close(blurEvent,true)}if(parent.attr("title")){parent.uniqueId();that.parents[this.id]={element:this,title:parent.attr("title")};parent.attr("title","")}}))}this._registerCloseHandlers(event,target);this._updateContent(target,event)},_updateContent:function(target,event){var content,contentOption=this.options.content,that=this,eventType=event?event.type:null;if(typeof contentOption==="string"||contentOption.nodeType||contentOption.jquery){return this._open(event,target,contentOption)}content=contentOption.call(target[0],(function(response){that._delay((function(){if(!target.data("ui-tooltip-open")){return}if(event){event.type=eventType}this._open(event,target,response)}))}));if(content){this._open(event,target,content)}},_open:function(event,target,content){var tooltipData,tooltip,delayedShow,a11yContent,positionOption=$.extend({},this.options.position);if(!content){return}tooltipData=this._find(target);if(tooltipData){tooltipData.tooltip.find(".ui-tooltip-content").html(content);return}if(target.is("[title]")){if(event&&event.type==="mouseover"){target.attr("title","")}else{target.removeAttr("title")}}tooltipData=this._tooltip(target);tooltip=tooltipData.tooltip;this._addDescribedBy(target,tooltip.attr("id"));tooltip.find(".ui-tooltip-content").html(content);this.liveRegion.children().hide();a11yContent=$("<div>").html(tooltip.find(".ui-tooltip-content").html());a11yContent.removeAttr("name").find("[name]").removeAttr("name");a11yContent.removeAttr("id").find("[id]").removeAttr("id");a11yContent.appendTo(this.liveRegion);function position(event){positionOption.of=event;if(tooltip.is(":hidden")){return}tooltip.position(positionOption)}if(this.options.track&&event&&/^mouse/.test(event.type)){this._on(this.document,{mousemove:position});position(event)}else{tooltip.position($.extend({of:target},this.options.position))}tooltip.hide();this._show(tooltip,this.options.show);if(this.options.track&&this.options.show&&this.options.show.delay){delayedShow=this.delayedShow=setInterval((function(){if(tooltip.is(":visible")){position(positionOption.of);clearInterval(delayedShow)}}),13)}this._trigger("open",event,{tooltip:tooltip})},_registerCloseHandlers:function(event,target){var events={keyup:function(event){if(event.keyCode===$.ui.keyCode.ESCAPE){var fakeEvent=$.Event(event);fakeEvent.currentTarget=target[0];this.close(fakeEvent,true)}}};if(target[0]!==this.element[0]){events.remove=function(){var targetElement=this._find(target);if(targetElement){this._removeTooltip(targetElement.tooltip)}}}if(!event||event.type==="mouseover"){events.mouseleave="close"}if(!event||event.type==="focusin"){events.focusout="close"}this._on(true,target,events)},close:function(event){var tooltip,that=this,target=$(event?event.currentTarget:this.element),tooltipData=this._find(target);if(!tooltipData){target.removeData("ui-tooltip-open");return}tooltip=tooltipData.tooltip;if(tooltipData.closing){return}clearInterval(this.delayedShow);if(target.data("ui-tooltip-title")&&!target.attr("title")){target.attr("title",target.data("ui-tooltip-title"))}this._removeDescribedBy(target);tooltipData.hiding=true;tooltip.stop(true);this._hide(tooltip,this.options.hide,(function(){that._removeTooltip($(this))}));target.removeData("ui-tooltip-open");this._off(target,"mouseleave focusout keyup");if(target[0]!==this.element[0]){this._off(target,"remove")}this._off(this.document,"mousemove");if(event&&event.type==="mouseleave"){$.each(this.parents,(function(id,parent){$(parent.element).attr("title",parent.title);delete that.parents[id]}))}tooltipData.closing=true;this._trigger("close",event,{tooltip:tooltip});if(!tooltipData.hiding){tooltipData.closing=false}},_tooltip:function(element){var tooltip=$("<div>").attr("role","tooltip"),content=$("<div>").appendTo(tooltip),id=tooltip.uniqueId().attr("id");this._addClass(content,"ui-tooltip-content");this._addClass(tooltip,"ui-tooltip","ui-widget ui-widget-content");tooltip.appendTo(this._appendTo(element));return this.tooltips[id]={element:element,tooltip:tooltip}},_find:function(target){var id=target.data("ui-tooltip-id");return id?this.tooltips[id]:null},_removeTooltip:function(tooltip){clearInterval(this.delayedShow);tooltip.remove();delete this.tooltips[tooltip.attr("id")]},_appendTo:function(target){var element=target.closest(".ui-front, dialog");if(!element.length){element=this.document[0].body}return element},_destroy:function(){var that=this;$.each(this.tooltips,(function(id,tooltipData){var event=$.Event("blur"),element=tooltipData.element;event.target=event.currentTarget=element[0];that.close(event,true);$("#"+id).remove();if(element.data("ui-tooltip-title")){if(!element.attr("title")){element.attr("title",element.data("ui-tooltip-title"))}element.removeData("ui-tooltip-title")}}));this.liveRegion.remove()}});if($.uiBackCompat!==false){$.widget("ui.tooltip",$.ui.tooltip,{options:{tooltipClass:null},_tooltip:function(){var tooltipData=this._superApply(arguments);if(this.options.tooltipClass){tooltipData.tooltip.addClass(this.options.tooltipClass)}return tooltipData}})}return $.ui.tooltip}));"use strict";var fluid=fluid||{};(function($){fluid.thatistBridge=function(name,peer){var togo=function(funcname){var segs=funcname.split(".");var move=peer;for(var i=0;i<segs.length;++i){move=move[segs[i]]}var args=[this];if(arguments.length===2){args=args.concat($.makeArray(arguments[1]))}var ret=move.apply(null,args);this.that=function(){return ret};return ret&&ret.constructor&&ret.constructor.name==="fluid.componentConstructor"?this:ret};$.fn[name]=togo;return togo};fluid.thatistBridge("fluid",fluid);var canHaveDefaultTabindex=function(elements){if(elements.length<=0){return false}return $(elements[0]).is("a, input, button, select, area, textarea, object")};var getValue=function(elements){if(elements.length<=0){return undefined}if(!fluid.tabindex.hasAttr(elements)){return canHaveDefaultTabindex(elements)?Number(0):undefined}var value=elements.attr("tabindex");return Number(value)};var setValue=function(elements,toIndex){return elements.each((function(i,item){$(item).attr("tabindex",toIndex)}))};fluid.tabindex=function(target,toIndex){target=$(target);if(toIndex!==null&&toIndex!==undefined){return setValue(target,toIndex)}else{return getValue(target)}};fluid.tabindex.remove=function(target){target=$(target);return target.each((function(i,item){$(item).removeAttr("tabindex")}))};fluid.tabindex.hasAttr=function(target){target=$(target);if(target.length<=0){return false}var togo=target.map((function(){var attributeNode=this.getAttributeNode("tabindex");return attributeNode?attributeNode.specified:false}));return togo.length===1?togo[0]:togo};fluid.tabindex.has=function(target){target=$(target);return fluid.tabindex.hasAttr(target)||canHaveDefaultTabindex(target)};fluid.a11y=$.a11y||{};fluid.a11y.orientation={HORIZONTAL:0,VERTICAL:1,BOTH:2};var UP_DOWN_KEYMAP={next:$.ui.keyCode.DOWN,previous:$.ui.keyCode.UP};var LEFT_RIGHT_KEYMAP={next:$.ui.keyCode.RIGHT,previous:$.ui.keyCode.LEFT};var unwrap=function(element){return element.jquery?element[0]:element};var makeElementsTabFocussable=function(elements){elements.each((function(idx,item){item=$(item);if(!item.fluid("tabindex.has")||item.fluid("tabindex")<0){item.fluid("tabindex",0)}}))};fluid.tabbable=function(target){target=$(target);makeElementsTabFocussable(target)};var CONTEXT_KEY="selectionContext";var NO_SELECTION=-32768;var cleanUpWhenLeavingContainer=function(selectionContext){if(selectionContext.activeItemIndex!==NO_SELECTION){if(selectionContext.options.onLeaveContainer){selectionContext.options.onLeaveContainer(selectionContext.selectables[selectionContext.activeItemIndex])}else if(selectionContext.options.onUnselect){selectionContext.options.onUnselect(selectionContext.selectables[selectionContext.activeItemIndex])}}if(!selectionContext.options.rememberSelectionState){selectionContext.activeItemIndex=NO_SELECTION}};var drawSelection=function(elementToSelect,handler){if(handler){handler(elementToSelect)}};var eraseSelection=function(selectedElement,handler){if(handler&&selectedElement){handler(selectedElement)}};var unselectElement=function(selectedElement,selectionContext){eraseSelection(selectedElement,selectionContext.options.onUnselect)};var selectElement=function(elementToSelect,selectionContext){unselectElement(selectionContext.selectedElement(),selectionContext);elementToSelect=unwrap(elementToSelect);var newIndex=selectionContext.selectables.index(elementToSelect);if(newIndex===-1){return}selectionContext.activeItemIndex=newIndex;drawSelection(elementToSelect,selectionContext.options.onSelect)};var selectableFocusHandler=function(selectionContext){return function(evt){$(evt.target).fluid("tabindex",0);selectElement(evt.target,selectionContext);return evt.stopPropagation()}};var selectableBlurHandler=function(selectionContext){return function(evt){$(evt.target).fluid("tabindex",selectionContext.options.selectablesTabindex);unselectElement(evt.target,selectionContext);return evt.stopPropagation()}};var reifyIndex=async function(sc_that){var elements=sc_that.selectables;if(sc_that.activeItemIndex>=elements.length){sc_that.activeItemIndex=sc_that.options.noWrap?elements.length-1:0}if(sc_that.activeItemIndex<0&&sc_that.activeItemIndex!==NO_SELECTION){sc_that.activeItemIndex=sc_that.options.noWrap?0:elements.length-1}if(sc_that.activeItemIndex>=0){return fluid.focus(elements[sc_that.activeItemIndex])}};var prepareShift=async function(selectionContext){var selElm=selectionContext.selectedElement();if(selElm){await fluid.blur(selElm)}unselectElement(selectionContext.selectedElement(),selectionContext);if(selectionContext.activeItemIndex===NO_SELECTION){selectionContext.activeItemIndex=-1}};var focusNextElement=async function(selectionContext){await prepareShift(selectionContext);++selectionContext.activeItemIndex;return reifyIndex(selectionContext)};var focusPreviousElement=async function(selectionContext){await prepareShift(selectionContext);--selectionContext.activeItemIndex;return reifyIndex(selectionContext)};var arrowKeyHandler=function(selectionContext,keyMap){return async function(evt){if(evt.which===keyMap.next){await focusNextElement(selectionContext);evt.preventDefault()}else if(evt.which===keyMap.previous){await focusPreviousElement(selectionContext);evt.preventDefault()}}};var getKeyMapForDirection=function(direction){var keyMap;if(direction===fluid.a11y.orientation.HORIZONTAL){keyMap=LEFT_RIGHT_KEYMAP}else if(direction===fluid.a11y.orientation.VERTICAL){keyMap=UP_DOWN_KEYMAP}return keyMap};var tabKeyHandler=function(selectionContext){return function(evt){if(evt.which!==$.ui.keyCode.TAB){return}cleanUpWhenLeavingContainer(selectionContext);if(evt.shiftKey){selectionContext.focusIsLeavingContainer=true}}};var containerFocusHandler=function(selectionContext){return async function(evt){var shouldOrig=selectionContext.options.autoSelectFirstItem;var shouldSelect=typeof shouldOrig==="function"?shouldOrig():shouldOrig;if(selectionContext.focusIsLeavingContainer){shouldSelect=false}if(shouldSelect&&evt.target===selectionContext.container.get(0)){if(selectionContext.activeItemIndex===NO_SELECTION){selectionContext.activeItemIndex=0}await fluid.focus(selectionContext.selectables[selectionContext.activeItemIndex])}return evt.stopPropagation()}};var containerBlurHandler=function(selectionContext){return function(evt){selectionContext.focusIsLeavingContainer=false;return evt.stopPropagation()}};var makeElementsSelectable=function(container,defaults,userOptions){var options=$.extend(true,{},defaults,userOptions);var keyMap=getKeyMapForDirection(options.direction);var selectableElements=options.selectableElements?options.selectableElements:container.find(options.selectableSelector);var that={container:container,activeItemIndex:NO_SELECTION,selectables:selectableElements,focusIsLeavingContainer:false,options:options};that.selectablesUpdated=async function(focusedItem){if(typeof that.options.selectablesTabindex==="number"){that.selectables.fluid("tabindex",that.options.selectablesTabindex)}that.selectables.off("focus."+CONTEXT_KEY);that.selectables.off("blur."+CONTEXT_KEY);that.selectables.on("focus."+CONTEXT_KEY,selectableFocusHandler(that));that.selectables.on("blur."+CONTEXT_KEY,selectableBlurHandler(that));if(keyMap&&that.options.noBubbleListeners){that.selectables.off("keydown."+CONTEXT_KEY);that.selectables.on("keydown."+CONTEXT_KEY,arrowKeyHandler(that,keyMap))}if(focusedItem){selectElement(focusedItem,that)}else{return reifyIndex(that)}};that.refresh=async function(){if(!that.options.selectableSelector){fluid.fail("Cannot refresh selectable context which was not initialised by a selector")}that.selectables=container.find(options.selectableSelector);return that.selectablesUpdated()};that.selectedElement=function(){return that.activeItemIndex<0?null:that.selectables[that.activeItemIndex]};if(keyMap&&!that.options.noBubbleListeners){container.on("keydown",arrowKeyHandler(that,keyMap))}container.on("keydown",tabKeyHandler(that));container.on("focus",containerFocusHandler(that));container.on("blur",containerBlurHandler(that));that.promise=that.selectablesUpdated();return that};fluid.selectable=function(target,options){target=$(target);var that=makeElementsSelectable(target,fluid.selectable.defaults,options);fluid.setScopedData(target,CONTEXT_KEY,that);return that};fluid.selectable.select=async function(target,toSelect){return fluid.focus(toSelect)};fluid.selectable.selectNext=async function(target){target=$(target);return focusNextElement(fluid.getScopedData(target,CONTEXT_KEY))};fluid.selectable.selectPrevious=async function(target){target=$(target);return focusPreviousElement(fluid.getScopedData(target,CONTEXT_KEY))};fluid.selectable.currentSelection=function(target){target=$(target);var that=fluid.getScopedData(target,CONTEXT_KEY);return $(that.selectedElement())};fluid.selectable.defaults={direction:fluid.a11y.orientation.VERTICAL,selectablesTabindex:-1,autoSelectFirstItem:true,rememberSelectionState:true,selectableSelector:".selectable",selectableElements:null,onSelect:null,onUnselect:null,onLeaveContainer:null,noWrap:false};var checkForModifier=function(binding,evt){if(!binding.modifier){return true}var modifierKey=binding.modifier;var isCtrlKeyPresent=modifierKey&&evt.ctrlKey;var isAltKeyPresent=modifierKey&&evt.altKey;var isShiftKeyPresent=modifierKey&&evt.shiftKey;return isCtrlKeyPresent||isAltKeyPresent||isShiftKeyPresent};var makeActivationHandler=function(binding){return function(evt){var target=evt.target;if(!fluid.enabled(target)){return}var code=evt.which?evt.which:evt.keyCode;if(code===binding.key&&binding.activateHandler&&checkForModifier(binding,evt)){var event=$.Event("fluid-activate");$(target).trigger(event,[binding.activateHandler]);if(event.isDefaultPrevented()){evt.preventDefault()}}}};var makeElementsActivatable=function(elements,onActivateHandler,defaultKeys,options){var bindings=[];$(defaultKeys).each((function(index,key){bindings.push({modifier:null,key:key,activateHandler:onActivateHandler})}));if(options&&options.additionalBindings){bindings=bindings.concat(options.additionalBindings)}fluid.initEnablement(elements);for(var i=0;i<bindings.length;++i){var binding=bindings[i];elements.on("keydown",makeActivationHandler(binding))}elements.on("fluid-activate",(function(evt,handler){handler=handler||onActivateHandler;return handler?handler(evt):null}))};fluid.activatable=function(target,fn,options){target=$(target);makeElementsActivatable(target,fn,fluid.activatable.defaults.keys,options)};fluid.activate=function(target){$(target).trigger("fluid-activate")};fluid.activatable.defaults={keys:[$.ui.keyCode.ENTER,$.ui.keyCode.SPACE]}})(jQuery);
/*!
 * Fluid Infusion v4.6.0
 *
 * Infusion is distributed under the Educational Community License 2.0 and new BSD licenses:
 * http://wiki.fluidproject.org/display/fluid/Fluid+Licensing
 *
 * Copyright The Infusion copyright holders
 * See the AUTHORS.md file at the top-level directory of this distribution and at
 * https://github.com/fluid-project/infusion/raw/main/AUTHORS.md
 */
"use strict";var fluid=fluid||{};fluid.version="Infusion 4.6.0";fluid.Error=Error;fluid.environment={fluid:fluid};fluid.global=fluid.global||typeof window!=="undefined"?window:typeof self!=="undefined"?self:{};fluid.invokeLater=function(func){return setTimeout(func,0)};fluid.defeatLogging=true;fluid.activityTracing=false;fluid.activityTrace=[];var activityParser=/(%\w+)/g;fluid.renderActivityArgument=function(arg){if(fluid.isComponent(arg)){return fluid.dumpComponentAndPath(arg)}else{return arg}};fluid.renderOneActivity=function(activity,nowhile){var togo=nowhile===true?[]:["    while "];var message=activity.message;var index=activityParser.lastIndex=0;while(true){var match=activityParser.exec(message);if(match){var key=match[1].substring(1);togo.push(message.substring(index,match.index));togo.push(fluid.renderActivityArgument(activity.args[key]));index=activityParser.lastIndex}else{break}}if(index<message.length){togo.push(message.substring(index))}return togo};fluid.renderActivity=function(activityStack,renderer){renderer=renderer||fluid.renderOneActivity;return fluid.transform(activityStack,renderer)};fluid.singleThreadLocal=function(initFunc){var value=initFunc();return function(newValue){return newValue===undefined?value:value=newValue}};fluid.threadLocal=fluid.singleThreadLocal;fluid.globalThreadLocal=fluid.threadLocal((function(){return{}}));fluid.getActivityStack=function(){var root=fluid.globalThreadLocal();if(!root.activityStack){root.activityStack=[]}return root.activityStack};fluid.describeActivity=fluid.getActivityStack;fluid.logActivity=function(activity){activity=activity||fluid.describeActivity();var rendered=fluid.renderActivity(activity).reverse();if(rendered.length>0){fluid.log("Current activity: ");fluid.each(rendered,(function(args){fluid.log.apply(null,args)}))}};fluid.pushActivity=function(type,message,args){var record={type:type,message:message,args:args,time:(new Date).getTime()};if(fluid.activityTracing){fluid.activityTrace.push(record)}if(fluid.passLogLevel(fluid.logLevel.TRACE)){fluid.log.apply(null,fluid.renderOneActivity(record,true))}var activityStack=fluid.getActivityStack();activityStack.push(record)};fluid.popActivity=function(popframes){popframes=popframes||1;if(fluid.activityTracing){fluid.activityTrace.push({pop:popframes})}var activityStack=fluid.getActivityStack();var popped=activityStack.length-popframes;activityStack.length=popped<0?0:popped};fluid.FluidError=function(){var togo=Error.apply(this,arguments);this.message=togo.message;try{throw togo}catch(togo){this.stack=togo.stack}return this};fluid.FluidError.prototype=Object.create(Error.prototype);fluid.logFailure=function(args,activity){fluid.log.apply(null,[fluid.logLevel.FAIL,"ASSERTION FAILED: "].concat(args));fluid.logActivity(activity)};fluid.renderLoggingArg=function(arg){return arg===undefined?"undefined":fluid.isPrimitive(arg)||!fluid.isPlainObject(arg)?arg:JSON.stringify(arg)};fluid.builtinFail=function(args){var message=fluid.transform(args,fluid.renderLoggingArg).join("");throw new fluid.FluidError("Assertion failure - check console for more details: "+message)};fluid.fail=function(...messages){var activity=fluid.makeArray(fluid.describeActivity());fluid.popActivity(activity.length);if(fluid.failureEvent){fluid.failureEvent.fire(messages,activity)}else{fluid.logFailure(messages,activity);fluid.builtinFail(messages,activity)}};fluid.notrycatch=false;fluid.tryCatch=function(tryfun,catchfun,finallyfun){finallyfun=finallyfun||fluid.identity;if(fluid.notrycatch){var togo=tryfun();finallyfun();return togo}else{try{return tryfun()}catch(e){if(catchfun){catchfun(e)}else{throw e}}finally{finallyfun()}}};fluid.expect=function(name,target,members){fluid.transform(fluid.makeArray(members),(function(key){if(target[key]===undefined){fluid.fail(name+" missing required member "+key)}}))};fluid.isLogging=function(){return logLevelStack[0].priority>fluid.logLevel.IMPORTANT.priority};fluid.isLogLevel=function(arg){return fluid.isMarker(arg)&&arg.priority!==undefined};fluid.passLogLevel=function(testLogLevel){return testLogLevel.priority<=logLevelStack[0].priority};fluid.setLogging=function(enabled){var logLevel;if(typeof enabled==="boolean"){logLevel=fluid.logLevel[enabled?"INFO":"IMPORTANT"]}else if(fluid.isLogLevel(enabled)){logLevel=enabled}else{fluid.fail("Unrecognised fluid logging level ",enabled)}logLevelStack.unshift(logLevel);fluid.defeatLogging=!fluid.isLogging()};fluid.setLogLevel=fluid.setLogging;fluid.popLogging=function(){var togo=logLevelStack.length===1?logLevelStack[0]:logLevelStack.shift();fluid.defeatLogging=!fluid.isLogging();return togo};fluid.doBrowserLog=function(args){if(typeof console!=="undefined"){if(console.debug){console.debug.apply(console,args)}else if(typeof console.log==="function"){console.log.apply(console,args)}}};fluid.log=function(){var directArgs=fluid.makeArray(arguments);var userLogLevel=fluid.logLevel.INFO;if(fluid.isLogLevel(directArgs[0])){userLogLevel=directArgs.shift()}if(fluid.passLogLevel(userLogLevel)){fluid.loggingEvent.fire(directArgs)}};fluid.isValue=function(value){return value!==undefined&&value!==null};fluid.isPrimitive=function(value){var valueType=typeof value;return!value||valueType==="string"||valueType==="boolean"||valueType==="number"||valueType==="function"};fluid.isJQuery=function(totest){return Boolean(totest&&totest.jquery&&totest.constructor&&totest.constructor.prototype&&totest.constructor.prototype.jquery)};fluid.isArrayable=function(totest){return Boolean(totest)&&(Object.prototype.toString.call(totest)==="[object Array]"||fluid.isJQuery(totest))};fluid.isPlainObject=function(totest,strict){var string=Object.prototype.toString.call(totest);if(string==="[object Array]"){return!strict}else if(string!=="[object Object]"){return false}return!totest.constructor||!totest.constructor.prototype||Object.prototype.hasOwnProperty.call(totest.constructor.prototype,"isPrototypeOf")};fluid.typeCode=function(totest){return fluid.isPrimitive(totest)||!fluid.isPlainObject(totest)?"primitive":fluid.isArrayable(totest)?"array":"object"};fluid.isIoCReference=function(ref){return typeof ref==="string"&&ref.charAt(0)==="{"};fluid.isReferenceOrExpander=function(ref){return ref&&(fluid.isIoCReference(ref)||ref.expander)};fluid.isDOMNode=function(obj){return obj&&typeof obj.nodeType==="number"};fluid.isComponent=function(obj){return obj&&obj.constructor===fluid.componentConstructor};fluid.isUncopyable=function(totest){return fluid.isPrimitive(totest)||!fluid.isPlainObject(totest)};fluid.isApplicable=function(totest){return totest.apply&&typeof totest.apply==="function"};fluid.identity=function(arg){return arg};fluid.notImplemented=function(){fluid.fail("This operation is not implemented")};fluid.firstDefined=function(a,b){return a===undefined?b:a};fluid.freshContainer=function(tocopy){return fluid.isArrayable(tocopy)?[]:{}};fluid.testStrategyRecursion=function(funcName,segs){if(segs.length>fluid.strategyRecursionBailout){fluid.fail("Runaway recursion encountered in "+funcName+" - reached path depth of "+fluid.strategyRecursionBailout+" via path of "+segs.join(".")+"this object is probably circularly connected. Either adjust your object structure to remove the circularity or increase fluid.strategyRecursionBailout")}};fluid.copyRecurse=function(tocopy,segs){fluid.testStrategyRecursion("fluid.copy",segs);if(fluid.isUncopyable(tocopy)){return tocopy}else{return fluid.transform(tocopy,(function(value,key){segs.push(key);var togo=fluid.copyRecurse(value,segs);segs.pop();return togo}))}};fluid.copy=function(tocopy){return fluid.copyRecurse(tocopy,[])};fluid.extend=$.extend;fluid.makeArray=function(arg){var togo=[];if(arg!==null&&arg!==undefined){if(fluid.isPrimitive(arg)||fluid.isPlainObject(arg,true)||typeof arg.length!=="number"){togo.push(arg)}else{for(var i=0;i<arg.length;++i){togo[i]=arg[i]}}}return togo};fluid.pushArray=function(holder,member,topush){var array=holder[member]?holder[member]:holder[member]=[];if(Array.isArray(topush)){array.push.apply(array,topush)}else{array.push(topush)}};function transformInternal(source,togo,key,transformations){var transit=source[key];for(var j=0;j<transformations.length;++j){transit=transformations[j](transit,key)}if(transit!==fluid.NO_VALUE){togo[key]=transit}}fluid.transform=function(source,...transformations){if(fluid.isPrimitive(source)){return source}var togo=fluid.freshContainer(source);if(fluid.isArrayable(source)){for(var i=0;i<source.length;++i){transformInternal(source,togo,i,transformations)}}else{for(var key in source){transformInternal(source,togo,key,transformations)}}return togo};fluid.forEachInRange=function(array,start,end,func){for(var i=start;i<end;++i){func(array[i],i)}};fluid.peek=function(array){return array.length===0?undefined:array[array.length-1]};fluid.each=function(source,func){if(fluid.isArrayable(source)){for(var i=0;i<source.length;++i){func(source[i],i)}}else{for(var key in source){func(source[key],key)}}};fluid.make_find=function(find_if){var target=find_if?false:undefined;return function(source,func,deffolt){var disp;if(fluid.isArrayable(source)){for(var i=0;i<source.length;++i){disp=func(source[i],i);if(disp!==target){return find_if?source[i]:disp}}}else{for(var key in source){disp=func(source[key],key);if(disp!==target){return find_if?source[key]:disp}}}return deffolt}};fluid.find=fluid.make_find(false);fluid.find_if=fluid.make_find(true);fluid.remove_if=function(source,fn,target){if(fluid.isArrayable(source)){for(var i=source.length-1;i>=0;--i){if(fn(source[i],i)){if(target){target.unshift(source[i])}source.splice(i,1)}}}else{for(var key in source){if(fn(source[key],key)){if(target){target[key]=source[key]}delete source[key]}}}return target||source};fluid.generate=function(n,generator,applyFunc){var togo=[];for(var i=0;i<n;++i){togo[i]=applyFunc?generator(i):generator}return togo};fluid.iota=function(count,first){first=first||0;var togo=[];for(var i=0;i<count;++i){togo[togo.length]=first++}return togo};fluid.getMembers=function(holder,name){return fluid.transform(holder,(function(member){return fluid.get(member,name)}))};fluid.filterKeys=function(toFilter,keys,exclude){return fluid.remove_if($.extend({},toFilter),(function(value,key){return exclude^keys.indexOf(key)===-1}))};fluid.censorKeys=function(toCensor,keys){return fluid.filterKeys(toCensor,keys,true)};fluid.keys=function(obj){var togo=[];for(var key in obj){togo.push(key)}return togo};fluid.values=function(obj){var togo=[];for(var key in obj){togo.push(obj[key])}return togo};fluid.keyForValue=function(obj,value){return fluid.find(obj,(function(thisValue,key){if(value===thisValue){return key}}))};fluid.arrayToHash=function(array){var togo={};fluid.each(array,(function(el){togo[el]=true}));return togo};fluid.hashToArray=function(hash,keyName,func){var togo=[];fluid.each(hash,(function(el,key){var newEl=el;if(keyName!==undefined){newEl={};newEl[keyName]=key}if(func){newEl=func(newEl,el,key)||newEl}else if(newEl!==el){$.extend(true,newEl,el)}togo.push(newEl)}));return togo};fluid.flatten=function(array){var togo=[];fluid.each(array,(function(element){if(fluid.isArrayable(element)){togo=togo.concat(element)}else{togo.push(element)}}));return togo};fluid.clear=function(target){if(fluid.isArrayable(target)){target.length=0}else{for(var i in target){delete target[i]}}};fluid.compareStringLength=function(ascending){return ascending?function(a,b){return a.length-b.length}:function(a,b){return b.length-a.length}};fluid.parseInteger=function(string){return isFinite(string)&&string%1===0?Number(string):NaN};fluid.roundToDecimal=function(num,scale,method){scale=scale&&scale>=0?Math.round(scale):0;if(method==="ceil"||method==="floor"){return Number(Math[method](num+"e"+scale)+"e-"+scale)}else{var sign=num>=0?1:-1;return Number(sign*(Math.round(Math.abs(num)+"e"+scale)+"e-"+scale))}};fluid.debounce=function(func,wait,immediate){var timeout,result;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate){result=func.apply(context,args)}};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow){result=func.apply(context,args)}return result}};fluid.freezeRecursive=function(tofreeze,segs){segs=segs||[];fluid.testStrategyRecursion("fluid.freezeRecursive",segs);if(fluid.isPlainObject(tofreeze)){fluid.each(tofreeze,(function(value,key){segs.push(key);fluid.freezeRecursive(value,segs);segs.pop()}));return Object.freeze(tofreeze)}else{return tofreeze}};fluid.marker=function(){};fluid.makeMarker=function(value,extra){var togo=Object.create(fluid.marker.prototype);togo.value=value;fluid.extend(togo,extra);return Object.freeze(togo)};fluid.NO_VALUE=fluid.makeMarker("NO_VALUE");fluid.EXPAND=fluid.makeMarker("EXPAND");fluid.isMarker=function(totest,type){if(!(totest instanceof fluid.marker)){return false}if(!type){return true}return totest.value===type.value};fluid.logLevelsSpec={FATAL:0,FAIL:5,WARN:10,IMPORTANT:12,INFO:15,TRACE:20};fluid.logLevel=fluid.transform(fluid.logLevelsSpec,(function(value,key){return fluid.makeMarker(key,{priority:value})}));var logLevelStack=[fluid.logLevel.IMPORTANT];fluid.model={};fluid.model.copyModel=function(target,source){fluid.clear(target);$.extend(true,target,source)};fluid.model.parseEL=function(EL){return EL===""?[]:String(EL).split(".")};fluid.model.composePath=function(prefix,suffix){return prefix===""?suffix:suffix===""?prefix:prefix+"."+suffix};fluid.model.composeSegments=function(){return fluid.makeArray(arguments).join(".")};fluid.lastDotIndex=function(path){return path.lastIndexOf(".")};fluid.model.getToTailPath=function(path){var lastdot=fluid.lastDotIndex(path);return lastdot===-1?"":path.substring(0,lastdot)};fluid.model.getTailPath=function(path){var lastdot=fluid.lastDotIndex(path);return path.substring(lastdot+1)};fluid.path=fluid.model.composeSegments;fluid.composePath=fluid.model.composePath;fluid.requireDataBinding=function(){fluid.fail("Please include DataBinding.js in order to operate complex model accessor configuration")};fluid.model.setWithStrategy=fluid.model.getWithStrategy=fluid.requireDataBinding;fluid.model.resolvePathSegment=function(root,segment,create,origEnv){if(!origEnv&&root.resolvePathSegment){var togo=root.resolvePathSegment(segment);if(togo!==undefined){return togo}}if(create&&root[segment]===undefined){return root[segment]={}}return root[segment]};fluid.model.parseToSegments=function(EL,parseEL,copy){return typeof EL==="number"||typeof EL==="string"?parseEL(EL):copy?fluid.makeArray(EL):EL};fluid.model.pathToSegments=function(EL,config){var parser=config&&config.parser?config.parser.parse:fluid.model.parseEL;return fluid.model.parseToSegments(EL,parser)};fluid.model.accessImpl=function(root,EL,newValue,config,initSegs,returnSegs,traverser){var segs=fluid.model.pathToSegments(EL,config);var initPos=0;if(initSegs){initPos=initSegs.length;segs=initSegs.concat(segs)}var uncess=newValue===fluid.NO_VALUE?0:1;root=traverser(root,segs,initPos,config,uncess);if(newValue===fluid.NO_VALUE){return returnSegs?{root:root,segs:segs}:root}else{root[fluid.peek(segs)]=newValue}};fluid.model.accessSimple=function(root,EL,newValue,environment,initSegs,returnSegs){return fluid.model.accessImpl(root,EL,newValue,environment,initSegs,returnSegs,fluid.model.traverseSimple)};fluid.model.traverseSimple=function(root,segs,initPos,environment,uncess){var origEnv=environment;var limit=segs.length-uncess;for(var i=0;i<limit;++i){if(!root){return undefined}var segment=segs[i];if(environment&&environment[segment]){root=environment[segment]}else{root=fluid.model.resolvePathSegment(root,segment,uncess===1,origEnv)}environment=null}return root};fluid.model.setSimple=function(root,EL,newValue,environment,initSegs){fluid.model.accessSimple(root,EL,newValue,environment,initSegs,false)};fluid.model.getSimple=function(root,EL,environment,initSegs){if(EL===null||EL===undefined||EL.length===0){return root}return fluid.model.accessSimple(root,EL,fluid.NO_VALUE,environment,initSegs,false)};fluid.getImmediate=function(root,segs,i){var limit=i===undefined?segs.length:i+1;for(var j=0;j<limit;++j){root=root?root[segs[j]]:undefined}return root};fluid.decodeAccessorArg=function(arg3){return!arg3||arg3===fluid.model.defaultGetConfig||arg3===fluid.model.defaultSetConfig?null:arg3.type==="environment"?arg3.value:undefined};fluid.set=function(root,EL,newValue,config,initSegs){var env=fluid.decodeAccessorArg(config);if(env===undefined){fluid.model.setWithStrategy(root,EL,newValue,config,initSegs)}else{fluid.model.setSimple(root,EL,newValue,env,initSegs)}};fluid.get=function(root,EL,config,initSegs){var env=fluid.decodeAccessorArg(config);return env===undefined?fluid.model.getWithStrategy(root,EL,config,initSegs):fluid.model.accessImpl(root,EL,fluid.NO_VALUE,env,null,false,fluid.model.traverseSimple)};fluid.getGlobalValue=function(path,env){if(path){env=env||fluid.environment;return fluid.get(fluid.global,path,{type:"environment",value:env})}};fluid.bind=function(obj,fnName,args){return obj[fnName].apply(obj,fluid.makeArray(args))};fluid.proxyComponentArgs=fluid.identity;fluid.invokeGlobalFunction=function(functionPath,args,environment){var func=fluid.getGlobalValue(functionPath,environment);if(!func){fluid.fail("Error invoking global function: "+functionPath+" could not be located")}else{var argsArray=fluid.isArrayable(args)?args:fluid.makeArray(args);fluid.proxyComponentArgs(argsArray);return func.apply(null,argsArray)}};fluid.registerGlobalFunction=function(functionPath,func,env){env=env||fluid.environment;fluid.set(fluid.global,functionPath,func,{type:"environment",value:env})};fluid.setGlobalValue=fluid.registerGlobalFunction;fluid.registerNamespace=function(path,env){env=env||fluid.environment;var existing=fluid.getGlobalValue(path,env);if(!existing){existing={};fluid.setGlobalValue(path,existing,env)}return existing};fluid.dumpEl=fluid.identity;fluid.renderTimestamp=fluid.identity;fluid.generateUniquePrefix=function(){return Math.floor(Math.random()*1e12).toString(36)+"-"};var fluid_prefix=fluid.generateUniquePrefix();fluid.fluidInstance=fluid_prefix;var fluid_guid=1;fluid.allocateGuid=function(){return fluid_prefix+fluid_guid++};fluid.registerNamespace("fluid.event");fluid.extremePriority=4e9;fluid.priorityTypes={first:-1,last:1,before:0,after:0};fluid.extremalPriorities={none:0,transaction:10,testing:20,authoring:30};fluid.parsePriorityConstraint=function(constraint,fixedOnly,site){var segs=constraint.split(":");var type=segs[0];var lookup=fluid.priorityTypes[type];if(lookup===undefined){fluid.fail("Invalid constraint type in priority field "+constraint+": the only supported values are "+fluid.keys(fluid.priorityTypes).join(", ")+" or numeric")}if(fixedOnly&&lookup===0){fluid.fail("Constraint type in priority field "+constraint+" is not supported in a "+site+" record - you must use either a numeric value or first, last")}return{type:segs[0],target:segs[1]}};fluid.parsePriority=function(priority,count,fixedOnly,site){priority=priority||0;var togo={count:count||0,fixed:null,constraint:null,site:site};if(typeof priority==="number"){togo.fixed=-priority}else{togo.constraint=fluid.parsePriorityConstraint(priority,fixedOnly,site)}var multiplier=togo.constraint?fluid.priorityTypes[togo.constraint.type]:0;if(multiplier!==0){var target=togo.constraint.target||"none";var extremal=fluid.extremalPriorities[target];if(extremal===undefined){fluid.fail("Unrecognised extremal priority target "+target+": the currently supported values are "+fluid.keys(fluid.extremalPriorities).join(", ")+": register your value in fluid.extremalPriorities")}togo.fixed=multiplier*(fluid.extremePriority+extremal)}if(togo.fixed!==null){togo.fixed+=togo.count/1024}return togo};fluid.renderPriority=function(parsed){return parsed.constraint?parsed.constraint.target?parsed.constraint.type+":"+parsed.constraint.target:parsed.constraint.type:Math.floor(parsed.fixed)};fluid.compareByPriority=function(recA,recB){if(recA.priority.fixed!==null&&recB.priority.fixed!==null){return recA.priority.fixed-recB.priority.fixed}else{return(recA.priority.fixed===null)-(recB.priority.fixed===null)}};fluid.honourConstraint=function(array,firstConstraint,c){var constraint=array[c].priority.constraint;var matchIndex=fluid.find(array,(function(element,index){return element.namespace===constraint.target?index:undefined}),-1);if(matchIndex===-1){return true}else if(matchIndex>=firstConstraint){return false}else{var offset=constraint.type==="after"?1:0;var target=matchIndex+offset;var temp=array[c];for(var shift=c;shift>=target;--shift){array[shift]=array[shift-1]}array[target]=temp;return true}};fluid.sortByPriority=function(array){array.sort(fluid.compareByPriority);var firstConstraint=fluid.find(array,(function(element,index){return element.priority.constraint&&fluid.priorityTypes[element.priority.constraint.type]===0?index:undefined}),array.length);while(true){if(firstConstraint===array.length){return array}var oldFirstConstraint=firstConstraint;for(var c=firstConstraint;c<array.length;++c){var applied=fluid.honourConstraint(array,firstConstraint,c);if(applied){++firstConstraint}}if(firstConstraint===oldFirstConstraint){var holders=array.slice(firstConstraint);fluid.fail("Could not find targets for any constraints in "+holders[0].priority.site+" ",holders,": none of the targets ("+fluid.getMembers(holders,"priority.constraint.target").join(", ")+") matched any namespaces of the elements in (",array.slice(0,firstConstraint),") - this is caused by either an invalid or circular reference")}}};fluid.parsePriorityRecords=function(records,name){var array=fluid.hashToArray(records,"namespace",(function(newElement,oldElement){$.extend(newElement,oldElement);newElement.priority=fluid.parsePriority(oldElement.priority,0,false,name)}));fluid.sortByPriority(array);return array};fluid.event.identifyListener=function(listener,soft){if(typeof listener!=="string"&&!listener.$$fluid_guid&&!soft){listener.$$fluid_guid=fluid.allocateGuid()}return listener.$$fluid_guid};fluid.event.impersonateListener=function(origListener,newListener){fluid.event.identifyListener(origListener);newListener.$$fluid_guid=origListener.$$fluid_guid};fluid.event.sortListeners=function(listeners){var togo=[];fluid.each(listeners,(function(oneNamespace){var headHard;for(var i=0;i<oneNamespace.length;++i){var thisListener=oneNamespace[i];if(!thisListener.softNamespace&&!headHard){headHard=thisListener}}if(headHard){togo.push(headHard)}else{togo=togo.concat(oneNamespace)}}));return fluid.sortByPriority(togo)};fluid.event.resolveListener=function(listener){var listenerName=listener.globalName||(typeof listener==="string"?listener:null);if(listenerName){var listenerFunc=fluid.getGlobalValue(listenerName);if(!listenerFunc){fluid.fail("Unable to look up name "+listenerName+" as a global function")}else{listener=listenerFunc}}return listener};fluid.nameComponent=function(that){return that?fluid.dumpComponentAndPath(that):"[unknown component]"};fluid.event.nameEvent=function(that,eventName){return eventName+" of "+fluid.nameComponent(that)};fluid.event.firer=function(){};fluid.makeEventFirer=function(options){options=options||{};var name=options.name||"<anonymous>";var that;var lazyInit=function(){that.listeners={};that.byId={};that.sortedListeners=[];that.onDestroy=null;that.addListener=function(listener,namespace,priority,softNamespace,listenerId){var record;if(that.destroyed){fluid.fail("Cannot add listener to destroyed event firer "+that.name)}if(!listener){return}if(fluid.isPlainObject(listener,true)&&!fluid.isApplicable(listener)){record=listener;listener=record.listener;namespace=record.namespace;priority=record.priority;softNamespace=record.softNamespace;listenerId=record.listenerId}if(typeof listener==="string"){listener={globalName:listener}}var id=listenerId||fluid.event.identifyListener(listener);namespace=namespace||id;record=$.extend(record||{},{namespace:namespace,listener:listener,softNamespace:softNamespace,listenerId:listenerId,priority:fluid.parsePriority(priority,that.sortedListeners.length,false,"listeners")});that.byId[id]=record;var thisListeners=that.listeners[namespace]=fluid.makeArray(that.listeners[namespace]);thisListeners[softNamespace?"push":"unshift"](record);that.sortedListeners=fluid.event.sortListeners(that.listeners)};that.addListener.apply(null,arguments)};that=Object.create(fluid.event.firer.prototype);fluid.extend(that,{eventId:fluid.allocateGuid(),name:name,ownerId:options.ownerId,typeName:"fluid.event.firer",destroy:function(){that.destroyed=true;fluid.each(that.onDestroy,(function(func){func()}))},addListener:function(){lazyInit.apply(null,arguments)},removeListener:function(listener){if(!that.listeners){return}var namespace,id,record;if(typeof listener==="string"){namespace=listener;record=that.listeners[namespace];if(!record){id=namespace;namespace=null}}else if(typeof listener==="function"){id=fluid.event.identifyListener(listener,true);if(!id){fluid.fail("Cannot remove unregistered listener function ",listener," from event "+that.name)}}var rec=that.byId[id];var softNamespace=rec&&rec.softNamespace;namespace=namespace||rec&&rec.namespace||id;delete that.byId[id];record=that.listeners[namespace];if(record){if(softNamespace){fluid.remove_if(record,(function(thisLis){return thisLis.listener.$$fluid_guid===id||thisLis.listenerId===id}))}else{record.shift()}if(record.length===0){delete that.listeners[namespace]}}that.sortedListeners=fluid.event.sortListeners(that.listeners)},fire:function(){var listeners=that.sortedListeners;if(options.promise){that.promisePayload=arguments[0]}if(!listeners||that.destroyed){return}for(var i=0;i<listeners.length;++i){var lisrec=listeners[i];if(typeof lisrec.listener!=="function"){lisrec.listener=fluid.event.resolveListener(lisrec.listener)}var listener=lisrec.listener;var ret=listener.apply(null,arguments);var value;if(options.preventable&&ret===false||that.destroyed){value=false}if(value!==undefined){return value}}}});if(options.promise){that.then=function(func){if("promisePayload"in that){func(that.promisePayload)}else{that.addListener(func)}}}return that};fluid.event.addPrimitiveListener=function(holder,name,func){var existing=holder[name];if(!existing){existing=holder[name]=[]}existing.push(func)};fluid.fireEvent=function(component,eventName,args){var firer=component.events&&component.events[eventName];if(firer){firer.fire.apply(null,fluid.makeArray(args))}};fluid.event.addListenerToFirer=function(firer,value,namespace,wrapper){wrapper=wrapper||fluid.identity;if(fluid.isArrayable(value)){for(var i=0;i<value.length;++i){fluid.event.addListenerToFirer(firer,value[i],namespace,wrapper)}}else if(typeof value==="function"||typeof value==="string"){wrapper(firer).addListener(value,namespace)}else if(value&&typeof value==="object"){wrapper(firer).addListener(value.listener,namespace||value.namespace,value.priority,value.softNamespace,value.listenerId)}};fluid.event.resolveListenerRecord=function(records){return{records:records}};fluid.expandImmediate=function(material){fluid.fail("fluid.expandImmediate could not be loaded - please include FluidIoC.js in order to operate IoC-driven event with descriptor "+material)};fluid.mergeListeners=function(that,events,listeners){fluid.each(listeners,(function(value,key){var firer,namespace;if(fluid.isIoCReference(key)){firer=fluid.expandImmediate(key,that);if(!firer){fluid.fail("Error in listener record: key "+key+' could not be looked up to an event firer - did you miss out "events." when referring to an event firer?')}}else{var keydot=key.indexOf(".");if(keydot!==-1){namespace=key.substring(keydot+1);key=key.substring(0,keydot)}if(!events[key]){fluid.fail("Listener registered for event "+key+" which is not defined for this component")}firer=events[key]}var record=fluid.event.resolveListenerRecord(value,that,key,namespace,true);fluid.event.addListenerToFirer(firer,record.records,namespace,record.adderWrapper)}))};fluid.eventFromRecord=function(eventSpec,eventKey,that){var isIoCEvent=eventSpec&&(typeof eventSpec!=="string"||fluid.isIoCReference(eventSpec));var event;if(isIoCEvent){if(!fluid.event.resolveEvent){fluid.fail("fluid.event.resolveEvent could not be loaded - please include FluidIoC.js in order to operate IoC-driven event with descriptor ",eventSpec)}else{event=fluid.event.resolveEvent(that,eventKey,eventSpec)}}else{event=fluid.makeEventFirer({name:fluid.event.nameEvent(that,eventKey),preventable:eventSpec==="preventable",promise:eventSpec==="promise",ownerId:that.id})}return event};fluid.mergeListenerPolicy=function(target,source,key){if(typeof key!=="string"){fluid.fail("Error in listeners declaration - the keys in this structure must resolve to event names - got "+key+" from ",source)}var hasNamespace=!fluid.isIoCReference(key)&&key.indexOf(".")!==-1;return hasNamespace?source||target:fluid.arrayConcatPolicy(target,source)};fluid.makeMergeListenersPolicy=function(merger,modelRelay){return function(target,source){target=target||{};if(modelRelay&&(fluid.isArrayable(source)||"target"in source&&(typeof source.target==="string"||source.target.segs))){target[""]=merger(target[""],source,"")}else{fluid.each(source,(function(listeners,key){target[key]=merger(target[key],listeners,key)}))}return target}};fluid.validateListenersImplemented=function(that){var errors=[];fluid.each(that.events,(function(event,name){fluid.each(event.sortedListeners,(function(lisrec){if(lisrec.listener===fluid.notImplemented||lisrec.listener.globalName==="fluid.notImplemented"){errors.push({name:name,namespace:lisrec.namespace,componentSource:fluid.model.getSimple(that.options.listeners,[name+"."+lisrec.namespace,0,"componentSource"])})}}))}));return errors};fluid.arrayConcatPolicy=function(target,source){return fluid.makeArray(target).concat(fluid.makeArray(source))};fluid.loggingEvent=fluid.makeEventFirer({name:"logging event"});fluid.addTimestampArg=function(args){var arg0=fluid.renderTimestamp(new Date)+":  ";args.unshift(arg0)};fluid.loggingEvent.addListener(fluid.doBrowserLog,"log");fluid.loggingEvent.addListener(fluid.identity,"filterArgs","before:log");fluid.loggingEvent.addListener(fluid.addTimestampArg,"addTimestampArg","after:filterArgs");fluid.upgradeError=function(originError,whileMsg){var error=originError instanceof Error?originError:fluid.isPrimitive(originError)?{message:originError}:fluid.extend({},originError);error.message=error.message+whileMsg;return error};fluid.failureEvent=fluid.makeEventFirer({name:"failure event"});fluid.failureEvent.addListener(fluid.builtinFail,"fail");fluid.failureEvent.addListener(fluid.logFailure,"log","before:fail");fluid.componentConstructor=function(){};Object.defineProperty(fluid.componentConstructor,"name",{value:"fluid.componentConstructor"});fluid.typeTag=function(type,id){var that=Object.create(fluid.componentConstructor.prototype);that.typeName=type;that.id=id||fluid.allocateGuid();return that};var gradeTick=1;var gradeTickStore={};fluid.defaultsStore={};fluid.flattenGradeName=function(gradeName){return typeof gradeName==="string"?gradeName:JSON.stringify(gradeName)};fluid.resolveGradesImpl=function(gs,gradeNames){gradeNames=fluid.makeArray(gradeNames);for(var i=gradeNames.length-1;i>=0;--i){var gradeName=gradeNames[i];var flatGradeName=fluid.flattenGradeName(gradeName);if(gradeName&&!gs.gradeHash[flatGradeName]){var isDynamic=fluid.isReferenceOrExpander(gradeName);var options=(isDynamic?null:fluid.rawDefaults(gradeName))||{};var thisTick=gradeTickStore[gradeName]||gradeTick-1;gs.lastTick=Math.max(gs.lastTick,thisTick);gs.gradeHash[flatGradeName]=true;gs.gradeChain.push(gradeName);var oGradeNames=fluid.makeArray(options.gradeNames);for(var j=oGradeNames.length-1;j>=0;--j){fluid.resolveGradesImpl(gs,oGradeNames[j])}}}return gs};fluid.resolveGradeStructure=function(defaultName,gradeNames){var gradeStruct={lastTick:0,gradeChain:[],gradeHash:{}};fluid.resolveGradesImpl(gradeStruct,[defaultName].concat(fluid.makeArray(gradeNames)));gradeStruct.gradeChain.reverse();return gradeStruct};fluid.hasGrade=function(options,gradeName){return!options||!options.gradeNames?false:options.gradeNames.includes(gradeName)};fluid.resolveGrade=function(defaults,defaultName,gradeNames){var gradeStruct=fluid.resolveGradeStructure(defaultName,gradeNames);var mergeArgs=fluid.transform(gradeStruct.gradeChain,fluid.rawDefaults,fluid.copy);fluid.remove_if(mergeArgs,(function(options){return!options}));var mergePolicy={};for(var i=0;i<mergeArgs.length;++i){if(mergeArgs[i]&&mergeArgs[i].mergePolicy){mergePolicy=$.extend(true,mergePolicy,mergeArgs[i].mergePolicy)}}mergeArgs=[mergePolicy,{}].concat(mergeArgs);var mergedDefaults=fluid.merge.apply(null,mergeArgs);mergedDefaults.gradeNames=gradeStruct.gradeChain;fluid.freezeRecursive(mergedDefaults);return{defaults:mergedDefaults,lastTick:gradeStruct.lastTick}};fluid.mergedDefaultsCache={};fluid.gradeNamesToKey=function(defaultName,gradeNames){return defaultName+"|"+gradeNames.join("|")};fluid.getMergedDefaults=function(defaultName,gradeNames){gradeNames=fluid.makeArray(gradeNames);var key=fluid.gradeNamesToKey(defaultName,gradeNames);var mergedDefaults=fluid.mergedDefaultsCache[key];if(mergedDefaults){var lastTick=0;var searchGrades=mergedDefaults.defaults.gradeNames;for(var i=0;i<searchGrades.length;++i){lastTick=Math.max(lastTick,gradeTickStore[searchGrades[i]]||0)}if(lastTick>mergedDefaults.lastTick){if(fluid.passLogLevel(fluid.logLevel.TRACE)){fluid.log(fluid.logLevel.TRACE,"Clearing cache for component "+defaultName+" with gradeNames ",searchGrades)}mergedDefaults=null}}if(!mergedDefaults){var defaults=fluid.rawDefaults(defaultName);if(!defaults){return defaults}mergedDefaults=fluid.mergedDefaultsCache[key]=fluid.resolveGrade(defaults,defaultName,gradeNames)}return mergedDefaults.defaults};fluid.NO_ARGUMENTS=fluid.makeMarker("NO_ARGUMENTS");fluid.upgradePrimitiveFunc=function(rec,key){if(rec&&fluid.isPrimitive(rec)){var togo={};togo[key||(typeof rec==="string"&&rec.charAt(0)!=="{"?"funcName":"func")]=rec;togo.args=fluid.NO_ARGUMENTS;return togo}else{return rec}};fluid.annotateListeners=function(componentName,options){options.listeners=fluid.transform(options.listeners,(function(record){var togo=fluid.makeArray(record);return fluid.transform(togo,(function(onerec){onerec=fluid.upgradePrimitiveFunc(onerec,"listener");onerec.componentSource=componentName;return onerec}))}));options.invokers=fluid.transform(options.invokers,(function(record){record=fluid.upgradePrimitiveFunc(record);if(record){record.componentSource=componentName}return record}))};fluid.workflowCache={};fluid.workflowCacheSorted=[];fluid.resortWorkflows=function(workflowType,baseIndex){var thisCache=fluid.workflowCache[workflowType];var parsed=fluid.parsePriorityRecords(thisCache,workflowType+" workflows");parsed.forEach((function(oneParsed,index){thisCache[oneParsed.namespace].index=index+baseIndex}));return parsed};fluid.indexOneWorkflows=function(gradeName,workflowType,workflows,baseIndex){fluid.each(workflows,(function(oneWorkflow,workflowKey){fluid.model.setSimple(fluid.workflowCache,[workflowType,workflowKey],{workflowType:workflowType,workflowName:workflowKey,priority:oneWorkflow.priority,gradeName:gradeName,workflowOptions:oneWorkflow})}));return fluid.resortWorkflows(workflowType,baseIndex)};fluid.clearGradeWorkflows=function(gradeName,workflowType){var cacheForType=fluid.workflowCache[workflowType];fluid.each(cacheForType,(function(oneWorkflow,workflowKey){if(oneWorkflow.gradeName===gradeName){delete cacheForType[workflowKey]}}))};fluid.indexGradeWorkflows=function(gradeName,options){fluid.clearGradeWorkflows(gradeName,"global");fluid.clearGradeWorkflows(gradeName,"local");var sortedGlobal=fluid.indexOneWorkflows(gradeName,"global",fluid.getImmediate(options,["workflows","global"]),0);var globalWorkflowCount=sortedGlobal.length;var sortedLocal=fluid.indexOneWorkflows(gradeName,"local",fluid.getImmediate(options,["workflows","local"]),globalWorkflowCount);fluid.workflowCacheSorted=sortedGlobal.concat(sortedLocal)};fluid.rawDefaults=function(componentName){var entry=fluid.defaultsStore[componentName];return entry&&entry.options};fluid.registerRawDefaults=function(componentName,options){fluid.pushActivity("registerRawDefaults","registering defaults for grade %componentName with options %options",{componentName:componentName,options:options});var optionsCopy=fluid.expandCompact?fluid.expandCompact(options):fluid.copy(options);fluid.annotateListeners(componentName,optionsCopy);fluid.indexGradeWorkflows(componentName,optionsCopy);delete optionsCopy.workflows;var callerInfo=fluid.getCallerInfo&&fluid.getCallerInfo(6);fluid.freezeRecursive(optionsCopy);fluid.defaultsStore[componentName]={options:optionsCopy,callerInfo:callerInfo};gradeTickStore[componentName]=gradeTick++;fluid.popActivity()};fluid.doIndexDefaults=function(defaultName,defaults,index,indexSpec){var requiredGrades=fluid.makeArray(indexSpec.gradeNames);for(var i=0;i<requiredGrades.length;++i){if(!fluid.hasGrade(defaults,requiredGrades[i])){return}}var indexFunc=typeof indexSpec.indexFunc==="function"?indexSpec.indexFunc:fluid.getGlobalValue(indexSpec.indexFunc);var keys=indexFunc(defaults)||[];for(var j=0;j<keys.length;++j){fluid.pushArray(index,keys[j],defaultName)}};fluid.indexDefaults=function(indexName,indexSpec){var index={};for(var defaultName in fluid.defaultsStore){var defaults=fluid.getMergedDefaults(defaultName);fluid.doIndexDefaults(defaultName,defaults,index,indexSpec)}return index};fluid.defaults=function(componentName,options){if(options===undefined){return fluid.getMergedDefaults(componentName)}else{if(options&&options.options){fluid.fail("Probable error in options structure for "+componentName+' with option named "options" - perhaps you meant to write these options at top level in fluid.defaults? - ',options)}fluid.registerRawDefaults(componentName,options);var gradedDefaults=fluid.getMergedDefaults(componentName);if(!fluid.hasGrade(gradedDefaults,"fluid.function")){fluid.makeComponentCreator(componentName)}}};fluid.validateCreatorGrade=function(message,componentName){var defaults=fluid.getMergedDefaults(componentName);if(!defaults||!defaults.gradeNames||defaults.gradeNames.length===0){fluid.fail(message+" type "+componentName+" which does not have any gradeNames defined")}else if(!defaults.argumentMap){var blankGrades=[];for(var i=0;i<defaults.gradeNames.length;++i){var gradeName=defaults.gradeNames[i];var rawDefaults=fluid.rawDefaults(gradeName);if(!rawDefaults){blankGrades.push(gradeName)}}if(blankGrades.length===0){fluid.fail(message+" type "+componentName+" which is not derived from fluid.component")}else{fluid.fail("The grade hierarchy of component with type "+componentName+" is incomplete - it inherits from the following grade(s): "+blankGrades.join(", ")+" for which the grade definitions are corrupt or missing. Please check the files which might include these "+"grades and ensure they are readable and have been loaded by this instance of Infusion")}}};fluid.makeComponentCreator=function(componentName){var creator=function(){fluid.validateCreatorGrade("Cannot make component creator for",componentName);return fluid.initFreeComponent(componentName,arguments)};var existing=fluid.getGlobalValue(componentName);if(existing){$.extend(creator,existing)}fluid.setGlobalValue(componentName,creator)};fluid.emptyPolicy=fluid.freezeRecursive({});fluid.derefMergePolicy=function(policy){return(policy?policy["*"]:fluid.emptyPolicy)||fluid.emptyPolicy};fluid.compileMergePolicy=function(mergePolicy){var builtins={},defaultValues={};var togo={builtins:builtins,defaultValues:defaultValues};if(!mergePolicy){return togo}fluid.each(mergePolicy,(function(value,key){var parsed={},builtin=true;if(typeof value==="function"){parsed.func=value}else if(typeof value==="object"){parsed=value}else if(!fluid.isDefaultValueMergePolicy(value)){var split=value.split(/\s*,\s*/);for(var i=0;i<split.length;++i){parsed[split[i]]=true}}else{fluid.set(defaultValues,key,"{that}.options."+value);togo.hasDefaults=true;builtin=false}if(builtin){fluid.set(builtins,fluid.composePath(key,"*"),parsed)}}));return togo};fluid.isDefaultValueMergePolicy=function(policy){return typeof policy==="string"&&(policy.indexOf(",")===-1&&!/replace|nomerge|noexpand/.test(policy))};fluid.mergeOneImpl=function(thisTarget,thisSource,j,sources,newPolicy,newPolicyHolder,i,segs){var togo=thisTarget;var primitiveTarget=fluid.isPrimitive(thisTarget);if(thisSource!==undefined){if(!newPolicy.func&&thisSource!==null&&fluid.isPlainObject(thisSource)&&!newPolicy.nomerge){if(primitiveTarget){togo=thisTarget=fluid.freshContainer(thisSource)}}else{sources[j]=undefined;if(newPolicy.func){togo=newPolicy.func.call(null,thisTarget,thisSource,newPolicyHolder,segs,i)}else{togo=thisSource}}}return togo};fluid.regenerateCursor=function(source,segs,limit,sourceStrategy){for(var i=0;i<limit;++i){source=sourceStrategy(source,segs[i],i,fluid.makeArray(segs))}return source};fluid.regenerateSources=function(sources,segs,limit,sourceStrategies){var togo=[];for(var i=0;i<sources.length;++i){var thisSource=fluid.regenerateCursor(sources[i],segs,limit,sourceStrategies[i]);togo.push(thisSource)}return togo};fluid.fetchMergeChildren=function(target,i,segs,sources,mergePolicy,options){var thisPolicy=fluid.derefMergePolicy(mergePolicy);for(var j=sources.length-1;j>=0;--j){var source=sources[j];if(source!==undefined){fluid.each(source,(function(newSource,name){var childPolicy=fluid.concreteTrundler(mergePolicy,name);if(!(name in target)||options.evaluateFully&&childPolicy===undefined&&!fluid.isPrimitive(target[name])){segs[i]=name;options.strategy(target,name,i+1,segs,sources,mergePolicy)}}));if(thisPolicy.replace){break}}}return target};fluid.inEvaluationMarker=Object.freeze({__CURRENTLY_IN_EVALUATION__:true});fluid.strategyRecursionBailout=50;fluid.makeMergeStrategy=function(options){var strategy=function(target,name,i,segs,sources,policy){if(i>fluid.strategyRecursionBailout){fluid.fail("Overflow/circularity in options merging, current path is ",segs," at depth ",i,' - please protect components from merging using the "nomerge" merge policy')}if(fluid.isPrimitive(target)){return undefined}if(fluid.isTracing){fluid.tracing.pathCount.push(fluid.path(segs.slice(0,i)))}var oldTarget;if(name in target||options.fullyEvaluated){oldTarget=target[name];if(!options.evaluateFully){return oldTarget}}if(sources===undefined){segs=fluid.makeArray(segs);sources=fluid.regenerateSources(options.sources,segs,i-1,options.sourceStrategies);policy=fluid.regenerateCursor(options.mergePolicy,segs,i-1,fluid.concreteTrundler)}var newPolicyHolder=fluid.concreteTrundler(policy,name);var newPolicy=fluid.derefMergePolicy(newPolicyHolder);var start,limit,mul;if(newPolicy.replace){start=1-sources.length;limit=0;mul=-1}else{start=0;limit=sources.length-1;mul=+1}var newSources=[];var thisTarget;for(var j=start;j<=limit;++j){var k=mul*j;var thisSource=options.sourceStrategies[k](sources[k],name,i,segs);if(thisSource!==undefined){if(!fluid.isPrimitive(thisSource)){newSources[k]=thisSource}if(oldTarget===undefined){if(mul===-1){thisTarget=target[name]=thisSource;break}else{thisTarget=fluid.mergeOneImpl(thisTarget,thisSource,j,newSources,newPolicy,newPolicyHolder,i,segs,options);target[name]=thisTarget}}}}if(oldTarget!==undefined){thisTarget=oldTarget}if(newSources.length>0){if(fluid.isPlainObject(thisTarget)){fluid.fetchMergeChildren(thisTarget,i,segs,newSources,newPolicyHolder,options)}}return thisTarget};options.strategy=strategy;return strategy};fluid.driveStrategy=function(root,pathSegs,strategy){pathSegs=fluid.makeArray(pathSegs);for(var i=0;i<pathSegs.length;++i){if(!root){return undefined}root=strategy(root,pathSegs[i],i+1,pathSegs)}return root};fluid.concreteTrundler=function(source,seg){return!source?undefined:source[seg]};fluid.merge=function(policy,...sources){var compiled=fluid.compileMergePolicy(policy).builtins;var options=fluid.makeMergeOptions(compiled,sources,{});options.initter();return options.target};fluid.makeMergeOptions=function(policy,sources,userOptions){var options={mergePolicy:policy,sources:sources};options=$.extend(options,userOptions);options.target=options.target||fluid.freshContainer(options.sources[0]);options.sourceStrategies=options.sourceStrategies||fluid.generate(options.sources.length,fluid.concreteTrundler);options.initter=function(){options.evaluateFully=true;fluid.fetchMergeChildren(options.target,0,[],options.sources,options.mergePolicy,options);options.fullyEvaluated=true};fluid.makeMergeStrategy(options);return options};fluid.transformOptions=function(options,transRec){fluid.expect("Options transformation record",transRec,["transformer","config"]);var transFunc=fluid.getGlobalValue(transRec.transformer);return transFunc.call(null,options,transRec.config)};fluid.findMergeBlocks=function(mergeBlocks,recordType){return fluid.remove_if(fluid.makeArray(mergeBlocks),(function(block){return block.recordType!==recordType}))};fluid.transformOptionsBlocks=function(mergeBlocks,transformOptions,recordTypes){fluid.each(recordTypes,(function(recordType){var blocks=fluid.findMergeBlocks(mergeBlocks,recordType);fluid.each(blocks,(function(block){var source=block.source?"source":"target";block[block.simple||source==="target"?"target":"source"]=fluid.transformOptions(block[source],transformOptions)}))}))};fluid.dedupeDistributionNamespaces=function(mergeBlocks){var byNamespace={};fluid.remove_if(mergeBlocks,(function(mergeBlock){var ns=mergeBlock.namespace;if(ns){if(byNamespace[ns]&&byNamespace[ns]!==mergeBlock.contextThat.id){return true}else{byNamespace[ns]=mergeBlock.contextThat.id}}}))};fluid.mergeRecordTypes={defaults:1e3,defaultValueMerge:900,lensedComponents:800,subcomponentRecord:700,user:600,distribution:100};fluid.model.applyChangeRequest=function(model,request){var segs=request.segs;if(segs.length===0){if(request.type==="ADD"){$.extend(true,model,request.value)}else{fluid.clear(model)}}else if(request.type==="ADD"){fluid.model.setSimple(model,request.segs,request.value)}else{for(var i=0;i<segs.length-1;++i){model=model[segs[i]];if(!model){return}}var last=fluid.peek(segs);delete model[last]}};fluid.destroyValue=function(target,segs){if(target){fluid.model.applyChangeRequest(target,{type:"DELETE",segs:segs})}};fluid.mergeComponentOptions=function(that,potentia,lightMerge){fluid.validateCreatorGrade("Cannot construct component of",lightMerge.type);var sharedMergePolicy={};var mergeBlocks=fluid.expandComponentOptions(sharedMergePolicy,potentia,lightMerge,that);var options={};var sourceStrategies=[],sources=[];var baseMergeOptions={target:options,sourceStrategies:sourceStrategies};var updateBlocks=function(){fluid.each(mergeBlocks,(function(block){if(fluid.isPrimitive(block.priority)){block.priority=fluid.parsePriority(block.priority,0,false,block.recordType)}}));fluid.sortByPriority(mergeBlocks);fluid.dedupeDistributionNamespaces(mergeBlocks);sourceStrategies.length=0;sources.length=0;fluid.each(mergeBlocks,(function(block){sourceStrategies.push(block.strategy);sources.push(block.target)}))};updateBlocks();var mergeOptions=fluid.makeMergeOptions(sharedMergePolicy,sources,baseMergeOptions);mergeOptions.mergeBlocks=mergeBlocks;mergeOptions.updateBlocks=updateBlocks;mergeOptions.destroyValue=function(segs){for(var i=0;i<mergeBlocks.length;++i){if(!mergeBlocks[i].immutableTarget){fluid.destroyValue(mergeBlocks[i].target,segs)}}fluid.destroyValue(baseMergeOptions.target,segs)};var compiledPolicy;var mergePolicy;function computeMergePolicy(){mergePolicy=fluid.driveStrategy(options,"mergePolicy",mergeOptions.strategy);mergePolicy=$.extend({},fluid.rootMergePolicy,mergePolicy);compiledPolicy=fluid.compileMergePolicy(mergePolicy);$.extend(true,sharedMergePolicy,compiledPolicy.builtins)}computeMergePolicy();mergeOptions.computeMergePolicy=computeMergePolicy;if(compiledPolicy.hasDefaults){mergeBlocks.push(fluid.generateExpandBlock({options:compiledPolicy.defaultValues,recordType:"defaultValueMerge",priority:fluid.mergeRecordTypes.defaultValueMerge},that,{}));updateBlocks()}that.options=options;fluid.driveStrategy(options,"gradeNames",mergeOptions.strategy);fluid.deliverOptionsStrategy(that,options,mergeOptions);fluid.computeComponentAccessor(that,potentia.localRecord);var transformOptions=fluid.driveStrategy(options,"transformOptions",mergeOptions.strategy);if(transformOptions){fluid.transformOptionsBlocks(mergeBlocks,transformOptions,["user","subcomponentRecord"]);updateBlocks()}if(!baseMergeOptions.target.mergePolicy){computeMergePolicy()}return mergeOptions};fluid.defaults("fluid.function",{});fluid.invokeGradedFunction=function(name,spec){var defaults=fluid.defaults(name);if(!defaults||!defaults.argumentMap||!fluid.hasGrade(defaults,"fluid.function")){fluid.fail("Cannot look up name "+name+" to a function with registered argumentMap - got defaults ",defaults)}var args=[];fluid.each(defaults.argumentMap,(function(value,key){args[value]=spec[key]}));return fluid.invokeGlobalFunction(name,args)};fluid.noNamespaceDistributionPrefix="no-namespace-distribution-";fluid.mergeOneDistribution=function(target,source,key){var namespace=source.namespace||key||fluid.noNamespaceDistributionPrefix+fluid.allocateGuid();source.namespace=namespace;target[namespace]=$.extend(true,{},target[namespace],source)};fluid.distributeOptionsPolicy=function(target,source){target=target||{};if(fluid.isArrayable(source)){for(var i=0;i<source.length;++i){fluid.mergeOneDistribution(target,source[i])}}else if(typeof source.target==="string"){fluid.mergeOneDistribution(target,source)}else{fluid.each(source,(function(oneSource,key){fluid.mergeOneDistribution(target,oneSource,key)}))}return target};fluid.mergingArray=function(){};fluid.mergingArray.prototype=[];fluid.deferringMergePolicy=function(target,source,mergePolicyHolder){target=target||{};fluid.each(source,(function(oneSource,key){if(!target[key]){target[key]=new fluid.mergingArray}if(fluid.derefMergePolicy(mergePolicyHolder[key]).replace&&oneSource!==undefined){target[key].length=0}if(oneSource instanceof fluid.mergingArray){target[key].push.apply(target[key],oneSource)}else if(oneSource!==undefined){target[key].push(oneSource)}}));return target};fluid.invokerStrategies=fluid.arrayToHash(["func","funcName","listener","this","method","changePath","value"]);fluid.invokersMergePolicy=function(target,source){target=target||{};fluid.each(source,(function(oneInvoker,name){if(!oneInvoker){target[name]=oneInvoker;return}else{oneInvoker=fluid.upgradePrimitiveFunc(oneInvoker)}var oneT=target[name];if(!oneT){oneT=target[name]={}}for(var key in fluid.invokerStrategies){if(key in oneInvoker){for(var key2 in fluid.invokerStrategies){oneT[key2]=undefined}}}$.extend(oneT,oneInvoker)}));return target};fluid.rootMergePolicy=fluid.freezeRecursive({gradeNames:fluid.arrayConcatPolicy,distributeOptions:fluid.distributeOptionsPolicy,members:{noexpand:true,func:fluid.deferringMergePolicy},invokers:{noexpand:true,func:fluid.invokersMergePolicy},components:{noexpand:true,func:fluid.deferringMergePolicy},dynamicComponents:{noexpand:true,func:fluid.deferringMergePolicy},transformOptions:"replace",listeners:fluid.makeMergeListenersPolicy(fluid.mergeListenerPolicy)});fluid.defaults("fluid.component",{mergePolicy:fluid.rootMergePolicy,argumentMap:{options:0},workflows:{local:{concludeComponentObservation:{funcName:"fluid.concludeComponentObservation",priority:"first"},concludeComponentInit:{funcName:"fluid.concludeComponentInit",waitIO:true,priority:"last"}}},events:{onCreate:"promise",onDestroy:"promise",afterDestroy:"promise"}});fluid.computeNickName=function(typeName){var segs=fluid.model.parseEL(typeName);return fluid.peek(segs)};fluid.isDestroyed=function(that,strict){return that.lifecycleStatus==="destroyed"||!strict&&that.lifecycleStatus==="destroying"};fluid.computeGlobalMemberName=function(type,id){var nickName=fluid.computeNickName(type);return nickName+"-"+id};fluid.adaptTransactionFailure=function(transRec){var returned=false;transRec.promise.then(null,(function(e){if(!returned){throw e}else{if(transRec.promise.onReject.length===0){fluid.fireUnhandledRejection(transRec.promise,e)}}}));returned=true};fluid.initFreeComponent=function(type,initArgs){var id=fluid.allocateGuid();var path=[fluid.computeGlobalMemberName(type,id)];var userRecord={recordType:"user",type:type};var upDefaults=fluid.defaults(type);var argMap=fluid.defaults(upDefaults.argumentMap.container!==undefined?"fluid.viewComponent":"fluid.component").argumentMap;fluid.each(argMap,(function(index,name){var arg=initArgs[index];userRecord[name]=name==="options"?fluid.expandCompact(arg,true):arg}));var potentia={type:"create",path:path,componentId:id,records:[userRecord]};var transRec=fluid.registerPotentia(potentia);var shadow=fluid.commitPotentiae(transRec.transactionId);fluid.adaptTransactionFailure(transRec);return shadow&&shadow.that};var charStart="(?:[\\w\\u00c0-\\uFFFF*_-";fluid.simpleCSSMatcher={regexp:new RegExp("([#.]?)("+charStart+"]|\\\\.)+)","g"),charToTag:{"":"tag","#":"id",".":"clazz"}};fluid.IoCSSMatcher={regexp:new RegExp("([&#]?)("+charStart+"]|\\.|\\/)+)","g"),charToTag:{"":"context","&":"context","#":"id"}};var childSeg=new RegExp("\\s*(>)?\\s*","g");fluid.parseSelector=function(selstring,strategy){var togo=[];selstring=selstring.trim();var regexp=strategy.regexp;regexp.lastIndex=0;var lastIndex=0;while(true){var atNode=[];var first=true;while(true){var segMatch=regexp.exec(selstring);if(!segMatch){break}if(segMatch.index!==lastIndex){if(first){fluid.fail("Error in selector string - cannot match child selector expression starting at "+selstring.substring(lastIndex))}else{break}}var thisNode={};var text=segMatch[2];var targetTag=strategy.charToTag[segMatch[1]];if(targetTag){thisNode[targetTag]=text}atNode[atNode.length]=thisNode;lastIndex=regexp.lastIndex;first=false}childSeg.lastIndex=lastIndex;var fullAtNode={predList:atNode};var childMatch=childSeg.exec(selstring);if(!childMatch||childMatch.index!==lastIndex){fluid.fail("Error in selector string - can not match child selector expression at "+selstring.substring(lastIndex))}if(childMatch[1]===">"){fullAtNode.child=true}togo[togo.length]=fullAtNode;if(childSeg.lastIndex>=selstring.length){break}lastIndex=childSeg.lastIndex;regexp.lastIndex=childSeg.lastIndex}return togo};fluid.flattenObjectPaths=function(originalObject){var flattenedObject={};fluid.each(originalObject,(function(value,key){if(value!==null&&typeof value==="object"){var flattenedSubObject=fluid.flattenObjectPaths(value);fluid.each(flattenedSubObject,(function(subValue,subKey){flattenedObject[key+"."+subKey]=subValue}));if(typeof fluid.get(value,"toString")==="function"){flattenedObject[key]=value.toString()}}else{flattenedObject[key]=value}}));return flattenedObject};fluid.stringTemplate=function(template,values){var flattenedValues=fluid.flattenObjectPaths(values);var keys=fluid.keys(flattenedValues);keys=keys.sort(fluid.compareStringLength());for(var i=0;i<keys.length;++i){var key=keys[i];var templatePlaceholder="%"+key;var replacementValue=flattenedValues[key];var indexOfPlaceHolder=-1;while((indexOfPlaceHolder=template.indexOf(templatePlaceholder))!==-1){template=template.slice(0,indexOfPlaceHolder)+replacementValue+template.slice(indexOfPlaceHolder+templatePlaceholder.length)}}return template};
/*!
 Copyright 2011 unscriptable.com / John Hann
 Copyright The Infusion copyright holders
 See the AUTHORS.md file at the top-level directory of this distribution and at
 https://github.com/fluid-project/infusion/raw/main/AUTHORS.md.

 License MIT
*/
"use strict";fluid.promise=function(){var that={onResolve:[],onReject:[],onCancel:[]};that.then=function(onResolve,onReject,onCancel){fluid.promise.pushHandler(that,onResolve,"onResolve","resolve");fluid.promise.pushHandler(that,onReject,"onReject","reject");fluid.promise.pushHandler(that,onCancel,"onCancel","cancel");return that};that.resolve=function(value){if(that.disposition){if(that.disposition!=="cancel"){fluid.fail("Error: resolving promise ",that,' which has already received "'+that.disposition+'"')}}else{that.complete("resolve",that.onResolve,value)}return that};that.reject=function(reason){if(that.disposition){if(that.disposition!=="cancel"){fluid.fail("Error: rejecting promise ",that,'which has already received "'+that.disposition+'"')}}else{if(that.onReject.length===0){fluid.armUnhandledRejection(that,reason)}that.complete("reject",that.onReject,reason)}return that};that.cancel=function(reason){if(!that.disposition){that.complete("cancel",that.onCancel,reason)}};that.complete=function(which,queue,arg){that.disposition=which;that.value=arg;for(var i=0;i<queue.length;++i){queue[i](arg)}delete that.onResolve;delete that.onReject;delete that.onCancel};return that};fluid.promise.pushHandler=function(promise,handler,eventName,disposition){if(handler){if(promise.disposition){if(promise.disposition===disposition){handler(promise.value);promise.directHandle=disposition}}else{promise[eventName].push(handler)}}};fluid.armUnhandledRejection=function(promise,reason){fluid.invokeLater((function(){if(promise.directHandle!=="reject"){fluid.fireUnhandledRejection(promise,reason)}}))};fluid.fireUnhandledRejection=function(promise,reason){fluid.unhandledRejectionEvent.fire(reason,promise)};fluid.unhandledRejectionEvent=fluid.makeEventFirer({name:"Global unhandled rejection handler"});fluid.logUnhandledRejection=function(reason){fluid.log(fluid.logLevel.WARN,"Unhandled promise rejection: ",reason)};fluid.unhandledRejectionEvent.addListener(fluid.logUnhandledRejection,"log");fluid.isPromise=function(totest){return totest&&typeof totest.then==="function"};fluid.toPromise=function(promiseOrValue){if(fluid.isPromise(promiseOrValue)){return promiseOrValue}else{var togo=fluid.promise();togo.resolve(promiseOrValue);return togo}};fluid.promise.follow=function(source,target){source.then(target.resolve,target.reject);target.then(null,null,source.cancel)};fluid.promise.map=function(source,func){var promise=fluid.toPromise(source);var togo=fluid.promise();promise.then((function(value){var mapped=func(value);if(fluid.isPromise(mapped)){fluid.promise.follow(mapped,togo)}else{togo.resolve(mapped)}}),(function(error){togo.reject(error)}));return togo};fluid.promise.makeSequencer=function(sources,options,strategy){if(!fluid.isArrayable(sources)){fluid.fail("fluid.promise sequence algorithms must be supplied an array as source")}var sequencer={sources:sources,resolvedSources:[],index:0,strategy:strategy,options:options,returns:[],sequenceStarted:false,sequenceCancelled:false,promise:fluid.promise()};sequencer.promise.then(null,null,(function(){fluid.promise.cancelSequencer(sequencer)}));sequencer.promise.sequencer=sequencer;return sequencer};fluid.promise.cancelSequencer=function(sequencer){sequencer.sequenceCancelled=true;sequencer.resolvedSources.forEach((function(source){if(fluid.isPromise(source)){source.cancel()}}))};fluid.promise.progressSequence=function(that,retValue){that.returns.push(retValue);that.index++;fluid.promise.resumeSequence(that)};fluid.promise.processSequenceReject=function(that,error){for(var i=that.index-1;i>=0;--i){var resolved=that.resolvedSources[i];var accumulator=fluid.isPromise(resolved)&&typeof resolved.accumulateRejectionReason==="function"?resolved.accumulateRejectionReason:fluid.identity;error=accumulator(error)}that.promise.reject(error)};fluid.promise.resumeSequence=function(that){that.sequenceStarted=true;if(that.sequenceCancelled){return}else if(that.index===that.sources.length){that.promise.resolve(that.strategy.resolveResult(that))}else{var value=that.strategy.invokeNext(that);that.resolvedSources[that.index]=value;if(fluid.isPromise(value)){value.then((function(retValue){fluid.promise.progressSequence(that,retValue)}),(function(error){fluid.promise.processSequenceReject(that,error)}))}else{fluid.promise.progressSequence(that,value)}}};fluid.promise.makeSequenceStrategy=function(){return{invokeNext:function(that){var source=that.sources[that.index];return typeof source==="function"?source(that.options):source},resolveResult:function(that){return that.returns}}};fluid.promise.sequence=function(sources,options){var sequencer=fluid.promise.makeSequencer(sources,options,fluid.promise.makeSequenceStrategy());fluid.promise.resumeSequence(sequencer);return sequencer.promise};fluid.promise.makeTransformerStrategy=function(){return{invokeNext:function(that){var lisrec=that.sources[that.index];lisrec.listener=fluid.event.resolveListener(lisrec.listener);var value=lisrec.listener.apply(null,[that.returns[that.index],that.options]);return value},resolveResult:function(that){return that.returns[that.index]}}};fluid.promise.makeTransformer=function(listeners,payload,options){listeners.unshift({listener:function(){return payload}});var sequencer=fluid.promise.makeSequencer(listeners,options,fluid.promise.makeTransformerStrategy());sequencer.returns.push(null);return sequencer};fluid.promise.filterNamespaces=function(listeners,namespaces){if(!namespaces){return listeners}return fluid.remove_if(fluid.makeArray(listeners),(function(element){return element.namespace&&!element.softNamespace&&!namespaces.includes(element.namespace)}))};fluid.promise.fireTransformEvent=function(event,payload,options){options=options||{};var listeners=options.reverse?fluid.makeArray(event.sortedListeners).reverse():fluid.makeArray(event.sortedListeners);listeners=fluid.promise.filterNamespaces(listeners,options.filterNamespaces);var sequencer=fluid.promise.makeTransformer(listeners,payload,options);var canceller=sequencer.promise.cancel;var remover=function(){fluid.remove_if(event.onDestroy,(function(func){return func===canceller}))};fluid.event.addPrimitiveListener(event,"onDestroy",canceller);sequencer.promise.then(remover,remover,remover);fluid.promise.resumeSequence(sequencer);return sequencer.promise};"use strict";fluid.renderTimestamp=function(date){var zeropad=function(num,width){if(!width){width=2}var numstr=num===undefined?"":num.toString();return"00000".substring(5-width+numstr.length)+numstr};return zeropad(date.getHours())+":"+zeropad(date.getMinutes())+":"+zeropad(date.getSeconds())+"."+zeropad(date.getMilliseconds(),3)};fluid.isTracing=false;fluid.registerNamespace("fluid.tracing");fluid.tracing.pathCount=[];fluid.tracing.summarisePathCount=function(pathCount){pathCount=pathCount||fluid.tracing.pathCount;var togo={};for(var i=0;i<pathCount.length;++i){var path=pathCount[i];if(!togo[path]){togo[path]=1}else{++togo[path]}}var toReallyGo=[];fluid.each(togo,(function(el,path){toReallyGo.push({path:path,count:el})}));toReallyGo.sort((function(a,b){return b.count-a.count}));return toReallyGo};fluid.tracing.condensePathCount=function(prefixes,pathCount){prefixes=fluid.makeArray(prefixes);var prefixCount={};fluid.each(prefixes,(function(prefix){prefixCount[prefix]=0}));var togo=[];fluid.each(pathCount,(function(el){var path=el.path;if(!fluid.find(prefixes,(function(prefix){if(path.indexOf(prefix)===0){prefixCount[prefix]+=el.count;return true}}))){togo.push(el)}}));fluid.each(prefixCount,(function(count,path){togo.unshift({path:path,count:count})}));return togo};fluid.obtainException=function(){return new Error("Trace exception")};fluid.registerNamespace("fluid.exceptionDecoders");fluid.decodeStack=function(){var e=fluid.obtainException();return fluid.exceptionDecoders.standard(e)};fluid.exceptionDecoders.standard=function(e){var delimiter="at ";var lines=e.stack.replace(/(?:\n@:0)?\s+$/m,"").replace(/^\(/gm,"{anonymous}(").split("\n");return fluid.transform(lines,(function(line){line=line.replace(/\)/g,"");var atind=line.indexOf(delimiter);return atind===-1?[line]:[line.substring(atind+delimiter.length),line.substring(0,atind)]}))};fluid.getCallerInfo=function(atDepth){atDepth=atDepth||3;var stack=fluid.decodeStack();var element=stack&&stack[atDepth]&&stack[atDepth][0];if(element){var lastslash=element.lastIndexOf("/");if(lastslash===-1){lastslash=0}var nextColon=element.indexOf(":",lastslash);return{path:element.substring(0,lastslash),filename:element.substring(lastslash+1,nextColon),index:element.substring(nextColon+1)}}else{return null}};fluid.generatePadding=function(c,count){var togo="";for(var i=0;i<count;++i){togo+=c}return togo};fluid.SYNTHETIC_PROPERTY=Object.freeze({});fluid.getSafeProperty=function(obj,key){var desc=Object.getOwnPropertyDescriptor(obj,key);return desc&&!desc.get?obj[key]:fluid.SYNTHETIC_PROPERTY};fluid.prettyPrintJSONImpl=function(obj,small,options){function out(str){options.output+=str}var big=small+options.indentChars,isFunction=typeof obj==="function";if(options.maxRenderChars!==undefined&&options.output.length>options.maxRenderChars){return true}if(obj===null){out("null")}else if(obj===undefined){out("undefined")}else if(obj===fluid.SYNTHETIC_PROPERTY){out("[Synthetic property]")}else if(fluid.isPrimitive(obj)&&!isFunction){out(JSON.stringify(obj))}else{if(options.stack.indexOf(obj)!==-1){out("(CIRCULAR)");return}options.stack.push(obj);var i;if(fluid.isArrayable(obj)){if(obj.length===0){out("[]")}else{out("[\n"+big);for(i=0;i<obj.length;++i){if(fluid.prettyPrintJSONImpl(obj[i],big,options)){return true}if(i!==obj.length-1){out(",\n"+big)}}out("\n"+small+"]")}}else{out("{"+(isFunction?" Function":"")+"\n"+big);var keys=fluid.keys(obj);for(i=0;i<keys.length;++i){var key=keys[i];var value=fluid.getSafeProperty(obj,key);out(JSON.stringify(key)+": ");if(fluid.prettyPrintJSONImpl(value,big,options)){return true}if(i!==keys.length-1){out(",\n"+big)}}out("\n"+small+"}")}options.stack.pop()}return};fluid.prettyPrintJSON=function(obj,options){options=$.extend({indent:4,stack:[],output:""},options);options.indentChars=fluid.generatePadding(" ",options.indent);fluid.prettyPrintJSONImpl(obj,"",options);return options.output};fluid.dumpEl=function(element){var togo;if(!element){return"null"}if(element.nodeType===3||element.nodeType===8){return"[data: "+element.data+"]"}if(element.nodeType===9){return"[document: location "+element.location+"]"}if(!element.nodeType&&fluid.isArrayable(element)){togo="[";for(var i=0;i<element.length;++i){togo+=fluid.dumpEl(element[i]);if(i<element.length-1){togo+=", "}}return togo+"]"}element=$(element);togo=element.get(0).tagName;if(element.id){togo+="#"+element.id}if(element.attr("class")){togo+="."+element.attr("class")}return togo};fluid["debugger"]=function(){debugger};fluid.defaults("fluid.debuggingProbe",{gradeNames:["fluid.component"]});fluid.probeToDistribution=function(probe){var instantiator=fluid.globalInstantiator;var parsed=fluid.parseContextReference(probe.target);var segs=fluid.model.parseToSegments(parsed.path,instantiator.parseEL,true);if(segs[0]!=="options"){segs.unshift("options")}var parsedPriority=fluid.parsePriority(probe.priority);if(parsedPriority.constraint&&!parsedPriority.constraint.target){parsedPriority.constraint.target="authoring"}return{target:"{/ "+parsed.context+"}."+instantiator.composeSegments.apply(null,segs),record:{func:probe.func,funcName:probe.funcName,args:probe.args,priority:fluid.renderPriority(parsedPriority)}}};fluid.registerProbes=function(probes){var probeDistribution=fluid.transform(probes,fluid.probeToDistribution);var memberName="fluid_debuggingProbe_"+fluid.allocateGuid();fluid.construct([memberName],{type:"fluid.debuggingProbe",distributeOptions:probeDistribution});return memberName};fluid.deregisterProbes=function(probeName){fluid.destroy([probeName])};"use strict";var fluid=fluid||{};fluid.uaMatch=function(ua){ua=ua.toLowerCase();var match=/(chrome)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[];return{browser:match[1]||"",version:match[2]||"0"}};fluid.assignJQueryBrowser=function($){if(!$.browser){var matched=fluid.uaMatch(navigator.userAgent);var browser={};if(matched.browser){browser[matched.browser]=true;browser.version=matched.version}if(browser.chrome){browser.webkit=true}else if(browser.webkit){browser.safari=true}$.browser=browser}};fluid.assignJQueryBrowser(jQuery);fluid.getScopedData=function(target,key){var data=$(target).data("fluid-scoped-data");return data?data[key]:undefined};fluid.setScopedData=function(target,key,value){$(target).each((function(){var data=$.data(this,"fluid-scoped-data")||{};data[key]=value;$.data(this,"fluid-scoped-data",data)}))};fluid.lastFocusedElement=null;$(document).on("focusin",(function(event){fluid.lastFocusedElement=event.target}));fluid.enabled=function(target,state){target=$(target);if(state===undefined){return fluid.getScopedData(target,"enablement")!==false}else{$("*",target).add(target).each((function(){if(fluid.getScopedData(this,"enablement")!==undefined){fluid.setScopedData(this,"enablement",state)}else if(/select|textarea|input/i.test(this.nodeName)){$(this).prop("disabled",!state)}}));fluid.setScopedData(target,"enablement",state)}};fluid.initEnablement=function(target){fluid.setScopedData(target,"enablement",true)};fluid.resolveEventTarget=function(event){while(event.originalEvent&&event.originalEvent.target){event=event.originalEvent}return event.target};async function applyOp(node,func){node=$(node)[0];if(node){var promise=new Promise((function(resolve){node.addEventListener(func,resolve,{once:true})}));node[func]();return promise}}$.each(["focus","blur"],(function(i,name){fluid[name]=function(elem){return applyOp(elem,name)}}));"use strict";fluid.visitComponentChildren=function(that,visitor,options,segs){segs=segs||[];var shadow=fluid.shadowForComponent(that);for(var name in shadow.childComponents){var component=shadow.childComponents[name];if(options.visited&&options.visited[component.id]){continue}segs.push(name);if(options.visited){options.visited[component.id]=true}if(visitor(component,name,segs,segs.length-1)){return true}if(!options.flat){fluid.visitComponentChildren(component,visitor,options,segs)}segs.pop()}};fluid.getContextHash=function(instantiator,that){var shadow=instantiator.idToShadow[that.id];return shadow&&shadow.contextHash};fluid.componentHasGrade=function(that,gradeName){var contextHash=fluid.getContextHash(fluid.globalInstantiator,that);return!!(contextHash&&contextHash[gradeName])};fluid.visitComponentsForMatching=function(that,options,visitor){var instantiator=fluid.getInstantiator(that);options=$.extend({visited:{},instantiator:instantiator},options);var thatStack=[that];var contextHashes=[fluid.getContextHash(instantiator,that)];var visitorWrapper=function(component,name,segs){thatStack.length=1;contextHashes.length=1;for(var i=0;i<segs.length;++i){var child=thatStack[i][segs[i]];thatStack[i+1]=child;contextHashes[i+1]=fluid.getContextHash(instantiator,child)||{}}return visitor(component,thatStack,contextHashes,segs,segs.length)};fluid.visitComponentChildren(that,visitorWrapper,options,[])};fluid.getMemberNames=function(instantiator,thatStack){if(thatStack.length===0){return[]}else{var path=instantiator.idToPath(fluid.peek(thatStack).id);var segs=instantiator.parseEL(path);segs.unshift.apply(segs,fluid.generate(thatStack.length-segs.length,""));return segs}};fluid.visitComponentsForVisibility=function(instantiator,thatStack,visitor,options){options=options||{visited:{},flat:true,instantiator:instantiator};var memberNames=fluid.getMemberNames(instantiator,thatStack);for(var i=thatStack.length-1;i>=0;--i){var that=thatStack[i];options.visited[that.id]=true;if(visitor(that,memberNames[i],memberNames,i)){return}if(fluid.visitComponentChildren(that,visitor,options,memberNames)){return}memberNames.pop()}};fluid.mountStrategy=function(prefix,root,toMount){var offset=prefix.length;return function(target,name,i,segs){if(i<=prefix.length){return}for(var j=0;j<prefix.length;++j){if(segs[j]!==prefix[j]){return}}return toMount(target,name,i-prefix.length,segs.slice(offset))}};fluid.invokerFromRecord=function(invokerec,name,that){fluid.pushActivity("makeInvoker","beginning instantiation of invoker with name %name and record %record as child of %that",{name:name,record:invokerec,that:that});var invoker=invokerec?fluid.makeInvoker(that,invokerec,name):undefined;fluid.popActivity();return invoker};fluid.memberFromRecord=function(memberrecs,name,that){var shadow=fluid.shadowForComponent(that);var togo;for(var i=0;i<memberrecs.length;++i){var expanded=fluid.expandImmediate(memberrecs[i],that,shadow.localRecord);if(!fluid.isPlainObject(togo)){togo=expanded}else{togo=$.extend(true,togo,expanded)}}return togo};fluid.resourceFromRecord=function(resourceRec,name,that){var resourceFetcher=fluid.getForComponent(that,"resourceFetcher");var resourceSpec=resourceFetcher.resourceSpecs[name];var oneFetcher=new fluid.fetchResources.FetchOne(resourceSpec,resourceFetcher);var existing=that.resources[name];if(existing&&existing!==fluid.inEvaluationMarker){return existing}else{var promise=oneFetcher.resourceSpec.promise;if(!promise.disposition){var transRec=fluid.currentTreeTransaction();transRec.pendingIO.push(promise)}return oneFetcher}};fluid.recordStrategy=function(that,options,optionsStrategy,recordPath,recordMaker,prefix,exceptions){prefix=prefix||[];var fullyEvaluated=false;return{strategy:function(target,name,i){if(i!==1||fullyEvaluated){return}var record=fluid.driveStrategy(options,[recordPath,name],optionsStrategy);if(record===undefined){if(prefix.length>0){fluid.fail("Reference to "+recordPath+" record with name "+name+" which is not registered for component "+fluid.dumpComponentAndPath(that))}else{return}}fluid.set(target,[name],fluid.inEvaluationMarker);var member=recordMaker(record,name,that);fluid.set(target,[name],member);return member},initter:function(){var records=fluid.driveStrategy(options,recordPath,optionsStrategy)||{};for(var name in records){if(!exceptions||!exceptions[name]){fluid.getForComponent(that,prefix.concat([name]))}}fullyEvaluated=true}}};fluid.makeDistributionRecord=function(contextThat,sourceRecord,sourcePath,targetSegs,exclusions,sourceType){sourceType=sourceType||"distribution";fluid.pushActivity("makeDistributionRecord","Making distribution record from source record %sourceRecord path %sourcePath to target path %targetSegs",{sourceRecord:sourceRecord,sourcePath:sourcePath,targetSegs:targetSegs});var source=fluid.copy(fluid.get(sourceRecord,sourcePath));fluid.each(exclusions,(function(exclusion){fluid.model.applyChangeRequest(source,{segs:exclusion,type:"DELETE"})}));var record={options:{}};fluid.model.applyChangeRequest(record,{segs:targetSegs,type:"ADD",value:source});fluid.checkComponentRecord(record,fluid.componentRecordExpected);fluid.popActivity();return $.extend(record,{contextThat:contextThat,recordType:sourceType})};fluid.filterBlocks=function(contextThat,sourceBlocks,sourceSegs,targetSegs,exclusions,removeSource){var togo=[];fluid.each(sourceBlocks,(function(block){var source=fluid.get(block.source,sourceSegs);if(source!==undefined){togo.push(fluid.makeDistributionRecord(contextThat,block.source,sourceSegs,targetSegs,exclusions,"distribution"));var rescued=$.extend({},source);if(removeSource){fluid.model.applyChangeRequest(block.source,{segs:sourceSegs,type:"DELETE"})}fluid.each(exclusions,(function(exclusion){var orig=fluid.get(rescued,exclusion);fluid.set(block.source,sourceSegs.concat(exclusion),orig)}))}}));return togo};fluid.noteCollectedDistribution=function(parentShadow,memberName,distribution){fluid.model.setSimple(parentShadow,["collectedDistributions",memberName,distribution.id],true)};fluid.isCollectedDistribution=function(parentShadow,memberName,distribution){return fluid.model.getSimple(parentShadow,["collectedDistributions",memberName,distribution.id])};fluid.clearCollectedDistributions=function(parentShadow,memberName){fluid.model.applyChangeRequest(parentShadow,{segs:["collectedDistributions",memberName],type:"DELETE"})};fluid.collectDistributions=function(distributedBlocks,parentShadow,distribution,thatStack,contextHashes,memberNames,i){var lastMember=fluid.peek(memberNames);if(!fluid.isCollectedDistribution(parentShadow,lastMember,distribution)&&fluid.matchIoCSelector(distribution.selector,thatStack,contextHashes,memberNames,i)){distributedBlocks.push.apply(distributedBlocks,fluid.copy(distribution.blocks));fluid.noteCollectedDistribution(parentShadow,lastMember,distribution)}};fluid.registerCollectedClearer=function(shadow,parentShadow,memberName){if(!shadow.collectedClearer&&parentShadow){shadow.collectedClearer=function(){fluid.clearCollectedDistributions(parentShadow,memberName)}}};fluid.receiveDistributions=function(parentThat,gradeNames,memberName,that){var instantiator=fluid.getInstantiator(parentThat||that);var thatStack=instantiator.getThatStack(parentThat||that);thatStack.unshift(fluid.rootComponent);var memberNames=fluid.getMemberNames(instantiator,thatStack);var shadows=fluid.transform(thatStack,(function(thisThat){return instantiator.idToShadow[thisThat.id]}));var parentShadow=shadows[shadows.length-(parentThat?1:2)];var contextHashes=fluid.getMembers(shadows,"contextHash");if(parentThat){memberNames.push(memberName);contextHashes.push(fluid.gradeNamesToHash(gradeNames));thatStack.push(that)}else{fluid.registerCollectedClearer(fluid.peek(shadows),parentShadow,fluid.peek(memberNames))}var distributedBlocks=[];for(var i=0;i<thatStack.length-1;++i){fluid.each(shadows[i].distributions,(function(distribution){fluid.collectDistributions(distributedBlocks,parentShadow,distribution,thatStack,contextHashes,memberNames,i)}))}return distributedBlocks};fluid.computeTreeDistance=function(path1,path2){var i=0;while(i<path1.length&&i<path2.length&&path1[i]===path2[i]){++i}return path1.length+path2.length-2*i};fluid.computeDistributionPriority=function(targetThat,distributedBlock){if(!distributedBlock.priority){var instantiator=fluid.getInstantiator(targetThat);var targetStack=instantiator.getThatStack(targetThat);var targetPath=fluid.getMemberNames(instantiator,targetStack);var sourceStack=instantiator.getThatStack(distributedBlock.contextThat);var sourcePath=fluid.getMemberNames(instantiator,sourceStack);var distance=fluid.computeTreeDistance(targetPath,sourcePath);distributedBlock.priority=fluid.mergeRecordTypes.distribution-distance}return distributedBlock};fluid.applyDistributions=function(that,preBlocks,targetShadow){var distributedBlocks=fluid.transform(preBlocks,(function(preBlock){return fluid.generateExpandBlock(preBlock,that,targetShadow.mergePolicy)}),(function(distributedBlock){return fluid.computeDistributionPriority(that,distributedBlock)}));var mergeOptions=targetShadow.mergeOptions;mergeOptions.mergeBlocks.push.apply(mergeOptions.mergeBlocks,distributedBlocks);mergeOptions.updateBlocks();return distributedBlocks};fluid.matchIoCSelector=function(selector,thatStack,contextHashes,memberNames,i){var thatpos=thatStack.length-1;var selpos=selector.length-1;while(true){var isChild=selector[selpos].child;var mustMatchHere=thatpos===thatStack.length-1||isChild;var that=thatStack[thatpos];var selel=selector[selpos];var match=true;for(var j=0;j<selel.predList.length;++j){var pred=selel.predList[j];var context=pred.context;if(context&&context!=="*"&&!(contextHashes[thatpos][context]||memberNames[thatpos]===context)){match=false;break}if(pred.id&&that.id!==pred.id){match=false;break}}if(selpos===0&&thatpos>i&&mustMatchHere&&isChild){match=false}if(match){if(selpos===0){return true}--thatpos;--selpos}else{if(mustMatchHere){return false}else{--thatpos}}if(thatpos<i){return false}}return false};fluid.queryIoCSelector=function(root,selector,flat){var parsed=fluid.parseSelector(selector,fluid.IoCSSMatcher);var togo=[];fluid.visitComponentsForMatching(root,{flat:flat},(function(that,thatStack,contextHashes){if(fluid.matchIoCSelector(parsed,thatStack,contextHashes,[],1)){togo.push(that)}}));return togo};fluid.isIoCSSSelector=function(context){return context.indexOf(" ")!==-1};fluid.pushDistributions=function(targetHead,selector,target,blocks){var targetShadow=fluid.shadowForComponent(targetHead);var id=fluid.allocateGuid();var distribution={id:id,target:target,selector:selector,blocks:blocks};Object.freeze(distribution);Object.freeze(distribution.blocks);distribution.blocks.forEach((function(block){fluid.freezeRecursive(block.options)}));fluid.pushArray(targetShadow,"distributions",distribution);return id};fluid.clearDistribution=function(targetHeadId,id){var targetHeadShadow=fluid.globalInstantiator.idToShadow[targetHeadId];if(targetHeadShadow){fluid.remove_if(targetHeadShadow.distributions,(function(distribution){return distribution.id===id}))}};fluid.clearDistributions=function(shadow){fluid.each(shadow.outDistributions,(function(outDist){fluid.clearDistribution(outDist.targetHeadId,outDist.distributionId)}))};fluid.extractSelectorHead=function(parsedSelector){var predList=parsedSelector[0].predList;var context=predList[0].context;predList.length=0;return context};fluid.parseExpectedOptionsPath=function(path,role){var segs=fluid.model.parseEL(path);if(segs[0]!=="options"){fluid.fail("Error in options distribution path ",path," - only "+role+' paths beginning with "options" are supported')}return segs.slice(1)};fluid.replicateProperty=function(source,property,targets){if(source[property]!==undefined){fluid.each(targets,(function(target){target[property]=source[property]}))}};fluid.undistributableOptions=["gradeNames","distributeOptions","argumentMap","mergePolicy"];fluid.distributeOptionsOne=function(that,record,targetRef,selector,context){fluid.pushActivity("distributeOptions","parsing distributeOptions block %record %that ",{that:that,record:record});var targetHead=fluid.resolveContext(context,that);if(!targetHead){fluid.fail("Error in options distribution record ",record," - could not resolve context {"+context+"} to a head component")}var thatShadow=fluid.shadowForComponent(that);var targetSegs=fluid.model.parseEL(targetRef.path);var preBlocks;if(record.record!==undefined){preBlocks=[fluid.makeDistributionRecord(that,record.record,[],targetSegs,[])]}else{var source=fluid.parseContextReference(record.source);if(source.context!=="that"){fluid.fail("Error in options distribution record ",record," only a source context of {that} is supported")}var sourceSegs=fluid.parseExpectedOptionsPath(source.path,"source");var fullExclusions=fluid.makeArray(record.exclusions).concat(sourceSegs.length===0?fluid.undistributableOptions:[]);var exclusions=fluid.transform(fullExclusions,(function(exclusion){return fluid.model.parseEL(exclusion)}));preBlocks=fluid.filterBlocks(that,thatShadow.mergeOptions.mergeBlocks,sourceSegs,targetSegs,exclusions,record.removeSource);thatShadow.mergeOptions.updateBlocks()}fluid.replicateProperty(record,"priority",preBlocks);fluid.replicateProperty(record,"namespace",preBlocks);if(selector){var distributionId=fluid.pushDistributions(targetHead,selector,record.target,preBlocks);thatShadow.outDistributions=thatShadow.outDistributions||[];thatShadow.outDistributions.push({targetHeadId:targetHead.id,distributionId:distributionId})}else{var targetShadow=fluid.shadowForComponent(targetHead);fluid.applyDistributions(that,preBlocks,targetShadow)}fluid.popActivity()};fluid.distributeOptions=function(that,optionsStrategy){var records=fluid.driveStrategy(that.options,"distributeOptions",optionsStrategy);fluid.each(records,(function distributeOptionsOne(record){if(typeof record.target!=="string"){fluid.fail("Error in options distribution record ",record,' a member named "target" must be supplied holding an IoC reference')}if(typeof record.source==="string"^record.record===undefined){fluid.fail("Error in options distribution record ",record,': must supply either a member "source" holding an IoC reference or a member "record" holding a literal record')}var targetRef=fluid.parseContextReference(record.target);var selector,context;if(fluid.isIoCSSSelector(targetRef.context)){selector=fluid.parseSelector(targetRef.context,fluid.IoCSSMatcher);context=fluid.extractSelectorHead(selector)}else{context=targetRef.context}if(context==="/"||context==="that"){fluid.distributeOptionsOne(that,record,targetRef,selector,context)}else{var transRec=fluid.currentTreeTransaction();transRec.deferredDistributions.push({that:that,record:record,targetRef:targetRef,selector:selector,context:context})}}))};fluid.contextName=1;fluid.memberName=2;fluid.gradeNamesToHash=function(gradeNames){var contextHash={};fluid.each(gradeNames,(function(gradeName){if(!fluid.isReferenceOrExpander(gradeName)){contextHash[gradeName]=fluid.contextName;contextHash[fluid.computeNickName(gradeName)]=fluid.contextName}}));return contextHash};fluid.applyToContexts=function(hash,key,disposition){var existing=hash[key];hash[key]=(existing||0)|disposition};fluid.applyToScope=function(scope,key,value,disposition){var existing=scope[key];if(!existing||disposition&fluid.memberName){scope[key]=value}};fluid.cacheShadowGrades=function(that,shadow){var contextHash=fluid.gradeNamesToHash(that.options&&that.options.gradeNames||[that.typeName]);fluid.applyToContexts(contextHash,shadow.memberName,fluid.memberName);shadow.contextHash=contextHash;fluid.each(contextHash,(function(disposition,context){shadow.ownScope[context]=that;if(shadow.parentShadow&&shadow.parentShadow.that.typeName!=="fluid.rootComponent"){fluid.applyToScope(shadow.parentShadow.childrenScope,context,that,disposition)}}))};fluid.deliverOptionsStrategy=function(that,target,mergeOptions){var shadow=fluid.shadowForComponent(that,shadow);fluid.cacheShadowGrades(that,shadow);shadow.mergeOptions=mergeOptions};fluid.collectDistributedGrades=function(rec){var distributedBlocks=fluid.receiveDistributions(null,null,null,rec.that);if(distributedBlocks.length>0){var readyBlocks=fluid.applyDistributions(rec.that,distributedBlocks,rec.shadow);var gradeNamesList=fluid.transform(fluid.getMembers(readyBlocks,["source","gradeNames"]),fluid.makeArray);fluid.accumulateDynamicGrades(rec,fluid.flatten(gradeNamesList))}};fluid.applyDynamicGrades=function(rec){rec.oldGradeNames=fluid.makeArray(rec.gradeNames);var newDefaults=fluid.copy(fluid.getMergedDefaults(rec.that.typeName,rec.gradeNames));rec.gradeNames.length=0;rec.gradeNames.push.apply(rec.gradeNames,newDefaults.gradeNames);fluid.each(rec.gradeNames,(function(gradeName){if(!fluid.isReferenceOrExpander(gradeName)){rec.seenGrades[gradeName]=true}}));var shadow=rec.shadow;fluid.cacheShadowGrades(rec.that,shadow);shadow.mergeOptions.destroyValue(["mergePolicy"]);shadow.mergeOptions.destroyValue(["components"]);shadow.mergeOptions.destroyValue(["invokers"]);rec.defaultsBlock.source=newDefaults;shadow.mergeOptions.updateBlocks();shadow.mergeOptions.computeMergePolicy();fluid.accumulateDynamicGrades(rec,newDefaults.gradeNames)};fluid.accumulateDynamicGrades=function(rec,newGradeNames){fluid.each(newGradeNames,(function(gradeName){var flatGradeName=fluid.flattenGradeName(gradeName);if(!rec.seenGrades[flatGradeName]){if(fluid.isReferenceOrExpander(gradeName)){rec.rawDynamic.push(gradeName);rec.seenGrades[flatGradeName]=true}else if(!rec.oldGradeNames.includes(gradeName)){rec.plainDynamic.push(gradeName)}}}))};fluid.accumulateContextAwareGrades=function(that,rec){var newContextAware=[];if(rec.gradeNames.includes("fluid.contextAware")){var contextAwarenessOptions=fluid.getForComponent(that,["options","contextAwareness"]);newContextAware=fluid.contextAware.check(that,contextAwarenessOptions);var lostGrade=fluid.find_if(rec.contextAware,(function(gradeName){return!newContextAware.includes(gradeName)}));if(lostGrade){fluid.fail("Failure operating contextAwareness definition ",contextAwarenessOptions," for component "+fluid.dumpComponentAndPath(that)+": grade name "+lostGrade+" returned by an earlier round of checks was lost through a context change caused by a raw dynamic grade")}rec.contextAware=newContextAware}return newContextAware};fluid.computeDynamicGrades=function(that,shadow,strategy){delete that.options.gradeNames;var gradeNames=fluid.driveStrategy(that.options,"gradeNames",strategy);gradeNames.length=0;var defaultsBlock=fluid.findMergeBlocks(shadow.mergeOptions.mergeBlocks,"defaults")[0];var rec={that:that,shadow:shadow,defaultsBlock:defaultsBlock,gradeNames:gradeNames,seenGrades:{},plainDynamic:[],contextAware:[],rawDynamic:[]};fluid.each(shadow.mergeOptions.mergeBlocks,(function(block){gradeNames.push.apply(gradeNames,fluid.makeArray(block.target&&block.target.gradeNames));fluid.applyDynamicGrades(rec)}));fluid.collectDistributedGrades(rec);var checkContextAware=true;while(true){while(rec.plainDynamic.length>0){gradeNames.push.apply(gradeNames,rec.plainDynamic);rec.plainDynamic.length=0;fluid.applyDynamicGrades(rec);fluid.collectDistributedGrades(rec)}if(checkContextAware){var newContextAware=fluid.accumulateContextAwareGrades(that,rec);rec.plainDynamic=rec.plainDynamic.concat(newContextAware);checkContextAware=false}else if(rec.rawDynamic.length>0){var toexpand=rec.rawDynamic.shift();var expanded=fluid.expandImmediate(toexpand,that,shadow.localRecord);if(typeof expanded==="function"){expanded=expanded()}if(expanded){rec.plainDynamic=rec.plainDynamic.concat(expanded)}checkContextAware=true}else{break}}fluid.remove_if(gradeNames,fluid.isReferenceOrExpander);if(shadow.collectedClearer){shadow.collectedClearer();delete shadow.collectedClearer}};fluid.computeComponentAccessor=function(that,localRecord){var instantiator=fluid.globalInstantiator;var shadow=fluid.shadowForComponent(that);shadow.localRecord=localRecord;var options=that.options;var strategy=shadow.mergeOptions.strategy;var optionsStrategy=fluid.mountStrategy(["options"],options,strategy);shadow.invokerStrategy=fluid.recordStrategy(that,options,strategy,"invokers",fluid.invokerFromRecord);shadow.eventStrategyBlock=fluid.recordStrategy(that,options,strategy,"events",fluid.eventFromRecord,["events"]);var eventStrategy=fluid.mountStrategy(["events"],that,shadow.eventStrategyBlock.strategy);shadow.memberStrategy=fluid.recordStrategy(that,options,strategy,"members",fluid.memberFromRecord,null,{model:true,modelRelay:true});shadow.getConfig={strategies:[fluid.concreteStrategy,fluid.model.funcResolverStrategy,optionsStrategy,shadow.invokerStrategy.strategy,shadow.memberStrategy.strategy,eventStrategy]};fluid.computeDynamicGrades(that,shadow,strategy,shadow.mergeOptions.mergeBlocks);if(shadow.contextHash["fluid.resourceLoader"]){shadow.resourceStrategyBlock=fluid.recordStrategy(that,options,strategy,"resources",fluid.resourceFromRecord,["resources"]);var resourceStrategy=fluid.mountStrategy(["resources"],that,shadow.resourceStrategyBlock.strategy);shadow.getConfig.strategies.push(resourceStrategy);that.resources={}}fluid.distributeOptions(that,strategy);if(shadow.contextHash["fluid.resolveRoot"]){var memberName;if(shadow.contextHash["fluid.resolveRootSingle"]){var singleRootType=fluid.getForComponent(that,["options","singleRootType"]);if(!singleRootType){fluid.fail("Cannot register object with grades "+Object.keys(shadow.contextHash).join(", ")+" as fluid.resolveRootSingle since it has not defined option singleRootType")}memberName=fluid.typeNameToMemberName(singleRootType)}else{memberName=fluid.computeGlobalMemberName(that.typeName,that.id)}var parent=fluid.resolveRootComponent;if(parent[memberName]){instantiator.clearComponent(parent,memberName)}instantiator.recordKnownComponent(parent,that,memberName,false)}return shadow.getConfig};fluid.shadowForComponent=function(component){var instantiator=fluid.getInstantiator(component);return instantiator&&component?instantiator.idToShadow[component.id]:null};fluid.pathInEvaluation=function(path,paths){var index=paths.indexOf(path);return index!==-1&&index!==paths.length-1};fluid.getForComponent=function(component,path){var segs=fluid.model.pathToSegments(path);if(segs.length===0){return component}var instantiator=fluid.globalInstantiator;var shadow=fluid.shadowForComponent(component);if(shadow){var next=fluid.get(component,segs[0],shadow.getConfig);if(fluid.isComponent(next)){return fluid.getForComponent(next,segs.slice(1))}else{var inEvaluationPaths=instantiator.inEvaluationPaths;var inEvaluationPath=component.id+":"+path;if(fluid.pathInEvaluation(inEvaluationPath,inEvaluationPaths)){fluid.fail("Error in component configuration - a circular reference was found during evaluation of path "+path+" for component "+fluid.dumpComponentAndPath(component)+": a circular set of references was found - for more details, see the activity records following this message in the console")}else{inEvaluationPaths.push(inEvaluationPath);var togo=fluid.get(component,path,shadow.getConfig);inEvaluationPaths.pop();return togo}}}else{return fluid.get(component,path)}};fluid.concreteStrategy=function(component,thisSeg,index,segs){var atval=component[thisSeg];if(atval===fluid.inEvaluationMarker){fluid.fail('Error in component configuration - a circular reference was found during evaluation of path segment "'+thisSeg+" of path ",segs,'": for more details, see the activity records following this message in the console, or issue fluid.setLogging(fluid.logLevel.TRACE) when running your application')}if(index>1){return atval}if(atval===undefined&&component.hasOwnProperty(thisSeg)){return fluid.NO_VALUE}return atval};fluid.frameworkGrades=["fluid.component","fluid.modelComponent","fluid.viewComponent","fluid.rendererComponent"];fluid.filterBuiltinGrades=function(gradeNames){return fluid.remove_if(fluid.makeArray(gradeNames),(function(gradeName){return fluid.frameworkGrades.indexOf(gradeName)!==-1}))};fluid.dumpGradeNames=function(that){return that.options&&that.options.gradeNames?" gradeNames: "+JSON.stringify(fluid.filterBuiltinGrades(that.options.gradeNames)):""};fluid.dumpThat=function(that){return'{ typeName: "'+that.typeName+" id: "+that.id+'"'+fluid.dumpGradeNames(that)+"}"};fluid.dumpThatStack=function(thatStack,instantiator){var togo=fluid.transform(thatStack,(function(that){var path=instantiator.idToPath(that.id);return fluid.dumpThat(that)+(path?" - path: "+path:"")}));return togo.join("\n")};fluid.dumpComponentPath=function(that){var path=fluid.pathForComponent(that);return path?fluid.pathUtil.composeSegments.apply(null,path):"** no path registered for component **"};fluid.dumpComponentAndPath=function(that){return"component "+fluid.dumpThat(that)+" at path "+fluid.dumpComponentPath(that)};fluid.resolveContext=function(context,that,fast){if(context==="that"){return that}else if(context==="/"){return fluid.rootComponent}if(typeof context==="object"){var innerContext=fluid.resolveContext(context.context,that,fast);if(!fluid.isComponent(innerContext)){fluid.triggerMismatchedPathError(context.context,that)}var rawValue=fluid.getForComponent(innerContext,context.path);var expanded=fluid.expandOptions(rawValue,that);if(!fluid.isComponent(expanded)){fluid.fail("Unable to resolve recursive context expression "+fluid.renderContextReference(context)+": the directly resolved value of "+rawValue+" did not resolve to a component in the scope of "+fluid.dumpComponentAndPath(that)+": got ",expanded)}return expanded}else{var foundComponent;var instantiator=fluid.globalInstantiator;if(fast){var shadow=instantiator.idToShadow[that.id];return shadow.ownScope[context]}else{var thatStack=instantiator.getFullStack(that);fluid.visitComponentsForVisibility(instantiator,thatStack,(function(component,memberName){var shadow=fluid.shadowForComponent(component);var scopeValue=shadow.contextHash[context];if(scopeValue&&scopeValue!==fluid.memberName||context===memberName){foundComponent=component;return true}}));return foundComponent}}};fluid.triggerMismatchedPathError=function(parsed,parentThat){var ref=fluid.renderContextReference(parsed);fluid.fail("Failed to resolve reference "+ref+" - could not match context with name "+parsed.context+" from "+fluid.dumpComponentAndPath(parentThat))};fluid.makeStackFetcher=function(parentThat,localRecord,fast){var fetcher=function(parsed){if(parentThat&&parentThat.lifecycleStatus==="destroyed"){fluid.fail("Cannot resolve reference "+fluid.renderContextReference(parsed)+" from component "+fluid.dumpComponentAndPath(parentThat)+" which has been destroyed")}var context=parsed.context;if(localRecord&&context in localRecord){return fluid.get(localRecord[context],parsed.path)}var foundComponent=fluid.resolveContext(context,parentThat,fast);if(!foundComponent&&parsed.path!==""){fluid.triggerMismatchedPathError(parsed,parentThat)}return fluid.getForComponent(foundComponent,parsed.path)};return fetcher};fluid.makeStackResolverOptions=function(parentThat,localRecord,fast){return $.extend(fluid.copy(fluid.rawDefaults("fluid.makeExpandOptions")),{ELstyle:"{}",localRecord:localRecord||{},fetcher:fluid.makeStackFetcher(parentThat,localRecord,fast),contextThat:parentThat,exceptions:{members:{model:true,modelRelay:true}}})};fluid.clearListeners=function(shadow){fluid.each(shadow.listeners,(function(rec){rec.event.removeListener(rec.listenerId||rec.listener)}));delete shadow.listeners};fluid.recordListener=function(event,listener,shadow,listenerId){if(event.ownerId!==shadow.that.id){fluid.pushArray(shadow,"listeners",{event:event,listener:listener,listenerId:listenerId})}};fluid.constructScopeObjects=function(instantiator,parent,child,childShadow){var parentShadow=parent?instantiator.idToShadow[parent.id]:null;childShadow.childrenScope=parentShadow?Object.create(parentShadow.ownScope):{};childShadow.ownScope=Object.create(childShadow.childrenScope);childShadow.parentShadow=parentShadow;childShadow.childComponents={};fluid.cacheShadowGrades(child,childShadow)};fluid.clearChildrenScope=function(parentShadow,child,childShadow,memberName){var keys=fluid.keys(childShadow.contextHash);keys.push(memberName);keys.forEach((function(context){if(parentShadow.childrenScope[context]===child){delete parentShadow.childrenScope[context]}}))};fluid.clearComponentIndexes=function(instantiator,destroyRec){var shadow=destroyRec.shadow;fluid.clearChildrenScope(shadow,destroyRec.child,destroyRec.childShadow,destroyRec.name);delete instantiator.pathToComponent[destroyRec.childPath];delete shadow.childComponents[destroyRec.name]};fluid.doDestroy=function(instantiator,destroyRec){var shadow=destroyRec.childShadow,that=destroyRec.child;fluid.each(shadow.injectedPaths,(function(troo,injectedPath){var parentPath=fluid.model.getToTailPath(injectedPath);var otherParent=instantiator.pathToComponent[parentPath];instantiator.clearComponent(otherParent,fluid.model.getTailPath(injectedPath),that)}));fluid.clearComponentIndexes(instantiator,destroyRec);fluid.clearDistributions(shadow);fluid.clearListeners(shadow);for(var key in that.events){if(key!=="afterDestroy"&&typeof that.events[key].destroy==="function"){that.events[key].destroy()}}if(that.applier){that.applier.destroy()}that.lifecycleStatus="destroyed";fluid.fireEvent(destroyRec.child,"afterDestroy",[destroyRec.child,destroyRec.name,destroyRec.component]);delete instantiator.idToShadow[destroyRec.child.id]};fluid.instantiator=function(){var that=fluid.typeTag("instantiator");$.extend(that,{lifecycleStatus:"constructed",pathToComponent:{},idToShadow:{},modelTransactions:{},treeTransactions:{},inEvaluationPaths:[],currentTreeTransactionId:null,composePath:fluid.model.composePath,composeSegments:fluid.model.composeSegments,parseEL:fluid.model.parseEL,events:{onComponentAttach:fluid.makeEventFirer({name:"instantiator's onComponentAttach event"}),onComponentClear:fluid.makeEventFirer({name:"instantiator's onComponentClear event"}),onBeginTreeTransaction:fluid.makeEventFirer({name:"instantiator's onBeginTransaction event"}),onEndTreeTransaction:fluid.makeEventFirer({name:"instantiator's onEndTransaction event"})}});that.parseToSegments=function(path){return fluid.model.parseToSegments(path,that.parseEL,true)};that.idToPath=function(id){var shadow=that.idToShadow[id];return shadow?shadow.path:""};that.getThatStack=function(component){var shadow=that.idToShadow[component.id];if(shadow){var path=shadow.path;var parsed=that.parseEL(path);var root=that.pathToComponent[""],togo=[];for(var i=0;i<parsed.length;++i){root=root[parsed[i]];togo.push(root)}return togo}else{return[]}};that.getFullStack=function(component){var thatStack=component?that.getThatStack(component):[];thatStack.unshift(fluid.resolveRootComponent);return thatStack};function recordComponent(parent,component,path,name,created){var shadow;if(created){shadow=that.idToShadow[component.id]={};shadow.that=component;shadow.path=path;shadow.memberName=name;fluid.constructScopeObjects(that,parent,component,shadow)}else{shadow=that.idToShadow[component.id];shadow.injectedPaths=shadow.injectedPaths||{};shadow.injectedPaths[path]=true;var parentShadow=that.idToShadow[parent.id];var keys=fluid.keys(shadow.contextHash);fluid.remove_if(keys,(function(key){return shadow.contextHash&&shadow.contextHash[key]===fluid.memberName}));keys.push(name);keys.forEach((function(context){if(!parentShadow.childrenScope.hasOwnProperty(context)){parentShadow.childrenScope[context]=component}}))}if(that.pathToComponent[path]){fluid.fail("Error during instantiation - path "+path+" which has just created component "+fluid.dumpThat(component)+" has already been used for component "+fluid.dumpThat(that.pathToComponent[path])+" - this is a circular instantiation or other oversight."+" Please clear the component using instantiator.clearComponent() before reusing the path.")}that.pathToComponent[path]=component}that.recordRoot=function(component){recordComponent(null,component,"","",true)};that.recordKnownComponent=function(parent,component,name,created){parent[name]=component;if(fluid.isComponent(component)||component.type==="instantiator"){var parentShadow=that.idToShadow[parent.id];parentShadow.childComponents[name]=component;var path=that.composePath(parentShadow.path,name);recordComponent(parent,component,path,name,created);that.events.onComponentAttach.fire(component,path,that,created)}else{fluid.fail("Cannot record non-component with value ",component,' at path "'+name+'" of parent ',parent)}};that.clearComponent=function(component,name,child,options,nested,path){var shadow=that.idToShadow[component.id];options=options||{flat:true,destroyRecs:[]};child=child||component[name];path=path||shadow.path;if(path===undefined){fluid.fail("Cannot clear component "+name+" from component ",component," which was not created by this instantiator")}var childPath=that.composePath(path,name);var childShadow=that.idToShadow[child.id];if(!childShadow){return}var created=childShadow.path===childPath;that.events.onComponentClear.fire(child,childPath,component,created);var destroyRec={child:child,childShadow:childShadow,name:name,component:component,shadow:shadow,childPath:childPath};if(created){if(fluid.isDestroyed(child)){fluid.fail('Cannot destroy component which is already in status "'+child.lifecycleStatus+'"')}child.lifecycleStatus="destroying";fluid.visitComponentChildren(child,(function(gchild,gchildname,segs,i){var parentPath=that.composeSegments.apply(null,segs.slice(0,i));that.clearComponent(child,gchildname,null,options,true,parentPath)}),options,that.parseEL(childPath));fluid.fireEvent(child,"onDestroy",[child,name||"",component]);options.destroyRecs.push(destroyRec)}else{fluid.remove_if(childShadow.injectedPaths,(function(troo,path){return path===childPath}));fluid.clearComponentIndexes(that,destroyRec)}if(!nested){delete component[name];options.destroyRecs.forEach((function(destroyRec){fluid.doDestroy(that,destroyRec)}))}};return that};fluid.globalInstantiator=fluid.instantiator();fluid.getInstantiator=function(component){var instantiator=fluid.globalInstantiator;return component&&instantiator.idToShadow[component.id]?instantiator:null};fluid.defaults("fluid.resolveRoot");fluid.defaults("fluid.resolveRootSingle",{gradeNames:"fluid.resolveRoot"});fluid.constructRootComponents=function(instantiator){fluid.rootComponent=instantiator.rootComponent=fluid.typeTag("fluid.rootComponent");instantiator.recordRoot(fluid.rootComponent);fluid.resolveRootComponent=instantiator.resolveRootComponent=fluid.typeTag("fluid.resolveRootComponent");instantiator.recordKnownComponent(fluid.rootComponent,fluid.resolveRootComponent,"resolveRootComponent",true);var rootShadow=instantiator.idToShadow[fluid.rootComponent.id];rootShadow.contextHash={};var resolveRootShadow=instantiator.idToShadow[fluid.resolveRootComponent.id];resolveRootShadow.ownScope=rootShadow.ownScope;resolveRootShadow.childrenScope=rootShadow.childrenScope;instantiator.recordKnownComponent(fluid.resolveRootComponent,instantiator,"instantiator",true);resolveRootShadow.childrenScope.instantiator=instantiator};fluid.constructRootComponents(fluid.globalInstantiator);fluid.expandOptions=function(args,that,mergePolicy,localRecord,outerExpandOptions){if(!args){return args}fluid.pushActivity("expandOptions","expanding options %args for component %that ",{that:that,args:args});var expandOptions=fluid.makeStackResolverOptions(that,localRecord);expandOptions.mergePolicy=mergePolicy;expandOptions.defer=outerExpandOptions&&outerExpandOptions.defer;var expanded=expandOptions.defer?fluid.makeExpandOptions(args,expandOptions):fluid.expand(args,expandOptions);fluid.popActivity();return expanded};fluid.computeMergeListPriority=function(toMerge){toMerge.forEach((function(record){var recordType=record.recordType;if(recordType!=="distribution"){record.priority=fluid.mergeRecordTypes[recordType]+(record.priorityDelta||0);if(!Number.isInteger(record.priority)){fluid.fail("Merge record with unrecognised type "+recordType+": ",record)}}}))};var addPolicyBuiltins=function(policy){fluid.each(["gradeNames","mergePolicy","argumentMap","components","dynamicComponents","events","listeners","modelListeners","modelRelay","distributeOptions","transformOptions"],(function(key){fluid.set(policy,[key,"*","noexpand"],true)}));return policy};fluid.generateExpandBlock=function(record,that,mergePolicy,localRecord){var expanded=fluid.expandOptions(record.options||{},record.contextThat||that,mergePolicy,localRecord,{defer:true});expanded.priority=record.priority;expanded.namespace=record.namespace;expanded.recordType=record.recordType;return expanded};fluid.fabricateDestroyMethod=function(that){return function(){var currentTrans=fluid.currentTreeTransaction();var shadow=fluid.shadowForComponent(that);var transRec=fluid.destroy(shadow.path);if(!currentTrans){transRec.promise.then(null,(function(e){throw e}))}}};fluid.typeNameToMemberName=function(typeName){return typeName.replace(/\./g,"_")};fluid.expandComponentOptions=function(mergePolicy,potentia,lightMerge,that){var toMerge=lightMerge.toMerge;var container=fluid.lightMergeValue(toMerge,"container");if(container){toMerge.push({recordType:"distribution",priority:fluid.mergeRecordTypes.distribution,options:{container:container},contextThat:potentia.parentThat})}that.destroy=fluid.fabricateDestroyMethod(that);addPolicyBuiltins(mergePolicy);var shadow=fluid.shadowForComponent(that);shadow.mergePolicy=mergePolicy;fluid.computeMergeListPriority(toMerge);var togo=fluid.transform(toMerge,(function(value){return fluid.generateExpandBlock(value,that,mergePolicy,potentia.localRecord)}));return togo};fluid.computeDynamicComponentKey=function(recordKey,sourceKey){return recordKey+(sourceKey===0||sourceKey==="0"?"":"-"+sourceKey)};fluid.concludeAnyTreeTransaction=function(){var instantiator=fluid.globalInstantiator;var transactionId=instantiator.currentTreeTransactionId;if(transactionId){var transRec=instantiator.treeTransactions[transactionId];var errorOut;transRec.promise.then(null,(function(e){errorOut=e}));fluid.commitPotentiae(transactionId);if(errorOut){throw errorOut}}};fluid.bindDeferredComponent=function(that,componentName,lightMerge,dynamicComponent){var eventName=lightMerge.createOnEvent;var event=fluid.isIoCReference(eventName)?fluid.expandOptions(eventName,that):that.events[eventName];if(!event||!event.addListener){fluid.fail("Error instantiating createOnEvent component with name "+componentName+" of parent "+fluid.dumpComponentAndPath(that)+" since event specification "+eventName+" could not be expanded to an event - got ",event)}var shadow=fluid.shadowForComponent(that);if(dynamicComponent){fluid.set(shadow,["dynamicComponentCount",componentName],0)}var constructListener=function(){var key=dynamicComponent?fluid.computeDynamicComponentKey(componentName,shadow.dynamicComponentCount[componentName]++):componentName;var localRecord={arguments:fluid.makeArray(arguments)};fluid.pushActivity("initDeferred","instantiating deferred component %componentName of parent %that due to event %eventName",{componentName:componentName,that:that,eventName:eventName});var freshLightMerge=fluid.copy(lightMerge);delete freshLightMerge.createOnEvent;fluid.registerConcreteSubPotentia(freshLightMerge,key,0,that,localRecord);fluid.popActivity()};event.addListener(constructListener);fluid.recordListener(event,constructListener,shadow);event.addListener(fluid.concludeAnyTreeTransaction,"fluid-componentConstruction","last:transaction");fluid.recordListener(event,fluid.concludeAnyTreeTransaction,shadow)};fluid.markSubtree=function(instantiator,that,path,state){that.lifecycleStatus=state;fluid.visitComponentChildren(that,(function(child,name){var childPath=instantiator.composePath(path,name);var childShadow=instantiator.idToShadow[child.id];var created=childShadow&&childShadow.path===childPath;if(created){fluid.markSubtree(instantiator,child,childPath,state)}}),{flat:true})};fluid.assessTreeConstruction=function(that,shadow){var instantiator=fluid.globalInstantiator;var thatStack=instantiator.getThatStack(that);var unstableUp=fluid.find_if(thatStack,(function(that){return that.lifecycleStatus==="constructing"}));if(unstableUp){that.lifecycleStatus="constructed"}else{fluid.markSubtree(instantiator,that,shadow.path,"treeConstructed")}};fluid.concludeComponentObservation=function(shadow){var that=shadow.that;var mergeOptions=shadow.mergeOptions;fluid.pushActivity("concludeComponentObservation","constructing component of type %componentName at path %path",{componentName:that.typeName,path:shadow.path});mergeOptions.evaluateFully=true;for(var i=0;i<mergeOptions.mergeBlocks.length;++i){mergeOptions.mergeBlocks[i].initter()}mergeOptions.initter();delete that.options.mergePolicy;shadow.memberStrategy.initter();shadow.invokerStrategy.initter();fluid.freezeRecursive(that.options);fluid.each(shadow.lightMergeComponents,(function(lightMerge,key){if(lightMerge.createOnEvent){fluid.bindDeferredComponent(that,key,lightMerge)}}));fluid.each(shadow.lightMergeDynamicComponents,(function(lightMerge,key){if(lightMerge.createOnEvent){fluid.bindDeferredComponent(that,key,lightMerge,true)}}));fluid.popActivity()};fluid.concludeComponentInit=function(shadow){var that=shadow.that;if(fluid.isDestroyed(that)){return}that.lifecycleStatus="constructed";fluid.assessTreeConstruction(that,shadow);that.events.onCreate.fire(that);fluid.popActivity();return that};fluid.pushCreatePotentia=function(potentiaList,path,topush){var existing=potentiaList.pathToPotentia[path];if(existing&&!existing.applied){fluid.lightMergeRecords.pushRecords(existing,topush.records||topush.lightMerge.toMerge)}else{potentiaList.pathToPotentia[path]=topush;if(topush.records){topush.lightMerge=fluid.lightMergeRecords(topush.records);delete topush.records}return topush}};fluid.blankPotentiaList=function(){return{destroys:[],creates:[],activeCount:0,pathToPotentia:{}}};fluid.isInjectedComponentRecord=function(record){return typeof record==="string"||fluid.isPlainObject(record,true)&&record.expander};fluid.lightMergeValue=function(records,member){var value;records.forEach((function(record){var recValue=record[member];value=recValue===undefined?value:recValue}));return value};fluid.lightMergeRecords=function(records){var togo={toMerge:[],isInjected:false};fluid.lightMergeRecords.pushRecords(togo,records);return togo};fluid.lightMergeRecords.pushRecord=function(lightMerge,record){if(fluid.isInjectedComponentRecord(record)){lightMerge.toMerge=[{injected:record}];lightMerge.isInjected=true}else{lightMerge.type=record.type||lightMerge.type;lightMerge.createOnEvent=record.createOnEvent||lightMerge.createOnEvent;lightMerge.source=record.source||lightMerge.source;lightMerge.sources=record.sources||lightMerge.sources;if(lightMerge.isInjected){lightMerge.toMerge=[record]}else{lightMerge.toMerge.push(record)}lightMerge.isInjected=false}};fluid.lightMergeRecords.pushRecords=function(lightMerge,records){records.forEach((function(record){fluid.lightMergeRecords.pushRecord(lightMerge,record)}))};fluid.instantiateEvents=function(shadow){var that=shadow.that;shadow.eventStrategyBlock.initter();var listeners=fluid.getForComponent(that,["options","listeners"]);fluid.mergeListeners(that,that.events,listeners);var errors=fluid.validateListenersImplemented(that);if(errors.length>0){fluid.fail(fluid.transform(errors,(function(error){return["Error constructing component "+fluid.dumpComponentAndPath(that)+" - the listener for event "+error.name+" with namespace "+error.namespace+((error.componentSource?" which was defined in grade "+error.componentSource:"")+" needs to be overridden with a concrete implementation")]}))).join("\n")}};fluid.initComponentShell=function(potentia,lightMerge){var instantiator=fluid.globalInstantiator,upDefaults=fluid.defaults(lightMerge.type),parentThat=potentia.parentThat,memberName=potentia.memberName,fakeThat={};var distributions=fluid.receiveDistributions(parentThat,upDefaults&&upDefaults.gradeNames,memberName,fakeThat);fluid.each(distributions,(function(distribution){fluid.computeDistributionPriority(parentThat,distribution);if(fluid.isPrimitive(distribution.priority)){distribution.priority=fluid.parsePriority(distribution.priority,0,false,"options distribution")}}));fluid.sortByPriority(distributions);fluid.lightMergeRecords.pushRecords(lightMerge,distributions);upDefaults=fluid.defaults(lightMerge.type);var defaultCopy=fluid.copy(upDefaults);lightMerge.toMerge.unshift({options:defaultCopy,recordType:"defaults"});var that=lightMerge.type==="fluid.emptySubcomponent"?null:fluid.typeTag(lightMerge.type,potentia.componentId);if(that){that.lifecycleStatus="constructing";instantiator.recordKnownComponent(parentThat,that,memberName,true);var mergeOptions=fluid.mergeComponentOptions(that,potentia,lightMerge);mergeOptions.exceptions={members:{model:true,modelRelay:true}};that.events={}}return that};fluid.registerConcreteSubPotentia=function(lightMerge,key,componentDepth,parentShell,localRecord,transactionId){componentDepth=componentDepth||0;var newSegs=fluid.pathForComponent(parentShell).concat([key]);var existing=parentShell[key];if(existing){fluid.registerPotentia({segs:newSegs,type:"destroy"},transactionId)}lightMerge.toMerge=fluid.transform(lightMerge.toMerge,(function(toMerge){var record=$.extend({componentDepth:componentDepth+1,sourceComponentId:parentShell.id,recordType:"subcomponentRecord"},toMerge);return record}));lightMerge.type=fluid.expandImmediate(lightMerge.type,parentShell,localRecord);var subPotentia={type:"create",segs:newSegs,lightMerge:lightMerge,localRecord:localRecord};fluid.registerPotentia(subPotentia,transactionId)};fluid.lightMergeComponentRecord=function(shadow,shadowKey,key,mergingArray){var lightMerge=fluid.lightMergeRecords(mergingArray);fluid.set(shadow,[shadowKey,key],lightMerge);return lightMerge};fluid.componentRecordExpected=fluid.arrayToHash(["type","options","container","createOnEvent"]);fluid.dynamicComponentRecordExpected=$.extend({},fluid.componentRecordExpected,fluid.arrayToHash(["source","sources"]));fluid.checkComponentRecord=function(localRecord,expected){if(!fluid.isInjectedComponentRecord(localRecord)){if(fluid.isPlainObject(localRecord,true)){fluid.each(localRecord,(function(value,key){if(!expected[key]){fluid.fail("Error in subcomponent record "+JSON.stringify(localRecord)+' - key "'+key+'" found, where the only legal options are '+fluid.keys(expected).join(", "))}}))}else{fluid.fail("Error in subcomponent record "+JSON.stringify(localRecord)+' - this should either be an object with member "type" or else a reference to another component')}}};fluid.checkSubcomponentRecords=function(subcomponentRecords,expected){subcomponentRecords.forEach((function(oneRecord){fluid.checkComponentRecord(oneRecord,expected)}))};fluid.registerSourcedDynamicComponent=function(potentia,shell,source,sourceKey,lightMerge,key,localRecordContributor){var localRecord=$.extend({},potentia.localRecord,{source:source,sourcePath:sourceKey});(localRecordContributor||fluid.identity)(localRecord,source,sourceKey);var dynamicKey=fluid.computeDynamicComponentKey(key,sourceKey);var freshLightMerge=fluid.copy(lightMerge);fluid.registerConcreteSubPotentia(freshLightMerge,dynamicKey,potentia.componentDepth,shell,localRecord)};fluid.registerSourcedDynamicComponents=function(potentia,shell,sources,lightMerge,key,localRecordContributor){fluid.each(sources,(function(source,sourceKey){fluid.registerSourcedDynamicComponent(potentia,shell,source,sourceKey,lightMerge,key,localRecordContributor)}))};fluid.lensedComponentModelListener=function(that,key,segs,value,isBoolean){var isEmptyValue=function(value){return isBoolean?!value:value===undefined};var shadow=fluid.shadowForComponent(that);var sourceKey=isBoolean?0:fluid.peek(segs);var expectedMemberName=fluid.computeDynamicComponentKey(key,sourceKey);var currentComponent=that[expectedMemberName];if(!isEmptyValue(value)&&!currentComponent){var lightMerge=shadow.lightMergeDynamicComponents[key];var parentRecord=shadow.modelSourcedDynamicComponents[key];fluid.registerSourcedDynamicComponent(shadow.potentia,that,value,sourceKey,lightMerge,key,parentRecord.localRecordContributor)}else if(isEmptyValue(value)&&currentComponent){currentComponent.destroy()}};fluid.lensedComponentDefToBlock=function(key,sourcesParsed,isBoolean){var fromModelPath=sourcesParsed.segs.slice(1);var modelListener={path:{context:sourcesParsed.context,segs:fromModelPath.concat(isBoolean?[]:["*"])},excludeSource:"init",transactional:true,funcName:"fluid.lensedComponentModelListener",args:["{that}",key,"{change}.path","{change}.value",isBoolean]};var modelListeners={};modelListeners["lensedComponents-"+key]=modelListener;return{modelListeners:modelListeners}};fluid.addLensedComponentBlocks=function(lensedComponentBlocks,potentia,shadow){var merged=fluid.extend.apply(null,[true,{}].concat(lensedComponentBlocks));shadow.mergeOptions.mergeBlocks.push(fluid.generateExpandBlock({options:merged,recordType:"lensedComponents",priority:fluid.mergeRecordTypes.lensedComponents},shadow.that,shadow.mergePolicy,potentia.localRecord));shadow.mergeOptions.updateBlocks()};fluid.pushMarkupSourcedDynamicComponentListener=function(shell,key,sourcesParsed,registerDynamicComponents){var namespace=shell.id+"-markupDynamicComponents-"+key;var context=fluid.resolveContext(sourcesParsed.context,shell);if(context.events.onDomBind){context.events.onDomBind.addListener(registerDynamicComponents,namespace)}else{var targetShadow=fluid.shadowForComponent(context);fluid.addLensedComponentBlocks([{listeners:{onDomBind:{namespace:namespace,listener:registerDynamicComponents}}}],{},targetShadow)}};fluid.expectExactlyOne=function(failStart,target,members){var found=0;members.forEach((function(member){if(target[member]!==undefined){++found}}));if(found!==1){fluid.fail.apply(null,failStart.concat([" must contain exactly one member out of "+members.join(", ")]))}};fluid.registerSourcedDynamicComponentsTriage=function(potentia,shell,sourceOrSources,lightMerge,key,isBoolean,localRecordContributor){if(isBoolean&&sourceOrSources){fluid.registerSourcedDynamicComponent(potentia,shell,sourceOrSources,0,lightMerge,key,localRecordContributor)}else{fluid.registerSourcedDynamicComponents(potentia,shell,sourceOrSources,lightMerge,key,localRecordContributor)}};fluid.processComponentShell=function(potentia,shell,transRec){var instantiator=fluid.globalInstantiator;var shadow=instantiator.idToShadow[shell.id];shadow.potentia=potentia;shadow.createdTransactionId=transRec.transactionId;var mergeOptions=shadow.mergeOptions;var components=fluid.driveStrategy(shell.options,"components",mergeOptions.strategy);fluid.each(components,(function(subcomponentRecords,key){fluid.checkSubcomponentRecords(subcomponentRecords,fluid.componentRecordExpected);var lightMerge=fluid.lightMergeComponentRecord(shadow,"lightMergeComponents",key,subcomponentRecords);if(!lightMerge.createOnEvent){fluid.registerConcreteSubPotentia(lightMerge,key,potentia.componentDepth,shell,potentia.localRecord)}}));var dynamicComponents=fluid.driveStrategy(shell.options,"dynamicComponents",mergeOptions.strategy);var lensedComponentBlocks=[];fluid.each(dynamicComponents,(function(subcomponentRecords,key){fluid.checkSubcomponentRecords(subcomponentRecords,fluid.dynamicComponentRecordExpected);var lightMerge=fluid.lightMergeComponentRecord(shadow,"lightMergeDynamicComponents",key,subcomponentRecords);fluid.expectExactlyOne(["dynamicComponents records ",subcomponentRecords],lightMerge,["source","sources","createOnEvent"]);if(lightMerge.sources!==undefined||lightMerge.source!==undefined){var recordSources=lightMerge.sources,isBoolean=false;if(lightMerge.source!==undefined){recordSources=lightMerge.source;isBoolean=true}if(fluid.isIoCReference(recordSources)){var sourcesParsed=fluid.parseValidModelReference(shell,"dynamicComponents source",recordSources,true);var registerDynamicComponents=function(){var sources=fluid.getForComponent(sourcesParsed.that,sourcesParsed.segs);fluid.registerSourcedDynamicComponentsTriage(potentia,shell,sources,lightMerge,key,null,isBoolean)};if(sourcesParsed.nonModel){if(sourcesParsed.segs[0]==="dom"){fluid.pushMarkupSourcedDynamicComponentListener(shell,key,sourcesParsed,registerDynamicComponents)}else{registerDynamicComponents()}}else{fluid.set(shadow,["modelSourcedDynamicComponents",key],{sourcesParsed:sourcesParsed,isBoolean:isBoolean});lensedComponentBlocks.push(fluid.lensedComponentDefToBlock(key,sourcesParsed,isBoolean))}}else{var sources=fluid.expandImmediate(recordSources,shell,potentia.localRecord);fluid.registerSourcedDynamicComponentsTriage(potentia,shell,sources,lightMerge,key,null,isBoolean)}}}));if(lensedComponentBlocks.length){fluid.addLensedComponentBlocks(lensedComponentBlocks,potentia,shadow)}if(transRec.deferredDistributions.length){transRec.pendingPotentiae.creates.push({type:"distributeOptions",distributions:transRec.deferredDistributions});++transRec.pendingPotentiae.activeCount;transRec.deferredDistributions=[]}};fluid.preparePathedPotentia=function(potentia,instantiator){var segs=potentia.segs||instantiator.parseToSegments(potentia.path);potentia.segs=segs;potentia.memberName=fluid.peek(segs);potentia.parentThat=fluid.getImmediate(fluid.rootComponent,segs.slice(0,-1));if(potentia.type==="create"&&!potentia.parentThat){fluid.fail("Cannot construct component at path ",segs," whose parent does not exist")}};fluid.fetchNestedInjectedComponentReference=function(transRec,potentiaList,injected,head,parentPath,segs){var instantiator=fluid.globalInstantiator;var path=parentPath,current=head;for(var i=0;i<segs.length;++i){path=fluid.composePath(path,segs[i]);current=instantiator.pathToComponent[path];if(!current){var upcoming=potentiaList.pathToPotentia[path];if(upcoming){if(upcoming.applied){fluid.fail("Circular reference found when resolving injected component reference ",injected," - the target of the reference is still in construction")}else{current=fluid.operateCreatePotentia(transRec,upcoming);if(current){path=instantiator.idToShadow[current.id].path}}}}if(!current&&i!==segs.length-1){fluid.fail("Failed to resolved injected component reference ",injected," - component at segment "+segs[i]+" was not found")}}return current};fluid.fetchInjectedComponentReference=function(transRec,potentiaList,injected,parentThat){var instantiator=fluid.globalInstantiator;if(injected.expander){return fluid.expandImmediate(injected,parentThat,null,true)}else{var parsed=fluid.parseContextReference(injected);var head=fluid.resolveContext(parsed.context,parentThat);if(!head){if(parsed.path!==""){fluid.fail("Error in injected component reference ",injected," - could not resolve context {"+parsed.context+"} to a head component")}else{return head}}else{var parentPath=instantiator.idToShadow[head.id].path;var segs=fluid.model.parseEL(parsed.path);return fluid.fetchNestedInjectedComponentReference(transRec,potentiaList,injected,head,parentPath,segs)}}};fluid.operateCreatePotentia=function(transRec,potentia){var instantiator=fluid.globalInstantiator;var potentiaList=transRec.pendingPotentiae;fluid.preparePathedPotentia(potentia,instantiator);var memberName=potentia.memberName,parentThat=potentia.parentThat,shell;fluid.pushActivity("operateCreatePotentia",'operating create potentia for path "%path" with records %records',{path:potentia.path,records:potentia.records});potentia.applied=true;--potentiaList.activeCount;var lightMerge=potentia.lightMerge;if(lightMerge.isInjected){parentThat[memberName]=fluid.inEvaluationMarker;shell=fluid.fetchInjectedComponentReference(transRec,potentiaList,lightMerge.toMerge[0].injected,parentThat);if(shell){instantiator.recordKnownComponent(parentThat,shell,memberName,false)}else{delete parentThat[memberName]}}else if(lightMerge.type){shell=fluid.initComponentShell(potentia,lightMerge);if(shell){fluid.processComponentShell(potentia,shell,transRec);var shadow=instantiator.idToShadow[shell.id];transRec.outputShadows.push(shadow)}}else{fluid.fail("Unrecognised material in place of subcomponent "+memberName+" - could not recognise the records ",potentia.records," as designating either an injected or concrete component")}fluid.pushPotentia(transRec.restoreRecords,instantiator,{type:"destroy",segs:potentia.segs});fluid.popActivity();return shell};fluid.operateDestroyPotentia=function(transRec,potentia,instantiator){instantiator=instantiator||fluid.globalInstantiator;fluid.preparePathedPotentia(potentia,instantiator);var that=fluid.getImmediate(fluid.rootComponent,potentia.segs);if(that){instantiator.clearComponent(potentia.parentThat,potentia.memberName,that)}};fluid.lookupWorkflowStage=function(workflowName){if(!workflowName){return fluid.workflowCacheSorted.length}else if(workflowName==="shells"){return 0}else{var found=fluid.find_if(fluid.workflowCacheSorted,(function(workflowEntry){return workflowEntry.workflowName===workflowName}));if(found){return found.index+1}else{fluid.fail("Unknown workflow name "+workflowName+' supplied as "breakAt" for tree transaction: '+": valid names are "+fluid.getMembers(fluid.workflowCacheSorted,"workflowName").join(", "))}}};fluid.evaluateWorkflows=function(shadows,workflowType){var togo=[];fluid.workflowCacheSorted[workflowType].forEach((function(workflowRecord){var workflowShadows=shadows.filter((function(oneShadow){return fluid.componentHasGrade(oneShadow.that,workflowRecord.gradeName)}));if(workflowShadows.length>0){togo.push({shadows:shadows,workflowIndex:workflowRecord.index,workflowOptions:workflowRecord.workflowOptions})}}));return togo};fluid.findWorkflowShadows=function(shadows,blockStart,blockEnd,workflowRecord){var workflowShadows=[];for(var i=blockStart;i<blockEnd;++i){if(fluid.componentHasGrade(shadows[i].that,workflowRecord.gradeName)){if(workflowRecord.workflowType==="global"){workflowShadows.push(shadows[i])}else{workflowShadows.unshift(shadows[i])}}}return workflowShadows};fluid.waitPendingIOTask=function(transRec){var sequence;var waitIOTask=function(){return transRec.pendingIO.length?sequence=fluid.promise.sequence(transRec.pendingIO):null};waitIOTask.taskName="waitIO";waitIOTask.sequence=sequence;return waitIOTask};fluid.enqueueWorkflowBlock=function(transRec,shadows,workflowStart,workflowEnd,blockStart,blockEnd,sequencer){var workQueued=false;var instantiator=fluid.globalInstantiator;var resumeCurrentTransaction=function(){instantiator.currentTreeTransactionId=transRec.transactionId};transRec.lastWorkflowShadow=Math.max(transRec.lastWorkflowShadow,blockEnd);fluid.forEachInRange(fluid.workflowCacheSorted,workflowStart,workflowEnd,(function(workflowRecord,workflowIndex){if(workflowIndex===0){for(var i=blockStart;i<blockEnd;++i){fluid.instantiateEvents(shadows[i])}}var workflowShadows=fluid.findWorkflowShadows(shadows,blockStart,blockEnd,workflowRecord);transRec.maximumWorkflowStage=Math.max(transRec.maximumWorkflowStage,workflowIndex+1);if(workflowShadows.length>0){var workflow=workflowRecord.workflowOptions;var workflowFunc=fluid.getGlobalValue(workflow.funcName);var sequence=sequencer.sources;if(workflow.waitIO){sequence.push(fluid.waitPendingIOTask(transRec))}if(workflowRecord.workflowType==="global"){var globalWorkflowTask=function(){resumeCurrentTransaction();workflowFunc(workflowShadows,transRec)};globalWorkflowTask.taskName=workflowRecord.namespace;sequence.push(globalWorkflowTask)}else{var localWorkflowTask=function(){resumeCurrentTransaction();if(workflowRecord.namespace==="concludeComponentInit"){sequencer.hasStartedConcludeInit=true}workflowShadows.forEach((function(shadow){workflowFunc(shadow,transRec)}))};localWorkflowTask.taskName=workflowRecord.namespace;sequence.push(localWorkflowTask)}workQueued=true}}));if(transRec.maximumWorkflowStage===transRec.workflowStageBreak){transRec.maximumWorkflowStage=0;transRec.restartLastWorkflowShadow=transRec.lastWorkflowShadow}return workQueued};fluid.applyWorkflowPhase=function(transRec,sequencer){var shadows=transRec.outputShadows;if(shadows.length>transRec.lastWorkflowShadow&&transRec.maximumWorkflowStage>0){fluid.enqueueWorkflowBlock(transRec,shadows,0,transRec.maximumWorkflowStage,transRec.lastWorkflowShadow,shadows.length,sequencer);return true}else if(transRec.maximumWorkflowStage<transRec.workflowStageBreak){for(var workflowStage=transRec.maximumWorkflowStage;workflowStage<transRec.workflowStageBreak;++workflowStage){var workQueued=fluid.enqueueWorkflowBlock(transRec,shadows,workflowStage,workflowStage+1,transRec.restartLastWorkflowShadow,shadows.length,sequencer);if(workQueued){return workQueued}}}return false};fluid.commitPotentiaePhase=function(transRec){var pendingPotentiae=transRec.pendingPotentiae;pendingPotentiae.destroys.forEach((function(potentia){if(!potentia.applied){potentia.applied=true;--pendingPotentiae.activeCount;fluid.operateDestroyPotentia(transRec,potentia)}}));for(var i=0;i<pendingPotentiae.creates.length;++i){var potentia=pendingPotentiae.creates[i];if(!potentia.applied){if(potentia.type==="create"){fluid.operateCreatePotentia(transRec,potentia)}else if(potentia.type==="distributeOptions"){potentia.distributions.forEach((function(distro){fluid.distributeOptionsOne(distro.that,distro.record,distro.targetRef,distro.selector,distro.context)}));potentia.applied=true;--pendingPotentiae.activeCount}else{fluid.fail("Unrecognised potentia type "+potentia.type)}}}};fluid.isPopulatedPotentiaList=function(potentiaList){return potentiaList.activeCount>0};fluid.commitPotentiae=function(transactionId,resumeSequencer){var instantiator=fluid.globalInstantiator;var transRec=instantiator.treeTransactions[transactionId];++transRec.commitDepth;var lastWorkflowShadow=transRec.lastWorkflowShadow;var rootSequencer=transRec.rootSequencer;var sequencer=resumeSequencer;if(!sequencer){var topSequencer=fluid.getImmediate(fluid.peek(rootSequencer.sources),["sequencer"]);if(!topSequencer||topSequencer.hasStartedConcludeInit||topSequencer.promise.disposition){sequencer=fluid.promise.makeSequencer([],{},fluid.promise.makeSequenceStrategy());sequencer.promise.sequencer=sequencer;rootSequencer.sources.push(sequencer.promise)}else{sequencer=topSequencer}}fluid.tryCatch((function commitPotentiae(){if(fluid.isPopulatedPotentiaList(transRec.pendingPotentiae)){fluid.commitPotentiaePhase(transRec)}var workflowEnqueued=fluid.applyWorkflowPhase(transRec,sequencer);if(workflowEnqueued){sequencer.sources.push((function(){if(!sequencer.hasStartedConcludeInit){fluid.commitPotentiae(transactionId,sequencer)}else if(sequencer===fluid.peek(rootSequencer.sources).sequencer){fluid.commitPotentiae(transactionId,null)}}))}if(!sequencer.sequenceStarted){fluid.promise.resumeSequence(sequencer)}if(!rootSequencer.sequenceStarted){fluid.promise.resumeSequence(rootSequencer)}}),(function(e){if(!transRec.promise.disposition){transRec.promise.reject(e)}}));--transRec.commitDepth;if(transRec.commitDepth===0&&!resumeSequencer){instantiator.currentTreeTransactionId=null}return transRec.outputShadows[lastWorkflowShadow]};fluid.pushPotentia=function(potentiaList,instantiator,potentia){var segs=potentia.segs=potentia.segs||instantiator.parseToSegments(potentia.path);var path=potentia.path=instantiator.composeSegments.apply(null,segs);if(potentia.type==="destroy"){potentiaList.destroys.push(potentia);potentiaList.activeCount++;fluid.remove_if(potentiaList.creates,(function(create){if(!create.applied&&create.path.startsWith(potentia.path)){potentiaList.activeCount--;return true}}))}else{var newPotentia=potentia;if(potentia.type==="create"){newPotentia=fluid.pushCreatePotentia(potentiaList,path,potentia)}if(newPotentia){potentiaList.creates.push(potentia);potentiaList.activeCount++}}};fluid.pathForComponent=function(component,instantiator){instantiator=instantiator||fluid.getInstantiator(component)||fluid.globalInstantiator;var shadow=instantiator.idToShadow[component.id];if(!shadow){return null}return instantiator.parseEL(shadow.path)};fluid.currentTreeTransaction=function(){var instantiator=fluid.globalInstantiator;return instantiator.treeTransactions[instantiator.currentTreeTransactionId]};fluid.clearTreeTransaction=function(transRec){transRec.rootSequencer=fluid.promise.makeSequencer([],{},fluid.promise.makeSequenceStrategy());transRec.restoreRecords=fluid.blankPotentiaList();transRec.initModelTransaction={};transRec.outputShadows=[];transRec.lastWorkflowShadow=0;transRec.maximumWorkflowStage=0;transRec.restartLastWorkflowShadow=0;transRec.deferredDistributions=[]};fluid.beginTreeTransaction=function(transactionOptions){var instantiator=fluid.globalInstantiator;if(instantiator.currentTreeTransactionId){fluid.fail("Attempt to start new tree transaction when transaction "+instantiator.currentTreeTransactionId+" is already active")}var transactionId=instantiator.currentTreeTransactionId=fluid.allocateGuid();var transRec=$.extend({transactionId:transactionId,workflowStageBreak:undefined,pendingPotentiae:fluid.blankPotentiaList(),commitDepth:0,cancelled:false,cancellationError:null,pendingIO:[]},transactionOptions);fluid.clearTreeTransaction(transRec);transRec.promise=transRec.rootSequencer.promise;var onConclude=function(){instantiator.events.onEndTreeTransaction.fire(transRec);if(transRec.rootSequencer.promise.disposition){instantiator.currentTreeTransactionId=null;delete instantiator.treeTransactions[transactionId]}};var onException=function(err){if(!transRec.cancelled){delete transRec.rootSequencer;instantiator.inEvaluationPaths.length=0;fluid.cancelTreeTransaction(transactionId,instantiator,err);onConclude()}};transRec.promise.then(onConclude,onException);instantiator.treeTransactions[transactionId]=transRec;try{transRec.workflowStageBreak=fluid.lookupWorkflowStage(transRec.breakAt)}catch(e){transRec.promise.reject(e)}instantiator.events.onBeginTreeTransaction.fire(transRec);return transRec};fluid.registerPotentia=function(potentia,transactionId){var instantiator=fluid.globalInstantiator;transactionId=transactionId||instantiator.currentTreeTransactionId;if(!transactionId){transactionId=fluid.beginTreeTransaction().transactionId}var transRec=instantiator.treeTransactions[transactionId];fluid.pushPotentia(transRec.pendingPotentiae,instantiator,potentia);return transRec};fluid.cancelTreeTransaction=function(transactionId,instantiator){var transRec=instantiator.treeTransactions[transactionId];if(transRec){try{transRec.pendingPotentiae=transRec.restoreRecords;transRec.cancelled=true;fluid.clearTreeTransaction(transRec);fluid.commitPotentiae(transactionId)}catch(e){fluid.log(fluid.logLevel.FAIL,"Fatal error cancelling transaction "+transactionId+": destroying all affected paths");transRec.restoreRecords.creates.forEach((function(potentia){instantiator.clearComponent(potentia.parentThat,potentia.memberName,potentia.parentThat[potentia.memberName])}));throw e}}};fluid.constructChild=function(parent,memberName,options){var parentPath=fluid.pathForComponent(parent);var path=parentPath.concat([memberName]);return fluid.construct(path,options)};fluid.construct=function(path,componentOptions,constructOptions){constructOptions=constructOptions||{};var transRec=fluid.registerPotentia({path:path,type:"destroy"},constructOptions.transactionId);var record={recordType:"user"};fluid.each(fluid.componentRecordExpected,(function(troo,key){if(componentOptions[key]!==undefined){record[key]=componentOptions[key]}}));record.options=componentOptions;var potentia={path:path,type:"create",localRecord:constructOptions.localRecord,records:[record]};fluid.registerPotentia(potentia,transRec.transactionId);if(!constructOptions.transactionId){fluid.commitPotentiae(transRec.transactionId)}fluid.adaptTransactionFailure(transRec);return constructOptions.returnTransaction?transRec:fluid.getImmediate(fluid.rootComponent,potentia.segs)};fluid.destroy=function(path,instantiator){instantiator=instantiator||fluid.globalInstantiator;var segs=instantiator.parseToSegments(path);if(segs.length===0){fluid.fail("Cannot destroy the root component")}var transRec=fluid.registerPotentia({path:path,type:"destroy"});fluid.commitPotentiae(transRec.transactionId);return transRec};fluid.constructSingle=function(parentPath,options,instantiator){instantiator=instantiator||fluid.globalInstantiator;parentPath=parentPath||"";var segs=fluid.model.parseToSegments(parentPath,instantiator.parseEL,true);if(typeof options==="string"){options={type:options}}var type=options.type;if(!type){fluid.fail("Cannot construct singleton object without a type entry")}options=$.extend({},options);var gradeNames=options.gradeNames=fluid.makeArray(options.gradeNames);gradeNames.unshift(type);options.type="fluid.component";var root=segs.length===0;if(root){gradeNames.push("fluid.resolveRoot")}var memberName=fluid.typeNameToMemberName(options.singleRootType||type);segs.push(memberName);return fluid.construct(segs,options)};fluid.destroySingle=function(parentPath,typeName,instantiator){instantiator=instantiator||fluid.globalInstantiator;var segs=fluid.model.parseToSegments(parentPath,instantiator.parseEL,true);var memberName=fluid.typeNameToMemberName(typeName);segs.push(memberName);fluid.destroy(segs,instantiator)};fluid.makeGradeLinkage=function(linkageName,inputNames,outputNames){fluid.defaults(linkageName,{gradeNames:"fluid.component",distributeOptions:{record:outputNames,target:"{/ "+inputNames.join("&")+"}.options.gradeNames"}});fluid.constructSingle([],linkageName)};fluid.componentForPath=function(path){return fluid.globalInstantiator.pathToComponent[fluid.isArrayable(path)?path.join("."):path]};fluid.thisistToApplicable=function(record,recthis,that){return{apply:function(noThis,args){var resolvedThis=fluid.expandImmediate(recthis,that);if(typeof resolvedThis==="string"){resolvedThis=fluid.getGlobalValue(resolvedThis)}if(!resolvedThis){fluid.fail("Could not resolve reference "+recthis+" to a value")}var resolvedFunc=resolvedThis[record.method];if(typeof resolvedFunc!=="function"){fluid.fail("Object ",resolvedThis," at reference "+recthis+" has no member named "+record.method+" which is a function ")}if(fluid.passLogLevel(fluid.logLevel.TRACE)){fluid.log(fluid.logLevel.TRACE,"Applying arguments ",args," to method "+record.method+" of instance ",resolvedThis)}return resolvedFunc.apply(resolvedThis,args)}}};fluid.changeToApplicable=function(record,that){fluid.getForComponent(that,"applier");var parsed=fluid.parseValidModelReference(that,"changePath listener record",record.changePath);fluid.materialiseModelPath(parsed.that,parsed.modelSegs);return{apply:function(noThis,args,localRecord,mergeRecord){var value;if(record.func||record.funcName){var invoker=fluid.makeInvoker(that,fluid.filterKeys(record,["func","funcName","args"]),"changePath listener record",localRecord);value=invoker()}else{value=fluid.expandImmediate(record.value,that,fluid.extend(localRecord,{arguments:args}))}var sources=mergeRecord&&mergeRecord.source&&mergeRecord.source.length?fluid.makeArray(record.source).concat(mergeRecord.source):record.source;parsed.applier.change(parsed.modelSegs,value,record.type,sources)}}};fluid.recordToApplicable=function(record,that,standard){if(record.changePath!==undefined){return fluid.changeToApplicable(record,that,standard)}var recthis=record["this"];if(record.method^recthis){fluid.fail("Record ",that,' must contain both entries "method" and "this" if it contains either')}return record.method?fluid.thisistToApplicable(record,recthis,that):null};fluid.getGlobalValueNonComponent=function(funcName,context){var defaults=fluid.defaults(funcName);if(defaults&&fluid.hasGrade(defaults,"fluid.component")){fluid.fail("Error in function specification - cannot invoke function "+funcName+" in the context of "+context+": component creator functions can only be used as subcomponents")}return fluid.getGlobalValue(funcName)};fluid.makeInvoker=function(that,invokerec,name,localRecord){invokerec=fluid.upgradePrimitiveFunc(invokerec);if(invokerec.args!==undefined&&invokerec.args!==fluid.NO_ARGUMENTS&&!fluid.isArrayable(invokerec.args)){invokerec.args=fluid.makeArray(invokerec.args)}var func=fluid.recordToApplicable(invokerec,that);var invokePre=fluid.preExpand(invokerec.args);localRecord=localRecord||{};var expandOptions=fluid.makeStackResolverOptions(that,localRecord,true);func=func||(invokerec.funcName?fluid.getGlobalValueNonComponent(invokerec.funcName,"an invoker"):fluid.expandImmediate(invokerec.func,that));if(!func||!func.apply){fluid.fail("Error in invoker record: could not resolve members func, funcName or method to a function implementation - got "+func+" from ",invokerec)}else if(func===fluid.notImplemented){fluid.fail("Error constructing component "+fluid.dumpComponentAndPath(that)+" - the invoker named "+name+" which was defined in grade "+invokerec.componentSource+" needs to be overridden with a concrete implementation")}return function invokeInvoker(){if(fluid.defeatLogging===false){fluid.pushActivity("invokeInvoker","invoking invoker with name %name and record %record holding component %that",{name:name,record:invokerec,that:that})}var togo,finalArgs;if(that.lifecycleStatus==="destroyed"){fluid.log(fluid.logLevel.WARN,"Ignoring call to invoker "+name+" of component "+fluid.dumpComponentAndPath(that)+" which has been destroyed")}else{localRecord.arguments=arguments;if(invokerec.args===undefined||invokerec.args===fluid.NO_ARGUMENTS){finalArgs=arguments}else{fluid.expandImmediateImpl(invokePre,expandOptions);finalArgs=invokePre.source}togo=func.apply(null,finalArgs)}if(fluid.defeatLogging===false){fluid.popActivity()}return togo}};fluid.event.makeTrackedListenerAdder=function(source){var shadow=fluid.shadowForComponent(source);return function(event){return{addListener:function(listener,namespace,priority,softNamespace,listenerId){fluid.recordListener(event,listener,shadow,listenerId);event.addListener.apply(null,arguments)}}}};fluid.event.listenerEngine=function(eventSpec,callback,adder){var argstruc={};function checkFire(){var notall=fluid.find(eventSpec,(function(value,key){if(argstruc[key]===undefined){return true}}));if(!notall){var oldstruc=argstruc;argstruc={};callback(oldstruc)}}fluid.each(eventSpec,(function(event,eventName){adder(event).addListener((function(){argstruc[eventName]=fluid.makeArray(arguments);checkFire()}))}))};fluid.event.dispatchListener=function(that,listener,eventName,eventSpec,wrappedArgs){if(eventSpec.args!==undefined&&eventSpec.args!==fluid.NO_ARGUMENTS&&!fluid.isArrayable(eventSpec.args)){eventSpec.args=fluid.makeArray(eventSpec.args)}listener=fluid.event.resolveListener(listener);var dispatchPre=fluid.preExpand(eventSpec.args);var localRecord={};var expandOptions=fluid.makeStackResolverOptions(that,localRecord,true);var togo=function(){if(fluid.defeatLogging===false){fluid.pushActivity("dispatchListener","firing to listener to event named %eventName of component %that",{eventName:eventName,that:that})}var args=wrappedArgs?arguments[0]:arguments,finalArgs;localRecord.arguments=args;if(eventSpec.args!==undefined&&eventSpec.args!==fluid.NO_ARGUMENTS){fluid.expandImmediateImpl(dispatchPre,expandOptions);finalArgs=dispatchPre.source}else{finalArgs=args}var togo=listener.apply(null,finalArgs);if(fluid.defeatLogging===false){fluid.popActivity()}return togo};fluid.event.impersonateListener(listener,togo);return togo};fluid.event.resolveSoftNamespace=function(key){if(typeof key!=="string"){return null}else{var lastpos=Math.max(key.lastIndexOf("."),key.lastIndexOf("}"));return key.substring(lastpos+1)}};fluid.event.resolveListenerRecord=function(lisrec,that,eventName,namespace,standard){var badRec=function(record,extra){fluid.fail("Error in listener record - could not resolve reference ",record," to a listener or firer. "+'Did you miss out "events." when referring to an event firer?'+extra)};fluid.pushActivity("resolveListenerRecord","resolving listener record for event named %eventName for component %that",{eventName:eventName,that:that});var records=fluid.makeArray(lisrec);var transRecs=fluid.transform(records,(function(record){var expanded=fluid.isPrimitive(record)||record.expander?{listener:record}:fluid.copy(record);var methodist=fluid.recordToApplicable(record,that,standard);if(methodist){expanded.listener=methodist}else{expanded.listener=expanded.listener||expanded.func||expanded.funcName}if(!expanded.listener){badRec(record,' Listener record must contain a member named "listener", "func", "funcName" or "method"')}var softNamespace=record.method?fluid.event.resolveSoftNamespace(record["this"])+"."+record.method:fluid.event.resolveSoftNamespace(expanded.listener);if(!expanded.namespace&&!namespace&&softNamespace){expanded.softNamespace=true;expanded.namespace=(record.componentSource?record.componentSource:that.typeName)+"."+softNamespace}var listener=expanded.listener=fluid.expandOptions(expanded.listener,that);if(!listener){badRec(record,"")}var firer=false;if(listener.typeName==="fluid.event.firer"){listener=listener.fire;firer=true}expanded.listener=standard&&(expanded.args&&listener!=="fluid.notImplemented"||firer)?fluid.event.dispatchListener(that,listener,eventName,expanded):listener;expanded.listenerId=fluid.allocateGuid();return expanded}));var togo={records:transRecs,adderWrapper:standard?fluid.event.makeTrackedListenerAdder(that):null};fluid.popActivity();return togo};fluid.event.expandOneEvent=function(that,event){var origin;if(typeof event==="string"&&event.charAt(0)!=="{"){origin=fluid.getForComponent(that,["events",event])}else{origin=fluid.expandOptions(event,that)}if(!origin||origin.typeName!=="fluid.event.firer"){fluid.fail("Error in event specification - could not resolve base event reference ",event," to an event firer: got ",origin)}return origin};fluid.event.expandEvents=function(that,event){return typeof event==="string"?fluid.event.expandOneEvent(that,event):fluid.transform(event,(function(oneEvent){return fluid.event.expandOneEvent(that,oneEvent)}))};fluid.event.resolveEvent=function(that,eventName,eventSpec){fluid.pushActivity("resolveEvent","resolving event with name %eventName attached to component %that",{eventName:eventName,that:that});var adder=fluid.event.makeTrackedListenerAdder(that);if(typeof eventSpec==="string"){eventSpec={event:eventSpec}}var event=eventSpec.typeName==="fluid.event.firer"?eventSpec:eventSpec.event||eventSpec.events;if(!event){fluid.fail("Event specification for event with name "+eventName+" does not include a base event specification: ",eventSpec)}var origin=event.typeName==="fluid.event.firer"?event:fluid.event.expandEvents(that,event);var isMultiple=origin.typeName!=="fluid.event.firer";var isComposite=eventSpec.args||isMultiple;var firer;if(isComposite){firer=fluid.makeEventFirer({name:" [composite] "+fluid.event.nameEvent(that,eventName)});var dispatcher=fluid.event.dispatchListener(that,firer.fire,eventName,eventSpec,isMultiple);if(isMultiple){fluid.event.listenerEngine(origin,dispatcher,adder)}else{adder(origin).addListener(dispatcher)}}else{firer={typeName:"fluid.event.firer"};firer.fire=function(){var outerArgs=fluid.makeArray(arguments);fluid.pushActivity("fireSynthetic","firing synthetic event %eventName ",{eventName:eventName});var togo=origin.fire.apply(null,outerArgs);fluid.popActivity();return togo};firer.addListener=function(listener,namespace,priority,softNamespace,listenerId){var dispatcher=fluid.event.dispatchListener(that,listener,eventName,eventSpec);adder(origin).addListener(dispatcher,namespace,priority,softNamespace,listenerId)};firer.removeListener=function(listener){origin.removeListener(listener)};firer.originEvent=origin}fluid.popActivity();return firer};fluid.coerceToPrimitive=function(string){return string==="false"?false:string==="true"?true:isFinite(string)?Number(string):string};fluid.compactStringToRec=function(string,type){var openPos=string.indexOf("(");var closePos=string.indexOf(")");if(openPos===-1^closePos===-1||openPos>closePos){fluid.fail("Badly-formed compact "+type+" record without matching parentheses: "+string)}if(openPos!==-1&&closePos!==-1){var trail=string.substring(closePos+1);if(trail.trim()!==""){fluid.fail("Badly-formed compact "+type+" record "+string+" - unexpected material following close parenthesis: "+trail)}var prefix=string.substring(0,openPos);var body=string.substring(openPos+1,closePos).trim();var args=body===""?[]:fluid.transform(body.split(","),(function(str){return str.trim()}),fluid.coerceToPrimitive);var togo=fluid.upgradePrimitiveFunc(prefix,null);togo.args=args;return togo}else if(type==="expander"){fluid.fail("Badly-formed compact expander record without parentheses: "+string)}return string};fluid.expandPrefix="@expand:";fluid.expandCompactString=function(string,active){var rec=string;if(string.indexOf(fluid.expandPrefix)===0){var rem=string.substring(fluid.expandPrefix.length);rec={expander:fluid.compactStringToRec(rem,"expander")}}else if(active){rec=fluid.compactStringToRec(string,active)}return rec};var singularPenRecord={listeners:"listener",modelListeners:"modelListener"};var singularRecord=$.extend({invokers:"invoker"},singularPenRecord);fluid.expandCompactRec=function(segs,target,source){fluid.guardCircularExpansion(segs,segs.length);var pen=fluid.peek(segs);var active=singularRecord[pen];if(!active&&segs.length>1){active=singularPenRecord[segs[segs.length-2]]}fluid.each(source,(function(value,key){if(fluid.isPlainObject(value)){target[key]=fluid.freshContainer(value);segs.push(key);fluid.expandCompactRec(segs,target[key],value);segs.pop();return}else if(typeof value==="string"){value=fluid.expandCompactString(value,active)}target[key]=value}))};fluid.expandCompact=function(options){var togo={};fluid.expandCompactRec([],togo,options);return togo};fluid.extractEL=function(string,options){if(options.ELstyle==="ALL"||options.ELstyle==="{}"){return string}else if(options.ELstyle.length===1){if(string.charAt(0)===options.ELstyle){return string.substring(1)}}else if(options.ELstyle==="${}"){var i1=string.indexOf("${");var i2=string.lastIndexOf("}");if(i1===0&&i2!==-1){return string.substring(2,i2)}}};fluid.extractELWithContext=function(string,options){var EL=fluid.extractEL(string,options);if(fluid.isIoCReference(EL)){return fluid.parseContextReference(EL)}else if(options.ELstyle==="{}"){return null}return EL?{path:EL}:EL};fluid.parseContextReference=function(reference,index,delimiter){index=index||0;var isNested=reference.charAt(index+1)==="{",endcpos,context,nested;if(isNested){nested=fluid.parseContextReference(reference,index+1,"}");endcpos=nested.endpos}else{endcpos=reference.indexOf("}",index+1)}if(endcpos===-1){fluid.fail('Cannot parse context reference "'+reference+'": Malformed context reference without }')}if(isNested){context=nested}else{context=reference.substring(index+1,endcpos)}var endpos=delimiter?reference.indexOf(delimiter,endcpos+1):reference.length;var path=reference.substring(endcpos+1,endpos);if(path.charAt(0)==="."){path=path.substring(1)}return{context:context,path:path,endpos:endpos}};fluid.renderContextReference=function(parsed){var context=parsed.context;return"{"+(fluid.isPrimitive(context)?context:fluid.renderContextReference(context))+"}"+(parsed.path?"."+parsed.path:"")};fluid.resolveContextValue=function(string,options){function fetch(parsed){fluid.pushActivity("resolveContextValue","resolving context value %parsed",{parsed:parsed});var togo=options.fetcher(parsed);fluid.pushActivity("resolvedContextValue","resolved value %parsed to value %value",{parsed:parsed,value:togo});fluid.popActivity(2);return togo}var parsed;if(options.bareContextRefs&&fluid.isIoCReference(string)){parsed=fluid.parseContextReference(string);return fetch(parsed)}else if(options.ELstyle&&options.ELstyle!=="${}"){parsed=fluid.extractELWithContext(string,options);if(parsed){return fetch(parsed)}}if(options.ELstyle==="${}"){while(typeof string==="string"){var i1=string.indexOf("${");var i2=string.indexOf("}",i1+2);if(i1!==-1&&i2!==-1){if(string.charAt(i1+2)==="{"){parsed=fluid.parseContextReference(string,i1+2,"}");i2=parsed.endpos}else{parsed={path:string.substring(i1+2,i2)}}var subs=fetch(parsed);var all=i1===0&&i2===string.length-1;if(subs===undefined||subs===null){return subs}string=all?subs:string.substring(0,i1)+subs+string.substring(i2+1)}else{break}}}return string};fluid.fetchExpandChildren=function(target,i,segs,source,mergePolicy,options){if(source.expander){var expanded=fluid.expandExpander(target,source,options);if(fluid.isPrimitive(expanded)||!fluid.isPlainObject(expanded)||fluid.isArrayable(expanded)^fluid.isArrayable(target)){return expanded}else{$.extend(true,target,expanded)}}fluid.each(source,(function(newSource,key){if(newSource===undefined){target[key]=undefined}else if(key!=="expander"){segs[i]=key;if(fluid.getImmediate(options.exceptions,segs,i)!==true){options.strategy(target,key,i+1,segs,source,mergePolicy)}}}));return target};fluid.isUnexpandable=function(source){return fluid.isPrimitive(source)||!fluid.isPlainObject(source)};fluid.expandSource=function(options,target,i,segs,deliverer,source,policy,recurse){var expanded,isTrunk;var thisPolicy=fluid.derefMergePolicy(policy);if(typeof source==="string"&&!thisPolicy.noexpand){if(!options.defaultEL||source.charAt(0)==="{"){fluid.pushActivity("expandContextValue","expanding context value %source held at path %path",{source:source,path:fluid.path.apply(null,segs.slice(0,i))});expanded=fluid.copy(fluid.resolveContextValue(source,options));fluid.popActivity(1)}else{expanded=source}}else if(thisPolicy.noexpand||fluid.isUnexpandable(source)){expanded=fluid.copy(source)}else if(source.expander){expanded=fluid.expandExpander(deliverer,source,options)}else{expanded=fluid.freshContainer(source);isTrunk=true}if(expanded!==fluid.NO_VALUE){deliverer(expanded)}if(isTrunk){recurse(expanded,source,i,segs,policy)}return expanded};fluid.guardCircularExpansion=function(segs,i){if(i>fluid.strategyRecursionBailout){fluid.fail("Overflow/circularity in options expansion, current path is ",segs," at depth ",i,' - please ensure options are not circularly connected, or protect from expansion using the "noexpand" policy or expander')}};fluid.makeExpandStrategy=function(options){var recurse=function(target,source,i,segs,policy){return fluid.fetchExpandChildren(target,i||0,segs||[],source,policy,options)};var strategy=function(target,name,i,segs,source,policy){fluid.guardCircularExpansion(segs,i);if(!target){return}if(target.hasOwnProperty(name)){return target[name]}if(source===undefined){source=fluid.regenerateCursor(options.source,segs,i-1,options.sourceStrategy);policy=fluid.regenerateCursor(options.mergePolicy,segs,i-1,fluid.concreteTrundler)}var thisSource=options.sourceStrategy(source,name,i,segs);var thisPolicy=fluid.concreteTrundler(policy,name);function deliverer(value){target[name]=value}return fluid.expandSource(options,target,i,segs,deliverer,thisSource,thisPolicy,recurse)};options.recurse=recurse;options.strategy=strategy;return strategy};fluid.defaults("fluid.makeExpandOptions",{ELstyle:"${}",bareContextRefs:true,target:fluid.inCreationMarker});fluid.makeExpandOptions=function(source,options){options=$.extend({},fluid.rawDefaults("fluid.makeExpandOptions"),options);options.defaultEL=options.ELStyle==="${}"&&options.bareContextRefs;options.expandSource=function(source){return fluid.expandSource(options,null,0,[],fluid.identity,source,options.mergePolicy,false)};if(!fluid.isUnexpandable(source)){options.source=source;options.target=fluid.freshContainer(source);options.sourceStrategy=options.sourceStrategy||fluid.concreteTrundler;fluid.makeExpandStrategy(options);options.initter=function(){options.target=fluid.fetchExpandChildren(options.target,0,[],options.source,options.mergePolicy,options)}}else{options.strategy=fluid.concreteTrundler;options.initter=fluid.identity;if(typeof source==="string"){options.target=(options.defer?fluid.copy:fluid.identity)(options.expandSource(source))}else{options.target=source}options.immutableTarget=true}return options};fluid.expand=function(source,options){var expandOptions=fluid.makeExpandOptions(source,options);expandOptions.initter();return expandOptions.target};fluid.preExpandRecurse=function(root,source,holder,member,rootSegs){fluid.guardCircularExpansion(rootSegs,rootSegs.length);function pushExpander(expander){root.expanders.push({expander:expander,holder:holder,member:member});delete holder[member]}if(fluid.isIoCReference(source)){var parsed=fluid.parseContextReference(source);var segs=fluid.model.parseEL(parsed.path);pushExpander({typeFunc:fluid.expander.fetch,context:parsed.context,segs:segs})}else if(fluid.isPlainObject(source)){if(source.expander){source.expander.typeFunc=fluid.getGlobalValue(source.expander.type||"fluid.expander.invokeFunc");pushExpander(source.expander)}else{fluid.each(source,(function(value,key){rootSegs.push(key);fluid.preExpandRecurse(root,value,source,key,rootSegs);rootSegs.pop()}))}}};fluid.preExpand=function(source){var root={expanders:[],source:fluid.isUnexpandable(source)?source:fluid.copy(source)};fluid.preExpandRecurse(root,root.source,root,"source",[]);return root};fluid.expandImmediate=function(source,that,localRecord,noproxy){var options=fluid.makeStackResolverOptions(that,localRecord,true);options.noproxy=!!noproxy;var root=fluid.preExpand(source);fluid.expandImmediateImpl(root,options);return root.source};fluid.expandImmediateImpl=function(root,options){var expanders=root.expanders;for(var i=0;i<expanders.length;++i){var expander=expanders[i];expander.holder[expander.member]=expander.expander.typeFunc(null,expander,options)}};fluid.expandExpander=function(deliverer,source,options){var expander=fluid.getGlobalValue(source.expander.type||"fluid.expander.invokeFunc");if(!expander){fluid.fail("Unknown expander with type "+source.expander.type)}return expander(deliverer,source,options)};fluid.proxyComponentHandler=function(target,prop){return prop===Symbol.toStringTag?Object.prototype.toString.call(target):prop in target?target[prop]:fluid.getForComponent(target,prop)};fluid.proxyComponent=function(component){var shadow=fluid.shadowForComponent(component);if(!shadow.proxy){shadow.proxy=new Proxy(component,{get:fluid.proxyComponentHandler})}return shadow.proxy};fluid.possiblyProxyComponent=function(value){return fluid.isComponent(value)&&value.lifecycleStatus!=="treeConstructed"?fluid.proxyComponent(value):value};fluid.proxyComponentArgs=function(args){args.forEach((function(arg,i){args[i]=fluid.possiblyProxyComponent(arg)}))};fluid.registerNamespace("fluid.expander");fluid.expander.fetch=function(deliverer,source,options){var localRecord=options.localRecord,context=source.expander.context,segs=source.expander.segs;var inLocal=localRecord[context]!==undefined;var contextStatus=options.contextThat.lifecycleStatus;var fast=contextStatus==="treeConstructed"||contextStatus==="destroyed";var component=inLocal?localRecord[context]:fluid.resolveContext(context,options.contextThat,fast);if(component!==undefined){var root=component;if(inLocal||component.lifecycleStatus!=="constructing"){for(var i=0;i<segs.length;++i){root=root?root[segs[i]]:undefined}}else{root=fluid.getForComponent(component,segs)}if(root===undefined&&!inLocal){root=fluid.getForComponent(component,segs)}if(!fast&&!options.noproxy&&fluid.isComponent(root)){return fluid.proxyComponent(root)}return root}else if(segs.length>0){fluid.triggerMismatchedPathError(source.expander,options.contextThat)}};fluid.expander.invokeFunc=function(deliverer,source,options){var expander=source.expander;var args=fluid.makeArray(expander.args);var whichFuncEntry=expander.func?"func":expander.funcName?"funcName":null;expander.args=args;if(options.recurse){args=options.recurse([],args)}else{expander=fluid.expandImmediate(expander,options.contextThat,options.localRecord,expander.noproxy);args=expander.args}if(!expander.noproxy){fluid.proxyComponentArgs(args)}var funcEntry=expander[whichFuncEntry];var func=(options.expandSource?options.expandSource(funcEntry):funcEntry)||fluid.recordToApplicable(expander,options.contextThat);if(typeof func==="string"){func=fluid.getGlobalValue(func)}if(!func){fluid.fail("Error in expander record ",source.expander,": "+source.expander[whichFuncEntry]+" could not be resolved to a function for component ",options.contextThat)}return func.apply(null,args)};fluid.expander.noexpand=function(deliverer,source){return source.expander.value?source.expander.value:source.expander.tree};fluid.noexpand=fluid.expander.noexpand;"use strict";fluid.model.makeEnvironmentStrategy=function(environment){return function(root,segment,index){return index===0&&environment[segment]?environment[segment]:undefined}};fluid.model.defaultCreatorStrategy=function(root,segment){if(root[segment]===undefined){root[segment]={};return root[segment]}};fluid.model.defaultFetchStrategy=function(root,segment){return root[segment]};fluid.model.funcResolverStrategy=function(root,segment){if(root.resolvePathSegment){return root.resolvePathSegment(segment)}};fluid.model.traverseWithStrategy=function(root,segs,initPos,config,uncess){var strategies=config.strategies;var limit=segs.length-uncess;for(var i=initPos;i<limit;++i){if(!root){return root}var accepted;for(var j=0;j<strategies.length;++j){accepted=strategies[j](root,segs[i],i+1,segs);if(accepted!==undefined){break}}if(accepted===fluid.NO_VALUE){accepted=undefined}root=accepted}return root};fluid.model.getValueAndSegments=function(root,EL,config,initSegs){return fluid.model.accessWithStrategy(root,EL,fluid.NO_VALUE,config,initSegs,true)};fluid.model.makeTrundler=function(config){return function(valueSeg,EL){return fluid.model.getValueAndSegments(valueSeg.root,EL,config,valueSeg.segs)}};fluid.model.getWithStrategy=function(root,EL,config,initSegs){return fluid.model.accessWithStrategy(root,EL,fluid.NO_VALUE,config,initSegs)};fluid.model.setWithStrategy=function(root,EL,newValue,config,initSegs){fluid.model.accessWithStrategy(root,EL,newValue,config,initSegs)};fluid.model.accessWithStrategy=function(root,EL,newValue,config,initSegs,returnSegs){if(!fluid.isPrimitive(EL)&&!fluid.isArrayable(EL)){var key=EL.type||"default";var resolver=config.resolvers[key];if(!resolver){fluid.fail("Unable to find resolver of type "+key)}var trundler=fluid.model.makeTrundler(config);var valueSeg={root:root,segs:initSegs};valueSeg=resolver(valueSeg,EL,trundler);if(EL.path&&valueSeg){valueSeg=trundler(valueSeg,EL.path)}return returnSegs?valueSeg:valueSeg?valueSeg.root:undefined}else{return fluid.model.accessImpl(root,EL,newValue,config,initSegs,returnSegs,fluid.model.traverseWithStrategy)}};fluid.registerNamespace("fluid.pathUtil");fluid.pathUtil.getPathSegmentImpl=function(accept,path,i){var segment=null;if(accept){segment=""}var escaped=false;var limit=path.length;for(;i<limit;++i){var c=path.charAt(i);if(!escaped){if(c==="."){break}else if(c==="\\"){escaped=true}else if(segment!==null){segment+=c}}else{escaped=false;if(segment!==null){segment+=c}}}if(segment!==null){accept[0]=segment}return i};var globalAccept=[];fluid.pathUtil.parseEL=function(path){var togo=[];var index=0;var limit=path.length;while(index<limit){var firstdot=fluid.pathUtil.getPathSegmentImpl(globalAccept,path,index);togo.push(globalAccept[0]);index=firstdot+1}return togo};fluid.pathUtil.composeSegment=function(prefix,toappend){toappend=toappend.toString();for(var i=0;i<toappend.length;++i){var c=toappend.charAt(i);if(c==="."||c==="\\"||c==="}"){prefix+="\\"}prefix+=c}return prefix};fluid.pathUtil.escapeSegment=function(segment){return fluid.pathUtil.composeSegment("",segment)};fluid.pathUtil.composePath=function(prefix,suffix){if(prefix.length!==0){prefix+="."}return fluid.pathUtil.composeSegment(prefix,suffix)};fluid.pathUtil.composeSegments=function(){var path="";for(var i=0;i<arguments.length;++i){path=fluid.pathUtil.composePath(path,arguments[i])}return path};fluid.pathUtil.matchSegments=function(toMatch,segs,start,end){if(end-start!==toMatch.length){return false}for(var i=start;i<end;++i){if(segs[i]!==toMatch[i-start]){return false}}return true};fluid.model.unescapedParser={parse:fluid.model.parseEL,compose:fluid.model.composeSegments};fluid.model.defaultGetConfig={parser:fluid.model.unescapedParser,strategies:[fluid.model.funcResolverStrategy,fluid.model.defaultFetchStrategy]};fluid.model.defaultSetConfig={parser:fluid.model.unescapedParser,strategies:[fluid.model.funcResolverStrategy,fluid.model.defaultFetchStrategy,fluid.model.defaultCreatorStrategy]};fluid.model.escapedParser={parse:fluid.pathUtil.parseEL,compose:fluid.pathUtil.composeSegments};fluid.model.escapedGetConfig={parser:fluid.model.escapedParser,strategies:[fluid.model.defaultFetchStrategy]};fluid.model.escapedSetConfig={parser:fluid.model.escapedParser,strategies:[fluid.model.defaultFetchStrategy,fluid.model.defaultCreatorStrategy]};fluid.stronglyConnected=function(vertices,accessor){var that={stack:[],accessor:accessor,components:[],index:0};vertices.forEach((function(vertex){delete vertex.lowIndex;delete vertex.tarjanIndex;delete vertex.onStack}));vertices.forEach((function(vertex){if(vertex.tarjanIndex===undefined){fluid.stronglyConnectedOne(vertex,that)}}));return that.components};fluid.stronglyConnectedOne=function(vertex,that){vertex.tarjanIndex=that.index;vertex.lowIndex=that.index;++that.index;that.stack.push(vertex);vertex.onStack=true;var outEdges=that.accessor(vertex);outEdges.forEach((function(outVertex){if(outVertex.tarjanIndex===undefined){fluid.stronglyConnectedOne(outVertex,that);vertex.lowIndex=Math.min(vertex.lowIndex,outVertex.lowIndex)}else if(outVertex.onStack){vertex.lowIndex=Math.min(vertex.lowIndex,outVertex.tarjanIndex)}}));if(vertex.lowIndex===vertex.tarjanIndex){var component=[],outVertex;do{outVertex=that.stack.pop();outVertex.onStack=false;component.push(outVertex)}while(outVertex!==vertex);that.components.push(component)}};fluid.initRelayModel=function(that){return that.model};fluid.findInitModelTransaction=function(that){var transRec=fluid.currentTreeTransaction();if(transRec&&fluid.isComponent(that)){return transRec.initModelTransaction[that.id]}};fluid.enlistModelComponent=function(that){var treeTransaction=fluid.currentTreeTransaction();var transId=treeTransaction.initModelTransactionId;var initModelTransaction=treeTransaction.initModelTransaction;var enlist=initModelTransaction[that.id];if(!enlist){var shadow=fluid.shadowForComponent(that);enlist={that:that,applier:fluid.getForComponent(that,"applier"),initModels:[],completeOnInit:!!shadow.initTransactionId,transaction:that.applier.initiate(null,"init",transId)};initModelTransaction[that.id]=enlist;var transRec=fluid.getModelTransactionRec(fluid.rootComponent,transId);transRec[that.applier.applierId]={transaction:enlist.transaction};fluid.registerMaterialisationListener(that,that.applier)}return enlist};fluid.clearTransactions=function(){var instantiator=fluid.globalInstantiator;fluid.clear(instantiator.modelTransactions)};fluid.failureEvent.addListener(fluid.clearTransactions,"clearTransactions","before:fail");fluid.clearLinkCounts=function(transRec,relaysAlso){fluid.each(transRec,(function(value,key){if(typeof value==="number"){transRec[key]=0}else if(relaysAlso&&value.options&&typeof value.relayCount==="number"){value.relayCount=0}}))};fluid.computeInitialOutArcs=function(transacs,initModelTransaction){return fluid.transform(initModelTransaction,(function(recel,id){var oneOutArcs={};var listeners=recel.that.applier.listeners.sortedListeners;fluid.each(listeners,(function(listener){if(listener.isRelay&&!fluid.isExcludedChangeSource(transacs[id],listener.cond)){var targetId=listener.targetId;if(targetId!==id){oneOutArcs[targetId]=true}}}));var oneOutArcList=Object.keys(oneOutArcs);var togo=oneOutArcList.map((function(id){return initModelTransaction[id]}));fluid.remove_if(togo,(function(rec){return rec===undefined}));return togo}))};fluid.sortCompleteLast=function(reca,recb){return(reca.completeOnInit?1:0)-(recb.completeOnInit?1:0)};fluid.subscribeResourceModelUpdates=function(that,resourceMapEntry){var treeTransaction=fluid.currentTreeTransaction();var resourceSpec=resourceMapEntry.resourceSpec;var resourceUpdateListener=function(){var initTransaction=fluid.getImmediate(treeTransaction,["initModelTransaction",that.id]);var trans=initTransaction?initTransaction.transaction:that.applier.initiate();resourceMapEntry.listeners.forEach((function(oneListener){var innerValue=fluid.getImmediate(resourceSpec,oneListener.resourceSegs);var segs=oneListener.segs;trans.change(segs,null,"DELETE");trans.change(segs,innerValue)}));if(!initTransaction){trans.commit()}else{var transRec=fluid.getModelTransactionRec(fluid.rootComponent,trans.id);fluid.clearLinkCounts(transRec,true);that.applier.preCommit.fire(trans,that)}};resourceSpec.onFetched.addListener(resourceUpdateListener);fluid.recordListener(resourceSpec.onFetched,resourceUpdateListener,fluid.shadowForComponent(that))};fluid.resolveResourceModelWorkflow=function(shadows,treeTransaction){var initModelTransaction=treeTransaction.initModelTransaction;shadows.forEach((function(shadow){var that=shadow.that;fluid.registerMergedModelListeners(that,that.options.modelListeners);fluid.each(shadow.modelSourcedDynamicComponents,(function(componentRecord,key){fluid.constructLensedComponents(shadow,initModelTransaction[that.id],componentRecord.sourcesParsed,key)}))}))};fluid.condenseResourceMap=function(resourceMap){var byId={};resourceMap.forEach((function(resourceMapEntry){var resourceSpec=resourceMapEntry.fetchOne.resourceSpec;var id=resourceSpec.transformEvent.eventId;var existing=byId[id];if(!existing){existing=byId[id]={resourceSpec:resourceSpec,listeners:[]}}existing.listeners.push({resourceSegs:resourceMapEntry.fetchOne.segs,segs:resourceMapEntry.segs})}));return byId};fluid.operateInitialTransaction=function(initModelTransaction,transId){var transacs=fluid.transform(initModelTransaction,(function(recel){return recel.transaction}));var outArcs=fluid.computeInitialOutArcs(transacs,initModelTransaction);var arcAccessor=function(initTransactionRecord){return outArcs[initTransactionRecord.that.id]};var recs=fluid.values(initModelTransaction);var components=fluid.stronglyConnected(recs,arcAccessor);var priorityIndex=0;components.forEach((function(component){component.forEach((function(recel){recel.initPriority=recel.completeOnInit?Infinity:priorityIndex++}))}));recs.sort((function(reca,recb){return reca.initPriority-recb.initPriority}));var transRec=fluid.getModelTransactionRec(fluid.rootComponent,transId);recs.forEach((function applyInitialModelTransactionValues(recel){var that=recel.that,applier=recel.that.applier,transac=transacs[that.id];if(recel.completeOnInit){fluid.notifyModelChanges(applier.listeners.sortedListeners,"ADD",transac.oldHolder,fluid.emptyHolder,null,transac,applier,that)}else{fluid.each(recel.initModels,(function(oneInitModel){if(oneInitModel!==undefined){transac.fireChangeRequest({type:"ADD",segs:[],value:oneInitModel})}fluid.clearLinkCounts(transRec,true)}))}}));recs.forEach((function updateInitialModelTransactionRelays(recel){var that=recel.that,applier=recel.that.applier,transac=transacs[that.id];applier.preCommit.fire(transac,that);if(!recel.completeOnInit){var resourceMapById=fluid.condenseResourceMap(applier.resourceMap);fluid.each(resourceMapById,(function(resourceMapEntry){fluid.subscribeResourceModelUpdates(that,resourceMapEntry)}));applier.earlyModelResolved.fire(that.model);applier.preCommit.fire(transac,that);recel.completeOnInit=true;var shadow=fluid.shadowForComponent(that);if(shadow&&!shadow.initTransactionId){shadow.initTransactionId=transId}}}))};fluid.parseModelReference=function(that,ref){var parsed=fluid.parseContextReference(ref);parsed.segs=fluid.pathUtil.parseEL(parsed.path);return parsed};fluid.parseValidModelReference=function(that,name,ref,permitNonModel){var localRecord=fluid.shadowForComponent(that).localRecord;var reject=function(){var failArgs=["Error in "+name+": ",ref].concat(fluid.makeArray(arguments));fluid.fail.apply(null,failArgs)};var rejectNonModel=function(value){reject(" must be a reference to a component with a ChangeApplier (descended from fluid.modelComponent), instead got ",value)};var parsed;if(typeof ref==="string"){if(fluid.isIoCReference(ref)){parsed=fluid.parseModelReference(that,ref);var modelPoint=parsed.segs.indexOf("model");if(modelPoint===-1){if(permitNonModel){parsed.nonModel=true}else{reject(' must be a reference into a component model via a path including the segment "model"')}}else{parsed.modelSegs=parsed.segs.slice(modelPoint+1);parsed.contextSegs=parsed.segs.slice(0,modelPoint);delete parsed.path}}else{parsed={path:ref,modelSegs:that.applier.parseEL(ref)}}}else{if(!fluid.isArrayable(ref.segs)){reject(' must contain an entry "segs" holding path segments referring a model path within a component')}parsed={context:ref.context,modelSegs:fluid.expandImmediate(ref.segs,that,localRecord)};fluid.each(parsed.modelSegs,(function(seg,index){if(!fluid.isValue(seg)){reject(" did not resolve path segment reference "+ref.segs[index]+" at index "+index)}}))}var contextTarget,target;if(parsed.context){if(localRecord&&parsed.context in localRecord){if(parsed.context==="source"&&localRecord.sourceModelReference){target=localRecord.sourceModelReference.that;parsed.modelSegs=localRecord.sourceModelReference.modelSegs.concat(parsed.segs);parsed.nonModel=false}else{target=localRecord[parsed.context]}}else{contextTarget=fluid.resolveContext(parsed.context,that);if(!contextTarget){reject(" context must be a reference to an existing component")}target=parsed.contextSegs?fluid.getForComponent(contextTarget,parsed.contextSegs):contextTarget}}else{target=that}if(!parsed.nonModel){if(!fluid.isComponent(target)){rejectNonModel(target)}if(!target.applier){fluid.getForComponent(target,["applier"])}if(!target.applier){rejectNonModel(target)}}parsed.that=target;parsed.applier=target&&target.applier;if(!parsed.path&&parsed.applier){parsed.path=target&&parsed.applier.composeSegments.apply(null,parsed.modelSegs)}return parsed};fluid.registerNamespace("fluid.materialiserRegistry");fluid.matchMaterialiserSpec=function(record,segs){var trundle=record;var routedPath=null;for(var i=0;i<segs.length;++i){var seg=segs[i];var wildcard=trundle["*"];if(wildcard){routedPath=wildcard}trundle=trundle[seg]||wildcard;if(!trundle){break}else if(trundle.materialiser){return trundle}}if(routedPath){fluid.fail("Materialised DOM path ",segs," did not match any registered materialiser - available paths are "+Object.keys(routedPath).join(", "))}return null};fluid.materialiseModelPath=function(that,segs){var shadow=fluid.shadowForComponent(that);var materialisedPath=["materialisedPaths"].concat(segs);if(!fluid.getImmediate(shadow,materialisedPath)){fluid.each(fluid.materialiserRegistry,(function(gradeRecord,grade){if(fluid.componentHasGrade(that,grade)){var record=fluid.matchMaterialiserSpec(gradeRecord,segs);if(record&&record.materialiser){fluid.model.setSimple(shadow,materialisedPath,{});var args=fluid.makeArray(record.args);fluid.invokeGlobalFunction(record.materialiser,[that,fluid.makeArray(segs)].concat(args))}}}))}};fluid.materialiseAgainstValue=function(that,newValue,segs){if(fluid.isPlainObject(newValue)){fluid.each(newValue,(function(inner,seg){segs.push(seg);fluid.materialiseAgainstValue(that,inner,segs);segs.pop()}))}else{fluid.materialiseModelPath(that,segs)}};fluid.registerMaterialisationListener=function(that,applier){fluid.each(fluid.materialiserRegistry,(function(gradeRecord,grade){if(fluid.componentHasGrade(that,grade)){fluid.each(gradeRecord,(function(rest,root){applier.modelChanged.addListener({transactional:false,path:root},(function(newValue){var segs=[root];fluid.materialiseAgainstValue(that,newValue,segs)}))}))}}))};fluid.getModelTransactionRec=function(that,transId){if(!transId){fluid.fail("Cannot get transaction record without transaction id")}var instantiator=fluid.isComponent(that)&&!fluid.isDestroyed(that,true)?fluid.globalInstantiator:null;if(!instantiator){return null}var transRec=instantiator.modelTransactions[transId];if(!transRec){transRec=instantiator.modelTransactions[transId]={relays:[],sources:{},externalChanges:{}}}return transRec};fluid.recordChangeListener=function(component,applier,sourceListener,listenerId){var shadow=fluid.shadowForComponent(component);fluid.recordListener(applier.modelChanged,sourceListener,shadow,listenerId)};fluid.registerRelayTransaction=function(transRec,targetApplier,transId,options,npOptions){var newTrans=targetApplier.initiate("relay",null,transId);var transEl=transRec[targetApplier.applierId]={transaction:newTrans,relayCount:0,namespace:npOptions.namespace,priority:npOptions.priority,options:options};transEl.priority=fluid.parsePriority(transEl.priority,transRec.relays.length,false,"model relay");transRec.relays.push(transEl);return transEl};fluid.relayRecursionBailout=100;fluid.registerDirectChangeRelay=function(target,targetSegs,source,sourceSegs,linkId,transducer,options,npOptions){var targetApplier=options.targetApplier||target.applier;var sourceApplier=options.sourceApplier||source.applier;if(!options.targetApplier){fluid.materialiseModelPath(target,targetSegs)}if(!options.sourceApplier){fluid.materialiseModelPath(source,sourceSegs)}var applierId=targetApplier.applierId;targetSegs=fluid.makeArray(targetSegs);sourceSegs=fluid.makeArray(sourceSegs);var sourceListener=function(newValue,oldValue,path,changeRequest,trans,applier){var transId=trans.id;var transRec=fluid.getModelTransactionRec(target,transId);if(applier&&trans&&!transRec[applier.applierId]){transRec[applier.applierId]={transaction:trans}}var transEl=transRec[applierId];transRec[linkId]=transRec[linkId]||0;var relay=true;if(relay){++transRec[linkId];if(transRec[linkId]>fluid.relayRecursionBailout){fluid.fail("Error in model relay specification at component ",target," - operated more than "+fluid.relayRecursionBailout+" relays without model value settling - current model contents are ",trans.newHolder.model)}if(!transEl){transEl=fluid.registerRelayTransaction(transRec,targetApplier,transId,options,npOptions)}if(transducer&&!options.targetApplier){fluid.pushActivity("relayTransducer",'computing modelRelay output for rule with target path "%targetSegs" and namespace "%namespace"',{targetSegs:targetSegs,namespace:npOptions.namespace});transducer(transEl.transaction,options.sourceApplier?undefined:newValue,source,sourceSegs,targetSegs,changeRequest);fluid.popActivity()}else{if(changeRequest&&changeRequest.type==="DELETE"){var deleteSegs=targetSegs.concat(changeRequest.segs.slice(sourceSegs.length));transEl.transaction.fireChangeRequest({type:"DELETE",segs:deleteSegs})}else if(newValue!==undefined){transEl.transaction.fireChangeRequest({type:"ADD",segs:targetSegs,value:newValue})}}}};var spec=sourceApplier.modelChanged.addListener({isRelay:true,cond:transducer&&transducer.cond,targetId:target.id,targetApplierId:targetApplier.id,segs:sourceSegs,transactional:options.transactional},sourceListener);if(fluid.passLogLevel(fluid.logLevel.TRACE)){fluid.log(fluid.logLevel.TRACE,"Adding relay listener with listenerId "+spec.listenerId+" to source applier with id "+sourceApplier.applierId+" from target applier with id "+applierId+" for target component with id "+target.id)}if(source){fluid.recordChangeListener(source,sourceApplier,sourceListener,spec.listenerId);if(target!==source){fluid.recordChangeListener(target,sourceApplier,sourceListener,spec.listenerId)}}};fluid.connectModelRelay=function(source,sourceSegs,target,targetSegs,options){var linkId=fluid.allocateGuid();fluid.enlistModelComponent(target);fluid.enlistModelComponent(source);var npOptions=fluid.filterKeys(options,["namespace","priority"]);if(options.update){if(options.targetApplier){fluid.registerDirectChangeRelay(source,sourceSegs,target,targetSegs,linkId,null,{transactional:false,targetApplier:options.targetApplier,refCount:options.refCount,update:options.update},npOptions)}else{fluid.registerDirectChangeRelay(target,targetSegs,source,[],linkId+"-transform",options.forwardAdapter,{transactional:true,sourceApplier:options.forwardApplier},npOptions)}}else{fluid.registerDirectChangeRelay(target,targetSegs,source,sourceSegs,linkId,options.forwardAdapter,{transactional:false},npOptions);fluid.registerDirectChangeRelay(source,sourceSegs,target,targetSegs,linkId,options.backwardAdapter,{transactional:false},npOptions)}};fluid.parseSourceExclusionSpec=function(targetSpec,sourceSpec){targetSpec.excludeSource=fluid.arrayToHash(fluid.makeArray(sourceSpec.excludeSource||(sourceSpec.includeSource?"*":undefined)));targetSpec.includeSource=fluid.arrayToHash(fluid.makeArray(sourceSpec.includeSource));return targetSpec};fluid.isExcludedChangeSource=function(transaction,spec){if(!spec||!spec.excludeSource){return false}var excluded=spec.excludeSource["*"];for(var source in transaction.fullSources){if(spec.excludeSource[source]){excluded=true}if(spec.includeSource[source]){excluded=false}}return excluded};fluid.model.guardedAdapter=function(transaction,cond,func,args){if(!fluid.isExcludedChangeSource(transaction,cond)&&func!==fluid.model.transform.uninvertibleTransform){func.apply(null,args)}};fluid.transformToAdapter=function(transform,targetPath){var basedTransform={};basedTransform[targetPath]=transform;return function(trans,newValue,source,sourceSegs,targetSegs,changeRequest){if(changeRequest&&changeRequest.type==="DELETE"){trans.fireChangeRequest({type:"DELETE",path:targetPath})}var oldTarget=fluid.getImmediate(trans.oldHolder.model,targetSegs);var oldSource=fluid.getImmediate(source.model,sourceSegs);fluid.model.transformWithRules(newValue,basedTransform,{finalApplier:trans,oldTarget:oldTarget,oldSource:oldSource})}};fluid.makeTransformPackage=function(componentThat,transform,sourcePath,targetPath,forwardCond,backwardCond,namespace,priority){var that={forwardHolder:{model:transform},backwardHolder:{model:null}};that.generateAdapters=function(trans){that.forwardAdapterImpl=fluid.transformToAdapter(trans?trans.newHolder.model:that.forwardHolder.model,targetPath);if(sourcePath!==null){var inverted=fluid.model.transform.invertConfiguration(transform);if(inverted!==fluid.model.transform.uninvertibleTransform){that.backwardHolder.model=inverted;that.backwardAdapterImpl=fluid.transformToAdapter(that.backwardHolder.model,sourcePath)}else{that.backwardAdapterImpl=inverted}}};that.forwardAdapter=function(transaction,newValue){if(newValue===undefined){that.generateAdapters()}fluid.model.guardedAdapter(transaction,forwardCond,that.forwardAdapterImpl,arguments)};that.forwardAdapter.cond=forwardCond;that.runTransform=function(trans){trans.commit();trans.reset()};that.forwardApplier=fluid.makeHolderChangeApplier(that.forwardHolder);that.forwardApplier.isRelayApplier=true;that.invalidator=fluid.makeEventFirer({name:"Invalidator for model relay with applier "+that.forwardApplier.applierId});if(sourcePath!==null){that.backwardApplier=fluid.makeHolderChangeApplier(that.backwardHolder);that.backwardAdapter=function(transaction){fluid.model.guardedAdapter(transaction,backwardCond,that.backwardAdapterImpl,arguments)};that.backwardAdapter.cond=backwardCond}that.update=that.invalidator.fire;var implicitOptions={targetApplier:that.forwardApplier,update:that.update,namespace:namespace,priority:priority,refCount:0};that.forwardHolder.model=fluid.parseImplicitRelay(componentThat,transform,[],implicitOptions);that.refCount=implicitOptions.refCount;that.namespace=namespace;that.priority=priority;that.generateAdapters();that.invalidator.addListener(that.generateAdapters);that.invalidator.addListener(that.runTransform);return that};fluid.singleTransformToFull=function(singleTransform){var expanded=typeof singleTransform==="string"?{type:singleTransform}:singleTransform;var withPath=$.extend(true,{inputPath:""},expanded);return{"":{transform:withPath}}};fluid.funcToSingleTransform=function(that,mrrec){if(mrrec.func){if((mrrec.args!==undefined)+(mrrec.source!==undefined)+(mrrec.value!==undefined)!==1){fluid.fail("Error in model relay definition: short-form relay must specify just one out of (args, source, value)")}return{type:"fluid.transforms.free",func:mrrec.func,args:mrrec.args?mrrec.args:[fluid.isIoCReference(mrrec.source)?mrrec.source:"{that}.model."+mrrec.source]}}else{return null}};fluid.model.relayConditions={initOnly:{includeSource:"init"},liveOnly:{excludeSource:"init"},never:{includeSource:[]},always:{}};fluid.model.expandRelayCondition=function(condition){var exclusionRec;if(condition==="initOnly"){fluid.log(fluid.logLevel.WARN,'The relay condition "initOnly" is deprecated: Please use the form \'includeSource: "init"\' instead')}else if(condition==="liveOnly"){fluid.log(fluid.logLevel.WARN,'The relay condition "liveOnly" is deprecated: Please use the form \'excludeSource: "init"\' instead')}if(!condition){exclusionRec={}}else if(typeof condition==="string"){exclusionRec=fluid.model.relayConditions[condition];if(!exclusionRec){fluid.fail('Unrecognised model relay condition string "'+condition+'": the supported values are "never" or a record with members "includeSource" and/or "excludeSource"')}}else{exclusionRec=condition}return exclusionRec};fluid.model.parseRelayConditions=function(conditions){var expanded=conditions.map(fluid.model.expandRelayCondition);var mergeArgs=[true,{}].concat(expanded);var merged=fluid.extend.apply(null,mergeArgs);return fluid.parseSourceExclusionSpec({},merged)};fluid.parseModelRelay=function(that,mrrec,key){fluid.pushActivity("parseModelRelay",'parsing modelRelay definition with key "%key" and body "%body" attached to component "%that"',{key:key,body:mrrec,that:that});if(typeof mrrec.target!=="string"&&!(fluid.isPlainObject(mrrec.target,true)&&mrrec.target.segs)){fluid.fail('Error parsing model relay definition: model reference must be specified for "target"')}var parsedSource=mrrec.source!==undefined?fluid.parseValidModelReference(that,'modelRelay record member "source"',mrrec.source,true):mrrec.value!==undefined?{nonModel:true}:{path:null,modelSegs:null};var parsedTarget=fluid.parseValidModelReference(that,'modelRelay record member "target"',mrrec.target);var namespace=mrrec.namespace||key;var singleTransform=typeof mrrec.singleTransform==="string"?{type:mrrec.singleTransform}:mrrec.singleTransform;var shortSingleTransform=fluid.funcToSingleTransform(that,mrrec);var transform=mrrec.transform||fluid.singleTransformToFull(singleTransform||shortSingleTransform||{type:"fluid.transforms.identity"});var upDefaults=singleTransform?fluid.defaults(singleTransform.type):null;var relayOptions=upDefaults&&upDefaults.relayOptions||{};var forwardCond=fluid.model.parseRelayConditions([relayOptions.forward,mrrec.forward]),backwardCond=fluid.model.parseRelayConditions([relayOptions.backward,mrrec.backward]);var transformPackage=fluid.makeTransformPackage(that,transform,parsedSource.path,parsedTarget.path,forwardCond,backwardCond,namespace,mrrec.priority);if(parsedSource.nonModel){var initValue=fluid.parseImplicitRelay(that,fluid.firstDefined(mrrec.source,mrrec.value),parsedTarget.modelSegs),transformed;if(transform[""].transform.type!=="fluid.transforms.identity"){var localTransform=fluid.copy(transform);localTransform[""].transform.args=[initValue];transformed=fluid.model.transformWithRules(initValue,localTransform)}else{transformed=initValue}var enlist=fluid.enlistModelComponent(parsedTarget.that);var initModel={};fluid.model.setSimple(initModel,parsedTarget.modelSegs,transformed);enlist.initModels.push(initModel)}else{if(transformPackage.refCount===0){fluid.connectModelRelay(parsedSource.that||that,parsedSource.modelSegs,parsedTarget.that,parsedTarget.modelSegs,fluid.filterKeys(transformPackage,["forwardAdapter","backwardAdapter","namespace","priority"]))}else{if(parsedSource.modelSegs&&!shortSingleTransform){fluid.fail('Error in model relay definition: If a relay transform has a model dependency, you can not specify a "source" entry - please instead enter this as "input" in the transform specification. Definition was ',mrrec," for component ",that)}fluid.connectModelRelay(that,null,parsedTarget.that,parsedTarget.modelSegs,transformPackage)}}fluid.popActivity()};fluid.parseImplicitRelay=function(that,modelRec,segs,options){var value;if(fluid.isIoCReference(modelRec)){var parsed=fluid.parseValidModelReference(that,"model reference from model (implicit relay)",modelRec,true);if(parsed.nonModel){value=fluid.isComponent(parsed.that)?fluid.possiblyProxyComponent(fluid.getForComponent(parsed.that,parsed.segs)):fluid.getImmediate(parsed.that,parsed.segs);if(value instanceof fluid.fetchResources.FetchOne){that.applier.resourceMap.push({segs:fluid.makeArray(segs),fetchOne:value});return undefined}}else{++options.refCount;fluid.connectModelRelay(that,segs,parsed.that,parsed.modelSegs,options)}}else if(fluid.isPrimitive(modelRec)||!fluid.isPlainObject(modelRec)){value=modelRec}else if(modelRec.expander&&fluid.isPlainObject(modelRec.expander)){value=fluid.expandOptions(modelRec,that)}else{value=fluid.freshContainer(modelRec);fluid.each(modelRec,(function(innerValue,key){segs.push(key);var innerTrans=fluid.parseImplicitRelay(that,innerValue,segs,options);if(innerTrans!==undefined){value[key]=innerTrans}segs.pop()}))}return value};fluid.model.notifyExternal=function(transRec){var allChanges=transRec?fluid.values(transRec.externalChanges):[];fluid.sortByPriority(allChanges);for(var i=0;i<allChanges.length;++i){var change=allChanges[i];var targetApplier=change.args[5];if(!targetApplier.destroyed){change.listener.apply(null,change.args)}}fluid.clearLinkCounts(transRec,true)};fluid.model.commitRelays=function(instantiator,transactionId){var transRec=instantiator.modelTransactions[transactionId];fluid.each(transRec,(function(transEl){if(transEl.transaction){transEl.transaction.commit("relay");transEl.transaction.reset()}}))};fluid.model.updateRelays=function(instantiator,transactionId){var transRec=instantiator.modelTransactions[transactionId];var updates=0;fluid.sortByPriority(transRec.relays);fluid.each(transRec.relays,(function(transEl){var maxRelay=transEl.options.refCount?transEl.options.refCount*4:4;if(transEl.transaction.changeRecord.changes>0&&transEl.relayCount<maxRelay&&transEl.options.update){transEl.relayCount++;fluid.clearLinkCounts(transRec);transEl.options.update(transEl.transaction,transRec);++updates}}));return updates};fluid.concludeModelTransaction=function(transaction){var instantiator=fluid.globalInstantiator;fluid.model.notifyExternal(instantiator.modelTransactions[transaction.id]);delete instantiator.modelTransactions[transaction.id]};fluid.establishModelRelay=function(that,optionsModel,optionsML,optionsMR,applier){var shadow=fluid.shadowForComponent(that);if(!shadow.modelRelayEstablished){shadow.modelRelayEstablished=true}else{fluid.fail("FLUID-5887 failure: Model relay initialised twice on component",that)}var enlist=fluid.enlistModelComponent(that);var initModels=(optionsModel||[]).map((function(modelRec){return fluid.parseImplicitRelay(that,modelRec,[],{refCount:0,priority:"first"})}));Array.prototype.push.apply(enlist.initModels,initModels);fluid.each(optionsMR,(function(mrrec,key){if(key===""){for(var i=0;i<mrrec.length;++i){fluid.parseModelRelay(that,mrrec[i],key)}}else{var lightMerge=fluid.extend.apply(null,[true,{}].concat(mrrec));fluid.parseModelRelay(that,lightMerge,key)}}));var instantiator=fluid.getInstantiator(that);function updateRelays(transaction){while(fluid.model.updateRelays(instantiator,transaction.id)>0){}}function commitRelays(transaction){fluid.model.commitRelays(instantiator,transaction.id)}applier.preCommit.addListener(updateRelays);applier.preCommit.addListener(commitRelays);applier.postCommit.addListener(fluid.concludeModelTransaction);applier.postCommit.addListener(fluid.concludeAnyTreeTransaction);return null};fluid.destroyLensedComponentSource=function(that,isBoolean){var shadow=fluid.shadowForComponent(that);var sourceModelReference=shadow.localRecord.sourceModelReference;if(sourceModelReference&&!fluid.isDestroyed(sourceModelReference.that,true)){sourceModelReference.that.applier.change(sourceModelReference.modelSegs,false,isBoolean?"ADD":"DELETE")}};fluid.constructLensedComponents=function(shadow,initTransRec,sourcesParsed,dynamicComponentKey){var lightMerge=shadow.lightMergeDynamicComponents[dynamicComponentKey];var sources=fluid.getImmediate(shadow.that.model,sourcesParsed.modelSegs);var shadowRecord=shadow.modelSourcedDynamicComponents[dynamicComponentKey];var localRecordContributor=shadowRecord.localRecordContributor=function(localRecord,source,sourceKey){localRecord.sourceModelReference={that:sourcesParsed.that,modelSegs:sourcesParsed.modelSegs.concat(shadowRecord.isBoolean?[]:[sourceKey])}};fluid.lightMergeRecords.pushRecord(lightMerge,{options:{listeners:{afterDestroy:{funcName:"fluid.destroyLensedComponentSource",args:["{that}",shadowRecord.isBoolean]}}}});fluid.registerSourcedDynamicComponentsTriage(shadow.potentia,shadow.that,sources,lightMerge,dynamicComponentKey,shadowRecord.isBoolean,localRecordContributor)};fluid.operateInitialTransactionWorkflow=function(shadows,treeTransaction){fluid.tryCatch((function(){var initModelTransaction=treeTransaction.initModelTransaction;var transId=treeTransaction.initModelTransactionId;fluid.operateInitialTransaction(initModelTransaction,transId)}),(function(e){treeTransaction.initModelTransaction={};treeTransaction.initModelTransactionId=null;fluid.clearTransactions();throw e}),fluid.identity)};fluid.enlistModelWorkflow=function(shadows,treeTransaction){var transId=treeTransaction.initModelTransactionId;if(!transId){transId=fluid.allocateGuid();treeTransaction.initModelTransactionId=transId}shadows.forEach((function(shadow){fluid.getForComponent(shadow.that,"modelRelay")}));fluid.operateInitialTransactionWorkflow(shadows,treeTransaction)};fluid.notifyInitModelWorkflow=function(shadow,treeTransaction){if(!shadow.modelComplete){var initModelTransaction=treeTransaction.initModelTransaction;var transRec=fluid.getModelTransactionRec(fluid.rootComponent,shadow.initTransactionId);var trans=fluid.values(initModelTransaction)[0].transaction;treeTransaction.initModelTransaction={};treeTransaction.initModelTransactionId=null;trans.commit();fluid.each(initModelTransaction,(function(oneRec){var that=oneRec.that,applier=that.applier;trans=transRec[applier.applierId].transaction;var listeners=applier.transListeners.sortedListeners;var initShadow=fluid.shadowForComponent(that);initShadow.modelComplete=true;var shadowTrans=initShadow.initTransactionId;if(shadowTrans===shadow.initTransactionId){fluid.notifyModelChanges(listeners,"ADD",trans.oldHolder,fluid.emptyHolder,null,trans,applier,that)}else{}}));fluid.concludeModelTransaction(trans)}};fluid.defaults("fluid.modelComponent",{gradeNames:["fluid.component"],workflows:{global:{enlistModel:{funcName:"fluid.enlistModelWorkflow"},resolveResourceModel:{funcName:"fluid.resolveResourceModelWorkflow",priority:"after:enlistModel",waitIO:true}},local:{notifyInitModelWorkflow:{funcName:"fluid.notifyInitModelWorkflow",priority:"before:concludeComponentInit"}}},members:{model:{expander:{funcName:"fluid.initRelayModel",args:["{that}","{that}.modelRelay"],noproxy:true}},applier:{expander:{funcName:"fluid.makeHolderChangeApplier",args:["{that}","{that}.options.changeApplierOptions"],noproxy:true}},modelRelay:{expander:{funcName:"fluid.establishModelRelay",args:["{that}","{that}.options.model","{that}.options.modelListeners","{that}.options.modelRelay","{that}.applier"],noproxy:true}}},mergePolicy:{model:{noexpand:true,func:fluid.arrayConcatPolicy},modelListeners:fluid.makeMergeListenersPolicy(fluid.arrayConcatPolicy),modelRelay:fluid.makeMergeListenersPolicy(fluid.arrayConcatPolicy,true)}});fluid.modelChangedToChange=function(args){return{value:args[0],oldValue:args[1],path:args[2],transaction:args[4]}};fluid.event.invokeListener=function(listener,args,localRecord,mergeRecord){if(typeof listener==="string"){listener=fluid.event.resolveListener(listener)}return listener.apply(null,args,localRecord,mergeRecord)};fluid.resolveModelListener=function(that,record){var togo=function(){if(fluid.isDestroyed(that,true)){return}var change=fluid.modelChangedToChange(arguments);var args=arguments;var localRecord={change:change,arguments:args};var mergeRecord={source:Object.keys(change.transaction.sources)};if(record.args){args=fluid.expandImmediate(record.args,that,localRecord)}fluid.event.invokeListener(record.listener,fluid.makeArray(args),localRecord,mergeRecord)};fluid.event.impersonateListener(record.listener,togo);return togo};fluid.registerModelListeners=function(that,record,paths,namespace){var func=fluid.resolveModelListener(that,record);fluid.each(record.byTarget,(function(parsedArray){var parsed=parsedArray[0];var spec={listener:func,listenerId:fluid.allocateGuid(),segsArray:fluid.getMembers(parsedArray,"modelSegs"),includeSource:record.includeSource,excludeSource:record.excludeSource,priority:fluid.expandOptions(record.priority,that),transactional:true};spec=parsed.applier.modelChanged.addListener(spec,func,namespace,record.softNamespace);spec.segsArray.forEach((function(segs){fluid.materialiseModelPath(that,segs)}));fluid.recordChangeListener(that,parsed.applier,func,spec.listenerId)}))};fluid.registerMergedModelListeners=function(that,listeners){fluid.each(listeners,(function(value,key){if(typeof value==="string"){value={funcName:value}}var records=fluid.event.resolveListenerRecord(value,that,"modelListeners",null,false).records;fluid.each(records,(function(record){record.byTarget={};var paths=fluid.makeArray(record.path===undefined?key:record.path);fluid.each(paths,(function(path){var parsed=fluid.parseValidModelReference(that,"modelListeners entry",path);fluid.pushArray(record.byTarget,parsed.that.id,parsed)}));var namespace=(record.namespace&&!record.softNamespace?record.namespace:null)||(record.path!==undefined?key:null);fluid.registerModelListeners(that,record,paths,namespace)}))}))};fluid.replaceModelValue=function(applier,path,newValue){var transaction=applier.initiate();transaction.fireChangeRequest({path:path,type:"DELETE"});transaction.fireChangeRequest({path:path,value:newValue});transaction.commit();return applier.holder.model};fluid.fireChanges=function(applier,changes){for(var i=0;i<changes.length;++i){applier.fireChangeRequest(changes[i])}};fluid.model.isChangedPath=function(changeMap,segs){for(var i=0;i<=segs.length;++i){if(typeof changeMap==="string"){return changeMap}if(i<segs.length&&changeMap){changeMap=changeMap[segs[i]]}}return null};fluid.model.setChangedPath=function(options,segs,value){var notePath=function(record){var root=options;segs.unshift(record);for(var i=0;i<segs.length-1;++i){var seg=segs[i];if(root[seg]===undefined){root[seg]={}}root=root[seg]}if(fluid.isPlainObject(root)){root[fluid.peek(segs)]=value}segs.shift()};if(fluid.model.isChangedPath(options.changeMap,segs)!==value){++options.changes;notePath("changeMap")}if(fluid.model.isChangedPath(options.deltaMap,segs)!==value){++options.deltas;notePath("deltaMap")}};fluid.model.fetchChangeChildren=function(target,i,segs,source,options){fluid.each(source,(function(value,key){segs[i]=key;fluid.model.applyChangeStrategy(target,key,i,segs,value,options);segs.length=i}))};fluid.model.isSameValue=function(a,b){if(typeof a!=="number"||typeof b!=="number"){return a===b}else{if(a===b||a!==a&&b!==b){return true}else{var relError=Math.abs((a-b)/b);return relError<1e-12}}};fluid.model.applyChangeStrategy=function(target,name,i,segs,source,options){var targetSlot=target[name];var sourceCode=fluid.typeCode(source);var targetCode=fluid.typeCode(targetSlot);var changedValue=fluid.NO_VALUE;if(sourceCode==="primitive"){if(!fluid.model.isSameValue(targetSlot,source)){changedValue=source;++options.unchanged}}else if(targetCode!==sourceCode||sourceCode==="array"&&source.length!==targetSlot.length){changedValue=fluid.freshContainer(source)}if(changedValue!==fluid.NO_VALUE){target[name]=changedValue;if(options.changeMap){fluid.model.setChangedPath(options,segs,options.inverse?"DELETE":"ADD")}}if(sourceCode!=="primitive"){fluid.model.fetchChangeChildren(target[name],i+1,segs,source,options)}};fluid.model.stepTargetAccess=function(target,type,segs,startpos,endpos,options){for(var i=startpos;i<endpos;++i){if(!target){continue}var oldTrunk=target[segs[i]];target=fluid.model.traverseWithStrategy(target,segs,i,options[type==="ADD"?"resolverSetConfig":"resolverGetConfig"],segs.length-i-1);if(oldTrunk!==target&&options.changeMap){fluid.model.setChangedPath(options,segs.slice(0,i+1),"ADD")}}return{root:target,last:segs[endpos]}};fluid.model.defaultAccessorConfig=function(options){options=options||{};options.resolverSetConfig=options.resolverSetConfig||fluid.model.escapedSetConfig;options.resolverGetConfig=options.resolverGetConfig||fluid.model.escapedGetConfig;return options};fluid.model.applyHolderChangeRequest=function(holder,request,options){options=fluid.model.defaultAccessorConfig(options);options.deltaMap=options.changeMap?{}:null;options.deltas=0;var length=request.segs.length;var pen,atRoot=length===0;if(atRoot){pen={root:holder,last:"model"}}else{if(!holder.model&&request.type!=="DELETE"){holder.model={};fluid.model.setChangedPath(options,[],options.inverse?"DELETE":"ADD")}pen=fluid.model.stepTargetAccess(holder.model,request.type,request.segs,0,length-1,options)}if(request.type==="ADD"){var value=request.value;var segs=fluid.makeArray(request.segs);fluid.model.applyChangeStrategy(pen.root,pen.last,length-1,segs,value,options,atRoot)}else if(request.type==="DELETE"){if(pen.root&&pen.root[pen.last]!==undefined){delete pen.root[pen.last];if(options.changeMap){fluid.model.setChangedPath(options,request.segs,"DELETE")}}}else{fluid.fail("Unrecognised change type of "+request.type)}return options.deltas?options.deltaMap:null};fluid.model.diff=function(modela,modelb,options){options=options||{changes:0,unchanged:0,changeMap:{}};var typea=fluid.typeCode(modela);var typeb=fluid.typeCode(modelb);var togo;if(typea==="primitive"&&typeb==="primitive"){togo=fluid.model.isSameValue(modela,modelb)}else if(typea==="primitive"^typeb==="primitive"){togo=false}else{var holderb={model:fluid.copy(modelb)};options.inverse=true;fluid.model.applyHolderChangeRequest(holderb,{value:modela,segs:[],type:"ADD"},options);var holdera={model:fluid.copy(modela)};options.inverse=false;fluid.model.applyHolderChangeRequest(holdera,{value:modelb,segs:[],type:"ADD"},options);togo=options.changes===0}if(togo===false&&options.changes===0){options.changes=1;options.changeMap=modelb===undefined?"DELETE":"ADD"}else if(togo===true&&options.unchanged===0){options.unchanged=1}return togo};fluid.outputWildcardMatches=function(matches,outSegs,root){fluid.each(root,(function(value,key){matches.push(outSegs.concat(key))}))};fluid.matchChanges=function(changeMap,specSegs,newHolder,oldHolder){var newRoot=newHolder.model;var oldRoot=oldHolder.model;var map=changeMap;var outSegs=["model"];var wildcard=false;var togo=[];for(var i=0;i<specSegs.length;++i){var seg=specSegs[i];if(seg==="*"){if(i===specSegs.length-1){wildcard=true}else{fluid.fail("Wildcard specification in modelChanged listener is only supported for the final path segment: "+specSegs.join("."))}}else{outSegs.push(seg);map=fluid.isPrimitive(map)?map:map[seg];newRoot=newRoot?newRoot[seg]:undefined;oldRoot=oldRoot?oldRoot[seg]:undefined}}if(map){if(wildcard){if(typeof map==="string"){var allKeys=fluid.extend({},oldRoot,newRoot);fluid.outputWildcardMatches(togo,outSegs,allKeys)}else{fluid.outputWildcardMatches(togo,outSegs,map)}}else{togo.push(outSegs)}}return togo};fluid.storeExternalChange=function(transRec,applier,invalidPath,spec,args){var pathString=applier.composeSegments.apply(null,invalidPath);var keySegs=[applier.holder.id,spec.listenerId,spec.wildcard?pathString:""];var keyString=keySegs.join("|");transRec.externalChanges[keyString]={listener:spec.listener,namespace:spec.namespace,priority:spec.priority,args:args}};fluid.notifyModelChanges=function(listeners,changeMap,newHolder,oldHolder,changeRequest,transaction,applier,that){if(!listeners){return}var transRec=fluid.getModelTransactionRec(that,transaction.id);for(var i=0;i<listeners.length;++i){var spec=listeners[i];var multiplePaths=spec.segsArray.length>1;for(var j=0;j<spec.segsArray.length;++j){var invalidPaths=fluid.matchChanges(changeMap,spec.segsArray[j],newHolder,oldHolder);for(var k=0;k<invalidPaths.length;++k){if(applier.destroyed){return}var invalidPath=invalidPaths[k];spec.listener=fluid.event.resolveListener(spec.listener);var args=[multiplePaths?newHolder.model:fluid.model.getSimple(newHolder,invalidPath),multiplePaths?oldHolder.model:fluid.model.getSimple(oldHolder,invalidPath),multiplePaths?[]:invalidPath.slice(1),changeRequest,transaction,applier];if(!spec.isRelay){var isNull=fluid.model.diff(args[0],args[1]);if(isNull){continue}var sourceExcluded=fluid.isExcludedChangeSource(transaction,spec);if(sourceExcluded){continue}}if(transRec&&!spec.isRelay&&spec.transactional){fluid.storeExternalChange(transRec,applier,invalidPath,spec,args)}else{spec.listener.apply(null,args)}}}}};fluid.bindELMethods=function(applier){applier.parseEL=function(EL){return fluid.model.pathToSegments(EL,applier.options.resolverSetConfig)};applier.composeSegments=function(){return applier.options.resolverSetConfig.parser.compose.apply(null,arguments)}};fluid.emptyHolder=fluid.freezeRecursive({model:undefined});fluid.preFireChangeRequest=function(applier,changeRequest){if(!changeRequest.type){changeRequest.type="ADD"}changeRequest.segs=changeRequest.segs||applier.parseEL(changeRequest.path)};fluid.bindRequestChange=function(that){that.change=function(path,value,type,source){var changeRequest={path:path,value:value,type:type,source:source};that.fireChangeRequest(changeRequest)}};fluid.mergeChangeSources=function(target,globalSources){if(fluid.isPlainObject(globalSources,true)){fluid.extend(target,globalSources)}else{fluid.each(fluid.makeArray(globalSources),(function(globalSource){target[globalSource]=true}))}};fluid.ChangeApplier=function(){};fluid.makeHolderChangeApplier=function(holder,options){options=fluid.model.defaultAccessorConfig(options);var applierId=fluid.allocateGuid();var that=new fluid.ChangeApplier;var name=fluid.isComponent(holder)?"ChangeApplier for component "+fluid.dumpThat(holder):"ChangeApplier with id "+applierId;$.extend(that,{applierId:applierId,holder:holder,listeners:fluid.makeEventFirer({name:"Internal change listeners for "+name}),transListeners:fluid.makeEventFirer({name:"External change listeners for "+name}),options:options,modelChanged:{},resourceMap:[],earlyModelResolved:fluid.makeEventFirer({name:"earlyModelResolved event for "+name}),preCommit:fluid.makeEventFirer({name:"preCommit event for "+name}),postCommit:fluid.makeEventFirer({name:"postCommit event for "+name})});that.destroy=function(){that.preCommit.destroy();that.postCommit.destroy();that.destroyed=true};that.modelChanged.addListener=function(spec,listener,namespace,softNamespace){if(typeof spec==="string"){spec={path:spec}}else{spec=fluid.copy(spec)}spec.listenerId=spec.listenerId||fluid.allocateGuid();spec.namespace=namespace;spec.softNamespace=softNamespace;if(typeof listener==="string"){listener={globalName:listener}}spec.listener=listener;if(spec.transactional!==false){spec.transactional=true}if(!spec.segsArray){if(spec.path!==undefined){spec.segs=spec.segs||that.parseEL(spec.path)}spec.segsArray=[spec.segs]}if(!spec.isRelay){fluid.parseSourceExclusionSpec(spec,spec);spec.wildcard=spec.segsArray.some((function(segs){return segs.includes("*")}));if(spec.wildcard&&spec.segsArray.length>1){fluid.fail("Error in model listener specification ",spec," - you may not supply a wildcard pattern as one of a set of multiple paths to be matched")}}var firer=that[spec.transactional?"transListeners":"listeners"];firer.addListener(spec);return spec};that.modelChanged.removeListener=function(listener){that.listeners.removeListener(listener);that.transListeners.removeListener(listener)};that.fireChangeRequest=function(changeRequest){var initTransaction=fluid.findInitModelTransaction(holder);if(initTransaction){initTransaction.transaction.fireChangeRequest(changeRequest)}else{var ation=that.initiate("local",changeRequest.source);ation.fireChangeRequest(changeRequest);ation.commit()}};that.initiate=function(localSource,globalSources,transactionId){localSource=globalSources==="init"?null:localSource||"local";var defeatPost=localSource==="relay"||globalSources==="init";var trans={instanceId:fluid.allocateGuid(),id:transactionId||fluid.allocateGuid(),changeRecord:{resolverSetConfig:options.resolverSetConfig,resolverGetConfig:options.resolverGetConfig},reset:function(){trans.oldHolder=holder;trans.newHolder={model:fluid.copy(holder.model)};trans.changeRecord.changes=0;trans.changeRecord.unchanged=0;trans.changeRecord.changeMap={}},commit:function(code){if(code!=="relay"){that.preCommit.fire(trans,that,code)}if(trans.changeRecord.changes>0){var oldHolder={model:holder.model};holder.model=trans.newHolder.model;fluid.notifyModelChanges(that.transListeners.sortedListeners,trans.changeRecord.changeMap,holder,oldHolder,null,trans,that,holder)}if(!defeatPost&&code!=="relay"){that.postCommit.fire(trans,that,code)}},fireChangeRequest:function(changeRequest){fluid.preFireChangeRequest(that,changeRequest);changeRequest.transactionId=trans.id;var deltaMap=fluid.model.applyHolderChangeRequest(trans.newHolder,changeRequest,trans.changeRecord);fluid.notifyModelChanges(that.listeners.sortedListeners,deltaMap,trans.newHolder,holder,changeRequest,trans,that,holder)},hasChangeSource:function(source){return trans.fullSources[source]}};var transRec=fluid.getModelTransactionRec(holder,trans.id);if(transRec){fluid.mergeChangeSources(transRec.sources,globalSources);trans.sources=transRec.sources;trans.fullSources=Object.create(transRec.sources);if(localSource){trans.fullSources[localSource]=true}}trans.reset();fluid.bindRequestChange(trans);return trans};fluid.bindRequestChange(that);fluid.bindELMethods(that);return that};fluid.modelPairToChanges=function(value,oldValue,changePathPrefix){changePathPrefix=changePathPrefix||"";var diffOptions={changes:0,unchanged:0,changeMap:{}};fluid.model.diff(oldValue,value,diffOptions);var changes=[];fluid.modelPairToChangesImpl(value,fluid.pathUtil.parseEL(changePathPrefix),diffOptions.changeMap,[],changes);return changes};fluid.modelPairToChangesImpl=function(value,changePathPrefixSegs,changeMap,changeSegs,changes){if(changeMap==="ADD"){changes.push({path:changePathPrefixSegs,value:value,type:"ADD"})}else if(changeMap==="DELETE"){changes.push({path:changePathPrefixSegs,value:null,type:"DELETE"})}else if(fluid.isPlainObject(changeMap,true)){fluid.each(changeMap,(function(change,seg){var currentChangeSegs=changeSegs.concat([seg]);if(change==="ADD"){changes.push({path:changePathPrefixSegs.concat(currentChangeSegs),value:fluid.get(value,currentChangeSegs),type:"ADD"})}else if(change==="DELETE"){changes.push({path:changePathPrefixSegs.concat(currentChangeSegs),value:null,type:"DELETE"})}else if(fluid.isPlainObject(change,true)){fluid.modelPairToChangesImpl(value,changePathPrefixSegs,change,currentChangeSegs,changes)}}))}};"use strict";fluid.registerNamespace("fluid.model.transform");fluid.defaults("fluid.transformFunction",{gradeNames:"fluid.function"});fluid.defaults("fluid.standardInputTransformFunction",{gradeNames:"fluid.transformFunction"});fluid.defaults("fluid.standardOutputTransformFunction",{gradeNames:"fluid.transformFunction"});fluid.defaults("fluid.multiInputTransformFunction",{gradeNames:"fluid.transformFunction"});fluid.defaults("fluid.standardTransformFunction",{gradeNames:["fluid.standardInputTransformFunction","fluid.standardOutputTransformFunction"]});fluid.defaults("fluid.lens",{gradeNames:"fluid.transformFunction",invertConfiguration:null});fluid.model.transform.pathToRule=function(inputPath){return{transform:{type:"fluid.transforms.value",inputPath:inputPath}}};fluid.model.transform.literalValueToRule=function(input){return{transform:{type:"fluid.transforms.literalValue",input:input}}};fluid.model.composePaths=function(prefix,suffix){prefix=prefix===0?"0":prefix||"";suffix=suffix===0?"0":suffix||"";return!prefix?suffix:!suffix?prefix:prefix+"."+suffix};fluid.model.transform.accumulateInputPath=function(inputPath,transformer,paths){if(inputPath!==undefined){paths.push(fluid.model.composePaths(transformer.inputPrefix,inputPath))}};fluid.model.transform.accumulateStandardInputPath=function(input,transformSpec,transformer,paths){fluid.model.transform.getValue(undefined,transformSpec[input],transformer);fluid.model.transform.accumulateInputPath(transformSpec[input+"Path"],transformer,paths)};fluid.model.transform.accumulateMultiInputPaths=function(inputVariables,transformSpec,transformer,paths){fluid.each(inputVariables,(function(v,k){fluid.model.transform.accumulateStandardInputPath(k,transformSpec,transformer,paths)}))};fluid.model.transform.getValue=function(inputPath,value,transformer){var togo;if(inputPath!==undefined){togo=fluid.get(transformer.source,fluid.model.composePaths(transformer.inputPrefix,inputPath),transformer.resolverGetConfig)}if(togo===undefined){togo=fluid.isPrimitive(value)?value:"literalValue"in value?value.literalValue:value.transform===undefined?value:transformer.expand(value)}return togo};fluid.model.transform.NONDEFAULT_OUTPUT_PATH_RETURN={};fluid.model.transform.setValue=function(userOutputPath,value,transformer){var toset=fluid.copy(value);var outputPath=fluid.model.composePaths(transformer.outputPrefix,userOutputPath);if(toset!==undefined){transformer.applier.change(outputPath,toset)}return userOutputPath?fluid.model.transform.NONDEFAULT_OUTPUT_PATH_RETURN:toset};fluid.model.transform.resolveParam=function(transformSpec,transformer,key,def){var val=fluid.model.transform.getValue(transformSpec[key+"Path"],transformSpec[key],transformer);return val!==undefined?val:def};fluid.model.transform.matchValue=function(expected,actual,partialMatches){var stats={changes:0,unchanged:0,changeMap:{}};fluid.model.diff(expected,actual,stats);return stats.unchanged===0?0:partialMatches?0xffffff000000-16777216*stats.changes+stats.unchanged:stats.changes?0:0xffffff000000+stats.unchanged};fluid.model.transform.invertPaths=function(transformSpec,transformer){var oldOutput=fluid.model.composePaths(transformer.outputPrefix,transformSpec.outputPath);transformSpec.outputPath=fluid.model.composePaths(transformer.inputPrefix,transformSpec.inputPath);transformSpec.inputPath=oldOutput;return transformSpec};fluid.model.transform.prefixApplier=function(transformSpec,transformer){if(transformSpec.inputPrefix){transformer.inputPrefixOp.push(transformSpec.inputPrefix)}if(transformSpec.outputPrefix){transformer.outputPrefixOp.push(transformSpec.outputPrefix)}transformer.expand(transformSpec.input);if(transformSpec.inputPrefix){transformer.inputPrefixOp.pop()}if(transformSpec.outputPrefix){transformer.outputPrefixOp.pop()}};fluid.defaults("fluid.model.transform.prefixApplier",{gradeNames:["fluid.transformFunction"]});fluid.model.makePathStack=function(transform,prefixName){var stack=transform[prefixName+"Stack"]=[];transform[prefixName]="";return{push:function(prefix){var newPath=fluid.model.composePaths(transform[prefixName],prefix);stack.push(transform[prefixName]);transform[prefixName]=newPath},pop:function(){transform[prefixName]=stack.pop()}}};fluid.model.transform.doTransform=function(transformSpec,transformer,transformOpts){var expdef=transformOpts.defaults;var transformFn=fluid.getGlobalValue(transformOpts.typeName);if(typeof transformFn!=="function"){fluid.fail("Transformation record specifies transformation function with name "+transformSpec.type+" which is not a function - ",transformFn)}if(!fluid.hasGrade(expdef,"fluid.transformFunction")){expdef=fluid.defaults("fluid.standardTransformFunction")}var transformArgs=[transformSpec,transformer];if(fluid.hasGrade(expdef,"fluid.multiInputTransformFunction")){var inputs={};fluid.each(expdef.inputVariables,(function(v,k){inputs[k]=function(){var input=fluid.model.transform.getValue(transformSpec[k+"Path"],transformSpec[k],transformer);input=input===undefined&&v!==null?v:input;return input}}));transformArgs.unshift(inputs)}if(fluid.hasGrade(expdef,"fluid.standardInputTransformFunction")){if(!("input"in transformSpec)&&!("inputPath"in transformSpec)){fluid.fail('Error in transform specification. Either "input" or "inputPath" must be specified for a standardInputTransformFunction: received ',transformSpec)}var expanded=fluid.model.transform.getValue(transformSpec.inputPath,transformSpec.input,transformer);transformArgs.unshift(expanded);if(expanded===undefined){return undefined}}var transformed=transformFn.apply(null,transformArgs);if(fluid.hasGrade(expdef,"fluid.standardOutputTransformFunction")){var outputPath=transformSpec.outputPath!==undefined?transformSpec.outputPath:transformOpts.doOutput?"":undefined;if(outputPath!==undefined&&transformed!==undefined){fluid.model.transform.setValue(transformSpec.outputPath,transformed,transformer);transformed=undefined}}return transformed};var globalAccept=[];fluid.registerNamespace("fluid.pathUtil");fluid.pathUtil.getPathSegment=function(path,i){fluid.pathUtil.getPathSegmentImpl(globalAccept,path,i);return globalAccept[0]};fluid.pathUtil.getHeadPath=function(path){return fluid.pathUtil.getPathSegment(path,0)};fluid.pathUtil.getFromHeadPath=function(path){var firstdot=fluid.pathUtil.getPathSegmentImpl(null,path,0);return firstdot===path.length?"":path.substring(firstdot+1)};fluid.pathUtil.matchPath=function(spec,path,exact){var togo=[];while(true){if(path===""^spec===""&&exact){return null}if(!spec||!path){break}var spechead=fluid.pathUtil.getHeadPath(spec);var pathhead=fluid.pathUtil.getHeadPath(path);if(spechead!=="*"&&spechead!==pathhead){return null}togo.push(pathhead);spec=fluid.pathUtil.getFromHeadPath(spec);path=fluid.pathUtil.getFromHeadPath(path)}return togo};fluid.model.transform.expandWildcards=function(transformer,source){fluid.each(source,(function(value,key){var q=transformer.queuedTransforms;transformer.pathOp.push(fluid.pathUtil.escapeSegment(key.toString()));for(var i=0;i<q.length;++i){if(fluid.pathUtil.matchPath(q[i].matchPath,transformer.path,true)){var esCopy=fluid.copy(q[i].transformSpec);if(esCopy.inputPath===undefined||fluid.model.transform.hasWildcard(esCopy.inputPath)){esCopy.inputPath=""}transformer.inputPrefixOp.push(transformer.path);transformer.outputPrefixOp.push(transformer.path);var transformOpts=fluid.model.transform.lookupType(esCopy.type);var result=fluid.model.transform.doTransform(esCopy,transformer,transformOpts);if(result!==undefined){fluid.model.transform.setValue(null,result,transformer)}transformer.outputPrefixOp.pop();transformer.inputPrefixOp.pop()}}if(!fluid.isPrimitive(value)){fluid.model.transform.expandWildcards(transformer,value)}transformer.pathOp.pop()}))};fluid.model.transform.hasWildcard=function(path){return typeof path==="string"&&path.indexOf("*")!==-1};fluid.model.transform.maybePushWildcard=function(transformSpec,transformer){var hw=fluid.model.transform.hasWildcard;var matchPath;if(hw(transformSpec.inputPath)){matchPath=fluid.model.composePaths(transformer.inputPrefix,transformSpec.inputPath)}else if(hw(transformer.outputPrefix)||hw(transformSpec.outputPath)){matchPath=fluid.model.composePaths(transformer.outputPrefix,transformSpec.outputPath)}if(matchPath){transformer.queuedTransforms.push({transformSpec:transformSpec,outputPrefix:transformer.outputPrefix,inputPrefix:transformer.inputPrefix,matchPath:matchPath});return true}return false};fluid.model.sortByKeyLength=function(inObject){var keys=fluid.keys(inObject);return keys.sort(fluid.compareStringLength(true))};fluid.model.transform.handleTransformStrategy=function(transformSpec,transformer,transformOpts){if(fluid.model.transform.maybePushWildcard(transformSpec,transformer)){return}else{return fluid.model.transform.doTransform(transformSpec,transformer,transformOpts)}};fluid.model.transform.handleInvertStrategy=function(transformSpec,transformer,transformOpts){transformSpec=fluid.copy(transformSpec);if(fluid.hasGrade(transformOpts.defaults,"fluid.standardTransformFunction")){transformSpec=fluid.model.transform.invertPaths(transformSpec,transformer)}var invertor=transformOpts.defaults&&transformOpts.defaults.invertConfiguration;if(invertor){var inverted=fluid.invokeGlobalFunction(invertor,[transformSpec,transformer]);transformer.inverted.push(inverted)}else{transformer.inverted.push(fluid.model.transform.uninvertibleTransform)}};fluid.model.transform.handleCollectStrategy=function(transformSpec,transformer,transformOpts){var defaults=transformOpts.defaults;var standardInput=fluid.hasGrade(defaults,"fluid.standardInputTransformFunction");var multiInput=fluid.hasGrade(defaults,"fluid.multiInputTransformFunction");if(standardInput){fluid.model.transform.accumulateStandardInputPath("input",transformSpec,transformer,transformer.inputPaths)}if(multiInput){fluid.model.transform.accumulateMultiInputPaths(defaults.inputVariables,transformSpec,transformer,transformer.inputPaths)}var collector=defaults.collectInputPaths;if(collector){var collected=fluid.makeArray(fluid.invokeGlobalFunction(collector,[transformSpec,transformer]));Array.prototype.push.apply(transformer.inputPaths,collected)}};fluid.model.transform.lookupType=function(typeName,transformSpec){if(!typeName){fluid.fail("Transformation record is missing a type name: ",transformSpec)}if(typeName.indexOf(".")===-1){typeName="fluid.transforms."+typeName}var defaults=fluid.defaults(typeName);return{defaults:defaults,typeName:typeName}};fluid.model.transform.processRule=function(rule,transformer){if(typeof rule==="string"){rule=fluid.model.transform.pathToRule(rule)}else if(rule.literalValue!==undefined){rule=fluid.model.transform.literalValueToRule(rule.literalValue)}var togo;if(rule.transform){var transformSpec,transformOpts;if(fluid.isArrayable(rule.transform)){var transforms=rule.transform;togo=undefined;for(var i=0;i<transforms.length;++i){transformSpec=transforms[i];transformOpts=fluid.model.transform.lookupType(transformSpec.type);transformer.transformHandler(transformSpec,transformer,transformOpts)}}else{transformSpec=rule.transform;transformOpts=fluid.model.transform.lookupType(transformSpec.type);togo=transformer.transformHandler(transformSpec,transformer,transformOpts)}}if(fluid.isArrayable(rule)){transformer.collectedFlatSchemaOpts=transformer.collectedFlatSchemaOpts||{};transformer.collectedFlatSchemaOpts[transformer.outputPrefix]="array"}fluid.each(rule,(function(value,key){if(key!=="transform"){transformer.outputPrefixOp.push(key);var togo=transformer.expand(value,transformer);if(togo!==undefined){fluid.model.transform.setValue(null,togo,transformer);togo=undefined}transformer.outputPrefixOp.pop()}}));return togo};fluid.model.transform.makeStrategy=function(transformer,handleFn,transformFn){transformFn=transformFn||fluid.model.transform.processRule;transformer.expand=function(rules){return transformFn(rules,transformer)};transformer.outputPrefixOp=fluid.model.makePathStack(transformer,"outputPrefix");transformer.inputPrefixOp=fluid.model.makePathStack(transformer,"inputPrefix");transformer.transformHandler=handleFn};fluid.model.transform.uninvertibleTransform=Object.freeze({});fluid.model.transform.invertConfiguration=function(rules){var transformer={inverted:[]};fluid.model.transform.makeStrategy(transformer,fluid.model.transform.handleInvertStrategy);transformer.expand(rules);var invertible=transformer.inverted.indexOf(fluid.model.transform.uninvertibleTransform)===-1;return invertible?{transform:transformer.inverted}:fluid.model.transform.uninvertibleTransform};fluid.model.transform.collectInputPaths=function(rules){var transformer={inputPaths:[]};fluid.model.transform.makeStrategy(transformer,fluid.model.transform.handleCollectStrategy);transformer.expand(rules);var inputPathHash=fluid.arrayToHash(transformer.inputPaths);return Object.keys(inputPathHash)};fluid.model.transform.flatSchemaStrategy=function(flatSchema,getConfig){var keys=fluid.model.sortByKeyLength(flatSchema);return function(root,segment,index,segs){var path=getConfig.parser.compose.apply(null,segs.slice(0,index));for(var i=0;i<keys.length;++i){var key=keys[i];if(fluid.pathUtil.matchPath(key,path,true)!==null){return flatSchema[key]}}}};fluid.model.transform.defaultSchemaValue=function(schemaValue){var type=fluid.isPrimitive(schemaValue)?schemaValue:schemaValue.type;return type==="array"?[]:{}};fluid.model.transform.isomorphicSchemaStrategy=function(source,getConfig){return function(root,segment,index,segs){var existing=fluid.get(source,segs.slice(0,index),getConfig);return fluid.isArrayable(existing)?"array":"object"}};fluid.model.transform.decodeStrategy=function(source,options,getConfig){if(options.isomorphic){return fluid.model.transform.isomorphicSchemaStrategy(source,getConfig)}else if(options.flatSchema){return fluid.model.transform.flatSchemaStrategy(options.flatSchema,getConfig)}};fluid.model.transform.schemaToCreatorStrategy=function(strategy){return function(root,segment,index,segs){if(root[segment]===undefined){var schemaValue=strategy(root,segment,index,segs);root[segment]=fluid.model.transform.defaultSchemaValue(schemaValue);return root[segment]}}};fluid.model.transform.sequence=function(source,rules,options){for(var i=0;i<rules.length;++i){source=fluid.model.transform(source,rules[i],options)}return source};fluid.model.compareByPathLength=function(changea,changeb){var pdiff=changea.path.length-changeb.path.length;return pdiff===0?changea.sequence-changeb.sequence:pdiff};fluid.model.fireSortedChanges=function(changes,applier){changes.sort(fluid.model.compareByPathLength);fluid.fireChanges(applier,changes)};fluid.model.transformWithRules=function(source,rules,options){options=options||{};var getConfig=fluid.model.escapedGetConfig;var setConfig=fluid.model.escapedSetConfig;var schemaStrategy=fluid.model.transform.decodeStrategy(source,options,getConfig);var transformer={source:source,target:{model:schemaStrategy?fluid.model.transform.defaultSchemaValue(schemaStrategy(null,"",0,[""])):{}},oldSource:options.oldSource,oldTarget:options.oldTarget,resolverGetConfig:getConfig,resolverSetConfig:setConfig,collectedFlatSchemaOpts:undefined,queuedChanges:[],queuedTransforms:[]};fluid.model.transform.makeStrategy(transformer,fluid.model.transform.handleTransformStrategy);transformer.applier={fireChangeRequest:function(changeRequest){changeRequest.sequence=transformer.queuedChanges.length;transformer.queuedChanges.push(changeRequest)}};fluid.bindRequestChange(transformer.applier);transformer.expand(rules);var rootSetConfig=fluid.copy(setConfig);if(transformer.collectedFlatSchemaOpts!==undefined){$.extend(transformer.collectedFlatSchemaOpts,options.flatSchema);schemaStrategy=fluid.model.transform.flatSchemaStrategy(transformer.collectedFlatSchemaOpts,getConfig)}rootSetConfig.strategies=[fluid.model.defaultFetchStrategy,schemaStrategy?fluid.model.transform.schemaToCreatorStrategy(schemaStrategy):fluid.model.defaultCreatorStrategy];transformer.finalApplier=options.finalApplier||fluid.makeHolderChangeApplier(transformer.target,{resolverSetConfig:rootSetConfig});if(transformer.queuedTransforms.length>0){transformer.typeStack=[];transformer.pathOp=fluid.model.makePathStack(transformer,"path");fluid.model.transform.expandWildcards(transformer,source)}fluid.model.fireSortedChanges(transformer.queuedChanges,transformer.finalApplier);return transformer.target.model};$.extend(fluid.model.transformWithRules,fluid.model.transform);fluid.model.transform=fluid.model.transformWithRules;fluid.transformOne=function(rules){return{transformOptions:{transformer:"fluid.model.transformWithRules",config:rules}}};fluid.transformMany=function(rules){return{transformOptions:{transformer:"fluid.model.transform.sequence",config:rules}}};"use strict";fluid.registerNamespace("fluid.model.transform");fluid.registerNamespace("fluid.transforms");fluid.defaults("fluid.transforms.value",{gradeNames:"fluid.standardTransformFunction",invertConfiguration:"fluid.identity"});fluid.transforms.value=fluid.identity;fluid.transforms.identity=fluid.transforms.value;fluid.defaults("fluid.transforms.identity",{gradeNames:"fluid.transforms.value"});fluid.transforms.invertToIdentity=function(transformSpec){transformSpec.type="fluid.transforms.identity";return transformSpec};fluid.defaults("fluid.transforms.literalValue",{gradeNames:"fluid.standardOutputTransformFunction"});fluid.transforms.literalValue=function(transformSpec){return transformSpec.input};fluid.defaults("fluid.transforms.stringToNumber",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.stringToNumber.invert"});fluid.transforms.stringToNumber=function(value){var newValue=Number(value);return isNaN(newValue)?undefined:newValue};fluid.transforms.stringToNumber.invert=function(transformSpec){transformSpec.type="fluid.transforms.numberToString";return transformSpec};fluid.defaults("fluid.transforms.numberToString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.numberToString.invert"});fluid.transforms.numberToString=function(value,transformSpec){if(typeof value==="number"){if(typeof transformSpec.scale==="number"&&!isNaN(transformSpec.scale)){var rounded=fluid.roundToDecimal(value,transformSpec.scale,transformSpec.method);return rounded.toString()}else{return value.toString()}}};fluid.transforms.numberToString.invert=function(transformSpec){transformSpec.type="fluid.transforms.stringToNumber";return transformSpec};fluid.defaults("fluid.transforms.count",{gradeNames:"fluid.standardTransformFunction"});fluid.transforms.count=function(value){return fluid.makeArray(value).length};fluid.defaults("fluid.transforms.round",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.invertToIdentity"});fluid.transforms.round=function(value,transformSpec){return fluid.roundToDecimal(value,transformSpec.scale,transformSpec.method)};fluid.defaults("fluid.transforms.delete",{gradeNames:"fluid.transformFunction"});fluid.transforms["delete"]=function(transformSpec,transformer){var outputPath=fluid.model.composePaths(transformer.outputPrefix,transformSpec.outputPath);transformer.applier.change(outputPath,null,"DELETE")};fluid.defaults("fluid.transforms.firstValue",{gradeNames:"fluid.standardOutputTransformFunction"});fluid.transforms.firstValue=function(transformSpec,transformer){if(!transformSpec.values||!transformSpec.values.length){fluid.fail('firstValue transformer requires an array of values at path named "values", supplied',transformSpec)}for(var i=0;i<transformSpec.values.length;i++){var value=transformSpec.values[i];var expanded=transformer.expand(value);if(expanded!==undefined){return expanded}}};fluid.defaults("fluid.transforms.linearScale",{gradeNames:["fluid.multiInputTransformFunction","fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.linearScale.invert",inputVariables:{factor:1,offset:0}});fluid.transforms.linearScale=function(input,extraInputs){var factor=extraInputs.factor();var offset=extraInputs.offset();if(typeof input!=="number"||typeof factor!=="number"||typeof offset!=="number"){return undefined}return input*factor+offset};fluid.transforms.linearScale.invert=function(transformSpec){delete transformSpec.factorPath;delete transformSpec.offsetPath;if(transformSpec.factor!==undefined){transformSpec.factor=transformSpec.factor===0?0:1/transformSpec.factor}if(transformSpec.offset!==undefined){transformSpec.offset=-transformSpec.offset*(transformSpec.factor!==undefined?transformSpec.factor:1)}return transformSpec};fluid.defaults("fluid.transforms.binaryOp",{gradeNames:["fluid.multiInputTransformFunction","fluid.standardOutputTransformFunction"],inputVariables:{left:null,right:null}});fluid.transforms.binaryLookup={"===":function(a,b){return fluid.model.isSameValue(a,b)},"!==":function(a,b){return!fluid.model.isSameValue(a,b)},"<=":function(a,b){return a<=b},"<":function(a,b){return a<b},">=":function(a,b){return a>=b},">":function(a,b){return a>b},"+":function(a,b){return a+b},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"%":function(a,b){return a%b},"&&":function(a,b){return a&&b},"||":function(a,b){return a||b}};fluid.transforms.binaryOp=function(inputs,transformSpec,transformer){var left=inputs.left();var right=inputs.right();var operator=fluid.model.transform.getValue(undefined,transformSpec.operator,transformer);var fun=fluid.transforms.binaryLookup[operator];return fun===undefined||left===undefined||right===undefined?undefined:fun(left,right)};fluid.defaults("fluid.transforms.condition",{gradeNames:["fluid.multiInputTransformFunction","fluid.standardOutputTransformFunction"],inputVariables:{true:null,false:null,condition:null}});fluid.transforms.condition=function(inputs){var condition=inputs.condition();if(condition===null){return undefined}return inputs[condition?"true":"false"]()};fluid.defaults("fluid.transforms.valueMapper",{gradeNames:["fluid.lens"],invertConfiguration:"fluid.transforms.valueMapper.invert",collectInputPaths:"fluid.transforms.valueMapper.collect"});fluid.model.transform.compareMatches=function(speca,specb){var matchDiff=specb.matchValue-speca.matchValue;return matchDiff===0?speca.index-specb.index:matchDiff};fluid.transforms.valueMapper=function(transformSpec,transformer){if(!transformSpec.match){fluid.fail('valueMapper requires an array or hash of matches at path named "match", supplied ',transformSpec)}var value=fluid.model.transform.getValue(transformSpec.defaultInputPath,transformSpec.defaultInput,transformer);var matchedEntry=fluid.isArrayable(transformSpec.match)?fluid.transforms.valueMapper.longFormMatch(value,transformSpec,transformer):transformSpec.match[value];if(matchedEntry===undefined){matchedEntry=transformSpec.noMatch}if(matchedEntry===undefined){return}var outputPath=matchedEntry.outputPath===undefined?transformSpec.defaultOutputPath:matchedEntry.outputPath;transformer.outputPrefixOp.push(outputPath);var outputValue;if(fluid.isPrimitive(matchedEntry)){outputValue=matchedEntry}else if(matchedEntry.outputUndefinedValue){outputValue=undefined}else{outputValue=fluid.model.transform.resolveParam(matchedEntry,transformer,"outputValue",undefined);outputValue=outputValue===undefined?transformSpec.defaultOutputValue:outputValue}if(typeof outputPath==="string"&&outputValue!==undefined){fluid.model.transform.setValue(undefined,outputValue,transformer,transformSpec.merge);outputValue=undefined}transformer.outputPrefixOp.pop();return outputValue};fluid.transforms.valueMapper.longFormMatch=function(valueFromDefaultPath,transformSpec,transformer){var o=transformSpec.match;if(o.length===0){fluid.fail("valueMapper supplied empty list of matches: ",transformSpec)}var matchPower=[];for(var i=0;i<o.length;++i){var option=o[i];var value=option.inputPath?fluid.model.transform.getValue(option.inputPath,undefined,transformer):valueFromDefaultPath;var matchValue=fluid.model.transform.matchValue(option.inputValue,value,option.partialMatches);matchPower[i]={index:i,matchValue:matchValue}}matchPower.sort(fluid.model.transform.compareMatches);return matchPower[0].matchValue<=0?undefined:o[matchPower[0].index]};fluid.transforms.valueMapper.invert=function(transformSpec,transformer){var match=[];var togo={type:"fluid.transforms.valueMapper",match:match};var isArray=fluid.isArrayable(transformSpec.match);togo.defaultInputPath=fluid.model.composePaths(transformer.outputPrefix,transformSpec.defaultOutputPath);togo.defaultOutputPath=fluid.model.composePaths(transformer.inputPrefix,transformSpec.defaultInputPath);var def=fluid.firstDefined;fluid.each(transformSpec.match,(function(option,key){if(option.outputUndefinedValue===true){return}var outOption={};var origInputValue=def(isArray?option.inputValue:key,transformSpec.defaultInputValue);if(origInputValue===undefined){fluid.fail("Failure inverting configuration for valueMapper - inputValue could not be resolved for record "+key+": ",transformSpec)}outOption.outputValue=origInputValue;outOption.inputValue=!isArray&&fluid.isPrimitive(option)?option:def(option.outputValue,transformSpec.defaultOutputValue);if(option.outputPath){outOption.inputPath=fluid.model.composePaths(transformer.outputPrefix,def(option.outputPath,transformSpec.outputPath))}if(option.inputPath){outOption.outputPath=fluid.model.composePaths(transformer.inputPrefix,def(option.inputPath,transformSpec.inputPath))}match.push(outOption)}));return togo};fluid.transforms.valueMapper.collect=function(transformSpec,transformer){var togo=[];fluid.model.transform.accumulateStandardInputPath("defaultInput",transformSpec,transformer,togo);fluid.each(transformSpec.match,(function(option){fluid.model.transform.accumulateInputPath(option.inputPath,transformer,togo)}));return togo};fluid.defaults("fluid.transforms.arrayToSetMembership",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.arrayToSetMembership.invert"});fluid.transforms.arrayToSetMembership=function(value,transformSpec){if(!value||!fluid.isArrayable(value)){fluid.fail("arrayToSetMembership didn't find array at inputPath nor passed as value.")}transformSpec=transformSpec||{};var output=transformSpec.arrayValue?[]:{};var presentValue=transformSpec.presentValue===undefined?true:transformSpec.presentValue,missingValue=transformSpec.missingValue===undefined?false:transformSpec.missingValue,options=transformSpec.options;if(options===undefined){fluid.each(value,(function(outPath){output[outPath]=presentValue}))}else{fluid.each(options,(function(outPath,key){var outVal=value.indexOf(key)!==-1?presentValue:missingValue;output[outPath]=outVal}))}return output};fluid.transforms.arrayToSetMembership.invert=function(transformSpec){return fluid.transforms.arrayToSetMembership.invertWithType(transformSpec,"fluid.transforms.setMembershipToArray")};fluid.transforms.arrayToSetMembership.invertWithType=function(transformSpec,newType){transformSpec.type=newType;var newOptions={};fluid.each(transformSpec.options,(function(path,oldKey){newOptions[path]=oldKey}));if(!$.isEmptyObject(newOptions)){transformSpec.options=newOptions}return transformSpec};fluid.defaults("fluid.transforms.setMembershipToArray",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.setMembershipToArray.invert"});fluid.transforms.setMembershipToArray=function(input,transformSpec){if(!fluid.isPlainObject(input)){fluid.fail("setMembershipToArray didn't find object at inputPath nor passed as value.")}var outputArr=[];transformSpec=transformSpec||{};var presentValue=transformSpec.presentValue===undefined?true:transformSpec.presentValue,options=transformSpec.options;if(options===undefined){fluid.each(input,(function(keyValue,outputVal){if(keyValue===presentValue){outputArr.push(outputVal)}}))}else{fluid.each(options,(function(outputVal,key){if(input[key]===presentValue){outputArr.push(outputVal)}}))}return outputArr};fluid.transforms.setMembershipToArray.invert=function(transformSpec){return fluid.transforms.arrayToSetMembership.invertWithType(transformSpec,"fluid.transforms.arrayToSetMembership")};fluid.model.transform.applyPaths=function(operation,pathOp,paths){for(var i=0;i<paths.length;++i){if(operation==="push"){pathOp.push(paths[i])}else{pathOp.pop()}}};fluid.model.transform.expandInnerValues=function(inputPath,outputPath,transformer,innerValues){var inputPrefixOp=transformer.inputPrefixOp;var outputPrefixOp=transformer.outputPrefixOp;var apply=fluid.model.transform.applyPaths;apply("push",inputPrefixOp,inputPath);apply("push",outputPrefixOp,outputPath);var expanded={};fluid.each(innerValues,(function(innerValue){var expandedInner=transformer.expand(innerValue);if(!fluid.isPrimitive(expandedInner)){$.extend(true,expanded,expandedInner)}else{expanded=expandedInner}}));apply("pop",outputPrefixOp,outputPath);apply("pop",inputPrefixOp,inputPath);return expanded};fluid.defaults("fluid.transforms.indexArrayByKey",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.indexArrayByKey.invert"});fluid.transforms.indexArrayByKey=function(arr,transformSpec,transformer){if(transformSpec.key===undefined){fluid.fail("indexArrayByKey requires a 'key' option.",transformSpec)}if(!fluid.isArrayable(arr)){fluid.fail("indexArrayByKey didn't find array at inputPath.",transformSpec)}var newHash={};var pivot=transformSpec.key;fluid.each(arr,(function(v,k){var newKey=v[pivot];var keyType=typeof newKey;if(keyType!=="string"&&keyType!=="boolean"&&keyType!=="number"){fluid.fail("indexArrayByKey encountered untransformable array due to missing or invalid key",v)}var content=fluid.copy(v);delete content[pivot];if(transformSpec.innerValue){content=fluid.model.transform.expandInnerValues([transformer.inputPrefix,transformSpec.inputPath,k.toString()],[transformSpec.outputPath,newKey],transformer,transformSpec.innerValue)}newHash[newKey]=content}));return newHash};fluid.transforms.indexArrayByKey.invert=function(transformSpec){transformSpec.type="fluid.transforms.deindexIntoArrayByKey";if(transformSpec.innerValue){var innerValue=transformSpec.innerValue;for(var i=0;i<innerValue.length;++i){var inverted=fluid.model.transform.invertConfiguration(innerValue[i]);if(inverted===fluid.model.transform.uninvertibleTransform){return inverted}else{innerValue[i]=inverted}}}return transformSpec};fluid.defaults("fluid.transforms.deindexIntoArrayByKey",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.deindexIntoArrayByKey.invert"});fluid.transforms.deindexIntoArrayByKey=function(hash,transformSpec,transformer){if(transformSpec.key===undefined){fluid.fail('deindexIntoArrayByKey requires a "key" option.',transformSpec)}var newArray=[];var pivot=transformSpec.key;fluid.each(hash,(function(v,k){var content={};content[pivot]=k;if(transformSpec.innerValue){v=fluid.model.transform.expandInnerValues([transformSpec.inputPath,k],[transformSpec.outputPath,newArray.length.toString()],transformer,transformSpec.innerValue)}$.extend(true,content,v);newArray.push(content)}));return newArray};fluid.transforms.deindexIntoArrayByKey.invert=function(transformSpec){transformSpec.type="fluid.transforms.indexArrayByKey";if(transformSpec.innerValue){var innerValue=transformSpec.innerValue;for(var i=0;i<innerValue.length;++i){innerValue[i]=fluid.model.transform.invertConfiguration(innerValue[i])}}return transformSpec};fluid.defaults("fluid.transforms.limitRange",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.invertToIdentity"});fluid.transforms.limitRange=function(value,transformSpec){var min=transformSpec.min;if(min!==undefined){var excludeMin=transformSpec.excludeMin||0;min+=excludeMin;if(value<min){value=min}}var max=transformSpec.max;if(max!==undefined){var excludeMax=transformSpec.excludeMax||0;max-=excludeMax;if(value>max){value=max}}return value};fluid.defaults("fluid.transforms.indexOf",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.indexOf.invert"});fluid.transforms.indexOf=function(value,transformSpec){if(typeof transformSpec.notFound==="number"&&transformSpec.notFound>=0){fluid.fail("A positive number is not allowed as 'notFound' value for indexOf")}var offset=fluid.transforms.parseIndexationOffset(transformSpec.offset,"indexOf");var array=fluid.makeArray(transformSpec.array);var originalIndex=array.indexOf(value);return originalIndex===-1&&transformSpec.notFound?transformSpec.notFound:originalIndex+offset};fluid.transforms.indexOf.invert=function(transformSpec,transformer){var togo=fluid.transforms.invertArrayIndexation(transformSpec,transformer);togo.type="fluid.transforms.dereference";return togo};fluid.defaults("fluid.transforms.dereference",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.dereference.invert"});fluid.transforms.dereference=function(value,transformSpec){if(typeof value!=="number"){return undefined}var offset=fluid.transforms.parseIndexationOffset(transformSpec.offset,"dereference");var array=fluid.makeArray(transformSpec.array);var index=value+offset;return array[index]};fluid.transforms.dereference.invert=function(transformSpec,transformer){var togo=fluid.transforms.invertArrayIndexation(transformSpec,transformer);togo.type="fluid.transforms.indexOf";return togo};fluid.transforms.parseIndexationOffset=function(offset,transformName){var parsedOffset=0;if(offset!==undefined){parsedOffset=fluid.parseInteger(offset);if(isNaN(parsedOffset)){fluid.fail(transformName+' requires the value of "offset" to be an integer or a string that can be converted to an integer. '+offset+" is invalid.")}}return parsedOffset};fluid.transforms.invertArrayIndexation=function(transformSpec){if(!isNaN(Number(transformSpec.offset))){transformSpec.offset=Number(transformSpec.offset)*-1}return transformSpec};fluid.defaults("fluid.transforms.stringTemplate",{gradeNames:"fluid.standardOutputTransformFunction"});fluid.transforms.stringTemplate=function(transformSpec){return fluid.stringTemplate(transformSpec.template,transformSpec.terms)};fluid.defaults("fluid.transforms.free",{gradeNames:"fluid.transformFunction"});fluid.transforms.free=function(transformSpec){var args=fluid.makeArray(transformSpec.args);if(!transformSpec.func){fluid.fail("Error in transform specification ",transformSpec,' required member "func" was not set')}return fluid.event.invokeListener(transformSpec.func,args)};fluid.defaults("fluid.transforms.quantize",{gradeNames:"fluid.standardTransformFunction",collectInputPaths:"fluid.transforms.quantize.collect"});fluid.transforms.quantize=function(value,transformSpec,transformer){if(!transformSpec.ranges||!transformSpec.ranges.length){fluid.fail("fluid.transforms.quantize should have a key called ranges containing an array defining ranges to quantize")}for(var i=0;i<transformSpec.ranges.length;i++){var rangeSpec=transformSpec.ranges[i];if(value<=rangeSpec.upperBound||rangeSpec.upperBound===undefined&&value>=Number.NEGATIVE_INFINITY){return fluid.isPrimitive(rangeSpec.output)?rangeSpec.output:transformer.expand(rangeSpec.output)}}};fluid.transforms.quantize.collect=function(transformSpec,transformer){transformSpec.ranges.forEach((function(rangeSpec){if(!fluid.isPrimitive(rangeSpec.output)){transformer.expand(rangeSpec.output)}}))};fluid.defaults("fluid.transforms.inRange",{gradeNames:"fluid.standardTransformFunction"});fluid.transforms.inRange=function(value,transformSpec){return(transformSpec.min===undefined||transformSpec.min<=value)&&(transformSpec.max===undefined||transformSpec.max>=value)?true:false};fluid.defaults("fluid.transforms.toggle",{gradeNames:["fluid.standardTransformFunction"],invertConfiguration:"fluid.transforms.toggle.invert",relayOptions:{forward:{excludeSource:"init"},backward:{includeSource:"init"}}});fluid.transforms.toggle=function(source,transformSpec,transformer){var oldSource=transformer.oldSource,oldTarget=transformer.oldTarget;var phase=(oldSource||0)-fluid.transforms.inverseToggle.base(oldTarget);return fluid.transforms.toggle.base(source+phase)};fluid.transforms.toggle.base=function(source){return(source||0)%2===1};fluid.transforms.toggle.invert=function(transformSpec){transformSpec.type="fluid.transforms.inverseToggle";return transformSpec};fluid.defaults("fluid.transforms.inverseToggle",{gradeNames:["fluid.standardTransformFunction"]});fluid.transforms.inverseToggle=function(source,transformSpec,transformer){return transformer.originalTarget||undefined};fluid.transforms.inverseToggle.base=function(source){return source?1:0};fluid.transforms.parseClasses=function(classes){var classList=classes.match(fluid.transforms.parseClasses.rnothtmlwhite)||[];return fluid.arrayToHash(classList)};fluid.transforms.parseClasses.rnothtmlwhite=/[^\x20\t\r\n\f]+/g;fluid.transforms.stringToBoolean=function(value){if(value){return!(value==="0"||value==="false")}else{return false}};fluid.transforms.stringToBoolean.invert=function(transformSpec){transformSpec.type="fluid.transforms.booleanToString";return transformSpec};fluid.defaults("fluid.transforms.stringToBoolean",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.stringToBoolean.invert"});fluid.transforms.booleanToString=function(value){return value?"true":"false"};fluid.transforms.booleanToString.invert=function(transformSpec){transformSpec.type="fluid.transforms.stringToBoolean";return transformSpec};fluid.defaults("fluid.transforms.booleanToString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.booleanToString.invert"});fluid.transforms.JSONstringToObject=function(value){try{return JSON.parse(value)}catch(e){return undefined}};fluid.transforms.JSONstringToObject.invert=function(transformSpec){transformSpec.type="fluid.transforms.objectToJSONString";return transformSpec};fluid.defaults("fluid.transforms.JSONstringToObject",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.JSONstringToObject.invert"});fluid.transforms.objectToJSONString=function(value,transformSpec){var space=transformSpec.space||0;return JSON.stringify(value,null,space)};fluid.transforms.objectToJSONString.invert=function(transformSpec){transformSpec.type="fluid.transforms.JSONstringToObject";return transformSpec};fluid.defaults("fluid.transforms.objectToJSONString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.objectToJSONString.invert"});fluid.transforms.stringToDate=function(value){var date=new Date(value);return isNaN(date.getTime())?undefined:date};fluid.transforms.stringToDate.invert=function(transformSpec){transformSpec.type="fluid.transforms.dateToString";return transformSpec};fluid.defaults("fluid.transforms.stringToDate",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.stringToDate.invert"});fluid.transforms.dateToString=function(value){if(value instanceof Date){var isoString=value.toISOString();var dateString=isoString.substring(0,isoString.indexOf("T"));return dateString}else{return undefined}};fluid.transforms.dateToString.invert=function(transformSpec){transformSpec.type="fluid.transforms.stringToDate";return transformSpec};fluid.defaults("fluid.transforms.dateToString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.dateToString.invert"});fluid.transforms.dateTimeToString=function(value){return value instanceof Date?value.toISOString():undefined};fluid.defaults("fluid.transforms.dateTimeToString",{gradeNames:["fluid.standardTransformFunction","fluid.lens"],invertConfiguration:"fluid.transforms.dateToString.invert"});"use strict";fluid.registerNamespace("fluid.contextAware");fluid.defaults("fluid.contextAware.marker",{gradeNames:["fluid.component"]});fluid.contextAware.makeCheckMarkers=function(checks,path,instantiator){fluid.each(checks,(function(value,markerTypeName){fluid.constructSingle(path,{type:markerTypeName,gradeNames:"fluid.contextAware.marker",value:value},instantiator)}))};fluid.contextAware.performChecks=function(checkHash){return fluid.transform(checkHash,(function(checkRecord){if(typeof checkRecord==="function"){checkRecord={func:checkRecord}}else if(typeof checkRecord==="string"){checkRecord={funcName:checkRecord}}if(fluid.isPrimitive(checkRecord)){return checkRecord}else if("value"in checkRecord){return checkRecord.value}else if("func"in checkRecord){return checkRecord.func()}else if("funcName"in checkRecord){return fluid.invokeGlobalFunction(checkRecord.funcName)}else{fluid.fail("Error in contextAwareness check record ",checkRecord," - must contain an entry with name value, func, or funcName")}}))};fluid.contextAware.makeChecks=function(checkHash,path,instantiator){var checkOptions=fluid.contextAware.performChecks(checkHash);fluid.contextAware.makeCheckMarkers(checkOptions,path,instantiator)};fluid.contextAware.forgetChecks=function(markerNames,path,instantiator){instantiator=instantiator||fluid.globalInstantiator;path=path||[];var markerArray=fluid.makeArray(markerNames);fluid.each(markerArray,(function(markerName){var memberName=fluid.typeNameToMemberName(markerName);var segs=fluid.model.parseToSegments(path,instantiator.parseEL,true);segs.push(memberName);fluid.destroy(segs,instantiator)}))};fluid.defaults("fluid.contextAware",{mergePolicy:{contextAwareness:"noexpand"},contextAwareness:{}});fluid.contextAware.getCheckValue=function(that,reference){var targetRef=fluid.parseContextReference(reference);var targetComponent=fluid.resolveContext(targetRef.context,that);var path=targetRef.path||(fluid.isComponent(targetComponent)&&fluid.componentHasGrade(targetComponent,"fluid.contextAware.marker")?["options","value"]:[]);var value=fluid.getForComponent(targetComponent,path);return value};fluid.contextAware.checkOne=function(that,contextAwareRecord){if(contextAwareRecord.checks&&contextAwareRecord.checks.contextValue){fluid.fail("Nesting error in contextAwareness record ",contextAwareRecord,' - the "checks" entry must contain a hash and not a contextValue/gradeNames record at top level')}var checkList=fluid.parsePriorityRecords(contextAwareRecord.checks,"contextAwareness checkRecord");return fluid.find(checkList,(function(check){if(!check.contextValue){fluid.fail("Cannot perform check for contextAwareness record ",check,' without a valid field named "contextValue"')}var value=fluid.contextAware.getCheckValue(that,check.contextValue);if(check.equals===undefined?value:value===check.equals){return check.gradeNames}}),contextAwareRecord.defaultGradeNames)};fluid.contextAware.check=function(that,contextAwarenessOptions){var gradeNames=[];var contextAwareList=fluid.parsePriorityRecords(contextAwarenessOptions,"contextAwareness adaptationRecord");fluid.each(contextAwareList,(function(record){var matched=fluid.contextAware.checkOne(that,record);gradeNames=gradeNames.concat(fluid.makeArray(matched))}));return gradeNames};fluid.contextAware.makeAdaptation=function(options){fluid.expect("fluid.contextAware.makeAdaptation",options,["distributionName","targetName","adaptationName","checkName","record"]);fluid.defaults(options.distributionName,{gradeNames:["fluid.component"],distributeOptions:{target:"{/ "+options.targetName+"}.options.contextAwareness."+options.adaptationName+".checks."+options.checkName,record:options.record}});fluid.constructSingle([],options.distributionName)};fluid.contextAware.isBrowser=function(){return typeof window!=="undefined"&&!!window.document};fluid.contextAware.isNode=function(){return typeof process!=="undefined"&&process.versions&&process.versions.node};fluid.contextAware.makeChecks({"fluid.browser":{funcName:"fluid.contextAware.isBrowser"},"fluid.node":{funcName:"fluid.contextAware.isNode"}});fluid.registerNamespace("fluid.contextAware.browser");fluid.contextAware.browser.getPlatformName=function(){return typeof navigator!=="undefined"&&navigator.platform?navigator.platform:undefined};fluid.contextAware.browser.getUserAgent=function(){return typeof navigator!=="undefined"&&navigator.userAgent?navigator.userAgent:undefined};fluid.contextAware.makeChecks({"fluid.browser.platformName":{funcName:"fluid.contextAware.browser.getPlatformName"},"fluid.browser.userAgent":{funcName:"fluid.contextAware.browser.getUserAgent"}});"use strict";if(fluid.contextAware.isBrowser()&&$.fn){$("head").append("<style type='text/css'>.fl-progEnhance-basic, .fl-ProgEnhance-basic { display: none; } .fl-progEnhance-enhanced, .fl-ProgEnhance-enhanced { display: block; }</style>")}"use strict";fluid.apply=function(options){return options.func.apply(null,options.args)};fluid.defaults("fluid.baseViewComponent",{gradeNames:"fluid.component",argumentMap:{container:0,options:1},events:{onDomBind:"promise"},listeners:{"onCreate.onDomBind":"{that}.events.onDomBind"},selectors:{},members:{dom:"@expand:fluid.createDomBinder({that}.container, {that}.options.selectors)",locate:"{that}.dom.locate"},mergePolicy:{"members.dom":"replace","members.container":"replace"}});fluid.defaults("fluid.viewComponent",{gradeNames:["fluid.modelComponent","fluid.baseViewComponent"],members:{container:"@expand:fluid.containerForViewComponent({that}, {that}.options.container)"}});fluid.dumpSelector=function(selectable){return typeof selectable==="string"?selectable:selectable.selector?selectable.selector:""};fluid.checkTryCatchParameter=function(){var location=window.location||{search:"",protocol:"file:"};var GETparams=location.search.slice(1).split("&");return fluid.find(GETparams,(function(param){if(param.indexOf("notrycatch")===0){return true}}))===true};fluid.notrycatch=fluid.checkTryCatchParameter();fluid.wrap=function(obj,userJQuery){userJQuery=userJQuery||$;return!obj||obj.jquery?obj:userJQuery(obj)};fluid.unwrap=function(obj){return obj&&obj.jquery?obj[0]:obj};fluid.container=function(containerSpec,fallible,userJQuery){if(!containerSpec){fluid.fail("fluid.container argument is empty")}var selector=containerSpec.selector||containerSpec;if(userJQuery){containerSpec=fluid.unwrap(containerSpec)}var container=fluid.wrap(containerSpec,userJQuery);if(fallible&&(!container||container.length===0)){return null}if(!container||!container.jquery||container.length!==1){if(typeof containerSpec!=="string"){containerSpec=container.selector}var count=container.length!==undefined?container.length:0;var extraMessage=container.selectorName?" with selector name "+container.selectorName+" in context "+fluid.dumpEl(containerSpec.context):"";fluid.fail((count>1?"More than one ("+count+") container elements were":"No container element was")+" found for selector "+containerSpec+extraMessage)}if(!fluid.isDOMNode(container[0])){fluid.fail("fluid.container was supplied a non-jQueryable element")}container.selector=selector;container.context=container.context||containerSpec.ownerDocument||document;return container};fluid.createDomBinder=function(container,selectors){var userJQuery=container.constructor;var that={container:container,id:fluid.allocateGuid(),doQuery:function(selector){return userJQuery(selector,that.container)},cache:{}};that.locate=function(selectorName){var selector=selectorName==="container"?"":selectors[selectorName];if(selector===undefined){fluid.fail("DOM binder request for selector "+selectorName+" which is not registered")}var togo;if(selector===""){togo=that.container}else{togo=that.doQuery(selector,selectorName)}togo.selector=selector;togo.context=that.container;togo.selectorName=selectorName;that.cache[selectorName]=togo;return togo};that.fastLocate=function(selectorName){return that.cache[selectorName]||that.locate(selectorName)};that.resetContainer=function(container){that.container=container;that.clear()};that.clear=function(){that.cache={}};that.resolvePathSegment=that.locate;return that};fluid.createLocalContainerDomBinder=function(container,selectors){var that={container:container,id:fluid.allocateGuid(),cache:{}};var userJQuery=container.constructor;function cacheKey(name,thisContainer){return fluid.allocateSimpleId(thisContainer)+"-"+name}function record(name,thisContainer,result){that.cache[cacheKey(name,thisContainer)]=result}that.locate=function(name,localContainer){var selector,thisContainer,togo;selector=selectors[name];if(selector===undefined){if(name==="container"){selector=""}else{fluid.fail("DOM binder request for selector "+name+" which is not registered")}}thisContainer=localContainer||that.container;if(!thisContainer){fluid.fail("DOM binder invoked for selector "+name+" without container")}if(selector===""){togo=userJQuery(thisContainer)}else{if(typeof selector==="function"){togo=userJQuery(selector.call(null,fluid.unwrap(thisContainer)))}else{togo=userJQuery(selector,thisContainer)}}if(!togo.selector){togo.selector=selector;togo.context=thisContainer}togo.selectorName=name;record(name,thisContainer,togo);return togo};that.fastLocate=function(name,localContainer){var thisContainer=localContainer?localContainer:that.container;var key=cacheKey(name,thisContainer);var togo=that.cache[key];return togo?togo:that.locate(name,localContainer)};that.resetContainer=function(container){that.container=container;that.clear()};that.clear=function(){that.cache={}};that.refresh=function(names,localContainer){var thisContainer=localContainer?localContainer:that.container;if(typeof names==="string"){names=[names]}if(thisContainer.length===undefined){thisContainer=[thisContainer]}for(var i=0;i<names.length;++i){for(var j=0;j<thisContainer.length;++j){that.locate(names[i],thisContainer[j])}}};that.resolvePathSegment=that.locate;return that};fluid.expectFilledSelector=function(result,message){if(result&&result.length===0&&result.jquery){fluid.fail(message+': selector "'+result.selector+'" with name '+result.selectorName+" returned no results in context "+fluid.dumpEl(result.context))}};fluid.containerForViewComponent=function(that,containerSpec){var container=fluid.container(containerSpec);fluid.expectFilledSelector(container,'Error instantiating viewComponent at path "'+fluid.pathForComponent(that));return container};fluid.getId=function(element){return fluid.unwrap(element).id};fluid.allocateSimpleId=function(element){element=fluid.unwrap(element);if(!element||fluid.isPrimitive(element)){return null}if(!element.id){var simpleId="fluid-id-"+fluid.allocateGuid();element.id=simpleId}return element.id};fluid.registerNamespace("fluid.materialisers");fluid.makeDomMaterialiserManager=function(){var that={idToModelListeners:{}};return that};fluid.checkMaterialisedElement=function(element,selectorName,that){if(!element||!element.length){fluid.fail("Could not locate element for selector "+selectorName+" for component "+fluid.dumpComponentAndPath(that))}};fluid.domMaterialiserManager=fluid.makeDomMaterialiserManager();fluid.materialisers.domOutput=function(that,segs,type,options){fluid.freezeRecursive(segs);var selectorName=segs[1];var listener=function(value){if(that.dom){var element=that.dom.locate(selectorName);fluid.checkMaterialisedElement(element,selectorName,that);if(type==="jQuery"){var model={value:value,segs:segs};var args=options.makeArgs?options.makeArgs(model):[model.value];element[options.method].apply(element,args)}else if(type==="booleanAttr"){if(value===undefined){var markupValue=!!element.attr(options.attr);that.applier.change(segs,options.negate?!markupValue:markupValue)}else{var attrValue=options.negate?!value:value;if(attrValue){element.attr(options.attr,options.attr)}else{element.removeAttr(options.attr)}}}}};that.applier.modelChanged.addListener({segs:segs},listener);that.events.onDomBind.addListener((function(){var modelValue=fluid.getImmediate(that.model,segs);listener(modelValue)}))};fluid.incrementModel=function(that,segs){var oldValue=fluid.getImmediate(that.model,segs)||0;that.applier.change(segs,oldValue+1)};fluid.materialisers.domClick=function(that,segs){var listener=function(){fluid.incrementModel(that,segs)};that.events.onDomBind.addListener((function(){that.dom.locate(segs[1]).click(listener)}))};fluid.materialisers.hover=function(that,segs){var makeListener=function(state){return function(){that.applier.change(segs,state)}};that.events.onDomBind.addListener((function(){that.dom.locate(segs[1]).hover(makeListener(true),makeListener(false))}))};fluid.materialisers.focusin=function(that,segs){var makeListener=function(state){return function(){that.applier.change(segs,state)}};that.events.onDomBind.addListener((function(){that.dom.locate(segs[1]).focusin(makeListener(true)).focusout(makeListener(false))}))};fluid.materialisers.id=function(that,segs){that.events.onDomBind.addListener((function(){var element=that.dom.locate(segs[1])[0];var modelValue=fluid.getImmediate(that.model,segs);if(modelValue===undefined){var id=fluid.allocateSimpleId(element);that.applier.change(segs,id,"ADD","DOM")}else{element.id=modelValue}var modelListener=function(value){if(value!==undefined){element.id=value}};that.applier.modelChanged.addListener({segs:segs},modelListener)}))};fluid.materialisers.domValue=function(that,segs){that.events.onDomBind.addListener((function(){var element=that.dom.locate(segs[1]);var domListener=function(){var val=fluid.value(element);that.applier.change(segs,val,"ADD","DOM")};var modelListener=function(value){if(value!==undefined){fluid.value(element,value)}};that.applier.modelChanged.addListener({segs:segs},modelListener);var options=fluid.getImmediate(that,["options","bindingOptions",fluid.model.composeSegments.apply(null,segs)]);var changeEvent=options&&options.changeEvent||"change";element.on(changeEvent,domListener);modelListener(fluid.getImmediate(that.model,segs))}))};fluid.materialisers.style=function(that,segs){var selectorName=segs[1];that.events.onDomBind.addListener((function(){var element=that.dom.locate(selectorName);fluid.checkMaterialisedElement(element,selectorName,that);var modelValue=fluid.getImmediate(that.model,segs);element[0].style[segs[3]]=modelValue}))};fluid.registerNamespace("fluid.materialiserRegistry");fluid.materialiserRegistry["fluid.viewComponent"]={dom:{"*":{text:{materialiser:"fluid.materialisers.domOutput",args:["jQuery",{method:"text"}]},attr:{materialiser:"fluid.materialisers.domOutput",args:["jQuery",{method:"attr",makeArgs:function(model){return[model.segs[3],model.value]}}]},visible:{materialiser:"fluid.materialisers.domOutput",args:["jQuery",{method:"toggle"}]},enabled:{materialiser:"fluid.materialisers.domOutput",args:["booleanAttr",{attr:"disabled",negate:true}]},click:{materialiser:"fluid.materialisers.domClick"},hover:{materialiser:"fluid.materialisers.hover"},focusin:{materialiser:"fluid.materialisers.focusin"},value:{materialiser:"fluid.materialisers.domValue"},class:{materialiser:"fluid.materialisers.domOutput",args:["jQuery",{method:"toggleClass",makeArgs:function(model){return[model.segs[3],!!model.value]}}]},style:{materialiser:"fluid.materialisers.style"},id:{materialiser:"fluid.materialisers.id"}}}};fluid.value=function(nodeIn,newValue){var node=fluid.unwrap(nodeIn);var isMultiple=false;if(node.nodeType===undefined&&node.length>1){node=node[0];isMultiple=true}if("input"!==node.nodeName.toLowerCase()||!/radio|checkbox/.test(node.type)){return newValue===undefined?$(node).val():$(node).val(newValue)}var name=node.name;var elements;if(isMultiple||name===""){elements=nodeIn}else{elements=node.ownerDocument.getElementsByName(name);var scope=fluid.findForm(node);elements=$.grep(elements,(function(element){if(element.name!==name){return false}return!scope||scope.contains(element)}));isMultiple=elements.length>1}if(newValue!==undefined){if(typeof newValue==="boolean"){newValue=newValue?"true":"false"}$.each(elements,(function(){this.checked=newValue instanceof Array?newValue.indexOf(this.value)!==-1:newValue===this.value}))}else{var checked=$.map(elements,(function(element){return element.checked?element.value:null}));return node.type==="radio"?checked[0]:isMultiple?checked:!!checked[0]}};fluid.defaults("fluid.ariaLabeller",{gradeNames:"fluid.viewComponent"});"use strict";fluid.changeElementValue=function(node,value){node=$(node);fluid.value(node,value);node.change()};fluid.findAncestor=function(element,test){element=fluid.unwrap(element);while(element){if(test(element)){return element}element=element.parentNode}};fluid.findForm=function(node){return fluid.findAncestor(node,(function(element){return element.nodeName.toLowerCase()==="form"}))};fluid.each(["text","html"],(function(method){fluid[method]=function(node,newValue){node=$(node);return newValue===undefined?node[method]():node[method](newValue)}}));fluid.BINDING_ROOT_KEY="fluid-binding-root";fluid.findData=function(elem,name){while(elem){var data=$.data(elem,name);if(data){return data}elem=elem.parentNode}};fluid.bindFossils=function(node,data,fossils){$.data(node,fluid.BINDING_ROOT_KEY,{data:data,fossils:fossils})};fluid.boundPathForNode=function(node,fossils){node=fluid.unwrap(node);var key=node.name||node.id;var record=fossils[key];return record?record.EL:null};fluid.applyBoundChange=function(node,newValue,applier){node=fluid.unwrap(node);if(newValue===undefined){newValue=fluid.value(node)}if(node.nodeType===undefined&&node.length>0){node=node[0]}var root=fluid.findData(node,fluid.BINDING_ROOT_KEY);if(!root){fluid.fail("Bound data could not be discovered in any node above "+fluid.dumpEl(node))}var name=node.name;var fossil=root.fossils[name];if(!fossil){fluid.fail("No fossil discovered for name "+name+" in fossil record above "+fluid.dumpEl(node))}var EL=root.fossils[name].EL;if(applier){applier.fireChangeRequest({path:EL,value:newValue,source:"DOM:"+node.id})}else{fluid.set(root.data,EL,newValue)}};fluid.jById=function(id,dokkument){dokkument=dokkument&&dokkument.nodeType===9?dokkument:document;var element=fluid.byId(id,dokkument);var togo=element?$(element):[];togo.selector="#"+id;togo.context=dokkument;return togo};fluid.byId=function(id,dokkument){dokkument=dokkument&&dokkument.nodeType===9?dokkument:document;var el=dokkument.getElementById(id);if(el){if(el.id!==id){fluid.fail("Problem in document structure - picked up element "+fluid.dumpEl(el)+" for id "+id+" without this id - most likely the element has a name which conflicts with this id")}return el}else{return null}};fluid.getDocument=function(element){var node=fluid.unwrap(element);return node.nodeType===9?node:node.ownerDocument};fluid.defaults("fluid.ariaLabeller",{gradeNames:["fluid.viewComponent"],labelAttribute:"aria-label",liveRegionMarkup:'<div class="liveRegion fl-hidden-accessible" aria-live="polite"></div>',liveRegionId:"fluid-ariaLabeller-liveRegion",invokers:{generateLiveElement:{funcName:"fluid.ariaLabeller.generateLiveElement",args:"{that}"},update:{funcName:"fluid.ariaLabeller.update",args:["{that}","{arguments}.0"]}},listeners:{onCreate:{func:"{that}.update",args:[null]}}});fluid.ariaLabeller.update=function(that,newOptions){newOptions=newOptions||that.options;that.container.attr(that.options.labelAttribute,newOptions.text);if(newOptions.dynamicLabel){var live=fluid.jById(that.options.liveRegionId);if(live.length===0){live=that.generateLiveElement()}live.text(newOptions.text)}};fluid.ariaLabeller.generateLiveElement=function(that){var liveEl=$(that.options.liveRegionMarkup);liveEl.prop("id",that.options.liveRegionId);$("body").append(liveEl);return liveEl};var LABEL_KEY="aria-labelling";fluid.getAriaLabeller=function(element){element=$(element);var that=fluid.getScopedData(element,LABEL_KEY);return that};fluid.updateAriaLabel=function(element,text,options){options=$.extend({},options||{},{text:text});var that=fluid.getAriaLabeller(element);if(!that){that=fluid.ariaLabeller(element,options);fluid.setScopedData(element,LABEL_KEY,that)}else{that.update(options)}return that};fluid.dismissList={};$(document).click((function(event){var target=fluid.resolveEventTarget(event);while(target){if(fluid.dismissList[target.id]){return}target=target.parentNode}fluid.each(fluid.dismissList,(function(dismissFunc,key){dismissFunc(event);delete fluid.dismissList[key]}))}));fluid.globalDismissal=function(nodes,dismissFunc){fluid.each(nodes,(function(node){var id=fluid.unwrap(node).ownerDocument===document?fluid.allocateSimpleId(node):fluid.allocateGuid();if(dismissFunc){fluid.dismissList[id]=dismissFunc}else{delete fluid.dismissList[id]}}))};fluid.deadMansBlur=function(control,options){var that={options:$.extend(true,{},fluid.defaults("fluid.deadMansBlur"),options)};that.blurPending=false;that.lastCancel=0;that.canceller=function(event){fluid.log("Cancellation through "+event.type+" on "+fluid.dumpEl(event.target));that.lastCancel=Date.now();that.blurPending=false};that.noteProceeded=function(){fluid.globalDismissal(that.options.exclusions)};that.reArm=function(){fluid.globalDismissal(that.options.exclusions,that.proceed)};that.addExclusion=function(exclusions){fluid.globalDismissal(exclusions,that.proceed)};that.proceed=function(event){fluid.log("Direct proceed through "+event.type+" on "+fluid.dumpEl(event.target));that.blurPending=false;that.options.handler(control)};fluid.each(that.options.exclusions,(function(exclusion){exclusion=$(exclusion);fluid.each(exclusion,(function(excludeEl){$(excludeEl).on("focusin",that.canceller).on("fluid-focus",that.canceller).click(that.canceller).mousedown(that.canceller)}))}));if(!that.options.cancelByDefault){$(control).on("focusout",(function(event){fluid.log("Starting blur timer for element "+fluid.dumpEl(event.target));var now=Date.now();fluid.log("back delay: "+(now-that.lastCancel));if(now-that.lastCancel>that.options.backDelay){that.blurPending=true}setTimeout((function(){if(that.blurPending){that.options.handler(control)}}),that.options.delay)}))}else{that.reArm()}return that};fluid.defaults("fluid.deadMansBlur",{gradeNames:"fluid.function",delay:150,backDelay:100});"use strict";fluid.defaults("fluid.newViewComponent",{gradeNames:"fluid.viewComponent",listeners:{"onCreate.onDomBind":null}});fluid.defaults("fluid.containerRenderingView",{gradeNames:["fluid.newViewComponent"],members:{container:"@expand:{that}.renderContainer()"},parentContainer:"{that}.options.container",injectionType:"append",invokers:{renderMarkup:"fluid.identity({that}.options.markup.container)",renderContainer:"fluid.containerRenderingView.renderContainer({that}, {that}.renderMarkup, {that}.addToParent)",addToParent:{funcName:"fluid.containerRenderingView.addToParent",args:["{that}.options.parentContainer","{arguments}.0","{that}.options.injectionType"]}},workflows:{global:{evaluateContainers:{funcName:"fluid.renderer.evaluateContainers",priority:"last",waitIO:true}}},listeners:{"onDestroy.clearInjectedMarkup":{this:"{that}.container",method:"remove",args:[]}}});fluid.registerNamespace("fluid.renderer");fluid.defaults("fluid.templateResourceFetcher",{gradeNames:"fluid.resourceLoader",rendererTemplateResources:{template:true},skipTemplateFetch:false,workflows:{global:{fetchTemplates:{funcName:"fluid.renderer.fetchTemplates",priority:"after:resolveResourceModel"}}}});fluid.renderer.fetchTemplates=function(shadows){shadows.forEach((function(shadow){var that=shadow.that;if(fluid.componentHasGrade(that,"fluid.templateResourceFetcher")){var skipTemplateFetch=fluid.getForComponent(that,["options","skipTemplateFetch"]);if(!skipTemplateFetch){var rendererTemplateResources=fluid.getForComponent(that,["options","rendererTemplateResources"]);fluid.each(rendererTemplateResources,(function(value,key){if(value){fluid.getForComponent(that,["resources",key])}}))}}}))};fluid.containerRenderingView.addToParent=function(parentContainer,elm,method){if(!parentContainer){fluid.fail('fluid.containerRenderingView needs to have "parentContainer" or "container" option supplied')}method=method||"append";$(parentContainer)[method](elm)};fluid.renderer.evaluateContainers=function(shadows){shadows.forEach((function(shadow){fluid.getForComponent(shadow.that,"container")}));shadows.forEach((function(shadow){shadow.that.events.onDomBind.fire(shadow.that)}))};fluid.containerRenderingView.renderContainer=function(that,renderMarkup,addToParent){fluid.log("Rendering container for "+that.id);var containerMarkup=renderMarkup();var container=$(containerMarkup);addToParent(container);return container};fluid.defaults("fluid.templateRenderingView",{gradeNames:["fluid.containerRenderingView","fluid.templateResourceFetcher"],invokers:{renderMarkup:"fluid.identity({that}.resources.template.parsed)"},distributeOptions:{mapTemplateUrl:{source:"{that}.options.templateUrl",target:"{that}.options.resources.template.url"}}});"use strict";fluid.defaults("fluid.dataSource.encoding.JSON",{gradeNames:"fluid.component",invokers:{parse:"fluid.dataSource.parseJSON",render:"fluid.dataSource.stringifyJSON"},contentType:"application/json"});fluid.defaults("fluid.dataSource.encoding.none",{gradeNames:"fluid.component",invokers:{parse:"fluid.identity",render:"fluid.identity"},contentType:"text/plain"});fluid.dataSource.parseJSON=function(string){var togo=fluid.promise();if(!string){togo.resolve(undefined)}else{try{togo.resolve(JSON.parse(string))}catch(err){togo.reject(err)}}return togo};fluid.dataSource.stringifyJSON=function(obj){return obj===undefined?"":JSON.stringify(obj,null,4)};fluid.defaults("fluid.dataSource",{gradeNames:["fluid.component","fluid.contextAware"],contextAwareness:{writable:{checks:{writableValue:{contextValue:"{fluid.dataSource}.options.writable",gradeNames:"{fluid.dataSource}.options.writableGrade"}}}},writable:false,events:{onRead:null,onError:null},components:{encoding:{type:"fluid.dataSource.encoding.JSON"}},listeners:{"onRead.impl":{func:"fluid.notImplemented",priority:"first"},"onRead.encoding":{func:"{encoding}.parse",priority:"after:impl"}},invokers:{get:{funcName:"fluid.dataSource.get",args:["{that}","{arguments}.0","{arguments}.1"]}}});fluid.defaults("fluid.dataSource.writable",{gradeNames:["fluid.component"],events:{onWrite:null,onWriteResponse:null},listeners:{"onWrite.encoding":{func:"{encoding}.render"},"onWrite.impl":{func:"fluid.notImplemented",priority:"after:encoding"},"onWriteResponse.encoding":{func:"{encoding}.parse"}},invokers:{set:{funcName:"fluid.dataSource.set",args:["{that}","{arguments}.0","{arguments}.1","{arguments}.2"]}}});fluid.dataSource.registerStandardPromiseHandlers=function(that,promise,requestOptions){promise.then(requestOptions.callback,requestOptions.onError?requestOptions.onError:that.events.onError.fire)};fluid.dataSource.defaultiseOptions=function(componentOptions,directOptions,directModel,isSet){var options=typeof directOptions==="function"?{callback:directOptions}:fluid.copy(directOptions)||{};options.directModel=directModel;options.operation=isSet?"set":"get";options.notFoundIsEmpty=options.notFoundIsEmpty||componentOptions.notFoundIsEmpty;return options};fluid.dataSource.get=function(that,directModel,directOptions){var requestOptions=fluid.dataSource.defaultiseOptions(that.options,directOptions,directModel);var promise=fluid.promise.fireTransformEvent(that.events.onRead,undefined,requestOptions);fluid.dataSource.registerStandardPromiseHandlers(that,promise,requestOptions);return promise};fluid.dataSource.set=function(that,directModel,model,directOptions){var requestOptions=fluid.dataSource.defaultiseOptions(that.options,directOptions,directModel,true);var transformPromise=fluid.promise.fireTransformEvent(that.events.onWrite,model,requestOptions);var togo=fluid.promise();transformPromise.then((function(setResponse){var options2=fluid.dataSource.defaultiseOptions(that.options,fluid.copy(requestOptions),directModel);var retransformed=fluid.promise.fireTransformEvent(that.events.onWriteResponse,setResponse,options2);fluid.promise.follow(retransformed,togo)}),(function(error){togo.reject(error)}));fluid.dataSource.registerStandardPromiseHandlers(that,togo,requestOptions);return togo};fluid.defaults("fluid.dataSource.URL",{gradeNames:["fluid.dataSource"],writableGrade:"fluid.dataSource.URL.writable",invokers:{resolveUrl:"fluid.dataSource.URL.resolveUrl",handleHttp:"fluid.dataSource.URL.handleHttp"},listeners:{"onRead.impl":{funcName:"fluid.dataSource.URL.handle",args:["{that}","{that}.options.permittedRequestOptions","{arguments}.0","{arguments}.1"]}},permittedRequestOptions:"fluid.dataSource.URL.requestOptions",components:{cookieJar:"{cookieJar}"},termMap:{}});fluid.defaults("fluid.dataSource.URL.writable",{gradeNames:["fluid.dataSource.writable"],listeners:{"onWrite.impl":{funcName:"fluid.dataSource.URL.handle",args:["{that}","{that}.options.permittedRequestOptions","{arguments}.0","{arguments}.1"]}}});fluid.dataSource.URL.resolveUrl=function(url,termMap,directModel,noencode){var map=fluid.transform(termMap,(function resolve(entry){entry=String(entry);var encode=!noencode;if(entry.indexOf("noencode:")===0){encode=false;entry=entry.substring("noencode:".length)}var value=entry.charAt(0)==="%"?fluid.get(directModel,entry.substring(1)):entry;if(encode){value=encodeURIComponent(value)}return value}));var replaced=fluid.stringTemplate(url,map);return replaced};fluid.dataSource.URL.urlFields=fluid.freezeRecursive(["protocol","username","password","hostname","port","pathname","search"]);fluid.dataSource.URL.condenseUrl=function(requestOptions){var togo=new fluid.resourceLoader.UrlClass("http://localhost/");fluid.dataSource.URL.urlFields.forEach((function(field){if(requestOptions[field]){togo[field]=requestOptions[field]}}));return togo};fluid.dataSource.URL.requestOptions=fluid.dataSource.URL.urlFields.concat(["url","method","headers","termMap"]);fluid.dataSource.URL.prepareRequestOptions=function(componentOptions,cookieJar,userOptions,permittedOptions,directModel,userStaticOptions){var staticOptions=fluid.filterKeys(componentOptions,permittedOptions);var requestOptions=fluid.extend(true,{headers:{}},userStaticOptions,staticOptions,userOptions);if(fluid.contextAware.isNode()){if(requestOptions.hostname==="localhost"){requestOptions.hostname="127.0.0.1"}}requestOptions.writeMethod=requestOptions.writeMethod||componentOptions.writeMethod||"PUT";requestOptions.pathname=fluid.dataSource.URL.resolveUrl(requestOptions.pathname,requestOptions.termMap,directModel);if(cookieJar&&cookieJar.cookie&&componentOptions.storeCookies){requestOptions.headers.Cookie=cookieJar.cookie}return requestOptions};fluid.dataSource.URL.parse=function(url,permittedOptions){var parsed=fluid.filterKeys(new fluid.resourceLoader.UrlClass(url,typeof window!=="undefined"&&window.location||undefined),fluid.dataSource.URL.urlFields);permittedOptions.forEach((function(oneOption){if(!parsed[oneOption]){delete parsed[oneOption]}}));return parsed};fluid.dataSource.URL.isErrorStatus=function(statusCode){return statusCode<200||statusCode>=300};fluid.dataSource.URL.handle=function(that,permittedRequestOptions,model,userOptions){var permittedOptions=fluid.getGlobalValue(permittedRequestOptions);permittedOptions.forEach((function(oneOption){fluid.getForComponent(that,["options",oneOption])}));var directModel=userOptions.directModel;var url=that.resolveUrl(that.options.url,that.options.termMap,directModel);var parsed=fluid.dataSource.URL.parse(url,permittedOptions);var finalRequestOptions=fluid.dataSource.URL.prepareRequestOptions(that.options,that.cookieJar,userOptions,permittedOptions,directModel,parsed);return that.handleHttp(that,finalRequestOptions,model)};fluid.extractHtmlError=function(received){var matches=/<pre>(.*)<\/pre>/gm.exec(received);return matches?matches[1]:received};fluid.dataSource.URL.relayError=function(statusCode,received,whileMsg){var rejectPayload;try{rejectPayload=JSON.parse(received)}catch(e){var message=typeof received==="string"&&received.indexOf("<html")!==-1?fluid.extractHtmlError(received):received;rejectPayload={message:message}}rejectPayload.message=rejectPayload.message||rejectPayload.error;delete rejectPayload.error;rejectPayload.isError=true;rejectPayload.statusCode=statusCode;return fluid.upgradeError(rejectPayload,whileMsg)};"use strict";fluid.explodeLocalisedName=function(fileName,locale,defaultLocale){var lastDot=fileName.lastIndexOf(".");if(lastDot===-1||lastDot===0){lastDot=fileName.length}var baseName=fileName.substring(0,lastDot);var extension=fileName.substring(lastDot);var segs=locale?locale.split("_"):[];var exploded=fluid.transform(segs,(function(seg,index){var shortSegs=segs.slice(0,index+1);return baseName+"_"+shortSegs.join("_")+extension}));if(defaultLocale){exploded.unshift(baseName+"_"+defaultLocale+extension)}exploded.unshift(fileName);return exploded};fluid.fetchResources=function(resourceSpecs,callback,options){var that=fluid.makeResourceFetcher(resourceSpecs,callback,options,fluid.identity);that.optionsReady.resolve();that.fetchAll();return that};fluid.fetchResources.explodeForLocales=function(resourceFetcher){fluid.each(resourceFetcher.resourceSpecs,(function(resourceSpec){resourceSpec.resolvedDefaultLocale=resourceSpec.defaultLocale||resourceFetcher.options.defaultLocale;resourceSpec.resolvedLocale=resourceFetcher.options.locale||resourceSpec.locale||resourceSpec.resolvedDefaultLocale;if(!resourceSpec.loader.loader.noPath){var pathKey=resourceSpec.loader.pathKey;var path=resourceSpec[pathKey];var resolvedPath=resourceSpec[pathKey]=resourceFetcher.transformResourceURL(path);resourceSpec.localeExploded=fluid.explodeLocalisedName(resolvedPath,resourceSpec.resolvedLocale,resourceSpec.resolvedDefaultLocale);resourceSpec.localeExplodedSpecs=fluid.transform(resourceSpec.localeExploded,(function(oneExploded){var togo={loader:resourceSpec.loader,options:resourceSpec.options};togo[pathKey]=oneExploded;return togo}),fluid.fetchResources.prepareRequestOptions)}}))};fluid.fetchResources.launchExplodedLocales=function(localeExplodedSpecs,loader){var promiseArray=fluid.transform(localeExplodedSpecs,loader,(function(promise){var promiseToGo=fluid.promise();promise.then((function(resolve){promiseToGo.resolve({resolved:resolve})}),(function(error){promiseToGo.resolve({rejected:error})}));return promiseToGo}));var settledArrayPromise=fluid.promise.sequence(promiseArray);return settledArrayPromise};fluid.fetchResources.condenseExplodedLocales=function(resourceSpec,settledArray){var togo=fluid.promise();settledArray.reverse();var lastNonError=fluid.find(settledArray,(function(settled){return settled.resolved}));if(lastNonError){togo.resolve(lastNonError)}else{togo.reject({isError:true,message:"No localised variants of the resource could be found at any of the paths "+resourceSpec.localeExploded.join(", ")})}return togo};fluid.fetchResources.resolveLoaderTask=function(resourceSpec,loader){if(resourceSpec.localeExplodedSpecs){return function(){var togo=fluid.promise();var settledArrayPromise=fluid.fetchResources.launchExplodedLocales(resourceSpec.localeExplodedSpecs,loader);settledArrayPromise.then((function(settledArray){var condensed=fluid.fetchResources.condenseExplodedLocales(resourceSpec,settledArray);fluid.promise.follow(condensed,togo)}));return togo}}else{return function(){return loader(resourceSpec)}}};fluid.fetchResources.checkCompletion=function(resourceSpecs,resourceFetcher){var incomplete=fluid.find_if(resourceSpecs,(function(resourceSpec){return!resourceSpec.promise.disposition}));if(!incomplete){var completionPromise=resourceFetcher.completionPromise;fluid.invokeLater((function(){if(!completionPromise.disposition){completionPromise.resolve(resourceSpecs)}}))}};fluid.fetchResources.noteResourceText=function(resourceText,options){options.resourceSpec.resourceText=resourceText;return resourceText};fluid.fetchResources.noteParsed=function(parsed,options){options.resourceSpec.parsed=parsed;return parsed};fluid.fetchResources.fireFetched=function(parsed,options){options.resourceSpec.onFetched.fire(parsed);return parsed};fluid.fetchResources.prepareRequestOptions=function(resourceSpec){var pathKey=resourceSpec.loader.pathKey;var requestOptions={};requestOptions[pathKey]=resourceSpec[pathKey];resourceSpec.options=$.extend(true,{},resourceSpec.options,requestOptions);return resourceSpec};fluid.fetchResources.initOneResource=function(resourceSpec){resourceSpec.promise=fluid.promise();resourceSpec.launched=false};fluid.fetchResources.subscribeOneResource=function(resourceSpec,key,ownerComponentId){if(resourceSpec.transformEvent){fluid.fail("Cannot subscribe resource ",resourceSpec," which has already been subscribed for I/O")}resourceSpec.key=key;resourceSpec.transformEvent=fluid.makeEventFirer({name:'Transform chain for resource "'+key+'"',ownerId:ownerComponentId});resourceSpec.transformEvent.addListener(fluid.fetchResources.noteParsed,"noteParsed","last");var parser=fluid.resourceLoader.resolveResourceParser(resourceSpec);resourceSpec.transformEvent.addListener(parser,"parser","before:noteParsed");resourceSpec.transformEvent.addListener((function(parsed){return fluid.resourceLoader.renderImmutable(parsed,resourceSpec)}),"renderImmutable","after:parser");resourceSpec.transformEvent.addListener(fluid.fetchResources.noteResourceText,"resourceText","before:parser");resourceSpec.transformEvent.addListener(fluid.fetchResources.resolveLoaderTask(resourceSpec,resourceSpec.loader.loader),"loader","before:resourceText");resourceSpec.onFetched=fluid.makeEventFirer({name:'onFetched event for resources "'+key+'"',ownerId:ownerComponentId});resourceSpec.onError=fluid.makeEventFirer({name:'onError event for resources "'+key+'"',ownerId:ownerComponentId});resourceSpec.transformEvent.addListener(fluid.fetchResources.fireFetched,"fireFetched","last");fluid.fetchResources.prepareRequestOptions(resourceSpec);fluid.fetchResources.initOneResource(resourceSpec)};fluid.fetchResources.FetchOne=function(resourceSpec,resourceFetcher,segs){var FetchOne=this;FetchOne.resourceFetcher=resourceFetcher;FetchOne.resourceSpec=resourceSpec;FetchOne.segs=segs||[];var thisPromise=FetchOne.promise=fluid.promise();fluid.fetchResources.fetchOneResource(resourceSpec,resourceFetcher).then((function(){thisPromise.resolve(fluid.fetchResources.resolveFetchOne(FetchOne))}))};fluid.fetchResources.resolveFetchOne=function(FetchOne){return fluid.getImmediate(FetchOne.resourceSpec,FetchOne.segs)};fluid.fetchResources.FetchOne.prototype.resolvePathSegment=function(seg){return new fluid.fetchResources.FetchOne(this.resourceSpec,this.resourceFetcher,this.segs.concat(fluid.makeArray(seg)))};fluid.initResourceFetcher=function(resourceFetcher){resourceFetcher.completionPromise=fluid.promise();fluid.fetchResources.explodeForLocales(resourceFetcher);resourceFetcher.onInit.fire(resourceFetcher.completionPromise)};fluid.resourceFetcher=function(){};fluid.makeResourceFetcher=function(sourceResourceSpecs,callback,options,transformResourceURL){options=options||{};var that=Object.create(fluid.resourceFetcher.prototype);fluid.extend(that,{sourceResourceSpecs:sourceResourceSpecs,options:fluid.copy(options),optionsReady:fluid.promise(),onInit:fluid.makeEventFirer({name:"onInit for resourceFetcher",ownerId:options.ownerComponentId}),transformResourceURL:transformResourceURL});that.fetchAll=function(){return fluid.fetchResources.fetchAll(that)};that.refetchAll=function(){return fluid.fetchResources.refetchAll(that)};that.fetchOneResource=function(key){return fluid.fetchResources.fetchOneResource(that.resourceSpecs[key],that)};that.refetchOneResource=function(key){return fluid.fetchResources.refetchOneResource(that.resourceSpecs[key],that)};that.resourceSpecs=fluid.copy(that.sourceResourceSpecs);that.onInit.addListener((function(completionPromise){completionPromise.then(callback,callback)}));fluid.each(options.onInitListeners,(function(args){that.onInit.addListener.apply(null,args)}));fluid.each(that.resourceSpecs,(function(resourceSpec){resourceSpec.dataType=resourceSpec.dataType||that.options.dataType;resourceSpec.loader=fluid.resourceLoader.resolveResourceLoader(resourceSpec)}));fluid.initResourceFetcher(that);fluid.each(that.resourceSpecs,(function(resourceSpec,key){fluid.fetchResources.subscribeOneResource(resourceSpec,key,that.options.ownerComponentId)}));return that};fluid.fetchResources.fetchAll=function(resourceFetcher){fluid.each(resourceFetcher.resourceSpecs,(function(resourceSpec){fluid.fetchResources.fetchOneResource(resourceSpec,resourceFetcher)}));fluid.fetchResources.checkCompletion(resourceFetcher.resourceSpecs,resourceFetcher);return resourceFetcher.completionPromise};fluid.fetchResources.mutableResourceSpecFields=["promise","resourceText","parsed","locale","defaultLocale"];fluid.fetchResources.refetchOneResource=function(resourceSpec,resourceFetcher,defeatInitiate){resourceSpec.promise.cancel();fluid.fetchResources.mutableResourceSpecFields.forEach((function(field){delete resourceSpec[field]}));fluid.fetchResources.initOneResource(resourceSpec);if(!defeatInitiate){fluid.fetchResources.initiateRefetch(resourceFetcher)}return resourceSpec.promise};fluid.fetchResources.initiateRefetch=function(resourceFetcher){resourceFetcher.completionPromise.cancel();delete resourceFetcher.completionPromise;fluid.initResourceFetcher(resourceFetcher,true);fluid.fetchResources.fetchAll(resourceFetcher);resourceFetcher.fetchAll()};fluid.fetchResources.refetchAll=function(resourceFetcher){var anyLaunched=false;fluid.each(resourceFetcher.resourceSpecs,(function(resourceSpec){if(resourceSpec.resolvedLocale){anyLaunched=true;fluid.fetchResources.refetchOneResource(resourceSpec,resourceFetcher,true)}}));if(anyLaunched){fluid.fetchResources.initiateRefetch(resourceFetcher)}return resourceFetcher.completionPromise};fluid.fetchResources.fireTransformEvent=function(resourceSpec,resourceFetcher){return fluid.promise.fireTransformEvent(resourceSpec.transformEvent,null,{resourceSpec:resourceSpec,resourceFetcher:resourceFetcher})};fluid.fetchResources.fetchOneResource=function(resourceSpec,resourceFetcher){if(!resourceSpec.launched){resourceSpec.launched=true;resourceFetcher.optionsReady.then((function(){var transformPromise=fluid.fetchResources.fireTransformEvent(resourceSpec,resourceFetcher);fluid.promise.follow(transformPromise,resourceSpec.promise);resourceSpec.promise.then((function(){fluid.fetchResources.checkCompletion(resourceFetcher.resourceSpecs,resourceFetcher)}),(function(error){resourceSpec.fetchError=error;resourceSpec.onError.fire(error);resourceFetcher.completionPromise.reject(error)}))}))}return resourceSpec.promise};fluid.registerNamespace("fluid.resourceLoader.loaders");fluid.resourceLoader.modelUpdated=function(resourceFetcher,modelOptions,early){resourceFetcher.options=$.extend(true,{},resourceFetcher.options,modelOptions);if(early){fluid.fetchResources.explodeForLocales(resourceFetcher);resourceFetcher.optionsReady.resolve()}else{resourceFetcher.refetchAll()}};fluid.resourceLoader.sanitizeResourceSpec=function(resourceSpec){return fluid.transform(resourceSpec,(function(value){return fluid.isPrimitive(value)||fluid.isPlainObject(value)&&!fluid.isPromise(value)?value:fluid.NO_VALUE}))};fluid.ImmutableArray=function(){};fluid.ImmutableArray.prototype=[];fluid.ImmutableObject=function(){};fluid.copyImmutableResource=function(tocopy){var newContainer=fluid.isArrayable(tocopy)?new fluid.ImmutableArray:new fluid.ImmutableObject;fluid.each(tocopy,(function(value,key){newContainer[key]=value}));return newContainer};fluid.resourceLoader.renderImmutable=function(parsed,resourceSpec){if(resourceSpec.immutableModelResource){return fluid.copyImmutableResource(parsed)}else{return parsed}};fluid.resourceLoader.resolveResourceLoader=function(resourceSpec){var loaders=[];fluid.each(fluid.resourceLoader.loaders,(function(loader,key){if(fluid.isValue(resourceSpec[key])){loaders.push({loader:loader,pathKey:key})}}));if(loaders.length===0){loaders.push({loader:fluid.resourceLoader.loaders.noLoader})}else if(loaders.length>1){fluid.fail("Resource spec ",fluid.resourceLoader.sanitizeResourceSpec(resourceSpec)," is ambiguous because it has fields for multiple resource loaders filled out: at most one of the fields ",fluid.getMembers(loaders,"pathKey")," can be used")}return loaders[0]};fluid.resourceLoader.loaders.resourceText=function(resourceSpec){return resourceSpec.resourceText};fluid.resourceLoader.loaders.resourceText.noPath=true;fluid.resourceLoader.loaders.promiseFunc=function(resourceSpec){var promiseFunc=fluid.event.resolveListener(resourceSpec.promiseFunc);return promiseFunc.apply(null,fluid.makeArray(resourceSpec.promiseArgs))};fluid.resourceLoader.loaders.promiseFunc.noPath=true;fluid.resourceLoader.loaders.dataSource=function(resourceSpec){fluid.getForComponent(resourceSpec.dataSource,"get");return resourceSpec.dataSource.get(resourceSpec.directModel,resourceSpec.options)};fluid.resourceLoader.loaders.dataSource.noPath=true;fluid.resourceLoader.loaders.dataSource.parsed=true;fluid.resourceLoader.loaders.noLoader=function(resourceSpec){return fluid.promise().resolve({noResource:true,message:["No resource was configured for resource spec ",fluid.resourceLoader.sanitizeResourceSpec(resourceSpec),"; since it had none of the fields fields ",Object.keys(fluid.resourceLoader.loaders)+" filled out"]})};fluid.resourceLoader.loaders.noLoader.noPath=true;fluid.resourceLoader.loaders.noLoader.parsed=true;fluid.registerNamespace("fluid.resourceLoader.parsers");fluid.resourceLoader.resolveResourceParser=function(resourceSpec){return!resourceSpec.loader.loader.parsed&&fluid.resourceLoader.parsers[resourceSpec.dataType]||fluid.identity};fluid.resourceLoader.parsers.json=function(resourceText){return fluid.dataSource.parseJSON(resourceText)};fluid.resourcesMergePolicy=function(target,source){target=target||{};fluid.each(source,(function(oneResource,name){if(!oneResource){target[name]=oneResource;return}else if(fluid.isPrimitive(oneResource)){oneResource={url:oneResource}}var oneR=target[name];if(!oneR){oneR=target[name]={}}for(var key in fluid.resourceLoader.loaders){if(key in oneResource){for(var key2 in fluid.resourceLoader.loaders){delete oneR[key2]}}}$.extend(oneR,oneResource)}));return target};fluid.defaults("fluid.resourceLoader",{gradeNames:["fluid.modelComponent"],listeners:{"onCreate.loadResources":"{that}.resourceFetcher.fetchAll","onDestroy.destroyResourceEvents":"fluid.resourceLoader.destroyResourceEvents({that}.resourceFetcher)","{that}.resourceFetcher.onInit":{namespace:"resourceLoaderCompletion",funcName:"fluid.resourceLoader.subscribeCompletion",args:["{arguments}.0","{that}"]},"{that}.applier.earlyModelResolved":{funcName:"fluid.resourceLoader.modelUpdated",args:["{that}.resourceFetcher","{arguments}.0.resourceLoader",true]}},modelListeners:{resourceLoader:{namespace:"resourceLoader",funcName:"fluid.resourceLoader.modelUpdated",excludeSource:"init",args:["{that}.resourceFetcher","{change}.value"]}},mergePolicy:{resources:fluid.resourcesMergePolicy},members:{resourceFetcher:{expander:{funcName:"fluid.resourceLoader.makeResourceFetcher",args:["{that}","{that}.options.resources","{that}.options.resourceOptions","{that}.transformResourceURL"]}}},resourceOptions:{terms:{}},resources:{},invokers:{transformResourceURL:{funcName:"fluid.stringTemplate",args:["{arguments}.0","{that}.options.resourceOptions.terms"]}},events:{onResourcesLoaded:null,onResourceError:null}});fluid.resourceLoader.makeResourceFetcher=function(that,resourceSpecs,userResourceOptions,transformResourceURL){var resourceOptions=$.extend({ownerComponentId:that.id,ownerComponentPath:fluid.pathForComponent(that),onInitListeners:[[function(completionPromise){fluid.resourceLoader.subscribeCompletion(completionPromise,that)},"resourceLoaderCompletion"]]},userResourceOptions);var fetcher=fluid.makeResourceFetcher(resourceSpecs,null,resourceOptions,transformResourceURL);fluid.each(fetcher.resourceSpecs,(function(resourceSpec,key){resourceSpec.transformEvent.addListener((function(parsed){that.resources[key]=resourceSpec;return parsed}),"noteComponentResource","after:parsed");resourceSpec.onError.addListener(that.events.onResourceError.fire)}));return fetcher};fluid.resourceLoader.subscribeCompletion=function(completionPromise,resourceLoader){var fire=function(){resourceLoader.events.onResourcesLoaded.fire(resourceLoader.resourceFetcher.resourceSpecs)};completionPromise.then((function(){if(resourceLoader.lifecycleStatus==="constructed"||resourceLoader.lifecycleStatus==="treeConstructed"){fire()}else if(resourceLoader.lifecycleStatus!=="destroyed"){resourceLoader.events.onCreate.addListener(fire,"fireOnResourcesLoaded")}}),(function(error){fluid.log("Failure loading resources for component at path "+fluid.dumpComponentPath(resourceLoader)+": ",error)}))};fluid.resourceLoader.destroyResourceEvents=function(resourceFetcher){fluid.each(resourceFetcher.resourceSpecs,(function(resourceSpec){resourceSpec.transformEvent.destroy();resourceSpec.onFetched.destroy()}))};"use strict";fluid.resourceLoader.UrlClass=URL;fluid.resourceLoader.configureXHR=function(xhr,options){fluid.resourceLoader.loaders.XHR.copyProps.forEach((function(prop){if(fluid.isValue(options[prop])){xhr[prop]=options[prop]}}));fluid.each(options.headers,(function(value,key){var values=fluid.makeArray(value);values.forEach((function(oneValue){xhr.setRequestHeader(key,oneValue)}))}))};fluid.resourceLoader.loaders.XHR=function(resourceSpec){var togo=fluid.promise();var xhr=resourceSpec.xhr=new XMLHttpRequest;togo.then(null,null,(function(){xhr.abort()}));var sendSuccess=function(){fluid.invokeLater((function(){var response=!xhr.responseType||xhr.responseType==="text"?xhr.responseText:xhr.response;togo.resolve(response)}))};var sendError=function(){fluid.invokeLater((function(){togo.reject({isError:true,status:xhr.status,textStatus:xhr.statusText})}))};xhr.addEventListener("load",(function(){var isError=fluid.dataSource.URL.isErrorStatus(xhr.status);isError?sendError():sendSuccess()}));xhr.addEventListener("error",sendError);var options=$.extend({async:true},resourceSpec.options);xhr.open(options.method||"GET",resourceSpec.url,options.async,options.username,options.password);fluid.resourceLoader.configureXHR(xhr,options);xhr.send();return togo};fluid.resourceLoader.loaders.XHR.copyProps=["contentType","responseType","timeout"];fluid.resourceLoader.loaders.url=fluid.resourceLoader.loaders.XHR;fluid.dataSource.URL.handleHttp=function(that,baseOptions,data){var promise=fluid.promise();var defaultOptions={method:"GET",async:true};if(baseOptions.operation==="set"){defaultOptions.headers={"Content-Type":that.encoding.options.contentType};defaultOptions.method=baseOptions.writeMethod}var requestOptions=fluid.extend(true,defaultOptions,baseOptions);var whileMsg=" while executing HTTP "+requestOptions.method+" on url "+requestOptions.url;promise.accumulateRejectionReason=function(originError){return fluid.upgradeError(originError,whileMsg)};var xhr=promise.xhr=new XMLHttpRequest;var sendError=function(){var relayed=fluid.dataSource.URL.relayError(xhr.status,xhr.statusText,whileMsg);if(requestOptions.notFoundIsEmpty&&relayed.statusCode===404){promise.resolve(undefined)}else{promise.reject(relayed)}};xhr.addEventListener("load",(function(){if(fluid.dataSource.URL.isErrorStatus(xhr.status)){sendError()}else{var response=!xhr.responseType||xhr.responseType==="text"?xhr.responseText:xhr.response;promise.resolve(response)}}));xhr.addEventListener("error",sendError);var url=fluid.dataSource.URL.condenseUrl(requestOptions);requestOptions.url=url;fluid.log("DataSource Issuing "+requestOptions.protocol.toUpperCase().slice(0,-1)+" request with options ",requestOptions);xhr.open(requestOptions.method||"GET",url.toString(),requestOptions.async);fluid.resourceLoader.configureXHR(xhr,requestOptions);xhr.send(data);return promise};(function webpackUniversalModuleDefinition(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["accessibleAutocomplete"]=t():e["accessibleAutocomplete"]=t()})(window,(function(){return function(n){var r={};function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}return o.m=n,o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(n,r,function(e){return t[e]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/",o(o.s=37)}([function(e,t,n){var m=n(1),v=n(6),y=n(7),g=n(16),_=n(18),b="prototype",w=function(e,t,n){var r,o,i,u,a=e&w.F,s=e&w.G,l=e&w.S,c=e&w.P,p=e&w.B,f=s?m:l?m[t]||(m[t]={}):(m[t]||{})[b],d=s?v:v[t]||(v[t]={}),h=d[b]||(d[b]={});for(r in s&&(n=t),n)i=((o=!a&&f&&f[r]!==undefined)?f:n)[r],u=p&&o?_(i,m):c&&"function"==typeof i?_(Function.call,i):i,f&&g(f,r,i,e&w.U),d[r]!=i&&y(d,r,u),c&&h[r]!=i&&(h[r]=i)};m.core=v,w.F=1,w.G=2,w.S=4,w.P=8,w.B=16,w.W=32,w.U=64,w.R=128,e.exports=w},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,n){e.exports=!n(4)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t){e.exports=function(e){try{return!!e()}catch(t){return!0}}},function(e,t,n){"use strict";n.r(t),n.d(t,"h",(function(){return r})),n.d(t,"createElement",(function(){return r})),n.d(t,"cloneElement",(function(){return i})),n.d(t,"Component",(function(){return g})),n.d(t,"render",(function(){return _})),n.d(t,"rerender",(function(){return f})),n.d(t,"options",(function(){return E}));var s=function s(){},E={},l=[],c=[];function r(e,t){var n,r,o,i,u=c;for(i=arguments.length;2<i--;)l.push(arguments[i]);for(t&&null!=t.children&&(l.length||l.push(t.children),delete t.children);l.length;)if((r=l.pop())&&r.pop!==undefined)for(i=r.length;i--;)l.push(r[i]);else"boolean"==typeof r&&(r=null),(o="function"!=typeof e)&&(null==r?r="":"number"==typeof r?r=String(r):"string"!=typeof r&&(o=!1)),o&&n?u[u.length-1]+=r:u===c?u=[r]:u.push(r),n=o;var a=new s;return a.nodeName=e,a.children=u,a.attributes=null==t?undefined:t,a.key=null==t?undefined:t.key,E.vnode!==undefined&&E.vnode(a),a}function M(e,t){for(var n in t)e[n]=t[n];return e}var o="function"==typeof Promise?Promise.resolve().then.bind(Promise.resolve()):setTimeout;function i(e,t){return r(e.nodeName,M(M({},e.attributes),t),2<arguments.length?[].slice.call(arguments,2):e.children)}var p=/acit|ex(?:s|g|n|p|$)|rph|ows|mnc|ntw|ine[ch]|zoo|^ord/i,u=[];function a(e){!e._dirty&&(e._dirty=!0)&&1==u.push(e)&&(E.debounceRendering||o)(f)}function f(){var e,t=u;for(u=[];e=t.pop();)e._dirty&&V(e)}function N(e,t){return e.normalizedNodeName===t||e.nodeName.toLowerCase()===t.toLowerCase()}function I(e){var t=M({},e.attributes);t.children=e.children;var n=e.nodeName.defaultProps;if(n!==undefined)for(var r in n)t[r]===undefined&&(t[r]=n[r]);return t}function k(e){var t=e.parentNode;t&&t.removeChild(e)}function v(e,t,n,r,o){if("className"===t&&(t="class"),"key"===t);else if("ref"===t)n&&n(null),r&&r(e);else if("class"!==t||o)if("style"===t){if(r&&"string"!=typeof r&&"string"!=typeof n||(e.style.cssText=r||""),r&&"object"==typeof r){if("string"!=typeof n)for(var i in n)i in r||(e.style[i]="");for(var i in r)e.style[i]="number"==typeof r[i]&&!1===p.test(i)?r[i]+"px":r[i]}}else if("dangerouslySetInnerHTML"===t)r&&(e.innerHTML=r.__html||"");else if("o"==t[0]&&"n"==t[1]){var u=t!==(t=t.replace(/Capture$/,""));t=t.toLowerCase().substring(2),r?n||e.addEventListener(t,d,u):e.removeEventListener(t,d,u),(e._listeners||(e._listeners={}))[t]=r}else if("list"!==t&&"type"!==t&&!o&&t in e){try{e[t]=null==r?"":r}catch(s){}null!=r&&!1!==r||"spellcheck"==t||e.removeAttribute(t)}else{var a=o&&t!==(t=t.replace(/^xlink:?/,""));null==r||!1===r?a?e.removeAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase()):e.removeAttribute(t):"function"!=typeof r&&(a?e.setAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase(),r):e.setAttribute(t,r))}else e.className=r||""}function d(e){return this._listeners[e.type](E.event&&E.event(e)||e)}var A=[],P=0,j=!1,L=!1;function T(){for(var e;e=A.pop();)E.afterMount&&E.afterMount(e),e.componentDidMount&&e.componentDidMount()}function B(e,t,n,r,o,i){P++||(j=null!=o&&o.ownerSVGElement!==undefined,L=null!=e&&!("__preactattr_"in e));var u=D(e,t,n,r,i);return o&&u.parentNode!==o&&o.appendChild(u),--P||(L=!1,i||T()),u}function D(e,t,n,r,o){var i=e,u=j;if(null!=t&&"boolean"!=typeof t||(t=""),"string"==typeof t||"number"==typeof t)return e&&e.splitText!==undefined&&e.parentNode&&(!e._component||o)?e.nodeValue!=t&&(e.nodeValue=t):(i=document.createTextNode(t),e&&(e.parentNode&&e.parentNode.replaceChild(i,e),F(e,!0))),i["__preactattr_"]=!0,i;var a=t.nodeName;if("function"==typeof a)return function d(e,t,n,r){var o=e&&e._component,i=o,u=e,a=o&&e._componentConstructor===t.nodeName,s=a,l=I(t);for(;o&&!s&&(o=o._parentComponent);)s=o.constructor===t.nodeName;o&&s&&(!r||o._component)?(U(o,l,3,n,r),e=o.base):(i&&!a&&(q(i),e=u=null),o=R(t.nodeName,l,n),e&&!o.nextBase&&(o.nextBase=e,u=null),U(o,l,1,n,r),e=o.base,u&&e!==u&&(u._component=null,F(u,!1)));return e}(e,t,n,r);if(j="svg"===a||"foreignObject"!==a&&j,a=String(a),(!e||!N(e,a))&&(i=function h(e,t){var n=t?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e);return n.normalizedNodeName=e,n}(a,j),e)){for(;e.firstChild;)i.appendChild(e.firstChild);e.parentNode&&e.parentNode.replaceChild(i,e),F(e,!0)}var s=i.firstChild,l=i["__preactattr_"],c=t.children;if(null==l){l=i["__preactattr_"]={};for(var p=i.attributes,f=p.length;f--;)l[p[f].name]=p[f].value}return!L&&c&&1===c.length&&"string"==typeof c[0]&&null!=s&&s.splitText!==undefined&&null==s.nextSibling?s.nodeValue!=c[0]&&(s.nodeValue=c[0]):(c&&c.length||null!=s)&&function S(e,t,n,r,o){var i,u,a,s,l,c=e.childNodes,p=[],f={},d=0,h=0,m=c.length,v=0,y=t?t.length:0;if(0!==m)for(var g=0;g<m;g++){var _=c[g],b=_["__preactattr_"],w=y&&b?_._component?_._component.__key:b.key:null;null!=w?(d++,f[w]=_):(b||(_.splitText!==undefined?!o||_.nodeValue.trim():o))&&(p[v++]=_)}if(0!==y)for(var g=0;g<y;g++){s=t[g],l=null;var w=s.key;if(null!=w)d&&f[w]!==undefined&&(l=f[w],f[w]=undefined,d--);else if(h<v)for(i=h;i<v;i++)if(p[i]!==undefined&&(x=u=p[i],C=o,"string"==typeof(O=s)||"number"==typeof O?x.splitText!==undefined:"string"==typeof O.nodeName?!x._componentConstructor&&N(x,O.nodeName):C||x._componentConstructor===O.nodeName)){l=u,p[i]=undefined,i===v-1&&v--,i===h&&h++;break}l=D(l,s,n,r),a=c[g],l&&l!==e&&l!==a&&(null==a?e.appendChild(l):l===a.nextSibling?k(a):e.insertBefore(l,a))}var x,O,C;if(d)for(var g in f)f[g]!==undefined&&F(f[g],!1);for(;h<=v;)(l=p[v--])!==undefined&&F(l,!1)}(i,c,n,r,L||null!=l.dangerouslySetInnerHTML),function m(e,t,n){var r;for(r in n)t&&null!=t[r]||null==n[r]||v(e,r,n[r],n[r]=undefined,j);for(r in t)"children"===r||"innerHTML"===r||r in n&&t[r]===("value"===r||"checked"===r?e[r]:n[r])||v(e,r,n[r],n[r]=t[r],j)}(i,t.attributes,l),j=u,i}function F(e,t){var n=e._component;n?q(n):(null!=e["__preactattr_"]&&e["__preactattr_"].ref&&e["__preactattr_"].ref(null),!1!==t&&null!=e["__preactattr_"]||k(e),h(e))}function h(e){for(e=e.lastChild;e;){var t=e.previousSibling;F(e,!0),e=t}}var m=[];function R(e,t,n){var r,o=m.length;for(e.prototype&&e.prototype.render?(r=new e(t,n),g.call(r,t,n)):((r=new g(t,n)).constructor=e,r.render=y);o--;)if(m[o].constructor===e)return r.nextBase=m[o].nextBase,m.splice(o,1),r;return r}function y(e,t,n){return this.constructor(e,n)}function U(e,t,n,r,o){e._disable||(e._disable=!0,e.__ref=t.ref,e.__key=t.key,delete t.ref,delete t.key,"undefined"==typeof e.constructor.getDerivedStateFromProps&&(!e.base||o?e.componentWillMount&&e.componentWillMount():e.componentWillReceiveProps&&e.componentWillReceiveProps(t,r)),r&&r!==e.context&&(e.prevContext||(e.prevContext=e.context),e.context=r),e.prevProps||(e.prevProps=e.props),e.props=t,e._disable=!1,0!==n&&(1!==n&&!1===E.syncComponentUpdates&&e.base?a(e):V(e,1,o)),e.__ref&&e.__ref(e))}function V(e,t,n,r){if(!e._disable){var o,i,u,a=e.props,s=e.state,l=e.context,c=e.prevProps||a,p=e.prevState||s,f=e.prevContext||l,d=e.base,h=e.nextBase,m=d||h,v=e._component,y=!1,g=f;if(e.constructor.getDerivedStateFromProps&&(s=M(M({},s),e.constructor.getDerivedStateFromProps(a,s)),e.state=s),d&&(e.props=c,e.state=p,e.context=f,2!==t&&e.shouldComponentUpdate&&!1===e.shouldComponentUpdate(a,s,l)?y=!0:e.componentWillUpdate&&e.componentWillUpdate(a,s,l),e.props=a,e.state=s,e.context=l),e.prevProps=e.prevState=e.prevContext=e.nextBase=null,e._dirty=!1,!y){o=e.render(a,s,l),e.getChildContext&&(l=M(M({},l),e.getChildContext())),d&&e.getSnapshotBeforeUpdate&&(g=e.getSnapshotBeforeUpdate(c,p));var _,b,w=o&&o.nodeName;if("function"==typeof w){var x=I(o);(i=v)&&i.constructor===w&&x.key==i.__key?U(i,x,1,l,!1):(_=i,e._component=i=R(w,x,l),i.nextBase=i.nextBase||h,i._parentComponent=e,U(i,x,0,l,!1),V(i,1,n,!0)),b=i.base}else u=m,(_=v)&&(u=e._component=null),(m||1===t)&&(u&&(u._component=null),b=function B(t,n,r,o,i,u){P++||(j=null!=i&&i.ownerSVGElement!==undefined,L=null!=t&&!("__preactattr_"in t));var a=D(t,n,r,o,u);return i&&a.parentNode!==i&&i.appendChild(a),--P||(L=!1,u||T()),a}(u,o,l,n||!d,m&&m.parentNode,!0));if(m&&b!==m&&i!==v){var O=m.parentNode;O&&b!==O&&(O.replaceChild(b,m),_||(m._component=null,F(m,!1)))}if(_&&q(_),(e.base=b)&&!r){for(var C=e,S=e;S=S._parentComponent;)(C=S).base=b;b._component=C,b._componentConstructor=C.constructor}}for(!d||n?A.unshift(e):y||(e.componentDidUpdate&&e.componentDidUpdate(c,p,g),E.afterUpdate&&E.afterUpdate(e));e._renderCallbacks.length;)e._renderCallbacks.pop().call(e);P||r||T()}}function q(e){E.beforeUnmount&&E.beforeUnmount(e);var t=e.base;e._disable=!0,e.componentWillUnmount&&e.componentWillUnmount(),e.base=null;var n=e._component;n?q(n):t&&(t["__preactattr_"]&&t["__preactattr_"].ref&&t["__preactattr_"].ref(null),k(e.nextBase=t),m.push(e),h(t)),e.__ref&&e.__ref(null)}function g(e,t){this._dirty=!0,this.context=t,this.props=e,this.state=this.state||{},this._renderCallbacks=[]}function _(e,t,n){return B(n,e,{},!1,t,!1)}M(g.prototype,{setState:function(e,t){this.prevState||(this.prevState=this.state),this.state=M(M({},this.state),"function"==typeof e?e(this.state,this.props):e),t&&this._renderCallbacks.push(t),a(this)},forceUpdate:function(e){e&&this._renderCallbacks.push(e),V(this,2)},render:function _(){}});var b={h:r,createElement:r,cloneElement:i,Component:g,render:_,rerender:f,options:E};t["default"]=b},function(e,t){var n=e.exports={version:"2.5.7"};"number"==typeof __e&&(__e=n)},function(e,t,n){var r=n(8),o=n(40);e.exports=n(3)?function(e,t,n){return r.f(e,t,o(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var o=n(9),i=n(38),u=n(39),a=Object.defineProperty;t.f=n(3)?Object.defineProperty:function(e,t,n){if(o(e),t=u(t,!0),o(n),i)try{return a(e,t,n)}catch(r){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t,n){var r=n(2);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t){var n=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(e===undefined?"":e,")_",(++n+r).toString(36))}},function(e,t,n){var r=n(22);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t){e.exports=function(e){if(e==undefined)throw TypeError("Can't call method on  "+e);return e}},function(e,t,n){"use strict";var r=n(4);e.exports=function(e,t){return!!e&&r((function(){t?e.call(null,(function(){}),1):e.call(null)}))}},function(e,t,n){var r=n(0);r(r.S+r.F,"Object",{assign:n(41)})},function(e,t,n){var r=n(2),o=n(1).document,i=r(o)&&r(o.createElement);e.exports=function(e){return i?o.createElement(e):{}}},function(e,t,n){var i=n(1),u=n(7),a=n(17),s=n(10)("src"),r="toString",o=Function[r],l=(""+o).split(r);n(6).inspectSource=function(e){return o.call(e)},(e.exports=function(e,t,n,r){var o="function"==typeof n;o&&(a(n,"name")||u(n,"name",t)),e[t]!==n&&(o&&(a(n,s)||u(n,s,e[t]?""+e[t]:l.join(String(t)))),e===i?e[t]=n:r?e[t]?e[t]=n:u(e,t,n):(delete e[t],u(e,t,n)))})(Function.prototype,r,(function(){return"function"==typeof this&&this[s]||o.call(this)}))},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){var i=n(19);e.exports=function(r,o,e){if(i(r),o===undefined)return r;switch(e){case 1:return function(e){return r.call(o,e)};case 2:return function(e,t){return r.call(o,e,t)};case 3:return function(e,t,n){return r.call(o,e,t,n)}}return function(){return r.apply(o,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){var r=n(42),o=n(28);e.exports=Object.keys||function(e){return r(e,o)}},function(e,t,n){var r=n(11),o=n(12);e.exports=function(e){return r(o(e))}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t,n){var s=n(21),l=n(24),c=n(43);e.exports=function(a){return function(e,t,n){var r,o=s(e),i=l(o.length),u=c(n,i);if(a&&t!=t){for(;u<i;)if((r=o[u++])!=r)return!0}else for(;u<i;u++)if((a||u in o)&&o[u]===t)return a||u||0;return!a&&-1}}},function(e,t,n){var r=n(25),o=Math.min;e.exports=function(e){return 0<e?o(r(e),9007199254740991):0}},function(e,t){var n=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(0<e?r:n)(e)}},function(e,t,n){var r=n(27)("keys"),o=n(10);e.exports=function(e){return r[e]||(r[e]=o(e))}},function(e,t,n){var r=n(6),o=n(1),i="__core-js_shared__",u=o[i]||(o[i]={});(e.exports=function(e,t){return u[e]||(u[e]=t!==undefined?t:{})})("versions",[]).push({version:r.version,mode:n(44)?"pure":"global",copyright:"Â© 2018 Denis Pushkarev (zloirock.ru)"})},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,n){var r=n(12);e.exports=function(e){return Object(r(e))}},function(e,t,n){var r=n(8).f,o=Function.prototype,i=/^\s*function ([^ (]*)/;"name"in o||n(3)&&r(o,"name",{configurable:!0,get:function(){try{return(""+this).match(i)[1]}catch(e){return""}}})},function(e,t,n){"use strict";var r=n(0),o=n(32)(1);r(r.P+r.F*!n(13)([].map,!0),"Array",{map:function(e){return o(this,e,arguments[1])}})},function(e,t,n){var _=n(18),b=n(11),w=n(29),x=n(24),r=n(47);e.exports=function(p,e){var f=1==p,d=2==p,h=3==p,m=4==p,v=6==p,y=5==p||v,g=e||r;return function(e,t,n){for(var r,o,i=w(e),u=b(i),a=_(t,n,3),s=x(u.length),l=0,c=f?g(e,s):d?g(e,0):undefined;l<s;l++)if((y||l in u)&&(o=a(r=u[l],l,i),p))if(f)c[l]=o;else if(o)switch(p){case 3:return!0;case 5:return r;case 6:return l;case 2:c.push(r)}else if(m)return!1;return v?-1:h||m?m:c}}},function(e,t,n){var r=n(22);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,n){var r=n(27)("wks"),o=n(10),i=n(1).Symbol,u="function"==typeof i;(e.exports=function(e){return r[e]||(r[e]=u&&i[e]||(u?i:o)("Symbol."+e))}).store=r},function(e,t,n){"use strict";var r=n(0),o=n(23)(!1),i=[].indexOf,u=!!i&&1/[1].indexOf(1,-0)<0;r(r.P+r.F*(u||!n(13)(i)),"Array",{indexOf:function(e){return u?i.apply(this,arguments)||0:o(this,e,arguments[1])}})},function(e,t,n){var r=n(0);r(r.S,"Object",{create:n(52)})},function(e,t,n){"use strict";t.__esModule=!0,t["default"]=void 0,n(14),n(30),n(31),n(35),n(49),n(50);var r=n(5),o=function s(e){return e&&e.__esModule?e:{default:e}}(n(51));function i(e){if(!e.element)throw new Error("element is not defined");if(!e.id)throw new Error("id is not defined");if(!e.source)throw new Error("source is not defined");Array.isArray(e.source)&&(e.source=u(e.source)),(0,r.render)((0,r.createElement)(o["default"],e),e.element)}var u=function u(n){return function(t,e){e(n.filter((function(e){return-1!==e.toLowerCase().indexOf(t.toLowerCase())})))}};i.enhanceSelectElement=function(n){if(!n.selectElement)throw new Error("selectElement is not defined");if(!n.source){var e=[].filter.call(n.selectElement.options,(function(e){return e.value||n.preserveNullOptions}));n.source=e.map((function(e){return e.textContent||e.innerText}))}if(n.onConfirm=n.onConfirm||function(t){var e=[].filter.call(n.selectElement.options,(function(e){return(e.textContent||e.innerText)===t}))[0];e&&(e.selected=!0)},n.selectElement.value||n.defaultValue===undefined){var t=n.selectElement.options[n.selectElement.options.selectedIndex];n.defaultValue=t.textContent||t.innerText}n.name===undefined&&(n.name=""),n.id===undefined&&(n.selectElement.id===undefined?n.id="":n.id=n.selectElement.id),n.autoselect===undefined&&(n.autoselect=!0);var r=document.createElement("div");n.selectElement.parentNode.insertBefore(r,n.selectElement),i(Object.assign({},n,{element:r})),n.selectElement.style.display="none",n.selectElement.id=n.selectElement.id+"-select"};var a=i;t["default"]=a},function(e,t,n){e.exports=!n(3)&&!n(4)((function(){return 7!=Object.defineProperty(n(15)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,n){var o=n(2);e.exports=function(e,t){if(!o(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!o(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!o(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!o(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){"use strict";var f=n(20),d=n(45),h=n(46),m=n(29),v=n(11),o=Object.assign;e.exports=!o||n(4)((function(){var e={},t={},n=Symbol(),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach((function(e){t[e]=e})),7!=o({},e)[n]||Object.keys(o({},t)).join("")!=r}))?function(e,t){for(var n=m(e),r=arguments.length,o=1,i=d.f,u=h.f;o<r;)for(var a,s=v(arguments[o++]),l=i?f(s).concat(i(s)):f(s),c=l.length,p=0;p<c;)u.call(s,a=l[p++])&&(n[a]=s[a]);return n}:o},function(e,t,n){var u=n(17),a=n(21),s=n(23)(!1),l=n(26)("IE_PROTO");e.exports=function(e,t){var n,r=a(e),o=0,i=[];for(n in r)n!=l&&u(r,n)&&i.push(n);for(;t.length>o;)u(r,n=t[o++])&&(~s(i,n)||i.push(n));return i}},function(e,t,n){var r=n(25),o=Math.max,i=Math.min;e.exports=function(e,t){return(e=r(e))<0?o(e+t,0):i(e,t)}},function(e,t){e.exports=!1},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,n){var r=n(48);e.exports=function(e,t){return new(r(e))(t)}},function(e,t,n){var r=n(2),o=n(33),i=n(34)("species");e.exports=function(e){var t;return o(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!o(t.prototype)||(t=undefined),r(t)&&null===(t=t[i])&&(t=undefined)),t===undefined?Array:t}},function(e,t,n){"use strict";var r=n(0),o=n(32)(2);r(r.P+r.F*!n(13)([].filter,!0),"Array",{filter:function(e){return o(this,e,arguments[1])}})},function(e,t,n){var r=n(0);r(r.S,"Array",{isArray:n(33)})},function(e,t,n){"use strict";t.__esModule=!0,t["default"]=void 0,n(14),n(36),n(30),n(31),n(35),n(55),n(58);var $=n(5),J=o(n(60)),r=o(n(61));function o(e){return e&&e.__esModule?e:{default:e}}function X(){return(X=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function i(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var u={13:"enter",27:"escape",32:"space",38:"up",40:"down"};function Y(){return"undefined"!=typeof navigator&&!(!navigator.userAgent.match(/(iPod|iPhone|iPad)/g)||!navigator.userAgent.match(/AppleWebKit/g))}var a=function(n){function e(e){var t;return(t=n.call(this,e)||this).elementReferences={},t.state={focused:null,hovered:null,menuOpen:!1,options:e.defaultValue?[e.defaultValue]:[],query:e.defaultValue,validChoiceMade:!1,selected:null,ariaHint:!0},t.handleComponentBlur=t.handleComponentBlur.bind(i(i(t))),t.handleKeyDown=t.handleKeyDown.bind(i(i(t))),t.handleUpArrow=t.handleUpArrow.bind(i(i(t))),t.handleDownArrow=t.handleDownArrow.bind(i(i(t))),t.handleEnter=t.handleEnter.bind(i(i(t))),t.handlePrintableKey=t.handlePrintableKey.bind(i(i(t))),t.handleListMouseLeave=t.handleListMouseLeave.bind(i(i(t))),t.handleOptionBlur=t.handleOptionBlur.bind(i(i(t))),t.handleOptionClick=t.handleOptionClick.bind(i(i(t))),t.handleOptionFocus=t.handleOptionFocus.bind(i(i(t))),t.handleOptionMouseDown=t.handleOptionMouseDown.bind(i(i(t))),t.handleOptionMouseEnter=t.handleOptionMouseEnter.bind(i(i(t))),t.handleInputBlur=t.handleInputBlur.bind(i(i(t))),t.handleInputChange=t.handleInputChange.bind(i(i(t))),t.handleInputFocus=t.handleInputFocus.bind(i(i(t))),t.pollInputElement=t.pollInputElement.bind(i(i(t))),t.getDirectInputChanges=t.getDirectInputChanges.bind(i(i(t))),t}(function r(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t})(e,n);var t=e.prototype;return t.isQueryAnOption=function(e,t){var n=this;return-1!==t.map((function(e){return n.templateInputValue(e).toLowerCase()})).indexOf(e.toLowerCase())},t.componentDidMount=function(){this.pollInputElement()},t.componentWillUnmount=function(){clearTimeout(this.$pollInput)},t.pollInputElement=function(){var e=this;this.getDirectInputChanges(),this.$pollInput=setTimeout((function(){e.pollInputElement()}),100)},t.getDirectInputChanges=function(){var e=this.elementReferences[-1];e&&e.value!==this.state.query&&this.handleInputChange({target:{value:e.value}})},t.componentDidUpdate=function(e,t){var n=this.state.focused,r=null===n,o=t.focused!==n;o&&!r&&this.elementReferences[n].focus();var i=-1===n,u=o&&null===t.focused;if(i&&u){var a=this.elementReferences[n];a.setSelectionRange(0,a.value.length)}},t.hasAutoselect=function(){return!Y()&&this.props.autoselect},t.templateInputValue=function(e){var t=this.props.templates&&this.props.templates.inputValue;return t?t(e):e},t.templateSuggestion=function(e){var t=this.props.templates&&this.props.templates.suggestion;return t?t(e):e},t.handleComponentBlur=function(e){var t,n=this.state,r=n.options,o=n.query,i=n.selected;this.props.confirmOnBlur?(t=e.query||o,this.props.onConfirm(r[i])):t=o,this.setState({focused:null,menuOpen:e.menuOpen||!1,query:t,selected:null,validChoiceMade:this.isQueryAnOption(t,r)})},t.handleListMouseLeave=function(e){this.setState({hovered:null})},t.handleOptionBlur=function(e,t){var n=this.state,r=n.focused,o=n.menuOpen,i=n.options,u=n.selected,a=null===e.relatedTarget,s=e.relatedTarget===this.elementReferences[-1],l=r!==t&&-1!==r;if(!l&&a||!(l||s)){var c=o&&Y();this.handleComponentBlur({menuOpen:c,query:this.templateInputValue(i[u])})}},t.handleInputBlur=function(e){var t=this.state,n=t.focused,r=t.menuOpen,o=t.options,i=t.query,u=t.selected;if(!(-1!==n)){var a=r&&Y(),s=Y()?i:this.templateInputValue(o[u]);this.handleComponentBlur({menuOpen:a,query:s})}},t.handleInputChange=function(e){var n=this,t=this.props,r=t.minLength,o=t.source,i=t.showAllValues,u=this.hasAutoselect(),a=e.target.value,s=0===a.length,l=this.state.query.length!==a.length,c=a.length>=r;this.setState({query:a,ariaHint:s}),i||!s&&l&&c?o(a,(function(e){var t=0<e.length;n.setState({menuOpen:t,options:e,selected:u&&t?0:-1,validChoiceMade:!1})})):!s&&c||this.setState({menuOpen:!1,options:[]})},t.handleInputClick=function(e){this.handleInputChange(e)},t.handleInputFocus=function(e){var t=this.state,n=t.query,r=t.validChoiceMade,o=t.options,i=this.props.minLength,u=!r&&n.length>=i&&0<o.length;u?this.setState((function(e){var t=e.menuOpen;return{focused:-1,menuOpen:u||t,selected:-1}})):this.setState({focused:-1})},t.handleOptionFocus=function(e){this.setState({focused:e,hovered:null,selected:e})},t.handleOptionMouseEnter=function(e,t){Y()||this.setState({hovered:t})},t.handleOptionClick=function(e,t){var n=this.state.options[t],r=this.templateInputValue(n);this.props.onConfirm(n),this.setState({focused:-1,hovered:null,menuOpen:!1,query:r,selected:-1,validChoiceMade:!0}),this.forceUpdate()},t.handleOptionMouseDown=function(e){e.preventDefault()},t.handleUpArrow=function(e){e.preventDefault();var t=this.state,n=t.menuOpen,r=t.selected;-1!==r&&n&&this.handleOptionFocus(r-1)},t.handleDownArrow=function(e){var t=this;if(e.preventDefault(),this.props.showAllValues&&!1===this.state.menuOpen)e.preventDefault(),this.props.source("",(function(e){t.setState({menuOpen:!0,options:e,selected:0,focused:0,hovered:null})}));else if(!0===this.state.menuOpen){var n=this.state,r=n.menuOpen,o=n.options,i=n.selected;i!==o.length-1&&r&&this.handleOptionFocus(i+1)}},t.handleSpace=function(e){var t=this;this.props.showAllValues&&!1===this.state.menuOpen&&""===this.state.query&&(e.preventDefault(),this.props.source("",(function(e){t.setState({menuOpen:!0,options:e})}))),-1!==this.state.focused&&(e.preventDefault(),this.handleOptionClick(e,this.state.focused))},t.handleEnter=function(e){this.state.menuOpen&&(e.preventDefault(),0<=this.state.selected&&this.handleOptionClick(e,this.state.selected))},t.handlePrintableKey=function(e){var t=this.elementReferences[-1];e.target===t||t.focus()},t.handleKeyDown=function(e){switch(u[e.keyCode]){case"up":this.handleUpArrow(e);break;case"down":this.handleDownArrow(e);break;case"space":this.handleSpace(e);break;case"enter":this.handleEnter(e);break;case"escape":this.handleComponentBlur({query:this.state.query});break;default:(function t(e){return 47<e&&e<58||32===e||8===e||64<e&&e<91||95<e&&e<112||185<e&&e<193||218<e&&e<223})(e.keyCode)&&this.handlePrintableKey(e)}},t.render=function(){var e,i=this,t=this.props,n=t.cssNamespace,r=t.displayMenu,u=t.id,o=t.minLength,a=t.name,s=t.placeholder,l=t.required,c=t.showAllValues,p=t.tNoResults,f=t.tStatusQueryTooShort,d=t.tStatusNoResults,h=t.tStatusSelectedOption,m=t.tStatusResults,v=t.tAssistiveHint,y=t.dropdownArrow,g=this.state,_=g.focused,b=g.hovered,w=g.menuOpen,x=g.options,O=g.query,C=g.selected,S=g.ariaHint,E=g.validChoiceMade,M=this.hasAutoselect(),N=-1===_,I=0===x.length,k=0!==O.length,A=O.length>=o,P=this.props.showNoOptionsFound&&N&&I&&k&&A,j=n+"__wrapper",L=n+"__input",T=null!==_?" "+L+"--focused":"",B=this.props.showAllValues?" "+L+"--show-all-values":" "+L+"--default",D=n+"__dropdown-arrow-down",F=-1!==_&&null!==_,R=n+"__menu",U=R+"--"+r,V=R+"--"+(w||P?"visible":"hidden"),q=n+"__option",W=n+"__hint",H=this.templateInputValue(x[C]),K=H&&0===H.toLowerCase().indexOf(O.toLowerCase())&&M?O+H.substr(O.length):"",Q=u+"__assistiveHint",z=S?{"aria-describedby":Q}:null;return c&&"string"==typeof(e=y({className:D}))&&(e=(0,$.createElement)("div",{className:n+"__dropdown-arrow-down-wrapper",dangerouslySetInnerHTML:{__html:e}})),(0,$.createElement)("div",{className:j,onKeyDown:this.handleKeyDown},(0,$.createElement)(J["default"],{id:u,length:x.length,queryLength:O.length,minQueryLength:o,selectedOption:this.templateInputValue(x[C]),selectedOptionIndex:C,validChoiceMade:E,isInFocus:null!==this.state.focused,tQueryTooShort:f,tNoResults:d,tSelectedOption:h,tResults:m}),K&&(0,$.createElement)("span",null,(0,$.createElement)("input",{className:W,readonly:!0,tabIndex:"-1",value:K})),(0,$.createElement)("input",X({"aria-expanded":w?"true":"false","aria-activedescendant":!!F&&u+"__option--"+_,"aria-owns":u+"__listbox","aria-autocomplete":this.hasAutoselect()?"both":"list"},z,{autoComplete:"off",className:""+L+T+B,id:u,onClick:function(e){return i.handleInputClick(e)},onBlur:this.handleInputBlur},function G(e){return{onInput:e}}(this.handleInputChange),{onFocus:this.handleInputFocus,name:a,placeholder:s,ref:function(e){i.elementReferences[-1]=e},type:"text",role:"combobox",required:l,value:O})),e,(0,$.createElement)("ul",{className:R+" "+U+" "+V,onMouseLeave:function(e){return i.handleListMouseLeave(e)},id:u+"__listbox",role:"listbox"},x.map((function(e,t){var n=(-1===_?C===t:_===t)&&null===b?" "+q+"--focused":"",r=t%2?" "+q+"--odd":"",o=Y()?"<span id="+u+"__option-suffix--"+t+' style="border:0;clip:rect(0 0 0 0);height:1px;marginBottom:-1px;marginRight:-1px;overflow:hidden;padding:0;position:absolute;whiteSpace:nowrap;width:1px"> '+(t+1)+" of "+x.length+"</span>":"";return(0,$.createElement)("li",{"aria-selected":_===t?"true":"false",className:""+q+n+r,dangerouslySetInnerHTML:{__html:i.templateSuggestion(e)+o},id:u+"__option--"+t,key:t,onBlur:function(e){return i.handleOptionBlur(e,t)},onClick:function(e){return i.handleOptionClick(e,t)},onMouseDown:i.handleOptionMouseDown,onMouseEnter:function(e){return i.handleOptionMouseEnter(e,t)},ref:function(e){i.elementReferences[t]=e},role:"option",tabIndex:"-1","aria-posinset":t+1,"aria-setsize":x.length})})),P&&(0,$.createElement)("li",{className:q+" "+q+"--no-results"},p())),(0,$.createElement)("span",{id:Q,style:{display:"none"}},v()))},e}($.Component);(t["default"]=a).defaultProps={autoselect:!1,cssNamespace:"autocomplete",defaultValue:"",displayMenu:"inline",minLength:0,name:"input-autocomplete",placeholder:"",onConfirm:function(){},confirmOnBlur:!0,showNoOptionsFound:!0,showAllValues:!1,required:!1,tNoResults:function(){return"No results found"},tAssistiveHint:function(){return"When autocomplete results are available use up and down arrows to review and enter to select.  Touch device users, explore by touch or with swipe gestures."},dropdownArrow:r["default"]}},function(e,t,r){var o=r(9),i=r(53),u=r(28),a=r(26)("IE_PROTO"),s=function(){},l="prototype",c=function(){var e,t=r(15)("iframe"),n=u.length;for(t.style.display="none",r(54).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),c=e.F;n--;)delete c[l][u[n]];return c()};e.exports=Object.create||function(e,t){var n;return null!==e?(s[l]=o(e),n=new s,s[l]=null,n[a]=e):n=c(),t===undefined?n:i(n,t)}},function(e,t,n){var u=n(8),a=n(9),s=n(20);e.exports=n(3)?Object.defineProperties:function(e,t){a(e);for(var n,r=s(t),o=r.length,i=0;i<o;)u.f(e,n=r[i++],t[n]);return e}},function(e,t,n){var r=n(1).document;e.exports=r&&r.documentElement},function(e,t,n){var r=n(0);r(r.P,"Function",{bind:n(56)})},function(e,t,n){"use strict";var i=n(19),u=n(2),a=n(57),s=[].slice,l={};e.exports=Function.bind||function(t){var n=i(this),r=s.call(arguments,1),o=function(){var e=r.concat(s.call(arguments));return this instanceof o?function(e,t,n){if(!(t in l)){for(var r=[],o=0;o<t;o++)r[o]="a["+o+"]";l[t]=Function("F,a","return new F("+r.join(",")+")")}return l[t](e,n)}(n,e.length,e):a(n,e,t)};return u(n.prototype)&&(o.prototype=n.prototype),o}},function(e,t){e.exports=function(e,t,n){var r=n===undefined;switch(t.length){case 0:return r?e():e.call(n);case 1:return r?e(t[0]):e.call(n,t[0]);case 2:return r?e(t[0],t[1]):e.call(n,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(n,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(n,t[0],t[1],t[2],t[3])}return e.apply(n,t)}},function(e,t,n){n(59)("match",1,(function(r,o,e){return[function(e){"use strict";var t=r(this),n=e==undefined?undefined:e[o];return n!==undefined?n.call(e,t):new RegExp(e)[o](String(t))},e]}))},function(e,t,n){"use strict";var a=n(7),s=n(16),l=n(4),c=n(12),p=n(34);e.exports=function(t,e,n){var r=p(t),o=n(c,r,""[t]),i=o[0],u=o[1];l((function(){var e={};return e[r]=function(){return 7},7!=""[t](e)}))&&(s(String.prototype,t,i),a(RegExp.prototype,r,2==e?function(e,t){return u.call(e,this,t)}:function(e){return u.call(e,this)}))}},function(e,t,n){"use strict";t.__esModule=!0,t["default"]=void 0,n(36);var _=n(5);var r=function r(o,i,u){var a;return function(){var e=this,t=arguments,n=function n(){a=null,u||o.apply(e,t)},r=u&&!a;clearTimeout(a),a=setTimeout(n,i),r&&o.apply(e,t)}},o=function(o){function e(){for(var e,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return(e=o.call.apply(o,[this].concat(n))||this).state={bump:!1,debounced:!1},e}(function n(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t})(e,o);var t=e.prototype;return t.componentWillMount=function(){var e=this;this.debounceStatusUpdate=r((function(){if(!e.state.debounced){var t=!e.props.isInFocus||e.props.validChoiceMade;e.setState((function(e){return{bump:!e.bump,debounced:!0,silenced:t}}))}}),1400)},t.componentWillReceiveProps=function(e){e.queryLength;this.setState({debounced:!1})},t.render=function(){var e=this.props,t=e.id,n=e.length,r=e.queryLength,o=e.minQueryLength,i=e.selectedOption,u=e.selectedOptionIndex,a=e.tQueryTooShort,s=e.tNoResults,l=e.tSelectedOption,c=e.tResults,p=this.state,f=p.bump,d=p.debounced,h=p.silenced,m=r<o,v=0===n,y=i?l(i,n,u):"",g=null;return g=m?a(o):v?s():c(n,y),this.debounceStatusUpdate(),(0,_.createElement)("div",{style:{border:"0",clip:"rect(0 0 0 0)",height:"1px",marginBottom:"-1px",marginRight:"-1px",overflow:"hidden",padding:"0",position:"absolute",whiteSpace:"nowrap",width:"1px"}},(0,_.createElement)("div",{id:t+"__status--A",role:"status","aria-atomic":"true","aria-live":"polite"},!h&&d&&f?g:""),(0,_.createElement)("div",{id:t+"__status--B",role:"status","aria-atomic":"true","aria-live":"polite"},h||!d||f?"":g))},e}(_.Component);(t["default"]=o).defaultProps={tQueryTooShort:function(e){return"Type in "+e+" or more characters for results"},tNoResults:function(){return"No search results"},tSelectedOption:function(e,t,n){return e+" "+(n+1)+" of "+t+" is highlighted"},tResults:function(e,t){return e+" "+(1===e?"result":"results")+" "+(1===e?"is":"are")+" available. "+t}}},function(e,t,n){"use strict";t.__esModule=!0,t["default"]=void 0;var r=n(5),o=function i(e){var t=e.className;return(0,r.createElement)("svg",{version:"1.1",xmlns:"http://www.w3.org/2000/svg",className:t,focusable:"false"},(0,r.createElement)("g",{stroke:"none",fill:"none","fill-rule":"evenodd"},(0,r.createElement)("polygon",{fill:"#000000",points:"0 0 22 0 11 17"})))};t["default"]=o}])["default"]}));
/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v4.0.2/LICENSE.txt
 */
(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):(global=typeof globalThis!=="undefined"?globalThis:global||self,global.maplibregl=factory())})(this,(function(){"use strict";var maplibregl={};var modules={};function define(moduleName,_dependencies,moduleFactory){modules[moduleName]=moduleFactory;if(moduleName!=="index"){return}var workerBundleString="var sharedModule = {}; ("+modules.shared+")(sharedModule); ("+modules.worker+")(sharedModule);";var sharedModule={};modules.shared(sharedModule);modules.index(maplibregl,sharedModule);if(typeof window!=="undefined"){maplibregl.setWorkerUrl(window.URL.createObjectURL(new Blob([workerBundleString],{type:"text/javascript"})))}return maplibregl}define("shared",["exports"],(function(exports){"use strict";var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};function __extends(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}var __assign=function(){__assign=Object.assign||function __assign(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};return __assign.apply(this,arguments)};function __rest(s,e){var t={};for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0)t[p]=s[p];if(s!=null&&typeof Object.getOwnPropertySymbols==="function")for(var i=0,p=Object.getOwnPropertySymbols(s);i<p.length;i++){if(e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i]))t[p[i]]=s[p[i]]}return t}function __decorate(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r}function __param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}function __esDecorate(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f){if(f!==void 0&&typeof f!=="function")throw new TypeError("Function expected");return f}var kind=contextIn.kind,key=kind==="getter"?"get":kind==="setter"?"set":"value";var target=!descriptorIn&&ctor?contextIn["static"]?ctor:ctor.prototype:null;var descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{});var _,done=false;for(var i=decorators.length-1;i>=0;i--){var context={};for(var p in contextIn)context[p]=p==="access"?{}:contextIn[p];for(var p in contextIn.access)context.access[p]=contextIn.access[p];context.addInitializer=function(f){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f||null))};var result=(0,decorators[i])(kind==="accessor"?{get:descriptor.get,set:descriptor.set}:descriptor[key],context);if(kind==="accessor"){if(result===void 0)continue;if(result===null||typeof result!=="object")throw new TypeError("Object expected");if(_=accept(result.get))descriptor.get=_;if(_=accept(result.set))descriptor.set=_;if(_=accept(result.init))initializers.unshift(_)}else if(_=accept(result)){if(kind==="field")initializers.unshift(_);else descriptor[key]=_}}if(target)Object.defineProperty(target,contextIn.name,descriptor);done=true}function __runInitializers(thisArg,initializers,value){var useValue=arguments.length>2;for(var i=0;i<initializers.length;i++){value=useValue?initializers[i].call(thisArg,value):initializers[i].call(thisArg)}return useValue?value:void 0}function __propKey(x){return typeof x==="symbol"?x:"".concat(x)}function __setFunctionName(f,name,prefix){if(typeof name==="symbol")name=name.description?"[".concat(name.description,"]"):"";return Object.defineProperty(f,"name",{configurable:true,value:prefix?"".concat(prefix," ",name):name})}function __metadata(metadataKey,metadataValue){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(metadataKey,metadataValue)}function __awaiter(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))}function __generator(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(g&&(g=0,op[0]&&(_=0)),_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}}var __createBinding=Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k]}}}Object.defineProperty(o,k2,desc)}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k]};function __exportStar(m,o){for(var p in m)if(p!=="default"&&!Object.prototype.hasOwnProperty.call(o,p))__createBinding(o,m,p)}function __values(o){var s=typeof Symbol==="function"&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&typeof o.length==="number")return{next:function(){if(o&&i>=o.length)o=void 0;return{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")}function __read(o,n){var m=typeof Symbol==="function"&&o[Symbol.iterator];if(!m)return o;var i=m.call(o),r,ar=[],e;try{while((n===void 0||n-- >0)&&!(r=i.next()).done)ar.push(r.value)}catch(error){e={error:error}}finally{try{if(r&&!r.done&&(m=i["return"]))m.call(i)}finally{if(e)throw e.error}}return ar}function __spread(){for(var ar=[],i=0;i<arguments.length;i++)ar=ar.concat(__read(arguments[i]));return ar}function __spreadArrays(){for(var s=0,i=0,il=arguments.length;i<il;i++)s+=arguments[i].length;for(var r=Array(s),k=0,i=0;i<il;i++)for(var a=arguments[i],j=0,jl=a.length;j<jl;j++,k++)r[k]=a[j];return r}function __spreadArray(to,from,pack){if(pack||arguments.length===2)for(var i=0,l=from.length,ar;i<l;i++){if(ar||!(i in from)){if(!ar)ar=Array.prototype.slice.call(from,0,i);ar[i]=from[i]}}return to.concat(ar||Array.prototype.slice.call(from))}function __await(v){return this instanceof __await?(this.v=v,this):new __await(v)}function __asyncGenerator(thisArg,_arguments,generator){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var g=generator.apply(thisArg,_arguments||[]),i,q=[];return i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i;function verb(n){if(g[n])i[n]=function(v){return new Promise((function(a,b){q.push([n,v,a,b])>1||resume(n,v)}))}}function resume(n,v){try{step(g[n](v))}catch(e){settle(q[0][3],e)}}function step(r){r.value instanceof __await?Promise.resolve(r.value.v).then(fulfill,reject):settle(q[0][2],r)}function fulfill(value){resume("next",value)}function reject(value){resume("throw",value)}function settle(f,v){if(f(v),q.shift(),q.length)resume(q[0][0],q[0][1])}}function __asyncDelegator(o){var i,p;return i={},verb("next"),verb("throw",(function(e){throw e})),verb("return"),i[Symbol.iterator]=function(){return this},i;function verb(n,f){i[n]=o[n]?function(v){return(p=!p)?{value:__await(o[n](v)),done:false}:f?f(v):v}:f}}function __asyncValues(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var m=o[Symbol.asyncIterator],i;return m?m.call(o):(o=typeof __values==="function"?__values(o):o[Symbol.iterator](),i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i);function verb(n){i[n]=o[n]&&function(v){return new Promise((function(resolve,reject){v=o[n](v),settle(resolve,reject,v.done,v.value)}))}}function settle(resolve,reject,d,v){Promise.resolve(v).then((function(v){resolve({value:v,done:d})}),reject)}}function __makeTemplateObject(cooked,raw){if(Object.defineProperty){Object.defineProperty(cooked,"raw",{value:raw})}else{cooked.raw=raw}return cooked}var __setModuleDefault=Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:true,value:v})}:function(o,v){o["default"]=v};function __importStar(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=="default"&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result}function __importDefault(mod){return mod&&mod.__esModule?mod:{default:mod}}function __classPrivateFieldGet(receiver,state,kind,f){if(kind==="a"&&!f)throw new TypeError("Private accessor was defined without a getter");if(typeof state==="function"?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return kind==="m"?f:kind==="a"?f.call(receiver):f?f.value:state.get(receiver)}function __classPrivateFieldSet(receiver,state,value,kind,f){if(kind==="m")throw new TypeError("Private method is not writable");if(kind==="a"&&!f)throw new TypeError("Private accessor was defined without a setter");if(typeof state==="function"?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return kind==="a"?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value}function __classPrivateFieldIn(state,receiver){if(receiver===null||typeof receiver!=="object"&&typeof receiver!=="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof state==="function"?receiver===state:state.has(receiver)}function __addDisposableResource(env,value,async){if(value!==null&&value!==void 0){if(typeof value!=="object"&&typeof value!=="function")throw new TypeError("Object expected.");var dispose;if(async){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");dispose=value[Symbol.asyncDispose]}if(dispose===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");dispose=value[Symbol.dispose]}if(typeof dispose!=="function")throw new TypeError("Object not disposable.");env.stack.push({value:value,dispose:dispose,async:async})}else if(async){env.stack.push({async:true})}return value}var _SuppressedError=typeof SuppressedError==="function"?SuppressedError:function(error,suppressed,message){var e=new Error(message);return e.name="SuppressedError",e.error=error,e.suppressed=suppressed,e};function __disposeResources(env){function fail(e){env.error=env.hasError?new _SuppressedError(e,env.error,"An error was suppressed during disposal."):e;env.hasError=true}function next(){while(env.stack.length){var rec=env.stack.pop();try{var result=rec.dispose&&rec.dispose.call(rec.value);if(rec.async)return Promise.resolve(result).then(next,(function(e){fail(e);return next()}))}catch(e){fail(e)}}if(env.hasError)throw env.error}return next()}var tslib_es6={__extends:__extends,__assign:__assign,__rest:__rest,__decorate:__decorate,__param:__param,__metadata:__metadata,__awaiter:__awaiter,__generator:__generator,__createBinding:__createBinding,__exportStar:__exportStar,__values:__values,__read:__read,__spread:__spread,__spreadArrays:__spreadArrays,__spreadArray:__spreadArray,__await:__await,__asyncGenerator:__asyncGenerator,__asyncDelegator:__asyncDelegator,__asyncValues:__asyncValues,__makeTemplateObject:__makeTemplateObject,__importStar:__importStar,__importDefault:__importDefault,__classPrivateFieldGet:__classPrivateFieldGet,__classPrivateFieldSet:__classPrivateFieldSet,__classPrivateFieldIn:__classPrivateFieldIn,__addDisposableResource:__addDisposableResource,__disposeResources:__disposeResources};var commonjsGlobal=typeof globalThis!=="undefined"?globalThis:typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:{};function getDefaultExportFromCjs$1(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x["default"]:x}function getDefaultExportFromNamespaceIfPresent(n){return n&&Object.prototype.hasOwnProperty.call(n,"default")?n["default"]:n}function getDefaultExportFromNamespaceIfNotNamed(n){return n&&Object.prototype.hasOwnProperty.call(n,"default")&&Object.keys(n).length===1?n["default"]:n}function getAugmentedNamespace(n){if(n.__esModule)return n;var f=n.default;if(typeof f=="function"){var a=function a(){if(this instanceof a){return Reflect.construct(f,arguments,this.constructor)}return f.apply(this,arguments)};a.prototype=f.prototype}else a={};Object.defineProperty(a,"__esModule",{value:true});Object.keys(n).forEach((function(k){var d=Object.getOwnPropertyDescriptor(n,k);Object.defineProperty(a,k,d.get?d:{enumerable:true,get:function(){return n[k]}})}));return a}"use strict";var pointGeometry=Point$1;function Point$1(x,y){this.x=x;this.y=y}Point$1.prototype={clone:function(){return new Point$1(this.x,this.y)},add:function(p){return this.clone()._add(p)},sub:function(p){return this.clone()._sub(p)},multByPoint:function(p){return this.clone()._multByPoint(p)},divByPoint:function(p){return this.clone()._divByPoint(p)},mult:function(k){return this.clone()._mult(k)},div:function(k){return this.clone()._div(k)},rotate:function(a){return this.clone()._rotate(a)},rotateAround:function(a,p){return this.clone()._rotateAround(a,p)},matMult:function(m){return this.clone()._matMult(m)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(other){return this.x===other.x&&this.y===other.y},dist:function(p){return Math.sqrt(this.distSqr(p))},distSqr:function(p){var dx=p.x-this.x,dy=p.y-this.y;return dx*dx+dy*dy},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(b){return Math.atan2(this.y-b.y,this.x-b.x)},angleWith:function(b){return this.angleWithSep(b.x,b.y)},angleWithSep:function(x,y){return Math.atan2(this.x*y-this.y*x,this.x*x+this.y*y)},_matMult:function(m){var x=m[0]*this.x+m[1]*this.y,y=m[2]*this.x+m[3]*this.y;this.x=x;this.y=y;return this},_add:function(p){this.x+=p.x;this.y+=p.y;return this},_sub:function(p){this.x-=p.x;this.y-=p.y;return this},_mult:function(k){this.x*=k;this.y*=k;return this},_div:function(k){this.x/=k;this.y/=k;return this},_multByPoint:function(p){this.x*=p.x;this.y*=p.y;return this},_divByPoint:function(p){this.x/=p.x;this.y/=p.y;return this},_unit:function(){this._div(this.mag());return this},_perp:function(){var y=this.y;this.y=this.x;this.x=-y;return this},_rotate:function(angle){var cos=Math.cos(angle),sin=Math.sin(angle),x=cos*this.x-sin*this.y,y=sin*this.x+cos*this.y;this.x=x;this.y=y;return this},_rotateAround:function(angle,p){var cos=Math.cos(angle),sin=Math.sin(angle),x=p.x+cos*(this.x-p.x)-sin*(this.y-p.y),y=p.y+sin*(this.x-p.x)+cos*(this.y-p.y);this.x=x;this.y=y;return this},_round:function(){this.x=Math.round(this.x);this.y=Math.round(this.y);return this}};Point$1.convert=function(a){if(a instanceof Point$1){return a}if(Array.isArray(a)){return new Point$1(a[0],a[1])}return a};var Point$2=getDefaultExportFromCjs$1(pointGeometry);"use strict";var unitbezier$1=UnitBezier$2;function UnitBezier$2(p1x,p1y,p2x,p2y){this.cx=3*p1x;this.bx=3*(p2x-p1x)-this.cx;this.ax=1-this.cx-this.bx;this.cy=3*p1y;this.by=3*(p2y-p1y)-this.cy;this.ay=1-this.cy-this.by;this.p1x=p1x;this.p1y=p1y;this.p2x=p2x;this.p2y=p2y}UnitBezier$2.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(x,epsilon){if(epsilon===undefined)epsilon=1e-6;if(x<0)return 0;if(x>1)return 1;var t=x;for(var i=0;i<8;i++){var x2=this.sampleCurveX(t)-x;if(Math.abs(x2)<epsilon)return t;var d2=this.sampleCurveDerivativeX(t);if(Math.abs(d2)<1e-6)break;t=t-x2/d2}var t0=0;var t1=1;t=x;for(i=0;i<20;i++){x2=this.sampleCurveX(t);if(Math.abs(x2-x)<epsilon)break;if(x>x2){t0=t}else{t1=t}t=(t1-t0)*.5+t0}return t},solve:function(x,epsilon){return this.sampleCurveY(this.solveCurveX(x,epsilon))}};var UnitBezier$3=getDefaultExportFromCjs$1(unitbezier$1);let supportsOffscreenCanvas;function offscreenCanvasSupported(){if(supportsOffscreenCanvas==null){supportsOffscreenCanvas=typeof OffscreenCanvas!=="undefined"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap==="function"}return supportsOffscreenCanvas}let offscreenCanvasDistorted;function isOffscreenCanvasDistorted(){if(offscreenCanvasDistorted==null){offscreenCanvasDistorted=false;if(offscreenCanvasSupported()){const size=5;const canvas=new OffscreenCanvas(size,size);const context=canvas.getContext("2d",{willReadFrequently:true});if(context){for(let i=0;i<size*size;i++){const base=i*4;context.fillStyle=`rgb(${base},${base+1},${base+2})`;context.fillRect(i%size,Math.floor(i/size),1,1)}const data=context.getImageData(0,0,size,size).data;for(let i=0;i<size*size*4;i++){if(i%4!==3&&data[i]!==i){offscreenCanvasDistorted=true;break}}}}}return offscreenCanvasDistorted||false}function easeCubicInOut(t){if(t<=0)return 0;if(t>=1)return 1;const t2=t*t,t3=t2*t;return 4*(t<.5?t3:3*(t-t2)+t3-.75)}function bezier$1(p1x,p1y,p2x,p2y){const bezier=new UnitBezier$3(p1x,p1y,p2x,p2y);return function(t){return bezier.solve(t)}}const defaultEasing=bezier$1(.25,.1,.25,1);function clamp$1(n,min,max){return Math.min(max,Math.max(min,n))}function wrap(n,min,max){const d=max-min;const w=((n-min)%d+d)%d+min;return w===min?max:w}function keysDifference(obj,other){const difference=[];for(const i in obj){if(!(i in other)){difference.push(i)}}return difference}function extend(dest,...sources){for(const src of sources){for(const k in src){dest[k]=src[k]}}return dest}function pick(src,properties){const result={};for(let i=0;i<properties.length;i++){const k=properties[i];if(k in src){result[k]=src[k]}}return result}let id=1;function uniqueId(){return id++}function isPowerOfTwo(value){return Math.log(value)/Math.LN2%1===0}function nextPowerOfTwo(value){if(value<=1)return 1;return Math.pow(2,Math.ceil(Math.log(value)/Math.LN2))}function mapObject(input,iterator,context){const output={};for(const key in input){output[key]=iterator.call(context||this,input[key],key,input)}return output}function filterObject(input,iterator,context){const output={};for(const key in input){if(iterator.call(context||this,input[key],key,input)){output[key]=input[key]}}return output}function deepEqual$1(a,b){if(Array.isArray(a)){if(!Array.isArray(b)||a.length!==b.length)return false;for(let i=0;i<a.length;i++){if(!deepEqual$1(a[i],b[i]))return false}return true}if(typeof a==="object"&&a!==null&&b!==null){if(!(typeof b==="object"))return false;const keys=Object.keys(a);if(keys.length!==Object.keys(b).length)return false;for(const key in a){if(!deepEqual$1(a[key],b[key]))return false}return true}return a===b}function clone$9(input){if(Array.isArray(input)){return input.map(clone$9)}else if(typeof input==="object"&&input){return mapObject(input,clone$9)}else{return input}}function arraysIntersect(a,b){for(let l=0;l<a.length;l++){if(b.indexOf(a[l])>=0)return true}return false}const warnOnceHistory={};function warnOnce(message){if(!warnOnceHistory[message]){if(typeof console!=="undefined")console.warn(message);warnOnceHistory[message]=true}}function isCounterClockwise(a,b,c){return(c.y-a.y)*(b.x-a.x)>(b.y-a.y)*(c.x-a.x)}function findLineIntersection(a1,a2,b1,b2){const aDeltaY=a2.y-a1.y;const aDeltaX=a2.x-a1.x;const bDeltaY=b2.y-b1.y;const bDeltaX=b2.x-b1.x;const denominator=bDeltaY*aDeltaX-bDeltaX*aDeltaY;if(denominator===0){return null}const originDeltaY=a1.y-b1.y;const originDeltaX=a1.x-b1.x;const aInterpolation=(bDeltaX*originDeltaY-bDeltaY*originDeltaX)/denominator;return new Point$2(a1.x+aInterpolation*aDeltaX,a1.y+aInterpolation*aDeltaY)}function calculateSignedArea(ring){let sum=0;for(let i=0,len=ring.length,j=len-1,p1,p2;i<len;j=i++){p1=ring[i];p2=ring[j];sum+=(p2.x-p1.x)*(p1.y+p2.y)}return sum}function isClosedPolygon(points){if(points.length<4)return false;const p1=points[0];const p2=points[points.length-1];if(Math.abs(p1.x-p2.x)>0||Math.abs(p1.y-p2.y)>0){return false}return Math.abs(calculateSignedArea(points))>.01}function sphericalToCartesian([r,azimuthal,polar]){azimuthal+=90;azimuthal*=Math.PI/180;polar*=Math.PI/180;return{x:r*Math.cos(azimuthal)*Math.sin(polar),y:r*Math.sin(azimuthal)*Math.sin(polar),z:r*Math.cos(polar)}}function isWorker(self){return typeof WorkerGlobalScope!=="undefined"&&typeof self!=="undefined"&&self instanceof WorkerGlobalScope}function parseCacheControl(cacheControl){const re=/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g;const header={};cacheControl.replace(re,(($0,$1,$2,$3)=>{const value=$2||$3;header[$1]=value?value.toLowerCase():true;return""}));if(header["max-age"]){const maxAge=parseInt(header["max-age"],10);if(isNaN(maxAge))delete header["max-age"];else header["max-age"]=maxAge}return header}let _isSafari=null;function isSafari(scope){if(_isSafari==null){const userAgent=scope.navigator?scope.navigator.userAgent:null;_isSafari=!!scope.safari||!!(userAgent&&(/\b(iPad|iPhone|iPod)\b/.test(userAgent)||!!userAgent.match("Safari")&&!userAgent.match("Chrome")))}return _isSafari}function storageAvailable(type){try{const storage=window[type];storage.setItem("_mapbox_test_",1);storage.removeItem("_mapbox_test_");return true}catch(e){return false}}function b64EncodeUnicode(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,((match,p1)=>String.fromCharCode(Number("0x"+p1)))))}function b64DecodeUnicode(str){return decodeURIComponent(atob(str).split("").map((c=>"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2))).join(""))}function isImageBitmap(image){return typeof ImageBitmap!=="undefined"&&image instanceof ImageBitmap}const arrayBufferToImageBitmap=data=>__awaiter(void 0,void 0,void 0,(function*(){if(data.byteLength===0){return createImageBitmap(new ImageData(1,1))}const blob=new Blob([new Uint8Array(data)],{type:"image/png"});try{return createImageBitmap(blob)}catch(e){throw new Error(`Could not load image because of ${e.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}}));const transparentPngUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";const arrayBufferToImage=data=>new Promise(((resolve,reject)=>{const img=new Image;img.onload=()=>{resolve(img);URL.revokeObjectURL(img.src);img.onload=null;window.requestAnimationFrame((()=>{img.src=transparentPngUrl}))};img.onerror=()=>reject(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const blob=new Blob([new Uint8Array(data)],{type:"image/png"});img.src=data.byteLength?URL.createObjectURL(blob):transparentPngUrl}));function computeVideoFrameParameters(image,x,y,width,height){const destRowOffset=Math.max(-x,0)*4;const firstSourceRow=Math.max(0,y);const firstDestRow=firstSourceRow-y;const offset=firstDestRow*width*4+destRowOffset;const stride=width*4;const sourceLeft=Math.max(0,x);const sourceTop=Math.max(0,y);const sourceRight=Math.min(image.width,x+width);const sourceBottom=Math.min(image.height,y+height);return{rect:{x:sourceLeft,y:sourceTop,width:sourceRight-sourceLeft,height:sourceBottom-sourceTop},layout:[{offset:offset,stride:stride}]}}function readImageUsingVideoFrame(image,x,y,width,height){return __awaiter(this,void 0,void 0,(function*(){if(typeof VideoFrame==="undefined"){throw new Error("VideoFrame not supported")}const frame=new VideoFrame(image,{timestamp:0});try{const format=frame===null||frame===void 0?void 0:frame.format;if(!format||!(format.startsWith("BGR")||format.startsWith("RGB"))){throw new Error(`Unrecognized format ${format}`)}const swapBR=format.startsWith("BGR");const result=new Uint8ClampedArray(width*height*4);yield frame.copyTo(result,computeVideoFrameParameters(image,x,y,width,height));if(swapBR){for(let i=0;i<result.length;i+=4){const tmp=result[i];result[i]=result[i+2];result[i+2]=tmp}}return result}finally{frame.close()}}))}let offscreenCanvas;let offscreenCanvasContext;function readImageDataUsingOffscreenCanvas(imgBitmap,x,y,width,height){const origWidth=imgBitmap.width;const origHeight=imgBitmap.height;if(!offscreenCanvas||!offscreenCanvasContext){offscreenCanvas=new OffscreenCanvas(origWidth,origHeight);offscreenCanvasContext=offscreenCanvas.getContext("2d",{willReadFrequently:true})}offscreenCanvas.width=origWidth;offscreenCanvas.height=origHeight;offscreenCanvasContext.drawImage(imgBitmap,0,0,origWidth,origHeight);const imgData=offscreenCanvasContext.getImageData(x,y,width,height);offscreenCanvasContext.clearRect(0,0,origWidth,origHeight);return imgData.data}function getImageData(image,x,y,width,height){return __awaiter(this,void 0,void 0,(function*(){if(isOffscreenCanvasDistorted()){try{return yield readImageUsingVideoFrame(image,x,y,width,height)}catch(e){}}return readImageDataUsingOffscreenCanvas(image,x,y,width,height)}))}function subscribe(target,message,listener,options){target.addEventListener(message,listener,options);return{unsubscribe:()=>{target.removeEventListener(message,listener,options)}}}function degreesToRadians(degrees){return degrees*Math.PI/180}const ABORT_ERROR="AbortError";function isAbortError(error){return error.message===ABORT_ERROR}function createAbortError(){return new Error(ABORT_ERROR)}const config={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function getProtocol(url){return config.REGISTERED_PROTOCOLS[url.substring(0,url.indexOf("://"))]}function addProtocol(customProtocol,loadFn){config.REGISTERED_PROTOCOLS[customProtocol]=loadFn}function removeProtocol(customProtocol){delete config.REGISTERED_PROTOCOLS[customProtocol]}const GLOBAL_DISPATCHER_ID="global-dispatcher";class AJAXError extends Error{constructor(status,statusText,url,body){super(`AJAXError: ${statusText} (${status}): ${url}`);this.status=status;this.statusText=statusText;this.url=url;this.body=body}}const getReferrer=()=>isWorker(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href;const isFileURL=url=>/^file:/.test(url)||/^file:/.test(getReferrer())&&!/^\w+:/.test(url);function makeFetchRequest(requestParameters,abortController){return __awaiter(this,void 0,void 0,(function*(){const request=new Request(requestParameters.url,{method:requestParameters.method||"GET",body:requestParameters.body,credentials:requestParameters.credentials,headers:requestParameters.headers,cache:requestParameters.cache,referrer:getReferrer(),signal:abortController.signal});if(requestParameters.type==="json"){request.headers.set("Accept","application/json")}const response=yield fetch(request);if(!response.ok){const body=yield response.blob();throw new AJAXError(response.status,response.statusText,requestParameters.url,body)}const parsePromise=requestParameters.type==="arrayBuffer"||requestParameters.type==="image"?response.arrayBuffer():requestParameters.type==="json"?response.json():response.text();const result=yield parsePromise;if(abortController.signal.aborted){throw createAbortError()}return{data:result,cacheControl:response.headers.get("Cache-Control"),expires:response.headers.get("Expires")}}))}function makeXMLHttpRequest(requestParameters,abortController){return new Promise(((resolve,reject)=>{const xhr=new XMLHttpRequest;xhr.open(requestParameters.method||"GET",requestParameters.url,true);if(requestParameters.type==="arrayBuffer"||requestParameters.type==="image"){xhr.responseType="arraybuffer"}for(const k in requestParameters.headers){xhr.setRequestHeader(k,requestParameters.headers[k])}if(requestParameters.type==="json"){xhr.responseType="text";xhr.setRequestHeader("Accept","application/json")}xhr.withCredentials=requestParameters.credentials==="include";xhr.onerror=()=>{reject(new Error(xhr.statusText))};xhr.onload=()=>{if(abortController.signal.aborted){return}if((xhr.status>=200&&xhr.status<300||xhr.status===0)&&xhr.response!==null){let data=xhr.response;if(requestParameters.type==="json"){try{data=JSON.parse(xhr.response)}catch(err){reject(err);return}}resolve({data:data,cacheControl:xhr.getResponseHeader("Cache-Control"),expires:xhr.getResponseHeader("Expires")})}else{const body=new Blob([xhr.response],{type:xhr.getResponseHeader("Content-Type")});reject(new AJAXError(xhr.status,xhr.statusText,requestParameters.url,body))}};abortController.signal.addEventListener("abort",(()=>{xhr.abort();reject(createAbortError())}));xhr.send(requestParameters.body)}))}const makeRequest=function(requestParameters,abortController){if(/:\/\//.test(requestParameters.url)&&!/^https?:|^file:/.test(requestParameters.url)){const protocolLoadFn=getProtocol(requestParameters.url);if(protocolLoadFn){return protocolLoadFn(requestParameters,abortController)}if(isWorker(self)&&self.worker&&self.worker.actor){return self.worker.actor.sendAsync({type:"getResource",data:requestParameters,targetMapId:GLOBAL_DISPATCHER_ID},abortController)}}if(!isFileURL(requestParameters.url)){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal")){return makeFetchRequest(requestParameters,abortController)}if(isWorker(self)&&self.worker&&self.worker.actor){return self.worker.actor.sendAsync({type:"getResource",data:requestParameters,mustQueue:true,targetMapId:GLOBAL_DISPATCHER_ID},abortController)}}return makeXMLHttpRequest(requestParameters,abortController)};const getJSON=(requestParameters,abortController)=>makeRequest(extend(requestParameters,{type:"json"}),abortController);const getArrayBuffer=(requestParameters,abortController)=>makeRequest(extend(requestParameters,{type:"arrayBuffer"}),abortController);function sameOrigin(inComingUrl){if(!inComingUrl||inComingUrl.indexOf("://")<=0||inComingUrl.indexOf("data:image/")===0||inComingUrl.indexOf("blob:")===0){return true}const urlObj=new URL(inComingUrl);const locationObj=window.location;return urlObj.protocol===locationObj.protocol&&urlObj.host===locationObj.host}const getVideo=urls=>{const video=window.document.createElement("video");video.muted=true;return new Promise((resolve=>{video.onloadstart=()=>{resolve(video)};for(const url of urls){const s=window.document.createElement("source");if(!sameOrigin(url)){video.crossOrigin="Anonymous"}s.src=url;video.appendChild(s)}}))};function _addEventListener(type,listener,listenerList){const listenerExists=listenerList[type]&&listenerList[type].indexOf(listener)!==-1;if(!listenerExists){listenerList[type]=listenerList[type]||[];listenerList[type].push(listener)}}function _removeEventListener(type,listener,listenerList){if(listenerList&&listenerList[type]){const index=listenerList[type].indexOf(listener);if(index!==-1){listenerList[type].splice(index,1)}}}class Event{constructor(type,data={}){extend(this,data);this.type=type}}class ErrorEvent extends Event{constructor(error,data={}){super("error",extend({error:error},data))}}class Evented{on(type,listener){this._listeners=this._listeners||{};_addEventListener(type,listener,this._listeners);return this}off(type,listener){_removeEventListener(type,listener,this._listeners);_removeEventListener(type,listener,this._oneTimeListeners);return this}once(type,listener){if(!listener){return new Promise((resolve=>this.once(type,resolve)))}this._oneTimeListeners=this._oneTimeListeners||{};_addEventListener(type,listener,this._oneTimeListeners);return this}fire(event,properties){if(typeof event==="string"){event=new Event(event,properties||{})}const type=event.type;if(this.listens(type)){event.target=this;const listeners=this._listeners&&this._listeners[type]?this._listeners[type].slice():[];for(const listener of listeners){listener.call(this,event)}const oneTimeListeners=this._oneTimeListeners&&this._oneTimeListeners[type]?this._oneTimeListeners[type].slice():[];for(const listener of oneTimeListeners){_removeEventListener(type,listener,this._oneTimeListeners);listener.call(this,event)}const parent=this._eventedParent;if(parent){extend(event,typeof this._eventedParentData==="function"?this._eventedParentData():this._eventedParentData);parent.fire(event)}}else if(event instanceof ErrorEvent){console.error(event.error)}return this}listens(type){return this._listeners&&this._listeners[type]&&this._listeners[type].length>0||this._oneTimeListeners&&this._oneTimeListeners[type]&&this._oneTimeListeners[type].length>0||this._eventedParent&&this._eventedParent.listens(type)}setEventedParent(parent,data){this._eventedParent=parent;this._eventedParentData=data;return this}}var $version=8;var $root={version:{required:true,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},terrain:{type:"terrain"},sources:{required:true,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:true,type:"array",value:"layer"}};var sources={"*":{type:"source"}};var source=["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"];var source_vector={type:{required:true,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:false},"*":{type:"*"}};var source_raster={type:{required:true,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:false},"*":{type:"*"}};var source_raster_dem={type:{required:true,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:false},"*":{type:"*"}};var source_geojson={type:{required:true,type:"enum",values:{geojson:{}}},data:{required:true,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:false},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:false},generateId:{type:"boolean",default:false},promoteId:{type:"promoteId"}};var source_video={type:{required:true,type:"enum",values:{video:{}}},urls:{required:true,type:"array",value:"string"},coordinates:{required:true,type:"array",length:4,value:{type:"array",length:2,value:"number"}}};var source_image={type:{required:true,type:"enum",values:{image:{}}},url:{required:true,type:"string"},coordinates:{required:true,type:"array",length:4,value:{type:"array",length:2,value:"number"}}};var layer={id:{type:"string",required:true},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:true},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}};var layout$7=["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"];var layout_background={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}};var layout_fill={"fill-sort-key":{type:"number",expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}};var layout_circle={"circle-sort-key":{type:"number",expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}};var layout_heatmap={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}};var layout_line={"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}};var layout_symbol={"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:false,expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:false,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:false,requires:["icon-image"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:false,requires:["icon-image","text-field"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:true,expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:false,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:true,expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:true,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:true,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:true,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:false,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:false,requires:["text-field"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:false,requires:["text-field","icon-image"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}};var layout_raster={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}};var layout_hillshade={visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}};var filter={type:"array",value:"*"};var filter_operator={type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{},within:{}}};var geometry_type={type:"enum",values:{Point:{},LineString:{},Polygon:{}}};var function_stop={type:"array",minimum:0,maximum:24,value:["number","color"],length:2};var expression$1={type:"array",value:"*",minimum:1};var light={anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:false,expression:{interpolated:false,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:true,expression:{interpolated:true,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:true,parameters:["zoom"]},transition:true},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:true,parameters:["zoom"]},transition:true}};var sky={"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:true,parameters:["zoom"]},transition:true},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:true,parameters:["zoom"]},transition:true},"fog-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:true,parameters:["zoom"]},transition:true},"horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:true,parameters:["zoom"]},transition:true}};var terrain={source:{type:"string",required:true},exaggeration:{type:"number",minimum:0,default:1}};var paint$9=["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"];var paint_fill={"fill-antialias":{type:"boolean",default:true,expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:true,requires:[{"!":"fill-pattern"}],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:true,requires:[{"!":"fill-pattern"},{"fill-antialias":true}],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:true,expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}};var paint_line={"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:true,requires:[{"!":"line-pattern"}],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:true,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:false,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:true,expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:false,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:true}}],expression:{interpolated:true,parameters:["line-progress"]},"property-type":"color-ramp"}};var paint_circle={"circle-radius":{type:"number",default:5,minimum:0,transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:true,expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:true,expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:true,expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}};var paint_heatmap={"heatmap-radius":{type:"number",default:30,minimum:1,transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:false,expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:false,expression:{interpolated:true,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"}};var paint_symbol={"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,requires:["icon-image"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:true,requires:["icon-image"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:true,requires:["icon-image"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:true,units:"pixels",requires:["icon-image"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:true,units:"pixels",requires:["icon-image"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:true,units:"pixels",requires:["icon-image"],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,requires:["text-field"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:true,overridable:true,requires:["text-field"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:true,requires:["text-field"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:true,units:"pixels",requires:["text-field"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:true,units:"pixels",requires:["text-field"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:true,units:"pixels",requires:["text-field"],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"}};var paint_raster={"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:true,units:"degrees",expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:false,units:"milliseconds",expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"}};var paint_hillshade={"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:false,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"}};var paint_background={"background-color":{type:"color",default:"#000000",transition:true,requires:[{"!":"background-pattern"}],expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:true,expression:{interpolated:false,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"}};var transition={duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}};var promoteId={"*":{type:"string"}};var v8Spec={$version:$version,$root:$root,sources:sources,source:source,source_vector:source_vector,source_raster:source_raster,source_raster_dem:source_raster_dem,source_geojson:source_geojson,source_video:source_video,source_image:source_image,layer:layer,layout:layout$7,layout_background:layout_background,layout_fill:layout_fill,layout_circle:layout_circle,layout_heatmap:layout_heatmap,"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:layout_line,layout_symbol:layout_symbol,layout_raster:layout_raster,layout_hillshade:layout_hillshade,filter:filter,filter_operator:filter_operator,geometry_type:geometry_type,function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:false}},function_stop:function_stop,expression:expression$1,light:light,sky:sky,terrain:terrain,paint:paint$9,paint_fill:paint_fill,"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:true,expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:true,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:true,units:"pixels",expression:{interpolated:true,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:true,expression:{interpolated:false,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:true,expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:true,requires:["fill-extrusion-height"],expression:{interpolated:true,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:true,transition:false,expression:{interpolated:false,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:paint_line,paint_circle:paint_circle,paint_heatmap:paint_heatmap,paint_symbol:paint_symbol,paint_raster:paint_raster,paint_hillshade:paint_hillshade,paint_background:paint_background,transition:transition,"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:promoteId};const refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function deref(layer,parent){const result={};for(const k in layer){if(k!=="ref"){result[k]=layer[k]}}refProperties.forEach((k=>{if(k in parent){result[k]=parent[k]}}));return result}function derefLayers(layers){layers=layers.slice();const map=Object.create(null);for(let i=0;i<layers.length;i++){map[layers[i].id]=layers[i]}for(let i=0;i<layers.length;i++){if("ref"in layers[i]){layers[i]=deref(layers[i],map[layers[i].ref])}}return layers}function deepEqual(a,b){if(Array.isArray(a)){if(!Array.isArray(b)||a.length!==b.length)return false;for(let i=0;i<a.length;i++){if(!deepEqual(a[i],b[i]))return false}return true}if(typeof a==="object"&&a!==null&&b!==null){if(!(typeof b==="object"))return false;const keys=Object.keys(a);if(keys.length!==Object.keys(b).length)return false;for(const key in a){if(!deepEqual(a[key],b[key]))return false}return true}return a===b}function addCommand(commands,command){commands.push(command)}function addSource(sourceId,after,commands){addCommand(commands,{command:"addSource",args:[sourceId,after[sourceId]]})}function removeSource(sourceId,commands,sourcesRemoved){addCommand(commands,{command:"removeSource",args:[sourceId]});sourcesRemoved[sourceId]=true}function updateSource(sourceId,after,commands,sourcesRemoved){removeSource(sourceId,commands,sourcesRemoved);addSource(sourceId,after,commands)}function canUpdateGeoJSON(before,after,sourceId){let prop;for(prop in before[sourceId]){if(!Object.prototype.hasOwnProperty.call(before[sourceId],prop))continue;if(prop!=="data"&&!deepEqual(before[sourceId][prop],after[sourceId][prop])){return false}}for(prop in after[sourceId]){if(!Object.prototype.hasOwnProperty.call(after[sourceId],prop))continue;if(prop!=="data"&&!deepEqual(before[sourceId][prop],after[sourceId][prop])){return false}}return true}function diffSources(before,after,commands,sourcesRemoved){before=before||{};after=after||{};let sourceId;for(sourceId in before){if(!Object.prototype.hasOwnProperty.call(before,sourceId))continue;if(!Object.prototype.hasOwnProperty.call(after,sourceId)){removeSource(sourceId,commands,sourcesRemoved)}}for(sourceId in after){if(!Object.prototype.hasOwnProperty.call(after,sourceId))continue;if(!Object.prototype.hasOwnProperty.call(before,sourceId)){addSource(sourceId,after,commands)}else if(!deepEqual(before[sourceId],after[sourceId])){if(before[sourceId].type==="geojson"&&after[sourceId].type==="geojson"&&canUpdateGeoJSON(before,after,sourceId)){addCommand(commands,{command:"setGeoJSONSourceData",args:[sourceId,after[sourceId].data]})}else{updateSource(sourceId,after,commands,sourcesRemoved)}}}}function diffLayerPropertyChanges(before,after,commands,layerId,klass,command){before=before||{};after=after||{};for(const prop in before){if(!Object.prototype.hasOwnProperty.call(before,prop))continue;if(!deepEqual(before[prop],after[prop])){commands.push({command:command,args:[layerId,prop,after[prop],klass]})}}for(const prop in after){if(!Object.prototype.hasOwnProperty.call(after,prop)||Object.prototype.hasOwnProperty.call(before,prop))continue;if(!deepEqual(before[prop],after[prop])){commands.push({command:command,args:[layerId,prop,after[prop],klass]})}}}function pluckId(layer){return layer.id}function indexById(group,layer){group[layer.id]=layer;return group}function diffLayers(before,after,commands){before=before||[];after=after||[];const beforeOrder=before.map(pluckId);const afterOrder=after.map(pluckId);const beforeIndex=before.reduce(indexById,{});const afterIndex=after.reduce(indexById,{});const tracker=beforeOrder.slice();const clean=Object.create(null);let layerId;let beforeLayer;let afterLayer;let insertBeforeLayerId;let prop;for(let i=0,d=0;i<beforeOrder.length;i++){layerId=beforeOrder[i];if(!Object.prototype.hasOwnProperty.call(afterIndex,layerId)){addCommand(commands,{command:"removeLayer",args:[layerId]});tracker.splice(tracker.indexOf(layerId,d),1)}else{d++}}for(let i=0,d=0;i<afterOrder.length;i++){layerId=afterOrder[afterOrder.length-1-i];if(tracker[tracker.length-1-i]===layerId)continue;if(Object.prototype.hasOwnProperty.call(beforeIndex,layerId)){addCommand(commands,{command:"removeLayer",args:[layerId]});tracker.splice(tracker.lastIndexOf(layerId,tracker.length-d),1)}else{d++}insertBeforeLayerId=tracker[tracker.length-i];addCommand(commands,{command:"addLayer",args:[afterIndex[layerId],insertBeforeLayerId]});tracker.splice(tracker.length-i,0,layerId);clean[layerId]=true}for(let i=0;i<afterOrder.length;i++){layerId=afterOrder[i];beforeLayer=beforeIndex[layerId];afterLayer=afterIndex[layerId];if(clean[layerId]||deepEqual(beforeLayer,afterLayer))continue;if(!deepEqual(beforeLayer.source,afterLayer.source)||!deepEqual(beforeLayer["source-layer"],afterLayer["source-layer"])||!deepEqual(beforeLayer.type,afterLayer.type)){addCommand(commands,{command:"removeLayer",args:[layerId]});insertBeforeLayerId=tracker[tracker.lastIndexOf(layerId)+1];addCommand(commands,{command:"addLayer",args:[afterLayer,insertBeforeLayerId]});continue}diffLayerPropertyChanges(beforeLayer.layout,afterLayer.layout,commands,layerId,null,"setLayoutProperty");diffLayerPropertyChanges(beforeLayer.paint,afterLayer.paint,commands,layerId,null,"setPaintProperty");if(!deepEqual(beforeLayer.filter,afterLayer.filter)){addCommand(commands,{command:"setFilter",args:[layerId,afterLayer.filter]})}if(!deepEqual(beforeLayer.minzoom,afterLayer.minzoom)||!deepEqual(beforeLayer.maxzoom,afterLayer.maxzoom)){addCommand(commands,{command:"setLayerZoomRange",args:[layerId,afterLayer.minzoom,afterLayer.maxzoom]})}for(prop in beforeLayer){if(!Object.prototype.hasOwnProperty.call(beforeLayer,prop))continue;if(prop==="layout"||prop==="paint"||prop==="filter"||prop==="metadata"||prop==="minzoom"||prop==="maxzoom")continue;if(prop.indexOf("paint.")===0){diffLayerPropertyChanges(beforeLayer[prop],afterLayer[prop],commands,layerId,prop.slice(6),"setPaintProperty")}else if(!deepEqual(beforeLayer[prop],afterLayer[prop])){addCommand(commands,{command:"setLayerProperty",args:[layerId,prop,afterLayer[prop]]})}}for(prop in afterLayer){if(!Object.prototype.hasOwnProperty.call(afterLayer,prop)||Object.prototype.hasOwnProperty.call(beforeLayer,prop))continue;if(prop==="layout"||prop==="paint"||prop==="filter"||prop==="metadata"||prop==="minzoom"||prop==="maxzoom")continue;if(prop.indexOf("paint.")===0){diffLayerPropertyChanges(beforeLayer[prop],afterLayer[prop],commands,layerId,prop.slice(6),"setPaintProperty")}else if(!deepEqual(beforeLayer[prop],afterLayer[prop])){addCommand(commands,{command:"setLayerProperty",args:[layerId,prop,afterLayer[prop]]})}}}}function diffStyles(before,after){if(!before)return[{command:"setStyle",args:[after]}];let commands=[];try{if(!deepEqual(before.version,after.version)){return[{command:"setStyle",args:[after]}]}if(!deepEqual(before.center,after.center)){commands.push({command:"setCenter",args:[after.center]})}if(!deepEqual(before.zoom,after.zoom)){commands.push({command:"setZoom",args:[after.zoom]})}if(!deepEqual(before.bearing,after.bearing)){commands.push({command:"setBearing",args:[after.bearing]})}if(!deepEqual(before.pitch,after.pitch)){commands.push({command:"setPitch",args:[after.pitch]})}if(!deepEqual(before.sprite,after.sprite)){commands.push({command:"setSprite",args:[after.sprite]})}if(!deepEqual(before.glyphs,after.glyphs)){commands.push({command:"setGlyphs",args:[after.glyphs]})}if(!deepEqual(before.transition,after.transition)){commands.push({command:"setTransition",args:[after.transition]})}if(!deepEqual(before.light,after.light)){commands.push({command:"setLight",args:[after.light]})}if(!deepEqual(before.terrain,after.terrain)){commands.push({command:"setTerrain",args:[after.terrain]})}if(!deepEqual(before.sky,after.sky)){commands.push({command:"setSky",args:[after.sky]})}const sourcesRemoved={};const removeOrAddSourceCommands=[];diffSources(before.sources,after.sources,removeOrAddSourceCommands,sourcesRemoved);const beforeLayers=[];if(before.layers){before.layers.forEach((layer=>{if("source"in layer&&sourcesRemoved[layer.source]){commands.push({command:"removeLayer",args:[layer.id]})}else{beforeLayers.push(layer)}}))}commands=commands.concat(removeOrAddSourceCommands);diffLayers(beforeLayers,after.layers,commands)}catch(e){console.warn("Unable to compute style diff:",e);commands=[{command:"setStyle",args:[after]}]}return commands}class ValidationError{constructor(key,value,message,identifier){this.message=(key?`${key}: `:"")+message;if(identifier)this.identifier=identifier;if(value!==null&&value!==undefined&&value.__line__){this.line=value.__line__}}}class ParsingError{constructor(error){this.error=error;this.message=error.message;const match=error.message.match(/line (\d+)/);this.line=match?parseInt(match[1],10):0}}function extendBy(output,...inputs){for(const input of inputs){for(const k in input){output[k]=input[k]}}return output}class ExpressionParsingError extends Error{constructor(key,message){super(message);this.message=message;this.key=key}}class Scope{constructor(parent,bindings=[]){this.parent=parent;this.bindings={};for(const[name,expression]of bindings){this.bindings[name]=expression}}concat(bindings){return new Scope(this,bindings)}get(name){if(this.bindings[name]){return this.bindings[name]}if(this.parent){return this.parent.get(name)}throw new Error(`${name} not found in scope.`)}has(name){if(this.bindings[name])return true;return this.parent?this.parent.has(name):false}}const NullType={kind:"null"};const NumberType={kind:"number"};const StringType={kind:"string"};const BooleanType={kind:"boolean"};const ColorType={kind:"color"};const ObjectType={kind:"object"};const ValueType={kind:"value"};const ErrorType={kind:"error"};const CollatorType={kind:"collator"};const FormattedType={kind:"formatted"};const PaddingType={kind:"padding"};const ResolvedImageType={kind:"resolvedImage"};const VariableAnchorOffsetCollectionType={kind:"variableAnchorOffsetCollection"};function array$1(itemType,N){return{kind:"array",itemType:itemType,N:N}}function toString$1(type){if(type.kind==="array"){const itemType=toString$1(type.itemType);return typeof type.N==="number"?`array<${itemType}, ${type.N}>`:type.itemType.kind==="value"?"array":`array<${itemType}>`}else{return type.kind}}const valueMemberTypes=[NullType,NumberType,StringType,BooleanType,ColorType,FormattedType,ObjectType,array$1(ValueType),PaddingType,ResolvedImageType,VariableAnchorOffsetCollectionType];function checkSubtype(expected,t){if(t.kind==="error"){return null}else if(expected.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!checkSubtype(expected.itemType,t.itemType))&&(typeof expected.N!=="number"||expected.N===t.N)){return null}}else if(expected.kind===t.kind){return null}else if(expected.kind==="value"){for(const memberType of valueMemberTypes){if(!checkSubtype(memberType,t)){return null}}}return`Expected ${toString$1(expected)} but found ${toString$1(t)} instead.`}function isValidType(provided,allowedTypes){return allowedTypes.some((t=>t.kind===provided.kind))}function isValidNativeType(provided,allowedTypes){return allowedTypes.some((t=>{if(t==="null"){return provided===null}else if(t==="array"){return Array.isArray(provided)}else if(t==="object"){return provided&&!Array.isArray(provided)&&typeof provided==="object"}else{return t===typeof provided}}))}function verifyType(provided,sample){if(provided.kind==="array"&&sample.kind==="array"){return provided.itemType.kind===sample.itemType.kind&&typeof provided.N==="number"}return provided.kind===sample.kind}const Xn=.96422,Yn=1,Zn=.82521,t0=4/29,t1=6/29,t2=3*t1*t1,t3=t1*t1*t1,deg2rad=Math.PI/180,rad2deg=180/Math.PI;function constrainAngle(angle){angle=angle%360;if(angle<0){angle+=360}return angle}function rgbToLab([r,g,b,alpha]){r=rgb2xyz(r);g=rgb2xyz(g);b=rgb2xyz(b);let x,z;const y=xyz2lab((.2225045*r+.7168786*g+.0606169*b)/Yn);if(r===g&&g===b){x=z=y}else{x=xyz2lab((.4360747*r+.3850649*g+.1430804*b)/Xn);z=xyz2lab((.0139322*r+.0971045*g+.7141733*b)/Zn)}const l=116*y-16;return[l<0?0:l,500*(x-y),200*(y-z),alpha]}function rgb2xyz(x){return x<=.04045?x/12.92:Math.pow((x+.055)/1.055,2.4)}function xyz2lab(t){return t>t3?Math.pow(t,1/3):t/t2+t0}function labToRgb([l,a,b,alpha]){let y=(l+16)/116,x=isNaN(a)?y:y+a/500,z=isNaN(b)?y:y-b/200;y=Yn*lab2xyz(y);x=Xn*lab2xyz(x);z=Zn*lab2xyz(z);return[xyz2rgb(3.1338561*x-1.6168667*y-.4906146*z),xyz2rgb(-.9787684*x+1.9161415*y+.033454*z),xyz2rgb(.0719453*x-.2289914*y+1.4052427*z),alpha]}function xyz2rgb(x){x=x<=.00304?12.92*x:1.055*Math.pow(x,1/2.4)-.055;return x<0?0:x>1?1:x}function lab2xyz(t){return t>t1?t*t*t:t2*(t-t0)}function rgbToHcl(rgbColor){const[l,a,b,alpha]=rgbToLab(rgbColor);const c=Math.sqrt(a*a+b*b);const h=Math.round(c*1e4)?constrainAngle(Math.atan2(b,a)*rad2deg):NaN;return[h,c,l,alpha]}function hclToRgb([h,c,l,alpha]){h=isNaN(h)?0:h*deg2rad;return labToRgb([l,Math.cos(h)*c,Math.sin(h)*c,alpha])}function hslToRgb([h,s,l,alpha]){h=constrainAngle(h);s/=100;l/=100;function f(n){const k=(n+h/30)%12;const a=s*Math.min(l,1-l);return l-a*Math.max(-1,Math.min(k-3,9-k,1))}return[f(0),f(8),f(4),alpha]}function parseCssColor(input){input=input.toLowerCase().trim();if(input==="transparent"){return[0,0,0,0]}const namedColorsMatch=namedColors[input];if(namedColorsMatch){const[r,g,b]=namedColorsMatch;return[r/255,g/255,b/255,1]}if(input.startsWith("#")){const hexRegexp=/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/;if(hexRegexp.test(input)){const step=input.length<6?1:2;let i=1;return[parseHex(input.slice(i,i+=step)),parseHex(input.slice(i,i+=step)),parseHex(input.slice(i,i+=step)),parseHex(input.slice(i,i+step)||"ff")]}}if(input.startsWith("rgb")){const rgbRegExp=/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/;const rgbMatch=input.match(rgbRegExp);if(rgbMatch){const[_,r,rp,f1,g,gp,f2,b,bp,f3,a,ap]=rgbMatch;const argFormat=[f1||" ",f2||" ",f3].join("");if(argFormat==="  "||argFormat==="  /"||argFormat===",,"||argFormat===",,,"){const valFormat=[rp,gp,bp].join("");const maxValue=valFormat==="%%%"?100:valFormat===""?255:0;if(maxValue){const rgba=[clamp(+r/maxValue,0,1),clamp(+g/maxValue,0,1),clamp(+b/maxValue,0,1),a?parseAlpha(+a,ap):1];if(validateNumbers(rgba)){return rgba}}}return}}const hslRegExp=/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/;const hslMatch=input.match(hslRegExp);if(hslMatch){const[_,h,f1,s,f2,l,f3,a,ap]=hslMatch;const argFormat=[f1||" ",f2||" ",f3].join("");if(argFormat==="  "||argFormat==="  /"||argFormat===",,"||argFormat===",,,"){const hsla=[+h,clamp(+s,0,100),clamp(+l,0,100),a?parseAlpha(+a,ap):1];if(validateNumbers(hsla)){return hslToRgb(hsla)}}}}function parseHex(hex){return parseInt(hex.padEnd(2,hex),16)/255}function parseAlpha(a,asPercentage){return clamp(asPercentage?a/100:a,0,1)}function clamp(n,min,max){return Math.min(Math.max(min,n),max)}function validateNumbers(array){return!array.some(Number.isNaN)}const namedColors={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};class Color{constructor(r,g,b,alpha=1,premultiplied=true){this.r=r;this.g=g;this.b=b;this.a=alpha;if(!premultiplied){this.r*=alpha;this.g*=alpha;this.b*=alpha;if(!alpha){this.overwriteGetter("rgb",[r,g,b,alpha])}}}static parse(input){if(input instanceof Color){return input}if(typeof input!=="string"){return}const rgba=parseCssColor(input);if(rgba){return new Color(...rgba,false)}}get rgb(){const{r:r,g:g,b:b,a:a}=this;const f=a||Infinity;return this.overwriteGetter("rgb",[r/f,g/f,b/f,a])}get hcl(){return this.overwriteGetter("hcl",rgbToHcl(this.rgb))}get lab(){return this.overwriteGetter("lab",rgbToLab(this.rgb))}overwriteGetter(getterKey,lazyValue){Object.defineProperty(this,getterKey,{value:lazyValue});return lazyValue}toString(){const[r,g,b,a]=this.rgb;return`rgba(${[r,g,b].map((n=>Math.round(n*255))).join(",")},${a})`}}Color.black=new Color(0,0,0,1);Color.white=new Color(1,1,1,1);Color.transparent=new Color(0,0,0,0);Color.red=new Color(1,0,0,1);class Collator{constructor(caseSensitive,diacriticSensitive,locale){if(caseSensitive)this.sensitivity=diacriticSensitive?"variant":"case";else this.sensitivity=diacriticSensitive?"accent":"base";this.locale=locale;this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(lhs,rhs){return this.collator.compare(lhs,rhs)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class FormattedSection{constructor(text,image,scale,fontStack,textColor){this.text=text;this.image=image;this.scale=scale;this.fontStack=fontStack;this.textColor=textColor}}class Formatted{constructor(sections){this.sections=sections}static fromString(unformatted){return new Formatted([new FormattedSection(unformatted,null,null,null,null)])}isEmpty(){if(this.sections.length===0)return true;return!this.sections.some((section=>section.text.length!==0||section.image&&section.image.name.length!==0))}static factory(text){if(text instanceof Formatted){return text}else{return Formatted.fromString(text)}}toString(){if(this.sections.length===0)return"";return this.sections.map((section=>section.text)).join("")}}class Padding{constructor(values){this.values=values.slice()}static parse(input){if(input instanceof Padding){return input}if(typeof input==="number"){return new Padding([input,input,input,input])}if(!Array.isArray(input)){return undefined}if(input.length<1||input.length>4){return undefined}for(const val of input){if(typeof val!=="number"){return undefined}}switch(input.length){case 1:input=[input[0],input[0],input[0],input[0]];break;case 2:input=[input[0],input[1],input[0],input[1]];break;case 3:input=[input[0],input[1],input[2],input[1]];break}return new Padding(input)}toString(){return JSON.stringify(this.values)}}const anchors=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class VariableAnchorOffsetCollection{constructor(values){this.values=values.slice()}static parse(input){if(input instanceof VariableAnchorOffsetCollection){return input}if(!Array.isArray(input)||input.length<1||input.length%2!==0){return undefined}for(let i=0;i<input.length;i+=2){const anchorValue=input[i];const offsetValue=input[i+1];if(typeof anchorValue!=="string"||!anchors.has(anchorValue)){return undefined}if(!Array.isArray(offsetValue)||offsetValue.length!==2||typeof offsetValue[0]!=="number"||typeof offsetValue[1]!=="number"){return undefined}}return new VariableAnchorOffsetCollection(input)}toString(){return JSON.stringify(this.values)}}class ResolvedImage{constructor(options){this.name=options.name;this.available=options.available}toString(){return this.name}static fromString(name){if(!name)return null;return new ResolvedImage({name:name,available:false})}}function validateRGBA(r,g,b,a){if(!(typeof r==="number"&&r>=0&&r<=255&&typeof g==="number"&&g>=0&&g<=255&&typeof b==="number"&&b>=0&&b<=255)){const value=typeof a==="number"?[r,g,b,a]:[r,g,b];return`Invalid rgba value [${value.join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}if(!(typeof a==="undefined"||typeof a==="number"&&a>=0&&a<=1)){return`Invalid rgba value [${[r,g,b,a].join(", ")}]: 'a' must be between 0 and 1.`}return null}function isValue(mixed){if(mixed===null||typeof mixed==="string"||typeof mixed==="boolean"||typeof mixed==="number"||mixed instanceof Color||mixed instanceof Collator||mixed instanceof Formatted||mixed instanceof Padding||mixed instanceof VariableAnchorOffsetCollection||mixed instanceof ResolvedImage){return true}else if(Array.isArray(mixed)){for(const item of mixed){if(!isValue(item)){return false}}return true}else if(typeof mixed==="object"){for(const key in mixed){if(!isValue(mixed[key])){return false}}return true}else{return false}}function typeOf(value){if(value===null){return NullType}else if(typeof value==="string"){return StringType}else if(typeof value==="boolean"){return BooleanType}else if(typeof value==="number"){return NumberType}else if(value instanceof Color){return ColorType}else if(value instanceof Collator){return CollatorType}else if(value instanceof Formatted){return FormattedType}else if(value instanceof Padding){return PaddingType}else if(value instanceof VariableAnchorOffsetCollection){return VariableAnchorOffsetCollectionType}else if(value instanceof ResolvedImage){return ResolvedImageType}else if(Array.isArray(value)){const length=value.length;let itemType;for(const item of value){const t=typeOf(item);if(!itemType){itemType=t}else if(itemType===t){continue}else{itemType=ValueType;break}}return array$1(itemType||ValueType,length)}else{return ObjectType}}function toString(value){const type=typeof value;if(value===null){return""}else if(type==="string"||type==="number"||type==="boolean"){return String(value)}else if(value instanceof Color||value instanceof Formatted||value instanceof Padding||value instanceof VariableAnchorOffsetCollection||value instanceof ResolvedImage){return value.toString()}else{return JSON.stringify(value)}}class Literal{constructor(type,value){this.type=type;this.value=value}static parse(args,context){if(args.length!==2)return context.error(`'literal' expression requires exactly one argument, but found ${args.length-1} instead.`);if(!isValue(args[1]))return context.error("invalid value");const value=args[1];let type=typeOf(value);const expected=context.expectedType;if(type.kind==="array"&&type.N===0&&expected&&expected.kind==="array"&&(typeof expected.N!=="number"||expected.N===0)){type=expected}return new Literal(type,value)}evaluate(){return this.value}eachChild(){}outputDefined(){return true}}class RuntimeError{constructor(message){this.name="ExpressionEvaluationError";this.message=message}toJSON(){return this.message}}const types$1={string:StringType,number:NumberType,boolean:BooleanType,object:ObjectType};class Assertion{constructor(type,args){this.type=type;this.args=args}static parse(args,context){if(args.length<2)return context.error("Expected at least one argument.");let i=1;let type;const name=args[0];if(name==="array"){let itemType;if(args.length>2){const type=args[1];if(typeof type!=="string"||!(type in types$1)||type==="object")return context.error('The item type argument of "array" must be one of string, number, boolean',1);itemType=types$1[type];i++}else{itemType=ValueType}let N;if(args.length>3){if(args[2]!==null&&(typeof args[2]!=="number"||args[2]<0||args[2]!==Math.floor(args[2]))){return context.error('The length argument to "array" must be a positive integer literal',2)}N=args[2];i++}type=array$1(itemType,N)}else{if(!types$1[name])throw new Error(`Types doesn't contain name = ${name}`);type=types$1[name]}const parsed=[];for(;i<args.length;i++){const input=context.parse(args[i],i,ValueType);if(!input)return null;parsed.push(input)}return new Assertion(type,parsed)}evaluate(ctx){for(let i=0;i<this.args.length;i++){const value=this.args[i].evaluate(ctx);const error=checkSubtype(this.type,typeOf(value));if(!error){return value}else if(i===this.args.length-1){throw new RuntimeError(`Expected value to be of type ${toString$1(this.type)}, but found ${toString$1(typeOf(value))} instead.`)}}throw new Error}eachChild(fn){this.args.forEach(fn)}outputDefined(){return this.args.every((arg=>arg.outputDefined()))}}const types={"to-boolean":BooleanType,"to-color":ColorType,"to-number":NumberType,"to-string":StringType};class Coercion{constructor(type,args){this.type=type;this.args=args}static parse(args,context){if(args.length<2)return context.error("Expected at least one argument.");const name=args[0];if(!types[name])throw new Error(`Can't parse ${name} as it is not part of the known types`);if((name==="to-boolean"||name==="to-string")&&args.length!==2)return context.error("Expected one argument.");const type=types[name];const parsed=[];for(let i=1;i<args.length;i++){const input=context.parse(args[i],i,ValueType);if(!input)return null;parsed.push(input)}return new Coercion(type,parsed)}evaluate(ctx){switch(this.type.kind){case"boolean":return Boolean(this.args[0].evaluate(ctx));case"color":{let input;let error;for(const arg of this.args){input=arg.evaluate(ctx);error=null;if(input instanceof Color){return input}else if(typeof input==="string"){const c=ctx.parseColor(input);if(c)return c}else if(Array.isArray(input)){if(input.length<3||input.length>4){error=`Invalid rbga value ${JSON.stringify(input)}: expected an array containing either three or four numeric values.`}else{error=validateRGBA(input[0],input[1],input[2],input[3])}if(!error){return new Color(input[0]/255,input[1]/255,input[2]/255,input[3])}}}throw new RuntimeError(error||`Could not parse color from value '${typeof input==="string"?input:JSON.stringify(input)}'`)}case"padding":{let input;for(const arg of this.args){input=arg.evaluate(ctx);const pad=Padding.parse(input);if(pad){return pad}}throw new RuntimeError(`Could not parse padding from value '${typeof input==="string"?input:JSON.stringify(input)}'`)}case"variableAnchorOffsetCollection":{let input;for(const arg of this.args){input=arg.evaluate(ctx);const coll=VariableAnchorOffsetCollection.parse(input);if(coll){return coll}}throw new RuntimeError(`Could not parse variableAnchorOffsetCollection from value '${typeof input==="string"?input:JSON.stringify(input)}'`)}case"number":{let value=null;for(const arg of this.args){value=arg.evaluate(ctx);if(value===null)return 0;const num=Number(value);if(isNaN(num))continue;return num}throw new RuntimeError(`Could not convert ${JSON.stringify(value)} to number.`)}case"formatted":return Formatted.fromString(toString(this.args[0].evaluate(ctx)));case"resolvedImage":return ResolvedImage.fromString(toString(this.args[0].evaluate(ctx)));default:return toString(this.args[0].evaluate(ctx))}}eachChild(fn){this.args.forEach(fn)}outputDefined(){return this.args.every((arg=>arg.outputDefined()))}}const geometryTypes=["Unknown","Point","LineString","Polygon"];class EvaluationContext{constructor(){this.globals=null;this.feature=null;this.featureState=null;this.formattedSection=null;this._parseColorCache={};this.availableImages=null;this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type==="number"?geometryTypes[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(input){let cached=this._parseColorCache[input];if(!cached){cached=this._parseColorCache[input]=Color.parse(input)}return cached}}class ParsingContext{constructor(registry,isConstantFunc,path=[],expectedType,scope=new Scope,errors=[]){this.registry=registry;this.path=path;this.key=path.map((part=>`[${part}]`)).join("");this.scope=scope;this.errors=errors;this.expectedType=expectedType;this._isConstant=isConstantFunc}parse(expr,index,expectedType,bindings,options={}){if(index){return this.concat(index,expectedType,bindings)._parse(expr,options)}return this._parse(expr,options)}_parse(expr,options){if(expr===null||typeof expr==="string"||typeof expr==="boolean"||typeof expr==="number"){expr=["literal",expr]}function annotate(parsed,type,typeAnnotation){if(typeAnnotation==="assert"){return new Assertion(type,[parsed])}else if(typeAnnotation==="coerce"){return new Coercion(type,[parsed])}else{return parsed}}if(Array.isArray(expr)){if(expr.length===0){return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].')}const op=expr[0];if(typeof op!=="string"){this.error(`Expression name must be a string, but found ${typeof op} instead. If you wanted a literal array, use ["literal", [...]].`,0);return null}const Expr=this.registry[op];if(Expr){let parsed=Expr.parse(expr,this);if(!parsed)return null;if(this.expectedType){const expected=this.expectedType;const actual=parsed.type;if((expected.kind==="string"||expected.kind==="number"||expected.kind==="boolean"||expected.kind==="object"||expected.kind==="array")&&actual.kind==="value"){parsed=annotate(parsed,expected,options.typeAnnotation||"assert")}else if((expected.kind==="color"||expected.kind==="formatted"||expected.kind==="resolvedImage")&&(actual.kind==="value"||actual.kind==="string")){parsed=annotate(parsed,expected,options.typeAnnotation||"coerce")}else if(expected.kind==="padding"&&(actual.kind==="value"||actual.kind==="number"||actual.kind==="array")){parsed=annotate(parsed,expected,options.typeAnnotation||"coerce")}else if(expected.kind==="variableAnchorOffsetCollection"&&(actual.kind==="value"||actual.kind==="array")){parsed=annotate(parsed,expected,options.typeAnnotation||"coerce")}else if(this.checkSubtype(expected,actual)){return null}}if(!(parsed instanceof Literal)&&parsed.type.kind!=="resolvedImage"&&this._isConstant(parsed)){const ec=new EvaluationContext;try{parsed=new Literal(parsed.type,parsed.evaluate(ec))}catch(e){this.error(e.message);return null}}return parsed}return this.error(`Unknown expression "${op}". If you wanted a literal array, use ["literal", [...]].`,0)}else if(typeof expr==="undefined"){return this.error("'undefined' value invalid. Use null instead.")}else if(typeof expr==="object"){return this.error('Bare objects invalid. Use ["literal", {...}] instead.')}else{return this.error(`Expected an array, but found ${typeof expr} instead.`)}}concat(index,expectedType,bindings){const path=typeof index==="number"?this.path.concat(index):this.path;const scope=bindings?this.scope.concat(bindings):this.scope;return new ParsingContext(this.registry,this._isConstant,path,expectedType||null,scope,this.errors)}error(error,...keys){const key=`${this.key}${keys.map((k=>`[${k}]`)).join("")}`;this.errors.push(new ExpressionParsingError(key,error))}checkSubtype(expected,t){const error=checkSubtype(expected,t);if(error)this.error(error);return error}}class CollatorExpression{constructor(caseSensitive,diacriticSensitive,locale){this.type=CollatorType;this.locale=locale;this.caseSensitive=caseSensitive;this.diacriticSensitive=diacriticSensitive}static parse(args,context){if(args.length!==2)return context.error("Expected one argument.");const options=args[1];if(typeof options!=="object"||Array.isArray(options))return context.error("Collator options argument must be an object.");const caseSensitive=context.parse(options["case-sensitive"]===undefined?false:options["case-sensitive"],1,BooleanType);if(!caseSensitive)return null;const diacriticSensitive=context.parse(options["diacritic-sensitive"]===undefined?false:options["diacritic-sensitive"],1,BooleanType);if(!diacriticSensitive)return null;let locale=null;if(options["locale"]){locale=context.parse(options["locale"],1,StringType);if(!locale)return null}return new CollatorExpression(caseSensitive,diacriticSensitive,locale)}evaluate(ctx){return new Collator(this.caseSensitive.evaluate(ctx),this.diacriticSensitive.evaluate(ctx),this.locale?this.locale.evaluate(ctx):null)}eachChild(fn){fn(this.caseSensitive);fn(this.diacriticSensitive);if(this.locale){fn(this.locale)}}outputDefined(){return false}}const EXTENT$1=8192;function updateBBox(bbox,coord){bbox[0]=Math.min(bbox[0],coord[0]);bbox[1]=Math.min(bbox[1],coord[1]);bbox[2]=Math.max(bbox[2],coord[0]);bbox[3]=Math.max(bbox[3],coord[1])}function mercatorXfromLng$1(lng){return(180+lng)/360}function mercatorYfromLat$1(lat){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+lat*Math.PI/360)))/360}function boxWithinBox(bbox1,bbox2){if(bbox1[0]<=bbox2[0])return false;if(bbox1[2]>=bbox2[2])return false;if(bbox1[1]<=bbox2[1])return false;if(bbox1[3]>=bbox2[3])return false;return true}function getTileCoordinates(p,canonical){const x=mercatorXfromLng$1(p[0]);const y=mercatorYfromLat$1(p[1]);const tilesAtZoom=Math.pow(2,canonical.z);return[Math.round(x*tilesAtZoom*EXTENT$1),Math.round(y*tilesAtZoom*EXTENT$1)]}function onBoundary(p,p1,p2){const x1=p[0]-p1[0];const y1=p[1]-p1[1];const x2=p[0]-p2[0];const y2=p[1]-p2[1];return x1*y2-x2*y1===0&&x1*x2<=0&&y1*y2<=0}function rayIntersect(p,p1,p2){return p1[1]>p[1]!==p2[1]>p[1]&&p[0]<(p2[0]-p1[0])*(p[1]-p1[1])/(p2[1]-p1[1])+p1[0]}function pointWithinPolygon(point,rings){let inside=false;for(let i=0,len=rings.length;i<len;i++){const ring=rings[i];for(let j=0,len2=ring.length;j<len2-1;j++){if(onBoundary(point,ring[j],ring[j+1]))return false;if(rayIntersect(point,ring[j],ring[j+1]))inside=!inside}}return inside}function pointWithinPolygons(point,polygons){for(let i=0;i<polygons.length;i++){if(pointWithinPolygon(point,polygons[i]))return true}return false}function perp(v1,v2){return v1[0]*v2[1]-v1[1]*v2[0]}function twoSided(p1,p2,q1,q2){const x1=p1[0]-q1[0];const y1=p1[1]-q1[1];const x2=p2[0]-q1[0];const y2=p2[1]-q1[1];const x3=q2[0]-q1[0];const y3=q2[1]-q1[1];const det1=x1*y3-x3*y1;const det2=x2*y3-x3*y2;if(det1>0&&det2<0||det1<0&&det2>0)return true;return false}function lineIntersectLine(a,b,c,d){const vectorP=[b[0]-a[0],b[1]-a[1]];const vectorQ=[d[0]-c[0],d[1]-c[1]];if(perp(vectorQ,vectorP)===0)return false;if(twoSided(a,b,c,d)&&twoSided(c,d,a,b))return true;return false}function lineIntersectPolygon(p1,p2,polygon){for(const ring of polygon){for(let j=0;j<ring.length-1;++j){if(lineIntersectLine(p1,p2,ring[j],ring[j+1])){return true}}}return false}function lineStringWithinPolygon(line,polygon){for(let i=0;i<line.length;++i){if(!pointWithinPolygon(line[i],polygon)){return false}}for(let i=0;i<line.length-1;++i){if(lineIntersectPolygon(line[i],line[i+1],polygon)){return false}}return true}function lineStringWithinPolygons(line,polygons){for(let i=0;i<polygons.length;i++){if(lineStringWithinPolygon(line,polygons[i]))return true}return false}function getTilePolygon(coordinates,bbox,canonical){const polygon=[];for(let i=0;i<coordinates.length;i++){const ring=[];for(let j=0;j<coordinates[i].length;j++){const coord=getTileCoordinates(coordinates[i][j],canonical);updateBBox(bbox,coord);ring.push(coord)}polygon.push(ring)}return polygon}function getTilePolygons(coordinates,bbox,canonical){const polygons=[];for(let i=0;i<coordinates.length;i++){const polygon=getTilePolygon(coordinates[i],bbox,canonical);polygons.push(polygon)}return polygons}function updatePoint(p,bbox,polyBBox,worldSize){if(p[0]<polyBBox[0]||p[0]>polyBBox[2]){const halfWorldSize=worldSize*.5;let shift=p[0]-polyBBox[0]>halfWorldSize?-worldSize:polyBBox[0]-p[0]>halfWorldSize?worldSize:0;if(shift===0){shift=p[0]-polyBBox[2]>halfWorldSize?-worldSize:polyBBox[2]-p[0]>halfWorldSize?worldSize:0}p[0]+=shift}updateBBox(bbox,p)}function resetBBox(bbox){bbox[0]=bbox[1]=Infinity;bbox[2]=bbox[3]=-Infinity}function getTilePoints(geometry,pointBBox,polyBBox,canonical){const worldSize=Math.pow(2,canonical.z)*EXTENT$1;const shifts=[canonical.x*EXTENT$1,canonical.y*EXTENT$1];const tilePoints=[];for(const points of geometry){for(const point of points){const p=[point.x+shifts[0],point.y+shifts[1]];updatePoint(p,pointBBox,polyBBox,worldSize);tilePoints.push(p)}}return tilePoints}function getTileLines(geometry,lineBBox,polyBBox,canonical){const worldSize=Math.pow(2,canonical.z)*EXTENT$1;const shifts=[canonical.x*EXTENT$1,canonical.y*EXTENT$1];const tileLines=[];for(const line of geometry){const tileLine=[];for(const point of line){const p=[point.x+shifts[0],point.y+shifts[1]];updateBBox(lineBBox,p);tileLine.push(p)}tileLines.push(tileLine)}if(lineBBox[2]-lineBBox[0]<=worldSize/2){resetBBox(lineBBox);for(const line of tileLines){for(const p of line){updatePoint(p,lineBBox,polyBBox,worldSize)}}}return tileLines}function pointsWithinPolygons(ctx,polygonGeometry){const pointBBox=[Infinity,Infinity,-Infinity,-Infinity];const polyBBox=[Infinity,Infinity,-Infinity,-Infinity];const canonical=ctx.canonicalID();if(polygonGeometry.type==="Polygon"){const tilePolygon=getTilePolygon(polygonGeometry.coordinates,polyBBox,canonical);const tilePoints=getTilePoints(ctx.geometry(),pointBBox,polyBBox,canonical);if(!boxWithinBox(pointBBox,polyBBox))return false;for(const point of tilePoints){if(!pointWithinPolygon(point,tilePolygon))return false}}if(polygonGeometry.type==="MultiPolygon"){const tilePolygons=getTilePolygons(polygonGeometry.coordinates,polyBBox,canonical);const tilePoints=getTilePoints(ctx.geometry(),pointBBox,polyBBox,canonical);if(!boxWithinBox(pointBBox,polyBBox))return false;for(const point of tilePoints){if(!pointWithinPolygons(point,tilePolygons))return false}}return true}function linesWithinPolygons(ctx,polygonGeometry){const lineBBox=[Infinity,Infinity,-Infinity,-Infinity];const polyBBox=[Infinity,Infinity,-Infinity,-Infinity];const canonical=ctx.canonicalID();if(polygonGeometry.type==="Polygon"){const tilePolygon=getTilePolygon(polygonGeometry.coordinates,polyBBox,canonical);const tileLines=getTileLines(ctx.geometry(),lineBBox,polyBBox,canonical);if(!boxWithinBox(lineBBox,polyBBox))return false;for(const line of tileLines){if(!lineStringWithinPolygon(line,tilePolygon))return false}}if(polygonGeometry.type==="MultiPolygon"){const tilePolygons=getTilePolygons(polygonGeometry.coordinates,polyBBox,canonical);const tileLines=getTileLines(ctx.geometry(),lineBBox,polyBBox,canonical);if(!boxWithinBox(lineBBox,polyBBox))return false;for(const line of tileLines){if(!lineStringWithinPolygons(line,tilePolygons))return false}}return true}class Within{constructor(geojson,geometries){this.type=BooleanType;this.geojson=geojson;this.geometries=geometries}static parse(args,context){if(args.length!==2)return context.error(`'within' expression requires exactly one argument, but found ${args.length-1} instead.`);if(isValue(args[1])){const geojson=args[1];if(geojson.type==="FeatureCollection"){const polygonsCoords=[];for(const polygon of geojson.features){const{type:type,coordinates:coordinates}=polygon.geometry;if(type==="Polygon"){polygonsCoords.push(coordinates)}if(type==="MultiPolygon"){polygonsCoords.push(...coordinates)}}if(polygonsCoords.length){const multipolygonWrapper={type:"MultiPolygon",coordinates:polygonsCoords};return new Within(geojson,multipolygonWrapper)}}else if(geojson.type==="Feature"){const type=geojson.geometry.type;if(type==="Polygon"||type==="MultiPolygon"){return new Within(geojson,geojson.geometry)}}else if(geojson.type==="Polygon"||geojson.type==="MultiPolygon"){return new Within(geojson,geojson)}}return context.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(ctx){if(ctx.geometry()!=null&&ctx.canonicalID()!=null){if(ctx.geometryType()==="Point"){return pointsWithinPolygons(ctx,this.geometries)}else if(ctx.geometryType()==="LineString"){return linesWithinPolygons(ctx,this.geometries)}}return false}eachChild(){}outputDefined(){return true}}class Var{constructor(name,boundExpression){this.type=boundExpression.type;this.name=name;this.boundExpression=boundExpression}static parse(args,context){if(args.length!==2||typeof args[1]!=="string")return context.error("'var' expression requires exactly one string literal argument.");const name=args[1];if(!context.scope.has(name)){return context.error(`Unknown variable "${name}". Make sure "${name}" has been bound in an enclosing "let" expression before using it.`,1)}return new Var(name,context.scope.get(name))}evaluate(ctx){return this.boundExpression.evaluate(ctx)}eachChild(){}outputDefined(){return false}}class CompoundExpression{constructor(name,type,evaluate,args){this.name=name;this.type=type;this._evaluate=evaluate;this.args=args}evaluate(ctx){return this._evaluate(ctx,this.args)}eachChild(fn){this.args.forEach(fn)}outputDefined(){return false}static parse(args,context){const op=args[0];const definition=CompoundExpression.definitions[op];if(!definition){return context.error(`Unknown expression "${op}". If you wanted a literal array, use ["literal", [...]].`,0)}const type=Array.isArray(definition)?definition[0]:definition.type;const availableOverloads=Array.isArray(definition)?[[definition[1],definition[2]]]:definition.overloads;const overloads=availableOverloads.filter((([signature])=>!Array.isArray(signature)||signature.length===args.length-1));let signatureContext=null;for(const[params,evaluate]of overloads){signatureContext=new ParsingContext(context.registry,isExpressionConstant,context.path,null,context.scope);const parsedArgs=[];let argParseFailed=false;for(let i=1;i<args.length;i++){const arg=args[i];const expectedType=Array.isArray(params)?params[i-1]:params.type;const parsed=signatureContext.parse(arg,1+parsedArgs.length,expectedType);if(!parsed){argParseFailed=true;break}parsedArgs.push(parsed)}if(argParseFailed){continue}if(Array.isArray(params)){if(params.length!==parsedArgs.length){signatureContext.error(`Expected ${params.length} arguments, but found ${parsedArgs.length} instead.`);continue}}for(let i=0;i<parsedArgs.length;i++){const expected=Array.isArray(params)?params[i]:params.type;const arg=parsedArgs[i];signatureContext.concat(i+1).checkSubtype(expected,arg.type)}if(signatureContext.errors.length===0){return new CompoundExpression(op,type,evaluate,parsedArgs)}}if(overloads.length===1){context.errors.push(...signatureContext.errors)}else{const expected=overloads.length?overloads:availableOverloads;const signatures=expected.map((([params])=>stringifySignature(params))).join(" | ");const actualTypes=[];for(let i=1;i<args.length;i++){const parsed=context.parse(args[i],1+actualTypes.length);if(!parsed)return null;actualTypes.push(toString$1(parsed.type))}context.error(`Expected arguments of type ${signatures}, but found (${actualTypes.join(", ")}) instead.`)}return null}static register(registry,definitions){CompoundExpression.definitions=definitions;for(const name in definitions){registry[name]=CompoundExpression}}}function stringifySignature(signature){if(Array.isArray(signature)){return`(${signature.map(toString$1).join(", ")})`}else{return`(${toString$1(signature.type)}...)`}}function isExpressionConstant(expression){if(expression instanceof Var){return isExpressionConstant(expression.boundExpression)}else if(expression instanceof CompoundExpression&&expression.name==="error"){return false}else if(expression instanceof CollatorExpression){return false}else if(expression instanceof Within){return false}const isTypeAnnotation=expression instanceof Coercion||expression instanceof Assertion;let childrenConstant=true;expression.eachChild((child=>{if(isTypeAnnotation){childrenConstant=childrenConstant&&isExpressionConstant(child)}else{childrenConstant=childrenConstant&&child instanceof Literal}}));if(!childrenConstant){return false}return isFeatureConstant(expression)&&isGlobalPropertyConstant(expression,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function isFeatureConstant(e){if(e instanceof CompoundExpression){if(e.name==="get"&&e.args.length===1){return false}else if(e.name==="feature-state"){return false}else if(e.name==="has"&&e.args.length===1){return false}else if(e.name==="properties"||e.name==="geometry-type"||e.name==="id"){return false}else if(/^filter-/.test(e.name)){return false}}if(e instanceof Within){return false}let result=true;e.eachChild((arg=>{if(result&&!isFeatureConstant(arg)){result=false}}));return result}function isStateConstant(e){if(e instanceof CompoundExpression){if(e.name==="feature-state"){return false}}let result=true;e.eachChild((arg=>{if(result&&!isStateConstant(arg)){result=false}}));return result}function isGlobalPropertyConstant(e,properties){if(e instanceof CompoundExpression&&properties.indexOf(e.name)>=0){return false}let result=true;e.eachChild((arg=>{if(result&&!isGlobalPropertyConstant(arg,properties)){result=false}}));return result}function findStopLessThanOrEqualTo(stops,input){const lastIndex=stops.length-1;let lowerIndex=0;let upperIndex=lastIndex;let currentIndex=0;let currentValue,nextValue;while(lowerIndex<=upperIndex){currentIndex=Math.floor((lowerIndex+upperIndex)/2);currentValue=stops[currentIndex];nextValue=stops[currentIndex+1];if(currentValue<=input){if(currentIndex===lastIndex||input<nextValue){return currentIndex}lowerIndex=currentIndex+1}else if(currentValue>input){upperIndex=currentIndex-1}else{throw new RuntimeError("Input is not a number.")}}return 0}class Step{constructor(type,input,stops){this.type=type;this.input=input;this.labels=[];this.outputs=[];for(const[label,expression]of stops){this.labels.push(label);this.outputs.push(expression)}}static parse(args,context){if(args.length-1<4){return context.error(`Expected at least 4 arguments, but found only ${args.length-1}.`)}if((args.length-1)%2!==0){return context.error("Expected an even number of arguments.")}const input=context.parse(args[1],1,NumberType);if(!input)return null;const stops=[];let outputType=null;if(context.expectedType&&context.expectedType.kind!=="value"){outputType=context.expectedType}for(let i=1;i<args.length;i+=2){const label=i===1?-Infinity:args[i];const value=args[i+1];const labelKey=i;const valueKey=i+1;if(typeof label!=="number"){return context.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',labelKey)}if(stops.length&&stops[stops.length-1][0]>=label){return context.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',labelKey)}const parsed=context.parse(value,valueKey,outputType);if(!parsed)return null;outputType=outputType||parsed.type;stops.push([label,parsed])}return new Step(outputType,input,stops)}evaluate(ctx){const labels=this.labels;const outputs=this.outputs;if(labels.length===1){return outputs[0].evaluate(ctx)}const value=this.input.evaluate(ctx);if(value<=labels[0]){return outputs[0].evaluate(ctx)}const stopCount=labels.length;if(value>=labels[stopCount-1]){return outputs[stopCount-1].evaluate(ctx)}const index=findStopLessThanOrEqualTo(labels,value);return outputs[index].evaluate(ctx)}eachChild(fn){fn(this.input);for(const expression of this.outputs){fn(expression)}}outputDefined(){return this.outputs.every((out=>out.outputDefined()))}}function getDefaultExportFromCjs(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x["default"]:x}var unitbezier=UnitBezier;function UnitBezier(p1x,p1y,p2x,p2y){this.cx=3*p1x;this.bx=3*(p2x-p1x)-this.cx;this.ax=1-this.cx-this.bx;this.cy=3*p1y;this.by=3*(p2y-p1y)-this.cy;this.ay=1-this.cy-this.by;this.p1x=p1x;this.p1y=p1y;this.p2x=p2x;this.p2y=p2y}UnitBezier.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(x,epsilon){if(epsilon===undefined)epsilon=1e-6;if(x<0)return 0;if(x>1)return 1;var t=x;for(var i=0;i<8;i++){var x2=this.sampleCurveX(t)-x;if(Math.abs(x2)<epsilon)return t;var d2=this.sampleCurveDerivativeX(t);if(Math.abs(d2)<1e-6)break;t=t-x2/d2}var t0=0;var t1=1;t=x;for(i=0;i<20;i++){x2=this.sampleCurveX(t);if(Math.abs(x2-x)<epsilon)break;if(x>x2){t0=t}else{t1=t}t=(t1-t0)*.5+t0}return t},solve:function(x,epsilon){return this.sampleCurveY(this.solveCurveX(x,epsilon))}};var UnitBezier$1=getDefaultExportFromCjs(unitbezier);function isSupportedInterpolationColorSpace(colorSpace){return colorSpace==="rgb"||colorSpace==="hcl"||colorSpace==="lab"}const interpolateFactory=interpolationType=>{switch(interpolationType){case"number":return number;case"color":return color;case"array":return array;case"padding":return padding;case"variableAnchorOffsetCollection":return variableAnchorOffsetCollection}};function number(from,to,t){return from+t*(to-from)}function color(from,to,t,spaceKey="rgb"){switch(spaceKey){case"rgb":{const[r,g,b,alpha]=array(from.rgb,to.rgb,t);return new Color(r,g,b,alpha,false)}case"hcl":{const[hue0,chroma0,light0,alphaF]=from.hcl;const[hue1,chroma1,light1,alphaT]=to.hcl;let hue,chroma;if(!isNaN(hue0)&&!isNaN(hue1)){let dh=hue1-hue0;if(hue1>hue0&&dh>180){dh-=360}else if(hue1<hue0&&hue0-hue1>180){dh+=360}hue=hue0+t*dh}else if(!isNaN(hue0)){hue=hue0;if(light1===1||light1===0)chroma=chroma0}else if(!isNaN(hue1)){hue=hue1;if(light0===1||light0===0)chroma=chroma1}else{hue=NaN}const[r,g,b,alpha]=hclToRgb([hue,chroma!==null&&chroma!==void 0?chroma:number(chroma0,chroma1,t),number(light0,light1,t),number(alphaF,alphaT,t)]);return new Color(r,g,b,alpha,false)}case"lab":{const[r,g,b,alpha]=labToRgb(array(from.lab,to.lab,t));return new Color(r,g,b,alpha,false)}}}function array(from,to,t){return from.map(((d,i)=>number(d,to[i],t)))}function padding(from,to,t){return new Padding(array(from.values,to.values,t))}function variableAnchorOffsetCollection(from,to,t){const fromValues=from.values;const toValues=to.values;if(fromValues.length!==toValues.length){throw new RuntimeError(`Cannot interpolate values of different length. from: ${from.toString()}, to: ${to.toString()}`)}const output=[];for(let i=0;i<fromValues.length;i+=2){if(fromValues[i]!==toValues[i]){throw new RuntimeError(`Cannot interpolate values containing mismatched anchors. from[${i}]: ${fromValues[i]}, to[${i}]: ${toValues[i]}`)}output.push(fromValues[i]);const[fx,fy]=fromValues[i+1];const[tx,ty]=toValues[i+1];output.push([number(fx,tx,t),number(fy,ty,t)])}return new VariableAnchorOffsetCollection(output)}const interpolate={number:number,color:color,array:array,padding:padding,variableAnchorOffsetCollection:variableAnchorOffsetCollection};class Interpolate{constructor(type,operator,interpolation,input,stops){this.type=type;this.operator=operator;this.interpolation=interpolation;this.input=input;this.labels=[];this.outputs=[];for(const[label,expression]of stops){this.labels.push(label);this.outputs.push(expression)}}static interpolationFactor(interpolation,input,lower,upper){let t=0;if(interpolation.name==="exponential"){t=exponentialInterpolation(input,interpolation.base,lower,upper)}else if(interpolation.name==="linear"){t=exponentialInterpolation(input,1,lower,upper)}else if(interpolation.name==="cubic-bezier"){const c=interpolation.controlPoints;const ub=new UnitBezier$1(c[0],c[1],c[2],c[3]);t=ub.solve(exponentialInterpolation(input,1,lower,upper))}return t}static parse(args,context){let[operator,interpolation,input,...rest]=args;if(!Array.isArray(interpolation)||interpolation.length===0){return context.error("Expected an interpolation type expression.",1)}if(interpolation[0]==="linear"){interpolation={name:"linear"}}else if(interpolation[0]==="exponential"){const base=interpolation[1];if(typeof base!=="number")return context.error("Exponential interpolation requires a numeric base.",1,1);interpolation={name:"exponential",base:base}}else if(interpolation[0]==="cubic-bezier"){const controlPoints=interpolation.slice(1);if(controlPoints.length!==4||controlPoints.some((t=>typeof t!=="number"||t<0||t>1))){return context.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1)}interpolation={name:"cubic-bezier",controlPoints:controlPoints}}else{return context.error(`Unknown interpolation type ${String(interpolation[0])}`,1,0)}if(args.length-1<4){return context.error(`Expected at least 4 arguments, but found only ${args.length-1}.`)}if((args.length-1)%2!==0){return context.error("Expected an even number of arguments.")}input=context.parse(input,2,NumberType);if(!input)return null;const stops=[];let outputType=null;if(operator==="interpolate-hcl"||operator==="interpolate-lab"){outputType=ColorType}else if(context.expectedType&&context.expectedType.kind!=="value"){outputType=context.expectedType}for(let i=0;i<rest.length;i+=2){const label=rest[i];const value=rest[i+1];const labelKey=i+3;const valueKey=i+4;if(typeof label!=="number"){return context.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',labelKey)}if(stops.length&&stops[stops.length-1][0]>=label){return context.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',labelKey)}const parsed=context.parse(value,valueKey,outputType);if(!parsed)return null;outputType=outputType||parsed.type;stops.push([label,parsed])}if(!verifyType(outputType,NumberType)&&!verifyType(outputType,ColorType)&&!verifyType(outputType,PaddingType)&&!verifyType(outputType,VariableAnchorOffsetCollectionType)&&!verifyType(outputType,array$1(NumberType))){return context.error(`Type ${toString$1(outputType)} is not interpolatable.`)}return new Interpolate(outputType,operator,interpolation,input,stops)}evaluate(ctx){const labels=this.labels;const outputs=this.outputs;if(labels.length===1){return outputs[0].evaluate(ctx)}const value=this.input.evaluate(ctx);if(value<=labels[0]){return outputs[0].evaluate(ctx)}const stopCount=labels.length;if(value>=labels[stopCount-1]){return outputs[stopCount-1].evaluate(ctx)}const index=findStopLessThanOrEqualTo(labels,value);const lower=labels[index];const upper=labels[index+1];const t=Interpolate.interpolationFactor(this.interpolation,value,lower,upper);const outputLower=outputs[index].evaluate(ctx);const outputUpper=outputs[index+1].evaluate(ctx);switch(this.operator){case"interpolate":return interpolate[this.type.kind](outputLower,outputUpper,t);case"interpolate-hcl":return interpolate.color(outputLower,outputUpper,t,"hcl");case"interpolate-lab":return interpolate.color(outputLower,outputUpper,t,"lab")}}eachChild(fn){fn(this.input);for(const expression of this.outputs){fn(expression)}}outputDefined(){return this.outputs.every((out=>out.outputDefined()))}}function exponentialInterpolation(input,base,lowerValue,upperValue){const difference=upperValue-lowerValue;const progress=input-lowerValue;if(difference===0){return 0}else if(base===1){return progress/difference}else{return(Math.pow(base,progress)-1)/(Math.pow(base,difference)-1)}}class Coalesce{constructor(type,args){this.type=type;this.args=args}static parse(args,context){if(args.length<2){return context.error("Expectected at least one argument.")}let outputType=null;const expectedType=context.expectedType;if(expectedType&&expectedType.kind!=="value"){outputType=expectedType}const parsedArgs=[];for(const arg of args.slice(1)){const parsed=context.parse(arg,1+parsedArgs.length,outputType,undefined,{typeAnnotation:"omit"});if(!parsed)return null;outputType=outputType||parsed.type;parsedArgs.push(parsed)}if(!outputType)throw new Error("No output type");const needsAnnotation=expectedType&&parsedArgs.some((arg=>checkSubtype(expectedType,arg.type)));return needsAnnotation?new Coalesce(ValueType,parsedArgs):new Coalesce(outputType,parsedArgs)}evaluate(ctx){let result=null;let argCount=0;let requestedImageName;for(const arg of this.args){argCount++;result=arg.evaluate(ctx);if(result&&result instanceof ResolvedImage&&!result.available){if(!requestedImageName){requestedImageName=result.name}result=null;if(argCount===this.args.length){result=requestedImageName}}if(result!==null)break}return result}eachChild(fn){this.args.forEach(fn)}outputDefined(){return this.args.every((arg=>arg.outputDefined()))}}class Let{constructor(bindings,result){this.type=result.type;this.bindings=[].concat(bindings);this.result=result}evaluate(ctx){return this.result.evaluate(ctx)}eachChild(fn){for(const binding of this.bindings){fn(binding[1])}fn(this.result)}static parse(args,context){if(args.length<4)return context.error(`Expected at least 3 arguments, but found ${args.length-1} instead.`);const bindings=[];for(let i=1;i<args.length-1;i+=2){const name=args[i];if(typeof name!=="string"){return context.error(`Expected string, but found ${typeof name} instead.`,i)}if(/[^a-zA-Z0-9_]/.test(name)){return context.error("Variable names must contain only alphanumeric characters or '_'.",i)}const value=context.parse(args[i+1],i+1);if(!value)return null;bindings.push([name,value])}const result=context.parse(args[args.length-1],args.length-1,context.expectedType,bindings);if(!result)return null;return new Let(bindings,result)}outputDefined(){return this.result.outputDefined()}}class At{constructor(type,index,input){this.type=type;this.index=index;this.input=input}static parse(args,context){if(args.length!==3)return context.error(`Expected 2 arguments, but found ${args.length-1} instead.`);const index=context.parse(args[1],1,NumberType);const input=context.parse(args[2],2,array$1(context.expectedType||ValueType));if(!index||!input)return null;const t=input.type;return new At(t.itemType,index,input)}evaluate(ctx){const index=this.index.evaluate(ctx);const array=this.input.evaluate(ctx);if(index<0){throw new RuntimeError(`Array index out of bounds: ${index} < 0.`)}if(index>=array.length){throw new RuntimeError(`Array index out of bounds: ${index} > ${array.length-1}.`)}if(index!==Math.floor(index)){throw new RuntimeError(`Array index must be an integer, but found ${index} instead.`)}return array[index]}eachChild(fn){fn(this.index);fn(this.input)}outputDefined(){return false}}class In{constructor(needle,haystack){this.type=BooleanType;this.needle=needle;this.haystack=haystack}static parse(args,context){if(args.length!==3){return context.error(`Expected 2 arguments, but found ${args.length-1} instead.`)}const needle=context.parse(args[1],1,ValueType);const haystack=context.parse(args[2],2,ValueType);if(!needle||!haystack)return null;if(!isValidType(needle.type,[BooleanType,StringType,NumberType,NullType,ValueType])){return context.error(`Expected first argument to be of type boolean, string, number or null, but found ${toString$1(needle.type)} instead`)}return new In(needle,haystack)}evaluate(ctx){const needle=this.needle.evaluate(ctx);const haystack=this.haystack.evaluate(ctx);if(!haystack)return false;if(!isValidNativeType(needle,["boolean","string","number","null"])){throw new RuntimeError(`Expected first argument to be of type boolean, string, number or null, but found ${toString$1(typeOf(needle))} instead.`)}if(!isValidNativeType(haystack,["string","array"])){throw new RuntimeError(`Expected second argument to be of type array or string, but found ${toString$1(typeOf(haystack))} instead.`)}return haystack.indexOf(needle)>=0}eachChild(fn){fn(this.needle);fn(this.haystack)}outputDefined(){return true}}class IndexOf{constructor(needle,haystack,fromIndex){this.type=NumberType;this.needle=needle;this.haystack=haystack;this.fromIndex=fromIndex}static parse(args,context){if(args.length<=2||args.length>=5){return context.error(`Expected 3 or 4 arguments, but found ${args.length-1} instead.`)}const needle=context.parse(args[1],1,ValueType);const haystack=context.parse(args[2],2,ValueType);if(!needle||!haystack)return null;if(!isValidType(needle.type,[BooleanType,StringType,NumberType,NullType,ValueType])){return context.error(`Expected first argument to be of type boolean, string, number or null, but found ${toString$1(needle.type)} instead`)}if(args.length===4){const fromIndex=context.parse(args[3],3,NumberType);if(!fromIndex)return null;return new IndexOf(needle,haystack,fromIndex)}else{return new IndexOf(needle,haystack)}}evaluate(ctx){const needle=this.needle.evaluate(ctx);const haystack=this.haystack.evaluate(ctx);if(!isValidNativeType(needle,["boolean","string","number","null"])){throw new RuntimeError(`Expected first argument to be of type boolean, string, number or null, but found ${toString$1(typeOf(needle))} instead.`)}if(!isValidNativeType(haystack,["string","array"])){throw new RuntimeError(`Expected second argument to be of type array or string, but found ${toString$1(typeOf(haystack))} instead.`)}if(this.fromIndex){const fromIndex=this.fromIndex.evaluate(ctx);return haystack.indexOf(needle,fromIndex)}return haystack.indexOf(needle)}eachChild(fn){fn(this.needle);fn(this.haystack);if(this.fromIndex){fn(this.fromIndex)}}outputDefined(){return false}}class Match{constructor(inputType,outputType,input,cases,outputs,otherwise){this.inputType=inputType;this.type=outputType;this.input=input;this.cases=cases;this.outputs=outputs;this.otherwise=otherwise}static parse(args,context){if(args.length<5)return context.error(`Expected at least 4 arguments, but found only ${args.length-1}.`);if(args.length%2!==1)return context.error("Expected an even number of arguments.");let inputType;let outputType;if(context.expectedType&&context.expectedType.kind!=="value"){outputType=context.expectedType}const cases={};const outputs=[];for(let i=2;i<args.length-1;i+=2){let labels=args[i];const value=args[i+1];if(!Array.isArray(labels)){labels=[labels]}const labelContext=context.concat(i);if(labels.length===0){return labelContext.error("Expected at least one branch label.")}for(const label of labels){if(typeof label!=="number"&&typeof label!=="string"){return labelContext.error("Branch labels must be numbers or strings.")}else if(typeof label==="number"&&Math.abs(label)>Number.MAX_SAFE_INTEGER){return labelContext.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`)}else if(typeof label==="number"&&Math.floor(label)!==label){return labelContext.error("Numeric branch labels must be integer values.")}else if(!inputType){inputType=typeOf(label)}else if(labelContext.checkSubtype(inputType,typeOf(label))){return null}if(typeof cases[String(label)]!=="undefined"){return labelContext.error("Branch labels must be unique.")}cases[String(label)]=outputs.length}const result=context.parse(value,i,outputType);if(!result)return null;outputType=outputType||result.type;outputs.push(result)}const input=context.parse(args[1],1,ValueType);if(!input)return null;const otherwise=context.parse(args[args.length-1],args.length-1,outputType);if(!otherwise)return null;if(input.type.kind!=="value"&&context.concat(1).checkSubtype(inputType,input.type)){return null}return new Match(inputType,outputType,input,cases,outputs,otherwise)}evaluate(ctx){const input=this.input.evaluate(ctx);const output=typeOf(input)===this.inputType&&this.outputs[this.cases[input]]||this.otherwise;return output.evaluate(ctx)}eachChild(fn){fn(this.input);this.outputs.forEach(fn);fn(this.otherwise)}outputDefined(){return this.outputs.every((out=>out.outputDefined()))&&this.otherwise.outputDefined()}}class Case{constructor(type,branches,otherwise){this.type=type;this.branches=branches;this.otherwise=otherwise}static parse(args,context){if(args.length<4)return context.error(`Expected at least 3 arguments, but found only ${args.length-1}.`);if(args.length%2!==0)return context.error("Expected an odd number of arguments.");let outputType;if(context.expectedType&&context.expectedType.kind!=="value"){outputType=context.expectedType}const branches=[];for(let i=1;i<args.length-1;i+=2){const test=context.parse(args[i],i,BooleanType);if(!test)return null;const result=context.parse(args[i+1],i+1,outputType);if(!result)return null;branches.push([test,result]);outputType=outputType||result.type}const otherwise=context.parse(args[args.length-1],args.length-1,outputType);if(!otherwise)return null;if(!outputType)throw new Error("Can't infer output type");return new Case(outputType,branches,otherwise)}evaluate(ctx){for(const[test,expression]of this.branches){if(test.evaluate(ctx)){return expression.evaluate(ctx)}}return this.otherwise.evaluate(ctx)}eachChild(fn){for(const[test,expression]of this.branches){fn(test);fn(expression)}fn(this.otherwise)}outputDefined(){return this.branches.every((([_,out])=>out.outputDefined()))&&this.otherwise.outputDefined()}}class Slice{constructor(type,input,beginIndex,endIndex){this.type=type;this.input=input;this.beginIndex=beginIndex;this.endIndex=endIndex}static parse(args,context){if(args.length<=2||args.length>=5){return context.error(`Expected 3 or 4 arguments, but found ${args.length-1} instead.`)}const input=context.parse(args[1],1,ValueType);const beginIndex=context.parse(args[2],2,NumberType);if(!input||!beginIndex)return null;if(!isValidType(input.type,[array$1(ValueType),StringType,ValueType])){return context.error(`Expected first argument to be of type array or string, but found ${toString$1(input.type)} instead`)}if(args.length===4){const endIndex=context.parse(args[3],3,NumberType);if(!endIndex)return null;return new Slice(input.type,input,beginIndex,endIndex)}else{return new Slice(input.type,input,beginIndex)}}evaluate(ctx){const input=this.input.evaluate(ctx);const beginIndex=this.beginIndex.evaluate(ctx);if(!isValidNativeType(input,["string","array"])){throw new RuntimeError(`Expected first argument to be of type array or string, but found ${toString$1(typeOf(input))} instead.`)}if(this.endIndex){const endIndex=this.endIndex.evaluate(ctx);return input.slice(beginIndex,endIndex)}return input.slice(beginIndex)}eachChild(fn){fn(this.input);fn(this.beginIndex);if(this.endIndex){fn(this.endIndex)}}outputDefined(){return false}}function isComparableType(op,type){if(op==="=="||op==="!="){return type.kind==="boolean"||type.kind==="string"||type.kind==="number"||type.kind==="null"||type.kind==="value"}else{return type.kind==="string"||type.kind==="number"||type.kind==="value"}}function eq(ctx,a,b){return a===b}function neq(ctx,a,b){return a!==b}function lt(ctx,a,b){return a<b}function gt(ctx,a,b){return a>b}function lteq(ctx,a,b){return a<=b}function gteq(ctx,a,b){return a>=b}function eqCollate(ctx,a,b,c){return c.compare(a,b)===0}function neqCollate(ctx,a,b,c){return!eqCollate(ctx,a,b,c)}function ltCollate(ctx,a,b,c){return c.compare(a,b)<0}function gtCollate(ctx,a,b,c){return c.compare(a,b)>0}function lteqCollate(ctx,a,b,c){return c.compare(a,b)<=0}function gteqCollate(ctx,a,b,c){return c.compare(a,b)>=0}function makeComparison(op,compareBasic,compareWithCollator){const isOrderComparison=op!=="=="&&op!=="!=";return class Comparison{constructor(lhs,rhs,collator){this.type=BooleanType;this.lhs=lhs;this.rhs=rhs;this.collator=collator;this.hasUntypedArgument=lhs.type.kind==="value"||rhs.type.kind==="value"}static parse(args,context){if(args.length!==3&&args.length!==4)return context.error("Expected two or three arguments.");const op=args[0];let lhs=context.parse(args[1],1,ValueType);if(!lhs)return null;if(!isComparableType(op,lhs.type)){return context.concat(1).error(`"${op}" comparisons are not supported for type '${toString$1(lhs.type)}'.`)}let rhs=context.parse(args[2],2,ValueType);if(!rhs)return null;if(!isComparableType(op,rhs.type)){return context.concat(2).error(`"${op}" comparisons are not supported for type '${toString$1(rhs.type)}'.`)}if(lhs.type.kind!==rhs.type.kind&&lhs.type.kind!=="value"&&rhs.type.kind!=="value"){return context.error(`Cannot compare types '${toString$1(lhs.type)}' and '${toString$1(rhs.type)}'.`)}if(isOrderComparison){if(lhs.type.kind==="value"&&rhs.type.kind!=="value"){lhs=new Assertion(rhs.type,[lhs])}else if(lhs.type.kind!=="value"&&rhs.type.kind==="value"){rhs=new Assertion(lhs.type,[rhs])}}let collator=null;if(args.length===4){if(lhs.type.kind!=="string"&&rhs.type.kind!=="string"&&lhs.type.kind!=="value"&&rhs.type.kind!=="value"){return context.error("Cannot use collator to compare non-string types.")}collator=context.parse(args[3],3,CollatorType);if(!collator)return null}return new Comparison(lhs,rhs,collator)}evaluate(ctx){const lhs=this.lhs.evaluate(ctx);const rhs=this.rhs.evaluate(ctx);if(isOrderComparison&&this.hasUntypedArgument){const lt=typeOf(lhs);const rt=typeOf(rhs);if(lt.kind!==rt.kind||!(lt.kind==="string"||lt.kind==="number")){throw new RuntimeError(`Expected arguments for "${op}" to be (string, string) or (number, number), but found (${lt.kind}, ${rt.kind}) instead.`)}}if(this.collator&&!isOrderComparison&&this.hasUntypedArgument){const lt=typeOf(lhs);const rt=typeOf(rhs);if(lt.kind!=="string"||rt.kind!=="string"){return compareBasic(ctx,lhs,rhs)}}return this.collator?compareWithCollator(ctx,lhs,rhs,this.collator.evaluate(ctx)):compareBasic(ctx,lhs,rhs)}eachChild(fn){fn(this.lhs);fn(this.rhs);if(this.collator){fn(this.collator)}}outputDefined(){return true}}}const Equals=makeComparison("==",eq,eqCollate);const NotEquals=makeComparison("!=",neq,neqCollate);const LessThan=makeComparison("<",lt,ltCollate);const GreaterThan=makeComparison(">",gt,gtCollate);const LessThanOrEqual=makeComparison("<=",lteq,lteqCollate);const GreaterThanOrEqual=makeComparison(">=",gteq,gteqCollate);class NumberFormat{constructor(number,locale,currency,minFractionDigits,maxFractionDigits){this.type=StringType;this.number=number;this.locale=locale;this.currency=currency;this.minFractionDigits=minFractionDigits;this.maxFractionDigits=maxFractionDigits}static parse(args,context){if(args.length!==3)return context.error("Expected two arguments.");const number=context.parse(args[1],1,NumberType);if(!number)return null;const options=args[2];if(typeof options!=="object"||Array.isArray(options))return context.error("NumberFormat options argument must be an object.");let locale=null;if(options["locale"]){locale=context.parse(options["locale"],1,StringType);if(!locale)return null}let currency=null;if(options["currency"]){currency=context.parse(options["currency"],1,StringType);if(!currency)return null}let minFractionDigits=null;if(options["min-fraction-digits"]){minFractionDigits=context.parse(options["min-fraction-digits"],1,NumberType);if(!minFractionDigits)return null}let maxFractionDigits=null;if(options["max-fraction-digits"]){maxFractionDigits=context.parse(options["max-fraction-digits"],1,NumberType);if(!maxFractionDigits)return null}return new NumberFormat(number,locale,currency,minFractionDigits,maxFractionDigits)}evaluate(ctx){return new Intl.NumberFormat(this.locale?this.locale.evaluate(ctx):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(ctx):undefined,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(ctx):undefined,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(ctx):undefined}).format(this.number.evaluate(ctx))}eachChild(fn){fn(this.number);if(this.locale){fn(this.locale)}if(this.currency){fn(this.currency)}if(this.minFractionDigits){fn(this.minFractionDigits)}if(this.maxFractionDigits){fn(this.maxFractionDigits)}}outputDefined(){return false}}class FormatExpression{constructor(sections){this.type=FormattedType;this.sections=sections}static parse(args,context){if(args.length<2){return context.error("Expected at least one argument.")}const firstArg=args[1];if(!Array.isArray(firstArg)&&typeof firstArg==="object"){return context.error("First argument must be an image or text section.")}const sections=[];let nextTokenMayBeObject=false;for(let i=1;i<=args.length-1;++i){const arg=args[i];if(nextTokenMayBeObject&&typeof arg==="object"&&!Array.isArray(arg)){nextTokenMayBeObject=false;let scale=null;if(arg["font-scale"]){scale=context.parse(arg["font-scale"],1,NumberType);if(!scale)return null}let font=null;if(arg["text-font"]){font=context.parse(arg["text-font"],1,array$1(StringType));if(!font)return null}let textColor=null;if(arg["text-color"]){textColor=context.parse(arg["text-color"],1,ColorType);if(!textColor)return null}const lastExpression=sections[sections.length-1];lastExpression.scale=scale;lastExpression.font=font;lastExpression.textColor=textColor}else{const content=context.parse(args[i],1,ValueType);if(!content)return null;const kind=content.type.kind;if(kind!=="string"&&kind!=="value"&&kind!=="null"&&kind!=="resolvedImage")return context.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");nextTokenMayBeObject=true;sections.push({content:content,scale:null,font:null,textColor:null})}}return new FormatExpression(sections)}evaluate(ctx){const evaluateSection=section=>{const evaluatedContent=section.content.evaluate(ctx);if(typeOf(evaluatedContent)===ResolvedImageType){return new FormattedSection("",evaluatedContent,null,null,null)}return new FormattedSection(toString(evaluatedContent),null,section.scale?section.scale.evaluate(ctx):null,section.font?section.font.evaluate(ctx).join(","):null,section.textColor?section.textColor.evaluate(ctx):null)};return new Formatted(this.sections.map(evaluateSection))}eachChild(fn){for(const section of this.sections){fn(section.content);if(section.scale){fn(section.scale)}if(section.font){fn(section.font)}if(section.textColor){fn(section.textColor)}}}outputDefined(){return false}}class ImageExpression{constructor(input){this.type=ResolvedImageType;this.input=input}static parse(args,context){if(args.length!==2){return context.error("Expected two arguments.")}const name=context.parse(args[1],1,StringType);if(!name)return context.error("No image name provided.");return new ImageExpression(name)}evaluate(ctx){const evaluatedImageName=this.input.evaluate(ctx);const value=ResolvedImage.fromString(evaluatedImageName);if(value&&ctx.availableImages)value.available=ctx.availableImages.indexOf(evaluatedImageName)>-1;return value}eachChild(fn){fn(this.input)}outputDefined(){return false}}class Length{constructor(input){this.type=NumberType;this.input=input}static parse(args,context){if(args.length!==2)return context.error(`Expected 1 argument, but found ${args.length-1} instead.`);const input=context.parse(args[1],1);if(!input)return null;if(input.type.kind!=="array"&&input.type.kind!=="string"&&input.type.kind!=="value")return context.error(`Expected argument of type string or array, but found ${toString$1(input.type)} instead.`);return new Length(input)}evaluate(ctx){const input=this.input.evaluate(ctx);if(typeof input==="string"){return input.length}else if(Array.isArray(input)){return input.length}else{throw new RuntimeError(`Expected value to be of type string or array, but found ${toString$1(typeOf(input))} instead.`)}}eachChild(fn){fn(this.input)}outputDefined(){return false}}const expressions$1={"==":Equals,"!=":NotEquals,">":GreaterThan,"<":LessThan,">=":GreaterThanOrEqual,"<=":LessThanOrEqual,array:Assertion,at:At,boolean:Assertion,case:Case,coalesce:Coalesce,collator:CollatorExpression,format:FormatExpression,image:ImageExpression,in:In,"index-of":IndexOf,interpolate:Interpolate,"interpolate-hcl":Interpolate,"interpolate-lab":Interpolate,length:Length,let:Let,literal:Literal,match:Match,number:Assertion,"number-format":NumberFormat,object:Assertion,slice:Slice,step:Step,string:Assertion,"to-boolean":Coercion,"to-color":Coercion,"to-number":Coercion,"to-string":Coercion,var:Var,within:Within};function rgba(ctx,[r,g,b,a]){r=r.evaluate(ctx);g=g.evaluate(ctx);b=b.evaluate(ctx);const alpha=a?a.evaluate(ctx):1;const error=validateRGBA(r,g,b,alpha);if(error)throw new RuntimeError(error);return new Color(r/255,g/255,b/255,alpha,false)}function has(key,obj){return key in obj}function get(key,obj){const v=obj[key];return typeof v==="undefined"?null:v}function binarySearch(v,a,i,j){while(i<=j){const m=i+j>>1;if(a[m]===v)return true;if(a[m]>v)j=m-1;else i=m+1}return false}function varargs(type){return{type:type}}CompoundExpression.register(expressions$1,{error:[ErrorType,[StringType],(ctx,[v])=>{throw new RuntimeError(v.evaluate(ctx))}],typeof:[StringType,[ValueType],(ctx,[v])=>toString$1(typeOf(v.evaluate(ctx)))],"to-rgba":[array$1(NumberType,4),[ColorType],(ctx,[v])=>{const[r,g,b,a]=v.evaluate(ctx).rgb;return[r*255,g*255,b*255,a]}],rgb:[ColorType,[NumberType,NumberType,NumberType],rgba],rgba:[ColorType,[NumberType,NumberType,NumberType,NumberType],rgba],has:{type:BooleanType,overloads:[[[StringType],(ctx,[key])=>has(key.evaluate(ctx),ctx.properties())],[[StringType,ObjectType],(ctx,[key,obj])=>has(key.evaluate(ctx),obj.evaluate(ctx))]]},get:{type:ValueType,overloads:[[[StringType],(ctx,[key])=>get(key.evaluate(ctx),ctx.properties())],[[StringType,ObjectType],(ctx,[key,obj])=>get(key.evaluate(ctx),obj.evaluate(ctx))]]},"feature-state":[ValueType,[StringType],(ctx,[key])=>get(key.evaluate(ctx),ctx.featureState||{})],properties:[ObjectType,[],ctx=>ctx.properties()],"geometry-type":[StringType,[],ctx=>ctx.geometryType()],id:[ValueType,[],ctx=>ctx.id()],zoom:[NumberType,[],ctx=>ctx.globals.zoom],"heatmap-density":[NumberType,[],ctx=>ctx.globals.heatmapDensity||0],"line-progress":[NumberType,[],ctx=>ctx.globals.lineProgress||0],accumulated:[ValueType,[],ctx=>ctx.globals.accumulated===undefined?null:ctx.globals.accumulated],"+":[NumberType,varargs(NumberType),(ctx,args)=>{let result=0;for(const arg of args){result+=arg.evaluate(ctx)}return result}],"*":[NumberType,varargs(NumberType),(ctx,args)=>{let result=1;for(const arg of args){result*=arg.evaluate(ctx)}return result}],"-":{type:NumberType,overloads:[[[NumberType,NumberType],(ctx,[a,b])=>a.evaluate(ctx)-b.evaluate(ctx)],[[NumberType],(ctx,[a])=>-a.evaluate(ctx)]]},"/":[NumberType,[NumberType,NumberType],(ctx,[a,b])=>a.evaluate(ctx)/b.evaluate(ctx)],"%":[NumberType,[NumberType,NumberType],(ctx,[a,b])=>a.evaluate(ctx)%b.evaluate(ctx)],ln2:[NumberType,[],()=>Math.LN2],pi:[NumberType,[],()=>Math.PI],e:[NumberType,[],()=>Math.E],"^":[NumberType,[NumberType,NumberType],(ctx,[b,e])=>Math.pow(b.evaluate(ctx),e.evaluate(ctx))],sqrt:[NumberType,[NumberType],(ctx,[x])=>Math.sqrt(x.evaluate(ctx))],log10:[NumberType,[NumberType],(ctx,[n])=>Math.log(n.evaluate(ctx))/Math.LN10],ln:[NumberType,[NumberType],(ctx,[n])=>Math.log(n.evaluate(ctx))],log2:[NumberType,[NumberType],(ctx,[n])=>Math.log(n.evaluate(ctx))/Math.LN2],sin:[NumberType,[NumberType],(ctx,[n])=>Math.sin(n.evaluate(ctx))],cos:[NumberType,[NumberType],(ctx,[n])=>Math.cos(n.evaluate(ctx))],tan:[NumberType,[NumberType],(ctx,[n])=>Math.tan(n.evaluate(ctx))],asin:[NumberType,[NumberType],(ctx,[n])=>Math.asin(n.evaluate(ctx))],acos:[NumberType,[NumberType],(ctx,[n])=>Math.acos(n.evaluate(ctx))],atan:[NumberType,[NumberType],(ctx,[n])=>Math.atan(n.evaluate(ctx))],min:[NumberType,varargs(NumberType),(ctx,args)=>Math.min(...args.map((arg=>arg.evaluate(ctx))))],max:[NumberType,varargs(NumberType),(ctx,args)=>Math.max(...args.map((arg=>arg.evaluate(ctx))))],abs:[NumberType,[NumberType],(ctx,[n])=>Math.abs(n.evaluate(ctx))],round:[NumberType,[NumberType],(ctx,[n])=>{const v=n.evaluate(ctx);return v<0?-Math.round(-v):Math.round(v)}],floor:[NumberType,[NumberType],(ctx,[n])=>Math.floor(n.evaluate(ctx))],ceil:[NumberType,[NumberType],(ctx,[n])=>Math.ceil(n.evaluate(ctx))],"filter-==":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>ctx.properties()[k.value]===v.value],"filter-id-==":[BooleanType,[ValueType],(ctx,[v])=>ctx.id()===v.value],"filter-type-==":[BooleanType,[StringType],(ctx,[v])=>ctx.geometryType()===v.value],"filter-<":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>{const a=ctx.properties()[k.value];const b=v.value;return typeof a===typeof b&&a<b}],"filter-id-<":[BooleanType,[ValueType],(ctx,[v])=>{const a=ctx.id();const b=v.value;return typeof a===typeof b&&a<b}],"filter->":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>{const a=ctx.properties()[k.value];const b=v.value;return typeof a===typeof b&&a>b}],"filter-id->":[BooleanType,[ValueType],(ctx,[v])=>{const a=ctx.id();const b=v.value;return typeof a===typeof b&&a>b}],"filter-<=":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>{const a=ctx.properties()[k.value];const b=v.value;return typeof a===typeof b&&a<=b}],"filter-id-<=":[BooleanType,[ValueType],(ctx,[v])=>{const a=ctx.id();const b=v.value;return typeof a===typeof b&&a<=b}],"filter->=":[BooleanType,[StringType,ValueType],(ctx,[k,v])=>{const a=ctx.properties()[k.value];const b=v.value;return typeof a===typeof b&&a>=b}],"filter-id->=":[BooleanType,[ValueType],(ctx,[v])=>{const a=ctx.id();const b=v.value;return typeof a===typeof b&&a>=b}],"filter-has":[BooleanType,[ValueType],(ctx,[k])=>k.value in ctx.properties()],"filter-has-id":[BooleanType,[],ctx=>ctx.id()!==null&&ctx.id()!==undefined],"filter-type-in":[BooleanType,[array$1(StringType)],(ctx,[v])=>v.value.indexOf(ctx.geometryType())>=0],"filter-id-in":[BooleanType,[array$1(ValueType)],(ctx,[v])=>v.value.indexOf(ctx.id())>=0],"filter-in-small":[BooleanType,[StringType,array$1(ValueType)],(ctx,[k,v])=>v.value.indexOf(ctx.properties()[k.value])>=0],"filter-in-large":[BooleanType,[StringType,array$1(ValueType)],(ctx,[k,v])=>binarySearch(ctx.properties()[k.value],v.value,0,v.value.length-1)],all:{type:BooleanType,overloads:[[[BooleanType,BooleanType],(ctx,[a,b])=>a.evaluate(ctx)&&b.evaluate(ctx)],[varargs(BooleanType),(ctx,args)=>{for(const arg of args){if(!arg.evaluate(ctx))return false}return true}]]},any:{type:BooleanType,overloads:[[[BooleanType,BooleanType],(ctx,[a,b])=>a.evaluate(ctx)||b.evaluate(ctx)],[varargs(BooleanType),(ctx,args)=>{for(const arg of args){if(arg.evaluate(ctx))return true}return false}]]},"!":[BooleanType,[BooleanType],(ctx,[b])=>!b.evaluate(ctx)],"is-supported-script":[BooleanType,[StringType],(ctx,[s])=>{const isSupportedScript=ctx.globals&&ctx.globals.isSupportedScript;if(isSupportedScript){return isSupportedScript(s.evaluate(ctx))}return true}],upcase:[StringType,[StringType],(ctx,[s])=>s.evaluate(ctx).toUpperCase()],downcase:[StringType,[StringType],(ctx,[s])=>s.evaluate(ctx).toLowerCase()],concat:[StringType,varargs(ValueType),(ctx,args)=>args.map((arg=>toString(arg.evaluate(ctx)))).join("")],"resolved-locale":[StringType,[CollatorType],(ctx,[collator])=>collator.evaluate(ctx).resolvedLocale()]});function success(value){return{result:"success",value:value}}function error(value){return{result:"error",value:value}}function supportsPropertyExpression(spec){return spec["property-type"]==="data-driven"||spec["property-type"]==="cross-faded-data-driven"}function supportsZoomExpression(spec){return!!spec.expression&&spec.expression.parameters.indexOf("zoom")>-1}function supportsInterpolation(spec){return!!spec.expression&&spec.expression.interpolated}function getType(val){if(val instanceof Number){return"number"}else if(val instanceof String){return"string"}else if(val instanceof Boolean){return"boolean"}else if(Array.isArray(val)){return"array"}else if(val===null){return"null"}else{return typeof val}}function isFunction$1(value){return typeof value==="object"&&value!==null&&!Array.isArray(value)}function identityFunction(x){return x}function createFunction(parameters,propertySpec){const isColor=propertySpec.type==="color";const zoomAndFeatureDependent=parameters.stops&&typeof parameters.stops[0][0]==="object";const featureDependent=zoomAndFeatureDependent||parameters.property!==undefined;const zoomDependent=zoomAndFeatureDependent||!featureDependent;const type=parameters.type||(supportsInterpolation(propertySpec)?"exponential":"interval");if(isColor||propertySpec.type==="padding"){const parseFn=isColor?Color.parse:Padding.parse;parameters=extendBy({},parameters);if(parameters.stops){parameters.stops=parameters.stops.map((stop=>[stop[0],parseFn(stop[1])]))}if(parameters.default){parameters.default=parseFn(parameters.default)}else{parameters.default=parseFn(propertySpec.default)}}if(parameters.colorSpace&&!isSupportedInterpolationColorSpace(parameters.colorSpace)){throw new Error(`Unknown color space: "${parameters.colorSpace}"`)}let innerFun;let hashedStops;let categoricalKeyType;if(type==="exponential"){innerFun=evaluateExponentialFunction}else if(type==="interval"){innerFun=evaluateIntervalFunction}else if(type==="categorical"){innerFun=evaluateCategoricalFunction;hashedStops=Object.create(null);for(const stop of parameters.stops){hashedStops[stop[0]]=stop[1]}categoricalKeyType=typeof parameters.stops[0][0]}else if(type==="identity"){innerFun=evaluateIdentityFunction}else{throw new Error(`Unknown function type "${type}"`)}if(zoomAndFeatureDependent){const featureFunctions={};const zoomStops=[];for(let s=0;s<parameters.stops.length;s++){const stop=parameters.stops[s];const zoom=stop[0].zoom;if(featureFunctions[zoom]===undefined){featureFunctions[zoom]={zoom:zoom,type:parameters.type,property:parameters.property,default:parameters.default,stops:[]};zoomStops.push(zoom)}featureFunctions[zoom].stops.push([stop[0].value,stop[1]])}const featureFunctionStops=[];for(const z of zoomStops){featureFunctionStops.push([featureFunctions[z].zoom,createFunction(featureFunctions[z],propertySpec)])}const interpolationType={name:"linear"};return{kind:"composite",interpolationType:interpolationType,interpolationFactor:Interpolate.interpolationFactor.bind(undefined,interpolationType),zoomStops:featureFunctionStops.map((s=>s[0])),evaluate({zoom:zoom},properties){return evaluateExponentialFunction({stops:featureFunctionStops,base:parameters.base},propertySpec,zoom).evaluate(zoom,properties)}}}else if(zoomDependent){const interpolationType=type==="exponential"?{name:"exponential",base:parameters.base!==undefined?parameters.base:1}:null;return{kind:"camera",interpolationType:interpolationType,interpolationFactor:Interpolate.interpolationFactor.bind(undefined,interpolationType),zoomStops:parameters.stops.map((s=>s[0])),evaluate:({zoom:zoom})=>innerFun(parameters,propertySpec,zoom,hashedStops,categoricalKeyType)}}else{return{kind:"source",evaluate(_,feature){const value=feature&&feature.properties?feature.properties[parameters.property]:undefined;if(value===undefined){return coalesce$1(parameters.default,propertySpec.default)}return innerFun(parameters,propertySpec,value,hashedStops,categoricalKeyType)}}}}function coalesce$1(a,b,c){if(a!==undefined)return a;if(b!==undefined)return b;if(c!==undefined)return c}function evaluateCategoricalFunction(parameters,propertySpec,input,hashedStops,keyType){const evaluated=typeof input===keyType?hashedStops[input]:undefined;return coalesce$1(evaluated,parameters.default,propertySpec.default)}function evaluateIntervalFunction(parameters,propertySpec,input){if(getType(input)!=="number")return coalesce$1(parameters.default,propertySpec.default);const n=parameters.stops.length;if(n===1)return parameters.stops[0][1];if(input<=parameters.stops[0][0])return parameters.stops[0][1];if(input>=parameters.stops[n-1][0])return parameters.stops[n-1][1];const index=findStopLessThanOrEqualTo(parameters.stops.map((stop=>stop[0])),input);return parameters.stops[index][1]}function evaluateExponentialFunction(parameters,propertySpec,input){const base=parameters.base!==undefined?parameters.base:1;if(getType(input)!=="number")return coalesce$1(parameters.default,propertySpec.default);const n=parameters.stops.length;if(n===1)return parameters.stops[0][1];if(input<=parameters.stops[0][0])return parameters.stops[0][1];if(input>=parameters.stops[n-1][0])return parameters.stops[n-1][1];const index=findStopLessThanOrEqualTo(parameters.stops.map((stop=>stop[0])),input);const t=interpolationFactor(input,base,parameters.stops[index][0],parameters.stops[index+1][0]);const outputLower=parameters.stops[index][1];const outputUpper=parameters.stops[index+1][1];const interp=interpolate[propertySpec.type]||identityFunction;if(typeof outputLower.evaluate==="function"){return{evaluate(...args){const evaluatedLower=outputLower.evaluate.apply(undefined,args);const evaluatedUpper=outputUpper.evaluate.apply(undefined,args);if(evaluatedLower===undefined||evaluatedUpper===undefined){return undefined}return interp(evaluatedLower,evaluatedUpper,t,parameters.colorSpace)}}}return interp(outputLower,outputUpper,t,parameters.colorSpace)}function evaluateIdentityFunction(parameters,propertySpec,input){switch(propertySpec.type){case"color":input=Color.parse(input);break;case"formatted":input=Formatted.fromString(input.toString());break;case"resolvedImage":input=ResolvedImage.fromString(input.toString());break;case"padding":input=Padding.parse(input);break;default:if(getType(input)!==propertySpec.type&&(propertySpec.type!=="enum"||!propertySpec.values[input])){input=undefined}}return coalesce$1(input,parameters.default,propertySpec.default)}function interpolationFactor(input,base,lowerValue,upperValue){const difference=upperValue-lowerValue;const progress=input-lowerValue;if(difference===0){return 0}else if(base===1){return progress/difference}else{return(Math.pow(base,progress)-1)/(Math.pow(base,difference)-1)}}class StyleExpression{constructor(expression,propertySpec){this.expression=expression;this._warningHistory={};this._evaluator=new EvaluationContext;this._defaultValue=propertySpec?getDefaultValue(propertySpec):null;this._enumValues=propertySpec&&propertySpec.type==="enum"?propertySpec.values:null}evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection){this._evaluator.globals=globals;this._evaluator.feature=feature;this._evaluator.featureState=featureState;this._evaluator.canonical=canonical;this._evaluator.availableImages=availableImages||null;this._evaluator.formattedSection=formattedSection;return this.expression.evaluate(this._evaluator)}evaluate(globals,feature,featureState,canonical,availableImages,formattedSection){this._evaluator.globals=globals;this._evaluator.feature=feature||null;this._evaluator.featureState=featureState||null;this._evaluator.canonical=canonical;this._evaluator.availableImages=availableImages||null;this._evaluator.formattedSection=formattedSection||null;try{const val=this.expression.evaluate(this._evaluator);if(val===null||val===undefined||typeof val==="number"&&val!==val){return this._defaultValue}if(this._enumValues&&!(val in this._enumValues)){throw new RuntimeError(`Expected value to be one of ${Object.keys(this._enumValues).map((v=>JSON.stringify(v))).join(", ")}, but found ${JSON.stringify(val)} instead.`)}return val}catch(e){if(!this._warningHistory[e.message]){this._warningHistory[e.message]=true;if(typeof console!=="undefined"){console.warn(e.message)}}return this._defaultValue}}}function isExpression(expression){return Array.isArray(expression)&&expression.length>0&&typeof expression[0]==="string"&&expression[0]in expressions$1}function createExpression(expression,propertySpec){const parser=new ParsingContext(expressions$1,isExpressionConstant,[],propertySpec?getExpectedType(propertySpec):undefined);const parsed=parser.parse(expression,undefined,undefined,undefined,propertySpec&&propertySpec.type==="string"?{typeAnnotation:"coerce"}:undefined);if(!parsed){return error(parser.errors)}return success(new StyleExpression(parsed,propertySpec))}class ZoomConstantExpression{constructor(kind,expression){this.kind=kind;this._styleExpression=expression;this.isStateDependent=kind!=="constant"&&!isStateConstant(expression.expression)}evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection){return this._styleExpression.evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection)}evaluate(globals,feature,featureState,canonical,availableImages,formattedSection){return this._styleExpression.evaluate(globals,feature,featureState,canonical,availableImages,formattedSection)}}class ZoomDependentExpression{constructor(kind,expression,zoomStops,interpolationType){this.kind=kind;this.zoomStops=zoomStops;this._styleExpression=expression;this.isStateDependent=kind!=="camera"&&!isStateConstant(expression.expression);this.interpolationType=interpolationType}evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection){return this._styleExpression.evaluateWithoutErrorHandling(globals,feature,featureState,canonical,availableImages,formattedSection)}evaluate(globals,feature,featureState,canonical,availableImages,formattedSection){return this._styleExpression.evaluate(globals,feature,featureState,canonical,availableImages,formattedSection)}interpolationFactor(input,lower,upper){if(this.interpolationType){return Interpolate.interpolationFactor(this.interpolationType,input,lower,upper)}else{return 0}}}function isZoomExpression(expression){return expression._styleExpression!==undefined}function createPropertyExpression(expressionInput,propertySpec){const expression=createExpression(expressionInput,propertySpec);if(expression.result==="error"){return expression}const parsed=expression.value.expression;const isFeatureConstantResult=isFeatureConstant(parsed);if(!isFeatureConstantResult&&!supportsPropertyExpression(propertySpec)){return error([new ExpressionParsingError("","data expressions not supported")])}const isZoomConstant=isGlobalPropertyConstant(parsed,["zoom"]);if(!isZoomConstant&&!supportsZoomExpression(propertySpec)){return error([new ExpressionParsingError("","zoom expressions not supported")])}const zoomCurve=findZoomCurve(parsed);if(!zoomCurve&&!isZoomConstant){return error([new ExpressionParsingError("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}else if(zoomCurve instanceof ExpressionParsingError){return error([zoomCurve])}else if(zoomCurve instanceof Interpolate&&!supportsInterpolation(propertySpec)){return error([new ExpressionParsingError("",'"interpolate" expressions cannot be used with this property')])}if(!zoomCurve){return success(isFeatureConstantResult?new ZoomConstantExpression("constant",expression.value):new ZoomConstantExpression("source",expression.value))}const interpolationType=zoomCurve instanceof Interpolate?zoomCurve.interpolation:undefined;return success(isFeatureConstantResult?new ZoomDependentExpression("camera",expression.value,zoomCurve.labels,interpolationType):new ZoomDependentExpression("composite",expression.value,zoomCurve.labels,interpolationType))}class StylePropertyFunction{constructor(parameters,specification){this._parameters=parameters;this._specification=specification;extendBy(this,createFunction(this._parameters,this._specification))}static deserialize(serialized){return new StylePropertyFunction(serialized._parameters,serialized._specification)}static serialize(input){return{_parameters:input._parameters,_specification:input._specification}}}function normalizePropertyExpression(value,specification){if(isFunction$1(value)){return new StylePropertyFunction(value,specification)}else if(isExpression(value)){const expression=createPropertyExpression(value,specification);if(expression.result==="error"){throw new Error(expression.value.map((err=>`${err.key}: ${err.message}`)).join(", "))}return expression.value}else{let constant=value;if(specification.type==="color"&&typeof value==="string"){constant=Color.parse(value)}else if(specification.type==="padding"&&(typeof value==="number"||Array.isArray(value))){constant=Padding.parse(value)}else if(specification.type==="variableAnchorOffsetCollection"&&Array.isArray(value)){constant=VariableAnchorOffsetCollection.parse(value)}return{kind:"constant",evaluate:()=>constant}}}function findZoomCurve(expression){let result=null;if(expression instanceof Let){result=findZoomCurve(expression.result)}else if(expression instanceof Coalesce){for(const arg of expression.args){result=findZoomCurve(arg);if(result){break}}}else if((expression instanceof Step||expression instanceof Interpolate)&&expression.input instanceof CompoundExpression&&expression.input.name==="zoom"){result=expression}if(result instanceof ExpressionParsingError){return result}expression.eachChild((child=>{const childResult=findZoomCurve(child);if(childResult instanceof ExpressionParsingError){result=childResult}else if(!result&&childResult){result=new ExpressionParsingError("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')}else if(result&&childResult&&result!==childResult){result=new ExpressionParsingError("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.')}}));return result}function getExpectedType(spec){const types={color:ColorType,string:StringType,number:NumberType,enum:StringType,boolean:BooleanType,formatted:FormattedType,padding:PaddingType,resolvedImage:ResolvedImageType,variableAnchorOffsetCollection:VariableAnchorOffsetCollectionType};if(spec.type==="array"){return array$1(types[spec.value]||ValueType,spec.length)}return types[spec.type]}function getDefaultValue(spec){if(spec.type==="color"&&isFunction$1(spec.default)){return new Color(0,0,0,0)}else if(spec.type==="color"){return Color.parse(spec.default)||null}else if(spec.type==="padding"){return Padding.parse(spec.default)||null}else if(spec.type==="variableAnchorOffsetCollection"){return VariableAnchorOffsetCollection.parse(spec.default)||null}else if(spec.default===undefined){return null}else{return spec.default}}function isExpressionFilter(filter){if(filter===true||filter===false){return true}if(!Array.isArray(filter)||filter.length===0){return false}switch(filter[0]){case"has":return filter.length>=2&&filter[1]!=="$id"&&filter[1]!=="$type";case"in":return filter.length>=3&&(typeof filter[1]!=="string"||Array.isArray(filter[2]));case"!in":case"!has":case"none":return false;case"==":case"!=":case">":case">=":case"<":case"<=":return filter.length!==3||(Array.isArray(filter[1])||Array.isArray(filter[2]));case"any":case"all":for(const f of filter.slice(1)){if(!isExpressionFilter(f)&&typeof f!=="boolean"){return false}}return true;default:return true}}const filterSpec={type:"boolean",default:false,transition:false,"property-type":"data-driven",expression:{interpolated:false,parameters:["zoom","feature"]}};function createFilter(filter){if(filter===null||filter===undefined){return{filter:()=>true,needGeometry:false}}if(!isExpressionFilter(filter)){filter=convertFilter$1(filter)}const compiled=createExpression(filter,filterSpec);if(compiled.result==="error"){throw new Error(compiled.value.map((err=>`${err.key}: ${err.message}`)).join(", "))}else{const needGeometry=geometryNeeded(filter);return{filter:(globalProperties,feature,canonical)=>compiled.value.evaluate(globalProperties,feature,{},canonical),needGeometry:needGeometry}}}function compare(a,b){return a<b?-1:a>b?1:0}function geometryNeeded(filter){if(!Array.isArray(filter))return false;if(filter[0]==="within")return true;for(let index=1;index<filter.length;index++){if(geometryNeeded(filter[index]))return true}return false}function convertFilter$1(filter){if(!filter)return true;const op=filter[0];if(filter.length<=1)return op!=="any";const converted=op==="=="?convertComparisonOp$1(filter[1],filter[2],"=="):op==="!="?convertNegation(convertComparisonOp$1(filter[1],filter[2],"==")):op==="<"||op===">"||op==="<="||op===">="?convertComparisonOp$1(filter[1],filter[2],op):op==="any"?convertDisjunctionOp(filter.slice(1)):op==="all"?["all"].concat(filter.slice(1).map(convertFilter$1)):op==="none"?["all"].concat(filter.slice(1).map(convertFilter$1).map(convertNegation)):op==="in"?convertInOp$1(filter[1],filter.slice(2)):op==="!in"?convertNegation(convertInOp$1(filter[1],filter.slice(2))):op==="has"?convertHasOp$1(filter[1]):op==="!has"?convertNegation(convertHasOp$1(filter[1])):op==="within"?filter:true;return converted}function convertComparisonOp$1(property,value,op){switch(property){case"$type":return[`filter-type-${op}`,value];case"$id":return[`filter-id-${op}`,value];default:return[`filter-${op}`,property,value]}}function convertDisjunctionOp(filters){return["any"].concat(filters.map(convertFilter$1))}function convertInOp$1(property,values){if(values.length===0){return false}switch(property){case"$type":return["filter-type-in",["literal",values]];case"$id":return["filter-id-in",["literal",values]];default:if(values.length>200&&!values.some((v=>typeof v!==typeof values[0]))){return["filter-in-large",property,["literal",values.sort(compare)]]}else{return["filter-in-small",property,["literal",values]]}}}function convertHasOp$1(property){switch(property){case"$type":return true;case"$id":return["filter-has-id"];default:return["filter-has",property]}}function convertNegation(filter){return["!",filter]}function convertFilter(filter,expectedTypes={}){if(isExpressionFilter(filter))return filter;if(!filter)return true;const legacyFilter=filter;const legacyOp=legacyFilter[0];if(filter.length<=1)return legacyOp!=="any";switch(legacyOp){case"==":case"!=":case"<":case">":case"<=":case">=":{const[,property,value]=filter;return convertComparisonOp(property,value,legacyOp,expectedTypes)}case"any":{const[,...conditions]=legacyFilter;const children=conditions.map((f=>{const types={};const child=convertFilter(f,types);const typechecks=runtimeTypeChecks(types);return typechecks===true?child:["case",typechecks,child,false]}));return["any",...children]}case"all":{const[,...conditions]=legacyFilter;const children=conditions.map((f=>convertFilter(f,expectedTypes)));return children.length>1?["all",...children]:children[0]}case"none":{const[,...conditions]=legacyFilter;return["!",convertFilter(["any",...conditions],{})]}case"in":{const[,property,...values]=legacyFilter;return convertInOp(property,values)}case"!in":{const[,property,...values]=legacyFilter;return convertInOp(property,values,true)}case"has":return convertHasOp(legacyFilter[1]);case"!has":return["!",convertHasOp(legacyFilter[1])];default:return true}}function runtimeTypeChecks(expectedTypes){const conditions=[];for(const property in expectedTypes){const get=property==="$id"?["id"]:["get",property];conditions.push(["==",["typeof",get],expectedTypes[property]])}if(conditions.length===0)return true;if(conditions.length===1)return conditions[0];return["all",...conditions]}function convertComparisonOp(property,value,op,expectedTypes){let get;if(property==="$type"){return[op,["geometry-type"],value]}else if(property==="$id"){get=["id"]}else{get=["get",property]}if(expectedTypes&&value!==null){const type=typeof value;expectedTypes[property]=type}if(op==="=="&&property!=="$id"&&value===null){return["all",["has",property],["==",get,null]]}else if(op==="!="&&property!=="$id"&&value===null){return["any",["!",["has",property]],["!=",get,null]]}return[op,get,value]}function convertInOp(property,values,negate=false){if(values.length===0)return negate;let get;if(property==="$type"){get=["geometry-type"]}else if(property==="$id"){get=["id"]}else{get=["get",property]}let uniformTypes=true;const type=typeof values[0];for(const value of values){if(typeof value!==type){uniformTypes=false;break}}if(uniformTypes&&(type==="string"||type==="number")){const uniqueValues=values.sort().filter(((v,i)=>i===0||values[i-1]!==v));return["match",get,uniqueValues,!negate,negate]}if(negate){return["all",...values.map((v=>["!=",get,v]))]}else{return["any",...values.map((v=>["==",get,v]))]}}function convertHasOp(property){if(property==="$type"){return true}else if(property==="$id"){return["!=",["id"],null]}else{return["has",property]}}function convertLiteral(value){return typeof value==="object"?["literal",value]:value}function convertFunction(parameters,propertySpec){let stops=parameters.stops;if(!stops){return convertIdentityFunction(parameters,propertySpec)}const zoomAndFeatureDependent=stops&&typeof stops[0][0]==="object";const featureDependent=zoomAndFeatureDependent||parameters.property!==undefined;const zoomDependent=zoomAndFeatureDependent||!featureDependent;stops=stops.map((stop=>{if(!featureDependent&&propertySpec.tokens&&typeof stop[1]==="string"){return[stop[0],convertTokenString(stop[1])]}return[stop[0],convertLiteral(stop[1])]}));if(zoomAndFeatureDependent){return convertZoomAndPropertyFunction(parameters,propertySpec,stops)}else if(zoomDependent){return convertZoomFunction(parameters,propertySpec,stops)}else{return convertPropertyFunction(parameters,propertySpec,stops)}}function convertIdentityFunction(parameters,propertySpec){const get=["get",parameters.property];if(parameters.default===undefined){return propertySpec.type==="string"?["string",get]:get}else if(propertySpec.type==="enum"){return["match",get,Object.keys(propertySpec.values),get,parameters.default]}else{const expression=[propertySpec.type==="color"?"to-color":propertySpec.type,get,convertLiteral(parameters.default)];if(propertySpec.type==="array"){expression.splice(1,0,propertySpec.value,propertySpec.length||null)}return expression}}function getInterpolateOperator(parameters){switch(parameters.colorSpace){case"hcl":return"interpolate-hcl";case"lab":return"interpolate-lab";default:return"interpolate"}}function convertZoomAndPropertyFunction(parameters,propertySpec,stops){const featureFunctionParameters={};const featureFunctionStops={};const zoomStops=[];for(let s=0;s<stops.length;s++){const stop=stops[s];const zoom=stop[0].zoom;if(featureFunctionParameters[zoom]===undefined){featureFunctionParameters[zoom]={zoom:zoom,type:parameters.type,property:parameters.property,default:parameters.default};featureFunctionStops[zoom]=[];zoomStops.push(zoom)}featureFunctionStops[zoom].push([stop[0].value,stop[1]])}const functionType=getFunctionType({},propertySpec);if(functionType==="exponential"){const expression=[getInterpolateOperator(parameters),["linear"],["zoom"]];for(const z of zoomStops){const output=convertPropertyFunction(featureFunctionParameters[z],propertySpec,featureFunctionStops[z]);appendStopPair(expression,z,output,false)}return expression}else{const expression=["step",["zoom"]];for(const z of zoomStops){const output=convertPropertyFunction(featureFunctionParameters[z],propertySpec,featureFunctionStops[z]);appendStopPair(expression,z,output,true)}fixupDegenerateStepCurve(expression);return expression}}function coalesce(a,b){if(a!==undefined)return a;if(b!==undefined)return b}function getFallback(parameters,propertySpec){const defaultValue=convertLiteral(coalesce(parameters.default,propertySpec.default));if(defaultValue===undefined&&propertySpec.type==="resolvedImage"){return""}return defaultValue}function convertPropertyFunction(parameters,propertySpec,stops){const type=getFunctionType(parameters,propertySpec);const get=["get",parameters.property];if(type==="categorical"&&typeof stops[0][0]==="boolean"){const expression=["case"];for(const stop of stops){expression.push(["==",get,stop[0]],stop[1])}expression.push(getFallback(parameters,propertySpec));return expression}else if(type==="categorical"){const expression=["match",get];for(const stop of stops){appendStopPair(expression,stop[0],stop[1],false)}expression.push(getFallback(parameters,propertySpec));return expression}else if(type==="interval"){const expression=["step",["number",get]];for(const stop of stops){appendStopPair(expression,stop[0],stop[1],true)}fixupDegenerateStepCurve(expression);return parameters.default===undefined?expression:["case",["==",["typeof",get],"number"],expression,convertLiteral(parameters.default)]}else if(type==="exponential"){const base=parameters.base!==undefined?parameters.base:1;const expression=[getInterpolateOperator(parameters),base===1?["linear"]:["exponential",base],["number",get]];for(const stop of stops){appendStopPair(expression,stop[0],stop[1],false)}return parameters.default===undefined?expression:["case",["==",["typeof",get],"number"],expression,convertLiteral(parameters.default)]}else{throw new Error(`Unknown property function type ${type}`)}}function convertZoomFunction(parameters,propertySpec,stops,input=["zoom"]){const type=getFunctionType(parameters,propertySpec);let expression;let isStep=false;if(type==="interval"){expression=["step",input];isStep=true}else if(type==="exponential"){const base=parameters.base!==undefined?parameters.base:1;expression=[getInterpolateOperator(parameters),base===1?["linear"]:["exponential",base],input]}else{throw new Error(`Unknown zoom function type "${type}"`)}for(const stop of stops){appendStopPair(expression,stop[0],stop[1],isStep)}fixupDegenerateStepCurve(expression);return expression}function fixupDegenerateStepCurve(expression){if(expression[0]==="step"&&expression.length===3){expression.push(0);expression.push(expression[3])}}function appendStopPair(curve,input,output,isStep){if(curve.length>3&&input===curve[curve.length-2]){return}if(!(isStep&&curve.length===2)){curve.push(input)}curve.push(output)}function getFunctionType(parameters,propertySpec){if(parameters.type){return parameters.type}else{return propertySpec.expression.interpolated?"exponential":"interval"}}function convertTokenString(s){const result=["concat"];const re=/{([^{}]+)}/g;let pos=0;for(let match=re.exec(s);match!==null;match=re.exec(s)){const literal=s.slice(pos,re.lastIndex-match[0].length);pos=re.lastIndex;if(literal.length>0)result.push(literal);result.push(["get",match[1]])}if(result.length===1){return s}if(pos<s.length){result.push(s.slice(pos))}else if(result.length===2){return["to-string",result[1]]}return result}function getPropertyReference(propertyName){for(let i=0;i<v8Spec.layout.length;i++){for(const key in v8Spec[v8Spec.layout[i]]){if(key===propertyName)return v8Spec[v8Spec.layout[i]][key]}}for(let i=0;i<v8Spec.paint.length;i++){for(const key in v8Spec[v8Spec.paint[i]]){if(key===propertyName)return v8Spec[v8Spec.paint[i]][key]}}return null}function eachSource(style,callback){for(const k in style.sources){callback(style.sources[k])}}function eachLayer(style,callback){for(const layer of style.layers){callback(layer)}}function eachProperty(style,options,callback){function inner(layer,propertyType){const properties=layer[propertyType];if(!properties)return;Object.keys(properties).forEach((key=>{callback({path:[layer.id,propertyType,key],key:key,value:properties[key],reference:getPropertyReference(key),set(x){properties[key]=x}})}))}eachLayer(style,(layer=>{if(options.paint){inner(layer,"paint")}if(options.layout){inner(layer,"layout")}}))}function stringify$1(obj){const type=typeof obj;if(type==="number"||type==="boolean"||type==="string"||obj===undefined||obj===null)return JSON.stringify(obj);if(Array.isArray(obj)){let str="[";for(const val of obj){str+=`${stringify$1(val)},`}return`${str}]`}const keys=Object.keys(obj).sort();let str="{";for(let i=0;i<keys.length;i++){str+=`${JSON.stringify(keys[i])}:${stringify$1(obj[keys[i]])},`}return`${str}}`}function getKey(layer){let key="";for(const k of refProperties){key+=`/${stringify$1(layer[k])}`}return key}function groupByLayout(layers,cachedKeys){const groups={};for(let i=0;i<layers.length;i++){const k=cachedKeys&&cachedKeys[layers[i].id]||getKey(layers[i]);if(cachedKeys)cachedKeys[layers[i].id]=k;let group=groups[k];if(!group){group=groups[k]=[]}group.push(layers[i])}const result=[];for(const k in groups){result.push(groups[k])}return result}function emptyStyle(){const style={};const version=v8Spec["$version"];for(const styleKey in v8Spec["$root"]){const spec=v8Spec["$root"][styleKey];if(spec.required){let value=null;if(styleKey==="version"){value=version}else{if(spec.type==="array"){value=[]}else{value={}}}if(value!=null){style[styleKey]=value}}}return style}function validateConstants(options){const key=options.key;const constants=options.value;if(constants){return[new ValidationError(key,constants,"constants have been deprecated as of v8")]}else{return[]}}function unbundle(value){if(value instanceof Number||value instanceof String||value instanceof Boolean){return value.valueOf()}else{return value}}function deepUnbundle(value){if(Array.isArray(value)){return value.map(deepUnbundle)}else if(value instanceof Object&&!(value instanceof Number||value instanceof String||value instanceof Boolean)){const unbundledValue={};for(const key in value){unbundledValue[key]=deepUnbundle(value[key])}return unbundledValue}return unbundle(value)}function validateObject(options){const key=options.key;const object=options.value;const elementSpecs=options.valueSpec||{};const elementValidators=options.objectElementValidators||{};const style=options.style;const styleSpec=options.styleSpec;const validateSpec=options.validateSpec;let errors=[];const type=getType(object);if(type!=="object"){return[new ValidationError(key,object,`object expected, ${type} found`)]}for(const objectKey in object){const elementSpecKey=objectKey.split(".")[0];const elementSpec=elementSpecs[elementSpecKey]||elementSpecs["*"];let validateElement;if(elementValidators[elementSpecKey]){validateElement=elementValidators[elementSpecKey]}else if(elementSpecs[elementSpecKey]){validateElement=validateSpec}else if(elementValidators["*"]){validateElement=elementValidators["*"]}else if(elementSpecs["*"]){validateElement=validateSpec}else{errors.push(new ValidationError(key,object[objectKey],`unknown property "${objectKey}"`));continue}errors=errors.concat(validateElement({key:(key?`${key}.`:key)+objectKey,value:object[objectKey],valueSpec:elementSpec,style:style,styleSpec:styleSpec,object:object,objectKey:objectKey,validateSpec:validateSpec},object))}for(const elementSpecKey in elementSpecs){if(elementValidators[elementSpecKey]){continue}if(elementSpecs[elementSpecKey].required&&elementSpecs[elementSpecKey]["default"]===undefined&&object[elementSpecKey]===undefined){errors.push(new ValidationError(key,object,`missing required property "${elementSpecKey}"`))}}return errors}function validateArray(options){const array=options.value;const arraySpec=options.valueSpec;const validateSpec=options.validateSpec;const style=options.style;const styleSpec=options.styleSpec;const key=options.key;const validateArrayElement=options.arrayElementValidator||validateSpec;if(getType(array)!=="array"){return[new ValidationError(key,array,`array expected, ${getType(array)} found`)]}if(arraySpec.length&&array.length!==arraySpec.length){return[new ValidationError(key,array,`array length ${arraySpec.length} expected, length ${array.length} found`)]}if(arraySpec["min-length"]&&array.length<arraySpec["min-length"]){return[new ValidationError(key,array,`array length at least ${arraySpec["min-length"]} expected, length ${array.length} found`)]}let arrayElementSpec={type:arraySpec.value,values:arraySpec.values};if(styleSpec.$version<7){arrayElementSpec["function"]=arraySpec.function}if(getType(arraySpec.value)==="object"){arrayElementSpec=arraySpec.value}let errors=[];for(let i=0;i<array.length;i++){errors=errors.concat(validateArrayElement({array:array,arrayIndex:i,value:array[i],valueSpec:arrayElementSpec,validateSpec:options.validateSpec,style:style,styleSpec:styleSpec,key:`${key}[${i}]`}))}return errors}function validateNumber(options){const key=options.key;const value=options.value;const valueSpec=options.valueSpec;let type=getType(value);if(type==="number"&&value!==value){type="NaN"}if(type!=="number"){return[new ValidationError(key,value,`number expected, ${type} found`)]}if("minimum"in valueSpec&&value<valueSpec.minimum){return[new ValidationError(key,value,`${value} is less than the minimum value ${valueSpec.minimum}`)]}if("maximum"in valueSpec&&value>valueSpec.maximum){return[new ValidationError(key,value,`${value} is greater than the maximum value ${valueSpec.maximum}`)]}return[]}function validateFunction(options){const functionValueSpec=options.valueSpec;const functionType=unbundle(options.value.type);let stopKeyType;let stopDomainValues={};let previousStopDomainValue;let previousStopDomainZoom;const isZoomFunction=functionType!=="categorical"&&options.value.property===undefined;const isPropertyFunction=!isZoomFunction;const isZoomAndPropertyFunction=getType(options.value.stops)==="array"&&getType(options.value.stops[0])==="array"&&getType(options.value.stops[0][0])==="object";const errors=validateObject({key:options.key,value:options.value,valueSpec:options.styleSpec.function,validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec,objectElementValidators:{stops:validateFunctionStops,default:validateFunctionDefault}});if(functionType==="identity"&&isZoomFunction){errors.push(new ValidationError(options.key,options.value,'missing required property "property"'))}if(functionType!=="identity"&&!options.value.stops){errors.push(new ValidationError(options.key,options.value,'missing required property "stops"'))}if(functionType==="exponential"&&options.valueSpec.expression&&!supportsInterpolation(options.valueSpec)){errors.push(new ValidationError(options.key,options.value,"exponential functions not supported"))}if(options.styleSpec.$version>=8){if(isPropertyFunction&&!supportsPropertyExpression(options.valueSpec)){errors.push(new ValidationError(options.key,options.value,"property functions not supported"))}else if(isZoomFunction&&!supportsZoomExpression(options.valueSpec)){errors.push(new ValidationError(options.key,options.value,"zoom functions not supported"))}}if((functionType==="categorical"||isZoomAndPropertyFunction)&&options.value.property===undefined){errors.push(new ValidationError(options.key,options.value,'"property" property is required'))}return errors;function validateFunctionStops(options){if(functionType==="identity"){return[new ValidationError(options.key,options.value,'identity function may not have a "stops" property')]}let errors=[];const value=options.value;errors=errors.concat(validateArray({key:options.key,value:value,valueSpec:options.valueSpec,validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec,arrayElementValidator:validateFunctionStop}));if(getType(value)==="array"&&value.length===0){errors.push(new ValidationError(options.key,value,"array must have at least one stop"))}return errors}function validateFunctionStop(options){let errors=[];const value=options.value;const key=options.key;if(getType(value)!=="array"){return[new ValidationError(key,value,`array expected, ${getType(value)} found`)]}if(value.length!==2){return[new ValidationError(key,value,`array length 2 expected, length ${value.length} found`)]}if(isZoomAndPropertyFunction){if(getType(value[0])!=="object"){return[new ValidationError(key,value,`object expected, ${getType(value[0])} found`)]}if(value[0].zoom===undefined){return[new ValidationError(key,value,"object stop key must have zoom")]}if(value[0].value===undefined){return[new ValidationError(key,value,"object stop key must have value")]}if(previousStopDomainZoom&&previousStopDomainZoom>unbundle(value[0].zoom)){return[new ValidationError(key,value[0].zoom,"stop zoom values must appear in ascending order")]}if(unbundle(value[0].zoom)!==previousStopDomainZoom){previousStopDomainZoom=unbundle(value[0].zoom);previousStopDomainValue=undefined;stopDomainValues={}}errors=errors.concat(validateObject({key:`${key}[0]`,value:value[0],valueSpec:{zoom:{}},validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec,objectElementValidators:{zoom:validateNumber,value:validateStopDomainValue}}))}else{errors=errors.concat(validateStopDomainValue({key:`${key}[0]`,value:value[0],valueSpec:{},validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec},value))}if(isExpression(deepUnbundle(value[1]))){return errors.concat([new ValidationError(`${key}[1]`,value[1],"expressions are not allowed in function stops.")])}return errors.concat(options.validateSpec({key:`${key}[1]`,value:value[1],valueSpec:functionValueSpec,validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec}))}function validateStopDomainValue(options,stop){const type=getType(options.value);const value=unbundle(options.value);const reportValue=options.value!==null?options.value:stop;if(!stopKeyType){stopKeyType=type}else if(type!==stopKeyType){return[new ValidationError(options.key,reportValue,`${type} stop domain type must match previous stop domain type ${stopKeyType}`)]}if(type!=="number"&&type!=="string"&&type!=="boolean"){return[new ValidationError(options.key,reportValue,"stop domain value must be a number, string, or boolean")]}if(type!=="number"&&functionType!=="categorical"){let message=`number expected, ${type} found`;if(supportsPropertyExpression(functionValueSpec)&&functionType===undefined){message+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'}return[new ValidationError(options.key,reportValue,message)]}if(functionType==="categorical"&&type==="number"&&(!isFinite(value)||Math.floor(value)!==value)){return[new ValidationError(options.key,reportValue,`integer expected, found ${value}`)]}if(functionType!=="categorical"&&type==="number"&&previousStopDomainValue!==undefined&&value<previousStopDomainValue){return[new ValidationError(options.key,reportValue,"stop domain values must appear in ascending order")]}else{previousStopDomainValue=value}if(functionType==="categorical"&&value in stopDomainValues){return[new ValidationError(options.key,reportValue,"stop domain values must be unique")]}else{stopDomainValues[value]=true}return[]}function validateFunctionDefault(options){return options.validateSpec({key:options.key,value:options.value,valueSpec:functionValueSpec,validateSpec:options.validateSpec,style:options.style,styleSpec:options.styleSpec})}}function validateExpression(options){const expression=(options.expressionContext==="property"?createPropertyExpression:createExpression)(deepUnbundle(options.value),options.valueSpec);if(expression.result==="error"){return expression.value.map((error=>new ValidationError(`${options.key}${error.key}`,options.value,error.message)))}const expressionObj=expression.value.expression||expression.value._styleExpression.expression;if(options.expressionContext==="property"&&options.propertyKey==="text-font"&&!expressionObj.outputDefined()){return[new ValidationError(options.key,options.value,`Invalid data expression for "${options.propertyKey}". Output values must be contained as literals within the expression.`)]}if(options.expressionContext==="property"&&options.propertyType==="layout"&&!isStateConstant(expressionObj)){return[new ValidationError(options.key,options.value,'"feature-state" data expressions are not supported with layout properties.')]}if(options.expressionContext==="filter"&&!isStateConstant(expressionObj)){return[new ValidationError(options.key,options.value,'"feature-state" data expressions are not supported with filters.')]}if(options.expressionContext&&options.expressionContext.indexOf("cluster")===0){if(!isGlobalPropertyConstant(expressionObj,["zoom","feature-state"])){return[new ValidationError(options.key,options.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')]}if(options.expressionContext==="cluster-initial"&&!isFeatureConstant(expressionObj)){return[new ValidationError(options.key,options.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}}return[]}function validateBoolean(options){const value=options.value;const key=options.key;const type=getType(value);if(type!=="boolean"){return[new ValidationError(key,value,`boolean expected, ${type} found`)]}return[]}function validateColor(options){const key=options.key;const value=options.value;const type=getType(value);if(type!=="string"){return[new ValidationError(key,value,`color expected, ${type} found`)]}if(!Color.parse(String(value))){return[new ValidationError(key,value,`color expected, "${value}" found`)]}return[]}function validateEnum(options){const key=options.key;const value=options.value;const valueSpec=options.valueSpec;const errors=[];if(Array.isArray(valueSpec.values)){if(valueSpec.values.indexOf(unbundle(value))===-1){errors.push(new ValidationError(key,value,`expected one of [${valueSpec.values.join(", ")}], ${JSON.stringify(value)} found`))}}else{if(Object.keys(valueSpec.values).indexOf(unbundle(value))===-1){errors.push(new ValidationError(key,value,`expected one of [${Object.keys(valueSpec.values).join(", ")}], ${JSON.stringify(value)} found`))}}return errors}function validateFilter$1(options){if(isExpressionFilter(deepUnbundle(options.value))){return validateExpression(extendBy({},options,{expressionContext:"filter",valueSpec:{value:"boolean"}}))}else{return validateNonExpressionFilter(options)}}function validateNonExpressionFilter(options){const value=options.value;const key=options.key;if(getType(value)!=="array"){return[new ValidationError(key,value,`array expected, ${getType(value)} found`)]}const styleSpec=options.styleSpec;let type;let errors=[];if(value.length<1){return[new ValidationError(key,value,"filter array must have at least 1 element")]}errors=errors.concat(validateEnum({key:`${key}[0]`,value:value[0],valueSpec:styleSpec.filter_operator,style:options.style,styleSpec:options.styleSpec}));switch(unbundle(value[0])){case"<":case"<=":case">":case">=":if(value.length>=2&&unbundle(value[1])==="$type"){errors.push(new ValidationError(key,value,`"$type" cannot be use with operator "${value[0]}"`))}case"==":case"!=":if(value.length!==3){errors.push(new ValidationError(key,value,`filter array for operator "${value[0]}" must have 3 elements`))}case"in":case"!in":if(value.length>=2){type=getType(value[1]);if(type!=="string"){errors.push(new ValidationError(`${key}[1]`,value[1],`string expected, ${type} found`))}}for(let i=2;i<value.length;i++){type=getType(value[i]);if(unbundle(value[1])==="$type"){errors=errors.concat(validateEnum({key:`${key}[${i}]`,value:value[i],valueSpec:styleSpec.geometry_type,style:options.style,styleSpec:options.styleSpec}))}else if(type!=="string"&&type!=="number"&&type!=="boolean"){errors.push(new ValidationError(`${key}[${i}]`,value[i],`string, number, or boolean expected, ${type} found`))}}break;case"any":case"all":case"none":for(let i=1;i<value.length;i++){errors=errors.concat(validateNonExpressionFilter({key:`${key}[${i}]`,value:value[i],style:options.style,styleSpec:options.styleSpec}))}break;case"has":case"!has":type=getType(value[1]);if(value.length!==2){errors.push(new ValidationError(key,value,`filter array for "${value[0]}" operator must have 2 elements`))}else if(type!=="string"){errors.push(new ValidationError(`${key}[1]`,value[1],`string expected, ${type} found`))}break;case"within":type=getType(value[1]);if(value.length!==2){errors.push(new ValidationError(key,value,`filter array for "${value[0]}" operator must have 2 elements`))}else if(type!=="object"){errors.push(new ValidationError(`${key}[1]`,value[1],`object expected, ${type} found`))}break}return errors}function validateProperty(options,propertyType){const key=options.key;const validateSpec=options.validateSpec;const style=options.style;const styleSpec=options.styleSpec;const value=options.value;const propertyKey=options.objectKey;const layerSpec=styleSpec[`${propertyType}_${options.layerType}`];if(!layerSpec)return[];const transitionMatch=propertyKey.match(/^(.*)-transition$/);if(propertyType==="paint"&&transitionMatch&&layerSpec[transitionMatch[1]]&&layerSpec[transitionMatch[1]].transition){return validateSpec({key:key,value:value,valueSpec:styleSpec.transition,style:style,styleSpec:styleSpec})}const valueSpec=options.valueSpec||layerSpec[propertyKey];if(!valueSpec){return[new ValidationError(key,value,`unknown property "${propertyKey}"`)]}let tokenMatch;if(getType(value)==="string"&&supportsPropertyExpression(valueSpec)&&!valueSpec.tokens&&(tokenMatch=/^{([^}]+)}$/.exec(value))){return[new ValidationError(key,value,`"${propertyKey}" does not support interpolation syntax\n`+`Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(tokenMatch[1])} }\`.`)]}const errors=[];if(options.layerType==="symbol"){if(propertyKey==="text-field"&&style&&!style.glyphs){errors.push(new ValidationError(key,value,'use of "text-field" requires a style "glyphs" property'))}if(propertyKey==="text-font"&&isFunction$1(deepUnbundle(value))&&unbundle(value.type)==="identity"){errors.push(new ValidationError(key,value,'"text-font" does not support identity functions'))}}return errors.concat(validateSpec({key:options.key,value:value,valueSpec:valueSpec,style:style,styleSpec:styleSpec,expressionContext:"property",propertyType:propertyType,propertyKey:propertyKey}))}function validatePaintProperty$1(options){return validateProperty(options,"paint")}function validateLayoutProperty$1(options){return validateProperty(options,"layout")}function validateLayer(options){let errors=[];const layer=options.value;const key=options.key;const style=options.style;const styleSpec=options.styleSpec;if(!layer.type&&!layer.ref){errors.push(new ValidationError(key,layer,'either "type" or "ref" is required'))}let type=unbundle(layer.type);const ref=unbundle(layer.ref);if(layer.id){const layerId=unbundle(layer.id);for(let i=0;i<options.arrayIndex;i++){const otherLayer=style.layers[i];if(unbundle(otherLayer.id)===layerId){errors.push(new ValidationError(key,layer.id,`duplicate layer id "${layer.id}", previously used at line ${otherLayer.id.__line__}`))}}}if("ref"in layer){["type","source","source-layer","filter","layout"].forEach((p=>{if(p in layer){errors.push(new ValidationError(key,layer[p],`"${p}" is prohibited for ref layers`))}}));let parent;style.layers.forEach((layer=>{if(unbundle(layer.id)===ref)parent=layer}));if(!parent){errors.push(new ValidationError(key,layer.ref,`ref layer "${ref}" not found`))}else if(parent.ref){errors.push(new ValidationError(key,layer.ref,"ref cannot reference another ref layer"))}else{type=unbundle(parent.type)}}else if(type!=="background"){if(!layer.source){errors.push(new ValidationError(key,layer,'missing required property "source"'))}else{const source=style.sources&&style.sources[layer.source];const sourceType=source&&unbundle(source.type);if(!source){errors.push(new ValidationError(key,layer.source,`source "${layer.source}" not found`))}else if(sourceType==="vector"&&type==="raster"){errors.push(new ValidationError(key,layer.source,`layer "${layer.id}" requires a raster source`))}else if(sourceType!=="raster-dem"&&type==="hillshade"){errors.push(new ValidationError(key,layer.source,`layer "${layer.id}" requires a raster-dem source`))}else if(sourceType==="raster"&&type!=="raster"){errors.push(new ValidationError(key,layer.source,`layer "${layer.id}" requires a vector source`))}else if(sourceType==="vector"&&!layer["source-layer"]){errors.push(new ValidationError(key,layer,`layer "${layer.id}" must specify a "source-layer"`))}else if(sourceType==="raster-dem"&&type!=="hillshade"){errors.push(new ValidationError(key,layer.source,"raster-dem source can only be used with layer type 'hillshade'."))}else if(type==="line"&&layer.paint&&layer.paint["line-gradient"]&&(sourceType!=="geojson"||!source.lineMetrics)){errors.push(new ValidationError(key,layer,`layer "${layer.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`))}}}errors=errors.concat(validateObject({key:key,value:layer,valueSpec:styleSpec.layer,style:options.style,styleSpec:options.styleSpec,validateSpec:options.validateSpec,objectElementValidators:{"*"(){return[]},type(){return options.validateSpec({key:`${key}.type`,value:layer.type,valueSpec:styleSpec.layer.type,style:options.style,styleSpec:options.styleSpec,validateSpec:options.validateSpec,object:layer,objectKey:"type"})},filter:validateFilter$1,layout(options){return validateObject({layer:layer,key:options.key,value:options.value,style:options.style,styleSpec:options.styleSpec,validateSpec:options.validateSpec,objectElementValidators:{"*"(options){return validateLayoutProperty$1(extendBy({layerType:type},options))}}})},paint(options){return validateObject({layer:layer,key:options.key,value:options.value,style:options.style,styleSpec:options.styleSpec,validateSpec:options.validateSpec,objectElementValidators:{"*"(options){return validatePaintProperty$1(extendBy({layerType:type},options))}}})}}}));return errors}function validateString(options){const value=options.value;const key=options.key;const type=getType(value);if(type!=="string"){return[new ValidationError(key,value,`string expected, ${type} found`)]}return[]}function validateRasterDEMSource(options){var _a;const sourceName=(_a=options.sourceName)!==null&&_a!==void 0?_a:"";const rasterDEM=options.value;const styleSpec=options.styleSpec;const rasterDEMSpec=styleSpec.source_raster_dem;const style=options.style;let errors=[];const rootType=getType(rasterDEM);if(rasterDEM===undefined){return errors}else if(rootType!=="object"){errors.push(new ValidationError("source_raster_dem",rasterDEM,`object expected, ${rootType} found`));return errors}const encoding=unbundle(rasterDEM.encoding);const isCustomEncoding=encoding==="custom";const customEncodingKeys=["redFactor","greenFactor","blueFactor","baseShift"];const encodingName=options.value.encoding?`"${options.value.encoding}"`:"Default";for(const key in rasterDEM){if(!isCustomEncoding&&customEncodingKeys.includes(key)){errors.push(new ValidationError(key,rasterDEM[key],`In "${sourceName}": "${key}" is only valid when "encoding" is set to "custom". ${encodingName} encoding found`))}else if(rasterDEMSpec[key]){errors=errors.concat(options.validateSpec({key:key,value:rasterDEM[key],valueSpec:rasterDEMSpec[key],validateSpec:options.validateSpec,style:style,styleSpec:styleSpec}))}else{errors.push(new ValidationError(key,rasterDEM[key],`unknown property "${key}"`))}}return errors}const objectElementValidators={promoteId:validatePromoteId};function validateSource$1(options){const value=options.value;const key=options.key;const styleSpec=options.styleSpec;const style=options.style;const validateSpec=options.validateSpec;if(!value.type){return[new ValidationError(key,value,'"type" is required')]}const type=unbundle(value.type);let errors;switch(type){case"vector":case"raster":errors=validateObject({key:key,value:value,valueSpec:styleSpec[`source_${type.replace("-","_")}`],style:options.style,styleSpec:styleSpec,objectElementValidators:objectElementValidators,validateSpec:validateSpec});return errors;case"raster-dem":errors=validateRasterDEMSource({sourceName:key,value:value,style:options.style,styleSpec:styleSpec,validateSpec:validateSpec});return errors;case"geojson":errors=validateObject({key:key,value:value,valueSpec:styleSpec.source_geojson,style:style,styleSpec:styleSpec,validateSpec:validateSpec,objectElementValidators:objectElementValidators});if(value.cluster){for(const prop in value.clusterProperties){const[operator,mapExpr]=value.clusterProperties[prop];const reduceExpr=typeof operator==="string"?[operator,["accumulated"],["get",prop]]:operator;errors.push(...validateExpression({key:`${key}.${prop}.map`,value:mapExpr,validateSpec:validateSpec,expressionContext:"cluster-map"}));errors.push(...validateExpression({key:`${key}.${prop}.reduce`,value:reduceExpr,validateSpec:validateSpec,expressionContext:"cluster-reduce"}))}}return errors;case"video":return validateObject({key:key,value:value,valueSpec:styleSpec.source_video,style:style,validateSpec:validateSpec,styleSpec:styleSpec});case"image":return validateObject({key:key,value:value,valueSpec:styleSpec.source_image,style:style,validateSpec:validateSpec,styleSpec:styleSpec});case"canvas":return[new ValidationError(key,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return validateEnum({key:`${key}.type`,value:value.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:style,validateSpec:validateSpec,styleSpec:styleSpec})}}function validatePromoteId({key:key,value:value}){if(getType(value)==="string"){return validateString({key:key,value:value})}else{const errors=[];for(const prop in value){errors.push(...validateString({key:`${key}.${prop}`,value:value[prop]}))}return errors}}function validateLight$1(options){const light=options.value;const styleSpec=options.styleSpec;const lightSpec=styleSpec.light;const style=options.style;let errors=[];const rootType=getType(light);if(light===undefined){return errors}else if(rootType!=="object"){errors=errors.concat([new ValidationError("light",light,`object expected, ${rootType} found`)]);return errors}for(const key in light){const transitionMatch=key.match(/^(.*)-transition$/);if(transitionMatch&&lightSpec[transitionMatch[1]]&&lightSpec[transitionMatch[1]].transition){errors=errors.concat(options.validateSpec({key:key,value:light[key],valueSpec:styleSpec.transition,validateSpec:options.validateSpec,style:style,styleSpec:styleSpec}))}else if(lightSpec[key]){errors=errors.concat(options.validateSpec({key:key,value:light[key],valueSpec:lightSpec[key],validateSpec:options.validateSpec,style:style,styleSpec:styleSpec}))}else{errors=errors.concat([new ValidationError(key,light[key],`unknown property "${key}"`)])}}return errors}function validateSky(options){const sky=options.value;const styleSpec=options.styleSpec;const skySpec=styleSpec.sky;const style=options.style;const rootType=getType(sky);if(sky===undefined){return[]}else if(rootType!=="object"){return[new ValidationError("sky",sky,`object expected, ${rootType} found`)]}let errors=[];for(const key in sky){if(skySpec[key]){errors=errors.concat(validate({key:key,value:sky[key],valueSpec:skySpec[key],style:style,styleSpec:styleSpec}))}else{errors=errors.concat([new ValidationError(key,sky[key],`unknown property "${key}"`)])}}return errors}function validateTerrain$1(options){const terrain=options.value;const styleSpec=options.styleSpec;const terrainSpec=styleSpec.terrain;const style=options.style;let errors=[];const rootType=getType(terrain);if(terrain===undefined){return errors}else if(rootType!=="object"){errors=errors.concat([new ValidationError("terrain",terrain,`object expected, ${rootType} found`)]);return errors}for(const key in terrain){if(terrainSpec[key]){errors=errors.concat(options.validateSpec({key:key,value:terrain[key],valueSpec:terrainSpec[key],validateSpec:options.validateSpec,style:style,styleSpec:styleSpec}))}else{errors=errors.concat([new ValidationError(key,terrain[key],`unknown property "${key}"`)])}}return errors}function validateFormatted(options){if(validateString(options).length===0){return[]}return validateExpression(options)}function validateImage(options){if(validateString(options).length===0){return[]}return validateExpression(options)}function validatePadding(options){const key=options.key;const value=options.value;const type=getType(value);if(type==="array"){if(value.length<1||value.length>4){return[new ValidationError(key,value,`padding requires 1 to 4 values; ${value.length} values found`)]}const arrayElementSpec={type:"number"};let errors=[];for(let i=0;i<value.length;i++){errors=errors.concat(options.validateSpec({key:`${key}[${i}]`,value:value[i],validateSpec:options.validateSpec,valueSpec:arrayElementSpec}))}return errors}else{return validateNumber({key:key,value:value,valueSpec:{}})}}function validateVariableAnchorOffsetCollection(options){const key=options.key;const value=options.value;const type=getType(value);const styleSpec=options.styleSpec;if(type!=="array"||value.length<1||value.length%2!==0){return[new ValidationError(key,value,"variableAnchorOffsetCollection requires a non-empty array of even length")]}let errors=[];for(let i=0;i<value.length;i+=2){errors=errors.concat(validateEnum({key:`${key}[${i}]`,value:value[i],valueSpec:styleSpec["layout_symbol"]["text-anchor"]}));errors=errors.concat(validateArray({key:`${key}[${i+1}]`,value:value[i+1],valueSpec:{length:2,value:"number"},validateSpec:options.validateSpec,style:options.style,styleSpec:styleSpec}))}return errors}function validateSprite(options){let errors=[];const sprite=options.value;const key=options.key;if(!Array.isArray(sprite)){return validateString({key:key,value:sprite})}else{const allSpriteIds=[];const allSpriteURLs=[];for(const i in sprite){if(sprite[i].id&&allSpriteIds.includes(sprite[i].id))errors.push(new ValidationError(key,sprite,`all the sprites' ids must be unique, but ${sprite[i].id} is duplicated`));allSpriteIds.push(sprite[i].id);if(sprite[i].url&&allSpriteURLs.includes(sprite[i].url))errors.push(new ValidationError(key,sprite,`all the sprites' URLs must be unique, but ${sprite[i].url} is duplicated`));allSpriteURLs.push(sprite[i].url);const pairSpec={id:{type:"string",required:true},url:{type:"string",required:true}};errors=errors.concat(validateObject({key:`${key}[${i}]`,value:sprite[i],valueSpec:pairSpec,validateSpec:options.validateSpec}))}return errors}}const VALIDATORS={"*"(){return[]},array:validateArray,boolean:validateBoolean,number:validateNumber,color:validateColor,constants:validateConstants,enum:validateEnum,filter:validateFilter$1,function:validateFunction,layer:validateLayer,object:validateObject,source:validateSource$1,light:validateLight$1,sky:validateSky,terrain:validateTerrain$1,string:validateString,formatted:validateFormatted,resolvedImage:validateImage,padding:validatePadding,variableAnchorOffsetCollection:validateVariableAnchorOffsetCollection,sprite:validateSprite};function validate(options){const value=options.value;const valueSpec=options.valueSpec;const styleSpec=options.styleSpec;options.validateSpec=validate;if(valueSpec.expression&&isFunction$1(unbundle(value))){return validateFunction(options)}else if(valueSpec.expression&&isExpression(deepUnbundle(value))){return validateExpression(options)}else if(valueSpec.type&&VALIDATORS[valueSpec.type]){return VALIDATORS[valueSpec.type](options)}else{const valid=validateObject(extendBy({},options,{valueSpec:valueSpec.type?styleSpec[valueSpec.type]:valueSpec}));return valid}}function validateGlyphsUrl(options){const value=options.value;const key=options.key;const errors=validateString(options);if(errors.length)return errors;if(value.indexOf("{fontstack}")===-1){errors.push(new ValidationError(key,value,'"glyphs" url must include a "{fontstack}" token'))}if(value.indexOf("{range}")===-1){errors.push(new ValidationError(key,value,'"glyphs" url must include a "{range}" token'))}return errors}function validateStyleMin(style,styleSpec=v8Spec){let errors=[];errors=errors.concat(validate({key:"",value:style,valueSpec:styleSpec.$root,styleSpec:styleSpec,style:style,validateSpec:validate,objectElementValidators:{glyphs:validateGlyphsUrl,"*"(){return[]}}}));if(style["constants"]){errors=errors.concat(validateConstants({key:"constants",value:style["constants"],style:style,styleSpec:styleSpec,validateSpec:validate}))}return sortErrors(errors)}validateStyleMin.source=wrapCleanErrors(injectValidateSpec(validateSource$1));validateStyleMin.sprite=wrapCleanErrors(injectValidateSpec(validateSprite));validateStyleMin.glyphs=wrapCleanErrors(injectValidateSpec(validateGlyphsUrl));validateStyleMin.light=wrapCleanErrors(injectValidateSpec(validateLight$1));validateStyleMin.sky=wrapCleanErrors(injectValidateSpec(validateSky));validateStyleMin.terrain=wrapCleanErrors(injectValidateSpec(validateTerrain$1));validateStyleMin.layer=wrapCleanErrors(injectValidateSpec(validateLayer));validateStyleMin.filter=wrapCleanErrors(injectValidateSpec(validateFilter$1));validateStyleMin.paintProperty=wrapCleanErrors(injectValidateSpec(validatePaintProperty$1));validateStyleMin.layoutProperty=wrapCleanErrors(injectValidateSpec(validateLayoutProperty$1));function injectValidateSpec(validator){return function(options){return validator({...options,validateSpec:validate})}}function sortErrors(errors){return[].concat(errors).sort(((a,b)=>a.line-b.line))}function wrapCleanErrors(inner){return function(...args){return sortErrors(inner.apply(this,args))}}const stringOrChar=/("(?:[^\\"]|\\.)*")|[:,]/g;function stringify(passedObj,options={}){const indent=JSON.stringify([1],undefined,options.indent===undefined?2:options.indent).slice(2,-3);const maxLength=indent===""?Infinity:options.maxLength===undefined?80:options.maxLength;let{replacer:replacer}=options;return function _stringify(obj,currentIndent,reserved){if(obj&&typeof obj.toJSON==="function"){obj=obj.toJSON()}const string=JSON.stringify(obj,replacer);if(string===undefined){return string}const length=maxLength-currentIndent.length-reserved;if(string.length<=length){const prettified=string.replace(stringOrChar,((match,stringLiteral)=>stringLiteral||`${match} `));if(prettified.length<=length){return prettified}}if(replacer!=null){obj=JSON.parse(string);replacer=undefined}if(typeof obj==="object"&&obj!==null){const nextIndent=currentIndent+indent;const items=[];let index=0;let start;let end;if(Array.isArray(obj)){start="[";end="]";const{length:length}=obj;for(;index<length;index++){items.push(_stringify(obj[index],nextIndent,index===length-1?0:1)||"null")}}else{start="{";end="}";const keys=Object.keys(obj);const{length:length}=keys;for(;index<length;index++){const key=keys[index];const keyPart=`${JSON.stringify(key)}: `;const value=_stringify(obj[key],nextIndent,keyPart.length+(index===length-1?0:1));if(value!==undefined){items.push(keyPart+value)}}}if(items.length>0){return[start,indent+items.join(`,\n${nextIndent}`),end].join(`\n${currentIndent}`)}}return string}(passedObj,"",0)}function sortKeysBy(obj,reference){const result={};for(const key in reference){if(obj[key]!==undefined){result[key]=obj[key]}}for(const key in obj){if(result[key]===undefined){result[key]=obj[key]}}return result}function format(style,space=2){style=sortKeysBy(style,v8Spec.$root);if(style.layers){style.layers=style.layers.map((layer=>sortKeysBy(layer,v8Spec.layer)))}return stringify(style,{indent:space})}function eachLayout(layer,callback){for(const k in layer){if(k.indexOf("layout")===0){callback(layer[k],k)}}}function eachPaint(layer,callback){for(const k in layer){if(k.indexOf("paint")===0){callback(layer[k],k)}}}function resolveConstant(style,value){if(typeof value==="string"&&value[0]==="@"){return resolveConstant(style,style.constants[value])}else{return value}}function isFunction(value){return Array.isArray(value.stops)}function renameProperty(obj,from,to){obj[to]=obj[from];delete obj[from]}function migrateV8(style){style.version=8;eachSource(style,(source=>{if(source.type==="video"&&source["url"]!==undefined){renameProperty(source,"url","urls")}if(source.type==="video"){source.coordinates.forEach((coord=>coord.reverse()))}}));eachLayer(style,(layer=>{eachLayout(layer,(layout=>{if(layout["symbol-min-distance"]!==undefined){renameProperty(layout,"symbol-min-distance","symbol-spacing")}}));eachPaint(layer,(paint=>{if(paint["background-image"]!==undefined){renameProperty(paint,"background-image","background-pattern")}if(paint["line-image"]!==undefined){renameProperty(paint,"line-image","line-pattern")}if(paint["fill-image"]!==undefined){renameProperty(paint,"fill-image","fill-pattern")}}))}));eachProperty(style,{paint:true,layout:true},(property=>{const value=resolveConstant(style,property.value);if(isFunction(value)){value.stops.forEach((stop=>{stop[1]=resolveConstant(style,stop[1])}))}property.set(value)}));delete style["constants"];eachLayer(style,(layer=>{eachLayout(layer,(layout=>{delete layout["text-max-size"];delete layout["icon-max-size"]}));eachPaint(layer,(paint=>{if(paint["text-size"]){if(!layer.layout)layer.layout={};layer.layout["text-size"]=paint["text-size"];delete paint["text-size"]}if(paint["icon-size"]){if(!layer.layout)layer.layout={};layer.layout["icon-size"]=paint["icon-size"];delete paint["icon-size"]}}))}));function migrateFontStack(font){function splitAndTrim(string){return string.split(",").map((s=>s.trim()))}if(Array.isArray(font)){return font}else if(typeof font==="string"){return splitAndTrim(font)}else if(typeof font==="object"){font.stops.forEach((stop=>{stop[1]=splitAndTrim(stop[1])}));return font}else{throw new Error("unexpected font value")}}eachLayer(style,(layer=>{eachLayout(layer,(layout=>{if(layout["text-font"]){layout["text-font"]=migrateFontStack(layout["text-font"])}}))}));let firstSymbolLayer=0;for(let i=style.layers.length-1;i>=0;i--){const layer=style.layers[i];if(layer.type!=="symbol"){firstSymbolLayer=i+1;break}}const symbolLayers=style.layers.splice(firstSymbolLayer);symbolLayers.reverse();style.layers=style.layers.concat(symbolLayers);return style}function expressions(style){const converted=[];eachLayer(style,(layer=>{if(layer.filter){layer.filter=convertFilter(layer.filter)}}));eachProperty(style,{paint:true,layout:true},(({path:path,value:value,reference:reference,set:set})=>{if(isExpression(value))return;if(typeof value==="object"&&!Array.isArray(value)){set(convertFunction(value,reference));converted.push(path.join("."))}else if(reference.tokens&&typeof value==="string"){set(convertTokenString(value))}}));return style}function migrateColors(colorToMigrate){return JSON.parse(migrateHslColors(JSON.stringify(colorToMigrate)))}function migrateHslColors(colorToMigrate){return colorToMigrate.replace(/"hsla?\((.+?)\)"/gi,((match,hslArgs)=>{const argsMatch=hslArgs.match(/^(.+?)\s*,\s*(.+?)\s*,\s*(.+?)(?:\s*,\s*(.+))?$/i);if(argsMatch){let[h,s,l,a]=argsMatch.slice(1);[s,l]=[s,l].map((v=>v.endsWith("%")?v:`${parseFloat(v)*100}%`));return`"hsl${typeof a==="string"?"a":""}(${[h,s,l,a].filter(Boolean).join(",")})"`}return match}))}function migrate(style){let migrated=false;if(style.version===7){style=migrateV8(style);migrated=true}if(style.version===8){migrated=!!expressions(style);migrated=true}eachProperty(style,{paint:true,layout:true},(({value:value,reference:reference,set:set})=>{if(reference.type==="color"){set(migrateColors(value))}}));if(!migrated){throw new Error(`Cannot migrate from ${style.version}`)}return style}const v8=v8Spec;const expression={StyleExpression:StyleExpression,StylePropertyFunction:StylePropertyFunction,ZoomConstantExpression:ZoomConstantExpression,ZoomDependentExpression:ZoomDependentExpression,createExpression:createExpression,createPropertyExpression:createPropertyExpression,isExpression:isExpression,isExpressionFilter:isExpressionFilter,isZoomExpression:isZoomExpression,normalizePropertyExpression:normalizePropertyExpression};const styleFunction={convertFunction:convertFunction,createFunction:createFunction,isFunction:isFunction$1};const visit={eachLayer:eachLayer,eachProperty:eachProperty,eachSource:eachSource};const validateStyle=validateStyleMin;const validateSource=validateStyle.source;const validateLight=validateStyle.light;const validateTerrain=validateStyle.terrain;const validateFilter=validateStyle.filter;const validatePaintProperty=validateStyle.paintProperty;const validateLayoutProperty=validateStyle.layoutProperty;function emitValidationErrors(emitter,errors){let hasErrors=false;if(errors&&errors.length){for(const error of errors){emitter.fire(new ErrorEvent(new Error(error.message)));hasErrors=true}}return hasErrors}const NUM_PARAMS=3;class TransferableGridIndex{constructor(extent,n,padding){const cells=this.cells=[];if(extent instanceof ArrayBuffer){this.arrayBuffer=extent;const array=new Int32Array(this.arrayBuffer);extent=array[0];n=array[1];padding=array[2];this.d=n+2*padding;for(let k=0;k<this.d*this.d;k++){const start=array[NUM_PARAMS+k];const end=array[NUM_PARAMS+k+1];cells.push(start===end?null:array.subarray(start,end))}const keysOffset=array[NUM_PARAMS+cells.length];const bboxesOffset=array[NUM_PARAMS+cells.length+1];this.keys=array.subarray(keysOffset,bboxesOffset);this.bboxes=array.subarray(bboxesOffset);this.insert=this._insertReadonly}else{this.d=n+2*padding;for(let i=0;i<this.d*this.d;i++){cells.push([])}this.keys=[];this.bboxes=[]}this.n=n;this.extent=extent;this.padding=padding;this.scale=n/extent;this.uid=0;const p=padding/n*extent;this.min=-p;this.max=extent+p}insert(key,x1,y1,x2,y2){this._forEachCell(x1,y1,x2,y2,this._insertCell,this.uid++,undefined,undefined);this.keys.push(key);this.bboxes.push(x1);this.bboxes.push(y1);this.bboxes.push(x2);this.bboxes.push(y2)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(x1,y1,x2,y2,cellIndex,uid){this.cells[cellIndex].push(uid)}query(x1,y1,x2,y2,intersectionTest){const min=this.min;const max=this.max;if(x1<=min&&y1<=min&&max<=x2&&max<=y2&&!intersectionTest){return Array.prototype.slice.call(this.keys)}else{const result=[];const seenUids={};this._forEachCell(x1,y1,x2,y2,this._queryCell,result,seenUids,intersectionTest);return result}}_queryCell(x1,y1,x2,y2,cellIndex,result,seenUids,intersectionTest){const cell=this.cells[cellIndex];if(cell!==null){const keys=this.keys;const bboxes=this.bboxes;for(let u=0;u<cell.length;u++){const uid=cell[u];if(seenUids[uid]===undefined){const offset=uid*4;if(intersectionTest?intersectionTest(bboxes[offset+0],bboxes[offset+1],bboxes[offset+2],bboxes[offset+3]):x1<=bboxes[offset+2]&&y1<=bboxes[offset+3]&&x2>=bboxes[offset+0]&&y2>=bboxes[offset+1]){seenUids[uid]=true;result.push(keys[uid])}else{seenUids[uid]=false}}}}}_forEachCell(x1,y1,x2,y2,fn,arg1,arg2,intersectionTest){const cx1=this._convertToCellCoord(x1);const cy1=this._convertToCellCoord(y1);const cx2=this._convertToCellCoord(x2);const cy2=this._convertToCellCoord(y2);for(let x=cx1;x<=cx2;x++){for(let y=cy1;y<=cy2;y++){const cellIndex=this.d*y+x;if(intersectionTest&&!intersectionTest(this._convertFromCellCoord(x),this._convertFromCellCoord(y),this._convertFromCellCoord(x+1),this._convertFromCellCoord(y+1)))continue;if(fn.call(this,x1,y1,x2,y2,cellIndex,arg1,arg2,intersectionTest))return}}}_convertFromCellCoord(x){return(x-this.padding)/this.scale}_convertToCellCoord(x){return Math.max(0,Math.min(this.d-1,Math.floor(x*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const cells=this.cells;const metadataLength=NUM_PARAMS+this.cells.length+1+1;let totalCellLength=0;for(let i=0;i<this.cells.length;i++){totalCellLength+=this.cells[i].length}const array=new Int32Array(metadataLength+totalCellLength+this.keys.length+this.bboxes.length);array[0]=this.extent;array[1]=this.n;array[2]=this.padding;let offset=metadataLength;for(let k=0;k<cells.length;k++){const cell=cells[k];array[NUM_PARAMS+k]=offset;array.set(cell,offset);offset+=cell.length}array[NUM_PARAMS+cells.length]=offset;array.set(this.keys,offset);offset+=this.keys.length;array[NUM_PARAMS+cells.length+1]=offset;array.set(this.bboxes,offset);offset+=this.bboxes.length;return array.buffer}static serialize(grid,transferables){const buffer=grid.toArrayBuffer();if(transferables){transferables.push(buffer)}return{buffer:buffer}}static deserialize(serialized){return new TransferableGridIndex(serialized.buffer)}}const registry={};function register(name,klass,options={}){if(registry[name])throw new Error(`${name} is already registered.`);Object.defineProperty(klass,"_classRegistryKey",{value:name,writeable:false});registry[name]={klass:klass,omit:options.omit||[],shallow:options.shallow||[]}}register("Object",Object);register("TransferableGridIndex",TransferableGridIndex);register("Color",Color);register("Error",Error);register("AJAXError",AJAXError);register("ResolvedImage",ResolvedImage);register("StylePropertyFunction",StylePropertyFunction);register("StyleExpression",StyleExpression,{omit:["_evaluator"]});register("ZoomDependentExpression",ZoomDependentExpression);register("ZoomConstantExpression",ZoomConstantExpression);register("CompoundExpression",CompoundExpression,{omit:["_evaluate"]});for(const name in expressions$1){if(expressions$1[name]._classRegistryKey)continue;register(`Expression_${name}`,expressions$1[name])}function isArrayBuffer(value){return value&&typeof ArrayBuffer!=="undefined"&&(value instanceof ArrayBuffer||value.constructor&&value.constructor.name==="ArrayBuffer")}function serialize(input,transferables){if(input===null||input===undefined||typeof input==="boolean"||typeof input==="number"||typeof input==="string"||input instanceof Boolean||input instanceof Number||input instanceof String||input instanceof Date||input instanceof RegExp||input instanceof Blob||input instanceof Error){return input}if(isArrayBuffer(input)){if(transferables){transferables.push(input)}return input}if(isImageBitmap(input)){if(transferables){transferables.push(input)}return input}if(ArrayBuffer.isView(input)){const view=input;if(transferables){transferables.push(view.buffer)}return view}if(input instanceof ImageData){if(transferables){transferables.push(input.data.buffer)}return input}if(Array.isArray(input)){const serialized=[];for(const item of input){serialized.push(serialize(item,transferables))}return serialized}if(typeof input==="object"){const klass=input.constructor;const name=klass._classRegistryKey;if(!name){throw new Error(`can't serialize object of unregistered class ${klass.name}`)}if(!registry[name])throw new Error(`${name} is not registered.`);const properties=klass.serialize?klass.serialize(input,transferables):{};if(!klass.serialize){for(const key in input){if(!input.hasOwnProperty(key))continue;if(registry[name].omit.indexOf(key)>=0)continue;const property=input[key];properties[key]=registry[name].shallow.indexOf(key)>=0?property:serialize(property,transferables)}if(input instanceof Error){properties.message=input.message}}else{if(transferables&&properties===transferables[transferables.length-1]){throw new Error("statically serialized object won't survive transfer of $name property")}}if(properties.$name){throw new Error("$name property is reserved for worker serialization logic.")}if(name!=="Object"){properties.$name=name}return properties}throw new Error(`can't serialize object of type ${typeof input}`)}function deserialize(input){if(input===null||input===undefined||typeof input==="boolean"||typeof input==="number"||typeof input==="string"||input instanceof Boolean||input instanceof Number||input instanceof String||input instanceof Date||input instanceof RegExp||input instanceof Blob||input instanceof Error||isArrayBuffer(input)||isImageBitmap(input)||ArrayBuffer.isView(input)||input instanceof ImageData){return input}if(Array.isArray(input)){return input.map(deserialize)}if(typeof input==="object"){const name=input.$name||"Object";if(!registry[name]){throw new Error(`can't deserialize unregistered class ${name}`)}const{klass:klass}=registry[name];if(!klass){throw new Error(`can't deserialize unregistered class ${name}`)}if(klass.deserialize){return klass.deserialize(input)}const result=Object.create(klass.prototype);for(const key of Object.keys(input)){if(key==="$name")continue;const value=input[key];result[key]=registry[name].shallow.indexOf(key)>=0?value:deserialize(value)}return result}throw new Error(`can't deserialize object of type ${typeof input}`)}class ZoomHistory{constructor(){this.first=true}update(z,now){const floorZ=Math.floor(z);if(this.first){this.first=false;this.lastIntegerZoom=floorZ;this.lastIntegerZoomTime=0;this.lastZoom=z;this.lastFloorZoom=floorZ;return true}if(this.lastFloorZoom>floorZ){this.lastIntegerZoom=floorZ+1;this.lastIntegerZoomTime=now}else if(this.lastFloorZoom<floorZ){this.lastIntegerZoom=floorZ;this.lastIntegerZoomTime=now}if(z!==this.lastZoom){this.lastZoom=z;this.lastFloorZoom=floorZ;return true}return false}}const unicodeBlockLookup={"Latin-1 Supplement":char=>char>=128&&char<=255,Arabic:char=>char>=1536&&char<=1791,"Arabic Supplement":char=>char>=1872&&char<=1919,"Arabic Extended-A":char=>char>=2208&&char<=2303,"Hangul Jamo":char=>char>=4352&&char<=4607,"Unified Canadian Aboriginal Syllabics":char=>char>=5120&&char<=5759,Khmer:char=>char>=6016&&char<=6143,"Unified Canadian Aboriginal Syllabics Extended":char=>char>=6320&&char<=6399,"General Punctuation":char=>char>=8192&&char<=8303,"Letterlike Symbols":char=>char>=8448&&char<=8527,"Number Forms":char=>char>=8528&&char<=8591,"Miscellaneous Technical":char=>char>=8960&&char<=9215,"Control Pictures":char=>char>=9216&&char<=9279,"Optical Character Recognition":char=>char>=9280&&char<=9311,"Enclosed Alphanumerics":char=>char>=9312&&char<=9471,"Geometric Shapes":char=>char>=9632&&char<=9727,"Miscellaneous Symbols":char=>char>=9728&&char<=9983,"Miscellaneous Symbols and Arrows":char=>char>=11008&&char<=11263,"CJK Radicals Supplement":char=>char>=11904&&char<=12031,"Kangxi Radicals":char=>char>=12032&&char<=12255,"Ideographic Description Characters":char=>char>=12272&&char<=12287,"CJK Symbols and Punctuation":char=>char>=12288&&char<=12351,Hiragana:char=>char>=12352&&char<=12447,Katakana:char=>char>=12448&&char<=12543,Bopomofo:char=>char>=12544&&char<=12591,"Hangul Compatibility Jamo":char=>char>=12592&&char<=12687,Kanbun:char=>char>=12688&&char<=12703,"Bopomofo Extended":char=>char>=12704&&char<=12735,"CJK Strokes":char=>char>=12736&&char<=12783,"Katakana Phonetic Extensions":char=>char>=12784&&char<=12799,"Enclosed CJK Letters and Months":char=>char>=12800&&char<=13055,"CJK Compatibility":char=>char>=13056&&char<=13311,"CJK Unified Ideographs Extension A":char=>char>=13312&&char<=19903,"Yijing Hexagram Symbols":char=>char>=19904&&char<=19967,"CJK Unified Ideographs":char=>char>=19968&&char<=40959,"Yi Syllables":char=>char>=40960&&char<=42127,"Yi Radicals":char=>char>=42128&&char<=42191,"Hangul Jamo Extended-A":char=>char>=43360&&char<=43391,"Hangul Syllables":char=>char>=44032&&char<=55215,"Hangul Jamo Extended-B":char=>char>=55216&&char<=55295,"Private Use Area":char=>char>=57344&&char<=63743,"CJK Compatibility Ideographs":char=>char>=63744&&char<=64255,"Arabic Presentation Forms-A":char=>char>=64336&&char<=65023,"Vertical Forms":char=>char>=65040&&char<=65055,"CJK Compatibility Forms":char=>char>=65072&&char<=65103,"Small Form Variants":char=>char>=65104&&char<=65135,"Arabic Presentation Forms-B":char=>char>=65136&&char<=65279,"Halfwidth and Fullwidth Forms":char=>char>=65280&&char<=65519};function allowsIdeographicBreaking(chars){for(const char of chars){if(!charAllowsIdeographicBreaking(char.charCodeAt(0)))return false}return true}function allowsVerticalWritingMode(chars){for(const char of chars){if(charHasUprightVerticalOrientation(char.charCodeAt(0)))return true}return false}function allowsLetterSpacing(chars){for(const char of chars){if(!charAllowsLetterSpacing(char.charCodeAt(0)))return false}return true}function charAllowsLetterSpacing(char){if(unicodeBlockLookup["Arabic"](char))return false;if(unicodeBlockLookup["Arabic Supplement"](char))return false;if(unicodeBlockLookup["Arabic Extended-A"](char))return false;if(unicodeBlockLookup["Arabic Presentation Forms-A"](char))return false;if(unicodeBlockLookup["Arabic Presentation Forms-B"](char))return false;return true}function charAllowsIdeographicBreaking(char){if(char<11904)return false;if(unicodeBlockLookup["Bopomofo Extended"](char))return true;if(unicodeBlockLookup["Bopomofo"](char))return true;if(unicodeBlockLookup["CJK Compatibility Forms"](char))return true;if(unicodeBlockLookup["CJK Compatibility Ideographs"](char))return true;if(unicodeBlockLookup["CJK Compatibility"](char))return true;if(unicodeBlockLookup["CJK Radicals Supplement"](char))return true;if(unicodeBlockLookup["CJK Strokes"](char))return true;if(unicodeBlockLookup["CJK Symbols and Punctuation"](char))return true;if(unicodeBlockLookup["CJK Unified Ideographs Extension A"](char))return true;if(unicodeBlockLookup["CJK Unified Ideographs"](char))return true;if(unicodeBlockLookup["Enclosed CJK Letters and Months"](char))return true;if(unicodeBlockLookup["Halfwidth and Fullwidth Forms"](char))return true;if(unicodeBlockLookup["Hiragana"](char))return true;if(unicodeBlockLookup["Ideographic Description Characters"](char))return true;if(unicodeBlockLookup["Kangxi Radicals"](char))return true;if(unicodeBlockLookup["Katakana Phonetic Extensions"](char))return true;if(unicodeBlockLookup["Katakana"](char))return true;if(unicodeBlockLookup["Vertical Forms"](char))return true;if(unicodeBlockLookup["Yi Radicals"](char))return true;if(unicodeBlockLookup["Yi Syllables"](char))return true;return false}function charHasUprightVerticalOrientation(char){if(char===746||char===747){return true}if(char<4352)return false;if(unicodeBlockLookup["Bopomofo Extended"](char))return true;if(unicodeBlockLookup["Bopomofo"](char))return true;if(unicodeBlockLookup["CJK Compatibility Forms"](char)){if(!(char>=65097&&char<=65103)){return true}}if(unicodeBlockLookup["CJK Compatibility Ideographs"](char))return true;if(unicodeBlockLookup["CJK Compatibility"](char))return true;if(unicodeBlockLookup["CJK Radicals Supplement"](char))return true;if(unicodeBlockLookup["CJK Strokes"](char))return true;if(unicodeBlockLookup["CJK Symbols and Punctuation"](char)){if(!(char>=12296&&char<=12305)&&!(char>=12308&&char<=12319)&&char!==12336){return true}}if(unicodeBlockLookup["CJK Unified Ideographs Extension A"](char))return true;if(unicodeBlockLookup["CJK Unified Ideographs"](char))return true;if(unicodeBlockLookup["Enclosed CJK Letters and Months"](char))return true;if(unicodeBlockLookup["Hangul Compatibility Jamo"](char))return true;if(unicodeBlockLookup["Hangul Jamo Extended-A"](char))return true;if(unicodeBlockLookup["Hangul Jamo Extended-B"](char))return true;if(unicodeBlockLookup["Hangul Jamo"](char))return true;if(unicodeBlockLookup["Hangul Syllables"](char))return true;if(unicodeBlockLookup["Hiragana"](char))return true;if(unicodeBlockLookup["Ideographic Description Characters"](char))return true;if(unicodeBlockLookup["Kanbun"](char))return true;if(unicodeBlockLookup["Kangxi Radicals"](char))return true;if(unicodeBlockLookup["Katakana Phonetic Extensions"](char))return true;if(unicodeBlockLookup["Katakana"](char)){if(char!==12540){return true}}if(unicodeBlockLookup["Halfwidth and Fullwidth Forms"](char)){if(char!==65288&&char!==65289&&char!==65293&&!(char>=65306&&char<=65310)&&char!==65339&&char!==65341&&char!==65343&&!(char>=65371&&char<=65503)&&char!==65507&&!(char>=65512&&char<=65519)){return true}}if(unicodeBlockLookup["Small Form Variants"](char)){if(!(char>=65112&&char<=65118)&&!(char>=65123&&char<=65126)){return true}}if(unicodeBlockLookup["Unified Canadian Aboriginal Syllabics"](char))return true;if(unicodeBlockLookup["Unified Canadian Aboriginal Syllabics Extended"](char))return true;if(unicodeBlockLookup["Vertical Forms"](char))return true;if(unicodeBlockLookup["Yijing Hexagram Symbols"](char))return true;if(unicodeBlockLookup["Yi Syllables"](char))return true;if(unicodeBlockLookup["Yi Radicals"](char))return true;return false}function charHasNeutralVerticalOrientation(char){if(unicodeBlockLookup["Latin-1 Supplement"](char)){if(char===167||char===169||char===174||char===177||char===188||char===189||char===190||char===215||char===247){return true}}if(unicodeBlockLookup["General Punctuation"](char)){if(char===8214||char===8224||char===8225||char===8240||char===8241||char===8251||char===8252||char===8258||char===8263||char===8264||char===8265||char===8273){return true}}if(unicodeBlockLookup["Letterlike Symbols"](char))return true;if(unicodeBlockLookup["Number Forms"](char))return true;if(unicodeBlockLookup["Miscellaneous Technical"](char)){if(char>=8960&&char<=8967||char>=8972&&char<=8991||char>=8996&&char<=9e3||char===9003||char>=9085&&char<=9114||char>=9150&&char<=9165||char===9167||char>=9169&&char<=9179||char>=9186&&char<=9215){return true}}if(unicodeBlockLookup["Control Pictures"](char)&&char!==9251)return true;if(unicodeBlockLookup["Optical Character Recognition"](char))return true;if(unicodeBlockLookup["Enclosed Alphanumerics"](char))return true;if(unicodeBlockLookup["Geometric Shapes"](char))return true;if(unicodeBlockLookup["Miscellaneous Symbols"](char)){if(!(char>=9754&&char<=9759)){return true}}if(unicodeBlockLookup["Miscellaneous Symbols and Arrows"](char)){if(char>=11026&&char<=11055||char>=11088&&char<=11097||char>=11192&&char<=11243){return true}}if(unicodeBlockLookup["CJK Symbols and Punctuation"](char))return true;if(unicodeBlockLookup["Katakana"](char))return true;if(unicodeBlockLookup["Private Use Area"](char))return true;if(unicodeBlockLookup["CJK Compatibility Forms"](char))return true;if(unicodeBlockLookup["Small Form Variants"](char))return true;if(unicodeBlockLookup["Halfwidth and Fullwidth Forms"](char))return true;if(char===8734||char===8756||char===8757||char>=9984&&char<=10087||char>=10102&&char<=10131||char===65532||char===65533){return true}return false}function charHasRotatedVerticalOrientation(char){return!(charHasUprightVerticalOrientation(char)||charHasNeutralVerticalOrientation(char))}function charInComplexShapingScript(char){return unicodeBlockLookup["Arabic"](char)||unicodeBlockLookup["Arabic Supplement"](char)||unicodeBlockLookup["Arabic Extended-A"](char)||unicodeBlockLookup["Arabic Presentation Forms-A"](char)||unicodeBlockLookup["Arabic Presentation Forms-B"](char)}function charInRTLScript(char){return char>=1424&&char<=2303||unicodeBlockLookup["Arabic Presentation Forms-A"](char)||unicodeBlockLookup["Arabic Presentation Forms-B"](char)}function charInSupportedScript(char,canRenderRTL){if(!canRenderRTL&&charInRTLScript(char)){return false}if(char>=2304&&char<=3583||char>=3840&&char<=4255||unicodeBlockLookup["Khmer"](char)){return false}return true}function stringContainsRTLText(chars){for(const char of chars){if(charInRTLScript(char.charCodeAt(0))){return true}}return false}function isStringInSupportedScript(chars,canRenderRTL){for(const char of chars){if(!charInSupportedScript(char.charCodeAt(0),canRenderRTL)){return false}}return true}class RTLWorkerPlugin{constructor(){this.applyArabicShaping=null;this.processBidirectionalText=null;this.processStyledBidirectionalText=null;this.pluginStatus="unavailable";this.pluginURL=null}setState(state){this.pluginStatus=state.pluginStatus;this.pluginURL=state.pluginURL}setMethods(rtlTextPlugin){this.applyArabicShaping=rtlTextPlugin.applyArabicShaping;this.processBidirectionalText=rtlTextPlugin.processBidirectionalText;this.processStyledBidirectionalText=rtlTextPlugin.processStyledBidirectionalText}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getPluginURL(){return this.pluginURL}getRTLTextPluginStatus(){return this.pluginStatus}}const rtlWorkerPlugin=new RTLWorkerPlugin;class EvaluationParameters{constructor(zoom,options){this.zoom=zoom;if(options){this.now=options.now;this.fadeDuration=options.fadeDuration;this.zoomHistory=options.zoomHistory;this.transition=options.transition}else{this.now=0;this.fadeDuration=0;this.zoomHistory=new ZoomHistory;this.transition={}}}isSupportedScript(str){return isStringInSupportedScript(str,rtlWorkerPlugin.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){if(this.fadeDuration===0){return 1}else{return Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}}getCrossfadeParameters(){const z=this.zoom;const fraction=z-Math.floor(z);const t=this.crossFadingFactor();return z>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:fraction+(1-fraction)*t}:{fromScale:.5,toScale:1,t:1-(1-t)*fraction}}}class PropertyValue{constructor(property,value){this.property=property;this.value=value;this.expression=normalizePropertyExpression(value===undefined?property.specification.default:value,property.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(parameters,canonical,availableImages){return this.property.possiblyEvaluate(this,parameters,canonical,availableImages)}}class TransitionablePropertyValue{constructor(property){this.property=property;this.value=new PropertyValue(property,undefined)}transitioned(parameters,prior){return new TransitioningPropertyValue(this.property,this.value,prior,extend({},parameters.transition,this.transition),parameters.now)}untransitioned(){return new TransitioningPropertyValue(this.property,this.value,null,{},0)}}class Transitionable{constructor(properties){this._properties=properties;this._values=Object.create(properties.defaultTransitionablePropertyValues)}getValue(name){return clone$9(this._values[name].value.value)}setValue(name,value){if(!Object.prototype.hasOwnProperty.call(this._values,name)){this._values[name]=new TransitionablePropertyValue(this._values[name].property)}this._values[name].value=new PropertyValue(this._values[name].property,value===null?undefined:clone$9(value))}getTransition(name){return clone$9(this._values[name].transition)}setTransition(name,value){if(!Object.prototype.hasOwnProperty.call(this._values,name)){this._values[name]=new TransitionablePropertyValue(this._values[name].property)}this._values[name].transition=clone$9(value)||undefined}serialize(){const result={};for(const property of Object.keys(this._values)){const value=this.getValue(property);if(value!==undefined){result[property]=value}const transition=this.getTransition(property);if(transition!==undefined){result[`${property}-transition`]=transition}}return result}transitioned(parameters,prior){const result=new Transitioning(this._properties);for(const property of Object.keys(this._values)){result._values[property]=this._values[property].transitioned(parameters,prior._values[property])}return result}untransitioned(){const result=new Transitioning(this._properties);for(const property of Object.keys(this._values)){result._values[property]=this._values[property].untransitioned()}return result}}class TransitioningPropertyValue{constructor(property,value,prior,transition,now){this.property=property;this.value=value;this.begin=now+transition.delay||0;this.end=this.begin+transition.duration||0;if(property.specification.transition&&(transition.delay||transition.duration)){this.prior=prior}}possiblyEvaluate(parameters,canonical,availableImages){const now=parameters.now||0;const finalValue=this.value.possiblyEvaluate(parameters,canonical,availableImages);const prior=this.prior;if(!prior){return finalValue}else if(now>this.end){this.prior=null;return finalValue}else if(this.value.isDataDriven()){this.prior=null;return finalValue}else if(now<this.begin){return prior.possiblyEvaluate(parameters,canonical,availableImages)}else{const t=(now-this.begin)/(this.end-this.begin);return this.property.interpolate(prior.possiblyEvaluate(parameters,canonical,availableImages),finalValue,easeCubicInOut(t))}}}class Transitioning{constructor(properties){this._properties=properties;this._values=Object.create(properties.defaultTransitioningPropertyValues)}possiblyEvaluate(parameters,canonical,availableImages){const result=new PossiblyEvaluated(this._properties);for(const property of Object.keys(this._values)){result._values[property]=this._values[property].possiblyEvaluate(parameters,canonical,availableImages)}return result}hasTransition(){for(const property of Object.keys(this._values)){if(this._values[property].prior){return true}}return false}}class Layout{constructor(properties){this._properties=properties;this._values=Object.create(properties.defaultPropertyValues)}hasValue(name){return this._values[name].value!==undefined}getValue(name){return clone$9(this._values[name].value)}setValue(name,value){this._values[name]=new PropertyValue(this._values[name].property,value===null?undefined:clone$9(value))}serialize(){const result={};for(const property of Object.keys(this._values)){const value=this.getValue(property);if(value!==undefined){result[property]=value}}return result}possiblyEvaluate(parameters,canonical,availableImages){const result=new PossiblyEvaluated(this._properties);for(const property of Object.keys(this._values)){result._values[property]=this._values[property].possiblyEvaluate(parameters,canonical,availableImages)}return result}}class PossiblyEvaluatedPropertyValue{constructor(property,value,parameters){this.property=property;this.value=value;this.parameters=parameters}isConstant(){return this.value.kind==="constant"}constantOr(value){if(this.value.kind==="constant"){return this.value.value}else{return value}}evaluate(feature,featureState,canonical,availableImages){return this.property.evaluate(this.value,this.parameters,feature,featureState,canonical,availableImages)}}class PossiblyEvaluated{constructor(properties){this._properties=properties;this._values=Object.create(properties.defaultPossiblyEvaluatedValues)}get(name){return this._values[name]}}class DataConstantProperty{constructor(specification){this.specification=specification}possiblyEvaluate(value,parameters){if(value.isDataDriven())throw new Error("Value should not be data driven");return value.expression.evaluate(parameters)}interpolate(a,b,t){const interpolationType=this.specification.type;const interpolationFn=interpolate[interpolationType];if(interpolationFn){return interpolationFn(a,b,t)}else{return a}}}class DataDrivenProperty{constructor(specification,overrides){this.specification=specification;this.overrides=overrides}possiblyEvaluate(value,parameters,canonical,availableImages){if(value.expression.kind==="constant"||value.expression.kind==="camera"){return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:value.expression.evaluate(parameters,null,{},canonical,availableImages)},parameters)}else{return new PossiblyEvaluatedPropertyValue(this,value.expression,parameters)}}interpolate(a,b,t){if(a.value.kind!=="constant"||b.value.kind!=="constant"){return a}if(a.value.value===undefined||b.value.value===undefined){return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:undefined},a.parameters)}const interpolationType=this.specification.type;const interpolationFn=interpolate[interpolationType];if(interpolationFn){const interpolatedValue=interpolationFn(a.value.value,b.value.value,t);return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:interpolatedValue},a.parameters)}else{return a}}evaluate(value,parameters,feature,featureState,canonical,availableImages){if(value.kind==="constant"){return value.value}else{return value.evaluate(parameters,feature,featureState,canonical,availableImages)}}}class CrossFadedDataDrivenProperty extends DataDrivenProperty{possiblyEvaluate(value,parameters,canonical,availableImages){if(value.value===undefined){return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:undefined},parameters)}else if(value.expression.kind==="constant"){const evaluatedValue=value.expression.evaluate(parameters,null,{},canonical,availableImages);const isImageExpression=value.property.specification.type==="resolvedImage";const constantValue=isImageExpression&&typeof evaluatedValue!=="string"?evaluatedValue.name:evaluatedValue;const constant=this._calculate(constantValue,constantValue,constantValue,parameters);return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:constant},parameters)}else if(value.expression.kind==="camera"){const cameraVal=this._calculate(value.expression.evaluate({zoom:parameters.zoom-1}),value.expression.evaluate({zoom:parameters.zoom}),value.expression.evaluate({zoom:parameters.zoom+1}),parameters);return new PossiblyEvaluatedPropertyValue(this,{kind:"constant",value:cameraVal},parameters)}else{return new PossiblyEvaluatedPropertyValue(this,value.expression,parameters)}}evaluate(value,globals,feature,featureState,canonical,availableImages){if(value.kind==="source"){const constant=value.evaluate(globals,feature,featureState,canonical,availableImages);return this._calculate(constant,constant,constant,globals)}else if(value.kind==="composite"){return this._calculate(value.evaluate({zoom:Math.floor(globals.zoom)-1},feature,featureState),value.evaluate({zoom:Math.floor(globals.zoom)},feature,featureState),value.evaluate({zoom:Math.floor(globals.zoom)+1},feature,featureState),globals)}else{return value.value}}_calculate(min,mid,max,parameters){const z=parameters.zoom;return z>parameters.zoomHistory.lastIntegerZoom?{from:min,to:mid}:{from:max,to:mid}}interpolate(a){return a}}class CrossFadedProperty{constructor(specification){this.specification=specification}possiblyEvaluate(value,parameters,canonical,availableImages){if(value.value===undefined){return undefined}else if(value.expression.kind==="constant"){const constant=value.expression.evaluate(parameters,null,{},canonical,availableImages);return this._calculate(constant,constant,constant,parameters)}else{return this._calculate(value.expression.evaluate(new EvaluationParameters(Math.floor(parameters.zoom-1),parameters)),value.expression.evaluate(new EvaluationParameters(Math.floor(parameters.zoom),parameters)),value.expression.evaluate(new EvaluationParameters(Math.floor(parameters.zoom+1),parameters)),parameters)}}_calculate(min,mid,max,parameters){const z=parameters.zoom;return z>parameters.zoomHistory.lastIntegerZoom?{from:min,to:mid}:{from:max,to:mid}}interpolate(a){return a}}class ColorRampProperty{constructor(specification){this.specification=specification}possiblyEvaluate(value,parameters,canonical,availableImages){return!!value.expression.evaluate(parameters,null,{},canonical,availableImages)}interpolate(){return false}}class Properties{constructor(properties){this.properties=properties;this.defaultPropertyValues={};this.defaultTransitionablePropertyValues={};this.defaultTransitioningPropertyValues={};this.defaultPossiblyEvaluatedValues={};this.overridableProperties=[];for(const property in properties){const prop=properties[property];if(prop.specification.overridable){this.overridableProperties.push(property)}const defaultPropertyValue=this.defaultPropertyValues[property]=new PropertyValue(prop,undefined);const defaultTransitionablePropertyValue=this.defaultTransitionablePropertyValues[property]=new TransitionablePropertyValue(prop);this.defaultTransitioningPropertyValues[property]=defaultTransitionablePropertyValue.untransitioned();this.defaultPossiblyEvaluatedValues[property]=defaultPropertyValue.possiblyEvaluate({})}}}register("DataDrivenProperty",DataDrivenProperty);register("DataConstantProperty",DataConstantProperty);register("CrossFadedDataDrivenProperty",CrossFadedDataDrivenProperty);register("CrossFadedProperty",CrossFadedProperty);register("ColorRampProperty",ColorRampProperty);const TRANSITION_SUFFIX="-transition";class StyleLayer extends Evented{constructor(layer,properties){super();this.id=layer.id;this.type=layer.type;this._featureFilter={filter:()=>true,needGeometry:false};if(layer.type==="custom")return;layer=layer;this.metadata=layer.metadata;this.minzoom=layer.minzoom;this.maxzoom=layer.maxzoom;if(layer.type!=="background"){this.source=layer.source;this.sourceLayer=layer["source-layer"];this.filter=layer.filter}if(properties.layout){this._unevaluatedLayout=new Layout(properties.layout)}if(properties.paint){this._transitionablePaint=new Transitionable(properties.paint);for(const property in layer.paint){this.setPaintProperty(property,layer.paint[property],{validate:false})}for(const property in layer.layout){this.setLayoutProperty(property,layer.layout[property],{validate:false})}this._transitioningPaint=this._transitionablePaint.untransitioned();this.paint=new PossiblyEvaluated(properties.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(name){if(name==="visibility"){return this.visibility}return this._unevaluatedLayout.getValue(name)}setLayoutProperty(name,value,options={}){if(value!==null&&value!==undefined){const key=`layers.${this.id}.layout.${name}`;if(this._validate(validateLayoutProperty,key,name,value,options)){return}}if(name==="visibility"){this.visibility=value;return}this._unevaluatedLayout.setValue(name,value)}getPaintProperty(name){if(name.endsWith(TRANSITION_SUFFIX)){return this._transitionablePaint.getTransition(name.slice(0,-TRANSITION_SUFFIX.length))}else{return this._transitionablePaint.getValue(name)}}setPaintProperty(name,value,options={}){if(value!==null&&value!==undefined){const key=`layers.${this.id}.paint.${name}`;if(this._validate(validatePaintProperty,key,name,value,options)){return false}}if(name.endsWith(TRANSITION_SUFFIX)){this._transitionablePaint.setTransition(name.slice(0,-TRANSITION_SUFFIX.length),value||undefined);return false}else{const transitionable=this._transitionablePaint._values[name];const isCrossFadedProperty=transitionable.property.specification["property-type"]==="cross-faded-data-driven";const wasDataDriven=transitionable.value.isDataDriven();const oldValue=transitionable.value;this._transitionablePaint.setValue(name,value);this._handleSpecialPaintPropertyUpdate(name);const newValue=this._transitionablePaint._values[name].value;const isDataDriven=newValue.isDataDriven();return isDataDriven||wasDataDriven||isCrossFadedProperty||this._handleOverridablePaintPropertyUpdate(name,oldValue,newValue)}}_handleSpecialPaintPropertyUpdate(_){}_handleOverridablePaintPropertyUpdate(name,oldValue,newValue){return false}isHidden(zoom){if(this.minzoom&&zoom<this.minzoom)return true;if(this.maxzoom&&zoom>=this.maxzoom)return true;return this.visibility==="none"}updateTransitions(parameters){this._transitioningPaint=this._transitionablePaint.transitioned(parameters,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(parameters,availableImages){if(parameters.getCrossfadeParameters){this._crossfadeParameters=parameters.getCrossfadeParameters()}if(this._unevaluatedLayout){this.layout=this._unevaluatedLayout.possiblyEvaluate(parameters,undefined,availableImages)}this.paint=this._transitioningPaint.possiblyEvaluate(parameters,undefined,availableImages)}serialize(){const output={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};if(this.visibility){output.layout=output.layout||{};output.layout.visibility=this.visibility}return filterObject(output,((value,key)=>value!==undefined&&!(key==="layout"&&!Object.keys(value).length)&&!(key==="paint"&&!Object.keys(value).length)))}_validate(validate,key,name,value,options={}){if(options&&options.validate===false){return false}return emitValidationErrors(this,validate.call(validateStyle,{key:key,layerType:this.type,objectKey:name,value:value,styleSpec:v8Spec,style:{glyphs:true,sprite:true}}))}is3D(){return false}isTileClipped(){return false}hasOffscreenPass(){return false}resize(){}isStateDependent(){for(const property in this.paint._values){const value=this.paint.get(property);if(!(value instanceof PossiblyEvaluatedPropertyValue)||!supportsPropertyExpression(value.property.specification)){continue}if((value.value.kind==="source"||value.value.kind==="composite")&&value.value.isStateDependent){return true}}return false}}const viewTypes={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Struct{constructor(structArray,index){this._structArray=structArray;this._pos1=index*this.size;this._pos2=this._pos1/2;this._pos4=this._pos1/4;this._pos8=this._pos1/8}}const DEFAULT_CAPACITY=128;const RESIZE_MULTIPLIER=5;class StructArray{constructor(){this.isTransferred=false;this.capacity=-1;this.resize(0)}static serialize(array,transferables){array._trim();if(transferables){array.isTransferred=true;transferables.push(array.arrayBuffer)}return{length:array.length,arrayBuffer:array.arrayBuffer}}static deserialize(input){const structArray=Object.create(this.prototype);structArray.arrayBuffer=input.arrayBuffer;structArray.length=input.length;structArray.capacity=input.arrayBuffer.byteLength/structArray.bytesPerElement;structArray._refreshViews();return structArray}_trim(){if(this.length!==this.capacity){this.capacity=this.length;this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement);this._refreshViews()}}clear(){this.length=0}resize(n){this.reserve(n);this.length=n}reserve(n){if(n>this.capacity){this.capacity=Math.max(n,Math.floor(this.capacity*RESIZE_MULTIPLIER),DEFAULT_CAPACITY);this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const oldUint8Array=this.uint8;this._refreshViews();if(oldUint8Array)this.uint8.set(oldUint8Array)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function createLayout(members,alignment=1){let offset=0;let maxSize=0;const layoutMembers=members.map((member=>{const typeSize=sizeOf(member.type);const memberOffset=offset=align$1(offset,Math.max(alignment,typeSize));const components=member.components||1;maxSize=Math.max(maxSize,typeSize);offset+=typeSize*components;return{name:member.name,type:member.type,components:components,offset:memberOffset}}));const size=align$1(offset,Math.max(maxSize,alignment));return{members:layoutMembers,size:size,alignment:alignment}}function sizeOf(type){return viewTypes[type].BYTES_PER_ELEMENT}function align$1(offset,size){return Math.ceil(offset/size)*size}class StructArrayLayout2i4 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1)}emplace(i,v0,v1){const o2=i*2;this.int16[o2+0]=v0;this.int16[o2+1]=v1;return i}}StructArrayLayout2i4.prototype.bytesPerElement=4;register("StructArrayLayout2i4",StructArrayLayout2i4);class StructArrayLayout3i6 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o2=i*3;this.int16[o2+0]=v0;this.int16[o2+1]=v1;this.int16[o2+2]=v2;return i}}StructArrayLayout3i6.prototype.bytesPerElement=6;register("StructArrayLayout3i6",StructArrayLayout3i6);class StructArrayLayout4i8 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3)}emplace(i,v0,v1,v2,v3){const o2=i*4;this.int16[o2+0]=v0;this.int16[o2+1]=v1;this.int16[o2+2]=v2;this.int16[o2+3]=v3;return i}}StructArrayLayout4i8.prototype.bytesPerElement=8;register("StructArrayLayout4i8",StructArrayLayout4i8);class StructArrayLayout2i4i12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3,v4,v5)}emplace(i,v0,v1,v2,v3,v4,v5){const o2=i*6;this.int16[o2+0]=v0;this.int16[o2+1]=v1;this.int16[o2+2]=v2;this.int16[o2+3]=v3;this.int16[o2+4]=v4;this.int16[o2+5]=v5;return i}}StructArrayLayout2i4i12.prototype.bytesPerElement=12;register("StructArrayLayout2i4i12",StructArrayLayout2i4i12);class StructArrayLayout2i4ub8 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3,v4,v5)}emplace(i,v0,v1,v2,v3,v4,v5){const o2=i*4;const o1=i*8;this.int16[o2+0]=v0;this.int16[o2+1]=v1;this.uint8[o1+4]=v2;this.uint8[o1+5]=v3;this.uint8[o1+6]=v4;this.uint8[o1+7]=v5;return i}}StructArrayLayout2i4ub8.prototype.bytesPerElement=8;register("StructArrayLayout2i4ub8",StructArrayLayout2i4ub8);class StructArrayLayout2f8 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1)}emplace(i,v0,v1){const o4=i*2;this.float32[o4+0]=v0;this.float32[o4+1]=v1;return i}}StructArrayLayout2f8.prototype.bytesPerElement=8;register("StructArrayLayout2f8",StructArrayLayout2f8);class StructArrayLayout10ui20 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8,v9){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9){const o2=i*10;this.uint16[o2+0]=v0;this.uint16[o2+1]=v1;this.uint16[o2+2]=v2;this.uint16[o2+3]=v3;this.uint16[o2+4]=v4;this.uint16[o2+5]=v5;this.uint16[o2+6]=v6;this.uint16[o2+7]=v7;this.uint16[o2+8]=v8;this.uint16[o2+9]=v9;return i}}StructArrayLayout10ui20.prototype.bytesPerElement=20;register("StructArrayLayout10ui20",StructArrayLayout10ui20);class StructArrayLayout4i4ui4i24 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11){const o2=i*12;this.int16[o2+0]=v0;this.int16[o2+1]=v1;this.int16[o2+2]=v2;this.int16[o2+3]=v3;this.uint16[o2+4]=v4;this.uint16[o2+5]=v5;this.uint16[o2+6]=v6;this.uint16[o2+7]=v7;this.int16[o2+8]=v8;this.int16[o2+9]=v9;this.int16[o2+10]=v10;this.int16[o2+11]=v11;return i}}StructArrayLayout4i4ui4i24.prototype.bytesPerElement=24;register("StructArrayLayout4i4ui4i24",StructArrayLayout4i4ui4i24);class StructArrayLayout3f12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o4=i*3;this.float32[o4+0]=v0;this.float32[o4+1]=v1;this.float32[o4+2]=v2;return i}}StructArrayLayout3f12.prototype.bytesPerElement=12;register("StructArrayLayout3f12",StructArrayLayout3f12);class StructArrayLayout1ul4 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(v0){const i=this.length;this.resize(i+1);return this.emplace(i,v0)}emplace(i,v0){const o4=i*1;this.uint32[o4+0]=v0;return i}}StructArrayLayout1ul4.prototype.bytesPerElement=4;register("StructArrayLayout1ul4",StructArrayLayout1ul4);class StructArrayLayout6i1ul2ui20 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer);this.uint32=new Uint32Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8){const o2=i*10;const o4=i*5;this.int16[o2+0]=v0;this.int16[o2+1]=v1;this.int16[o2+2]=v2;this.int16[o2+3]=v3;this.int16[o2+4]=v4;this.int16[o2+5]=v5;this.uint32[o4+3]=v6;this.uint16[o2+8]=v7;this.uint16[o2+9]=v8;return i}}StructArrayLayout6i1ul2ui20.prototype.bytesPerElement=20;register("StructArrayLayout6i1ul2ui20",StructArrayLayout6i1ul2ui20);class StructArrayLayout2i2i2i12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3,v4,v5)}emplace(i,v0,v1,v2,v3,v4,v5){const o2=i*6;this.int16[o2+0]=v0;this.int16[o2+1]=v1;this.int16[o2+2]=v2;this.int16[o2+3]=v3;this.int16[o2+4]=v4;this.int16[o2+5]=v5;return i}}StructArrayLayout2i2i2i12.prototype.bytesPerElement=12;register("StructArrayLayout2i2i2i12",StructArrayLayout2i2i2i12);class StructArrayLayout2f1f2i16 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.float32=new Float32Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3,v4)}emplace(i,v0,v1,v2,v3,v4){const o4=i*4;const o2=i*8;this.float32[o4+0]=v0;this.float32[o4+1]=v1;this.float32[o4+2]=v2;this.int16[o2+6]=v3;this.int16[o2+7]=v4;return i}}StructArrayLayout2f1f2i16.prototype.bytesPerElement=16;register("StructArrayLayout2f1f2i16",StructArrayLayout2f1f2i16);class StructArrayLayout2ub2f12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3)}emplace(i,v0,v1,v2,v3){const o1=i*12;const o4=i*3;this.uint8[o1+0]=v0;this.uint8[o1+1]=v1;this.float32[o4+1]=v2;this.float32[o4+2]=v3;return i}}StructArrayLayout2ub2f12.prototype.bytesPerElement=12;register("StructArrayLayout2ub2f12",StructArrayLayout2ub2f12);class StructArrayLayout3ui6 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o2=i*3;this.uint16[o2+0]=v0;this.uint16[o2+1]=v1;this.uint16[o2+2]=v2;return i}}StructArrayLayout3ui6.prototype.bytesPerElement=6;register("StructArrayLayout3ui6",StructArrayLayout3ui6);class StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer);this.uint32=new Uint32Array(this.arrayBuffer);this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16){const o2=i*24;const o4=i*12;const o1=i*48;this.int16[o2+0]=v0;this.int16[o2+1]=v1;this.uint16[o2+2]=v2;this.uint16[o2+3]=v3;this.uint32[o4+2]=v4;this.uint32[o4+3]=v5;this.uint32[o4+4]=v6;this.uint16[o2+10]=v7;this.uint16[o2+11]=v8;this.uint16[o2+12]=v9;this.float32[o4+7]=v10;this.float32[o4+8]=v11;this.uint8[o1+36]=v12;this.uint8[o1+37]=v13;this.uint8[o1+38]=v14;this.uint32[o4+10]=v15;this.int16[o2+22]=v16;return i}}StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48.prototype.bytesPerElement=48;register("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48);class StructArrayLayout8i15ui1ul2f2ui64 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.int16=new Int16Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer);this.uint32=new Uint32Array(this.arrayBuffer);this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18,v19,v20,v21,v22,v23,v24,v25,v26,v27){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18,v19,v20,v21,v22,v23,v24,v25,v26,v27)}emplace(i,v0,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18,v19,v20,v21,v22,v23,v24,v25,v26,v27){const o2=i*32;const o4=i*16;this.int16[o2+0]=v0;this.int16[o2+1]=v1;this.int16[o2+2]=v2;this.int16[o2+3]=v3;this.int16[o2+4]=v4;this.int16[o2+5]=v5;this.int16[o2+6]=v6;this.int16[o2+7]=v7;this.uint16[o2+8]=v8;this.uint16[o2+9]=v9;this.uint16[o2+10]=v10;this.uint16[o2+11]=v11;this.uint16[o2+12]=v12;this.uint16[o2+13]=v13;this.uint16[o2+14]=v14;this.uint16[o2+15]=v15;this.uint16[o2+16]=v16;this.uint16[o2+17]=v17;this.uint16[o2+18]=v18;this.uint16[o2+19]=v19;this.uint16[o2+20]=v20;this.uint16[o2+21]=v21;this.uint16[o2+22]=v22;this.uint32[o4+12]=v23;this.float32[o4+13]=v24;this.float32[o4+14]=v25;this.uint16[o2+30]=v26;this.uint16[o2+31]=v27;return i}}StructArrayLayout8i15ui1ul2f2ui64.prototype.bytesPerElement=64;register("StructArrayLayout8i15ui1ul2f2ui64",StructArrayLayout8i15ui1ul2f2ui64);class StructArrayLayout1f4 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0){const i=this.length;this.resize(i+1);return this.emplace(i,v0)}emplace(i,v0){const o4=i*1;this.float32[o4+0]=v0;return i}}StructArrayLayout1f4.prototype.bytesPerElement=4;register("StructArrayLayout1f4",StructArrayLayout1f4);class StructArrayLayout1ui2f12 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer);this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o2=i*6;const o4=i*3;this.uint16[o2+0]=v0;this.float32[o4+1]=v1;this.float32[o4+2]=v2;return i}}StructArrayLayout1ui2f12.prototype.bytesPerElement=12;register("StructArrayLayout1ui2f12",StructArrayLayout1ui2f12);class StructArrayLayout1ul2ui8 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.uint32=new Uint32Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1,v2){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2)}emplace(i,v0,v1,v2){const o4=i*2;const o2=i*4;this.uint32[o4+0]=v0;this.uint16[o2+2]=v1;this.uint16[o2+3]=v2;return i}}StructArrayLayout1ul2ui8.prototype.bytesPerElement=8;register("StructArrayLayout1ul2ui8",StructArrayLayout1ul2ui8);class StructArrayLayout2ui4 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0,v1){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1)}emplace(i,v0,v1){const o2=i*2;this.uint16[o2+0]=v0;this.uint16[o2+1]=v1;return i}}StructArrayLayout2ui4.prototype.bytesPerElement=4;register("StructArrayLayout2ui4",StructArrayLayout2ui4);class StructArrayLayout1ui2 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(v0){const i=this.length;this.resize(i+1);return this.emplace(i,v0)}emplace(i,v0){const o2=i*1;this.uint16[o2+0]=v0;return i}}StructArrayLayout1ui2.prototype.bytesPerElement=2;register("StructArrayLayout1ui2",StructArrayLayout1ui2);class StructArrayLayout4f16 extends StructArray{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer);this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(v0,v1,v2,v3){const i=this.length;this.resize(i+1);return this.emplace(i,v0,v1,v2,v3)}emplace(i,v0,v1,v2,v3){const o4=i*4;this.float32[o4+0]=v0;this.float32[o4+1]=v1;this.float32[o4+2]=v2;this.float32[o4+3]=v3;return i}}StructArrayLayout4f16.prototype.bytesPerElement=16;register("StructArrayLayout4f16",StructArrayLayout4f16);class CollisionBoxStruct extends Struct{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new Point$2(this.anchorPointX,this.anchorPointY)}}CollisionBoxStruct.prototype.size=20;class CollisionBoxArray extends StructArrayLayout6i1ul2ui20{get(index){return new CollisionBoxStruct(this,index)}}register("CollisionBoxArray",CollisionBoxArray);class PlacedSymbolStruct extends Struct{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(x){this._structArray.uint8[this._pos1+37]=x}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(x){this._structArray.uint8[this._pos1+38]=x}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(x){this._structArray.uint32[this._pos4+10]=x}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}PlacedSymbolStruct.prototype.size=48;class PlacedSymbolArray extends StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48{get(index){return new PlacedSymbolStruct(this,index)}}register("PlacedSymbolArray",PlacedSymbolArray);class SymbolInstanceStruct extends Struct{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(x){this._structArray.uint32[this._pos4+12]=x}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}SymbolInstanceStruct.prototype.size=64;class SymbolInstanceArray extends StructArrayLayout8i15ui1ul2f2ui64{get(index){return new SymbolInstanceStruct(this,index)}}register("SymbolInstanceArray",SymbolInstanceArray);class GlyphOffsetArray extends StructArrayLayout1f4{getoffsetX(index){return this.float32[index*1+0]}}register("GlyphOffsetArray",GlyphOffsetArray);class SymbolLineVertexArray extends StructArrayLayout3i6{getx(index){return this.int16[index*3+0]}gety(index){return this.int16[index*3+1]}gettileUnitDistanceFromAnchor(index){return this.int16[index*3+2]}}register("SymbolLineVertexArray",SymbolLineVertexArray);class TextAnchorOffsetStruct extends Struct{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}TextAnchorOffsetStruct.prototype.size=12;class TextAnchorOffsetArray extends StructArrayLayout1ui2f12{get(index){return new TextAnchorOffsetStruct(this,index)}}register("TextAnchorOffsetArray",TextAnchorOffsetArray);class FeatureIndexStruct extends Struct{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}FeatureIndexStruct.prototype.size=8;class FeatureIndexArray extends StructArrayLayout1ul2ui8{get(index){return new FeatureIndexStruct(this,index)}}register("FeatureIndexArray",FeatureIndexArray);class PosArray extends StructArrayLayout2i4{}class Pos3dArray extends StructArrayLayout3i6{}class RasterBoundsArray extends StructArrayLayout4i8{}class CircleLayoutArray extends StructArrayLayout2i4{}class FillLayoutArray extends StructArrayLayout2i4{}class FillExtrusionLayoutArray extends StructArrayLayout2i4i12{}class HeatmapLayoutArray extends StructArrayLayout2i4{}class LineLayoutArray extends StructArrayLayout2i4ub8{}class LineExtLayoutArray extends StructArrayLayout2f8{}class PatternLayoutArray extends StructArrayLayout10ui20{}class SymbolLayoutArray extends StructArrayLayout4i4ui4i24{}class SymbolDynamicLayoutArray extends StructArrayLayout3f12{}class SymbolOpacityArray extends StructArrayLayout1ul4{}class CollisionBoxLayoutArray extends StructArrayLayout2i2i2i12{}class CollisionCircleLayoutArray extends StructArrayLayout2f1f2i16{}class CollisionVertexArray extends StructArrayLayout2ub2f12{}class QuadTriangleArray extends StructArrayLayout3ui6{}class TriangleIndexArray extends StructArrayLayout3ui6{}class LineIndexArray extends StructArrayLayout2ui4{}class LineStripIndexArray extends StructArrayLayout1ui2{}const layout$6=createLayout([{name:"a_pos",components:2,type:"Int16"}],4);const{members:members$4,size:size$4,alignment:alignment$4}=layout$6;class SegmentVector{constructor(segments=[]){this.segments=segments}prepareSegment(numVertices,layoutVertexArray,indexArray,sortKey){let segment=this.segments[this.segments.length-1];if(numVertices>SegmentVector.MAX_VERTEX_ARRAY_LENGTH)warnOnce(`Max vertices per segment is ${SegmentVector.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${numVertices}`);if(!segment||segment.vertexLength+numVertices>SegmentVector.MAX_VERTEX_ARRAY_LENGTH||segment.sortKey!==sortKey){segment={vertexOffset:layoutVertexArray.length,primitiveOffset:indexArray.length,vertexLength:0,primitiveLength:0};if(sortKey!==undefined)segment.sortKey=sortKey;this.segments.push(segment)}return segment}get(){return this.segments}destroy(){for(const segment of this.segments){for(const k in segment.vaos){segment.vaos[k].destroy()}}}static simpleSegment(vertexOffset,primitiveOffset,vertexLength,primitiveLength){return new SegmentVector([{vertexOffset:vertexOffset,primitiveOffset:primitiveOffset,vertexLength:vertexLength,primitiveLength:primitiveLength,vaos:{},sortKey:0}])}}SegmentVector.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1;register("SegmentVector",SegmentVector);function packUint8ToFloat(a,b){a=clamp$1(Math.floor(a),0,255);b=clamp$1(Math.floor(b),0,255);return 256*a+b}const patternAttributes=createLayout([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var murmurhashJs$1={exports:{}};var murmurhash3_gc$2={exports:{}};var murmurhash3_gc=murmurhash3_gc$2.exports;(function(module){function murmurhash3_32_gc(key,seed){var remainder,bytes,h1,h1b,c1,c1b,c2,c2b,k1,i;remainder=key.length&3;bytes=key.length-remainder;h1=seed;c1=3432918353;c2=461845907;i=0;while(i<bytes){k1=key.charCodeAt(i)&255|(key.charCodeAt(++i)&255)<<8|(key.charCodeAt(++i)&255)<<16|(key.charCodeAt(++i)&255)<<24;++i;k1=(k1&65535)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295;k1=k1<<15|k1>>>17;k1=(k1&65535)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295;h1^=k1;h1=h1<<13|h1>>>19;h1b=(h1&65535)*5+(((h1>>>16)*5&65535)<<16)&4294967295;h1=(h1b&65535)+27492+(((h1b>>>16)+58964&65535)<<16)}k1=0;switch(remainder){case 3:k1^=(key.charCodeAt(i+2)&255)<<16;case 2:k1^=(key.charCodeAt(i+1)&255)<<8;case 1:k1^=key.charCodeAt(i)&255;k1=(k1&65535)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295;k1=k1<<15|k1>>>17;k1=(k1&65535)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295;h1^=k1}h1^=key.length;h1^=h1>>>16;h1=(h1&65535)*2246822507+(((h1>>>16)*2246822507&65535)<<16)&4294967295;h1^=h1>>>13;h1=(h1&65535)*3266489909+(((h1>>>16)*3266489909&65535)<<16)&4294967295;h1^=h1>>>16;return h1>>>0}if("object"!=="undefined"){module.exports=murmurhash3_32_gc}})(murmurhash3_gc$2);var murmurhash3_gcExports=murmurhash3_gc$2.exports;var murmurhash3_gc$1=getDefaultExportFromCjs$1(murmurhash3_gcExports);var murmurhash2_gc$2={exports:{}};var murmurhash2_gc=murmurhash2_gc$2.exports;(function(module){function murmurhash2_32_gc(str,seed){var l=str.length,h=seed^l,i=0,k;while(l>=4){k=str.charCodeAt(i)&255|(str.charCodeAt(++i)&255)<<8|(str.charCodeAt(++i)&255)<<16|(str.charCodeAt(++i)&255)<<24;k=(k&65535)*1540483477+(((k>>>16)*1540483477&65535)<<16);k^=k>>>24;k=(k&65535)*1540483477+(((k>>>16)*1540483477&65535)<<16);h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)^k;l-=4;++i}switch(l){case 3:h^=(str.charCodeAt(i+2)&255)<<16;case 2:h^=(str.charCodeAt(i+1)&255)<<8;case 1:h^=str.charCodeAt(i)&255;h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16)}h^=h>>>13;h=(h&65535)*1540483477+(((h>>>16)*1540483477&65535)<<16);h^=h>>>15;return h>>>0}if("object"!==undefined){module.exports=murmurhash2_32_gc}})(murmurhash2_gc$2);var murmurhash2_gcExports=murmurhash2_gc$2.exports;var murmurhash2_gc$1=getDefaultExportFromCjs$1(murmurhash2_gcExports);var murmurhashJs=murmurhashJs$1.exports;var murmur3=murmurhash3_gcExports;var murmur2=murmurhash2_gcExports;murmurhashJs$1.exports=murmur3;var murmur3_1=murmurhashJs$1.exports.murmur3=murmur3;var murmur2_1=murmurhashJs$1.exports.murmur2=murmur2;var murmurhashJsExports=murmurhashJs$1.exports;var murmur3$1=getDefaultExportFromCjs$1(murmurhashJsExports);class FeaturePositionMap{constructor(){this.ids=[];this.positions=[];this.indexed=false}add(id,index,start,end){this.ids.push(getNumericId(id));this.positions.push(index,start,end)}getPositions(id){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const intId=getNumericId(id);let i=0;let j=this.ids.length-1;while(i<j){const m=i+j>>1;if(this.ids[m]>=intId){j=m}else{i=m+1}}const positions=[];while(this.ids[i]===intId){const index=this.positions[3*i];const start=this.positions[3*i+1];const end=this.positions[3*i+2];positions.push({index:index,start:start,end:end});i++}return positions}static serialize(map,transferables){const ids=new Float64Array(map.ids);const positions=new Uint32Array(map.positions);sort$1(ids,positions,0,ids.length-1);if(transferables){transferables.push(ids.buffer,positions.buffer)}return{ids:ids,positions:positions}}static deserialize(obj){const map=new FeaturePositionMap;map.ids=obj.ids;map.positions=obj.positions;map.indexed=true;return map}}function getNumericId(value){const numValue=+value;if(!isNaN(numValue)&&numValue<=Number.MAX_SAFE_INTEGER){return numValue}return murmur3$1(String(value))}function sort$1(ids,positions,left,right){while(left<right){const pivot=ids[left+right>>1];let i=left-1;let j=right+1;while(true){do{i++}while(ids[i]<pivot);do{j--}while(ids[j]>pivot);if(i>=j)break;swap$2(ids,i,j);swap$2(positions,3*i,3*j);swap$2(positions,3*i+1,3*j+1);swap$2(positions,3*i+2,3*j+2)}if(j-left<right-j){sort$1(ids,positions,left,j);left=j+1}else{sort$1(ids,positions,j+1,right);right=j}}}function swap$2(arr,i,j){const tmp=arr[i];arr[i]=arr[j];arr[j]=tmp}register("FeaturePositionMap",FeaturePositionMap);class Uniform{constructor(context,location){this.gl=context.gl;this.location=location}}class Uniform1i extends Uniform{constructor(context,location){super(context,location);this.current=0}set(v){if(this.current!==v){this.current=v;this.gl.uniform1i(this.location,v)}}}class Uniform1f extends Uniform{constructor(context,location){super(context,location);this.current=0}set(v){if(this.current!==v){this.current=v;this.gl.uniform1f(this.location,v)}}}class Uniform2f extends Uniform{constructor(context,location){super(context,location);this.current=[0,0]}set(v){if(v[0]!==this.current[0]||v[1]!==this.current[1]){this.current=v;this.gl.uniform2f(this.location,v[0],v[1])}}}class Uniform3f extends Uniform{constructor(context,location){super(context,location);this.current=[0,0,0]}set(v){if(v[0]!==this.current[0]||v[1]!==this.current[1]||v[2]!==this.current[2]){this.current=v;this.gl.uniform3f(this.location,v[0],v[1],v[2])}}}class Uniform4f extends Uniform{constructor(context,location){super(context,location);this.current=[0,0,0,0]}set(v){if(v[0]!==this.current[0]||v[1]!==this.current[1]||v[2]!==this.current[2]||v[3]!==this.current[3]){this.current=v;this.gl.uniform4f(this.location,v[0],v[1],v[2],v[3])}}}class UniformColor extends Uniform{constructor(context,location){super(context,location);this.current=Color.transparent}set(v){if(v.r!==this.current.r||v.g!==this.current.g||v.b!==this.current.b||v.a!==this.current.a){this.current=v;this.gl.uniform4f(this.location,v.r,v.g,v.b,v.a)}}}const emptyMat4=new Float32Array(16);class UniformMatrix4f extends Uniform{constructor(context,location){super(context,location);this.current=emptyMat4}set(v){if(v[12]!==this.current[12]||v[0]!==this.current[0]){this.current=v;this.gl.uniformMatrix4fv(this.location,false,v);return}for(let i=1;i<16;i++){if(v[i]!==this.current[i]){this.current=v;this.gl.uniformMatrix4fv(this.location,false,v);break}}}}function packColor(color){return[packUint8ToFloat(255*color.r,255*color.g),packUint8ToFloat(255*color.b,255*color.a)]}class ConstantBinder{constructor(value,names,type){this.value=value;this.uniformNames=names.map((name=>`u_${name}`));this.type=type}setUniform(uniform,globals,currentValue){uniform.set(currentValue.constantOr(this.value))}getBinding(context,location,_){return this.type==="color"?new UniformColor(context,location):new Uniform1f(context,location)}}class CrossFadedConstantBinder{constructor(value,names){this.uniformNames=names.map((name=>`u_${name}`));this.patternFrom=null;this.patternTo=null;this.pixelRatioFrom=1;this.pixelRatioTo=1}setConstantPatternPositions(posTo,posFrom){this.pixelRatioFrom=posFrom.pixelRatio;this.pixelRatioTo=posTo.pixelRatio;this.patternFrom=posFrom.tlbr;this.patternTo=posTo.tlbr}setUniform(uniform,globals,currentValue,uniformName){const pos=uniformName==="u_pattern_to"?this.patternTo:uniformName==="u_pattern_from"?this.patternFrom:uniformName==="u_pixel_ratio_to"?this.pixelRatioTo:uniformName==="u_pixel_ratio_from"?this.pixelRatioFrom:null;if(pos)uniform.set(pos)}getBinding(context,location,name){return name.substr(0,9)==="u_pattern"?new Uniform4f(context,location):new Uniform1f(context,location)}}class SourceExpressionBinder{constructor(expression,names,type,PaintVertexArray){this.expression=expression;this.type=type;this.maxValue=0;this.paintVertexAttributes=names.map((name=>({name:`a_${name}`,type:"Float32",components:type==="color"?2:1,offset:0})));this.paintVertexArray=new PaintVertexArray}populatePaintArray(newLength,feature,imagePositions,canonical,formattedSection){const start=this.paintVertexArray.length;const value=this.expression.evaluate(new EvaluationParameters(0),feature,{},canonical,[],formattedSection);this.paintVertexArray.resize(newLength);this._setPaintValue(start,newLength,value)}updatePaintArray(start,end,feature,featureState){const value=this.expression.evaluate({zoom:0},feature,featureState);this._setPaintValue(start,end,value)}_setPaintValue(start,end,value){if(this.type==="color"){const color=packColor(value);for(let i=start;i<end;i++){this.paintVertexArray.emplace(i,color[0],color[1])}}else{for(let i=start;i<end;i++){this.paintVertexArray.emplace(i,value)}this.maxValue=Math.max(this.maxValue,Math.abs(value))}}upload(context){if(this.paintVertexArray&&this.paintVertexArray.arrayBuffer){if(this.paintVertexBuffer&&this.paintVertexBuffer.buffer){this.paintVertexBuffer.updateData(this.paintVertexArray)}else{this.paintVertexBuffer=context.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent)}}}destroy(){if(this.paintVertexBuffer){this.paintVertexBuffer.destroy()}}}class CompositeExpressionBinder{constructor(expression,names,type,useIntegerZoom,zoom,PaintVertexArray){this.expression=expression;this.uniformNames=names.map((name=>`u_${name}_t`));this.type=type;this.useIntegerZoom=useIntegerZoom;this.zoom=zoom;this.maxValue=0;this.paintVertexAttributes=names.map((name=>({name:`a_${name}`,type:"Float32",components:type==="color"?4:2,offset:0})));this.paintVertexArray=new PaintVertexArray}populatePaintArray(newLength,feature,imagePositions,canonical,formattedSection){const min=this.expression.evaluate(new EvaluationParameters(this.zoom),feature,{},canonical,[],formattedSection);const max=this.expression.evaluate(new EvaluationParameters(this.zoom+1),feature,{},canonical,[],formattedSection);const start=this.paintVertexArray.length;this.paintVertexArray.resize(newLength);this._setPaintValue(start,newLength,min,max)}updatePaintArray(start,end,feature,featureState){const min=this.expression.evaluate({zoom:this.zoom},feature,featureState);const max=this.expression.evaluate({zoom:this.zoom+1},feature,featureState);this._setPaintValue(start,end,min,max)}_setPaintValue(start,end,min,max){if(this.type==="color"){const minColor=packColor(min);const maxColor=packColor(max);for(let i=start;i<end;i++){this.paintVertexArray.emplace(i,minColor[0],minColor[1],maxColor[0],maxColor[1])}}else{for(let i=start;i<end;i++){this.paintVertexArray.emplace(i,min,max)}this.maxValue=Math.max(this.maxValue,Math.abs(min),Math.abs(max))}}upload(context){if(this.paintVertexArray&&this.paintVertexArray.arrayBuffer){if(this.paintVertexBuffer&&this.paintVertexBuffer.buffer){this.paintVertexBuffer.updateData(this.paintVertexArray)}else{this.paintVertexBuffer=context.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent)}}}destroy(){if(this.paintVertexBuffer){this.paintVertexBuffer.destroy()}}setUniform(uniform,globals){const currentZoom=this.useIntegerZoom?Math.floor(globals.zoom):globals.zoom;const factor=clamp$1(this.expression.interpolationFactor(currentZoom,this.zoom,this.zoom+1),0,1);uniform.set(factor)}getBinding(context,location,_){return new Uniform1f(context,location)}}class CrossFadedCompositeBinder{constructor(expression,type,useIntegerZoom,zoom,PaintVertexArray,layerId){this.expression=expression;this.type=type;this.useIntegerZoom=useIntegerZoom;this.zoom=zoom;this.layerId=layerId;this.zoomInPaintVertexArray=new PaintVertexArray;this.zoomOutPaintVertexArray=new PaintVertexArray}populatePaintArray(length,feature,imagePositions){const start=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(length);this.zoomOutPaintVertexArray.resize(length);this._setPaintValues(start,length,feature.patterns&&feature.patterns[this.layerId],imagePositions)}updatePaintArray(start,end,feature,featureState,imagePositions){this._setPaintValues(start,end,feature.patterns&&feature.patterns[this.layerId],imagePositions)}_setPaintValues(start,end,patterns,positions){if(!positions||!patterns)return;const{min:min,mid:mid,max:max}=patterns;const imageMin=positions[min];const imageMid=positions[mid];const imageMax=positions[max];if(!imageMin||!imageMid||!imageMax)return;for(let i=start;i<end;i++){this.zoomInPaintVertexArray.emplace(i,imageMid.tl[0],imageMid.tl[1],imageMid.br[0],imageMid.br[1],imageMin.tl[0],imageMin.tl[1],imageMin.br[0],imageMin.br[1],imageMid.pixelRatio,imageMin.pixelRatio);this.zoomOutPaintVertexArray.emplace(i,imageMid.tl[0],imageMid.tl[1],imageMid.br[0],imageMid.br[1],imageMax.tl[0],imageMax.tl[1],imageMax.br[0],imageMax.br[1],imageMid.pixelRatio,imageMax.pixelRatio)}}upload(context){if(this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer){this.zoomInPaintVertexBuffer=context.createVertexBuffer(this.zoomInPaintVertexArray,patternAttributes.members,this.expression.isStateDependent);this.zoomOutPaintVertexBuffer=context.createVertexBuffer(this.zoomOutPaintVertexArray,patternAttributes.members,this.expression.isStateDependent)}}destroy(){if(this.zoomOutPaintVertexBuffer)this.zoomOutPaintVertexBuffer.destroy();if(this.zoomInPaintVertexBuffer)this.zoomInPaintVertexBuffer.destroy()}}class ProgramConfiguration{constructor(layer,zoom,filterProperties){this.binders={};this._buffers=[];const keys=[];for(const property in layer.paint._values){if(!filterProperties(property))continue;const value=layer.paint.get(property);if(!(value instanceof PossiblyEvaluatedPropertyValue)||!supportsPropertyExpression(value.property.specification)){continue}const names=paintAttributeNames(property,layer.type);const expression=value.value;const type=value.property.specification.type;const useIntegerZoom=value.property.useIntegerZoom;const propType=value.property.specification["property-type"];const isCrossFaded=propType==="cross-faded"||propType==="cross-faded-data-driven";if(expression.kind==="constant"){this.binders[property]=isCrossFaded?new CrossFadedConstantBinder(expression.value,names):new ConstantBinder(expression.value,names,type);keys.push(`/u_${property}`)}else if(expression.kind==="source"||isCrossFaded){const StructArrayLayout=layoutType(property,type,"source");this.binders[property]=isCrossFaded?new CrossFadedCompositeBinder(expression,type,useIntegerZoom,zoom,StructArrayLayout,layer.id):new SourceExpressionBinder(expression,names,type,StructArrayLayout);keys.push(`/a_${property}`)}else{const StructArrayLayout=layoutType(property,type,"composite");this.binders[property]=new CompositeExpressionBinder(expression,names,type,useIntegerZoom,zoom,StructArrayLayout);keys.push(`/z_${property}`)}}this.cacheKey=keys.sort().join("")}getMaxValue(property){const binder=this.binders[property];return binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder?binder.maxValue:0}populatePaintArrays(newLength,feature,imagePositions,canonical,formattedSection){for(const property in this.binders){const binder=this.binders[property];if(binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder||binder instanceof CrossFadedCompositeBinder)binder.populatePaintArray(newLength,feature,imagePositions,canonical,formattedSection)}}setConstantPatternPositions(posTo,posFrom){for(const property in this.binders){const binder=this.binders[property];if(binder instanceof CrossFadedConstantBinder)binder.setConstantPatternPositions(posTo,posFrom)}}updatePaintArrays(featureStates,featureMap,vtLayer,layer,imagePositions){let dirty=false;for(const id in featureStates){const positions=featureMap.getPositions(id);for(const pos of positions){const feature=vtLayer.feature(pos.index);for(const property in this.binders){const binder=this.binders[property];if((binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder||binder instanceof CrossFadedCompositeBinder)&&binder.expression.isStateDependent===true){const value=layer.paint.get(property);binder.expression=value.value;binder.updatePaintArray(pos.start,pos.end,feature,featureStates[id],imagePositions);dirty=true}}}}return dirty}defines(){const result=[];for(const property in this.binders){const binder=this.binders[property];if(binder instanceof ConstantBinder||binder instanceof CrossFadedConstantBinder){result.push(...binder.uniformNames.map((name=>`#define HAS_UNIFORM_${name}`)))}}return result}getBinderAttributes(){const result=[];for(const property in this.binders){const binder=this.binders[property];if(binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder){for(let i=0;i<binder.paintVertexAttributes.length;i++){result.push(binder.paintVertexAttributes[i].name)}}else if(binder instanceof CrossFadedCompositeBinder){for(let i=0;i<patternAttributes.members.length;i++){result.push(patternAttributes.members[i].name)}}}return result}getBinderUniforms(){const uniforms=[];for(const property in this.binders){const binder=this.binders[property];if(binder instanceof ConstantBinder||binder instanceof CrossFadedConstantBinder||binder instanceof CompositeExpressionBinder){for(const uniformName of binder.uniformNames){uniforms.push(uniformName)}}}return uniforms}getPaintVertexBuffers(){return this._buffers}getUniforms(context,locations){const uniforms=[];for(const property in this.binders){const binder=this.binders[property];if(binder instanceof ConstantBinder||binder instanceof CrossFadedConstantBinder||binder instanceof CompositeExpressionBinder){for(const name of binder.uniformNames){if(locations[name]){const binding=binder.getBinding(context,locations[name],name);uniforms.push({name:name,property:property,binding:binding})}}}}return uniforms}setUniforms(context,binderUniforms,properties,globals){for(const{name:name,property:property,binding:binding}of binderUniforms){this.binders[property].setUniform(binding,globals,properties.get(property),name)}}updatePaintBuffers(crossfade){this._buffers=[];for(const property in this.binders){const binder=this.binders[property];if(crossfade&&binder instanceof CrossFadedCompositeBinder){const patternVertexBuffer=crossfade.fromScale===2?binder.zoomInPaintVertexBuffer:binder.zoomOutPaintVertexBuffer;if(patternVertexBuffer)this._buffers.push(patternVertexBuffer)}else if((binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder)&&binder.paintVertexBuffer){this._buffers.push(binder.paintVertexBuffer)}}}upload(context){for(const property in this.binders){const binder=this.binders[property];if(binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder||binder instanceof CrossFadedCompositeBinder)binder.upload(context)}this.updatePaintBuffers()}destroy(){for(const property in this.binders){const binder=this.binders[property];if(binder instanceof SourceExpressionBinder||binder instanceof CompositeExpressionBinder||binder instanceof CrossFadedCompositeBinder)binder.destroy()}}}class ProgramConfigurationSet{constructor(layers,zoom,filterProperties=(()=>true)){this.programConfigurations={};for(const layer of layers){this.programConfigurations[layer.id]=new ProgramConfiguration(layer,zoom,filterProperties)}this.needsUpload=false;this._featureMap=new FeaturePositionMap;this._bufferOffset=0}populatePaintArrays(length,feature,index,imagePositions,canonical,formattedSection){for(const key in this.programConfigurations){this.programConfigurations[key].populatePaintArrays(length,feature,imagePositions,canonical,formattedSection)}if(feature.id!==undefined){this._featureMap.add(feature.id,index,this._bufferOffset,length)}this._bufferOffset=length;this.needsUpload=true}updatePaintArrays(featureStates,vtLayer,layers,imagePositions){for(const layer of layers){this.needsUpload=this.programConfigurations[layer.id].updatePaintArrays(featureStates,this._featureMap,vtLayer,layer,imagePositions)||this.needsUpload}}get(layerId){return this.programConfigurations[layerId]}upload(context){if(!this.needsUpload)return;for(const layerId in this.programConfigurations){this.programConfigurations[layerId].upload(context)}this.needsUpload=false}destroy(){for(const layerId in this.programConfigurations){this.programConfigurations[layerId].destroy()}}}function paintAttributeNames(property,type){const attributeNameExceptions={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]};return attributeNameExceptions[property]||[property.replace(`${type}-`,"").replace(/-/g,"_")]}function getLayoutException(property){const propertyExceptions={"line-pattern":{source:PatternLayoutArray,composite:PatternLayoutArray},"fill-pattern":{source:PatternLayoutArray,composite:PatternLayoutArray},"fill-extrusion-pattern":{source:PatternLayoutArray,composite:PatternLayoutArray}};return propertyExceptions[property]}function layoutType(property,type,binderType){const defaultLayouts={color:{source:StructArrayLayout2f8,composite:StructArrayLayout4f16},number:{source:StructArrayLayout1f4,composite:StructArrayLayout2f8}};const layoutException=getLayoutException(property);return layoutException&&layoutException[binderType]||defaultLayouts[type][binderType]}register("ConstantBinder",ConstantBinder);register("CrossFadedConstantBinder",CrossFadedConstantBinder);register("SourceExpressionBinder",SourceExpressionBinder);register("CrossFadedCompositeBinder",CrossFadedCompositeBinder);register("CompositeExpressionBinder",CompositeExpressionBinder);register("ProgramConfiguration",ProgramConfiguration,{omit:["_buffers"]});register("ProgramConfigurationSet",ProgramConfigurationSet);const EXTENT=8192;const BITS=15;const MAX=Math.pow(2,BITS-1)-1;const MIN=-MAX-1;function loadGeometry(feature){const scale=EXTENT/feature.extent;const geometry=feature.loadGeometry();for(let r=0;r<geometry.length;r++){const ring=geometry[r];for(let p=0;p<ring.length;p++){const point=ring[p];const x=Math.round(point.x*scale);const y=Math.round(point.y*scale);point.x=clamp$1(x,MIN,MAX);point.y=clamp$1(y,MIN,MAX);if(x<point.x||x>point.x+1||y<point.y||y>point.y+1){warnOnce("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}}return geometry}function toEvaluationFeature(feature,needGeometry){return{type:feature.type,id:feature.id,properties:feature.properties,geometry:needGeometry?loadGeometry(feature):[]}}function addCircleVertex(layoutVertexArray,x,y,extrudeX,extrudeY){layoutVertexArray.emplaceBack(x*2+(extrudeX+1)/2,y*2+(extrudeY+1)/2)}class CircleBucket{constructor(options){this.zoom=options.zoom;this.overscaling=options.overscaling;this.layers=options.layers;this.layerIds=this.layers.map((layer=>layer.id));this.index=options.index;this.hasPattern=false;this.layoutVertexArray=new CircleLayoutArray;this.indexArray=new TriangleIndexArray;this.segments=new SegmentVector;this.programConfigurations=new ProgramConfigurationSet(options.layers,options.zoom);this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id))}populate(features,options,canonical){const styleLayer=this.layers[0];const bucketFeatures=[];let circleSortKey=null;let sortFeaturesByKey=false;if(styleLayer.type==="circle"){circleSortKey=styleLayer.layout.get("circle-sort-key");sortFeaturesByKey=!circleSortKey.isConstant()}for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=this.layers[0]._featureFilter.needGeometry;const evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!this.layers[0]._featureFilter.filter(new EvaluationParameters(this.zoom),evaluationFeature,canonical))continue;const sortKey=sortFeaturesByKey?circleSortKey.evaluate(evaluationFeature,{},canonical):undefined;const bucketFeature={id:id,properties:feature.properties,type:feature.type,sourceLayerIndex:sourceLayerIndex,index:index,geometry:needGeometry?evaluationFeature.geometry:loadGeometry(feature),patterns:{},sortKey:sortKey};bucketFeatures.push(bucketFeature)}if(sortFeaturesByKey){bucketFeatures.sort(((a,b)=>a.sortKey-b.sortKey))}for(const bucketFeature of bucketFeatures){const{geometry:geometry,index:index,sourceLayerIndex:sourceLayerIndex}=bucketFeature;const feature=features[index].feature;this.addFeature(bucketFeature,geometry,index,canonical);options.featureIndex.insert(feature,geometry,index,sourceLayerIndex,this.index)}}update(states,vtLayer,imagePositions){if(!this.stateDependentLayers.length)return;this.programConfigurations.updatePaintArrays(states,vtLayer,this.stateDependentLayers,imagePositions)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(context){if(!this.uploaded){this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,members$4);this.indexBuffer=context.createIndexBuffer(this.indexArray)}this.programConfigurations.upload(context);this.uploaded=true}destroy(){if(!this.layoutVertexBuffer)return;this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.programConfigurations.destroy();this.segments.destroy()}addFeature(feature,geometry,index,canonical){for(const ring of geometry){for(const point of ring){const x=point.x;const y=point.y;if(x<0||x>=EXTENT||y<0||y>=EXTENT)continue;const segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,feature.sortKey);const index=segment.vertexLength;addCircleVertex(this.layoutVertexArray,x,y,-1,-1);addCircleVertex(this.layoutVertexArray,x,y,1,-1);addCircleVertex(this.layoutVertexArray,x,y,1,1);addCircleVertex(this.layoutVertexArray,x,y,-1,1);this.indexArray.emplaceBack(index,index+1,index+2);this.indexArray.emplaceBack(index,index+3,index+2);segment.vertexLength+=4;segment.primitiveLength+=2}}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,feature,index,{},canonical)}}register("CircleBucket",CircleBucket,{omit:["layers"]});function polygonIntersectsPolygon(polygonA,polygonB){for(let i=0;i<polygonA.length;i++){if(polygonContainsPoint(polygonB,polygonA[i]))return true}for(let i=0;i<polygonB.length;i++){if(polygonContainsPoint(polygonA,polygonB[i]))return true}if(lineIntersectsLine(polygonA,polygonB))return true;return false}function polygonIntersectsBufferedPoint(polygon,point,radius){if(polygonContainsPoint(polygon,point))return true;if(pointIntersectsBufferedLine(point,polygon,radius))return true;return false}function polygonIntersectsMultiPolygon(polygon,multiPolygon){if(polygon.length===1){return multiPolygonContainsPoint(multiPolygon,polygon[0])}for(let m=0;m<multiPolygon.length;m++){const ring=multiPolygon[m];for(let n=0;n<ring.length;n++){if(polygonContainsPoint(polygon,ring[n]))return true}}for(let i=0;i<polygon.length;i++){if(multiPolygonContainsPoint(multiPolygon,polygon[i]))return true}for(let k=0;k<multiPolygon.length;k++){if(lineIntersectsLine(polygon,multiPolygon[k]))return true}return false}function polygonIntersectsBufferedMultiLine(polygon,multiLine,radius){for(let i=0;i<multiLine.length;i++){const line=multiLine[i];if(polygon.length>=3){for(let k=0;k<line.length;k++){if(polygonContainsPoint(polygon,line[k]))return true}}if(lineIntersectsBufferedLine(polygon,line,radius))return true}return false}function lineIntersectsBufferedLine(lineA,lineB,radius){if(lineA.length>1){if(lineIntersectsLine(lineA,lineB))return true;for(let j=0;j<lineB.length;j++){if(pointIntersectsBufferedLine(lineB[j],lineA,radius))return true}}for(let k=0;k<lineA.length;k++){if(pointIntersectsBufferedLine(lineA[k],lineB,radius))return true}return false}function lineIntersectsLine(lineA,lineB){if(lineA.length===0||lineB.length===0)return false;for(let i=0;i<lineA.length-1;i++){const a0=lineA[i];const a1=lineA[i+1];for(let j=0;j<lineB.length-1;j++){const b0=lineB[j];const b1=lineB[j+1];if(lineSegmentIntersectsLineSegment(a0,a1,b0,b1))return true}}return false}function lineSegmentIntersectsLineSegment(a0,a1,b0,b1){return isCounterClockwise(a0,b0,b1)!==isCounterClockwise(a1,b0,b1)&&isCounterClockwise(a0,a1,b0)!==isCounterClockwise(a0,a1,b1)}function pointIntersectsBufferedLine(p,line,radius){const radiusSquared=radius*radius;if(line.length===1)return p.distSqr(line[0])<radiusSquared;for(let i=1;i<line.length;i++){const v=line[i-1],w=line[i];if(distToSegmentSquared(p,v,w)<radiusSquared)return true}return false}function distToSegmentSquared(p,v,w){const l2=v.distSqr(w);if(l2===0)return p.distSqr(v);const t=((p.x-v.x)*(w.x-v.x)+(p.y-v.y)*(w.y-v.y))/l2;if(t<0)return p.distSqr(v);if(t>1)return p.distSqr(w);return p.distSqr(w.sub(v)._mult(t)._add(v))}function multiPolygonContainsPoint(rings,p){let c=false,ring,p1,p2;for(let k=0;k<rings.length;k++){ring=rings[k];for(let i=0,j=ring.length-1;i<ring.length;j=i++){p1=ring[i];p2=ring[j];if(p1.y>p.y!==p2.y>p.y&&p.x<(p2.x-p1.x)*(p.y-p1.y)/(p2.y-p1.y)+p1.x){c=!c}}}return c}function polygonContainsPoint(ring,p){let c=false;for(let i=0,j=ring.length-1;i<ring.length;j=i++){const p1=ring[i];const p2=ring[j];if(p1.y>p.y!==p2.y>p.y&&p.x<(p2.x-p1.x)*(p.y-p1.y)/(p2.y-p1.y)+p1.x){c=!c}}return c}function polygonIntersectsBox(ring,boxX1,boxY1,boxX2,boxY2){for(const p of ring){if(boxX1<=p.x&&boxY1<=p.y&&boxX2>=p.x&&boxY2>=p.y)return true}const corners=[new Point$2(boxX1,boxY1),new Point$2(boxX1,boxY2),new Point$2(boxX2,boxY2),new Point$2(boxX2,boxY1)];if(ring.length>2){for(const corner of corners){if(polygonContainsPoint(ring,corner))return true}}for(let i=0;i<ring.length-1;i++){const p1=ring[i];const p2=ring[i+1];if(edgeIntersectsBox(p1,p2,corners))return true}return false}function edgeIntersectsBox(e1,e2,corners){const tl=corners[0];const br=corners[2];if(e1.x<tl.x&&e2.x<tl.x||e1.x>br.x&&e2.x>br.x||e1.y<tl.y&&e2.y<tl.y||e1.y>br.y&&e2.y>br.y)return false;const dir=isCounterClockwise(e1,e2,corners[0]);return dir!==isCounterClockwise(e1,e2,corners[1])||dir!==isCounterClockwise(e1,e2,corners[2])||dir!==isCounterClockwise(e1,e2,corners[3])}function getMaximumPaintValue(property,layer,bucket){const value=layer.paint.get(property).value;if(value.kind==="constant"){return value.value}else{return bucket.programConfigurations.get(layer.id).getMaxValue(property)}}function translateDistance(translate){return Math.sqrt(translate[0]*translate[0]+translate[1]*translate[1])}function translate$4(queryGeometry,translate,translateAnchor,bearing,pixelsToTileUnits){if(!translate[0]&&!translate[1]){return queryGeometry}const pt=Point$2.convert(translate)._mult(pixelsToTileUnits);if(translateAnchor==="viewport"){pt._rotate(-bearing)}const translated=[];for(let i=0;i<queryGeometry.length;i++){const point=queryGeometry[i];translated.push(point.sub(pt))}return translated}function offsetLine(rings,offset){const newRings=[];for(let ringIndex=0;ringIndex<rings.length;ringIndex++){const ring=rings[ringIndex];const newRing=[];for(let index=0;index<ring.length;index++){const a=ring[index-1];const b=ring[index];const c=ring[index+1];const aToB=index===0?new Point$2(0,0):b.sub(a)._unit()._perp();const bToC=index===ring.length-1?new Point$2(0,0):c.sub(b)._unit()._perp();const extrude=aToB._add(bToC)._unit();const cosHalfAngle=extrude.x*bToC.x+extrude.y*bToC.y;if(cosHalfAngle!==0){extrude._mult(1/cosHalfAngle)}newRing.push(extrude._mult(offset)._add(b))}newRings.push(newRing)}return newRings}let layout$5;const getLayout$3=()=>layout$5=layout$5||new Properties({"circle-sort-key":new DataDrivenProperty(v8Spec["layout_circle"]["circle-sort-key"])});let paint$8;const getPaint$8=()=>paint$8=paint$8||new Properties({"circle-radius":new DataDrivenProperty(v8Spec["paint_circle"]["circle-radius"]),"circle-color":new DataDrivenProperty(v8Spec["paint_circle"]["circle-color"]),"circle-blur":new DataDrivenProperty(v8Spec["paint_circle"]["circle-blur"]),"circle-opacity":new DataDrivenProperty(v8Spec["paint_circle"]["circle-opacity"]),"circle-translate":new DataConstantProperty(v8Spec["paint_circle"]["circle-translate"]),"circle-translate-anchor":new DataConstantProperty(v8Spec["paint_circle"]["circle-translate-anchor"]),"circle-pitch-scale":new DataConstantProperty(v8Spec["paint_circle"]["circle-pitch-scale"]),"circle-pitch-alignment":new DataConstantProperty(v8Spec["paint_circle"]["circle-pitch-alignment"]),"circle-stroke-width":new DataDrivenProperty(v8Spec["paint_circle"]["circle-stroke-width"]),"circle-stroke-color":new DataDrivenProperty(v8Spec["paint_circle"]["circle-stroke-color"]),"circle-stroke-opacity":new DataDrivenProperty(v8Spec["paint_circle"]["circle-stroke-opacity"])});var properties$8={get paint(){return getPaint$8()},get layout(){return getLayout$3()}};var EPSILON=1e-6;var ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array;var RANDOM=Math.random;function setMatrixArrayType(type){ARRAY_TYPE=type}var degree=Math.PI/180;function toRadian(a){return a*degree}function equals$a(a,b){return Math.abs(a-b)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(b))}if(!Math.hypot)Math.hypot=function(){var y=0,i=arguments.length;while(i--){y+=arguments[i]*arguments[i]}return Math.sqrt(y)};var common=Object.freeze({__proto__:null,get ARRAY_TYPE(){return ARRAY_TYPE},EPSILON:EPSILON,RANDOM:RANDOM,equals:equals$a,setMatrixArrayType:setMatrixArrayType,toRadian:toRadian});function create$8(){var out=new ARRAY_TYPE(4);if(ARRAY_TYPE!=Float32Array){out[1]=0;out[2]=0}out[0]=1;out[3]=1;return out}function clone$8(a){var out=new ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out}function copy$8(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out}function identity$5(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out}function fromValues$8(m00,m01,m10,m11){var out=new ARRAY_TYPE(4);out[0]=m00;out[1]=m01;out[2]=m10;out[3]=m11;return out}function set$8(out,m00,m01,m10,m11){out[0]=m00;out[1]=m01;out[2]=m10;out[3]=m11;return out}function transpose$2(out,a){if(out===a){var a1=a[1];out[1]=a[2];out[2]=a1}else{out[0]=a[0];out[1]=a[2];out[2]=a[1];out[3]=a[3]}return out}function invert$5(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var det=a0*a3-a2*a1;if(!det){return null}det=1/det;out[0]=a3*det;out[1]=-a1*det;out[2]=-a2*det;out[3]=a0*det;return out}function adjoint$2(out,a){var a0=a[0];out[0]=a[3];out[1]=-a[1];out[2]=-a[2];out[3]=a0;return out}function determinant$3(a){return a[0]*a[3]-a[2]*a[1]}function multiply$8(out,a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=a0*b0+a2*b1;out[1]=a1*b0+a3*b1;out[2]=a0*b2+a2*b3;out[3]=a1*b2+a3*b3;return out}function rotate$4(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var s=Math.sin(rad);var c=Math.cos(rad);out[0]=a0*c+a2*s;out[1]=a1*c+a3*s;out[2]=a0*-s+a2*c;out[3]=a1*-s+a3*c;return out}function scale$8(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var v0=v[0],v1=v[1];out[0]=a0*v0;out[1]=a1*v0;out[2]=a2*v1;out[3]=a3*v1;return out}function fromRotation$4(out,rad){var s=Math.sin(rad);var c=Math.cos(rad);out[0]=c;out[1]=s;out[2]=-s;out[3]=c;return out}function fromScaling$3(out,v){out[0]=v[0];out[1]=0;out[2]=0;out[3]=v[1];return out}function str$8(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"}function frob$3(a){return Math.hypot(a[0],a[1],a[2],a[3])}function LDU(L,D,U,a){L[2]=a[2]/a[0];U[0]=a[0];U[1]=a[1];U[3]=a[3]-L[2]*U[1];return[L,D,U]}function add$8(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out}function subtract$6(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out}function exactEquals$8(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]}function equals$9(a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];return Math.abs(a0-b0)<=EPSILON*Math.max(1,Math.abs(a0),Math.abs(b0))&&Math.abs(a1-b1)<=EPSILON*Math.max(1,Math.abs(a1),Math.abs(b1))&&Math.abs(a2-b2)<=EPSILON*Math.max(1,Math.abs(a2),Math.abs(b2))&&Math.abs(a3-b3)<=EPSILON*Math.max(1,Math.abs(a3),Math.abs(b3))}function multiplyScalar$3(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out}function multiplyScalarAndAdd$3(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;return out}var mul$8=multiply$8;var sub$6=subtract$6;var mat2=Object.freeze({__proto__:null,LDU:LDU,add:add$8,adjoint:adjoint$2,clone:clone$8,copy:copy$8,create:create$8,determinant:determinant$3,equals:equals$9,exactEquals:exactEquals$8,frob:frob$3,fromRotation:fromRotation$4,fromScaling:fromScaling$3,fromValues:fromValues$8,identity:identity$5,invert:invert$5,mul:mul$8,multiply:multiply$8,multiplyScalar:multiplyScalar$3,multiplyScalarAndAdd:multiplyScalarAndAdd$3,rotate:rotate$4,scale:scale$8,set:set$8,str:str$8,sub:sub$6,subtract:subtract$6,transpose:transpose$2});function create$7(){var out=new ARRAY_TYPE(6);if(ARRAY_TYPE!=Float32Array){out[1]=0;out[2]=0;out[4]=0;out[5]=0}out[0]=1;out[3]=1;return out}function clone$7(a){var out=new ARRAY_TYPE(6);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out}function copy$7(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out}function identity$4(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;return out}function fromValues$7(a,b,c,d,tx,ty){var out=new ARRAY_TYPE(6);out[0]=a;out[1]=b;out[2]=c;out[3]=d;out[4]=tx;out[5]=ty;return out}function set$7(out,a,b,c,d,tx,ty){out[0]=a;out[1]=b;out[2]=c;out[3]=d;out[4]=tx;out[5]=ty;return out}function invert$4(out,a){var aa=a[0],ab=a[1],ac=a[2],ad=a[3];var atx=a[4],aty=a[5];var det=aa*ad-ab*ac;if(!det){return null}det=1/det;out[0]=ad*det;out[1]=-ab*det;out[2]=-ac*det;out[3]=aa*det;out[4]=(ac*aty-ad*atx)*det;out[5]=(ab*atx-aa*aty)*det;return out}function determinant$2(a){return a[0]*a[3]-a[1]*a[2]}function multiply$7(out,a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5];var b0=b[0],b1=b[1],b2=b[2],b3=b[3],b4=b[4],b5=b[5];out[0]=a0*b0+a2*b1;out[1]=a1*b0+a3*b1;out[2]=a0*b2+a2*b3;out[3]=a1*b2+a3*b3;out[4]=a0*b4+a2*b5+a4;out[5]=a1*b4+a3*b5+a5;return out}function rotate$3(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5];var s=Math.sin(rad);var c=Math.cos(rad);out[0]=a0*c+a2*s;out[1]=a1*c+a3*s;out[2]=a0*-s+a2*c;out[3]=a1*-s+a3*c;out[4]=a4;out[5]=a5;return out}function scale$7(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5];var v0=v[0],v1=v[1];out[0]=a0*v0;out[1]=a1*v0;out[2]=a2*v1;out[3]=a3*v1;out[4]=a4;out[5]=a5;return out}function translate$3(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5];var v0=v[0],v1=v[1];out[0]=a0;out[1]=a1;out[2]=a2;out[3]=a3;out[4]=a0*v0+a2*v1+a4;out[5]=a1*v0+a3*v1+a5;return out}function fromRotation$3(out,rad){var s=Math.sin(rad),c=Math.cos(rad);out[0]=c;out[1]=s;out[2]=-s;out[3]=c;out[4]=0;out[5]=0;return out}function fromScaling$2(out,v){out[0]=v[0];out[1]=0;out[2]=0;out[3]=v[1];out[4]=0;out[5]=0;return out}function fromTranslation$3(out,v){out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=v[0];out[5]=v[1];return out}function str$7(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"}function frob$2(a){return Math.hypot(a[0],a[1],a[2],a[3],a[4],a[5],1)}function add$7(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];out[4]=a[4]+b[4];out[5]=a[5]+b[5];return out}function subtract$5(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];out[4]=a[4]-b[4];out[5]=a[5]-b[5];return out}function multiplyScalar$2(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;out[4]=a[4]*b;out[5]=a[5]*b;return out}function multiplyScalarAndAdd$2(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;out[4]=a[4]+b[4]*scale;out[5]=a[5]+b[5]*scale;return out}function exactEquals$7(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]&&a[5]===b[5]}function equals$8(a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5];var b0=b[0],b1=b[1],b2=b[2],b3=b[3],b4=b[4],b5=b[5];return Math.abs(a0-b0)<=EPSILON*Math.max(1,Math.abs(a0),Math.abs(b0))&&Math.abs(a1-b1)<=EPSILON*Math.max(1,Math.abs(a1),Math.abs(b1))&&Math.abs(a2-b2)<=EPSILON*Math.max(1,Math.abs(a2),Math.abs(b2))&&Math.abs(a3-b3)<=EPSILON*Math.max(1,Math.abs(a3),Math.abs(b3))&&Math.abs(a4-b4)<=EPSILON*Math.max(1,Math.abs(a4),Math.abs(b4))&&Math.abs(a5-b5)<=EPSILON*Math.max(1,Math.abs(a5),Math.abs(b5))}var mul$7=multiply$7;var sub$5=subtract$5;var mat2d=Object.freeze({__proto__:null,add:add$7,clone:clone$7,copy:copy$7,create:create$7,determinant:determinant$2,equals:equals$8,exactEquals:exactEquals$7,frob:frob$2,fromRotation:fromRotation$3,fromScaling:fromScaling$2,fromTranslation:fromTranslation$3,fromValues:fromValues$7,identity:identity$4,invert:invert$4,mul:mul$7,multiply:multiply$7,multiplyScalar:multiplyScalar$2,multiplyScalarAndAdd:multiplyScalarAndAdd$2,rotate:rotate$3,scale:scale$7,set:set$7,str:str$7,sub:sub$5,subtract:subtract$5,translate:translate$3});function create$6(){var out=new ARRAY_TYPE(9);if(ARRAY_TYPE!=Float32Array){out[1]=0;out[2]=0;out[3]=0;out[5]=0;out[6]=0;out[7]=0}out[0]=1;out[4]=1;out[8]=1;return out}function fromMat4$1(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[4];out[4]=a[5];out[5]=a[6];out[6]=a[8];out[7]=a[9];out[8]=a[10];return out}function clone$6(a){var out=new ARRAY_TYPE(9);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out}function copy$6(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out}function fromValues$6(m00,m01,m02,m10,m11,m12,m20,m21,m22){var out=new ARRAY_TYPE(9);out[0]=m00;out[1]=m01;out[2]=m02;out[3]=m10;out[4]=m11;out[5]=m12;out[6]=m20;out[7]=m21;out[8]=m22;return out}function set$6(out,m00,m01,m02,m10,m11,m12,m20,m21,m22){out[0]=m00;out[1]=m01;out[2]=m02;out[3]=m10;out[4]=m11;out[5]=m12;out[6]=m20;out[7]=m21;out[8]=m22;return out}function identity$3(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out}function transpose$1(out,a){if(out===a){var a01=a[1],a02=a[2],a12=a[5];out[1]=a[3];out[2]=a[6];out[3]=a01;out[5]=a[7];out[6]=a02;out[7]=a12}else{out[0]=a[0];out[1]=a[3];out[2]=a[6];out[3]=a[1];out[4]=a[4];out[5]=a[7];out[6]=a[2];out[7]=a[5];out[8]=a[8]}return out}function invert$3(out,a){var a00=a[0],a01=a[1],a02=a[2];var a10=a[3],a11=a[4],a12=a[5];var a20=a[6],a21=a[7],a22=a[8];var b01=a22*a11-a12*a21;var b11=-a22*a10+a12*a20;var b21=a21*a10-a11*a20;var det=a00*b01+a01*b11+a02*b21;if(!det){return null}det=1/det;out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out}function adjoint$1(out,a){var a00=a[0],a01=a[1],a02=a[2];var a10=a[3],a11=a[4],a12=a[5];var a20=a[6],a21=a[7],a22=a[8];out[0]=a11*a22-a12*a21;out[1]=a02*a21-a01*a22;out[2]=a01*a12-a02*a11;out[3]=a12*a20-a10*a22;out[4]=a00*a22-a02*a20;out[5]=a02*a10-a00*a12;out[6]=a10*a21-a11*a20;out[7]=a01*a20-a00*a21;out[8]=a00*a11-a01*a10;return out}function determinant$1(a){var a00=a[0],a01=a[1],a02=a[2];var a10=a[3],a11=a[4],a12=a[5];var a20=a[6],a21=a[7],a22=a[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)}function multiply$6(out,a,b){var a00=a[0],a01=a[1],a02=a[2];var a10=a[3],a11=a[4],a12=a[5];var a20=a[6],a21=a[7],a22=a[8];var b00=b[0],b01=b[1],b02=b[2];var b10=b[3],b11=b[4],b12=b[5];var b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out}function translate$2(out,a,v){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],x=v[0],y=v[1];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a10;out[4]=a11;out[5]=a12;out[6]=x*a00+y*a10+a20;out[7]=x*a01+y*a11+a21;out[8]=x*a02+y*a12+a22;return out}function rotate$2(out,a,rad){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],s=Math.sin(rad),c=Math.cos(rad);out[0]=c*a00+s*a10;out[1]=c*a01+s*a11;out[2]=c*a02+s*a12;out[3]=c*a10-s*a00;out[4]=c*a11-s*a01;out[5]=c*a12-s*a02;out[6]=a20;out[7]=a21;out[8]=a22;return out}function scale$6(out,a,v){var x=v[0],y=v[1];out[0]=x*a[0];out[1]=x*a[1];out[2]=x*a[2];out[3]=y*a[3];out[4]=y*a[4];out[5]=y*a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out}function fromTranslation$2(out,v){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=v[0];out[7]=v[1];out[8]=1;return out}function fromRotation$2(out,rad){var s=Math.sin(rad),c=Math.cos(rad);out[0]=c;out[1]=s;out[2]=0;out[3]=-s;out[4]=c;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out}function fromScaling$1(out,v){out[0]=v[0];out[1]=0;out[2]=0;out[3]=0;out[4]=v[1];out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out}function fromMat2d(out,a){out[0]=a[0];out[1]=a[1];out[2]=0;out[3]=a[2];out[4]=a[3];out[5]=0;out[6]=a[4];out[7]=a[5];out[8]=1;return out}function fromQuat$1(out,q){var x=q[0],y=q[1],z=q[2],w=q[3];var x2=x+x;var y2=y+y;var z2=z+z;var xx=x*x2;var yx=y*x2;var yy=y*y2;var zx=z*x2;var zy=z*y2;var zz=z*z2;var wx=w*x2;var wy=w*y2;var wz=w*z2;out[0]=1-yy-zz;out[3]=yx-wz;out[6]=zx+wy;out[1]=yx+wz;out[4]=1-xx-zz;out[7]=zy-wx;out[2]=zx-wy;out[5]=zy+wx;out[8]=1-xx-yy;return out}function normalFromMat4(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a12*b08-a10*b11-a13*b07)*det;out[2]=(a10*b10-a11*b08+a13*b06)*det;out[3]=(a02*b10-a01*b11-a03*b09)*det;out[4]=(a00*b11-a02*b08+a03*b07)*det;out[5]=(a01*b08-a00*b10-a03*b06)*det;out[6]=(a31*b05-a32*b04+a33*b03)*det;out[7]=(a32*b02-a30*b05-a33*b01)*det;out[8]=(a30*b04-a31*b02+a33*b00)*det;return out}function projection(out,width,height){out[0]=2/width;out[1]=0;out[2]=0;out[3]=0;out[4]=-2/height;out[5]=0;out[6]=-1;out[7]=1;out[8]=1;return out}function str$6(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"}function frob$1(a){return Math.hypot(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])}function add$6(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];out[4]=a[4]+b[4];out[5]=a[5]+b[5];out[6]=a[6]+b[6];out[7]=a[7]+b[7];out[8]=a[8]+b[8];return out}function subtract$4(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];out[4]=a[4]-b[4];out[5]=a[5]-b[5];out[6]=a[6]-b[6];out[7]=a[7]-b[7];out[8]=a[8]-b[8];return out}function multiplyScalar$1(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;out[4]=a[4]*b;out[5]=a[5]*b;out[6]=a[6]*b;out[7]=a[7]*b;out[8]=a[8]*b;return out}function multiplyScalarAndAdd$1(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;out[4]=a[4]+b[4]*scale;out[5]=a[5]+b[5]*scale;out[6]=a[6]+b[6]*scale;out[7]=a[7]+b[7]*scale;out[8]=a[8]+b[8]*scale;return out}function exactEquals$6(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]&&a[5]===b[5]&&a[6]===b[6]&&a[7]===b[7]&&a[8]===b[8]}function equals$7(a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5],a6=a[6],a7=a[7],a8=a[8];var b0=b[0],b1=b[1],b2=b[2],b3=b[3],b4=b[4],b5=b[5],b6=b[6],b7=b[7],b8=b[8];return Math.abs(a0-b0)<=EPSILON*Math.max(1,Math.abs(a0),Math.abs(b0))&&Math.abs(a1-b1)<=EPSILON*Math.max(1,Math.abs(a1),Math.abs(b1))&&Math.abs(a2-b2)<=EPSILON*Math.max(1,Math.abs(a2),Math.abs(b2))&&Math.abs(a3-b3)<=EPSILON*Math.max(1,Math.abs(a3),Math.abs(b3))&&Math.abs(a4-b4)<=EPSILON*Math.max(1,Math.abs(a4),Math.abs(b4))&&Math.abs(a5-b5)<=EPSILON*Math.max(1,Math.abs(a5),Math.abs(b5))&&Math.abs(a6-b6)<=EPSILON*Math.max(1,Math.abs(a6),Math.abs(b6))&&Math.abs(a7-b7)<=EPSILON*Math.max(1,Math.abs(a7),Math.abs(b7))&&Math.abs(a8-b8)<=EPSILON*Math.max(1,Math.abs(a8),Math.abs(b8))}var mul$6=multiply$6;var sub$4=subtract$4;var mat3=Object.freeze({__proto__:null,add:add$6,adjoint:adjoint$1,clone:clone$6,copy:copy$6,create:create$6,determinant:determinant$1,equals:equals$7,exactEquals:exactEquals$6,frob:frob$1,fromMat2d:fromMat2d,fromMat4:fromMat4$1,fromQuat:fromQuat$1,fromRotation:fromRotation$2,fromScaling:fromScaling$1,fromTranslation:fromTranslation$2,fromValues:fromValues$6,identity:identity$3,invert:invert$3,mul:mul$6,multiply:multiply$6,multiplyScalar:multiplyScalar$1,multiplyScalarAndAdd:multiplyScalarAndAdd$1,normalFromMat4:normalFromMat4,projection:projection,rotate:rotate$2,scale:scale$6,set:set$6,str:str$6,sub:sub$4,subtract:subtract$4,translate:translate$2,transpose:transpose$1});function create$5(){var out=new ARRAY_TYPE(16);if(ARRAY_TYPE!=Float32Array){out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[11]=0;out[12]=0;out[13]=0;out[14]=0}out[0]=1;out[5]=1;out[10]=1;out[15]=1;return out}function clone$5(a){var out=new ARRAY_TYPE(16);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out}function copy$5(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out}function fromValues$5(m00,m01,m02,m03,m10,m11,m12,m13,m20,m21,m22,m23,m30,m31,m32,m33){var out=new ARRAY_TYPE(16);out[0]=m00;out[1]=m01;out[2]=m02;out[3]=m03;out[4]=m10;out[5]=m11;out[6]=m12;out[7]=m13;out[8]=m20;out[9]=m21;out[10]=m22;out[11]=m23;out[12]=m30;out[13]=m31;out[14]=m32;out[15]=m33;return out}function set$5(out,m00,m01,m02,m03,m10,m11,m12,m13,m20,m21,m22,m23,m30,m31,m32,m33){out[0]=m00;out[1]=m01;out[2]=m02;out[3]=m03;out[4]=m10;out[5]=m11;out[6]=m12;out[7]=m13;out[8]=m20;out[9]=m21;out[10]=m22;out[11]=m23;out[12]=m30;out[13]=m31;out[14]=m32;out[15]=m33;return out}function identity$2(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out}function transpose(out,a){if(out===a){var a01=a[1],a02=a[2],a03=a[3];var a12=a[6],a13=a[7];var a23=a[11];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a01;out[6]=a[9];out[7]=a[13];out[8]=a02;out[9]=a12;out[11]=a[14];out[12]=a03;out[13]=a13;out[14]=a23}else{out[0]=a[0];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a[1];out[5]=a[5];out[6]=a[9];out[7]=a[13];out[8]=a[2];out[9]=a[6];out[10]=a[10];out[11]=a[14];out[12]=a[3];out[13]=a[7];out[14]=a[11];out[15]=a[15]}return out}function invert$2(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out}function adjoint(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];out[0]=a11*(a22*a33-a23*a32)-a21*(a12*a33-a13*a32)+a31*(a12*a23-a13*a22);out[1]=-(a01*(a22*a33-a23*a32)-a21*(a02*a33-a03*a32)+a31*(a02*a23-a03*a22));out[2]=a01*(a12*a33-a13*a32)-a11*(a02*a33-a03*a32)+a31*(a02*a13-a03*a12);out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12));out[4]=-(a10*(a22*a33-a23*a32)-a20*(a12*a33-a13*a32)+a30*(a12*a23-a13*a22));out[5]=a00*(a22*a33-a23*a32)-a20*(a02*a33-a03*a32)+a30*(a02*a23-a03*a22);out[6]=-(a00*(a12*a33-a13*a32)-a10*(a02*a33-a03*a32)+a30*(a02*a13-a03*a12));out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12);out[8]=a10*(a21*a33-a23*a31)-a20*(a11*a33-a13*a31)+a30*(a11*a23-a13*a21);out[9]=-(a00*(a21*a33-a23*a31)-a20*(a01*a33-a03*a31)+a30*(a01*a23-a03*a21));out[10]=a00*(a11*a33-a13*a31)-a10*(a01*a33-a03*a31)+a30*(a01*a13-a03*a11);out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11));out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21));out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21);out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11));out[15]=a00*(a11*a22-a12*a21)-a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11);return out}function determinant(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;return b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06}function multiply$5(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out}function translate$1(out,a,v){var x=v[0],y=v[1],z=v[2];var a00,a01,a02,a03;var a10,a11,a12,a13;var a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15]}return out}function scale$5(out,a,v){var x=v[0],y=v[1],z=v[2];out[0]=a[0]*x;out[1]=a[1]*x;out[2]=a[2]*x;out[3]=a[3]*x;out[4]=a[4]*y;out[5]=a[5]*y;out[6]=a[6]*y;out[7]=a[7]*y;out[8]=a[8]*z;out[9]=a[9]*z;out[10]=a[10]*z;out[11]=a[11]*z;out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out}function rotate$1(out,a,rad,axis){var x=axis[0],y=axis[1],z=axis[2];var len=Math.hypot(x,y,z);var s,c,t;var a00,a01,a02,a03;var a10,a11,a12,a13;var a20,a21,a22,a23;var b00,b01,b02;var b10,b11,b12;var b20,b21,b22;if(len<EPSILON){return null}len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b22=z*z*t+c;out[0]=a00*b00+a10*b01+a20*b02;out[1]=a01*b00+a11*b01+a21*b02;out[2]=a02*b00+a12*b01+a22*b02;out[3]=a03*b00+a13*b01+a23*b02;out[4]=a00*b10+a10*b11+a20*b12;out[5]=a01*b10+a11*b11+a21*b12;out[6]=a02*b10+a12*b11+a22*b12;out[7]=a03*b10+a13*b11+a23*b12;out[8]=a00*b20+a10*b21+a20*b22;out[9]=a01*b20+a11*b21+a21*b22;out[10]=a02*b20+a12*b21+a22*b22;out[11]=a03*b20+a13*b21+a23*b22;if(a!==out){out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}return out}function rotateX$3(out,a,rad){var s=Math.sin(rad);var c=Math.cos(rad);var a10=a[4];var a11=a[5];var a12=a[6];var a13=a[7];var a20=a[8];var a21=a[9];var a22=a[10];var a23=a[11];if(a!==out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[4]=a10*c+a20*s;out[5]=a11*c+a21*s;out[6]=a12*c+a22*s;out[7]=a13*c+a23*s;out[8]=a20*c-a10*s;out[9]=a21*c-a11*s;out[10]=a22*c-a12*s;out[11]=a23*c-a13*s;return out}function rotateY$3(out,a,rad){var s=Math.sin(rad);var c=Math.cos(rad);var a00=a[0];var a01=a[1];var a02=a[2];var a03=a[3];var a20=a[8];var a21=a[9];var a22=a[10];var a23=a[11];if(a!==out){out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c-a20*s;out[1]=a01*c-a21*s;out[2]=a02*c-a22*s;out[3]=a03*c-a23*s;out[8]=a00*s+a20*c;out[9]=a01*s+a21*c;out[10]=a02*s+a22*c;out[11]=a03*s+a23*c;return out}function rotateZ$3(out,a,rad){var s=Math.sin(rad);var c=Math.cos(rad);var a00=a[0];var a01=a[1];var a02=a[2];var a03=a[3];var a10=a[4];var a11=a[5];var a12=a[6];var a13=a[7];if(a!==out){out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c+a10*s;out[1]=a01*c+a11*s;out[2]=a02*c+a12*s;out[3]=a03*c+a13*s;out[4]=a10*c-a00*s;out[5]=a11*c-a01*s;out[6]=a12*c-a02*s;out[7]=a13*c-a03*s;return out}function fromTranslation$1(out,v){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out}function fromScaling(out,v){out[0]=v[0];out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=v[1];out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=v[2];out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out}function fromRotation$1(out,rad,axis){var x=axis[0],y=axis[1],z=axis[2];var len=Math.hypot(x,y,z);var s,c,t;if(len<EPSILON){return null}len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;out[0]=x*x*t+c;out[1]=y*x*t+z*s;out[2]=z*x*t-y*s;out[3]=0;out[4]=x*y*t-z*s;out[5]=y*y*t+c;out[6]=z*y*t+x*s;out[7]=0;out[8]=x*z*t+y*s;out[9]=y*z*t-x*s;out[10]=z*z*t+c;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out}function fromXRotation(out,rad){var s=Math.sin(rad);var c=Math.cos(rad);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=c;out[6]=s;out[7]=0;out[8]=0;out[9]=-s;out[10]=c;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out}function fromYRotation(out,rad){var s=Math.sin(rad);var c=Math.cos(rad);out[0]=c;out[1]=0;out[2]=-s;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=s;out[9]=0;out[10]=c;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out}function fromZRotation(out,rad){var s=Math.sin(rad);var c=Math.cos(rad);out[0]=c;out[1]=s;out[2]=0;out[3]=0;out[4]=-s;out[5]=c;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out}function fromRotationTranslation$1(out,q,v){var x=q[0],y=q[1],z=q[2],w=q[3];var x2=x+x;var y2=y+y;var z2=z+z;var xx=x*x2;var xy=x*y2;var xz=x*z2;var yy=y*y2;var yz=y*z2;var zz=z*z2;var wx=w*x2;var wy=w*y2;var wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out}function fromQuat2(out,a){var translation=new ARRAY_TYPE(3);var bx=-a[0],by=-a[1],bz=-a[2],bw=a[3],ax=a[4],ay=a[5],az=a[6],aw=a[7];var magnitude=bx*bx+by*by+bz*bz+bw*bw;if(magnitude>0){translation[0]=(ax*bw+aw*bx+ay*bz-az*by)*2/magnitude;translation[1]=(ay*bw+aw*by+az*bx-ax*bz)*2/magnitude;translation[2]=(az*bw+aw*bz+ax*by-ay*bx)*2/magnitude}else{translation[0]=(ax*bw+aw*bx+ay*bz-az*by)*2;translation[1]=(ay*bw+aw*by+az*bx-ax*bz)*2;translation[2]=(az*bw+aw*bz+ax*by-ay*bx)*2}fromRotationTranslation$1(out,a,translation);return out}function getTranslation$1(out,mat){out[0]=mat[12];out[1]=mat[13];out[2]=mat[14];return out}function getScaling(out,mat){var m11=mat[0];var m12=mat[1];var m13=mat[2];var m21=mat[4];var m22=mat[5];var m23=mat[6];var m31=mat[8];var m32=mat[9];var m33=mat[10];out[0]=Math.hypot(m11,m12,m13);out[1]=Math.hypot(m21,m22,m23);out[2]=Math.hypot(m31,m32,m33);return out}function getRotation(out,mat){var scaling=new ARRAY_TYPE(3);getScaling(scaling,mat);var is1=1/scaling[0];var is2=1/scaling[1];var is3=1/scaling[2];var sm11=mat[0]*is1;var sm12=mat[1]*is2;var sm13=mat[2]*is3;var sm21=mat[4]*is1;var sm22=mat[5]*is2;var sm23=mat[6]*is3;var sm31=mat[8]*is1;var sm32=mat[9]*is2;var sm33=mat[10]*is3;var trace=sm11+sm22+sm33;var S=0;if(trace>0){S=Math.sqrt(trace+1)*2;out[3]=.25*S;out[0]=(sm23-sm32)/S;out[1]=(sm31-sm13)/S;out[2]=(sm12-sm21)/S}else if(sm11>sm22&&sm11>sm33){S=Math.sqrt(1+sm11-sm22-sm33)*2;out[3]=(sm23-sm32)/S;out[0]=.25*S;out[1]=(sm12+sm21)/S;out[2]=(sm31+sm13)/S}else if(sm22>sm33){S=Math.sqrt(1+sm22-sm11-sm33)*2;out[3]=(sm31-sm13)/S;out[0]=(sm12+sm21)/S;out[1]=.25*S;out[2]=(sm23+sm32)/S}else{S=Math.sqrt(1+sm33-sm11-sm22)*2;out[3]=(sm12-sm21)/S;out[0]=(sm31+sm13)/S;out[1]=(sm23+sm32)/S;out[2]=.25*S}return out}function fromRotationTranslationScale(out,q,v,s){var x=q[0],y=q[1],z=q[2],w=q[3];var x2=x+x;var y2=y+y;var z2=z+z;var xx=x*x2;var xy=x*y2;var xz=x*z2;var yy=y*y2;var yz=y*z2;var zz=z*z2;var wx=w*x2;var wy=w*y2;var wz=w*z2;var sx=s[0];var sy=s[1];var sz=s[2];out[0]=(1-(yy+zz))*sx;out[1]=(xy+wz)*sx;out[2]=(xz-wy)*sx;out[3]=0;out[4]=(xy-wz)*sy;out[5]=(1-(xx+zz))*sy;out[6]=(yz+wx)*sy;out[7]=0;out[8]=(xz+wy)*sz;out[9]=(yz-wx)*sz;out[10]=(1-(xx+yy))*sz;out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out}function fromRotationTranslationScaleOrigin(out,q,v,s,o){var x=q[0],y=q[1],z=q[2],w=q[3];var x2=x+x;var y2=y+y;var z2=z+z;var xx=x*x2;var xy=x*y2;var xz=x*z2;var yy=y*y2;var yz=y*z2;var zz=z*z2;var wx=w*x2;var wy=w*y2;var wz=w*z2;var sx=s[0];var sy=s[1];var sz=s[2];var ox=o[0];var oy=o[1];var oz=o[2];var out0=(1-(yy+zz))*sx;var out1=(xy+wz)*sx;var out2=(xz-wy)*sx;var out4=(xy-wz)*sy;var out5=(1-(xx+zz))*sy;var out6=(yz+wx)*sy;var out8=(xz+wy)*sz;var out9=(yz-wx)*sz;var out10=(1-(xx+yy))*sz;out[0]=out0;out[1]=out1;out[2]=out2;out[3]=0;out[4]=out4;out[5]=out5;out[6]=out6;out[7]=0;out[8]=out8;out[9]=out9;out[10]=out10;out[11]=0;out[12]=v[0]+ox-(out0*ox+out4*oy+out8*oz);out[13]=v[1]+oy-(out1*ox+out5*oy+out9*oz);out[14]=v[2]+oz-(out2*ox+out6*oy+out10*oz);out[15]=1;return out}function fromQuat(out,q){var x=q[0],y=q[1],z=q[2],w=q[3];var x2=x+x;var y2=y+y;var z2=z+z;var xx=x*x2;var yx=y*x2;var yy=y*y2;var zx=z*x2;var zy=z*y2;var zz=z*z2;var wx=w*x2;var wy=w*y2;var wz=w*z2;out[0]=1-yy-zz;out[1]=yx+wz;out[2]=zx-wy;out[3]=0;out[4]=yx-wz;out[5]=1-xx-zz;out[6]=zy+wx;out[7]=0;out[8]=zx+wy;out[9]=zy-wx;out[10]=1-xx-yy;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out}function frustum(out,left,right,bottom,top,near,far){var rl=1/(right-left);var tb=1/(top-bottom);var nf=1/(near-far);out[0]=near*2*rl;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=near*2*tb;out[6]=0;out[7]=0;out[8]=(right+left)*rl;out[9]=(top+bottom)*tb;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near*2*nf;out[15]=0;return out}function perspectiveNO(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2),nf;out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[11]=-1;out[12]=0;out[13]=0;out[15]=0;if(far!=null&&far!==Infinity){nf=1/(near-far);out[10]=(far+near)*nf;out[14]=2*far*near*nf}else{out[10]=-1;out[14]=-2*near}return out}var perspective=perspectiveNO;function perspectiveZO(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2),nf;out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[11]=-1;out[12]=0;out[13]=0;out[15]=0;if(far!=null&&far!==Infinity){nf=1/(near-far);out[10]=far*nf;out[14]=far*near*nf}else{out[10]=-1;out[14]=-near}return out}function perspectiveFromFieldOfView(out,fov,near,far){var upTan=Math.tan(fov.upDegrees*Math.PI/180);var downTan=Math.tan(fov.downDegrees*Math.PI/180);var leftTan=Math.tan(fov.leftDegrees*Math.PI/180);var rightTan=Math.tan(fov.rightDegrees*Math.PI/180);var xScale=2/(leftTan+rightTan);var yScale=2/(upTan+downTan);out[0]=xScale;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=yScale;out[6]=0;out[7]=0;out[8]=-((leftTan-rightTan)*xScale*.5);out[9]=(upTan-downTan)*yScale*.5;out[10]=far/(near-far);out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near/(near-far);out[15]=0;return out}function orthoNO(out,left,right,bottom,top,near,far){var lr=1/(left-right);var bt=1/(bottom-top);var nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=2*nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=(far+near)*nf;out[15]=1;return out}var ortho=orthoNO;function orthoZO(out,left,right,bottom,top,near,far){var lr=1/(left-right);var bt=1/(bottom-top);var nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=near*nf;out[15]=1;return out}function lookAt(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len;var eyex=eye[0];var eyey=eye[1];var eyez=eye[2];var upx=up[0];var upy=up[1];var upz=up[2];var centerx=center[0];var centery=center[1];var centerz=center[2];if(Math.abs(eyex-centerx)<EPSILON&&Math.abs(eyey-centery)<EPSILON&&Math.abs(eyez-centerz)<EPSILON){return identity$2(out)}z0=eyex-centerx;z1=eyey-centery;z2=eyez-centerz;len=1/Math.hypot(z0,z1,z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.hypot(x0,x1,x2);if(!len){x0=0;x1=0;x2=0}else{len=1/len;x0*=len;x1*=len;x2*=len}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.hypot(y0,y1,y2);if(!len){y0=0;y1=0;y2=0}else{len=1/len;y0*=len;y1*=len;y2*=len}out[0]=x0;out[1]=y0;out[2]=z0;out[3]=0;out[4]=x1;out[5]=y1;out[6]=z1;out[7]=0;out[8]=x2;out[9]=y2;out[10]=z2;out[11]=0;out[12]=-(x0*eyex+x1*eyey+x2*eyez);out[13]=-(y0*eyex+y1*eyey+y2*eyez);out[14]=-(z0*eyex+z1*eyey+z2*eyez);out[15]=1;return out}function targetTo(out,eye,target,up){var eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2];var z0=eyex-target[0],z1=eyey-target[1],z2=eyez-target[2];var len=z0*z0+z1*z1+z2*z2;if(len>0){len=1/Math.sqrt(len);z0*=len;z1*=len;z2*=len}var x0=upy*z2-upz*z1,x1=upz*z0-upx*z2,x2=upx*z1-upy*z0;len=x0*x0+x1*x1+x2*x2;if(len>0){len=1/Math.sqrt(len);x0*=len;x1*=len;x2*=len}out[0]=x0;out[1]=x1;out[2]=x2;out[3]=0;out[4]=z1*x2-z2*x1;out[5]=z2*x0-z0*x2;out[6]=z0*x1-z1*x0;out[7]=0;out[8]=z0;out[9]=z1;out[10]=z2;out[11]=0;out[12]=eyex;out[13]=eyey;out[14]=eyez;out[15]=1;return out}function str$5(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"}function frob(a){return Math.hypot(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15])}function add$5(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];out[4]=a[4]+b[4];out[5]=a[5]+b[5];out[6]=a[6]+b[6];out[7]=a[7]+b[7];out[8]=a[8]+b[8];out[9]=a[9]+b[9];out[10]=a[10]+b[10];out[11]=a[11]+b[11];out[12]=a[12]+b[12];out[13]=a[13]+b[13];out[14]=a[14]+b[14];out[15]=a[15]+b[15];return out}function subtract$3(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];out[4]=a[4]-b[4];out[5]=a[5]-b[5];out[6]=a[6]-b[6];out[7]=a[7]-b[7];out[8]=a[8]-b[8];out[9]=a[9]-b[9];out[10]=a[10]-b[10];out[11]=a[11]-b[11];out[12]=a[12]-b[12];out[13]=a[13]-b[13];out[14]=a[14]-b[14];out[15]=a[15]-b[15];return out}function multiplyScalar(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;out[4]=a[4]*b;out[5]=a[5]*b;out[6]=a[6]*b;out[7]=a[7]*b;out[8]=a[8]*b;out[9]=a[9]*b;out[10]=a[10]*b;out[11]=a[11]*b;out[12]=a[12]*b;out[13]=a[13]*b;out[14]=a[14]*b;out[15]=a[15]*b;return out}function multiplyScalarAndAdd(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;out[4]=a[4]+b[4]*scale;out[5]=a[5]+b[5]*scale;out[6]=a[6]+b[6]*scale;out[7]=a[7]+b[7]*scale;out[8]=a[8]+b[8]*scale;out[9]=a[9]+b[9]*scale;out[10]=a[10]+b[10]*scale;out[11]=a[11]+b[11]*scale;out[12]=a[12]+b[12]*scale;out[13]=a[13]+b[13]*scale;out[14]=a[14]+b[14]*scale;out[15]=a[15]+b[15]*scale;return out}function exactEquals$5(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]&&a[5]===b[5]&&a[6]===b[6]&&a[7]===b[7]&&a[8]===b[8]&&a[9]===b[9]&&a[10]===b[10]&&a[11]===b[11]&&a[12]===b[12]&&a[13]===b[13]&&a[14]===b[14]&&a[15]===b[15]}function equals$6(a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var a4=a[4],a5=a[5],a6=a[6],a7=a[7];var a8=a[8],a9=a[9],a10=a[10],a11=a[11];var a12=a[12],a13=a[13],a14=a[14],a15=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];var b4=b[4],b5=b[5],b6=b[6],b7=b[7];var b8=b[8],b9=b[9],b10=b[10],b11=b[11];var b12=b[12],b13=b[13],b14=b[14],b15=b[15];return Math.abs(a0-b0)<=EPSILON*Math.max(1,Math.abs(a0),Math.abs(b0))&&Math.abs(a1-b1)<=EPSILON*Math.max(1,Math.abs(a1),Math.abs(b1))&&Math.abs(a2-b2)<=EPSILON*Math.max(1,Math.abs(a2),Math.abs(b2))&&Math.abs(a3-b3)<=EPSILON*Math.max(1,Math.abs(a3),Math.abs(b3))&&Math.abs(a4-b4)<=EPSILON*Math.max(1,Math.abs(a4),Math.abs(b4))&&Math.abs(a5-b5)<=EPSILON*Math.max(1,Math.abs(a5),Math.abs(b5))&&Math.abs(a6-b6)<=EPSILON*Math.max(1,Math.abs(a6),Math.abs(b6))&&Math.abs(a7-b7)<=EPSILON*Math.max(1,Math.abs(a7),Math.abs(b7))&&Math.abs(a8-b8)<=EPSILON*Math.max(1,Math.abs(a8),Math.abs(b8))&&Math.abs(a9-b9)<=EPSILON*Math.max(1,Math.abs(a9),Math.abs(b9))&&Math.abs(a10-b10)<=EPSILON*Math.max(1,Math.abs(a10),Math.abs(b10))&&Math.abs(a11-b11)<=EPSILON*Math.max(1,Math.abs(a11),Math.abs(b11))&&Math.abs(a12-b12)<=EPSILON*Math.max(1,Math.abs(a12),Math.abs(b12))&&Math.abs(a13-b13)<=EPSILON*Math.max(1,Math.abs(a13),Math.abs(b13))&&Math.abs(a14-b14)<=EPSILON*Math.max(1,Math.abs(a14),Math.abs(b14))&&Math.abs(a15-b15)<=EPSILON*Math.max(1,Math.abs(a15),Math.abs(b15))}var mul$5=multiply$5;var sub$3=subtract$3;var mat4=Object.freeze({__proto__:null,add:add$5,adjoint:adjoint,clone:clone$5,copy:copy$5,create:create$5,determinant:determinant,equals:equals$6,exactEquals:exactEquals$5,frob:frob,fromQuat:fromQuat,fromQuat2:fromQuat2,fromRotation:fromRotation$1,fromRotationTranslation:fromRotationTranslation$1,fromRotationTranslationScale:fromRotationTranslationScale,fromRotationTranslationScaleOrigin:fromRotationTranslationScaleOrigin,fromScaling:fromScaling,fromTranslation:fromTranslation$1,fromValues:fromValues$5,fromXRotation:fromXRotation,fromYRotation:fromYRotation,fromZRotation:fromZRotation,frustum:frustum,getRotation:getRotation,getScaling:getScaling,getTranslation:getTranslation$1,identity:identity$2,invert:invert$2,lookAt:lookAt,mul:mul$5,multiply:multiply$5,multiplyScalar:multiplyScalar,multiplyScalarAndAdd:multiplyScalarAndAdd,ortho:ortho,orthoNO:orthoNO,orthoZO:orthoZO,perspective:perspective,perspectiveFromFieldOfView:perspectiveFromFieldOfView,perspectiveNO:perspectiveNO,perspectiveZO:perspectiveZO,rotate:rotate$1,rotateX:rotateX$3,rotateY:rotateY$3,rotateZ:rotateZ$3,scale:scale$5,set:set$5,str:str$5,sub:sub$3,subtract:subtract$3,targetTo:targetTo,translate:translate$1,transpose:transpose});function create$4(){var out=new ARRAY_TYPE(3);if(ARRAY_TYPE!=Float32Array){out[0]=0;out[1]=0;out[2]=0}return out}function clone$4(a){var out=new ARRAY_TYPE(3);out[0]=a[0];out[1]=a[1];out[2]=a[2];return out}function length$4(a){var x=a[0];var y=a[1];var z=a[2];return Math.hypot(x,y,z)}function fromValues$4(x,y,z){var out=new ARRAY_TYPE(3);out[0]=x;out[1]=y;out[2]=z;return out}function copy$4(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out}function set$4(out,x,y,z){out[0]=x;out[1]=y;out[2]=z;return out}function add$4(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out}function subtract$2(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out}function multiply$4(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out}function divide$2(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];return out}function ceil$2(out,a){out[0]=Math.ceil(a[0]);out[1]=Math.ceil(a[1]);out[2]=Math.ceil(a[2]);return out}function floor$2(out,a){out[0]=Math.floor(a[0]);out[1]=Math.floor(a[1]);out[2]=Math.floor(a[2]);return out}function min$2(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);return out}function max$2(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);return out}function round$2(out,a){out[0]=Math.round(a[0]);out[1]=Math.round(a[1]);out[2]=Math.round(a[2]);return out}function scale$4(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;return out}function scaleAndAdd$2(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;return out}function distance$2(a,b){var x=b[0]-a[0];var y=b[1]-a[1];var z=b[2]-a[2];return Math.hypot(x,y,z)}function squaredDistance$2(a,b){var x=b[0]-a[0];var y=b[1]-a[1];var z=b[2]-a[2];return x*x+y*y+z*z}function squaredLength$4(a){var x=a[0];var y=a[1];var z=a[2];return x*x+y*y+z*z}function negate$2(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];return out}function inverse$2(out,a){out[0]=1/a[0];out[1]=1/a[1];out[2]=1/a[2];return out}function normalize$4(out,a){var x=a[0];var y=a[1];var z=a[2];var len=x*x+y*y+z*z;if(len>0){len=1/Math.sqrt(len)}out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len;return out}function dot$5(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]}function cross$2(out,a,b){var ax=a[0],ay=a[1],az=a[2];var bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out}function lerp$4(out,a,b,t){var ax=a[0];var ay=a[1];var az=a[2];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);return out}function hermite(out,a,b,c,d,t){var factorTimes2=t*t;var factor1=factorTimes2*(2*t-3)+1;var factor2=factorTimes2*(t-2)+t;var factor3=factorTimes2*(t-1);var factor4=factorTimes2*(3-2*t);out[0]=a[0]*factor1+b[0]*factor2+c[0]*factor3+d[0]*factor4;out[1]=a[1]*factor1+b[1]*factor2+c[1]*factor3+d[1]*factor4;out[2]=a[2]*factor1+b[2]*factor2+c[2]*factor3+d[2]*factor4;return out}function bezier(out,a,b,c,d,t){var inverseFactor=1-t;var inverseFactorTimesTwo=inverseFactor*inverseFactor;var factorTimes2=t*t;var factor1=inverseFactorTimesTwo*inverseFactor;var factor2=3*t*inverseFactorTimesTwo;var factor3=3*factorTimes2*inverseFactor;var factor4=factorTimes2*t;out[0]=a[0]*factor1+b[0]*factor2+c[0]*factor3+d[0]*factor4;out[1]=a[1]*factor1+b[1]*factor2+c[1]*factor3+d[1]*factor4;out[2]=a[2]*factor1+b[2]*factor2+c[2]*factor3+d[2]*factor4;return out}function random$3(out,scale){scale=scale||1;var r=RANDOM()*2*Math.PI;var z=RANDOM()*2-1;var zScale=Math.sqrt(1-z*z)*scale;out[0]=Math.cos(r)*zScale;out[1]=Math.sin(r)*zScale;out[2]=z*scale;return out}function transformMat4$2(out,a,m){var x=a[0],y=a[1],z=a[2];var w=m[3]*x+m[7]*y+m[11]*z+m[15];w=w||1;out[0]=(m[0]*x+m[4]*y+m[8]*z+m[12])/w;out[1]=(m[1]*x+m[5]*y+m[9]*z+m[13])/w;out[2]=(m[2]*x+m[6]*y+m[10]*z+m[14])/w;return out}function transformMat3$1(out,a,m){var x=a[0],y=a[1],z=a[2];out[0]=x*m[0]+y*m[3]+z*m[6];out[1]=x*m[1]+y*m[4]+z*m[7];out[2]=x*m[2]+y*m[5]+z*m[8];return out}function transformQuat$1(out,a,q){var qx=q[0],qy=q[1],qz=q[2],qw=q[3];var x=a[0],y=a[1],z=a[2];var uvx=qy*z-qz*y,uvy=qz*x-qx*z,uvz=qx*y-qy*x;var uuvx=qy*uvz-qz*uvy,uuvy=qz*uvx-qx*uvz,uuvz=qx*uvy-qy*uvx;var w2=qw*2;uvx*=w2;uvy*=w2;uvz*=w2;uuvx*=2;uuvy*=2;uuvz*=2;out[0]=x+uvx+uuvx;out[1]=y+uvy+uuvy;out[2]=z+uvz+uuvz;return out}function rotateX$2(out,a,b,rad){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0];r[1]=p[1]*Math.cos(rad)-p[2]*Math.sin(rad);r[2]=p[1]*Math.sin(rad)+p[2]*Math.cos(rad);out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out}function rotateY$2(out,a,b,rad){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[2]*Math.sin(rad)+p[0]*Math.cos(rad);r[1]=p[1];r[2]=p[2]*Math.cos(rad)-p[0]*Math.sin(rad);out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out}function rotateZ$2(out,a,b,rad){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0]*Math.cos(rad)-p[1]*Math.sin(rad);r[1]=p[0]*Math.sin(rad)+p[1]*Math.cos(rad);r[2]=p[2];out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out}function angle$1(a,b){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2],mag1=Math.sqrt(ax*ax+ay*ay+az*az),mag2=Math.sqrt(bx*bx+by*by+bz*bz),mag=mag1*mag2,cosine=mag&&dot$5(a,b)/mag;return Math.acos(Math.min(Math.max(cosine,-1),1))}function zero$2(out){out[0]=0;out[1]=0;out[2]=0;return out}function str$4(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"}function exactEquals$4(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]}function equals$5(a,b){var a0=a[0],a1=a[1],a2=a[2];var b0=b[0],b1=b[1],b2=b[2];return Math.abs(a0-b0)<=EPSILON*Math.max(1,Math.abs(a0),Math.abs(b0))&&Math.abs(a1-b1)<=EPSILON*Math.max(1,Math.abs(a1),Math.abs(b1))&&Math.abs(a2-b2)<=EPSILON*Math.max(1,Math.abs(a2),Math.abs(b2))}var sub$2=subtract$2;var mul$4=multiply$4;var div$2=divide$2;var dist$2=distance$2;var sqrDist$2=squaredDistance$2;var len$4=length$4;var sqrLen$4=squaredLength$4;var forEach$2=function(){var vec=create$4();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=3}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2]}return a}}();var vec3=Object.freeze({__proto__:null,add:add$4,angle:angle$1,bezier:bezier,ceil:ceil$2,clone:clone$4,copy:copy$4,create:create$4,cross:cross$2,dist:dist$2,distance:distance$2,div:div$2,divide:divide$2,dot:dot$5,equals:equals$5,exactEquals:exactEquals$4,floor:floor$2,forEach:forEach$2,fromValues:fromValues$4,hermite:hermite,inverse:inverse$2,len:len$4,length:length$4,lerp:lerp$4,max:max$2,min:min$2,mul:mul$4,multiply:multiply$4,negate:negate$2,normalize:normalize$4,random:random$3,rotateX:rotateX$2,rotateY:rotateY$2,rotateZ:rotateZ$2,round:round$2,scale:scale$4,scaleAndAdd:scaleAndAdd$2,set:set$4,sqrDist:sqrDist$2,sqrLen:sqrLen$4,squaredDistance:squaredDistance$2,squaredLength:squaredLength$4,str:str$4,sub:sub$2,subtract:subtract$2,transformMat3:transformMat3$1,transformMat4:transformMat4$2,transformQuat:transformQuat$1,zero:zero$2});function create$3(){var out=new ARRAY_TYPE(4);if(ARRAY_TYPE!=Float32Array){out[0]=0;out[1]=0;out[2]=0;out[3]=0}return out}function clone$3(a){var out=new ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out}function fromValues$3(x,y,z,w){var out=new ARRAY_TYPE(4);out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out}function copy$3(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out}function set$3(out,x,y,z,w){out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out}function add$3(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out}function subtract$1(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out}function multiply$3(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];out[3]=a[3]*b[3];return out}function divide$1(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];out[3]=a[3]/b[3];return out}function ceil$1(out,a){out[0]=Math.ceil(a[0]);out[1]=Math.ceil(a[1]);out[2]=Math.ceil(a[2]);out[3]=Math.ceil(a[3]);return out}function floor$1(out,a){out[0]=Math.floor(a[0]);out[1]=Math.floor(a[1]);out[2]=Math.floor(a[2]);out[3]=Math.floor(a[3]);return out}function min$1(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);out[3]=Math.min(a[3],b[3]);return out}function max$1(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);out[3]=Math.max(a[3],b[3]);return out}function round$1(out,a){out[0]=Math.round(a[0]);out[1]=Math.round(a[1]);out[2]=Math.round(a[2]);out[3]=Math.round(a[3]);return out}function scale$3(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out}function scaleAndAdd$1(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;return out}function distance$1(a,b){var x=b[0]-a[0];var y=b[1]-a[1];var z=b[2]-a[2];var w=b[3]-a[3];return Math.hypot(x,y,z,w)}function squaredDistance$1(a,b){var x=b[0]-a[0];var y=b[1]-a[1];var z=b[2]-a[2];var w=b[3]-a[3];return x*x+y*y+z*z+w*w}function length$3(a){var x=a[0];var y=a[1];var z=a[2];var w=a[3];return Math.hypot(x,y,z,w)}function squaredLength$3(a){var x=a[0];var y=a[1];var z=a[2];var w=a[3];return x*x+y*y+z*z+w*w}function negate$1(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=-a[3];return out}function inverse$1(out,a){out[0]=1/a[0];out[1]=1/a[1];out[2]=1/a[2];out[3]=1/a[3];return out}function normalize$3(out,a){var x=a[0];var y=a[1];var z=a[2];var w=a[3];var len=x*x+y*y+z*z+w*w;if(len>0){len=1/Math.sqrt(len)}out[0]=x*len;out[1]=y*len;out[2]=z*len;out[3]=w*len;return out}function dot$4(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]}function cross$1(out,u,v,w){var A=v[0]*w[1]-v[1]*w[0],B=v[0]*w[2]-v[2]*w[0],C=v[0]*w[3]-v[3]*w[0],D=v[1]*w[2]-v[2]*w[1],E=v[1]*w[3]-v[3]*w[1],F=v[2]*w[3]-v[3]*w[2];var G=u[0];var H=u[1];var I=u[2];var J=u[3];out[0]=H*F-I*E+J*D;out[1]=-(G*F)+I*C-J*B;out[2]=G*E-H*C+J*A;out[3]=-(G*D)+H*B-I*A;return out}function lerp$3(out,a,b,t){var ax=a[0];var ay=a[1];var az=a[2];var aw=a[3];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);out[3]=aw+t*(b[3]-aw);return out}function random$2(out,scale){scale=scale||1;var v1,v2,v3,v4;var s1,s2;do{v1=RANDOM()*2-1;v2=RANDOM()*2-1;s1=v1*v1+v2*v2}while(s1>=1);do{v3=RANDOM()*2-1;v4=RANDOM()*2-1;s2=v3*v3+v4*v4}while(s2>=1);var d=Math.sqrt((1-s1)/s2);out[0]=scale*v1;out[1]=scale*v2;out[2]=scale*v3*d;out[3]=scale*v4*d;return out}function transformMat4$1(out,a,m){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out}function transformQuat(out,a,q){var x=a[0],y=a[1],z=a[2];var qx=q[0],qy=q[1],qz=q[2],qw=q[3];var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;out[3]=a[3];return out}function zero$1(out){out[0]=0;out[1]=0;out[2]=0;out[3]=0;return out}function str$3(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"}function exactEquals$3(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]}function equals$4(a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];return Math.abs(a0-b0)<=EPSILON*Math.max(1,Math.abs(a0),Math.abs(b0))&&Math.abs(a1-b1)<=EPSILON*Math.max(1,Math.abs(a1),Math.abs(b1))&&Math.abs(a2-b2)<=EPSILON*Math.max(1,Math.abs(a2),Math.abs(b2))&&Math.abs(a3-b3)<=EPSILON*Math.max(1,Math.abs(a3),Math.abs(b3))}var sub$1=subtract$1;var mul$3=multiply$3;var div$1=divide$1;var dist$1=distance$1;var sqrDist$1=squaredDistance$1;var len$3=length$3;var sqrLen$3=squaredLength$3;var forEach$1=function(){var vec=create$3();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=4}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];vec[3]=a[i+3];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2];a[i+3]=vec[3]}return a}}();var vec4=Object.freeze({__proto__:null,add:add$3,ceil:ceil$1,clone:clone$3,copy:copy$3,create:create$3,cross:cross$1,dist:dist$1,distance:distance$1,div:div$1,divide:divide$1,dot:dot$4,equals:equals$4,exactEquals:exactEquals$3,floor:floor$1,forEach:forEach$1,fromValues:fromValues$3,inverse:inverse$1,len:len$3,length:length$3,lerp:lerp$3,max:max$1,min:min$1,mul:mul$3,multiply:multiply$3,negate:negate$1,normalize:normalize$3,random:random$2,round:round$1,scale:scale$3,scaleAndAdd:scaleAndAdd$1,set:set$3,sqrDist:sqrDist$1,sqrLen:sqrLen$3,squaredDistance:squaredDistance$1,squaredLength:squaredLength$3,str:str$3,sub:sub$1,subtract:subtract$1,transformMat4:transformMat4$1,transformQuat:transformQuat,zero:zero$1});function create$2(){var out=new ARRAY_TYPE(4);if(ARRAY_TYPE!=Float32Array){out[0]=0;out[1]=0;out[2]=0}out[3]=1;return out}function identity$1(out){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out}function setAxisAngle(out,axis,rad){rad=rad*.5;var s=Math.sin(rad);out[0]=s*axis[0];out[1]=s*axis[1];out[2]=s*axis[2];out[3]=Math.cos(rad);return out}function getAxisAngle(out_axis,q){var rad=Math.acos(q[3])*2;var s=Math.sin(rad/2);if(s>EPSILON){out_axis[0]=q[0]/s;out_axis[1]=q[1]/s;out_axis[2]=q[2]/s}else{out_axis[0]=1;out_axis[1]=0;out_axis[2]=0}return rad}function getAngle(a,b){var dotproduct=dot$3(a,b);return Math.acos(2*dotproduct*dotproduct-1)}function multiply$2(out,a,b){var ax=a[0],ay=a[1],az=a[2],aw=a[3];var bx=b[0],by=b[1],bz=b[2],bw=b[3];out[0]=ax*bw+aw*bx+ay*bz-az*by;out[1]=ay*bw+aw*by+az*bx-ax*bz;out[2]=az*bw+aw*bz+ax*by-ay*bx;out[3]=aw*bw-ax*bx-ay*by-az*bz;return out}function rotateX$1(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3];var bx=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+aw*bx;out[1]=ay*bw+az*bx;out[2]=az*bw-ay*bx;out[3]=aw*bw-ax*bx;return out}function rotateY$1(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3];var by=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw-az*by;out[1]=ay*bw+aw*by;out[2]=az*bw+ax*by;out[3]=aw*bw-ay*by;return out}function rotateZ$1(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3];var bz=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+ay*bz;out[1]=ay*bw-ax*bz;out[2]=az*bw+aw*bz;out[3]=aw*bw-az*bz;return out}function calculateW(out,a){var x=a[0],y=a[1],z=a[2];out[0]=x;out[1]=y;out[2]=z;out[3]=Math.sqrt(Math.abs(1-x*x-y*y-z*z));return out}function exp(out,a){var x=a[0],y=a[1],z=a[2],w=a[3];var r=Math.sqrt(x*x+y*y+z*z);var et=Math.exp(w);var s=r>0?et*Math.sin(r)/r:0;out[0]=x*s;out[1]=y*s;out[2]=z*s;out[3]=et*Math.cos(r);return out}function ln(out,a){var x=a[0],y=a[1],z=a[2],w=a[3];var r=Math.sqrt(x*x+y*y+z*z);var t=r>0?Math.atan2(r,w)/r:0;out[0]=x*t;out[1]=y*t;out[2]=z*t;out[3]=.5*Math.log(x*x+y*y+z*z+w*w);return out}function pow(out,a,b){ln(out,a);scale$2(out,out,b);exp(out,out);return out}function slerp(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3];var bx=b[0],by=b[1],bz=b[2],bw=b[3];var omega,cosom,sinom,scale0,scale1;cosom=ax*bx+ay*by+az*bz+aw*bw;if(cosom<0){cosom=-cosom;bx=-bx;by=-by;bz=-bz;bw=-bw}if(1-cosom>EPSILON){omega=Math.acos(cosom);sinom=Math.sin(omega);scale0=Math.sin((1-t)*omega)/sinom;scale1=Math.sin(t*omega)/sinom}else{scale0=1-t;scale1=t}out[0]=scale0*ax+scale1*bx;out[1]=scale0*ay+scale1*by;out[2]=scale0*az+scale1*bz;out[3]=scale0*aw+scale1*bw;return out}function random$1(out){var u1=RANDOM();var u2=RANDOM();var u3=RANDOM();var sqrt1MinusU1=Math.sqrt(1-u1);var sqrtU1=Math.sqrt(u1);out[0]=sqrt1MinusU1*Math.sin(2*Math.PI*u2);out[1]=sqrt1MinusU1*Math.cos(2*Math.PI*u2);out[2]=sqrtU1*Math.sin(2*Math.PI*u3);out[3]=sqrtU1*Math.cos(2*Math.PI*u3);return out}function invert$1(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var dot=a0*a0+a1*a1+a2*a2+a3*a3;var invDot=dot?1/dot:0;out[0]=-a0*invDot;out[1]=-a1*invDot;out[2]=-a2*invDot;out[3]=a3*invDot;return out}function conjugate$1(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=a[3];return out}function fromMat3(out,m){var fTrace=m[0]+m[4]+m[8];var fRoot;if(fTrace>0){fRoot=Math.sqrt(fTrace+1);out[3]=.5*fRoot;fRoot=.5/fRoot;out[0]=(m[5]-m[7])*fRoot;out[1]=(m[6]-m[2])*fRoot;out[2]=(m[1]-m[3])*fRoot}else{var i=0;if(m[4]>m[0])i=1;if(m[8]>m[i*3+i])i=2;var j=(i+1)%3;var k=(i+2)%3;fRoot=Math.sqrt(m[i*3+i]-m[j*3+j]-m[k*3+k]+1);out[i]=.5*fRoot;fRoot=.5/fRoot;out[3]=(m[j*3+k]-m[k*3+j])*fRoot;out[j]=(m[j*3+i]+m[i*3+j])*fRoot;out[k]=(m[k*3+i]+m[i*3+k])*fRoot}return out}function fromEuler(out,x,y,z){var halfToRad=.5*Math.PI/180;x*=halfToRad;y*=halfToRad;z*=halfToRad;var sx=Math.sin(x);var cx=Math.cos(x);var sy=Math.sin(y);var cy=Math.cos(y);var sz=Math.sin(z);var cz=Math.cos(z);out[0]=sx*cy*cz-cx*sy*sz;out[1]=cx*sy*cz+sx*cy*sz;out[2]=cx*cy*sz-sx*sy*cz;out[3]=cx*cy*cz+sx*sy*sz;return out}function str$2(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"}var clone$2=clone$3;var fromValues$2=fromValues$3;var copy$2=copy$3;var set$2=set$3;var add$2=add$3;var mul$2=multiply$2;var scale$2=scale$3;var dot$3=dot$4;var lerp$2=lerp$3;var length$2=length$3;var len$2=length$2;var squaredLength$2=squaredLength$3;var sqrLen$2=squaredLength$2;var normalize$2=normalize$3;var exactEquals$2=exactEquals$3;var equals$3=equals$4;var rotationTo=function(){var tmpvec3=create$4();var xUnitVec3=fromValues$4(1,0,0);var yUnitVec3=fromValues$4(0,1,0);return function(out,a,b){var dot=dot$5(a,b);if(dot<-.999999){cross$2(tmpvec3,xUnitVec3,a);if(len$4(tmpvec3)<1e-6)cross$2(tmpvec3,yUnitVec3,a);normalize$4(tmpvec3,tmpvec3);setAxisAngle(out,tmpvec3,Math.PI);return out}else if(dot>.999999){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out}else{cross$2(tmpvec3,a,b);out[0]=tmpvec3[0];out[1]=tmpvec3[1];out[2]=tmpvec3[2];out[3]=1+dot;return normalize$2(out,out)}}}();var sqlerp=function(){var temp1=create$2();var temp2=create$2();return function(out,a,b,c,d,t){slerp(temp1,a,d,t);slerp(temp2,b,c,t);slerp(out,temp1,temp2,2*t*(1-t));return out}}();var setAxes=function(){var matr=create$6();return function(out,view,right,up){matr[0]=right[0];matr[3]=right[1];matr[6]=right[2];matr[1]=up[0];matr[4]=up[1];matr[7]=up[2];matr[2]=-view[0];matr[5]=-view[1];matr[8]=-view[2];return normalize$2(out,fromMat3(out,matr))}}();var quat=Object.freeze({__proto__:null,add:add$2,calculateW:calculateW,clone:clone$2,conjugate:conjugate$1,copy:copy$2,create:create$2,dot:dot$3,equals:equals$3,exactEquals:exactEquals$2,exp:exp,fromEuler:fromEuler,fromMat3:fromMat3,fromValues:fromValues$2,getAngle:getAngle,getAxisAngle:getAxisAngle,identity:identity$1,invert:invert$1,len:len$2,length:length$2,lerp:lerp$2,ln:ln,mul:mul$2,multiply:multiply$2,normalize:normalize$2,pow:pow,random:random$1,rotateX:rotateX$1,rotateY:rotateY$1,rotateZ:rotateZ$1,rotationTo:rotationTo,scale:scale$2,set:set$2,setAxes:setAxes,setAxisAngle:setAxisAngle,slerp:slerp,sqlerp:sqlerp,sqrLen:sqrLen$2,squaredLength:squaredLength$2,str:str$2});function create$1(){var dq=new ARRAY_TYPE(8);if(ARRAY_TYPE!=Float32Array){dq[0]=0;dq[1]=0;dq[2]=0;dq[4]=0;dq[5]=0;dq[6]=0;dq[7]=0}dq[3]=1;return dq}function clone$1(a){var dq=new ARRAY_TYPE(8);dq[0]=a[0];dq[1]=a[1];dq[2]=a[2];dq[3]=a[3];dq[4]=a[4];dq[5]=a[5];dq[6]=a[6];dq[7]=a[7];return dq}function fromValues$1(x1,y1,z1,w1,x2,y2,z2,w2){var dq=new ARRAY_TYPE(8);dq[0]=x1;dq[1]=y1;dq[2]=z1;dq[3]=w1;dq[4]=x2;dq[5]=y2;dq[6]=z2;dq[7]=w2;return dq}function fromRotationTranslationValues(x1,y1,z1,w1,x2,y2,z2){var dq=new ARRAY_TYPE(8);dq[0]=x1;dq[1]=y1;dq[2]=z1;dq[3]=w1;var ax=x2*.5,ay=y2*.5,az=z2*.5;dq[4]=ax*w1+ay*z1-az*y1;dq[5]=ay*w1+az*x1-ax*z1;dq[6]=az*w1+ax*y1-ay*x1;dq[7]=-ax*x1-ay*y1-az*z1;return dq}function fromRotationTranslation(out,q,t){var ax=t[0]*.5,ay=t[1]*.5,az=t[2]*.5,bx=q[0],by=q[1],bz=q[2],bw=q[3];out[0]=bx;out[1]=by;out[2]=bz;out[3]=bw;out[4]=ax*bw+ay*bz-az*by;out[5]=ay*bw+az*bx-ax*bz;out[6]=az*bw+ax*by-ay*bx;out[7]=-ax*bx-ay*by-az*bz;return out}function fromTranslation(out,t){out[0]=0;out[1]=0;out[2]=0;out[3]=1;out[4]=t[0]*.5;out[5]=t[1]*.5;out[6]=t[2]*.5;out[7]=0;return out}function fromRotation(out,q){out[0]=q[0];out[1]=q[1];out[2]=q[2];out[3]=q[3];out[4]=0;out[5]=0;out[6]=0;out[7]=0;return out}function fromMat4(out,a){var outer=create$2();getRotation(outer,a);var t=new ARRAY_TYPE(3);getTranslation$1(t,a);fromRotationTranslation(out,outer,t);return out}function copy$1(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];return out}function identity(out){out[0]=0;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;out[6]=0;out[7]=0;return out}function set$1(out,x1,y1,z1,w1,x2,y2,z2,w2){out[0]=x1;out[1]=y1;out[2]=z1;out[3]=w1;out[4]=x2;out[5]=y2;out[6]=z2;out[7]=w2;return out}var getReal=copy$2;function getDual(out,a){out[0]=a[4];out[1]=a[5];out[2]=a[6];out[3]=a[7];return out}var setReal=copy$2;function setDual(out,q){out[4]=q[0];out[5]=q[1];out[6]=q[2];out[7]=q[3];return out}function getTranslation(out,a){var ax=a[4],ay=a[5],az=a[6],aw=a[7],bx=-a[0],by=-a[1],bz=-a[2],bw=a[3];out[0]=(ax*bw+aw*bx+ay*bz-az*by)*2;out[1]=(ay*bw+aw*by+az*bx-ax*bz)*2;out[2]=(az*bw+aw*bz+ax*by-ay*bx)*2;return out}function translate(out,a,v){var ax1=a[0],ay1=a[1],az1=a[2],aw1=a[3],bx1=v[0]*.5,by1=v[1]*.5,bz1=v[2]*.5,ax2=a[4],ay2=a[5],az2=a[6],aw2=a[7];out[0]=ax1;out[1]=ay1;out[2]=az1;out[3]=aw1;out[4]=aw1*bx1+ay1*bz1-az1*by1+ax2;out[5]=aw1*by1+az1*bx1-ax1*bz1+ay2;out[6]=aw1*bz1+ax1*by1-ay1*bx1+az2;out[7]=-ax1*bx1-ay1*by1-az1*bz1+aw2;return out}function rotateX(out,a,rad){var bx=-a[0],by=-a[1],bz=-a[2],bw=a[3],ax=a[4],ay=a[5],az=a[6],aw=a[7],ax1=ax*bw+aw*bx+ay*bz-az*by,ay1=ay*bw+aw*by+az*bx-ax*bz,az1=az*bw+aw*bz+ax*by-ay*bx,aw1=aw*bw-ax*bx-ay*by-az*bz;rotateX$1(out,a,rad);bx=out[0];by=out[1];bz=out[2];bw=out[3];out[4]=ax1*bw+aw1*bx+ay1*bz-az1*by;out[5]=ay1*bw+aw1*by+az1*bx-ax1*bz;out[6]=az1*bw+aw1*bz+ax1*by-ay1*bx;out[7]=aw1*bw-ax1*bx-ay1*by-az1*bz;return out}function rotateY(out,a,rad){var bx=-a[0],by=-a[1],bz=-a[2],bw=a[3],ax=a[4],ay=a[5],az=a[6],aw=a[7],ax1=ax*bw+aw*bx+ay*bz-az*by,ay1=ay*bw+aw*by+az*bx-ax*bz,az1=az*bw+aw*bz+ax*by-ay*bx,aw1=aw*bw-ax*bx-ay*by-az*bz;rotateY$1(out,a,rad);bx=out[0];by=out[1];bz=out[2];bw=out[3];out[4]=ax1*bw+aw1*bx+ay1*bz-az1*by;out[5]=ay1*bw+aw1*by+az1*bx-ax1*bz;out[6]=az1*bw+aw1*bz+ax1*by-ay1*bx;out[7]=aw1*bw-ax1*bx-ay1*by-az1*bz;return out}function rotateZ(out,a,rad){var bx=-a[0],by=-a[1],bz=-a[2],bw=a[3],ax=a[4],ay=a[5],az=a[6],aw=a[7],ax1=ax*bw+aw*bx+ay*bz-az*by,ay1=ay*bw+aw*by+az*bx-ax*bz,az1=az*bw+aw*bz+ax*by-ay*bx,aw1=aw*bw-ax*bx-ay*by-az*bz;rotateZ$1(out,a,rad);bx=out[0];by=out[1];bz=out[2];bw=out[3];out[4]=ax1*bw+aw1*bx+ay1*bz-az1*by;out[5]=ay1*bw+aw1*by+az1*bx-ax1*bz;out[6]=az1*bw+aw1*bz+ax1*by-ay1*bx;out[7]=aw1*bw-ax1*bx-ay1*by-az1*bz;return out}function rotateByQuatAppend(out,a,q){var qx=q[0],qy=q[1],qz=q[2],qw=q[3],ax=a[0],ay=a[1],az=a[2],aw=a[3];out[0]=ax*qw+aw*qx+ay*qz-az*qy;out[1]=ay*qw+aw*qy+az*qx-ax*qz;out[2]=az*qw+aw*qz+ax*qy-ay*qx;out[3]=aw*qw-ax*qx-ay*qy-az*qz;ax=a[4];ay=a[5];az=a[6];aw=a[7];out[4]=ax*qw+aw*qx+ay*qz-az*qy;out[5]=ay*qw+aw*qy+az*qx-ax*qz;out[6]=az*qw+aw*qz+ax*qy-ay*qx;out[7]=aw*qw-ax*qx-ay*qy-az*qz;return out}function rotateByQuatPrepend(out,q,a){var qx=q[0],qy=q[1],qz=q[2],qw=q[3],bx=a[0],by=a[1],bz=a[2],bw=a[3];out[0]=qx*bw+qw*bx+qy*bz-qz*by;out[1]=qy*bw+qw*by+qz*bx-qx*bz;out[2]=qz*bw+qw*bz+qx*by-qy*bx;out[3]=qw*bw-qx*bx-qy*by-qz*bz;bx=a[4];by=a[5];bz=a[6];bw=a[7];out[4]=qx*bw+qw*bx+qy*bz-qz*by;out[5]=qy*bw+qw*by+qz*bx-qx*bz;out[6]=qz*bw+qw*bz+qx*by-qy*bx;out[7]=qw*bw-qx*bx-qy*by-qz*bz;return out}function rotateAroundAxis(out,a,axis,rad){if(Math.abs(rad)<EPSILON){return copy$1(out,a)}var axisLength=Math.hypot(axis[0],axis[1],axis[2]);rad=rad*.5;var s=Math.sin(rad);var bx=s*axis[0]/axisLength;var by=s*axis[1]/axisLength;var bz=s*axis[2]/axisLength;var bw=Math.cos(rad);var ax1=a[0],ay1=a[1],az1=a[2],aw1=a[3];out[0]=ax1*bw+aw1*bx+ay1*bz-az1*by;out[1]=ay1*bw+aw1*by+az1*bx-ax1*bz;out[2]=az1*bw+aw1*bz+ax1*by-ay1*bx;out[3]=aw1*bw-ax1*bx-ay1*by-az1*bz;var ax=a[4],ay=a[5],az=a[6],aw=a[7];out[4]=ax*bw+aw*bx+ay*bz-az*by;out[5]=ay*bw+aw*by+az*bx-ax*bz;out[6]=az*bw+aw*bz+ax*by-ay*bx;out[7]=aw*bw-ax*bx-ay*by-az*bz;return out}function add$1(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];out[4]=a[4]+b[4];out[5]=a[5]+b[5];out[6]=a[6]+b[6];out[7]=a[7]+b[7];return out}function multiply$1(out,a,b){var ax0=a[0],ay0=a[1],az0=a[2],aw0=a[3],bx1=b[4],by1=b[5],bz1=b[6],bw1=b[7],ax1=a[4],ay1=a[5],az1=a[6],aw1=a[7],bx0=b[0],by0=b[1],bz0=b[2],bw0=b[3];out[0]=ax0*bw0+aw0*bx0+ay0*bz0-az0*by0;out[1]=ay0*bw0+aw0*by0+az0*bx0-ax0*bz0;out[2]=az0*bw0+aw0*bz0+ax0*by0-ay0*bx0;out[3]=aw0*bw0-ax0*bx0-ay0*by0-az0*bz0;out[4]=ax0*bw1+aw0*bx1+ay0*bz1-az0*by1+ax1*bw0+aw1*bx0+ay1*bz0-az1*by0;out[5]=ay0*bw1+aw0*by1+az0*bx1-ax0*bz1+ay1*bw0+aw1*by0+az1*bx0-ax1*bz0;out[6]=az0*bw1+aw0*bz1+ax0*by1-ay0*bx1+az1*bw0+aw1*bz0+ax1*by0-ay1*bx0;out[7]=aw0*bw1-ax0*bx1-ay0*by1-az0*bz1+aw1*bw0-ax1*bx0-ay1*by0-az1*bz0;return out}var mul$1=multiply$1;function scale$1(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;out[4]=a[4]*b;out[5]=a[5]*b;out[6]=a[6]*b;out[7]=a[7]*b;return out}var dot$2=dot$3;function lerp$1(out,a,b,t){var mt=1-t;if(dot$2(a,b)<0)t=-t;out[0]=a[0]*mt+b[0]*t;out[1]=a[1]*mt+b[1]*t;out[2]=a[2]*mt+b[2]*t;out[3]=a[3]*mt+b[3]*t;out[4]=a[4]*mt+b[4]*t;out[5]=a[5]*mt+b[5]*t;out[6]=a[6]*mt+b[6]*t;out[7]=a[7]*mt+b[7]*t;return out}function invert(out,a){var sqlen=squaredLength$1(a);out[0]=-a[0]/sqlen;out[1]=-a[1]/sqlen;out[2]=-a[2]/sqlen;out[3]=a[3]/sqlen;out[4]=-a[4]/sqlen;out[5]=-a[5]/sqlen;out[6]=-a[6]/sqlen;out[7]=a[7]/sqlen;return out}function conjugate(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=a[3];out[4]=-a[4];out[5]=-a[5];out[6]=-a[6];out[7]=a[7];return out}var length$1=length$2;var len$1=length$1;var squaredLength$1=squaredLength$2;var sqrLen$1=squaredLength$1;function normalize$1(out,a){var magnitude=squaredLength$1(a);if(magnitude>0){magnitude=Math.sqrt(magnitude);var a0=a[0]/magnitude;var a1=a[1]/magnitude;var a2=a[2]/magnitude;var a3=a[3]/magnitude;var b0=a[4];var b1=a[5];var b2=a[6];var b3=a[7];var a_dot_b=a0*b0+a1*b1+a2*b2+a3*b3;out[0]=a0;out[1]=a1;out[2]=a2;out[3]=a3;out[4]=(b0-a0*a_dot_b)/magnitude;out[5]=(b1-a1*a_dot_b)/magnitude;out[6]=(b2-a2*a_dot_b)/magnitude;out[7]=(b3-a3*a_dot_b)/magnitude}return out}function str$1(a){return"quat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+")"}function exactEquals$1(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]&&a[5]===b[5]&&a[6]===b[6]&&a[7]===b[7]}function equals$2(a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5],a6=a[6],a7=a[7];var b0=b[0],b1=b[1],b2=b[2],b3=b[3],b4=b[4],b5=b[5],b6=b[6],b7=b[7];return Math.abs(a0-b0)<=EPSILON*Math.max(1,Math.abs(a0),Math.abs(b0))&&Math.abs(a1-b1)<=EPSILON*Math.max(1,Math.abs(a1),Math.abs(b1))&&Math.abs(a2-b2)<=EPSILON*Math.max(1,Math.abs(a2),Math.abs(b2))&&Math.abs(a3-b3)<=EPSILON*Math.max(1,Math.abs(a3),Math.abs(b3))&&Math.abs(a4-b4)<=EPSILON*Math.max(1,Math.abs(a4),Math.abs(b4))&&Math.abs(a5-b5)<=EPSILON*Math.max(1,Math.abs(a5),Math.abs(b5))&&Math.abs(a6-b6)<=EPSILON*Math.max(1,Math.abs(a6),Math.abs(b6))&&Math.abs(a7-b7)<=EPSILON*Math.max(1,Math.abs(a7),Math.abs(b7))}var quat2=Object.freeze({__proto__:null,add:add$1,clone:clone$1,conjugate:conjugate,copy:copy$1,create:create$1,dot:dot$2,equals:equals$2,exactEquals:exactEquals$1,fromMat4:fromMat4,fromRotation:fromRotation,fromRotationTranslation:fromRotationTranslation,fromRotationTranslationValues:fromRotationTranslationValues,fromTranslation:fromTranslation,fromValues:fromValues$1,getDual:getDual,getReal:getReal,getTranslation:getTranslation,identity:identity,invert:invert,len:len$1,length:length$1,lerp:lerp$1,mul:mul$1,multiply:multiply$1,normalize:normalize$1,rotateAroundAxis:rotateAroundAxis,rotateByQuatAppend:rotateByQuatAppend,rotateByQuatPrepend:rotateByQuatPrepend,rotateX:rotateX,rotateY:rotateY,rotateZ:rotateZ,scale:scale$1,set:set$1,setDual:setDual,setReal:setReal,sqrLen:sqrLen$1,squaredLength:squaredLength$1,str:str$1,translate:translate});function create(){var out=new ARRAY_TYPE(2);if(ARRAY_TYPE!=Float32Array){out[0]=0;out[1]=0}return out}function clone(a){var out=new ARRAY_TYPE(2);out[0]=a[0];out[1]=a[1];return out}function fromValues(x,y){var out=new ARRAY_TYPE(2);out[0]=x;out[1]=y;return out}function copy(out,a){out[0]=a[0];out[1]=a[1];return out}function set(out,x,y){out[0]=x;out[1]=y;return out}function add(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];return out}function subtract(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];return out}function multiply(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];return out}function divide(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];return out}function ceil(out,a){out[0]=Math.ceil(a[0]);out[1]=Math.ceil(a[1]);return out}function floor(out,a){out[0]=Math.floor(a[0]);out[1]=Math.floor(a[1]);return out}function min(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);return out}function max(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);return out}function round(out,a){out[0]=Math.round(a[0]);out[1]=Math.round(a[1]);return out}function scale(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;return out}function scaleAndAdd(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;return out}function distance(a,b){var x=b[0]-a[0],y=b[1]-a[1];return Math.hypot(x,y)}function squaredDistance(a,b){var x=b[0]-a[0],y=b[1]-a[1];return x*x+y*y}function length(a){var x=a[0],y=a[1];return Math.hypot(x,y)}function squaredLength(a){var x=a[0],y=a[1];return x*x+y*y}function negate(out,a){out[0]=-a[0];out[1]=-a[1];return out}function inverse(out,a){out[0]=1/a[0];out[1]=1/a[1];return out}function normalize(out,a){var x=a[0],y=a[1];var len=x*x+y*y;if(len>0){len=1/Math.sqrt(len)}out[0]=a[0]*len;out[1]=a[1]*len;return out}function dot$1(a,b){return a[0]*b[0]+a[1]*b[1]}function cross(out,a,b){var z=a[0]*b[1]-a[1]*b[0];out[0]=out[1]=0;out[2]=z;return out}function lerp(out,a,b,t){var ax=a[0],ay=a[1];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);return out}function random(out,scale){scale=scale||1;var r=RANDOM()*2*Math.PI;out[0]=Math.cos(r)*scale;out[1]=Math.sin(r)*scale;return out}function transformMat2(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y;out[1]=m[1]*x+m[3]*y;return out}function transformMat2d(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y+m[4];out[1]=m[1]*x+m[3]*y+m[5];return out}function transformMat3(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[3]*y+m[6];out[1]=m[1]*x+m[4]*y+m[7];return out}function transformMat4(out,a,m){var x=a[0];var y=a[1];out[0]=m[0]*x+m[4]*y+m[12];out[1]=m[1]*x+m[5]*y+m[13];return out}function rotate(out,a,b,rad){var p0=a[0]-b[0],p1=a[1]-b[1],sinC=Math.sin(rad),cosC=Math.cos(rad);out[0]=p0*cosC-p1*sinC+b[0];out[1]=p0*sinC+p1*cosC+b[1];return out}function angle(a,b){var x1=a[0],y1=a[1],x2=b[0],y2=b[1],mag=Math.sqrt(x1*x1+y1*y1)*Math.sqrt(x2*x2+y2*y2),cosine=mag&&(x1*x2+y1*y2)/mag;return Math.acos(Math.min(Math.max(cosine,-1),1))}function zero(out){out[0]=0;out[1]=0;return out}function str(a){return"vec2("+a[0]+", "+a[1]+")"}function exactEquals(a,b){return a[0]===b[0]&&a[1]===b[1]}function equals$1(a,b){var a0=a[0],a1=a[1];var b0=b[0],b1=b[1];return Math.abs(a0-b0)<=EPSILON*Math.max(1,Math.abs(a0),Math.abs(b0))&&Math.abs(a1-b1)<=EPSILON*Math.max(1,Math.abs(a1),Math.abs(b1))}var len=length;var sub=subtract;var mul=multiply;var div=divide;var dist=distance;var sqrDist=squaredDistance;var sqrLen=squaredLength;var forEach=function(){var vec=create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=2}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1]}return a}}();var vec2=Object.freeze({__proto__:null,add:add,angle:angle,ceil:ceil,clone:clone,copy:copy,create:create,cross:cross,dist:dist,distance:distance,div:div,divide:divide,dot:dot$1,equals:equals$1,exactEquals:exactEquals,floor:floor,forEach:forEach,fromValues:fromValues,inverse:inverse,len:len,length:length,lerp:lerp,max:max,min:min,mul:mul,multiply:multiply,negate:negate,normalize:normalize,random:random,rotate:rotate,round:round,scale:scale,scaleAndAdd:scaleAndAdd,set:set,sqrDist:sqrDist,sqrLen:sqrLen,squaredDistance:squaredDistance,squaredLength:squaredLength,str:str,sub:sub,subtract:subtract,transformMat2:transformMat2,transformMat2d:transformMat2d,transformMat3:transformMat3,transformMat4:transformMat4,zero:zero});class CircleStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$8)}createBucket(parameters){return new CircleBucket(parameters)}queryRadius(bucket){const circleBucket=bucket;return getMaximumPaintValue("circle-radius",this,circleBucket)+getMaximumPaintValue("circle-stroke-width",this,circleBucket)+translateDistance(this.paint.get("circle-translate"))}queryIntersectsFeature(queryGeometry,feature,featureState,geometry,zoom,transform,pixelsToTileUnits,pixelPosMatrix){const translatedPolygon=translate$4(queryGeometry,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),transform.angle,pixelsToTileUnits);const radius=this.paint.get("circle-radius").evaluate(feature,featureState);const stroke=this.paint.get("circle-stroke-width").evaluate(feature,featureState);const size=radius+stroke;const alignWithMap=this.paint.get("circle-pitch-alignment")==="map";const transformedPolygon=alignWithMap?translatedPolygon:projectQueryGeometry$1(translatedPolygon,pixelPosMatrix);const transformedSize=alignWithMap?size*pixelsToTileUnits:size;for(const ring of geometry){for(const point of ring){const transformedPoint=alignWithMap?point:projectPoint(point,pixelPosMatrix);let adjustedSize=transformedSize;const projectedCenter=transformMat4$1([],[point.x,point.y,0,1],pixelPosMatrix);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"){adjustedSize*=projectedCenter[3]/transform.cameraToCenterDistance}else if(this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"){adjustedSize*=transform.cameraToCenterDistance/projectedCenter[3]}if(polygonIntersectsBufferedPoint(transformedPolygon,transformedPoint,adjustedSize))return true}}return false}}function projectPoint(p,pixelPosMatrix){const point=transformMat4$1([],[p.x,p.y,0,1],pixelPosMatrix);return new Point$2(point[0]/point[3],point[1]/point[3])}function projectQueryGeometry$1(queryGeometry,pixelPosMatrix){return queryGeometry.map((p=>projectPoint(p,pixelPosMatrix)))}class HeatmapBucket extends CircleBucket{}register("HeatmapBucket",HeatmapBucket,{omit:["layers"]});let paint$7;const getPaint$7=()=>paint$7=paint$7||new Properties({"heatmap-radius":new DataDrivenProperty(v8Spec["paint_heatmap"]["heatmap-radius"]),"heatmap-weight":new DataDrivenProperty(v8Spec["paint_heatmap"]["heatmap-weight"]),"heatmap-intensity":new DataConstantProperty(v8Spec["paint_heatmap"]["heatmap-intensity"]),"heatmap-color":new ColorRampProperty(v8Spec["paint_heatmap"]["heatmap-color"]),"heatmap-opacity":new DataConstantProperty(v8Spec["paint_heatmap"]["heatmap-opacity"])});var properties$7={get paint(){return getPaint$7()}};function createImage(image,{width:width,height:height},channels,data){if(!data){data=new Uint8Array(width*height*channels)}else if(data instanceof Uint8ClampedArray){data=new Uint8Array(data.buffer)}else if(data.length!==width*height*channels){throw new RangeError(`mismatched image size. expected: ${data.length} but got: ${width*height*channels}`)}image.width=width;image.height=height;image.data=data;return image}function resizeImage(image,{width:width,height:height},channels){if(width===image.width&&height===image.height){return}const newImage=createImage({},{width:width,height:height},channels);copyImage(image,newImage,{x:0,y:0},{x:0,y:0},{width:Math.min(image.width,width),height:Math.min(image.height,height)},channels);image.width=width;image.height=height;image.data=newImage.data}function copyImage(srcImg,dstImg,srcPt,dstPt,size,channels){if(size.width===0||size.height===0){return dstImg}if(size.width>srcImg.width||size.height>srcImg.height||srcPt.x>srcImg.width-size.width||srcPt.y>srcImg.height-size.height){throw new RangeError("out of range source coordinates for image copy")}if(size.width>dstImg.width||size.height>dstImg.height||dstPt.x>dstImg.width-size.width||dstPt.y>dstImg.height-size.height){throw new RangeError("out of range destination coordinates for image copy")}const srcData=srcImg.data;const dstData=dstImg.data;if(srcData===dstData)throw new Error("srcData equals dstData, so image is already copied");for(let y=0;y<size.height;y++){const srcOffset=((srcPt.y+y)*srcImg.width+srcPt.x)*channels;const dstOffset=((dstPt.y+y)*dstImg.width+dstPt.x)*channels;for(let i=0;i<size.width*channels;i++){dstData[dstOffset+i]=srcData[srcOffset+i]}}return dstImg}class AlphaImage{constructor(size,data){createImage(this,size,1,data)}resize(size){resizeImage(this,size,1)}clone(){return new AlphaImage({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(srcImg,dstImg,srcPt,dstPt,size){copyImage(srcImg,dstImg,srcPt,dstPt,size,1)}}class RGBAImage{constructor(size,data){createImage(this,size,4,data)}resize(size){resizeImage(this,size,4)}replace(data,copy){if(copy){this.data.set(data)}else if(data instanceof Uint8ClampedArray){this.data=new Uint8Array(data.buffer)}else{this.data=data}}clone(){return new RGBAImage({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(srcImg,dstImg,srcPt,dstPt,size){copyImage(srcImg,dstImg,srcPt,dstPt,size,4)}}register("AlphaImage",AlphaImage);register("RGBAImage",RGBAImage);function renderColorRamp(params){const evaluationGlobals={};const width=params.resolution||256;const height=params.clips?params.clips.length:1;const image=params.image||new RGBAImage({width:width,height:height});if(!isPowerOfTwo(width))throw new Error(`width is not a power of 2 - ${width}`);const renderPixel=(stride,index,progress)=>{evaluationGlobals[params.evaluationKey]=progress;const pxColor=params.expression.evaluate(evaluationGlobals);image.data[stride+index+0]=Math.floor(pxColor.r*255/pxColor.a);image.data[stride+index+1]=Math.floor(pxColor.g*255/pxColor.a);image.data[stride+index+2]=Math.floor(pxColor.b*255/pxColor.a);image.data[stride+index+3]=Math.floor(pxColor.a*255)};if(!params.clips){for(let i=0,j=0;i<width;i++,j+=4){const progress=i/(width-1);renderPixel(0,j,progress)}}else{for(let clip=0,stride=0;clip<height;++clip,stride+=width*4){for(let i=0,j=0;i<width;i++,j+=4){const progress=i/(width-1);const{start:start,end:end}=params.clips[clip];const evaluationProgress=start*(1-progress)+end*progress;renderPixel(stride,j,evaluationProgress)}}}return image}class HeatmapStyleLayer extends StyleLayer{createBucket(options){return new HeatmapBucket(options)}constructor(layer){super(layer,properties$7);this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(name){if(name==="heatmap-color"){this._updateColorRamp()}}_updateColorRamp(){const expression=this._transitionablePaint._values["heatmap-color"].value.expression;this.colorRamp=renderColorRamp({expression:expression,evaluationKey:"heatmapDensity",image:this.colorRamp});this.colorRampTexture=null}resize(){if(this.heatmapFbo){this.heatmapFbo.destroy();this.heatmapFbo=null}}queryRadius(){return 0}queryIntersectsFeature(){return false}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let paint$6;const getPaint$6=()=>paint$6=paint$6||new Properties({"hillshade-illumination-direction":new DataConstantProperty(v8Spec["paint_hillshade"]["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new DataConstantProperty(v8Spec["paint_hillshade"]["hillshade-illumination-anchor"]),"hillshade-exaggeration":new DataConstantProperty(v8Spec["paint_hillshade"]["hillshade-exaggeration"]),"hillshade-shadow-color":new DataConstantProperty(v8Spec["paint_hillshade"]["hillshade-shadow-color"]),"hillshade-highlight-color":new DataConstantProperty(v8Spec["paint_hillshade"]["hillshade-highlight-color"]),"hillshade-accent-color":new DataConstantProperty(v8Spec["paint_hillshade"]["hillshade-accent-color"])});var properties$6={get paint(){return getPaint$6()}};class HillshadeStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$6)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const layout$4=createLayout([{name:"a_pos",components:2,type:"Int16"}],4);const{members:members$3,size:size$3,alignment:alignment$3}=layout$4;var earcut$2={exports:{}};var earcut_1=earcut$2.exports;"use strict";earcut$2.exports=earcut;var _default=earcut$2.exports.default=earcut;function earcut(data,holeIndices,dim){dim=dim||2;var hasHoles=holeIndices&&holeIndices.length,outerLen=hasHoles?holeIndices[0]*dim:data.length,outerNode=linkedList(data,0,outerLen,dim,true),triangles=[];if(!outerNode||outerNode.next===outerNode.prev)return triangles;var minX,minY,maxX,maxY,x,y,invSize;if(hasHoles)outerNode=eliminateHoles(data,holeIndices,outerNode,dim);if(data.length>80*dim){minX=maxX=data[0];minY=maxY=data[1];for(var i=dim;i<outerLen;i+=dim){x=data[i];y=data[i+1];if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y}invSize=Math.max(maxX-minX,maxY-minY);invSize=invSize!==0?32767/invSize:0}earcutLinked(outerNode,triangles,dim,minX,minY,invSize,0);return triangles}function linkedList(data,start,end,dim,clockwise){var i,last;if(clockwise===signedArea$1(data,start,end,dim)>0){for(i=start;i<end;i+=dim)last=insertNode(i,data[i],data[i+1],last)}else{for(i=end-dim;i>=start;i-=dim)last=insertNode(i,data[i],data[i+1],last)}if(last&&equals(last,last.next)){removeNode(last);last=last.next}return last}function filterPoints(start,end){if(!start)return start;if(!end)end=start;var p=start,again;do{again=false;if(!p.steiner&&(equals(p,p.next)||area(p.prev,p,p.next)===0)){removeNode(p);p=end=p.prev;if(p===p.next)break;again=true}else{p=p.next}}while(again||p!==end);return end}function earcutLinked(ear,triangles,dim,minX,minY,invSize,pass){if(!ear)return;if(!pass&&invSize)indexCurve(ear,minX,minY,invSize);var stop=ear,prev,next;while(ear.prev!==ear.next){prev=ear.prev;next=ear.next;if(invSize?isEarHashed(ear,minX,minY,invSize):isEar(ear)){triangles.push(prev.i/dim|0);triangles.push(ear.i/dim|0);triangles.push(next.i/dim|0);removeNode(ear);ear=next.next;stop=next.next;continue}ear=next;if(ear===stop){if(!pass){earcutLinked(filterPoints(ear),triangles,dim,minX,minY,invSize,1)}else if(pass===1){ear=cureLocalIntersections(filterPoints(ear),triangles,dim);earcutLinked(ear,triangles,dim,minX,minY,invSize,2)}else if(pass===2){splitEarcut(ear,triangles,dim,minX,minY,invSize)}break}}}function isEar(ear){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return false;var ax=a.x,bx=b.x,cx=c.x,ay=a.y,by=b.y,cy=c.y;var x0=ax<bx?ax<cx?ax:cx:bx<cx?bx:cx,y0=ay<by?ay<cy?ay:cy:by<cy?by:cy,x1=ax>bx?ax>cx?ax:cx:bx>cx?bx:cx,y1=ay>by?ay>cy?ay:cy:by>cy?by:cy;var p=c.next;while(p!==a){if(p.x>=x0&&p.x<=x1&&p.y>=y0&&p.y<=y1&&pointInTriangle(ax,ay,bx,by,cx,cy,p.x,p.y)&&area(p.prev,p,p.next)>=0)return false;p=p.next}return true}function isEarHashed(ear,minX,minY,invSize){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return false;var ax=a.x,bx=b.x,cx=c.x,ay=a.y,by=b.y,cy=c.y;var x0=ax<bx?ax<cx?ax:cx:bx<cx?bx:cx,y0=ay<by?ay<cy?ay:cy:by<cy?by:cy,x1=ax>bx?ax>cx?ax:cx:bx>cx?bx:cx,y1=ay>by?ay>cy?ay:cy:by>cy?by:cy;var minZ=zOrder(x0,y0,minX,minY,invSize),maxZ=zOrder(x1,y1,minX,minY,invSize);var p=ear.prevZ,n=ear.nextZ;while(p&&p.z>=minZ&&n&&n.z<=maxZ){if(p.x>=x0&&p.x<=x1&&p.y>=y0&&p.y<=y1&&p!==a&&p!==c&&pointInTriangle(ax,ay,bx,by,cx,cy,p.x,p.y)&&area(p.prev,p,p.next)>=0)return false;p=p.prevZ;if(n.x>=x0&&n.x<=x1&&n.y>=y0&&n.y<=y1&&n!==a&&n!==c&&pointInTriangle(ax,ay,bx,by,cx,cy,n.x,n.y)&&area(n.prev,n,n.next)>=0)return false;n=n.nextZ}while(p&&p.z>=minZ){if(p.x>=x0&&p.x<=x1&&p.y>=y0&&p.y<=y1&&p!==a&&p!==c&&pointInTriangle(ax,ay,bx,by,cx,cy,p.x,p.y)&&area(p.prev,p,p.next)>=0)return false;p=p.prevZ}while(n&&n.z<=maxZ){if(n.x>=x0&&n.x<=x1&&n.y>=y0&&n.y<=y1&&n!==a&&n!==c&&pointInTriangle(ax,ay,bx,by,cx,cy,n.x,n.y)&&area(n.prev,n,n.next)>=0)return false;n=n.nextZ}return true}function cureLocalIntersections(start,triangles,dim){var p=start;do{var a=p.prev,b=p.next.next;if(!equals(a,b)&&intersects(a,p,p.next,b)&&locallyInside(a,b)&&locallyInside(b,a)){triangles.push(a.i/dim|0);triangles.push(p.i/dim|0);triangles.push(b.i/dim|0);removeNode(p);removeNode(p.next);p=start=b}p=p.next}while(p!==start);return filterPoints(p)}function splitEarcut(start,triangles,dim,minX,minY,invSize){var a=start;do{var b=a.next.next;while(b!==a.prev){if(a.i!==b.i&&isValidDiagonal(a,b)){var c=splitPolygon(a,b);a=filterPoints(a,a.next);c=filterPoints(c,c.next);earcutLinked(a,triangles,dim,minX,minY,invSize,0);earcutLinked(c,triangles,dim,minX,minY,invSize,0);return}b=b.next}a=a.next}while(a!==start)}function eliminateHoles(data,holeIndices,outerNode,dim){var queue=[],i,len,start,end,list;for(i=0,len=holeIndices.length;i<len;i++){start=holeIndices[i]*dim;end=i<len-1?holeIndices[i+1]*dim:data.length;list=linkedList(data,start,end,dim,false);if(list===list.next)list.steiner=true;queue.push(getLeftmost(list))}queue.sort(compareX);for(i=0;i<queue.length;i++){outerNode=eliminateHole(queue[i],outerNode)}return outerNode}function compareX(a,b){return a.x-b.x}function eliminateHole(hole,outerNode){var bridge=findHoleBridge(hole,outerNode);if(!bridge){return outerNode}var bridgeReverse=splitPolygon(bridge,hole);filterPoints(bridgeReverse,bridgeReverse.next);return filterPoints(bridge,bridge.next)}function findHoleBridge(hole,outerNode){var p=outerNode,hx=hole.x,hy=hole.y,qx=-Infinity,m;do{if(hy<=p.y&&hy>=p.next.y&&p.next.y!==p.y){var x=p.x+(hy-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(x<=hx&&x>qx){qx=x;m=p.x<p.next.x?p:p.next;if(x===hx)return m}}p=p.next}while(p!==outerNode);if(!m)return null;var stop=m,mx=m.x,my=m.y,tanMin=Infinity,tan;p=m;do{if(hx>=p.x&&p.x>=mx&&hx!==p.x&&pointInTriangle(hy<my?hx:qx,hy,mx,my,hy<my?qx:hx,hy,p.x,p.y)){tan=Math.abs(hy-p.y)/(hx-p.x);if(locallyInside(p,hole)&&(tan<tanMin||tan===tanMin&&(p.x>m.x||p.x===m.x&&sectorContainsSector(m,p)))){m=p;tanMin=tan}}p=p.next}while(p!==stop);return m}function sectorContainsSector(m,p){return area(m.prev,m,p.prev)<0&&area(p.next,m,m.next)<0}function indexCurve(start,minX,minY,invSize){var p=start;do{if(p.z===0)p.z=zOrder(p.x,p.y,minX,minY,invSize);p.prevZ=p.prev;p.nextZ=p.next;p=p.next}while(p!==start);p.prevZ.nextZ=null;p.prevZ=null;sortLinked(p)}function sortLinked(list){var i,p,q,e,tail,numMerges,pSize,qSize,inSize=1;do{p=list;list=null;tail=null;numMerges=0;while(p){numMerges++;q=p;pSize=0;for(i=0;i<inSize;i++){pSize++;q=q.nextZ;if(!q)break}qSize=inSize;while(pSize>0||qSize>0&&q){if(pSize!==0&&(qSize===0||!q||p.z<=q.z)){e=p;p=p.nextZ;pSize--}else{e=q;q=q.nextZ;qSize--}if(tail)tail.nextZ=e;else list=e;e.prevZ=tail;tail=e}p=q}tail.nextZ=null;inSize*=2}while(numMerges>1);return list}function zOrder(x,y,minX,minY,invSize){x=(x-minX)*invSize|0;y=(y-minY)*invSize|0;x=(x|x<<8)&16711935;x=(x|x<<4)&252645135;x=(x|x<<2)&858993459;x=(x|x<<1)&1431655765;y=(y|y<<8)&16711935;y=(y|y<<4)&252645135;y=(y|y<<2)&858993459;y=(y|y<<1)&1431655765;return x|y<<1}function getLeftmost(start){var p=start,leftmost=start;do{if(p.x<leftmost.x||p.x===leftmost.x&&p.y<leftmost.y)leftmost=p;p=p.next}while(p!==start);return leftmost}function pointInTriangle(ax,ay,bx,by,cx,cy,px,py){return(cx-px)*(ay-py)>=(ax-px)*(cy-py)&&(ax-px)*(by-py)>=(bx-px)*(ay-py)&&(bx-px)*(cy-py)>=(cx-px)*(by-py)}function isValidDiagonal(a,b){return a.next.i!==b.i&&a.prev.i!==b.i&&!intersectsPolygon(a,b)&&(locallyInside(a,b)&&locallyInside(b,a)&&middleInside(a,b)&&(area(a.prev,a,b.prev)||area(a,b.prev,b))||equals(a,b)&&area(a.prev,a,a.next)>0&&area(b.prev,b,b.next)>0)}function area(p,q,r){return(q.y-p.y)*(r.x-q.x)-(q.x-p.x)*(r.y-q.y)}function equals(p1,p2){return p1.x===p2.x&&p1.y===p2.y}function intersects(p1,q1,p2,q2){var o1=sign(area(p1,q1,p2));var o2=sign(area(p1,q1,q2));var o3=sign(area(p2,q2,p1));var o4=sign(area(p2,q2,q1));if(o1!==o2&&o3!==o4)return true;if(o1===0&&onSegment(p1,p2,q1))return true;if(o2===0&&onSegment(p1,q2,q1))return true;if(o3===0&&onSegment(p2,p1,q2))return true;if(o4===0&&onSegment(p2,q1,q2))return true;return false}function onSegment(p,q,r){return q.x<=Math.max(p.x,r.x)&&q.x>=Math.min(p.x,r.x)&&q.y<=Math.max(p.y,r.y)&&q.y>=Math.min(p.y,r.y)}function sign(num){return num>0?1:num<0?-1:0}function intersectsPolygon(a,b){var p=a;do{if(p.i!==a.i&&p.next.i!==a.i&&p.i!==b.i&&p.next.i!==b.i&&intersects(p,p.next,a,b))return true;p=p.next}while(p!==a);return false}function locallyInside(a,b){return area(a.prev,a,a.next)<0?area(a,b,a.next)>=0&&area(a,a.prev,b)>=0:area(a,b,a.prev)<0||area(a,a.next,b)<0}function middleInside(a,b){var p=a,inside=false,px=(a.x+b.x)/2,py=(a.y+b.y)/2;do{if(p.y>py!==p.next.y>py&&p.next.y!==p.y&&px<(p.next.x-p.x)*(py-p.y)/(p.next.y-p.y)+p.x)inside=!inside;p=p.next}while(p!==a);return inside}function splitPolygon(a,b){var a2=new Node(a.i,a.x,a.y),b2=new Node(b.i,b.x,b.y),an=a.next,bp=b.prev;a.next=b;b.prev=a;a2.next=an;an.prev=a2;b2.next=a2;a2.prev=b2;bp.next=b2;b2.prev=bp;return b2}function insertNode(i,x,y,last){var p=new Node(i,x,y);if(!last){p.prev=p;p.next=p}else{p.next=last.next;p.prev=last;last.next.prev=p;last.next=p}return p}function removeNode(p){p.next.prev=p.prev;p.prev.next=p.next;if(p.prevZ)p.prevZ.nextZ=p.nextZ;if(p.nextZ)p.nextZ.prevZ=p.prevZ}function Node(i,x,y){this.i=i;this.x=x;this.y=y;this.prev=null;this.next=null;this.z=0;this.prevZ=null;this.nextZ=null;this.steiner=false}earcut.deviation=function(data,holeIndices,dim,triangles){var hasHoles=holeIndices&&holeIndices.length;var outerLen=hasHoles?holeIndices[0]*dim:data.length;var polygonArea=Math.abs(signedArea$1(data,0,outerLen,dim));if(hasHoles){for(var i=0,len=holeIndices.length;i<len;i++){var start=holeIndices[i]*dim;var end=i<len-1?holeIndices[i+1]*dim:data.length;polygonArea-=Math.abs(signedArea$1(data,start,end,dim))}}var trianglesArea=0;for(i=0;i<triangles.length;i+=3){var a=triangles[i]*dim;var b=triangles[i+1]*dim;var c=triangles[i+2]*dim;trianglesArea+=Math.abs((data[a]-data[c])*(data[b+1]-data[a+1])-(data[a]-data[b])*(data[c+1]-data[a+1]))}return polygonArea===0&&trianglesArea===0?0:Math.abs((trianglesArea-polygonArea)/polygonArea)};function signedArea$1(data,start,end,dim){var sum=0;for(var i=start,j=end-dim;i<end;i+=dim){sum+=(data[j]-data[i])*(data[i+1]+data[j+1]);j=i}return sum}earcut.flatten=function(data){var dim=data[0][0].length,result={vertices:[],holes:[],dimensions:dim},holeIndex=0;for(var i=0;i<data.length;i++){for(var j=0;j<data[i].length;j++){for(var d=0;d<dim;d++)result.vertices.push(data[i][j][d])}if(i>0){holeIndex+=data[i-1].length;result.holes.push(holeIndex)}}return result};var earcutExports=earcut$2.exports;var earcut$1=getDefaultExportFromCjs$1(earcutExports);function quickselect(arr,k,left,right,compare){quickselectStep(arr,k,left||0,right||arr.length-1,compare||defaultCompare$1)}function quickselectStep(arr,k,left,right,compare){while(right>left){if(right-left>600){var n=right-left+1;var m=k-left+1;var z=Math.log(n);var s=.5*Math.exp(2*z/3);var sd=.5*Math.sqrt(z*s*(n-s)/n)*(m-n/2<0?-1:1);var newLeft=Math.max(left,Math.floor(k-m*s/n+sd));var newRight=Math.min(right,Math.floor(k+(n-m)*s/n+sd));quickselectStep(arr,k,newLeft,newRight,compare)}var t=arr[k];var i=left;var j=right;swap$1(arr,left,k);if(compare(arr[right],t)>0)swap$1(arr,left,right);while(i<j){swap$1(arr,i,j);i++;j--;while(compare(arr[i],t)<0)i++;while(compare(arr[j],t)>0)j--}if(compare(arr[left],t)===0)swap$1(arr,left,j);else{j++;swap$1(arr,j,right)}if(j<=k)left=j+1;if(k<=j)right=j-1}}function swap$1(arr,i,j){var tmp=arr[i];arr[i]=arr[j];arr[j]=tmp}function defaultCompare$1(a,b){return a<b?-1:a>b?1:0}function classifyRings$1(rings,maxRings){const len=rings.length;if(len<=1)return[rings];const polygons=[];let polygon,ccw;for(let i=0;i<len;i++){const area=calculateSignedArea(rings[i]);if(area===0)continue;rings[i].area=Math.abs(area);if(ccw===undefined)ccw=area<0;if(ccw===area<0){if(polygon)polygons.push(polygon);polygon=[rings[i]]}else{polygon.push(rings[i])}}if(polygon)polygons.push(polygon);if(maxRings>1){for(let j=0;j<polygons.length;j++){if(polygons[j].length<=maxRings)continue;quickselect(polygons[j],maxRings,1,polygons[j].length-1,compareAreas);polygons[j]=polygons[j].slice(0,maxRings)}}return polygons}function compareAreas(a,b){return b.area-a.area}function hasPattern(type,layers,options){const patterns=options.patternDependencies;let hasPattern=false;for(const layer of layers){const patternProperty=layer.paint.get(`${type}-pattern`);if(!patternProperty.isConstant()){hasPattern=true}const constantPattern=patternProperty.constantOr(null);if(constantPattern){hasPattern=true;patterns[constantPattern.to]=true;patterns[constantPattern.from]=true}}return hasPattern}function addPatternDependencies(type,layers,patternFeature,zoom,options){const patterns=options.patternDependencies;for(const layer of layers){const patternProperty=layer.paint.get(`${type}-pattern`);const patternPropertyValue=patternProperty.value;if(patternPropertyValue.kind!=="constant"){let min=patternPropertyValue.evaluate({zoom:zoom-1},patternFeature,{},options.availableImages);let mid=patternPropertyValue.evaluate({zoom:zoom},patternFeature,{},options.availableImages);let max=patternPropertyValue.evaluate({zoom:zoom+1},patternFeature,{},options.availableImages);min=min&&min.name?min.name:min;mid=mid&&mid.name?mid.name:mid;max=max&&max.name?max.name:max;patterns[min]=true;patterns[mid]=true;patterns[max]=true;patternFeature.patterns[layer.id]={min:min,mid:mid,max:max}}}return patternFeature}const EARCUT_MAX_RINGS$1=500;class FillBucket{constructor(options){this.zoom=options.zoom;this.overscaling=options.overscaling;this.layers=options.layers;this.layerIds=this.layers.map((layer=>layer.id));this.index=options.index;this.hasPattern=false;this.patternFeatures=[];this.layoutVertexArray=new FillLayoutArray;this.indexArray=new TriangleIndexArray;this.indexArray2=new LineIndexArray;this.programConfigurations=new ProgramConfigurationSet(options.layers,options.zoom);this.segments=new SegmentVector;this.segments2=new SegmentVector;this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id))}populate(features,options,canonical){this.hasPattern=hasPattern("fill",this.layers,options);const fillSortKey=this.layers[0].layout.get("fill-sort-key");const sortFeaturesByKey=!fillSortKey.isConstant();const bucketFeatures=[];for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=this.layers[0]._featureFilter.needGeometry;const evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!this.layers[0]._featureFilter.filter(new EvaluationParameters(this.zoom),evaluationFeature,canonical))continue;const sortKey=sortFeaturesByKey?fillSortKey.evaluate(evaluationFeature,{},canonical,options.availableImages):undefined;const bucketFeature={id:id,properties:feature.properties,type:feature.type,sourceLayerIndex:sourceLayerIndex,index:index,geometry:needGeometry?evaluationFeature.geometry:loadGeometry(feature),patterns:{},sortKey:sortKey};bucketFeatures.push(bucketFeature)}if(sortFeaturesByKey){bucketFeatures.sort(((a,b)=>a.sortKey-b.sortKey))}for(const bucketFeature of bucketFeatures){const{geometry:geometry,index:index,sourceLayerIndex:sourceLayerIndex}=bucketFeature;if(this.hasPattern){const patternFeature=addPatternDependencies("fill",this.layers,bucketFeature,this.zoom,options);this.patternFeatures.push(patternFeature)}else{this.addFeature(bucketFeature,geometry,index,canonical,{})}const feature=features[index].feature;options.featureIndex.insert(feature,geometry,index,sourceLayerIndex,this.index)}}update(states,vtLayer,imagePositions){if(!this.stateDependentLayers.length)return;this.programConfigurations.updatePaintArrays(states,vtLayer,this.stateDependentLayers,imagePositions)}addFeatures(options,canonical,imagePositions){for(const feature of this.patternFeatures){this.addFeature(feature,feature.geometry,feature.index,canonical,imagePositions)}}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(context){if(!this.uploaded){this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,members$3);this.indexBuffer=context.createIndexBuffer(this.indexArray);this.indexBuffer2=context.createIndexBuffer(this.indexArray2)}this.programConfigurations.upload(context);this.uploaded=true}destroy(){if(!this.layoutVertexBuffer)return;this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.indexBuffer2.destroy();this.programConfigurations.destroy();this.segments.destroy();this.segments2.destroy()}addFeature(feature,geometry,index,canonical,imagePositions){for(const polygon of classifyRings$1(geometry,EARCUT_MAX_RINGS$1)){let numVertices=0;for(const ring of polygon){numVertices+=ring.length}const triangleSegment=this.segments.prepareSegment(numVertices,this.layoutVertexArray,this.indexArray);const triangleIndex=triangleSegment.vertexLength;const flattened=[];const holeIndices=[];for(const ring of polygon){if(ring.length===0){continue}if(ring!==polygon[0]){holeIndices.push(flattened.length/2)}const lineSegment=this.segments2.prepareSegment(ring.length,this.layoutVertexArray,this.indexArray2);const lineIndex=lineSegment.vertexLength;this.layoutVertexArray.emplaceBack(ring[0].x,ring[0].y);this.indexArray2.emplaceBack(lineIndex+ring.length-1,lineIndex);flattened.push(ring[0].x);flattened.push(ring[0].y);for(let i=1;i<ring.length;i++){this.layoutVertexArray.emplaceBack(ring[i].x,ring[i].y);this.indexArray2.emplaceBack(lineIndex+i-1,lineIndex+i);flattened.push(ring[i].x);flattened.push(ring[i].y)}lineSegment.vertexLength+=ring.length;lineSegment.primitiveLength+=ring.length}const indices=earcut$1(flattened,holeIndices);for(let i=0;i<indices.length;i+=3){this.indexArray.emplaceBack(triangleIndex+indices[i],triangleIndex+indices[i+1],triangleIndex+indices[i+2])}triangleSegment.vertexLength+=numVertices;triangleSegment.primitiveLength+=indices.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,feature,index,imagePositions,canonical)}}register("FillBucket",FillBucket,{omit:["layers","patternFeatures"]});let layout$3;const getLayout$2=()=>layout$3=layout$3||new Properties({"fill-sort-key":new DataDrivenProperty(v8Spec["layout_fill"]["fill-sort-key"])});let paint$5;const getPaint$5=()=>paint$5=paint$5||new Properties({"fill-antialias":new DataConstantProperty(v8Spec["paint_fill"]["fill-antialias"]),"fill-opacity":new DataDrivenProperty(v8Spec["paint_fill"]["fill-opacity"]),"fill-color":new DataDrivenProperty(v8Spec["paint_fill"]["fill-color"]),"fill-outline-color":new DataDrivenProperty(v8Spec["paint_fill"]["fill-outline-color"]),"fill-translate":new DataConstantProperty(v8Spec["paint_fill"]["fill-translate"]),"fill-translate-anchor":new DataConstantProperty(v8Spec["paint_fill"]["fill-translate-anchor"]),"fill-pattern":new CrossFadedDataDrivenProperty(v8Spec["paint_fill"]["fill-pattern"])});var properties$5={get paint(){return getPaint$5()},get layout(){return getLayout$2()}};class FillStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$5)}recalculate(parameters,availableImages){super.recalculate(parameters,availableImages);const outlineColor=this.paint._values["fill-outline-color"];if(outlineColor.value.kind==="constant"&&outlineColor.value.value===undefined){this.paint._values["fill-outline-color"]=this.paint._values["fill-color"]}}createBucket(parameters){return new FillBucket(parameters)}queryRadius(){return translateDistance(this.paint.get("fill-translate"))}queryIntersectsFeature(queryGeometry,feature,featureState,geometry,zoom,transform,pixelsToTileUnits){const translatedPolygon=translate$4(queryGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),transform.angle,pixelsToTileUnits);return polygonIntersectsMultiPolygon(translatedPolygon,geometry)}isTileClipped(){return true}}const layout$2=createLayout([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4);const centroidAttributes=createLayout([{name:"a_centroid",components:2,type:"Int16"}],4);const{members:members$2,size:size$2,alignment:alignment$2}=layout$2;var vectorTile={};"use strict";var Point=pointGeometry;var vectortilefeature=VectorTileFeature$2;function VectorTileFeature$2(pbf,end,extent,keys,values){this.properties={};this.extent=extent;this.type=0;this._pbf=pbf;this._geometry=-1;this._keys=keys;this._values=values;pbf.readFields(readFeature,this,end)}function readFeature(tag,feature,pbf){if(tag==1)feature.id=pbf.readVarint();else if(tag==2)readTag(pbf,feature);else if(tag==3)feature.type=pbf.readVarint();else if(tag==4)feature._geometry=pbf.pos}function readTag(pbf,feature){var end=pbf.readVarint()+pbf.pos;while(pbf.pos<end){var key=feature._keys[pbf.readVarint()],value=feature._values[pbf.readVarint()];feature.properties[key]=value}}VectorTileFeature$2.types=["Unknown","Point","LineString","Polygon"];VectorTileFeature$2.prototype.loadGeometry=function(){var pbf=this._pbf;pbf.pos=this._geometry;var end=pbf.readVarint()+pbf.pos,cmd=1,length=0,x=0,y=0,lines=[],line;while(pbf.pos<end){if(length<=0){var cmdLen=pbf.readVarint();cmd=cmdLen&7;length=cmdLen>>3}length--;if(cmd===1||cmd===2){x+=pbf.readSVarint();y+=pbf.readSVarint();if(cmd===1){if(line)lines.push(line);line=[]}line.push(new Point(x,y))}else if(cmd===7){if(line){line.push(line[0].clone())}}else{throw new Error("unknown command "+cmd)}}if(line)lines.push(line);return lines};VectorTileFeature$2.prototype.bbox=function(){var pbf=this._pbf;pbf.pos=this._geometry;var end=pbf.readVarint()+pbf.pos,cmd=1,length=0,x=0,y=0,x1=Infinity,x2=-Infinity,y1=Infinity,y2=-Infinity;while(pbf.pos<end){if(length<=0){var cmdLen=pbf.readVarint();cmd=cmdLen&7;length=cmdLen>>3}length--;if(cmd===1||cmd===2){x+=pbf.readSVarint();y+=pbf.readSVarint();if(x<x1)x1=x;if(x>x2)x2=x;if(y<y1)y1=y;if(y>y2)y2=y}else if(cmd!==7){throw new Error("unknown command "+cmd)}}return[x1,y1,x2,y2]};VectorTileFeature$2.prototype.toGeoJSON=function(x,y,z){var size=this.extent*Math.pow(2,z),x0=this.extent*x,y0=this.extent*y,coords=this.loadGeometry(),type=VectorTileFeature$2.types[this.type],i,j;function project(line){for(var j=0;j<line.length;j++){var p=line[j],y2=180-(p.y+y0)*360/size;line[j]=[(p.x+x0)*360/size-180,360/Math.PI*Math.atan(Math.exp(y2*Math.PI/180))-90]}}switch(this.type){case 1:var points=[];for(i=0;i<coords.length;i++){points[i]=coords[i][0]}coords=points;project(coords);break;case 2:for(i=0;i<coords.length;i++){project(coords[i])}break;case 3:coords=classifyRings(coords);for(i=0;i<coords.length;i++){for(j=0;j<coords[i].length;j++){project(coords[i][j])}}break}if(coords.length===1){coords=coords[0]}else{type="Multi"+type}var result={type:"Feature",geometry:{type:type,coordinates:coords},properties:this.properties};if("id"in this){result.id=this.id}return result};function classifyRings(rings){var len=rings.length;if(len<=1)return[rings];var polygons=[],polygon,ccw;for(var i=0;i<len;i++){var area=signedArea(rings[i]);if(area===0)continue;if(ccw===undefined)ccw=area<0;if(ccw===area<0){if(polygon)polygons.push(polygon);polygon=[rings[i]]}else{polygon.push(rings[i])}}if(polygon)polygons.push(polygon);return polygons}function signedArea(ring){var sum=0;for(var i=0,len=ring.length,j=len-1,p1,p2;i<len;j=i++){p1=ring[i];p2=ring[j];sum+=(p2.x-p1.x)*(p1.y+p2.y)}return sum}var vectortilefeature$1=getDefaultExportFromCjs$1(vectortilefeature);"use strict";var VectorTileFeature$1=vectortilefeature;var vectortilelayer=VectorTileLayer$2;function VectorTileLayer$2(pbf,end){this.version=1;this.name=null;this.extent=4096;this.length=0;this._pbf=pbf;this._keys=[];this._values=[];this._features=[];pbf.readFields(readLayer,this,end);this.length=this._features.length}function readLayer(tag,layer,pbf){if(tag===15)layer.version=pbf.readVarint();else if(tag===1)layer.name=pbf.readString();else if(tag===5)layer.extent=pbf.readVarint();else if(tag===2)layer._features.push(pbf.pos);else if(tag===3)layer._keys.push(pbf.readString());else if(tag===4)layer._values.push(readValueMessage(pbf))}function readValueMessage(pbf){var value=null,end=pbf.readVarint()+pbf.pos;while(pbf.pos<end){var tag=pbf.readVarint()>>3;value=tag===1?pbf.readString():tag===2?pbf.readFloat():tag===3?pbf.readDouble():tag===4?pbf.readVarint64():tag===5?pbf.readVarint():tag===6?pbf.readSVarint():tag===7?pbf.readBoolean():null}return value}VectorTileLayer$2.prototype.feature=function(i){if(i<0||i>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[i];var end=this._pbf.readVarint()+this._pbf.pos;return new VectorTileFeature$1(this._pbf,end,this.extent,this._keys,this._values)};var vectortilelayer$1=getDefaultExportFromCjs$1(vectortilelayer);"use strict";var VectorTileLayer$1=vectortilelayer;var vectortile=VectorTile$1;function VectorTile$1(pbf,end){this.layers=pbf.readFields(readTile,{},end)}function readTile(tag,layers,pbf){if(tag===3){var layer=new VectorTileLayer$1(pbf,pbf.readVarint()+pbf.pos);if(layer.length)layers[layer.name]=layer}}var vectortile$1=getDefaultExportFromCjs$1(vectortile);var VectorTile=vectorTile.VectorTile=vectortile;var VectorTileFeature=vectorTile.VectorTileFeature=vectortilefeature;var VectorTileLayer=vectorTile.VectorTileLayer=vectortilelayer;const vectorTileFeatureTypes$2=vectorTile.VectorTileFeature.types;const EARCUT_MAX_RINGS=500;const FACTOR=Math.pow(2,13);function addVertex$1(vertexArray,x,y,nx,ny,nz,t,e){vertexArray.emplaceBack(x,y,Math.floor(nx*FACTOR)*2+t,ny*FACTOR*2,nz*FACTOR*2,Math.round(e))}class FillExtrusionBucket{constructor(options){this.zoom=options.zoom;this.overscaling=options.overscaling;this.layers=options.layers;this.layerIds=this.layers.map((layer=>layer.id));this.index=options.index;this.hasPattern=false;this.layoutVertexArray=new FillExtrusionLayoutArray;this.centroidVertexArray=new PosArray;this.indexArray=new TriangleIndexArray;this.programConfigurations=new ProgramConfigurationSet(options.layers,options.zoom);this.segments=new SegmentVector;this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id))}populate(features,options,canonical){this.features=[];this.hasPattern=hasPattern("fill-extrusion",this.layers,options);for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=this.layers[0]._featureFilter.needGeometry;const evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!this.layers[0]._featureFilter.filter(new EvaluationParameters(this.zoom),evaluationFeature,canonical))continue;const bucketFeature={id:id,sourceLayerIndex:sourceLayerIndex,index:index,geometry:needGeometry?evaluationFeature.geometry:loadGeometry(feature),properties:feature.properties,type:feature.type,patterns:{}};if(this.hasPattern){this.features.push(addPatternDependencies("fill-extrusion",this.layers,bucketFeature,this.zoom,options))}else{this.addFeature(bucketFeature,bucketFeature.geometry,index,canonical,{})}options.featureIndex.insert(feature,bucketFeature.geometry,index,sourceLayerIndex,this.index,true)}}addFeatures(options,canonical,imagePositions){for(const feature of this.features){const{geometry:geometry}=feature;this.addFeature(feature,geometry,feature.index,canonical,imagePositions)}}update(states,vtLayer,imagePositions){if(!this.stateDependentLayers.length)return;this.programConfigurations.updatePaintArrays(states,vtLayer,this.stateDependentLayers,imagePositions)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(context){if(!this.uploaded){this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,members$2);this.centroidVertexBuffer=context.createVertexBuffer(this.centroidVertexArray,centroidAttributes.members,true);this.indexBuffer=context.createIndexBuffer(this.indexArray)}this.programConfigurations.upload(context);this.uploaded=true}destroy(){if(!this.layoutVertexBuffer)return;this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.programConfigurations.destroy();this.segments.destroy();this.centroidVertexBuffer.destroy()}addFeature(feature,geometry,index,canonical,imagePositions){const centroid={x:0,y:0,vertexCount:0};for(const polygon of classifyRings$1(geometry,EARCUT_MAX_RINGS)){let numVertices=0;for(const ring of polygon){numVertices+=ring.length}let segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);for(const ring of polygon){if(ring.length===0){continue}if(isEntirelyOutside(ring)){continue}let edgeDistance=0;for(let p=0;p<ring.length;p++){const p1=ring[p];if(p>=1){const p2=ring[p-1];if(!isBoundaryEdge(p1,p2)){if(segment.vertexLength+4>SegmentVector.MAX_VERTEX_ARRAY_LENGTH){segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)}const perp=p1.sub(p2)._perp()._unit();const dist=p2.dist(p1);if(edgeDistance+dist>32768)edgeDistance=0;addVertex$1(this.layoutVertexArray,p1.x,p1.y,perp.x,perp.y,0,0,edgeDistance);addVertex$1(this.layoutVertexArray,p1.x,p1.y,perp.x,perp.y,0,1,edgeDistance);centroid.x+=2*p1.x;centroid.y+=2*p1.y;centroid.vertexCount+=2;edgeDistance+=dist;addVertex$1(this.layoutVertexArray,p2.x,p2.y,perp.x,perp.y,0,0,edgeDistance);addVertex$1(this.layoutVertexArray,p2.x,p2.y,perp.x,perp.y,0,1,edgeDistance);centroid.x+=2*p2.x;centroid.y+=2*p2.y;centroid.vertexCount+=2;const bottomRight=segment.vertexLength;this.indexArray.emplaceBack(bottomRight,bottomRight+2,bottomRight+1);this.indexArray.emplaceBack(bottomRight+1,bottomRight+2,bottomRight+3);segment.vertexLength+=4;segment.primitiveLength+=2}}}}if(segment.vertexLength+numVertices>SegmentVector.MAX_VERTEX_ARRAY_LENGTH){segment=this.segments.prepareSegment(numVertices,this.layoutVertexArray,this.indexArray)}if(vectorTileFeatureTypes$2[feature.type]!=="Polygon")continue;const flattened=[];const holeIndices=[];const triangleIndex=segment.vertexLength;for(const ring of polygon){if(ring.length===0){continue}if(ring!==polygon[0]){holeIndices.push(flattened.length/2)}for(let i=0;i<ring.length;i++){const p=ring[i];addVertex$1(this.layoutVertexArray,p.x,p.y,0,0,1,1,0);centroid.x+=p.x;centroid.y+=p.y;centroid.vertexCount+=1;flattened.push(p.x);flattened.push(p.y)}}const indices=earcut$1(flattened,holeIndices);for(let j=0;j<indices.length;j+=3){this.indexArray.emplaceBack(triangleIndex+indices[j],triangleIndex+indices[j+2],triangleIndex+indices[j+1])}segment.primitiveLength+=indices.length/3;segment.vertexLength+=numVertices}for(let i=0;i<centroid.vertexCount;i++){this.centroidVertexArray.emplaceBack(Math.floor(centroid.x/centroid.vertexCount),Math.floor(centroid.y/centroid.vertexCount))}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,feature,index,imagePositions,canonical)}}register("FillExtrusionBucket",FillExtrusionBucket,{omit:["layers","features"]});function isBoundaryEdge(p1,p2){return p1.x===p2.x&&(p1.x<0||p1.x>EXTENT)||p1.y===p2.y&&(p1.y<0||p1.y>EXTENT)}function isEntirelyOutside(ring){return ring.every((p=>p.x<0))||ring.every((p=>p.x>EXTENT))||ring.every((p=>p.y<0))||ring.every((p=>p.y>EXTENT))}let paint$4;const getPaint$4=()=>paint$4=paint$4||new Properties({"fill-extrusion-opacity":new DataConstantProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new DataDrivenProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new DataConstantProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new DataConstantProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new CrossFadedDataDrivenProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new DataDrivenProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new DataDrivenProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new DataConstantProperty(v8Spec["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])});var properties$4={get paint(){return getPaint$4()}};class Point3D extends Point$2{}class FillExtrusionStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$4)}createBucket(parameters){return new FillExtrusionBucket(parameters)}queryRadius(){return translateDistance(this.paint.get("fill-extrusion-translate"))}is3D(){return true}queryIntersectsFeature(queryGeometry,feature,featureState,geometry,zoom,transform,pixelsToTileUnits,pixelPosMatrix){const translatedPolygon=translate$4(queryGeometry,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),transform.angle,pixelsToTileUnits);const height=this.paint.get("fill-extrusion-height").evaluate(feature,featureState);const base=this.paint.get("fill-extrusion-base").evaluate(feature,featureState);const projectedQueryGeometry=projectQueryGeometry(translatedPolygon,pixelPosMatrix,transform,0);const projected=projectExtrusion(geometry,base,height,pixelPosMatrix);const projectedBase=projected[0];const projectedTop=projected[1];return checkIntersection(projectedBase,projectedTop,projectedQueryGeometry)}}function dot(a,b){return a.x*b.x+a.y*b.y}function getIntersectionDistance(projectedQueryGeometry,projectedFace){if(projectedQueryGeometry.length===1){let i=0;const a=projectedFace[i++];let b;while(!b||a.equals(b)){b=projectedFace[i++];if(!b)return Infinity}for(;i<projectedFace.length;i++){const c=projectedFace[i];const p=projectedQueryGeometry[0];const ab=b.sub(a);const ac=c.sub(a);const ap=p.sub(a);const dotABAB=dot(ab,ab);const dotABAC=dot(ab,ac);const dotACAC=dot(ac,ac);const dotAPAB=dot(ap,ab);const dotAPAC=dot(ap,ac);const denom=dotABAB*dotACAC-dotABAC*dotABAC;const v=(dotACAC*dotAPAB-dotABAC*dotAPAC)/denom;const w=(dotABAB*dotAPAC-dotABAC*dotAPAB)/denom;const u=1-v-w;const distance=a.z*u+b.z*v+c.z*w;if(isFinite(distance))return distance}return Infinity}else{let closestDistance=Infinity;for(const p of projectedFace){closestDistance=Math.min(closestDistance,p.z)}return closestDistance}}function checkIntersection(projectedBase,projectedTop,projectedQueryGeometry){let closestDistance=Infinity;if(polygonIntersectsMultiPolygon(projectedQueryGeometry,projectedTop)){closestDistance=getIntersectionDistance(projectedQueryGeometry,projectedTop[0])}for(let r=0;r<projectedTop.length;r++){const ringTop=projectedTop[r];const ringBase=projectedBase[r];for(let p=0;p<ringTop.length-1;p++){const topA=ringTop[p];const topB=ringTop[p+1];const baseA=ringBase[p];const baseB=ringBase[p+1];const face=[topA,topB,baseB,baseA,topA];if(polygonIntersectsPolygon(projectedQueryGeometry,face)){closestDistance=Math.min(closestDistance,getIntersectionDistance(projectedQueryGeometry,face))}}}return closestDistance===Infinity?false:closestDistance}function projectExtrusion(geometry,zBase,zTop,m){const projectedBase=[];const projectedTop=[];const baseXZ=m[8]*zBase;const baseYZ=m[9]*zBase;const baseZZ=m[10]*zBase;const baseWZ=m[11]*zBase;const topXZ=m[8]*zTop;const topYZ=m[9]*zTop;const topZZ=m[10]*zTop;const topWZ=m[11]*zTop;for(const r of geometry){const ringBase=[];const ringTop=[];for(const p of r){const x=p.x;const y=p.y;const sX=m[0]*x+m[4]*y+m[12];const sY=m[1]*x+m[5]*y+m[13];const sZ=m[2]*x+m[6]*y+m[14];const sW=m[3]*x+m[7]*y+m[15];const baseX=sX+baseXZ;const baseY=sY+baseYZ;const baseZ=sZ+baseZZ;const baseW=sW+baseWZ;const topX=sX+topXZ;const topY=sY+topYZ;const topZ=sZ+topZZ;const topW=sW+topWZ;const b=new Point$2(baseX/baseW,baseY/baseW);b.z=baseZ/baseW;ringBase.push(b);const t=new Point$2(topX/topW,topY/topW);t.z=topZ/topW;ringTop.push(t)}projectedBase.push(ringBase);projectedTop.push(ringTop)}return[projectedBase,projectedTop]}function projectQueryGeometry(queryGeometry,pixelPosMatrix,transform,z){const projectedQueryGeometry=[];for(const p of queryGeometry){const v=[p.x,p.y,z,1];transformMat4$1(v,v,pixelPosMatrix);projectedQueryGeometry.push(new Point$2(v[0]/v[3],v[1]/v[3]))}return projectedQueryGeometry}const lineLayoutAttributes=createLayout([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4);const{members:members$1,size:size$1,alignment:alignment$1}=lineLayoutAttributes;const lineLayoutAttributesExt=createLayout([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]);const{members:members,size:size,alignment:alignment}=lineLayoutAttributesExt;const vectorTileFeatureTypes$1=vectorTile.VectorTileFeature.types;const EXTRUDE_SCALE=63;const COS_HALF_SHARP_CORNER=Math.cos(75/2*(Math.PI/180));const SHARP_CORNER_OFFSET=15;const DEG_PER_TRIANGLE=20;const LINE_DISTANCE_BUFFER_BITS=15;const LINE_DISTANCE_SCALE=1/2;const MAX_LINE_DISTANCE=Math.pow(2,LINE_DISTANCE_BUFFER_BITS-1)/LINE_DISTANCE_SCALE;class LineBucket{constructor(options){this.zoom=options.zoom;this.overscaling=options.overscaling;this.layers=options.layers;this.layerIds=this.layers.map((layer=>layer.id));this.index=options.index;this.hasPattern=false;this.patternFeatures=[];this.lineClipsArray=[];this.gradients={};this.layers.forEach((layer=>{this.gradients[layer.id]={}}));this.layoutVertexArray=new LineLayoutArray;this.layoutVertexArray2=new LineExtLayoutArray;this.indexArray=new TriangleIndexArray;this.programConfigurations=new ProgramConfigurationSet(options.layers,options.zoom);this.segments=new SegmentVector;this.maxLineLength=0;this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id))}populate(features,options,canonical){this.hasPattern=hasPattern("line",this.layers,options);const lineSortKey=this.layers[0].layout.get("line-sort-key");const sortFeaturesByKey=!lineSortKey.isConstant();const bucketFeatures=[];for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=this.layers[0]._featureFilter.needGeometry;const evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!this.layers[0]._featureFilter.filter(new EvaluationParameters(this.zoom),evaluationFeature,canonical))continue;const sortKey=sortFeaturesByKey?lineSortKey.evaluate(evaluationFeature,{},canonical):undefined;const bucketFeature={id:id,properties:feature.properties,type:feature.type,sourceLayerIndex:sourceLayerIndex,index:index,geometry:needGeometry?evaluationFeature.geometry:loadGeometry(feature),patterns:{},sortKey:sortKey};bucketFeatures.push(bucketFeature)}if(sortFeaturesByKey){bucketFeatures.sort(((a,b)=>a.sortKey-b.sortKey))}for(const bucketFeature of bucketFeatures){const{geometry:geometry,index:index,sourceLayerIndex:sourceLayerIndex}=bucketFeature;if(this.hasPattern){const patternBucketFeature=addPatternDependencies("line",this.layers,bucketFeature,this.zoom,options);this.patternFeatures.push(patternBucketFeature)}else{this.addFeature(bucketFeature,geometry,index,canonical,{})}const feature=features[index].feature;options.featureIndex.insert(feature,geometry,index,sourceLayerIndex,this.index)}}update(states,vtLayer,imagePositions){if(!this.stateDependentLayers.length)return;this.programConfigurations.updatePaintArrays(states,vtLayer,this.stateDependentLayers,imagePositions)}addFeatures(options,canonical,imagePositions){for(const feature of this.patternFeatures){this.addFeature(feature,feature.geometry,feature.index,canonical,imagePositions)}}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(context){if(!this.uploaded){if(this.layoutVertexArray2.length!==0){this.layoutVertexBuffer2=context.createVertexBuffer(this.layoutVertexArray2,members)}this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,members$1);this.indexBuffer=context.createIndexBuffer(this.indexArray)}this.programConfigurations.upload(context);this.uploaded=true}destroy(){if(!this.layoutVertexBuffer)return;this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.programConfigurations.destroy();this.segments.destroy()}lineFeatureClips(feature){if(!!feature.properties&&Object.prototype.hasOwnProperty.call(feature.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(feature.properties,"mapbox_clip_end")){const start=+feature.properties["mapbox_clip_start"];const end=+feature.properties["mapbox_clip_end"];return{start:start,end:end}}}addFeature(feature,geometry,index,canonical,imagePositions){const layout=this.layers[0].layout;const join=layout.get("line-join").evaluate(feature,{});const cap=layout.get("line-cap");const miterLimit=layout.get("line-miter-limit");const roundLimit=layout.get("line-round-limit");this.lineClips=this.lineFeatureClips(feature);for(const line of geometry){this.addLine(line,feature,join,cap,miterLimit,roundLimit)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,feature,index,imagePositions,canonical)}addLine(vertices,feature,join,cap,miterLimit,roundLimit){this.distance=0;this.scaledDistance=0;this.totalDistance=0;if(this.lineClips){this.lineClipsArray.push(this.lineClips);for(let i=0;i<vertices.length-1;i++){this.totalDistance+=vertices[i].dist(vertices[i+1])}this.updateScaledDistance();this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const isPolygon=vectorTileFeatureTypes$1[feature.type]==="Polygon";let len=vertices.length;while(len>=2&&vertices[len-1].equals(vertices[len-2])){len--}let first=0;while(first<len-1&&vertices[first].equals(vertices[first+1])){first++}if(len<(isPolygon?3:2))return;if(join==="bevel")miterLimit=1.05;const sharpCornerOffset=this.overscaling<=16?SHARP_CORNER_OFFSET*EXTENT/(512*this.overscaling):0;const segment=this.segments.prepareSegment(len*10,this.layoutVertexArray,this.indexArray);let currentVertex;let prevVertex;let nextVertex;let prevNormal;let nextNormal;this.e1=this.e2=-1;if(isPolygon){currentVertex=vertices[len-2];nextNormal=vertices[first].sub(currentVertex)._unit()._perp()}for(let i=first;i<len;i++){nextVertex=i===len-1?isPolygon?vertices[first+1]:undefined:vertices[i+1];if(nextVertex&&vertices[i].equals(nextVertex))continue;if(nextNormal)prevNormal=nextNormal;if(currentVertex)prevVertex=currentVertex;currentVertex=vertices[i];nextNormal=nextVertex?nextVertex.sub(currentVertex)._unit()._perp():prevNormal;prevNormal=prevNormal||nextNormal;let joinNormal=prevNormal.add(nextNormal);if(joinNormal.x!==0||joinNormal.y!==0){joinNormal._unit()}const cosAngle=prevNormal.x*nextNormal.x+prevNormal.y*nextNormal.y;const cosHalfAngle=joinNormal.x*nextNormal.x+joinNormal.y*nextNormal.y;const miterLength=cosHalfAngle!==0?1/cosHalfAngle:Infinity;const approxAngle=2*Math.sqrt(2-2*cosHalfAngle);const isSharpCorner=cosHalfAngle<COS_HALF_SHARP_CORNER&&prevVertex&&nextVertex;const lineTurnsLeft=prevNormal.x*nextNormal.y-prevNormal.y*nextNormal.x>0;if(isSharpCorner&&i>first){const prevSegmentLength=currentVertex.dist(prevVertex);if(prevSegmentLength>2*sharpCornerOffset){const newPrevVertex=currentVertex.sub(currentVertex.sub(prevVertex)._mult(sharpCornerOffset/prevSegmentLength)._round());this.updateDistance(prevVertex,newPrevVertex);this.addCurrentVertex(newPrevVertex,prevNormal,0,0,segment);prevVertex=newPrevVertex}}const middleVertex=prevVertex&&nextVertex;let currentJoin=middleVertex?join:isPolygon?"butt":cap;if(middleVertex&&currentJoin==="round"){if(miterLength<roundLimit){currentJoin="miter"}else if(miterLength<=2){currentJoin="fakeround"}}if(currentJoin==="miter"&&miterLength>miterLimit){currentJoin="bevel"}if(currentJoin==="bevel"){if(miterLength>2)currentJoin="flipbevel";if(miterLength<miterLimit)currentJoin="miter"}if(prevVertex)this.updateDistance(prevVertex,currentVertex);if(currentJoin==="miter"){joinNormal._mult(miterLength);this.addCurrentVertex(currentVertex,joinNormal,0,0,segment)}else if(currentJoin==="flipbevel"){if(miterLength>100){joinNormal=nextNormal.mult(-1)}else{const bevelLength=miterLength*prevNormal.add(nextNormal).mag()/prevNormal.sub(nextNormal).mag();joinNormal._perp()._mult(bevelLength*(lineTurnsLeft?-1:1))}this.addCurrentVertex(currentVertex,joinNormal,0,0,segment);this.addCurrentVertex(currentVertex,joinNormal.mult(-1),0,0,segment)}else if(currentJoin==="bevel"||currentJoin==="fakeround"){const offset=-Math.sqrt(miterLength*miterLength-1);const offsetA=lineTurnsLeft?offset:0;const offsetB=lineTurnsLeft?0:offset;if(prevVertex){this.addCurrentVertex(currentVertex,prevNormal,offsetA,offsetB,segment)}if(currentJoin==="fakeround"){const n=Math.round(approxAngle*180/Math.PI/DEG_PER_TRIANGLE);for(let m=1;m<n;m++){let t=m/n;if(t!==.5){const t2=t-.5;const A=1.0904+cosAngle*(-3.2452+cosAngle*(3.55645-cosAngle*1.43519));const B=.848013+cosAngle*(-1.06021+cosAngle*.215638);t=t+t*t2*(t-1)*(A*t2*t2+B)}const extrude=nextNormal.sub(prevNormal)._mult(t)._add(prevNormal)._unit()._mult(lineTurnsLeft?-1:1);this.addHalfVertex(currentVertex,extrude.x,extrude.y,false,lineTurnsLeft,0,segment)}}if(nextVertex){this.addCurrentVertex(currentVertex,nextNormal,-offsetA,-offsetB,segment)}}else if(currentJoin==="butt"){this.addCurrentVertex(currentVertex,joinNormal,0,0,segment)}else if(currentJoin==="square"){const offset=prevVertex?1:-1;this.addCurrentVertex(currentVertex,joinNormal,offset,offset,segment)}else if(currentJoin==="round"){if(prevVertex){this.addCurrentVertex(currentVertex,prevNormal,0,0,segment);this.addCurrentVertex(currentVertex,prevNormal,1,1,segment,true)}if(nextVertex){this.addCurrentVertex(currentVertex,nextNormal,-1,-1,segment,true);this.addCurrentVertex(currentVertex,nextNormal,0,0,segment)}}if(isSharpCorner&&i<len-1){const nextSegmentLength=currentVertex.dist(nextVertex);if(nextSegmentLength>2*sharpCornerOffset){const newCurrentVertex=currentVertex.add(nextVertex.sub(currentVertex)._mult(sharpCornerOffset/nextSegmentLength)._round());this.updateDistance(currentVertex,newCurrentVertex);this.addCurrentVertex(newCurrentVertex,nextNormal,0,0,segment);currentVertex=newCurrentVertex}}}}addCurrentVertex(p,normal,endLeft,endRight,segment,round=false){const leftX=normal.x+normal.y*endLeft;const leftY=normal.y-normal.x*endLeft;const rightX=-normal.x+normal.y*endRight;const rightY=-normal.y-normal.x*endRight;this.addHalfVertex(p,leftX,leftY,round,false,endLeft,segment);this.addHalfVertex(p,rightX,rightY,round,true,-endRight,segment);if(this.distance>MAX_LINE_DISTANCE/2&&this.totalDistance===0){this.distance=0;this.updateScaledDistance();this.addCurrentVertex(p,normal,endLeft,endRight,segment,round)}}addHalfVertex({x:x,y:y},extrudeX,extrudeY,round,up,dir,segment){const totalDistance=this.lineClips?this.scaledDistance*(MAX_LINE_DISTANCE-1):this.scaledDistance;const linesofarScaled=totalDistance*LINE_DISTANCE_SCALE;this.layoutVertexArray.emplaceBack((x<<1)+(round?1:0),(y<<1)+(up?1:0),Math.round(EXTRUDE_SCALE*extrudeX)+128,Math.round(EXTRUDE_SCALE*extrudeY)+128,(dir===0?0:dir<0?-1:1)+1|(linesofarScaled&63)<<2,linesofarScaled>>6);if(this.lineClips){const progressRealigned=this.scaledDistance-this.lineClips.start;const endClipRealigned=this.lineClips.end-this.lineClips.start;const uvX=progressRealigned/endClipRealigned;this.layoutVertexArray2.emplaceBack(uvX,this.lineClipsArray.length)}const e=segment.vertexLength++;if(this.e1>=0&&this.e2>=0){this.indexArray.emplaceBack(this.e1,this.e2,e);segment.primitiveLength++}if(up){this.e2=e}else{this.e1=e}}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(prev,next){this.distance+=prev.dist(next);this.updateScaledDistance()}}register("LineBucket",LineBucket,{omit:["layers","patternFeatures"]});let layout$1;const getLayout$1=()=>layout$1=layout$1||new Properties({"line-cap":new DataConstantProperty(v8Spec["layout_line"]["line-cap"]),"line-join":new DataDrivenProperty(v8Spec["layout_line"]["line-join"]),"line-miter-limit":new DataConstantProperty(v8Spec["layout_line"]["line-miter-limit"]),"line-round-limit":new DataConstantProperty(v8Spec["layout_line"]["line-round-limit"]),"line-sort-key":new DataDrivenProperty(v8Spec["layout_line"]["line-sort-key"])});let paint$3;const getPaint$3=()=>paint$3=paint$3||new Properties({"line-opacity":new DataDrivenProperty(v8Spec["paint_line"]["line-opacity"]),"line-color":new DataDrivenProperty(v8Spec["paint_line"]["line-color"]),"line-translate":new DataConstantProperty(v8Spec["paint_line"]["line-translate"]),"line-translate-anchor":new DataConstantProperty(v8Spec["paint_line"]["line-translate-anchor"]),"line-width":new DataDrivenProperty(v8Spec["paint_line"]["line-width"]),"line-gap-width":new DataDrivenProperty(v8Spec["paint_line"]["line-gap-width"]),"line-offset":new DataDrivenProperty(v8Spec["paint_line"]["line-offset"]),"line-blur":new DataDrivenProperty(v8Spec["paint_line"]["line-blur"]),"line-dasharray":new CrossFadedProperty(v8Spec["paint_line"]["line-dasharray"]),"line-pattern":new CrossFadedDataDrivenProperty(v8Spec["paint_line"]["line-pattern"]),"line-gradient":new ColorRampProperty(v8Spec["paint_line"]["line-gradient"])});var properties$3={get paint(){return getPaint$3()},get layout(){return getLayout$1()}};class LineFloorwidthProperty extends DataDrivenProperty{possiblyEvaluate(value,parameters){parameters=new EvaluationParameters(Math.floor(parameters.zoom),{now:parameters.now,fadeDuration:parameters.fadeDuration,zoomHistory:parameters.zoomHistory,transition:parameters.transition});return super.possiblyEvaluate(value,parameters)}evaluate(value,globals,feature,featureState){globals=extend({},globals,{zoom:Math.floor(globals.zoom)});return super.evaluate(value,globals,feature,featureState)}}let lineFloorwidthProperty;class LineStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$3);this.gradientVersion=0;if(!lineFloorwidthProperty){lineFloorwidthProperty=new LineFloorwidthProperty(properties$3.paint.properties["line-width"].specification);lineFloorwidthProperty.useIntegerZoom=true}}_handleSpecialPaintPropertyUpdate(name){if(name==="line-gradient"){const expression=this.gradientExpression();if(isZoomExpression(expression)){this.stepInterpolant=expression._styleExpression.expression instanceof Step}else{this.stepInterpolant=false}this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(parameters,availableImages){super.recalculate(parameters,availableImages);this.paint._values["line-floorwidth"]=lineFloorwidthProperty.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,parameters)}createBucket(parameters){return new LineBucket(parameters)}queryRadius(bucket){const lineBucket=bucket;const width=getLineWidth(getMaximumPaintValue("line-width",this,lineBucket),getMaximumPaintValue("line-gap-width",this,lineBucket));const offset=getMaximumPaintValue("line-offset",this,lineBucket);return width/2+Math.abs(offset)+translateDistance(this.paint.get("line-translate"))}queryIntersectsFeature(queryGeometry,feature,featureState,geometry,zoom,transform,pixelsToTileUnits){const translatedPolygon=translate$4(queryGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),transform.angle,pixelsToTileUnits);const halfWidth=pixelsToTileUnits/2*getLineWidth(this.paint.get("line-width").evaluate(feature,featureState),this.paint.get("line-gap-width").evaluate(feature,featureState));const lineOffset=this.paint.get("line-offset").evaluate(feature,featureState);if(lineOffset){geometry=offsetLine(geometry,lineOffset*pixelsToTileUnits)}return polygonIntersectsBufferedMultiLine(translatedPolygon,geometry,halfWidth)}isTileClipped(){return true}}function getLineWidth(lineWidth,lineGapWidth){if(lineGapWidth>0){return lineGapWidth+2*lineWidth}else{return lineWidth}}const symbolLayoutAttributes=createLayout([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4);const dynamicLayoutAttributes=createLayout([{name:"a_projected_pos",components:3,type:"Float32"}],4);const placementOpacityAttributes=createLayout([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const collisionVertexAttributes=createLayout([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]);const collisionBox=createLayout([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const collisionBoxLayout=createLayout([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4);const collisionCircleLayout=createLayout([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);const quadTriangle=createLayout([{name:"triangle",components:3,type:"Uint16"}]);const placement=createLayout([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]);const symbolInstance=createLayout([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]);const glyphOffset=createLayout([{type:"Float32",name:"offsetX"}]);const lineVertex=createLayout([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);const textAnchorOffset=createLayout([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);function transformTextInternal(text,layer,feature){const transform=layer.layout.get("text-transform").evaluate(feature,{});if(transform==="uppercase"){text=text.toLocaleUpperCase()}else if(transform==="lowercase"){text=text.toLocaleLowerCase()}if(rtlWorkerPlugin.applyArabicShaping){text=rtlWorkerPlugin.applyArabicShaping(text)}return text}function transformText(text,layer,feature){text.sections.forEach((section=>{section.text=transformTextInternal(section.text,layer,feature)}));return text}function mergeLines(features){const leftIndex={};const rightIndex={};const mergedFeatures=[];let mergedIndex=0;function add(k){mergedFeatures.push(features[k]);mergedIndex++}function mergeFromRight(leftKey,rightKey,geom){const i=rightIndex[leftKey];delete rightIndex[leftKey];rightIndex[rightKey]=i;mergedFeatures[i].geometry[0].pop();mergedFeatures[i].geometry[0]=mergedFeatures[i].geometry[0].concat(geom[0]);return i}function mergeFromLeft(leftKey,rightKey,geom){const i=leftIndex[rightKey];delete leftIndex[rightKey];leftIndex[leftKey]=i;mergedFeatures[i].geometry[0].shift();mergedFeatures[i].geometry[0]=geom[0].concat(mergedFeatures[i].geometry[0]);return i}function getKey(text,geom,onRight){const point=onRight?geom[0][geom[0].length-1]:geom[0][0];return`${text}:${point.x}:${point.y}`}for(let k=0;k<features.length;k++){const feature=features[k];const geom=feature.geometry;const text=feature.text?feature.text.toString():null;if(!text){add(k);continue}const leftKey=getKey(text,geom),rightKey=getKey(text,geom,true);if(leftKey in rightIndex&&rightKey in leftIndex&&rightIndex[leftKey]!==leftIndex[rightKey]){const j=mergeFromLeft(leftKey,rightKey,geom);const i=mergeFromRight(leftKey,rightKey,mergedFeatures[j].geometry);delete leftIndex[leftKey];delete rightIndex[rightKey];rightIndex[getKey(text,mergedFeatures[i].geometry,true)]=i;mergedFeatures[j].geometry=null}else if(leftKey in rightIndex){mergeFromRight(leftKey,rightKey,geom)}else if(rightKey in leftIndex){mergeFromLeft(leftKey,rightKey,geom)}else{add(k);leftIndex[leftKey]=mergedIndex-1;rightIndex[rightKey]=mergedIndex-1}}return mergedFeatures.filter((f=>f.geometry))}const verticalizedCharacterMap={"!":"ï¸","#":"ï¼",$:"ï¼","%":"ï¼","&":"ï¼","(":"ï¸µ",")":"ï¸¶","*":"ï¼","+":"ï¼",",":"ï¸","-":"ï¸²",".":"ã»","/":"ï¼",":":"ï¸",";":"ï¸","<":"ï¸¿","=":"ï¼",">":"ï¹","?":"ï¸","@":"ï¼ ","[":"ï¹","\\":"ï¼¼","]":"ï¹","^":"ï¼¾",_:"ï¸³","`":"ï½","{":"ï¸·","|":"â","}":"ï¸¸","~":"ï½","Â¢":"ï¿ ","Â£":"ï¿¡","Â¥":"ï¿¥","Â¦":"ï¿¤","Â¬":"ï¿¢","Â¯":"ï¿£","â":"ï¸²","â":"ï¸±","â":"ï¹","â":"ï¹","â":"ï¹","â":"ï¹","â¦":"ï¸","â§":"ã»","â©":"ï¿¦","ã":"ï¸","ã":"ï¸","ã":"ï¸¿","ã":"ï¹","ã":"ï¸½","ã":"ï¸¾","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¸»","ã":"ï¸¼","ã":"ï¸¹","ã":"ï¸º","ã":"ï¸","ã":"ï¸","ï¼":"ï¸","ï¼":"ï¸µ","ï¼":"ï¸¶","ï¼":"ï¸","ï¼":"ï¸²","ï¼":"ã»","ï¼":"ï¸","ï¼":"ï¸","ï¼":"ï¸¿","ï¼":"ï¹","ï¼":"ï¸","ï¼»":"ï¹","ï¼½":"ï¹","ï¼¿":"ï¸³","ï½":"ï¸·","ï½":"â","ï½":"ï¸¸","ï½":"ï¸µ","ï½ ":"ï¸¶","ï½¡":"ï¸","ï½¢":"ï¹","ï½£":"ï¹"};function verticalizePunctuation(input){let output="";for(let i=0;i<input.length;i++){const nextCharCode=input.charCodeAt(i+1)||null;const prevCharCode=input.charCodeAt(i-1)||null;const canReplacePunctuation=(!nextCharCode||!charHasRotatedVerticalOrientation(nextCharCode)||verticalizedCharacterMap[input[i+1]])&&(!prevCharCode||!charHasRotatedVerticalOrientation(prevCharCode)||verticalizedCharacterMap[input[i-1]]);if(canReplacePunctuation&&verticalizedCharacterMap[input[i]]){output+=verticalizedCharacterMap[input[i]]}else{output+=input[i]}}return output}var ONE_EM=24;var ieee754$1={};
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */var read=ieee754$1.read=function(buffer,offset,isLE,mLen,nBytes){var e,m;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var nBits=-7;var i=isLE?nBytes-1:0;var d=isLE?-1:1;var s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8){}m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8){}if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)};var write=ieee754$1.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0;var i=isLE?0:nBytes-1;var d=isLE?1:-1;var s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8){}e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8){}buffer[offset+i-d]|=s*128};"use strict";var pbf=Pbf;var ieee754=ieee754$1;function Pbf(buf){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(buf)?buf:new Uint8Array(buf||0);this.pos=0;this.type=0;this.length=this.buf.length}Pbf.Varint=0;Pbf.Fixed64=1;Pbf.Bytes=2;Pbf.Fixed32=5;var SHIFT_LEFT_32=(1<<16)*(1<<16),SHIFT_RIGHT_32=1/SHIFT_LEFT_32;var TEXT_DECODER_MIN_LENGTH=12;var utf8TextDecoder=typeof TextDecoder==="undefined"?null:new TextDecoder("utf8");Pbf.prototype={destroy:function(){this.buf=null},readFields:function(readField,result,end){end=end||this.length;while(this.pos<end){var val=this.readVarint(),tag=val>>3,startPos=this.pos;this.type=val&7;readField(tag,result,this);if(this.pos===startPos)this.skip(val)}return result},readMessage:function(readField,result){return this.readFields(readField,result,this.readVarint()+this.pos)},readFixed32:function(){var val=readUInt32(this.buf,this.pos);this.pos+=4;return val},readSFixed32:function(){var val=readInt32(this.buf,this.pos);this.pos+=4;return val},readFixed64:function(){var val=readUInt32(this.buf,this.pos)+readUInt32(this.buf,this.pos+4)*SHIFT_LEFT_32;this.pos+=8;return val},readSFixed64:function(){var val=readUInt32(this.buf,this.pos)+readInt32(this.buf,this.pos+4)*SHIFT_LEFT_32;this.pos+=8;return val},readFloat:function(){var val=ieee754.read(this.buf,this.pos,true,23,4);this.pos+=4;return val},readDouble:function(){var val=ieee754.read(this.buf,this.pos,true,52,8);this.pos+=8;return val},readVarint:function(isSigned){var buf=this.buf,val,b;b=buf[this.pos++];val=b&127;if(b<128)return val;b=buf[this.pos++];val|=(b&127)<<7;if(b<128)return val;b=buf[this.pos++];val|=(b&127)<<14;if(b<128)return val;b=buf[this.pos++];val|=(b&127)<<21;if(b<128)return val;b=buf[this.pos];val|=(b&15)<<28;return readVarintRemainder(val,isSigned,this)},readVarint64:function(){return this.readVarint(true)},readSVarint:function(){var num=this.readVarint();return num%2===1?(num+1)/-2:num/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var end=this.readVarint()+this.pos;var pos=this.pos;this.pos=end;if(end-pos>=TEXT_DECODER_MIN_LENGTH&&utf8TextDecoder){return readUtf8TextDecoder(this.buf,pos,end)}return readUtf8(this.buf,pos,end)},readBytes:function(){var end=this.readVarint()+this.pos,buffer=this.buf.subarray(this.pos,end);this.pos=end;return buffer},readPackedVarint:function(arr,isSigned){if(this.type!==Pbf.Bytes)return arr.push(this.readVarint(isSigned));var end=readPackedEnd(this);arr=arr||[];while(this.pos<end)arr.push(this.readVarint(isSigned));return arr},readPackedSVarint:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readSVarint());var end=readPackedEnd(this);arr=arr||[];while(this.pos<end)arr.push(this.readSVarint());return arr},readPackedBoolean:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readBoolean());var end=readPackedEnd(this);arr=arr||[];while(this.pos<end)arr.push(this.readBoolean());return arr},readPackedFloat:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readFloat());var end=readPackedEnd(this);arr=arr||[];while(this.pos<end)arr.push(this.readFloat());return arr},readPackedDouble:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readDouble());var end=readPackedEnd(this);arr=arr||[];while(this.pos<end)arr.push(this.readDouble());return arr},readPackedFixed32:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readFixed32());var end=readPackedEnd(this);arr=arr||[];while(this.pos<end)arr.push(this.readFixed32());return arr},readPackedSFixed32:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readSFixed32());var end=readPackedEnd(this);arr=arr||[];while(this.pos<end)arr.push(this.readSFixed32());return arr},readPackedFixed64:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readFixed64());var end=readPackedEnd(this);arr=arr||[];while(this.pos<end)arr.push(this.readFixed64());return arr},readPackedSFixed64:function(arr){if(this.type!==Pbf.Bytes)return arr.push(this.readSFixed64());var end=readPackedEnd(this);arr=arr||[];while(this.pos<end)arr.push(this.readSFixed64());return arr},skip:function(val){var type=val&7;if(type===Pbf.Varint)while(this.buf[this.pos++]>127){}else if(type===Pbf.Bytes)this.pos=this.readVarint()+this.pos;else if(type===Pbf.Fixed32)this.pos+=4;else if(type===Pbf.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+type)},writeTag:function(tag,type){this.writeVarint(tag<<3|type)},realloc:function(min){var length=this.length||16;while(length<this.pos+min)length*=2;if(length!==this.length){var buf=new Uint8Array(length);buf.set(this.buf);this.buf=buf;this.length=length}},finish:function(){this.length=this.pos;this.pos=0;return this.buf.subarray(0,this.length)},writeFixed32:function(val){this.realloc(4);writeInt32(this.buf,val,this.pos);this.pos+=4},writeSFixed32:function(val){this.realloc(4);writeInt32(this.buf,val,this.pos);this.pos+=4},writeFixed64:function(val){this.realloc(8);writeInt32(this.buf,val&-1,this.pos);writeInt32(this.buf,Math.floor(val*SHIFT_RIGHT_32),this.pos+4);this.pos+=8},writeSFixed64:function(val){this.realloc(8);writeInt32(this.buf,val&-1,this.pos);writeInt32(this.buf,Math.floor(val*SHIFT_RIGHT_32),this.pos+4);this.pos+=8},writeVarint:function(val){val=+val||0;if(val>268435455||val<0){writeBigVarint(val,this);return}this.realloc(4);this.buf[this.pos++]=val&127|(val>127?128:0);if(val<=127)return;this.buf[this.pos++]=(val>>>=7)&127|(val>127?128:0);if(val<=127)return;this.buf[this.pos++]=(val>>>=7)&127|(val>127?128:0);if(val<=127)return;this.buf[this.pos++]=val>>>7&127},writeSVarint:function(val){this.writeVarint(val<0?-val*2-1:val*2)},writeBoolean:function(val){this.writeVarint(Boolean(val))},writeString:function(str){str=String(str);this.realloc(str.length*4);this.pos++;var startPos=this.pos;this.pos=writeUtf8(this.buf,str,this.pos);var len=this.pos-startPos;if(len>=128)makeRoomForExtraLength(startPos,len,this);this.pos=startPos-1;this.writeVarint(len);this.pos+=len},writeFloat:function(val){this.realloc(4);ieee754.write(this.buf,val,this.pos,true,23,4);this.pos+=4},writeDouble:function(val){this.realloc(8);ieee754.write(this.buf,val,this.pos,true,52,8);this.pos+=8},writeBytes:function(buffer){var len=buffer.length;this.writeVarint(len);this.realloc(len);for(var i=0;i<len;i++)this.buf[this.pos++]=buffer[i]},writeRawMessage:function(fn,obj){this.pos++;var startPos=this.pos;fn(obj,this);var len=this.pos-startPos;if(len>=128)makeRoomForExtraLength(startPos,len,this);this.pos=startPos-1;this.writeVarint(len);this.pos+=len},writeMessage:function(tag,fn,obj){this.writeTag(tag,Pbf.Bytes);this.writeRawMessage(fn,obj)},writePackedVarint:function(tag,arr){if(arr.length)this.writeMessage(tag,writePackedVarint,arr)},writePackedSVarint:function(tag,arr){if(arr.length)this.writeMessage(tag,writePackedSVarint,arr)},writePackedBoolean:function(tag,arr){if(arr.length)this.writeMessage(tag,writePackedBoolean,arr)},writePackedFloat:function(tag,arr){if(arr.length)this.writeMessage(tag,writePackedFloat,arr)},writePackedDouble:function(tag,arr){if(arr.length)this.writeMessage(tag,writePackedDouble,arr)},writePackedFixed32:function(tag,arr){if(arr.length)this.writeMessage(tag,writePackedFixed32,arr)},writePackedSFixed32:function(tag,arr){if(arr.length)this.writeMessage(tag,writePackedSFixed32,arr)},writePackedFixed64:function(tag,arr){if(arr.length)this.writeMessage(tag,writePackedFixed64,arr)},writePackedSFixed64:function(tag,arr){if(arr.length)this.writeMessage(tag,writePackedSFixed64,arr)},writeBytesField:function(tag,buffer){this.writeTag(tag,Pbf.Bytes);this.writeBytes(buffer)},writeFixed32Field:function(tag,val){this.writeTag(tag,Pbf.Fixed32);this.writeFixed32(val)},writeSFixed32Field:function(tag,val){this.writeTag(tag,Pbf.Fixed32);this.writeSFixed32(val)},writeFixed64Field:function(tag,val){this.writeTag(tag,Pbf.Fixed64);this.writeFixed64(val)},writeSFixed64Field:function(tag,val){this.writeTag(tag,Pbf.Fixed64);this.writeSFixed64(val)},writeVarintField:function(tag,val){this.writeTag(tag,Pbf.Varint);this.writeVarint(val)},writeSVarintField:function(tag,val){this.writeTag(tag,Pbf.Varint);this.writeSVarint(val)},writeStringField:function(tag,str){this.writeTag(tag,Pbf.Bytes);this.writeString(str)},writeFloatField:function(tag,val){this.writeTag(tag,Pbf.Fixed32);this.writeFloat(val)},writeDoubleField:function(tag,val){this.writeTag(tag,Pbf.Fixed64);this.writeDouble(val)},writeBooleanField:function(tag,val){this.writeVarintField(tag,Boolean(val))}};function readVarintRemainder(l,s,p){var buf=p.buf,h,b;b=buf[p.pos++];h=(b&112)>>4;if(b<128)return toNum(l,h,s);b=buf[p.pos++];h|=(b&127)<<3;if(b<128)return toNum(l,h,s);b=buf[p.pos++];h|=(b&127)<<10;if(b<128)return toNum(l,h,s);b=buf[p.pos++];h|=(b&127)<<17;if(b<128)return toNum(l,h,s);b=buf[p.pos++];h|=(b&127)<<24;if(b<128)return toNum(l,h,s);b=buf[p.pos++];h|=(b&1)<<31;if(b<128)return toNum(l,h,s);throw new Error("Expected varint not more than 10 bytes")}function readPackedEnd(pbf){return pbf.type===Pbf.Bytes?pbf.readVarint()+pbf.pos:pbf.pos+1}function toNum(low,high,isSigned){if(isSigned){return high*4294967296+(low>>>0)}return(high>>>0)*4294967296+(low>>>0)}function writeBigVarint(val,pbf){var low,high;if(val>=0){low=val%4294967296|0;high=val/4294967296|0}else{low=~(-val%4294967296);high=~(-val/4294967296);if(low^4294967295){low=low+1|0}else{low=0;high=high+1|0}}if(val>=0x10000000000000000||val<-0x10000000000000000){throw new Error("Given varint doesn't fit into 10 bytes")}pbf.realloc(10);writeBigVarintLow(low,high,pbf);writeBigVarintHigh(high,pbf)}function writeBigVarintLow(low,high,pbf){pbf.buf[pbf.pos++]=low&127|128;low>>>=7;pbf.buf[pbf.pos++]=low&127|128;low>>>=7;pbf.buf[pbf.pos++]=low&127|128;low>>>=7;pbf.buf[pbf.pos++]=low&127|128;low>>>=7;pbf.buf[pbf.pos]=low&127}function writeBigVarintHigh(high,pbf){var lsb=(high&7)<<4;pbf.buf[pbf.pos++]|=lsb|((high>>>=3)?128:0);if(!high)return;pbf.buf[pbf.pos++]=high&127|((high>>>=7)?128:0);if(!high)return;pbf.buf[pbf.pos++]=high&127|((high>>>=7)?128:0);if(!high)return;pbf.buf[pbf.pos++]=high&127|((high>>>=7)?128:0);if(!high)return;pbf.buf[pbf.pos++]=high&127|((high>>>=7)?128:0);if(!high)return;pbf.buf[pbf.pos++]=high&127}function makeRoomForExtraLength(startPos,len,pbf){var extraLen=len<=16383?1:len<=2097151?2:len<=268435455?3:Math.floor(Math.log(len)/(Math.LN2*7));pbf.realloc(extraLen);for(var i=pbf.pos-1;i>=startPos;i--)pbf.buf[i+extraLen]=pbf.buf[i]}function writePackedVarint(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeVarint(arr[i])}function writePackedSVarint(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSVarint(arr[i])}function writePackedFloat(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFloat(arr[i])}function writePackedDouble(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeDouble(arr[i])}function writePackedBoolean(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeBoolean(arr[i])}function writePackedFixed32(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFixed32(arr[i])}function writePackedSFixed32(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSFixed32(arr[i])}function writePackedFixed64(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeFixed64(arr[i])}function writePackedSFixed64(arr,pbf){for(var i=0;i<arr.length;i++)pbf.writeSFixed64(arr[i])}function readUInt32(buf,pos){return(buf[pos]|buf[pos+1]<<8|buf[pos+2]<<16)+buf[pos+3]*16777216}function writeInt32(buf,val,pos){buf[pos]=val;buf[pos+1]=val>>>8;buf[pos+2]=val>>>16;buf[pos+3]=val>>>24}function readInt32(buf,pos){return(buf[pos]|buf[pos+1]<<8|buf[pos+2]<<16)+(buf[pos+3]<<24)}function readUtf8(buf,pos,end){var str="";var i=pos;while(i<end){var b0=buf[i];var c=null;var bytesPerSequence=b0>239?4:b0>223?3:b0>191?2:1;if(i+bytesPerSequence>end)break;var b1,b2,b3;if(bytesPerSequence===1){if(b0<128){c=b0}}else if(bytesPerSequence===2){b1=buf[i+1];if((b1&192)===128){c=(b0&31)<<6|b1&63;if(c<=127){c=null}}}else if(bytesPerSequence===3){b1=buf[i+1];b2=buf[i+2];if((b1&192)===128&&(b2&192)===128){c=(b0&15)<<12|(b1&63)<<6|b2&63;if(c<=2047||c>=55296&&c<=57343){c=null}}}else if(bytesPerSequence===4){b1=buf[i+1];b2=buf[i+2];b3=buf[i+3];if((b1&192)===128&&(b2&192)===128&&(b3&192)===128){c=(b0&15)<<18|(b1&63)<<12|(b2&63)<<6|b3&63;if(c<=65535||c>=1114112){c=null}}}if(c===null){c=65533;bytesPerSequence=1}else if(c>65535){c-=65536;str+=String.fromCharCode(c>>>10&1023|55296);c=56320|c&1023}str+=String.fromCharCode(c);i+=bytesPerSequence}return str}function readUtf8TextDecoder(buf,pos,end){return utf8TextDecoder.decode(buf.subarray(pos,end))}function writeUtf8(buf,str,pos){for(var i=0,c,lead;i<str.length;i++){c=str.charCodeAt(i);if(c>55295&&c<57344){if(lead){if(c<56320){buf[pos++]=239;buf[pos++]=191;buf[pos++]=189;lead=c;continue}else{c=lead-55296<<10|c-56320|65536;lead=null}}else{if(c>56319||i+1===str.length){buf[pos++]=239;buf[pos++]=191;buf[pos++]=189}else{lead=c}continue}}else if(lead){buf[pos++]=239;buf[pos++]=191;buf[pos++]=189;lead=null}if(c<128){buf[pos++]=c}else{if(c<2048){buf[pos++]=c>>6|192}else{if(c<65536){buf[pos++]=c>>12|224}else{buf[pos++]=c>>18|240;buf[pos++]=c>>12&63|128}buf[pos++]=c>>6&63|128}buf[pos++]=c&63|128}}return pos}var Protobuf=getDefaultExportFromCjs$1(pbf);const border$1=3;function readFontstacks(tag,glyphs,pbf){if(tag===1){pbf.readMessage(readFontstack,glyphs)}}function readFontstack(tag,glyphs,pbf){if(tag===3){const{id:id,bitmap:bitmap,width:width,height:height,left:left,top:top,advance:advance}=pbf.readMessage(readGlyph,{});glyphs.push({id:id,bitmap:new AlphaImage({width:width+2*border$1,height:height+2*border$1},bitmap),metrics:{width:width,height:height,left:left,top:top,advance:advance}})}}function readGlyph(tag,glyph,pbf){if(tag===1)glyph.id=pbf.readVarint();else if(tag===2)glyph.bitmap=pbf.readBytes();else if(tag===3)glyph.width=pbf.readVarint();else if(tag===4)glyph.height=pbf.readVarint();else if(tag===5)glyph.left=pbf.readSVarint();else if(tag===6)glyph.top=pbf.readSVarint();else if(tag===7)glyph.advance=pbf.readVarint()}function parseGlyphPbf(data){return new Protobuf(data).readFields(readFontstacks,[])}const GLYPH_PBF_BORDER=border$1;function potpack(boxes){let area=0;let maxWidth=0;for(const box of boxes){area+=box.w*box.h;maxWidth=Math.max(maxWidth,box.w)}boxes.sort(((a,b)=>b.h-a.h));const startWidth=Math.max(Math.ceil(Math.sqrt(area/.95)),maxWidth);const spaces=[{x:0,y:0,w:startWidth,h:Infinity}];let width=0;let height=0;for(const box of boxes){for(let i=spaces.length-1;i>=0;i--){const space=spaces[i];if(box.w>space.w||box.h>space.h)continue;box.x=space.x;box.y=space.y;height=Math.max(height,box.y+box.h);width=Math.max(width,box.x+box.w);if(box.w===space.w&&box.h===space.h){const last=spaces.pop();if(i<spaces.length)spaces[i]=last}else if(box.h===space.h){space.x+=box.w;space.w-=box.w}else if(box.w===space.w){space.y+=box.h;space.h-=box.h}else{spaces.push({x:space.x+box.w,y:space.y,w:space.w-box.w,h:box.h});space.y+=box.h;space.h-=box.h}break}}return{w:width,h:height,fill:area/(width*height)||0}}const IMAGE_PADDING=1;class ImagePosition{constructor(paddedRect,{pixelRatio:pixelRatio,version:version,stretchX:stretchX,stretchY:stretchY,content:content}){this.paddedRect=paddedRect;this.pixelRatio=pixelRatio;this.stretchX=stretchX;this.stretchY=stretchY;this.content=content;this.version=version}get tl(){return[this.paddedRect.x+IMAGE_PADDING,this.paddedRect.y+IMAGE_PADDING]}get br(){return[this.paddedRect.x+this.paddedRect.w-IMAGE_PADDING,this.paddedRect.y+this.paddedRect.h-IMAGE_PADDING]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-IMAGE_PADDING*2)/this.pixelRatio,(this.paddedRect.h-IMAGE_PADDING*2)/this.pixelRatio]}}class ImageAtlas{constructor(icons,patterns){const iconPositions={},patternPositions={};this.haveRenderCallbacks=[];const bins=[];this.addImages(icons,iconPositions,bins);this.addImages(patterns,patternPositions,bins);const{w:w,h:h}=potpack(bins);const image=new RGBAImage({width:w||1,height:h||1});for(const id in icons){const src=icons[id];const bin=iconPositions[id].paddedRect;RGBAImage.copy(src.data,image,{x:0,y:0},{x:bin.x+IMAGE_PADDING,y:bin.y+IMAGE_PADDING},src.data)}for(const id in patterns){const src=patterns[id];const bin=patternPositions[id].paddedRect;const x=bin.x+IMAGE_PADDING,y=bin.y+IMAGE_PADDING,w=src.data.width,h=src.data.height;RGBAImage.copy(src.data,image,{x:0,y:0},{x:x,y:y},src.data);RGBAImage.copy(src.data,image,{x:0,y:h-1},{x:x,y:y-1},{width:w,height:1});RGBAImage.copy(src.data,image,{x:0,y:0},{x:x,y:y+h},{width:w,height:1});RGBAImage.copy(src.data,image,{x:w-1,y:0},{x:x-1,y:y},{width:1,height:h});RGBAImage.copy(src.data,image,{x:0,y:0},{x:x+w,y:y},{width:1,height:h})}this.image=image;this.iconPositions=iconPositions;this.patternPositions=patternPositions}addImages(images,positions,bins){for(const id in images){const src=images[id];const bin={x:0,y:0,w:src.data.width+2*IMAGE_PADDING,h:src.data.height+2*IMAGE_PADDING};bins.push(bin);positions[id]=new ImagePosition(bin,src);if(src.hasRenderCallback){this.haveRenderCallbacks.push(id)}}}patchUpdatedImages(imageManager,texture){imageManager.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const name in imageManager.updatedImages){this.patchUpdatedImage(this.iconPositions[name],imageManager.getImage(name),texture);this.patchUpdatedImage(this.patternPositions[name],imageManager.getImage(name),texture)}}patchUpdatedImage(position,image,texture){if(!position||!image)return;if(position.version===image.version)return;position.version=image.version;const[x,y]=position.tl;texture.update(image.data,undefined,{x:x,y:y})}}register("ImagePosition",ImagePosition);register("ImageAtlas",ImageAtlas);exports.WritingMode=void 0;(function(WritingMode){WritingMode[WritingMode["none"]=0]="none";WritingMode[WritingMode["horizontal"]=1]="horizontal";WritingMode[WritingMode["vertical"]=2]="vertical";WritingMode[WritingMode["horizontalOnly"]=3]="horizontalOnly"})(exports.WritingMode||(exports.WritingMode={}));const SHAPING_DEFAULT_OFFSET=-17;function isEmpty(positionedLines){for(const line of positionedLines){if(line.positionedGlyphs.length!==0){return false}}return true}const PUAbegin=57344;const PUAend=63743;class SectionOptions{constructor(){this.scale=1;this.fontStack="";this.imageName=null}static forText(scale,fontStack){const textOptions=new SectionOptions;textOptions.scale=scale||1;textOptions.fontStack=fontStack;return textOptions}static forImage(imageName){const imageOptions=new SectionOptions;imageOptions.imageName=imageName;return imageOptions}}class TaggedString{constructor(){this.text="";this.sectionIndex=[];this.sections=[];this.imageSectionID=null}static fromFeature(text,defaultFontStack){const result=new TaggedString;for(let i=0;i<text.sections.length;i++){const section=text.sections[i];if(!section.image){result.addTextSection(section,defaultFontStack)}else{result.addImageSection(section)}}return result}length(){return this.text.length}getSection(index){return this.sections[this.sectionIndex[index]]}getSectionIndex(index){return this.sectionIndex[index]}getCharCode(index){return this.text.charCodeAt(index)}verticalizePunctuation(){this.text=verticalizePunctuation(this.text)}trim(){let beginningWhitespace=0;for(let i=0;i<this.text.length&&whitespace[this.text.charCodeAt(i)];i++){beginningWhitespace++}let trailingWhitespace=this.text.length;for(let i=this.text.length-1;i>=0&&i>=beginningWhitespace&&whitespace[this.text.charCodeAt(i)];i--){trailingWhitespace--}this.text=this.text.substring(beginningWhitespace,trailingWhitespace);this.sectionIndex=this.sectionIndex.slice(beginningWhitespace,trailingWhitespace)}substring(start,end){const substring=new TaggedString;substring.text=this.text.substring(start,end);substring.sectionIndex=this.sectionIndex.slice(start,end);substring.sections=this.sections;return substring}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((max,index)=>Math.max(max,this.sections[index].scale)),0)}addTextSection(section,defaultFontStack){this.text+=section.text;this.sections.push(SectionOptions.forText(section.scale,section.fontStack||defaultFontStack));const index=this.sections.length-1;for(let i=0;i<section.text.length;++i){this.sectionIndex.push(index)}}addImageSection(section){const imageName=section.image?section.image.name:"";if(imageName.length===0){warnOnce("Can't add FormattedSection with an empty image.");return}const nextImageSectionCharCode=this.getNextImageSectionCharCode();if(!nextImageSectionCharCode){warnOnce(`Reached maximum number of images ${PUAend-PUAbegin+2}`);return}this.text+=String.fromCharCode(nextImageSectionCharCode);this.sections.push(SectionOptions.forImage(imageName));this.sectionIndex.push(this.sections.length-1)}getNextImageSectionCharCode(){if(!this.imageSectionID){this.imageSectionID=PUAbegin;return this.imageSectionID}if(this.imageSectionID>=PUAend)return null;return++this.imageSectionID}}function breakLines(input,lineBreakPoints){const lines=[];const text=input.text;let start=0;for(const lineBreak of lineBreakPoints){lines.push(input.substring(start,lineBreak));start=lineBreak}if(start<text.length){lines.push(input.substring(start,text.length))}return lines}function shapeText(text,glyphMap,glyphPositions,imagePositions,defaultFontStack,maxWidth,lineHeight,textAnchor,textJustify,spacing,translate,writingMode,allowVerticalPlacement,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom){const logicalInput=TaggedString.fromFeature(text,defaultFontStack);if(writingMode===exports.WritingMode.vertical){logicalInput.verticalizePunctuation()}let lines;const{processBidirectionalText:processBidirectionalText,processStyledBidirectionalText:processStyledBidirectionalText}=rtlWorkerPlugin;if(processBidirectionalText&&logicalInput.sections.length===1){lines=[];const untaggedLines=processBidirectionalText(logicalInput.toString(),determineLineBreaks(logicalInput,spacing,maxWidth,glyphMap,imagePositions,symbolPlacement,layoutTextSize));for(const line of untaggedLines){const taggedLine=new TaggedString;taggedLine.text=line;taggedLine.sections=logicalInput.sections;for(let i=0;i<line.length;i++){taggedLine.sectionIndex.push(0)}lines.push(taggedLine)}}else if(processStyledBidirectionalText){lines=[];const processedLines=processStyledBidirectionalText(logicalInput.text,logicalInput.sectionIndex,determineLineBreaks(logicalInput,spacing,maxWidth,glyphMap,imagePositions,symbolPlacement,layoutTextSize));for(const line of processedLines){const taggedLine=new TaggedString;taggedLine.text=line[0];taggedLine.sectionIndex=line[1];taggedLine.sections=logicalInput.sections;lines.push(taggedLine)}}else{lines=breakLines(logicalInput,determineLineBreaks(logicalInput,spacing,maxWidth,glyphMap,imagePositions,symbolPlacement,layoutTextSize))}const positionedLines=[];const shaping={positionedLines:positionedLines,text:logicalInput.toString(),top:translate[1],bottom:translate[1],left:translate[0],right:translate[0],writingMode:writingMode,iconsInText:false,verticalizable:false};shapeLines(shaping,glyphMap,glyphPositions,imagePositions,lines,lineHeight,textAnchor,textJustify,writingMode,spacing,allowVerticalPlacement,layoutTextSizeThisZoom);if(isEmpty(positionedLines))return false;return shaping}const whitespace={[9]:true,[10]:true,[11]:true,[12]:true,[13]:true,[32]:true};const breakable={[10]:true,[32]:true,[38]:true,[40]:true,[41]:true,[43]:true,[45]:true,[47]:true,[173]:true,[183]:true,[8203]:true,[8208]:true,[8211]:true,[8231]:true};function getGlyphAdvance(codePoint,section,glyphMap,imagePositions,spacing,layoutTextSize){if(!section.imageName){const positions=glyphMap[section.fontStack];const glyph=positions&&positions[codePoint];if(!glyph)return 0;return glyph.metrics.advance*section.scale+spacing}else{const imagePosition=imagePositions[section.imageName];if(!imagePosition)return 0;return imagePosition.displaySize[0]*section.scale*ONE_EM/layoutTextSize+spacing}}function determineAverageLineWidth(logicalInput,spacing,maxWidth,glyphMap,imagePositions,layoutTextSize){let totalWidth=0;for(let index=0;index<logicalInput.length();index++){const section=logicalInput.getSection(index);totalWidth+=getGlyphAdvance(logicalInput.getCharCode(index),section,glyphMap,imagePositions,spacing,layoutTextSize)}const lineCount=Math.max(1,Math.ceil(totalWidth/maxWidth));return totalWidth/lineCount}function calculateBadness(lineWidth,targetWidth,penalty,isLastBreak){const raggedness=Math.pow(lineWidth-targetWidth,2);if(isLastBreak){if(lineWidth<targetWidth){return raggedness/2}else{return raggedness*2}}return raggedness+Math.abs(penalty)*penalty}function calculatePenalty(codePoint,nextCodePoint,penalizableIdeographicBreak){let penalty=0;if(codePoint===10){penalty-=1e4}if(penalizableIdeographicBreak){penalty+=150}if(codePoint===40||codePoint===65288){penalty+=50}if(nextCodePoint===41||nextCodePoint===65289){penalty+=50}return penalty}function evaluateBreak(breakIndex,breakX,targetWidth,potentialBreaks,penalty,isLastBreak){let bestPriorBreak=null;let bestBreakBadness=calculateBadness(breakX,targetWidth,penalty,isLastBreak);for(const potentialBreak of potentialBreaks){const lineWidth=breakX-potentialBreak.x;const breakBadness=calculateBadness(lineWidth,targetWidth,penalty,isLastBreak)+potentialBreak.badness;if(breakBadness<=bestBreakBadness){bestPriorBreak=potentialBreak;bestBreakBadness=breakBadness}}return{index:breakIndex,x:breakX,priorBreak:bestPriorBreak,badness:bestBreakBadness}}function leastBadBreaks(lastLineBreak){if(!lastLineBreak){return[]}return leastBadBreaks(lastLineBreak.priorBreak).concat(lastLineBreak.index)}function determineLineBreaks(logicalInput,spacing,maxWidth,glyphMap,imagePositions,symbolPlacement,layoutTextSize){if(symbolPlacement!=="point")return[];if(!logicalInput)return[];const potentialLineBreaks=[];const targetWidth=determineAverageLineWidth(logicalInput,spacing,maxWidth,glyphMap,imagePositions,layoutTextSize);const hasServerSuggestedBreakpoints=logicalInput.text.indexOf("â")>=0;let currentX=0;for(let i=0;i<logicalInput.length();i++){const section=logicalInput.getSection(i);const codePoint=logicalInput.getCharCode(i);if(!whitespace[codePoint])currentX+=getGlyphAdvance(codePoint,section,glyphMap,imagePositions,spacing,layoutTextSize);if(i<logicalInput.length()-1){const ideographicBreak=charAllowsIdeographicBreaking(codePoint);if(breakable[codePoint]||ideographicBreak||section.imageName){potentialLineBreaks.push(evaluateBreak(i+1,currentX,targetWidth,potentialLineBreaks,calculatePenalty(codePoint,logicalInput.getCharCode(i+1),ideographicBreak&&hasServerSuggestedBreakpoints),false))}}}return leastBadBreaks(evaluateBreak(logicalInput.length(),currentX,targetWidth,potentialLineBreaks,0,true))}function getAnchorAlignment(anchor){let horizontalAlign=.5,verticalAlign=.5;switch(anchor){case"right":case"top-right":case"bottom-right":horizontalAlign=1;break;case"left":case"top-left":case"bottom-left":horizontalAlign=0;break}switch(anchor){case"bottom":case"bottom-right":case"bottom-left":verticalAlign=1;break;case"top":case"top-right":case"top-left":verticalAlign=0;break}return{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}}function shapeLines(shaping,glyphMap,glyphPositions,imagePositions,lines,lineHeight,textAnchor,textJustify,writingMode,spacing,allowVerticalPlacement,layoutTextSizeThisZoom){let x=0;let y=SHAPING_DEFAULT_OFFSET;let maxLineLength=0;let maxLineHeight=0;const justify=textJustify==="right"?1:textJustify==="left"?0:.5;let lineIndex=0;for(const line of lines){line.trim();const lineMaxScale=line.getMaxScale();const maxLineOffset=(lineMaxScale-1)*ONE_EM;const positionedLine={positionedGlyphs:[],lineOffset:0};shaping.positionedLines[lineIndex]=positionedLine;const positionedGlyphs=positionedLine.positionedGlyphs;let lineOffset=0;if(!line.length()){y+=lineHeight;++lineIndex;continue}for(let i=0;i<line.length();i++){const section=line.getSection(i);const sectionIndex=line.getSectionIndex(i);const codePoint=line.getCharCode(i);let baselineOffset=0;let metrics=null;let rect=null;let imageName=null;let verticalAdvance=ONE_EM;const vertical=!(writingMode===exports.WritingMode.horizontal||!allowVerticalPlacement&&!charHasUprightVerticalOrientation(codePoint)||allowVerticalPlacement&&(whitespace[codePoint]||charInComplexShapingScript(codePoint)));if(!section.imageName){const positions=glyphPositions[section.fontStack];const glyphPosition=positions&&positions[codePoint];if(glyphPosition&&glyphPosition.rect){rect=glyphPosition.rect;metrics=glyphPosition.metrics}else{const glyphs=glyphMap[section.fontStack];const glyph=glyphs&&glyphs[codePoint];if(!glyph)continue;metrics=glyph.metrics}baselineOffset=(lineMaxScale-section.scale)*ONE_EM}else{const imagePosition=imagePositions[section.imageName];if(!imagePosition)continue;imageName=section.imageName;shaping.iconsInText=shaping.iconsInText||true;rect=imagePosition.paddedRect;const size=imagePosition.displaySize;section.scale=section.scale*ONE_EM/layoutTextSizeThisZoom;metrics={width:size[0],height:size[1],left:IMAGE_PADDING,top:-GLYPH_PBF_BORDER,advance:vertical?size[1]:size[0]};const imageOffset=ONE_EM-size[1]*section.scale;baselineOffset=maxLineOffset+imageOffset;verticalAdvance=metrics.advance;const offset=vertical?size[0]*section.scale-ONE_EM*lineMaxScale:size[1]*section.scale-ONE_EM*lineMaxScale;if(offset>0&&offset>lineOffset){lineOffset=offset}}if(!vertical){positionedGlyphs.push({glyph:codePoint,imageName:imageName,x:x,y:y+baselineOffset,vertical:vertical,scale:section.scale,fontStack:section.fontStack,sectionIndex:sectionIndex,metrics:metrics,rect:rect});x+=metrics.advance*section.scale+spacing}else{shaping.verticalizable=true;positionedGlyphs.push({glyph:codePoint,imageName:imageName,x:x,y:y+baselineOffset,vertical:vertical,scale:section.scale,fontStack:section.fontStack,sectionIndex:sectionIndex,metrics:metrics,rect:rect});x+=verticalAdvance*section.scale+spacing}}if(positionedGlyphs.length!==0){const lineLength=x-spacing;maxLineLength=Math.max(lineLength,maxLineLength);justifyLine(positionedGlyphs,0,positionedGlyphs.length-1,justify,lineOffset)}x=0;const currentLineHeight=lineHeight*lineMaxScale+lineOffset;positionedLine.lineOffset=Math.max(lineOffset,maxLineOffset);y+=currentLineHeight;maxLineHeight=Math.max(currentLineHeight,maxLineHeight);++lineIndex}const height=y-SHAPING_DEFAULT_OFFSET;const{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}=getAnchorAlignment(textAnchor);align(shaping.positionedLines,justify,horizontalAlign,verticalAlign,maxLineLength,maxLineHeight,lineHeight,height,lines.length);shaping.top+=-verticalAlign*height;shaping.bottom=shaping.top+height;shaping.left+=-horizontalAlign*maxLineLength;shaping.right=shaping.left+maxLineLength}function justifyLine(positionedGlyphs,start,end,justify,lineOffset){if(!justify&&!lineOffset)return;const lastPositionedGlyph=positionedGlyphs[end];const lastAdvance=lastPositionedGlyph.metrics.advance*lastPositionedGlyph.scale;const lineIndent=(positionedGlyphs[end].x+lastAdvance)*justify;for(let j=start;j<=end;j++){positionedGlyphs[j].x-=lineIndent;positionedGlyphs[j].y+=lineOffset}}function align(positionedLines,justify,horizontalAlign,verticalAlign,maxLineLength,maxLineHeight,lineHeight,blockHeight,lineCount){const shiftX=(justify-horizontalAlign)*maxLineLength;let shiftY=0;if(maxLineHeight!==lineHeight){shiftY=-blockHeight*verticalAlign-SHAPING_DEFAULT_OFFSET}else{shiftY=(-verticalAlign*lineCount+.5)*lineHeight}for(const line of positionedLines){for(const positionedGlyph of line.positionedGlyphs){positionedGlyph.x+=shiftX;positionedGlyph.y+=shiftY}}}function shapeIcon(image,iconOffset,iconAnchor){const{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}=getAnchorAlignment(iconAnchor);const dx=iconOffset[0];const dy=iconOffset[1];const x1=dx-image.displaySize[0]*horizontalAlign;const x2=x1+image.displaySize[0];const y1=dy-image.displaySize[1]*verticalAlign;const y2=y1+image.displaySize[1];return{image:image,top:y1,bottom:y2,left:x1,right:x2}}function fitIconToText(shapedIcon,shapedText,textFit,padding,iconOffset,fontScale){const image=shapedIcon.image;let collisionPadding;if(image.content){const content=image.content;const pixelRatio=image.pixelRatio||1;collisionPadding=[content[0]/pixelRatio,content[1]/pixelRatio,image.displaySize[0]-content[2]/pixelRatio,image.displaySize[1]-content[3]/pixelRatio]}const textLeft=shapedText.left*fontScale;const textRight=shapedText.right*fontScale;let top,right,bottom,left;if(textFit==="width"||textFit==="both"){left=iconOffset[0]+textLeft-padding[3];right=iconOffset[0]+textRight+padding[1]}else{left=iconOffset[0]+(textLeft+textRight-image.displaySize[0])/2;right=left+image.displaySize[0]}const textTop=shapedText.top*fontScale;const textBottom=shapedText.bottom*fontScale;if(textFit==="height"||textFit==="both"){top=iconOffset[1]+textTop-padding[0];bottom=iconOffset[1]+textBottom+padding[2]}else{top=iconOffset[1]+(textTop+textBottom-image.displaySize[1])/2;bottom=top+image.displaySize[1]}return{image:image,top:top,right:right,bottom:bottom,left:left,collisionPadding:collisionPadding}}const MAX_GLYPH_ICON_SIZE=255;const SIZE_PACK_FACTOR=128;const MAX_PACKED_SIZE=MAX_GLYPH_ICON_SIZE*SIZE_PACK_FACTOR;function getSizeData(tileZoom,value){const{expression:expression}=value;if(expression.kind==="constant"){const layoutSize=expression.evaluate(new EvaluationParameters(tileZoom+1));return{kind:"constant",layoutSize:layoutSize}}else if(expression.kind==="source"){return{kind:"source"}}else{const{zoomStops:zoomStops,interpolationType:interpolationType}=expression;let lower=0;while(lower<zoomStops.length&&zoomStops[lower]<=tileZoom)lower++;lower=Math.max(0,lower-1);let upper=lower;while(upper<zoomStops.length&&zoomStops[upper]<tileZoom+1)upper++;upper=Math.min(zoomStops.length-1,upper);const minZoom=zoomStops[lower];const maxZoom=zoomStops[upper];if(expression.kind==="composite"){return{kind:"composite",minZoom:minZoom,maxZoom:maxZoom,interpolationType:interpolationType}}const minSize=expression.evaluate(new EvaluationParameters(minZoom));const maxSize=expression.evaluate(new EvaluationParameters(maxZoom));return{kind:"camera",minZoom:minZoom,maxZoom:maxZoom,minSize:minSize,maxSize:maxSize,interpolationType:interpolationType}}}function evaluateSizeForFeature(sizeData,{uSize:uSize,uSizeT:uSizeT},{lowerSize:lowerSize,upperSize:upperSize}){if(sizeData.kind==="source"){return lowerSize/SIZE_PACK_FACTOR}else if(sizeData.kind==="composite"){return interpolate.number(lowerSize/SIZE_PACK_FACTOR,upperSize/SIZE_PACK_FACTOR,uSizeT)}return uSize}function evaluateSizeForZoom(sizeData,zoom){let uSizeT=0;let uSize=0;if(sizeData.kind==="constant"){uSize=sizeData.layoutSize}else if(sizeData.kind!=="source"){const{interpolationType:interpolationType,minZoom:minZoom,maxZoom:maxZoom}=sizeData;const t=!interpolationType?0:clamp$1(Interpolate.interpolationFactor(interpolationType,zoom,minZoom,maxZoom),0,1);if(sizeData.kind==="camera"){uSize=interpolate.number(sizeData.minSize,sizeData.maxSize,t)}else{uSizeT=t}}return{uSizeT:uSizeT,uSize:uSize}}function getOverlapMode(layout,overlapProp,allowOverlapProp){let result="never";const overlap=layout.get(overlapProp);if(overlap){result=overlap}else if(layout.get(allowOverlapProp)){result="always"}return result}const vectorTileFeatureTypes=vectorTile.VectorTileFeature.types;const shaderOpacityAttributes=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function addVertex(array,anchorX,anchorY,ox,oy,tx,ty,sizeVertex,isSDF,pixelOffsetX,pixelOffsetY,minFontScaleX,minFontScaleY){const aSizeX=sizeVertex?Math.min(MAX_PACKED_SIZE,Math.round(sizeVertex[0])):0;const aSizeY=sizeVertex?Math.min(MAX_PACKED_SIZE,Math.round(sizeVertex[1])):0;array.emplaceBack(anchorX,anchorY,Math.round(ox*32),Math.round(oy*32),tx,ty,(aSizeX<<1)+(isSDF?1:0),aSizeY,pixelOffsetX*16,pixelOffsetY*16,minFontScaleX*256,minFontScaleY*256)}function addDynamicAttributes(dynamicLayoutVertexArray,p,angle){dynamicLayoutVertexArray.emplaceBack(p.x,p.y,angle);dynamicLayoutVertexArray.emplaceBack(p.x,p.y,angle);dynamicLayoutVertexArray.emplaceBack(p.x,p.y,angle);dynamicLayoutVertexArray.emplaceBack(p.x,p.y,angle)}function containsRTLText(formattedText){for(const section of formattedText.sections){if(stringContainsRTLText(section.text)){return true}}return false}class SymbolBuffers{constructor(programConfigurations){this.layoutVertexArray=new SymbolLayoutArray;this.indexArray=new TriangleIndexArray;this.programConfigurations=programConfigurations;this.segments=new SegmentVector;this.dynamicLayoutVertexArray=new SymbolDynamicLayoutArray;this.opacityVertexArray=new SymbolOpacityArray;this.hasVisibleVertices=false;this.placedSymbolArray=new PlacedSymbolArray}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(context,dynamicIndexBuffer,upload,update){if(this.isEmpty()){return}if(upload){this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,symbolLayoutAttributes.members);this.indexBuffer=context.createIndexBuffer(this.indexArray,dynamicIndexBuffer);this.dynamicLayoutVertexBuffer=context.createVertexBuffer(this.dynamicLayoutVertexArray,dynamicLayoutAttributes.members,true);this.opacityVertexBuffer=context.createVertexBuffer(this.opacityVertexArray,shaderOpacityAttributes,true);this.opacityVertexBuffer.itemSize=1}if(upload||update){this.programConfigurations.upload(context)}}destroy(){if(!this.layoutVertexBuffer)return;this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.programConfigurations.destroy();this.segments.destroy();this.dynamicLayoutVertexBuffer.destroy();this.opacityVertexBuffer.destroy()}}register("SymbolBuffers",SymbolBuffers);class CollisionBuffers{constructor(LayoutArray,layoutAttributes,IndexArray){this.layoutVertexArray=new LayoutArray;this.layoutAttributes=layoutAttributes;this.indexArray=new IndexArray;this.segments=new SegmentVector;this.collisionVertexArray=new CollisionVertexArray}upload(context){this.layoutVertexBuffer=context.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes);this.indexBuffer=context.createIndexBuffer(this.indexArray);this.collisionVertexBuffer=context.createVertexBuffer(this.collisionVertexArray,collisionVertexAttributes.members,true)}destroy(){if(!this.layoutVertexBuffer)return;this.layoutVertexBuffer.destroy();this.indexBuffer.destroy();this.segments.destroy();this.collisionVertexBuffer.destroy()}}register("CollisionBuffers",CollisionBuffers);class SymbolBucket{constructor(options){this.collisionBoxArray=options.collisionBoxArray;this.zoom=options.zoom;this.overscaling=options.overscaling;this.layers=options.layers;this.layerIds=this.layers.map((layer=>layer.id));this.index=options.index;this.pixelRatio=options.pixelRatio;this.sourceLayerIndex=options.sourceLayerIndex;this.hasPattern=false;this.hasRTLText=false;this.sortKeyRanges=[];this.collisionCircleArray=[];this.placementInvProjMatrix=identity$2([]);this.placementViewportMatrix=identity$2([]);const layer=this.layers[0];const unevaluatedLayoutValues=layer._unevaluatedLayout._values;this.textSizeData=getSizeData(this.zoom,unevaluatedLayoutValues["text-size"]);this.iconSizeData=getSizeData(this.zoom,unevaluatedLayoutValues["icon-size"]);const layout=this.layers[0].layout;const sortKey=layout.get("symbol-sort-key");const zOrder=layout.get("symbol-z-order");this.canOverlap=getOverlapMode(layout,"text-overlap","text-allow-overlap")!=="never"||getOverlapMode(layout,"icon-overlap","icon-allow-overlap")!=="never"||layout.get("text-ignore-placement")||layout.get("icon-ignore-placement");this.sortFeaturesByKey=zOrder!=="viewport-y"&&!sortKey.isConstant();const zOrderByViewportY=zOrder==="viewport-y"||zOrder==="auto"&&!this.sortFeaturesByKey;this.sortFeaturesByY=zOrderByViewportY&&this.canOverlap;if(layout.get("symbol-placement")==="point"){this.writingModes=layout.get("text-writing-mode").map((wm=>exports.WritingMode[wm]))}this.stateDependentLayerIds=this.layers.filter((l=>l.isStateDependent())).map((l=>l.id));this.sourceID=options.sourceID}createArrays(){this.text=new SymbolBuffers(new ProgramConfigurationSet(this.layers,this.zoom,(property=>/^text/.test(property))));this.icon=new SymbolBuffers(new ProgramConfigurationSet(this.layers,this.zoom,(property=>/^icon/.test(property))));this.glyphOffsetArray=new GlyphOffsetArray;this.lineVertexArray=new SymbolLineVertexArray;this.symbolInstances=new SymbolInstanceArray;this.textAnchorOffsets=new TextAnchorOffsetArray}calculateGlyphDependencies(text,stack,textAlongLine,allowVerticalPlacement,doesAllowVerticalWritingMode){for(let i=0;i<text.length;i++){stack[text.charCodeAt(i)]=true;if((textAlongLine||allowVerticalPlacement)&&doesAllowVerticalWritingMode){const verticalChar=verticalizedCharacterMap[text.charAt(i)];if(verticalChar){stack[verticalChar.charCodeAt(0)]=true}}}}populate(features,options,canonical){const layer=this.layers[0];const layout=layer.layout;const textFont=layout.get("text-font");const textField=layout.get("text-field");const iconImage=layout.get("icon-image");const hasText=(textField.value.kind!=="constant"||textField.value.value instanceof Formatted&&!textField.value.value.isEmpty()||textField.value.value.toString().length>0)&&(textFont.value.kind!=="constant"||textFont.value.value.length>0);const hasIcon=iconImage.value.kind!=="constant"||!!iconImage.value.value||Object.keys(iconImage.parameters).length>0;const symbolSortKey=layout.get("symbol-sort-key");this.features=[];if(!hasText&&!hasIcon){return}const icons=options.iconDependencies;const stacks=options.glyphDependencies;const availableImages=options.availableImages;const globalProperties=new EvaluationParameters(this.zoom);for(const{feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex}of features){const needGeometry=layer._featureFilter.needGeometry;const evaluationFeature=toEvaluationFeature(feature,needGeometry);if(!layer._featureFilter.filter(globalProperties,evaluationFeature,canonical)){continue}if(!needGeometry)evaluationFeature.geometry=loadGeometry(feature);let text;if(hasText){const resolvedTokens=layer.getValueAndResolveTokens("text-field",evaluationFeature,canonical,availableImages);const formattedText=Formatted.factory(resolvedTokens);if(containsRTLText(formattedText)){this.hasRTLText=true}if(!this.hasRTLText||rtlWorkerPlugin.getRTLTextPluginStatus()==="unavailable"||this.hasRTLText&&rtlWorkerPlugin.isParsed()){text=transformText(formattedText,layer,evaluationFeature)}}let icon;if(hasIcon){const resolvedTokens=layer.getValueAndResolveTokens("icon-image",evaluationFeature,canonical,availableImages);if(resolvedTokens instanceof ResolvedImage){icon=resolvedTokens}else{icon=ResolvedImage.fromString(resolvedTokens)}}if(!text&&!icon){continue}const sortKey=this.sortFeaturesByKey?symbolSortKey.evaluate(evaluationFeature,{},canonical):undefined;const symbolFeature={id:id,text:text,icon:icon,index:index,sourceLayerIndex:sourceLayerIndex,geometry:evaluationFeature.geometry,properties:feature.properties,type:vectorTileFeatureTypes[feature.type],sortKey:sortKey};this.features.push(symbolFeature);if(icon){icons[icon.name]=true}if(text){const fontStack=textFont.evaluate(evaluationFeature,{},canonical).join(",");const textAlongLine=layout.get("text-rotation-alignment")!=="viewport"&&layout.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(exports.WritingMode.vertical)>=0;for(const section of text.sections){if(!section.image){const doesAllowVerticalWritingMode=allowsVerticalWritingMode(text.toString());const sectionFont=section.fontStack||fontStack;const sectionStack=stacks[sectionFont]=stacks[sectionFont]||{};this.calculateGlyphDependencies(section.text,sectionStack,textAlongLine,this.allowVerticalPlacement,doesAllowVerticalWritingMode)}else{icons[section.image.name]=true}}}}if(layout.get("symbol-placement")==="line"){this.features=mergeLines(this.features)}if(this.sortFeaturesByKey){this.features.sort(((a,b)=>a.sortKey-b.sortKey))}}update(states,vtLayer,imagePositions){if(!this.stateDependentLayers.length)return;this.text.programConfigurations.updatePaintArrays(states,vtLayer,this.layers,imagePositions);this.icon.programConfigurations.updatePaintArrays(states,vtLayer,this.layers,imagePositions)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(context){if(!this.uploaded&&this.hasDebugData()){this.textCollisionBox.upload(context);this.iconCollisionBox.upload(context)}this.text.upload(context,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload);this.icon.upload(context,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload);this.uploaded=true}destroyDebugData(){this.textCollisionBox.destroy();this.iconCollisionBox.destroy()}destroy(){this.text.destroy();this.icon.destroy();if(this.hasDebugData()){this.destroyDebugData()}}addToLineVertexArray(anchor,line){const lineStartIndex=this.lineVertexArray.length;if(anchor.segment!==undefined){let sumForwardLength=anchor.dist(line[anchor.segment+1]);let sumBackwardLength=anchor.dist(line[anchor.segment]);const vertices={};for(let i=anchor.segment+1;i<line.length;i++){vertices[i]={x:line[i].x,y:line[i].y,tileUnitDistanceFromAnchor:sumForwardLength};if(i<line.length-1){sumForwardLength+=line[i+1].dist(line[i])}}for(let i=anchor.segment||0;i>=0;i--){vertices[i]={x:line[i].x,y:line[i].y,tileUnitDistanceFromAnchor:sumBackwardLength};if(i>0){sumBackwardLength+=line[i-1].dist(line[i])}}for(let i=0;i<line.length;i++){const vertex=vertices[i];this.lineVertexArray.emplaceBack(vertex.x,vertex.y,vertex.tileUnitDistanceFromAnchor)}}return{lineStartIndex:lineStartIndex,lineLength:this.lineVertexArray.length-lineStartIndex}}addSymbols(arrays,quads,sizeVertex,lineOffset,alongLine,feature,writingMode,labelAnchor,lineStartIndex,lineLength,associatedIconIndex,canonical){const indexArray=arrays.indexArray;const layoutVertexArray=arrays.layoutVertexArray;const segment=arrays.segments.prepareSegment(4*quads.length,layoutVertexArray,indexArray,this.canOverlap?feature.sortKey:undefined);const glyphOffsetArrayStart=this.glyphOffsetArray.length;const vertexStartIndex=segment.vertexLength;const angle=this.allowVerticalPlacement&&writingMode===exports.WritingMode.vertical?Math.PI/2:0;const sections=feature.text&&feature.text.sections;for(let i=0;i<quads.length;i++){const{tl:tl,tr:tr,bl:bl,br:br,tex:tex,pixelOffsetTL:pixelOffsetTL,pixelOffsetBR:pixelOffsetBR,minFontScaleX:minFontScaleX,minFontScaleY:minFontScaleY,glyphOffset:glyphOffset,isSDF:isSDF,sectionIndex:sectionIndex}=quads[i];const index=segment.vertexLength;const y=glyphOffset[1];addVertex(layoutVertexArray,labelAnchor.x,labelAnchor.y,tl.x,y+tl.y,tex.x,tex.y,sizeVertex,isSDF,pixelOffsetTL.x,pixelOffsetTL.y,minFontScaleX,minFontScaleY);addVertex(layoutVertexArray,labelAnchor.x,labelAnchor.y,tr.x,y+tr.y,tex.x+tex.w,tex.y,sizeVertex,isSDF,pixelOffsetBR.x,pixelOffsetTL.y,minFontScaleX,minFontScaleY);addVertex(layoutVertexArray,labelAnchor.x,labelAnchor.y,bl.x,y+bl.y,tex.x,tex.y+tex.h,sizeVertex,isSDF,pixelOffsetTL.x,pixelOffsetBR.y,minFontScaleX,minFontScaleY);addVertex(layoutVertexArray,labelAnchor.x,labelAnchor.y,br.x,y+br.y,tex.x+tex.w,tex.y+tex.h,sizeVertex,isSDF,pixelOffsetBR.x,pixelOffsetBR.y,minFontScaleX,minFontScaleY);addDynamicAttributes(arrays.dynamicLayoutVertexArray,labelAnchor,angle);indexArray.emplaceBack(index,index+1,index+2);indexArray.emplaceBack(index+1,index+2,index+3);segment.vertexLength+=4;segment.primitiveLength+=2;this.glyphOffsetArray.emplaceBack(glyphOffset[0]);if(i===quads.length-1||sectionIndex!==quads[i+1].sectionIndex){arrays.programConfigurations.populatePaintArrays(layoutVertexArray.length,feature,feature.index,{},canonical,sections&&sections[sectionIndex])}}arrays.placedSymbolArray.emplaceBack(labelAnchor.x,labelAnchor.y,glyphOffsetArrayStart,this.glyphOffsetArray.length-glyphOffsetArrayStart,vertexStartIndex,lineStartIndex,lineLength,labelAnchor.segment,sizeVertex?sizeVertex[0]:0,sizeVertex?sizeVertex[1]:0,lineOffset[0],lineOffset[1],writingMode,0,false,0,associatedIconIndex)}_addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,point,anchorX,anchorY,extrude){collisionVertexArray.emplaceBack(0,0);return layoutVertexArray.emplaceBack(point.x,point.y,anchorX,anchorY,Math.round(extrude.x),Math.round(extrude.y))}addCollisionDebugVertices(x1,y1,x2,y2,arrays,boxAnchorPoint,symbolInstance){const segment=arrays.segments.prepareSegment(4,arrays.layoutVertexArray,arrays.indexArray);const index=segment.vertexLength;const layoutVertexArray=arrays.layoutVertexArray;const collisionVertexArray=arrays.collisionVertexArray;const anchorX=symbolInstance.anchorX;const anchorY=symbolInstance.anchorY;this._addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,boxAnchorPoint,anchorX,anchorY,new Point$2(x1,y1));this._addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,boxAnchorPoint,anchorX,anchorY,new Point$2(x2,y1));this._addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,boxAnchorPoint,anchorX,anchorY,new Point$2(x2,y2));this._addCollisionDebugVertex(layoutVertexArray,collisionVertexArray,boxAnchorPoint,anchorX,anchorY,new Point$2(x1,y2));segment.vertexLength+=4;const indexArray=arrays.indexArray;indexArray.emplaceBack(index,index+1);indexArray.emplaceBack(index+1,index+2);indexArray.emplaceBack(index+2,index+3);indexArray.emplaceBack(index+3,index);segment.primitiveLength+=4}addDebugCollisionBoxes(startIndex,endIndex,symbolInstance,isText){for(let b=startIndex;b<endIndex;b++){const box=this.collisionBoxArray.get(b);const x1=box.x1;const y1=box.y1;const x2=box.x2;const y2=box.y2;this.addCollisionDebugVertices(x1,y1,x2,y2,isText?this.textCollisionBox:this.iconCollisionBox,box.anchorPoint,symbolInstance)}}generateCollisionDebugBuffers(){if(this.hasDebugData()){this.destroyDebugData()}this.textCollisionBox=new CollisionBuffers(CollisionBoxLayoutArray,collisionBoxLayout.members,LineIndexArray);this.iconCollisionBox=new CollisionBuffers(CollisionBoxLayoutArray,collisionBoxLayout.members,LineIndexArray);for(let i=0;i<this.symbolInstances.length;i++){const symbolInstance=this.symbolInstances.get(i);this.addDebugCollisionBoxes(symbolInstance.textBoxStartIndex,symbolInstance.textBoxEndIndex,symbolInstance,true);this.addDebugCollisionBoxes(symbolInstance.verticalTextBoxStartIndex,symbolInstance.verticalTextBoxEndIndex,symbolInstance,true);this.addDebugCollisionBoxes(symbolInstance.iconBoxStartIndex,symbolInstance.iconBoxEndIndex,symbolInstance,false);this.addDebugCollisionBoxes(symbolInstance.verticalIconBoxStartIndex,symbolInstance.verticalIconBoxEndIndex,symbolInstance,false)}}_deserializeCollisionBoxesForSymbol(collisionBoxArray,textStartIndex,textEndIndex,verticalTextStartIndex,verticalTextEndIndex,iconStartIndex,iconEndIndex,verticalIconStartIndex,verticalIconEndIndex){const collisionArrays={};for(let k=textStartIndex;k<textEndIndex;k++){const box=collisionBoxArray.get(k);collisionArrays.textBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY};collisionArrays.textFeatureIndex=box.featureIndex;break}for(let k=verticalTextStartIndex;k<verticalTextEndIndex;k++){const box=collisionBoxArray.get(k);collisionArrays.verticalTextBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY};collisionArrays.verticalTextFeatureIndex=box.featureIndex;break}for(let k=iconStartIndex;k<iconEndIndex;k++){const box=collisionBoxArray.get(k);collisionArrays.iconBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY};collisionArrays.iconFeatureIndex=box.featureIndex;break}for(let k=verticalIconStartIndex;k<verticalIconEndIndex;k++){const box=collisionBoxArray.get(k);collisionArrays.verticalIconBox={x1:box.x1,y1:box.y1,x2:box.x2,y2:box.y2,anchorPointX:box.anchorPointX,anchorPointY:box.anchorPointY};collisionArrays.verticalIconFeatureIndex=box.featureIndex;break}return collisionArrays}deserializeCollisionBoxes(collisionBoxArray){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const symbolInstance=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(collisionBoxArray,symbolInstance.textBoxStartIndex,symbolInstance.textBoxEndIndex,symbolInstance.verticalTextBoxStartIndex,symbolInstance.verticalTextBoxEndIndex,symbolInstance.iconBoxStartIndex,symbolInstance.iconBoxEndIndex,symbolInstance.verticalIconBoxStartIndex,symbolInstance.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(iconOrText,placedSymbolIndex){const placedSymbol=iconOrText.placedSymbolArray.get(placedSymbolIndex);const endIndex=placedSymbol.vertexStartIndex+placedSymbol.numGlyphs*4;for(let vertexIndex=placedSymbol.vertexStartIndex;vertexIndex<endIndex;vertexIndex+=4){iconOrText.indexArray.emplaceBack(vertexIndex,vertexIndex+1,vertexIndex+2);iconOrText.indexArray.emplaceBack(vertexIndex+1,vertexIndex+2,vertexIndex+3)}}getSortedSymbolIndexes(angle){if(this.sortedAngle===angle&&this.symbolInstanceIndexes!==undefined){return this.symbolInstanceIndexes}const sin=Math.sin(angle);const cos=Math.cos(angle);const rotatedYs=[];const featureIndexes=[];const result=[];for(let i=0;i<this.symbolInstances.length;++i){result.push(i);const symbolInstance=this.symbolInstances.get(i);rotatedYs.push(Math.round(sin*symbolInstance.anchorX+cos*symbolInstance.anchorY)|0);featureIndexes.push(symbolInstance.featureIndex)}result.sort(((aIndex,bIndex)=>rotatedYs[aIndex]-rotatedYs[bIndex]||featureIndexes[bIndex]-featureIndexes[aIndex]));return result}addToSortKeyRanges(symbolInstanceIndex,sortKey){const last=this.sortKeyRanges[this.sortKeyRanges.length-1];if(last&&last.sortKey===sortKey){last.symbolInstanceEnd=symbolInstanceIndex+1}else{this.sortKeyRanges.push({sortKey:sortKey,symbolInstanceStart:symbolInstanceIndex,symbolInstanceEnd:symbolInstanceIndex+1})}}sortFeatures(angle){if(!this.sortFeaturesByY)return;if(this.sortedAngle===angle)return;if(this.text.segments.get().length>1||this.icon.segments.get().length>1)return;this.symbolInstanceIndexes=this.getSortedSymbolIndexes(angle);this.sortedAngle=angle;this.text.indexArray.clear();this.icon.indexArray.clear();this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const symbolInstance=this.symbolInstances.get(i);this.featureSortOrder.push(symbolInstance.featureIndex);[symbolInstance.rightJustifiedTextSymbolIndex,symbolInstance.centerJustifiedTextSymbolIndex,symbolInstance.leftJustifiedTextSymbolIndex].forEach(((index,i,array)=>{if(index>=0&&array.indexOf(index)===i){this.addIndicesForPlacedSymbol(this.text,index)}}));if(symbolInstance.verticalPlacedTextSymbolIndex>=0){this.addIndicesForPlacedSymbol(this.text,symbolInstance.verticalPlacedTextSymbolIndex)}if(symbolInstance.placedIconSymbolIndex>=0){this.addIndicesForPlacedSymbol(this.icon,symbolInstance.placedIconSymbolIndex)}if(symbolInstance.verticalPlacedIconSymbolIndex>=0){this.addIndicesForPlacedSymbol(this.icon,symbolInstance.verticalPlacedIconSymbolIndex)}}if(this.text.indexBuffer)this.text.indexBuffer.updateData(this.text.indexArray);if(this.icon.indexBuffer)this.icon.indexBuffer.updateData(this.icon.indexArray)}}register("SymbolBucket",SymbolBucket,{omit:["layers","collisionBoxArray","features","compareText"]});SymbolBucket.MAX_GLYPHS=65535;SymbolBucket.addDynamicAttributes=addDynamicAttributes;function resolveTokens(properties,text){return text.replace(/{([^{}]+)}/g,((match,key)=>properties&&key in properties?String(properties[key]):""))}let layout;const getLayout=()=>layout=layout||new Properties({"symbol-placement":new DataConstantProperty(v8Spec["layout_symbol"]["symbol-placement"]),"symbol-spacing":new DataConstantProperty(v8Spec["layout_symbol"]["symbol-spacing"]),"symbol-avoid-edges":new DataConstantProperty(v8Spec["layout_symbol"]["symbol-avoid-edges"]),"symbol-sort-key":new DataDrivenProperty(v8Spec["layout_symbol"]["symbol-sort-key"]),"symbol-z-order":new DataConstantProperty(v8Spec["layout_symbol"]["symbol-z-order"]),"icon-allow-overlap":new DataConstantProperty(v8Spec["layout_symbol"]["icon-allow-overlap"]),"icon-overlap":new DataConstantProperty(v8Spec["layout_symbol"]["icon-overlap"]),"icon-ignore-placement":new DataConstantProperty(v8Spec["layout_symbol"]["icon-ignore-placement"]),"icon-optional":new DataConstantProperty(v8Spec["layout_symbol"]["icon-optional"]),"icon-rotation-alignment":new DataConstantProperty(v8Spec["layout_symbol"]["icon-rotation-alignment"]),"icon-size":new DataDrivenProperty(v8Spec["layout_symbol"]["icon-size"]),"icon-text-fit":new DataConstantProperty(v8Spec["layout_symbol"]["icon-text-fit"]),"icon-text-fit-padding":new DataConstantProperty(v8Spec["layout_symbol"]["icon-text-fit-padding"]),"icon-image":new DataDrivenProperty(v8Spec["layout_symbol"]["icon-image"]),"icon-rotate":new DataDrivenProperty(v8Spec["layout_symbol"]["icon-rotate"]),"icon-padding":new DataDrivenProperty(v8Spec["layout_symbol"]["icon-padding"]),"icon-keep-upright":new DataConstantProperty(v8Spec["layout_symbol"]["icon-keep-upright"]),"icon-offset":new DataDrivenProperty(v8Spec["layout_symbol"]["icon-offset"]),"icon-anchor":new DataDrivenProperty(v8Spec["layout_symbol"]["icon-anchor"]),"icon-pitch-alignment":new DataConstantProperty(v8Spec["layout_symbol"]["icon-pitch-alignment"]),"text-pitch-alignment":new DataConstantProperty(v8Spec["layout_symbol"]["text-pitch-alignment"]),"text-rotation-alignment":new DataConstantProperty(v8Spec["layout_symbol"]["text-rotation-alignment"]),"text-field":new DataDrivenProperty(v8Spec["layout_symbol"]["text-field"]),"text-font":new DataDrivenProperty(v8Spec["layout_symbol"]["text-font"]),"text-size":new DataDrivenProperty(v8Spec["layout_symbol"]["text-size"]),"text-max-width":new DataDrivenProperty(v8Spec["layout_symbol"]["text-max-width"]),"text-line-height":new DataConstantProperty(v8Spec["layout_symbol"]["text-line-height"]),"text-letter-spacing":new DataDrivenProperty(v8Spec["layout_symbol"]["text-letter-spacing"]),"text-justify":new DataDrivenProperty(v8Spec["layout_symbol"]["text-justify"]),"text-radial-offset":new DataDrivenProperty(v8Spec["layout_symbol"]["text-radial-offset"]),"text-variable-anchor":new DataConstantProperty(v8Spec["layout_symbol"]["text-variable-anchor"]),"text-variable-anchor-offset":new DataDrivenProperty(v8Spec["layout_symbol"]["text-variable-anchor-offset"]),"text-anchor":new DataDrivenProperty(v8Spec["layout_symbol"]["text-anchor"]),"text-max-angle":new DataConstantProperty(v8Spec["layout_symbol"]["text-max-angle"]),"text-writing-mode":new DataConstantProperty(v8Spec["layout_symbol"]["text-writing-mode"]),"text-rotate":new DataDrivenProperty(v8Spec["layout_symbol"]["text-rotate"]),"text-padding":new DataConstantProperty(v8Spec["layout_symbol"]["text-padding"]),"text-keep-upright":new DataConstantProperty(v8Spec["layout_symbol"]["text-keep-upright"]),"text-transform":new DataDrivenProperty(v8Spec["layout_symbol"]["text-transform"]),"text-offset":new DataDrivenProperty(v8Spec["layout_symbol"]["text-offset"]),"text-allow-overlap":new DataConstantProperty(v8Spec["layout_symbol"]["text-allow-overlap"]),"text-overlap":new DataConstantProperty(v8Spec["layout_symbol"]["text-overlap"]),"text-ignore-placement":new DataConstantProperty(v8Spec["layout_symbol"]["text-ignore-placement"]),"text-optional":new DataConstantProperty(v8Spec["layout_symbol"]["text-optional"])});let paint$2;const getPaint$2=()=>paint$2=paint$2||new Properties({"icon-opacity":new DataDrivenProperty(v8Spec["paint_symbol"]["icon-opacity"]),"icon-color":new DataDrivenProperty(v8Spec["paint_symbol"]["icon-color"]),"icon-halo-color":new DataDrivenProperty(v8Spec["paint_symbol"]["icon-halo-color"]),"icon-halo-width":new DataDrivenProperty(v8Spec["paint_symbol"]["icon-halo-width"]),"icon-halo-blur":new DataDrivenProperty(v8Spec["paint_symbol"]["icon-halo-blur"]),"icon-translate":new DataConstantProperty(v8Spec["paint_symbol"]["icon-translate"]),"icon-translate-anchor":new DataConstantProperty(v8Spec["paint_symbol"]["icon-translate-anchor"]),"text-opacity":new DataDrivenProperty(v8Spec["paint_symbol"]["text-opacity"]),"text-color":new DataDrivenProperty(v8Spec["paint_symbol"]["text-color"],{runtimeType:ColorType,getOverride:o=>o.textColor,hasOverride:o=>!!o.textColor}),"text-halo-color":new DataDrivenProperty(v8Spec["paint_symbol"]["text-halo-color"]),"text-halo-width":new DataDrivenProperty(v8Spec["paint_symbol"]["text-halo-width"]),"text-halo-blur":new DataDrivenProperty(v8Spec["paint_symbol"]["text-halo-blur"]),"text-translate":new DataConstantProperty(v8Spec["paint_symbol"]["text-translate"]),"text-translate-anchor":new DataConstantProperty(v8Spec["paint_symbol"]["text-translate-anchor"])});var properties$2={get paint(){return getPaint$2()},get layout(){return getLayout()}};class FormatSectionOverride{constructor(defaultValue){if(defaultValue.property.overrides===undefined)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=defaultValue.property.overrides?defaultValue.property.overrides.runtimeType:NullType;this.defaultValue=defaultValue}evaluate(ctx){if(ctx.formattedSection){const overrides=this.defaultValue.property.overrides;if(overrides&&overrides.hasOverride(ctx.formattedSection)){return overrides.getOverride(ctx.formattedSection)}}if(ctx.feature&&ctx.featureState){return this.defaultValue.evaluate(ctx.feature,ctx.featureState)}return this.defaultValue.property.specification.default}eachChild(fn){if(!this.defaultValue.isConstant()){const expr=this.defaultValue.value;fn(expr._styleExpression.expression)}}outputDefined(){return false}serialize(){return null}}register("FormatSectionOverride",FormatSectionOverride,{omit:["defaultValue"]});class SymbolStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$2)}recalculate(parameters,availableImages){super.recalculate(parameters,availableImages);if(this.layout.get("icon-rotation-alignment")==="auto"){if(this.layout.get("symbol-placement")!=="point"){this.layout._values["icon-rotation-alignment"]="map"}else{this.layout._values["icon-rotation-alignment"]="viewport"}}if(this.layout.get("text-rotation-alignment")==="auto"){if(this.layout.get("symbol-placement")!=="point"){this.layout._values["text-rotation-alignment"]="map"}else{this.layout._values["text-rotation-alignment"]="viewport"}}if(this.layout.get("text-pitch-alignment")==="auto"){this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"}if(this.layout.get("icon-pitch-alignment")==="auto"){this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")}if(this.layout.get("symbol-placement")==="point"){const writingModes=this.layout.get("text-writing-mode");if(writingModes){const deduped=[];for(const m of writingModes){if(deduped.indexOf(m)<0)deduped.push(m)}this.layout._values["text-writing-mode"]=deduped}else{this.layout._values["text-writing-mode"]=["horizontal"]}}this._setPaintOverrides()}getValueAndResolveTokens(name,feature,canonical,availableImages){const value=this.layout.get(name).evaluate(feature,{},canonical,availableImages);const unevaluated=this._unevaluatedLayout._values[name];if(!unevaluated.isDataDriven()&&!isExpression(unevaluated.value)&&value){return resolveTokens(feature.properties,value)}return value}createBucket(parameters){return new SymbolBucket(parameters)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const overridable of properties$2.paint.overridableProperties){if(!SymbolStyleLayer.hasPaintOverride(this.layout,overridable)){continue}const overriden=this.paint.get(overridable);const override=new FormatSectionOverride(overriden);const styleExpression=new StyleExpression(override,overriden.property.specification);let expression=null;if(overriden.value.kind==="constant"||overriden.value.kind==="source"){expression=new ZoomConstantExpression("source",styleExpression)}else{expression=new ZoomDependentExpression("composite",styleExpression,overriden.value.zoomStops)}this.paint._values[overridable]=new PossiblyEvaluatedPropertyValue(overriden.property,expression,overriden.parameters)}}_handleOverridablePaintPropertyUpdate(name,oldValue,newValue){if(!this.layout||oldValue.isDataDriven()||newValue.isDataDriven()){return false}return SymbolStyleLayer.hasPaintOverride(this.layout,name)}static hasPaintOverride(layout,propertyName){const textField=layout.get("text-field");const property=properties$2.paint.properties[propertyName];let hasOverrides=false;const checkSections=sections=>{for(const section of sections){if(property.overrides&&property.overrides.hasOverride(section)){hasOverrides=true;return}}};if(textField.value.kind==="constant"&&textField.value.value instanceof Formatted){checkSections(textField.value.value.sections)}else if(textField.value.kind==="source"){const checkExpression=expression=>{if(hasOverrides)return;if(expression instanceof Literal&&typeOf(expression.value)===FormattedType){const formatted=expression.value;checkSections(formatted.sections)}else if(expression instanceof FormatExpression){checkSections(expression.sections)}else{expression.eachChild(checkExpression)}};const expr=textField.value;if(expr._styleExpression){checkExpression(expr._styleExpression.expression)}}return hasOverrides}}function getIconPadding(layout,feature,canonical,pixelRatio=1){const result=layout.get("icon-padding").evaluate(feature,{},canonical);const values=result&&result.values;return[values[0]*pixelRatio,values[1]*pixelRatio,values[2]*pixelRatio,values[3]*pixelRatio]}let paint$1;const getPaint$1=()=>paint$1=paint$1||new Properties({"background-color":new DataConstantProperty(v8Spec["paint_background"]["background-color"]),"background-pattern":new CrossFadedProperty(v8Spec["paint_background"]["background-pattern"]),"background-opacity":new DataConstantProperty(v8Spec["paint_background"]["background-opacity"])});var properties$1={get paint(){return getPaint$1()}};class BackgroundStyleLayer extends StyleLayer{constructor(layer){super(layer,properties$1)}}let paint;const getPaint=()=>paint=paint||new Properties({"raster-opacity":new DataConstantProperty(v8Spec["paint_raster"]["raster-opacity"]),"raster-hue-rotate":new DataConstantProperty(v8Spec["paint_raster"]["raster-hue-rotate"]),"raster-brightness-min":new DataConstantProperty(v8Spec["paint_raster"]["raster-brightness-min"]),"raster-brightness-max":new DataConstantProperty(v8Spec["paint_raster"]["raster-brightness-max"]),"raster-saturation":new DataConstantProperty(v8Spec["paint_raster"]["raster-saturation"]),"raster-contrast":new DataConstantProperty(v8Spec["paint_raster"]["raster-contrast"]),"raster-resampling":new DataConstantProperty(v8Spec["paint_raster"]["raster-resampling"]),"raster-fade-duration":new DataConstantProperty(v8Spec["paint_raster"]["raster-fade-duration"])});var properties={get paint(){return getPaint()}};class RasterStyleLayer extends StyleLayer{constructor(layer){super(layer,properties)}}function validateCustomStyleLayer(layerObject){const errors=[];const id=layerObject.id;if(id===undefined){errors.push({message:`layers.${id}: missing required property "id"`})}if(layerObject.render===undefined){errors.push({message:`layers.${id}: missing required method "render"`})}if(layerObject.renderingMode&&layerObject.renderingMode!=="2d"&&layerObject.renderingMode!=="3d"){errors.push({message:`layers.${id}: property "renderingMode" must be either "2d" or "3d"`})}return errors}class CustomStyleLayer extends StyleLayer{constructor(implementation){super(implementation,{});this.onAdd=map=>{if(this.implementation.onAdd){this.implementation.onAdd(map,map.painter.context.gl)}};this.onRemove=map=>{if(this.implementation.onRemove){this.implementation.onRemove(map,map.painter.context.gl)}};this.implementation=implementation}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==undefined}recalculate(){}updateTransitions(){}hasTransition(){return false}serialize(){throw new Error("Custom layers cannot be serialized")}}function createStyleLayer(layer){if(layer.type==="custom"){return new CustomStyleLayer(layer)}switch(layer.type){case"background":return new BackgroundStyleLayer(layer);case"circle":return new CircleStyleLayer(layer);case"fill":return new FillStyleLayer(layer);case"fill-extrusion":return new FillExtrusionStyleLayer(layer);case"heatmap":return new HeatmapStyleLayer(layer);case"hillshade":return new HillshadeStyleLayer(layer);case"line":return new LineStyleLayer(layer);case"raster":return new RasterStyleLayer(layer);case"symbol":return new SymbolStyleLayer(layer)}}class ThrottledInvoker{constructor(methodToThrottle){this._methodToThrottle=methodToThrottle;this._triggered=false;if(typeof MessageChannel!=="undefined"){this._channel=new MessageChannel;this._channel.port2.onmessage=()=>{this._triggered=false;this._methodToThrottle()}}}trigger(){if(this._triggered){return}this._triggered=true;if(this._channel){this._channel.port1.postMessage(true)}else{setTimeout((()=>{this._triggered=false;this._methodToThrottle()}),0)}}remove(){delete this._channel;this._methodToThrottle=()=>{}}}class Actor{constructor(target,mapId){this.target=target;this.mapId=mapId;this.resolveRejects={};this.tasks={};this.taskQueue=[];this.abortControllers={};this.messageHandlers={};this.invoker=new ThrottledInvoker((()=>this.process()));this.subscription=subscribe(this.target,"message",(message=>this.receive(message)),false);this.globalScope=isWorker(self)?target:window}registerMessageHandler(type,handler){this.messageHandlers[type]=handler}sendAsync(message,abortController){return new Promise(((resolve,reject)=>{const id=Math.round(Math.random()*1e18).toString(36).substring(0,10);this.resolveRejects[id]={resolve:resolve,reject:reject};if(abortController){abortController.signal.addEventListener("abort",(()=>{delete this.resolveRejects[id];const cancelMessage={id:id,type:"<cancel>",origin:location.origin,targetMapId:message.targetMapId,sourceMapId:this.mapId};this.target.postMessage(cancelMessage)}),{once:true})}const buffers=[];const messageToPost=Object.assign(Object.assign({},message),{id:id,sourceMapId:this.mapId,origin:location.origin,data:serialize(message.data,buffers)});this.target.postMessage(messageToPost,{transfer:buffers})}))}receive(message){const data=message.data;const id=data.id;if(data.origin!=="file://"&&location.origin!=="file://"&&data.origin!==location.origin){return}if(data.targetMapId&&this.mapId!==data.targetMapId){return}if(data.type==="<cancel>"){delete this.tasks[id];const abortController=this.abortControllers[id];delete this.abortControllers[id];if(abortController){abortController.abort()}return}if(isWorker(self)||data.mustQueue){this.tasks[id]=data;this.taskQueue.push(id);this.invoker.trigger();return}this.processTask(id,data)}process(){if(this.taskQueue.length===0){return}const id=this.taskQueue.shift();const task=this.tasks[id];delete this.tasks[id];if(this.taskQueue.length>0){this.invoker.trigger()}if(!task){return}this.processTask(id,task)}processTask(id,task){return __awaiter(this,void 0,void 0,(function*(){if(task.type==="<response>"){const resolveReject=this.resolveRejects[id];delete this.resolveRejects[id];if(!resolveReject){return}if(task.error){resolveReject.reject(deserialize(task.error))}else{resolveReject.resolve(deserialize(task.data))}return}if(!this.messageHandlers[task.type]){this.completeTask(id,new Error(`Could not find a registered handler for ${task.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));return}const params=deserialize(task.data);const abortController=new AbortController;this.abortControllers[id]=abortController;try{const data=yield this.messageHandlers[task.type](task.sourceMapId,params,abortController);this.completeTask(id,null,data)}catch(err){this.completeTask(id,err)}}))}completeTask(id,err,data){const buffers=[];delete this.abortControllers[id];const responseMessage={id:id,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:err?serialize(err):null,data:serialize(data,buffers)};this.target.postMessage(responseMessage,{transfer:buffers})}remove(){this.invoker.remove();this.subscription.unsubscribe()}}const earthRadius=6371008.8;class LngLat{constructor(lng,lat){if(isNaN(lng)||isNaN(lat)){throw new Error(`Invalid LngLat object: (${lng}, ${lat})`)}this.lng=+lng;this.lat=+lat;if(this.lat>90||this.lat<-90){throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}}wrap(){return new LngLat(wrap(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(lngLat){const rad=Math.PI/180;const lat1=this.lat*rad;const lat2=lngLat.lat*rad;const a=Math.sin(lat1)*Math.sin(lat2)+Math.cos(lat1)*Math.cos(lat2)*Math.cos((lngLat.lng-this.lng)*rad);const maxMeters=earthRadius*Math.acos(Math.min(a,1));return maxMeters}static convert(input){if(input instanceof LngLat){return input}if(Array.isArray(input)&&(input.length===2||input.length===3)){return new LngLat(Number(input[0]),Number(input[1]))}if(!Array.isArray(input)&&typeof input==="object"&&input!==null){return new LngLat(Number("lng"in input?input.lng:input.lon),Number(input.lat))}throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const earthCircumfrence=2*Math.PI*earthRadius;function circumferenceAtLatitude(latitude){return earthCircumfrence*Math.cos(latitude*Math.PI/180)}function mercatorXfromLng(lng){return(180+lng)/360}function mercatorYfromLat(lat){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+lat*Math.PI/360)))/360}function mercatorZfromAltitude(altitude,lat){return altitude/circumferenceAtLatitude(lat)}function lngFromMercatorX(x){return x*360-180}function latFromMercatorY(y){const y2=180-y*360;return 360/Math.PI*Math.atan(Math.exp(y2*Math.PI/180))-90}function altitudeFromMercatorZ(z,y){return z*circumferenceAtLatitude(latFromMercatorY(y))}function mercatorScale(lat){return 1/Math.cos(lat*Math.PI/180)}class MercatorCoordinate{constructor(x,y,z=0){this.x=+x;this.y=+y;this.z=+z}static fromLngLat(lngLatLike,altitude=0){const lngLat=LngLat.convert(lngLatLike);return new MercatorCoordinate(mercatorXfromLng(lngLat.lng),mercatorYfromLat(lngLat.lat),mercatorZfromAltitude(altitude,lngLat.lat))}toLngLat(){return new LngLat(lngFromMercatorX(this.x),latFromMercatorY(this.y))}toAltitude(){return altitudeFromMercatorZ(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/earthCircumfrence*mercatorScale(latFromMercatorY(this.y))}}function getURL(baseUrl,layer,x,y,z,options){options=options||{};var url=baseUrl+"?"+["bbox="+getTileBBox(x,y,z),"format="+(options.format||"image/png"),"service="+(options.service||"WMS"),"version="+(options.version||"1.1.1"),"request="+(options.request||"GetMap"),"srs="+(options.srs||"EPSG:3857"),"width="+(options.width||256),"height="+(options.height||256),"layers="+layer].join("&");return url}function getTileBBox(x,y,z){y=Math.pow(2,z)-y-1;var min=getMercCoords(x*256,y*256,z),max=getMercCoords((x+1)*256,(y+1)*256,z);return min[0]+","+min[1]+","+max[0]+","+max[1]}function getMercCoords(x,y,z){var resolution=2*Math.PI*6378137/256/Math.pow(2,z),merc_x=x*resolution-2*Math.PI*6378137/2,merc_y=y*resolution-2*Math.PI*6378137/2;return[merc_x,merc_y]}class CanonicalTileID{constructor(z,x,y){if(z<0||z>25||y<0||y>=Math.pow(2,z)||x<0||x>=Math.pow(2,z)){throw new Error(`x=${x}, y=${y}, z=${z} outside of bounds. 0<=x<${Math.pow(2,z)}, 0<=y<${Math.pow(2,z)} 0<=z<=25 `)}this.z=z;this.x=x;this.y=y;this.key=calculateKey(0,z,z,x,y)}equals(id){return this.z===id.z&&this.x===id.x&&this.y===id.y}url(urls,pixelRatio,scheme){const bbox=getTileBBox(this.x,this.y,this.z);const quadkey=getQuadkey(this.z,this.x,this.y);return urls[(this.x+this.y)%urls.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(scheme==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,pixelRatio>1?"@2x":"").replace(/{quadkey}/g,quadkey).replace(/{bbox-epsg-3857}/g,bbox)}isChildOf(parent){const dz=this.z-parent.z;return dz>0&&parent.x===this.x>>dz&&parent.y===this.y>>dz}getTilePoint(coord){const tilesAtZoom=Math.pow(2,this.z);return new Point$2((coord.x*tilesAtZoom-this.x)*EXTENT,(coord.y*tilesAtZoom-this.y)*EXTENT)}toString(){return`${this.z}/${this.x}/${this.y}`}}class UnwrappedTileID{constructor(wrap,canonical){this.wrap=wrap;this.canonical=canonical;this.key=calculateKey(wrap,canonical.z,canonical.z,canonical.x,canonical.y)}}class OverscaledTileID{constructor(overscaledZ,wrap,z,x,y){if(overscaledZ<z)throw new Error(`overscaledZ should be >= z; overscaledZ = ${overscaledZ}; z = ${z}`);this.overscaledZ=overscaledZ;this.wrap=wrap;this.canonical=new CanonicalTileID(z,+x,+y);this.key=calculateKey(wrap,overscaledZ,z,x,y)}clone(){return new OverscaledTileID(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(id){return this.overscaledZ===id.overscaledZ&&this.wrap===id.wrap&&this.canonical.equals(id.canonical)}scaledTo(targetZ){if(targetZ>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${targetZ}; overscaledZ = ${this.overscaledZ}`);const zDifference=this.canonical.z-targetZ;if(targetZ>this.canonical.z){return new OverscaledTileID(targetZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}else{return new OverscaledTileID(targetZ,this.wrap,targetZ,this.canonical.x>>zDifference,this.canonical.y>>zDifference)}}calculateScaledKey(targetZ,withWrap){if(targetZ>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${targetZ}; overscaledZ = ${this.overscaledZ}`);const zDifference=this.canonical.z-targetZ;if(targetZ>this.canonical.z){return calculateKey(this.wrap*+withWrap,targetZ,this.canonical.z,this.canonical.x,this.canonical.y)}else{return calculateKey(this.wrap*+withWrap,targetZ,targetZ,this.canonical.x>>zDifference,this.canonical.y>>zDifference)}}isChildOf(parent){if(parent.wrap!==this.wrap){return false}const zDifference=this.canonical.z-parent.canonical.z;return parent.overscaledZ===0||parent.overscaledZ<this.overscaledZ&&parent.canonical.x===this.canonical.x>>zDifference&&parent.canonical.y===this.canonical.y>>zDifference}children(sourceMaxZoom){if(this.overscaledZ>=sourceMaxZoom){return[new OverscaledTileID(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)]}const z=this.canonical.z+1;const x=this.canonical.x*2;const y=this.canonical.y*2;return[new OverscaledTileID(z,this.wrap,z,x,y),new OverscaledTileID(z,this.wrap,z,x+1,y),new OverscaledTileID(z,this.wrap,z,x,y+1),new OverscaledTileID(z,this.wrap,z,x+1,y+1)]}isLessThan(rhs){if(this.wrap<rhs.wrap)return true;if(this.wrap>rhs.wrap)return false;if(this.overscaledZ<rhs.overscaledZ)return true;if(this.overscaledZ>rhs.overscaledZ)return false;if(this.canonical.x<rhs.canonical.x)return true;if(this.canonical.x>rhs.canonical.x)return false;if(this.canonical.y<rhs.canonical.y)return true;return false}wrapped(){return new OverscaledTileID(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(wrap){return new OverscaledTileID(this.overscaledZ,wrap,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new UnwrappedTileID(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(coord){return this.canonical.getTilePoint(new MercatorCoordinate(coord.x-this.wrap,coord.y))}}function calculateKey(wrap,overscaledZ,z,x,y){wrap*=2;if(wrap<0)wrap=wrap*-1-1;const dim=1<<z;return(dim*dim*wrap+dim*y+x).toString(36)+z.toString(36)+overscaledZ.toString(36)}function getQuadkey(z,x,y){let quadkey="",mask;for(let i=z;i>0;i--){mask=1<<i-1;quadkey+=(x&mask?1:0)+(y&mask?2:0)}return quadkey}register("CanonicalTileID",CanonicalTileID);register("OverscaledTileID",OverscaledTileID,{omit:["posMatrix"]});class DEMData{constructor(uid,data,encoding,redFactor=1,greenFactor=1,blueFactor=1,baseShift=0){this.uid=uid;if(data.height!==data.width)throw new RangeError("DEM tiles must be square");if(encoding&&!["mapbox","terrarium","custom"].includes(encoding)){warnOnce(`"${encoding}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);return}this.stride=data.height;const dim=this.dim=data.height-2;this.data=new Uint32Array(data.data.buffer);switch(encoding){case"terrarium":this.redFactor=256;this.greenFactor=1;this.blueFactor=1/256;this.baseShift=32768;break;case"custom":this.redFactor=redFactor;this.greenFactor=greenFactor;this.blueFactor=blueFactor;this.baseShift=baseShift;break;case"mapbox":default:this.redFactor=6553.6;this.greenFactor=25.6;this.blueFactor=.1;this.baseShift=1e4;break}for(let x=0;x<dim;x++){this.data[this._idx(-1,x)]=this.data[this._idx(0,x)];this.data[this._idx(dim,x)]=this.data[this._idx(dim-1,x)];this.data[this._idx(x,-1)]=this.data[this._idx(x,0)];this.data[this._idx(x,dim)]=this.data[this._idx(x,dim-1)]}this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)];this.data[this._idx(dim,-1)]=this.data[this._idx(dim-1,0)];this.data[this._idx(-1,dim)]=this.data[this._idx(0,dim-1)];this.data[this._idx(dim,dim)]=this.data[this._idx(dim-1,dim-1)];this.min=Number.MAX_SAFE_INTEGER;this.max=Number.MIN_SAFE_INTEGER;for(let x=0;x<dim;x++){for(let y=0;y<dim;y++){const ele=this.get(x,y);if(ele>this.max)this.max=ele;if(ele<this.min)this.min=ele}}}get(x,y){const pixels=new Uint8Array(this.data.buffer);const index=this._idx(x,y)*4;return this.unpack(pixels[index],pixels[index+1],pixels[index+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(x,y){if(x<-1||x>=this.dim+1||y<-1||y>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(y+1)*this.stride+(x+1)}unpack(r,g,b){return r*this.redFactor+g*this.greenFactor+b*this.blueFactor-this.baseShift}getPixels(){return new RGBAImage({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(borderTile,dx,dy){if(this.dim!==borderTile.dim)throw new Error("dem dimension mismatch");let xMin=dx*this.dim,xMax=dx*this.dim+this.dim,yMin=dy*this.dim,yMax=dy*this.dim+this.dim;switch(dx){case-1:xMin=xMax-1;break;case 1:xMax=xMin+1;break}switch(dy){case-1:yMin=yMax-1;break;case 1:yMax=yMin+1;break}const ox=-dx*this.dim;const oy=-dy*this.dim;for(let y=yMin;y<yMax;y++){for(let x=xMin;x<xMax;x++){this.data[this._idx(x,y)]=borderTile.data[this._idx(x+ox,y+oy)]}}}}register("DEMData",DEMData);class DictionaryCoder{constructor(strings){this._stringToNumber={};this._numberToString=[];for(let i=0;i<strings.length;i++){const string=strings[i];this._stringToNumber[string]=i;this._numberToString[i]=string}}encode(string){return this._stringToNumber[string]}decode(n){if(n>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${n} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[n]}}class GeoJSONFeature{constructor(vectorTileFeature,z,x,y,id){this.type="Feature";this._vectorTileFeature=vectorTileFeature;vectorTileFeature._z=z;vectorTileFeature._x=x;vectorTileFeature._y=y;this.properties=vectorTileFeature.properties;this.id=id}get geometry(){if(this._geometry===undefined){this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry}return this._geometry}set geometry(g){this._geometry=g}toJSON(){const json={geometry:this.geometry};for(const i in this){if(i==="_geometry"||i==="_vectorTileFeature")continue;json[i]=this[i]}return json}}class FeatureIndex{constructor(tileID,promoteId){this.tileID=tileID;this.x=tileID.canonical.x;this.y=tileID.canonical.y;this.z=tileID.canonical.z;this.grid=new TransferableGridIndex(EXTENT,16,0);this.grid3D=new TransferableGridIndex(EXTENT,16,0);this.featureIndexArray=new FeatureIndexArray;this.promoteId=promoteId}insert(feature,geometry,featureIndex,sourceLayerIndex,bucketIndex,is3D){const key=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(featureIndex,sourceLayerIndex,bucketIndex);const grid=is3D?this.grid3D:this.grid;for(let r=0;r<geometry.length;r++){const ring=geometry[r];const bbox=[Infinity,Infinity,-Infinity,-Infinity];for(let i=0;i<ring.length;i++){const p=ring[i];bbox[0]=Math.min(bbox[0],p.x);bbox[1]=Math.min(bbox[1],p.y);bbox[2]=Math.max(bbox[2],p.x);bbox[3]=Math.max(bbox[3],p.y)}if(bbox[0]<EXTENT&&bbox[1]<EXTENT&&bbox[2]>=0&&bbox[3]>=0){grid.insert(key,bbox[0],bbox[1],bbox[2],bbox[3])}}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new vectorTile.VectorTile(new Protobuf(this.rawTileData)).layers;this.sourceLayerCoder=new DictionaryCoder(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])}return this.vtLayers}query(args,styleLayers,serializedLayers,sourceFeatureState){this.loadVTLayers();const params=args.params||{},pixelsToTileUnits=EXTENT/args.tileSize/args.scale,filter=createFilter(params.filter);const queryGeometry=args.queryGeometry;const queryPadding=args.queryPadding*pixelsToTileUnits;const bounds=getBounds(queryGeometry);const matching=this.grid.query(bounds.minX-queryPadding,bounds.minY-queryPadding,bounds.maxX+queryPadding,bounds.maxY+queryPadding);const cameraBounds=getBounds(args.cameraQueryGeometry);const matching3D=this.grid3D.query(cameraBounds.minX-queryPadding,cameraBounds.minY-queryPadding,cameraBounds.maxX+queryPadding,cameraBounds.maxY+queryPadding,((bx1,by1,bx2,by2)=>polygonIntersectsBox(args.cameraQueryGeometry,bx1-queryPadding,by1-queryPadding,bx2+queryPadding,by2+queryPadding)));for(const key of matching3D){matching.push(key)}matching.sort(topDownFeatureComparator);const result={};let previousIndex;for(let k=0;k<matching.length;k++){const index=matching[k];if(index===previousIndex)continue;previousIndex=index;const match=this.featureIndexArray.get(index);let featureGeometry=null;this.loadMatchingFeature(result,match.bucketIndex,match.sourceLayerIndex,match.featureIndex,filter,params.layers,params.availableImages,styleLayers,serializedLayers,sourceFeatureState,((feature,styleLayer,featureState)=>{if(!featureGeometry){featureGeometry=loadGeometry(feature)}return styleLayer.queryIntersectsFeature(queryGeometry,feature,featureState,featureGeometry,this.z,args.transform,pixelsToTileUnits,args.pixelPosMatrix)}))}return result}loadMatchingFeature(result,bucketIndex,sourceLayerIndex,featureIndex,filter,filterLayerIDs,availableImages,styleLayers,serializedLayers,sourceFeatureState,intersectionTest){const layerIDs=this.bucketLayerIDs[bucketIndex];if(filterLayerIDs&&!arraysIntersect(filterLayerIDs,layerIDs))return;const sourceLayerName=this.sourceLayerCoder.decode(sourceLayerIndex);const sourceLayer=this.vtLayers[sourceLayerName];const feature=sourceLayer.feature(featureIndex);if(filter.needGeometry){const evaluationFeature=toEvaluationFeature(feature,true);if(!filter.filter(new EvaluationParameters(this.tileID.overscaledZ),evaluationFeature,this.tileID.canonical)){return}}else if(!filter.filter(new EvaluationParameters(this.tileID.overscaledZ),feature)){return}const id=this.getId(feature,sourceLayerName);for(let l=0;l<layerIDs.length;l++){const layerID=layerIDs[l];if(filterLayerIDs&&filterLayerIDs.indexOf(layerID)<0){continue}const styleLayer=styleLayers[layerID];if(!styleLayer)continue;let featureState={};if(id&&sourceFeatureState){featureState=sourceFeatureState.getState(styleLayer.sourceLayer||"_geojsonTileLayer",id)}const serializedLayer=extend({},serializedLayers[layerID]);serializedLayer.paint=evaluateProperties(serializedLayer.paint,styleLayer.paint,feature,featureState,availableImages);serializedLayer.layout=evaluateProperties(serializedLayer.layout,styleLayer.layout,feature,featureState,availableImages);const intersectionZ=!intersectionTest||intersectionTest(feature,styleLayer,featureState);if(!intersectionZ){continue}const geojsonFeature=new GeoJSONFeature(feature,this.z,this.x,this.y,id);geojsonFeature.layer=serializedLayer;let layerResult=result[layerID];if(layerResult===undefined){layerResult=result[layerID]=[]}layerResult.push({featureIndex:featureIndex,feature:geojsonFeature,intersectionZ:intersectionZ})}}lookupSymbolFeatures(symbolFeatureIndexes,serializedLayers,bucketIndex,sourceLayerIndex,filterSpec,filterLayerIDs,availableImages,styleLayers){const result={};this.loadVTLayers();const filter=createFilter(filterSpec);for(const symbolFeatureIndex of symbolFeatureIndexes){this.loadMatchingFeature(result,bucketIndex,sourceLayerIndex,symbolFeatureIndex,filter,filterLayerIDs,availableImages,styleLayers,serializedLayers)}return result}hasLayer(id){for(const layerIDs of this.bucketLayerIDs){for(const layerID of layerIDs){if(id===layerID)return true}}return false}getId(feature,sourceLayerId){let id=feature.id;if(this.promoteId){const propName=typeof this.promoteId==="string"?this.promoteId:this.promoteId[sourceLayerId];id=feature.properties[propName];if(typeof id==="boolean")id=Number(id)}return id}}register("FeatureIndex",FeatureIndex,{omit:["rawTileData","sourceLayerCoder"]});function evaluateProperties(serializedProperties,styleLayerProperties,feature,featureState,availableImages){return mapObject(serializedProperties,((property,key)=>{const prop=styleLayerProperties instanceof PossiblyEvaluated?styleLayerProperties.get(key):null;return prop&&prop.evaluate?prop.evaluate(feature,featureState,availableImages):prop}))}function getBounds(geometry){let minX=Infinity;let minY=Infinity;let maxX=-Infinity;let maxY=-Infinity;for(const p of geometry){minX=Math.min(minX,p.x);minY=Math.min(minY,p.y);maxX=Math.max(maxX,p.x);maxY=Math.max(maxY,p.y)}return{minX:minX,minY:minY,maxX:maxX,maxY:maxY}}function topDownFeatureComparator(a,b){return b-a}function clipLine(lines,x1,y1,x2,y2){const clippedLines=[];for(let l=0;l<lines.length;l++){const line=lines[l];let clippedLine;for(let i=0;i<line.length-1;i++){let p0=line[i];let p1=line[i+1];if(p0.x<x1&&p1.x<x1){continue}else if(p0.x<x1){p0=new Point$2(x1,p0.y+(p1.y-p0.y)*((x1-p0.x)/(p1.x-p0.x)))._round()}else if(p1.x<x1){p1=new Point$2(x1,p0.y+(p1.y-p0.y)*((x1-p0.x)/(p1.x-p0.x)))._round()}if(p0.y<y1&&p1.y<y1){continue}else if(p0.y<y1){p0=new Point$2(p0.x+(p1.x-p0.x)*((y1-p0.y)/(p1.y-p0.y)),y1)._round()}else if(p1.y<y1){p1=new Point$2(p0.x+(p1.x-p0.x)*((y1-p0.y)/(p1.y-p0.y)),y1)._round()}if(p0.x>=x2&&p1.x>=x2){continue}else if(p0.x>=x2){p0=new Point$2(x2,p0.y+(p1.y-p0.y)*((x2-p0.x)/(p1.x-p0.x)))._round()}else if(p1.x>=x2){p1=new Point$2(x2,p0.y+(p1.y-p0.y)*((x2-p0.x)/(p1.x-p0.x)))._round()}if(p0.y>=y2&&p1.y>=y2){continue}else if(p0.y>=y2){p0=new Point$2(p0.x+(p1.x-p0.x)*((y2-p0.y)/(p1.y-p0.y)),y2)._round()}else if(p1.y>=y2){p1=new Point$2(p0.x+(p1.x-p0.x)*((y2-p0.y)/(p1.y-p0.y)),y2)._round()}if(!clippedLine||!p0.equals(clippedLine[clippedLine.length-1])){clippedLine=[p0];clippedLines.push(clippedLine)}clippedLine.push(p1)}}return clippedLines}class Anchor extends Point$2{constructor(x,y,angle,segment){super(x,y);this.angle=angle;if(segment!==undefined){this.segment=segment}}clone(){return new Anchor(this.x,this.y,this.angle,this.segment)}}register("Anchor",Anchor);function checkMaxAngle(line,anchor,labelLength,windowSize,maxAngle){if(anchor.segment===undefined||labelLength===0)return true;let p=anchor;let index=anchor.segment+1;let anchorDistance=0;while(anchorDistance>-labelLength/2){index--;if(index<0)return false;anchorDistance-=line[index].dist(p);p=line[index]}anchorDistance+=line[index].dist(line[index+1]);index++;const recentCorners=[];let recentAngleDelta=0;while(anchorDistance<labelLength/2){const prev=line[index-1];const current=line[index];const next=line[index+1];if(!next)return false;let angleDelta=prev.angleTo(current)-current.angleTo(next);angleDelta=Math.abs((angleDelta+3*Math.PI)%(Math.PI*2)-Math.PI);recentCorners.push({distance:anchorDistance,angleDelta:angleDelta});recentAngleDelta+=angleDelta;while(anchorDistance-recentCorners[0].distance>windowSize){recentAngleDelta-=recentCorners.shift().angleDelta}if(recentAngleDelta>maxAngle)return false;index++;anchorDistance+=current.dist(next)}return true}function getLineLength(line){let lineLength=0;for(let k=0;k<line.length-1;k++){lineLength+=line[k].dist(line[k+1])}return lineLength}function getAngleWindowSize(shapedText,glyphSize,boxScale){return shapedText?3/5*glyphSize*boxScale:0}function getShapedLabelLength(shapedText,shapedIcon){return Math.max(shapedText?shapedText.right-shapedText.left:0,shapedIcon?shapedIcon.right-shapedIcon.left:0)}function getCenterAnchor(line,maxAngle,shapedText,shapedIcon,glyphSize,boxScale){const angleWindowSize=getAngleWindowSize(shapedText,glyphSize,boxScale);const labelLength=getShapedLabelLength(shapedText,shapedIcon)*boxScale;let prevDistance=0;const centerDistance=getLineLength(line)/2;for(let i=0;i<line.length-1;i++){const a=line[i],b=line[i+1];const segmentDistance=a.dist(b);if(prevDistance+segmentDistance>centerDistance){const t=(centerDistance-prevDistance)/segmentDistance,x=interpolate.number(a.x,b.x,t),y=interpolate.number(a.y,b.y,t);const anchor=new Anchor(x,y,b.angleTo(a),i);anchor._round();if(!angleWindowSize||checkMaxAngle(line,anchor,labelLength,angleWindowSize,maxAngle)){return anchor}else{return}}prevDistance+=segmentDistance}}function getAnchors(line,spacing,maxAngle,shapedText,shapedIcon,glyphSize,boxScale,overscaling,tileExtent){const angleWindowSize=getAngleWindowSize(shapedText,glyphSize,boxScale);const shapedLabelLength=getShapedLabelLength(shapedText,shapedIcon);const labelLength=shapedLabelLength*boxScale;const isLineContinued=line[0].x===0||line[0].x===tileExtent||line[0].y===0||line[0].y===tileExtent;if(spacing-labelLength<spacing/4){spacing=labelLength+spacing/4}const fixedExtraOffset=glyphSize*2;const offset=!isLineContinued?(shapedLabelLength/2+fixedExtraOffset)*boxScale*overscaling%spacing:spacing/2*overscaling%spacing;return resample(line,offset,spacing,angleWindowSize,maxAngle,labelLength,isLineContinued,false,tileExtent)}function resample(line,offset,spacing,angleWindowSize,maxAngle,labelLength,isLineContinued,placeAtMiddle,tileExtent){const halfLabelLength=labelLength/2;const lineLength=getLineLength(line);let distance=0,markedDistance=offset-spacing;let anchors=[];for(let i=0;i<line.length-1;i++){const a=line[i],b=line[i+1];const segmentDist=a.dist(b),angle=b.angleTo(a);while(markedDistance+spacing<distance+segmentDist){markedDistance+=spacing;const t=(markedDistance-distance)/segmentDist,x=interpolate.number(a.x,b.x,t),y=interpolate.number(a.y,b.y,t);if(x>=0&&x<tileExtent&&y>=0&&y<tileExtent&&markedDistance-halfLabelLength>=0&&markedDistance+halfLabelLength<=lineLength){const anchor=new Anchor(x,y,angle,i);anchor._round();if(!angleWindowSize||checkMaxAngle(line,anchor,labelLength,angleWindowSize,maxAngle)){anchors.push(anchor)}}}distance+=segmentDist}if(!placeAtMiddle&&!anchors.length&&!isLineContinued){anchors=resample(line,distance/2,spacing,angleWindowSize,maxAngle,labelLength,isLineContinued,true,tileExtent)}return anchors}const border=IMAGE_PADDING;function getIconQuads(shapedIcon,iconRotate,isSDFIcon,hasIconTextFit){const quads=[];const image=shapedIcon.image;const pixelRatio=image.pixelRatio;const imageWidth=image.paddedRect.w-2*border;const imageHeight=image.paddedRect.h-2*border;const iconWidth=shapedIcon.right-shapedIcon.left;const iconHeight=shapedIcon.bottom-shapedIcon.top;const stretchX=image.stretchX||[[0,imageWidth]];const stretchY=image.stretchY||[[0,imageHeight]];const reduceRanges=(sum,range)=>sum+range[1]-range[0];const stretchWidth=stretchX.reduce(reduceRanges,0);const stretchHeight=stretchY.reduce(reduceRanges,0);const fixedWidth=imageWidth-stretchWidth;const fixedHeight=imageHeight-stretchHeight;let stretchOffsetX=0;let stretchContentWidth=stretchWidth;let stretchOffsetY=0;let stretchContentHeight=stretchHeight;let fixedOffsetX=0;let fixedContentWidth=fixedWidth;let fixedOffsetY=0;let fixedContentHeight=fixedHeight;if(image.content&&hasIconTextFit){const content=image.content;stretchOffsetX=sumWithinRange(stretchX,0,content[0]);stretchOffsetY=sumWithinRange(stretchY,0,content[1]);stretchContentWidth=sumWithinRange(stretchX,content[0],content[2]);stretchContentHeight=sumWithinRange(stretchY,content[1],content[3]);fixedOffsetX=content[0]-stretchOffsetX;fixedOffsetY=content[1]-stretchOffsetY;fixedContentWidth=content[2]-content[0]-stretchContentWidth;fixedContentHeight=content[3]-content[1]-stretchContentHeight}const makeBox=(left,top,right,bottom)=>{const leftEm=getEmOffset(left.stretch-stretchOffsetX,stretchContentWidth,iconWidth,shapedIcon.left);const leftPx=getPxOffset(left.fixed-fixedOffsetX,fixedContentWidth,left.stretch,stretchWidth);const topEm=getEmOffset(top.stretch-stretchOffsetY,stretchContentHeight,iconHeight,shapedIcon.top);const topPx=getPxOffset(top.fixed-fixedOffsetY,fixedContentHeight,top.stretch,stretchHeight);const rightEm=getEmOffset(right.stretch-stretchOffsetX,stretchContentWidth,iconWidth,shapedIcon.left);const rightPx=getPxOffset(right.fixed-fixedOffsetX,fixedContentWidth,right.stretch,stretchWidth);const bottomEm=getEmOffset(bottom.stretch-stretchOffsetY,stretchContentHeight,iconHeight,shapedIcon.top);const bottomPx=getPxOffset(bottom.fixed-fixedOffsetY,fixedContentHeight,bottom.stretch,stretchHeight);const tl=new Point$2(leftEm,topEm);const tr=new Point$2(rightEm,topEm);const br=new Point$2(rightEm,bottomEm);const bl=new Point$2(leftEm,bottomEm);const pixelOffsetTL=new Point$2(leftPx/pixelRatio,topPx/pixelRatio);const pixelOffsetBR=new Point$2(rightPx/pixelRatio,bottomPx/pixelRatio);const angle=iconRotate*Math.PI/180;if(angle){const sin=Math.sin(angle),cos=Math.cos(angle),matrix=[cos,-sin,sin,cos];tl._matMult(matrix);tr._matMult(matrix);bl._matMult(matrix);br._matMult(matrix)}const x1=left.stretch+left.fixed;const x2=right.stretch+right.fixed;const y1=top.stretch+top.fixed;const y2=bottom.stretch+bottom.fixed;const subRect={x:image.paddedRect.x+border+x1,y:image.paddedRect.y+border+y1,w:x2-x1,h:y2-y1};const minFontScaleX=fixedContentWidth/pixelRatio/iconWidth;const minFontScaleY=fixedContentHeight/pixelRatio/iconHeight;return{tl:tl,tr:tr,bl:bl,br:br,tex:subRect,writingMode:undefined,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:pixelOffsetTL,pixelOffsetBR:pixelOffsetBR,minFontScaleX:minFontScaleX,minFontScaleY:minFontScaleY,isSDF:isSDFIcon}};if(!hasIconTextFit||!image.stretchX&&!image.stretchY){quads.push(makeBox({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:imageWidth+1},{fixed:0,stretch:imageHeight+1}))}else{const xCuts=stretchZonesToCuts(stretchX,fixedWidth,stretchWidth);const yCuts=stretchZonesToCuts(stretchY,fixedHeight,stretchHeight);for(let xi=0;xi<xCuts.length-1;xi++){const x1=xCuts[xi];const x2=xCuts[xi+1];for(let yi=0;yi<yCuts.length-1;yi++){const y1=yCuts[yi];const y2=yCuts[yi+1];quads.push(makeBox(x1,y1,x2,y2))}}}return quads}function sumWithinRange(ranges,min,max){let sum=0;for(const range of ranges){sum+=Math.max(min,Math.min(max,range[1]))-Math.max(min,Math.min(max,range[0]))}return sum}function stretchZonesToCuts(stretchZones,fixedSize,stretchSize){const cuts=[{fixed:-border,stretch:0}];for(const[c1,c2]of stretchZones){const last=cuts[cuts.length-1];cuts.push({fixed:c1-last.stretch,stretch:last.stretch});cuts.push({fixed:c1-last.stretch,stretch:last.stretch+(c2-c1)})}cuts.push({fixed:fixedSize+border,stretch:stretchSize});return cuts}function getEmOffset(stretchOffset,stretchSize,iconSize,iconOffset){return stretchOffset/stretchSize*iconSize+iconOffset}function getPxOffset(fixedOffset,fixedSize,stretchOffset,stretchSize){return fixedOffset-fixedSize*stretchOffset/stretchSize}function getGlyphQuads(anchor,shaping,textOffset,layer,alongLine,feature,imageMap,allowVerticalPlacement){const textRotate=layer.layout.get("text-rotate").evaluate(feature,{})*Math.PI/180;const quads=[];for(const line of shaping.positionedLines){for(const positionedGlyph of line.positionedGlyphs){if(!positionedGlyph.rect)continue;const textureRect=positionedGlyph.rect||{};const glyphPadding=1;let rectBuffer=GLYPH_PBF_BORDER+glyphPadding;let isSDF=true;let pixelRatio=1;let lineOffset=0;const rotateVerticalGlyph=(alongLine||allowVerticalPlacement)&&positionedGlyph.vertical;const halfAdvance=positionedGlyph.metrics.advance*positionedGlyph.scale/2;if(allowVerticalPlacement&&shaping.verticalizable){const scaledGlyphOffset=(positionedGlyph.scale-1)*ONE_EM;const imageOffset=(ONE_EM-positionedGlyph.metrics.width*positionedGlyph.scale)/2;lineOffset=line.lineOffset/2-(positionedGlyph.imageName?-imageOffset:scaledGlyphOffset)}if(positionedGlyph.imageName){const image=imageMap[positionedGlyph.imageName];isSDF=image.sdf;pixelRatio=image.pixelRatio;rectBuffer=IMAGE_PADDING/pixelRatio}const glyphOffset=alongLine?[positionedGlyph.x+halfAdvance,positionedGlyph.y]:[0,0];let builtInOffset=alongLine?[0,0]:[positionedGlyph.x+halfAdvance+textOffset[0],positionedGlyph.y+textOffset[1]-lineOffset];let verticalizedLabelOffset=[0,0];if(rotateVerticalGlyph){verticalizedLabelOffset=builtInOffset;builtInOffset=[0,0]}const textureScale=positionedGlyph.metrics.isDoubleResolution?2:1;const x1=(positionedGlyph.metrics.left-rectBuffer)*positionedGlyph.scale-halfAdvance+builtInOffset[0];const y1=(-positionedGlyph.metrics.top-rectBuffer)*positionedGlyph.scale+builtInOffset[1];const x2=x1+textureRect.w/textureScale*positionedGlyph.scale/pixelRatio;const y2=y1+textureRect.h/textureScale*positionedGlyph.scale/pixelRatio;const tl=new Point$2(x1,y1);const tr=new Point$2(x2,y1);const bl=new Point$2(x1,y2);const br=new Point$2(x2,y2);if(rotateVerticalGlyph){const center=new Point$2(-halfAdvance,halfAdvance-SHAPING_DEFAULT_OFFSET);const verticalRotation=-Math.PI/2;const xHalfWidthOffsetCorrection=ONE_EM/2-halfAdvance;const yImageOffsetCorrection=positionedGlyph.imageName?xHalfWidthOffsetCorrection:0;const halfWidthOffsetCorrection=new Point$2(5-SHAPING_DEFAULT_OFFSET-xHalfWidthOffsetCorrection,-yImageOffsetCorrection);const verticalOffsetCorrection=new Point$2(...verticalizedLabelOffset);tl._rotateAround(verticalRotation,center)._add(halfWidthOffsetCorrection)._add(verticalOffsetCorrection);tr._rotateAround(verticalRotation,center)._add(halfWidthOffsetCorrection)._add(verticalOffsetCorrection);bl._rotateAround(verticalRotation,center)._add(halfWidthOffsetCorrection)._add(verticalOffsetCorrection);br._rotateAround(verticalRotation,center)._add(halfWidthOffsetCorrection)._add(verticalOffsetCorrection)}if(textRotate){const sin=Math.sin(textRotate),cos=Math.cos(textRotate),matrix=[cos,-sin,sin,cos];tl._matMult(matrix);tr._matMult(matrix);bl._matMult(matrix);br._matMult(matrix)}const pixelOffsetTL=new Point$2(0,0);const pixelOffsetBR=new Point$2(0,0);const minFontScaleX=0;const minFontScaleY=0;quads.push({tl:tl,tr:tr,bl:bl,br:br,tex:textureRect,writingMode:shaping.writingMode,glyphOffset:glyphOffset,sectionIndex:positionedGlyph.sectionIndex,isSDF:isSDF,pixelOffsetTL:pixelOffsetTL,pixelOffsetBR:pixelOffsetBR,minFontScaleX:minFontScaleX,minFontScaleY:minFontScaleY})}}return quads}class CollisionFeature{constructor(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,shaped,boxScale,padding,alignLine,rotate){this.boxStartIndex=collisionBoxArray.length;if(alignLine){let top=shaped.top;let bottom=shaped.bottom;const collisionPadding=shaped.collisionPadding;if(collisionPadding){top-=collisionPadding[1];bottom+=collisionPadding[3]}let height=bottom-top;if(height>0){height=Math.max(10,height);this.circleDiameter=height}}else{let y1=shaped.top*boxScale-padding[0];let y2=shaped.bottom*boxScale+padding[2];let x1=shaped.left*boxScale-padding[3];let x2=shaped.right*boxScale+padding[1];const collisionPadding=shaped.collisionPadding;if(collisionPadding){x1-=collisionPadding[0]*boxScale;y1-=collisionPadding[1]*boxScale;x2+=collisionPadding[2]*boxScale;y2+=collisionPadding[3]*boxScale}if(rotate){const tl=new Point$2(x1,y1);const tr=new Point$2(x2,y1);const bl=new Point$2(x1,y2);const br=new Point$2(x2,y2);const rotateRadians=rotate*Math.PI/180;tl._rotate(rotateRadians);tr._rotate(rotateRadians);bl._rotate(rotateRadians);br._rotate(rotateRadians);x1=Math.min(tl.x,tr.x,bl.x,br.x);x2=Math.max(tl.x,tr.x,bl.x,br.x);y1=Math.min(tl.y,tr.y,bl.y,br.y);y2=Math.max(tl.y,tr.y,bl.y,br.y)}collisionBoxArray.emplaceBack(anchor.x,anchor.y,x1,y1,x2,y2,featureIndex,sourceLayerIndex,bucketIndex)}this.boxEndIndex=collisionBoxArray.length}}class TinyQueue{constructor(data=[],compare=defaultCompare){this.data=data;this.length=this.data.length;this.compare=compare;if(this.length>0){for(let i=(this.length>>1)-1;i>=0;i--)this._down(i)}}push(item){this.data.push(item);this.length++;this._up(this.length-1)}pop(){if(this.length===0)return undefined;const top=this.data[0];const bottom=this.data.pop();this.length--;if(this.length>0){this.data[0]=bottom;this._down(0)}return top}peek(){return this.data[0]}_up(pos){const{data:data,compare:compare}=this;const item=data[pos];while(pos>0){const parent=pos-1>>1;const current=data[parent];if(compare(item,current)>=0)break;data[pos]=current;pos=parent}data[pos]=item}_down(pos){const{data:data,compare:compare}=this;const halfLength=this.length>>1;const item=data[pos];while(pos<halfLength){let left=(pos<<1)+1;let best=data[left];const right=left+1;if(right<this.length&&compare(data[right],best)<0){left=right;best=data[right]}if(compare(best,item)>=0)break;data[pos]=best;pos=left}data[pos]=item}}function defaultCompare(a,b){return a<b?-1:a>b?1:0}function findPoleOfInaccessibility(polygonRings,precision=1,debug=false){let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;const outerRing=polygonRings[0];for(let i=0;i<outerRing.length;i++){const p=outerRing[i];if(!i||p.x<minX)minX=p.x;if(!i||p.y<minY)minY=p.y;if(!i||p.x>maxX)maxX=p.x;if(!i||p.y>maxY)maxY=p.y}const width=maxX-minX;const height=maxY-minY;const cellSize=Math.min(width,height);let h=cellSize/2;const cellQueue=new TinyQueue([],compareMax);if(cellSize===0)return new Point$2(minX,minY);for(let x=minX;x<maxX;x+=cellSize){for(let y=minY;y<maxY;y+=cellSize){cellQueue.push(new Cell(x+h,y+h,h,polygonRings))}}let bestCell=getCentroidCell(polygonRings);let numProbes=cellQueue.length;while(cellQueue.length){const cell=cellQueue.pop();if(cell.d>bestCell.d||!bestCell.d){bestCell=cell;if(debug)console.log("found best %d after %d probes",Math.round(1e4*cell.d)/1e4,numProbes)}if(cell.max-bestCell.d<=precision)continue;h=cell.h/2;cellQueue.push(new Cell(cell.p.x-h,cell.p.y-h,h,polygonRings));cellQueue.push(new Cell(cell.p.x+h,cell.p.y-h,h,polygonRings));cellQueue.push(new Cell(cell.p.x-h,cell.p.y+h,h,polygonRings));cellQueue.push(new Cell(cell.p.x+h,cell.p.y+h,h,polygonRings));numProbes+=4}if(debug){console.log(`num probes: ${numProbes}`);console.log(`best distance: ${bestCell.d}`)}return bestCell.p}function compareMax(a,b){return b.max-a.max}function Cell(x,y,h,polygon){this.p=new Point$2(x,y);this.h=h;this.d=pointToPolygonDist(this.p,polygon);this.max=this.d+this.h*Math.SQRT2}function pointToPolygonDist(p,polygon){let inside=false;let minDistSq=Infinity;for(let k=0;k<polygon.length;k++){const ring=polygon[k];for(let i=0,len=ring.length,j=len-1;i<len;j=i++){const a=ring[i];const b=ring[j];if(a.y>p.y!==b.y>p.y&&p.x<(b.x-a.x)*(p.y-a.y)/(b.y-a.y)+a.x)inside=!inside;minDistSq=Math.min(minDistSq,distToSegmentSquared(p,a,b))}}return(inside?1:-1)*Math.sqrt(minDistSq)}function getCentroidCell(polygon){let area=0;let x=0;let y=0;const points=polygon[0];for(let i=0,len=points.length,j=len-1;i<len;j=i++){const a=points[i];const b=points[j];const f=a.x*b.y-b.x*a.y;x+=(a.x+b.x)*f;y+=(a.y+b.y)*f;area+=f*3}return new Cell(x/area,y/area,0,polygon)}exports.TextAnchorEnum=void 0;(function(TextAnchorEnum){TextAnchorEnum[TextAnchorEnum["center"]=1]="center";TextAnchorEnum[TextAnchorEnum["left"]=2]="left";TextAnchorEnum[TextAnchorEnum["right"]=3]="right";TextAnchorEnum[TextAnchorEnum["top"]=4]="top";TextAnchorEnum[TextAnchorEnum["bottom"]=5]="bottom";TextAnchorEnum[TextAnchorEnum["top-left"]=6]="top-left";TextAnchorEnum[TextAnchorEnum["top-right"]=7]="top-right";TextAnchorEnum[TextAnchorEnum["bottom-left"]=8]="bottom-left";TextAnchorEnum[TextAnchorEnum["bottom-right"]=9]="bottom-right"})(exports.TextAnchorEnum||(exports.TextAnchorEnum={}));const baselineOffset=7;const INVALID_TEXT_OFFSET=Number.POSITIVE_INFINITY;function evaluateVariableOffset(anchor,offset){function fromRadialOffset(anchor,radialOffset){let x=0,y=0;if(radialOffset<0)radialOffset=0;const hypotenuse=radialOffset/Math.SQRT2;switch(anchor){case"top-right":case"top-left":y=hypotenuse-baselineOffset;break;case"bottom-right":case"bottom-left":y=-hypotenuse+baselineOffset;break;case"bottom":y=-radialOffset+baselineOffset;break;case"top":y=radialOffset-baselineOffset;break}switch(anchor){case"top-right":case"bottom-right":x=-hypotenuse;break;case"top-left":case"bottom-left":x=hypotenuse;break;case"left":x=radialOffset;break;case"right":x=-radialOffset;break}return[x,y]}function fromTextOffset(anchor,offsetX,offsetY){let x=0,y=0;offsetX=Math.abs(offsetX);offsetY=Math.abs(offsetY);switch(anchor){case"top-right":case"top-left":case"top":y=offsetY-baselineOffset;break;case"bottom-right":case"bottom-left":case"bottom":y=-offsetY+baselineOffset;break}switch(anchor){case"top-right":case"bottom-right":case"right":x=-offsetX;break;case"top-left":case"bottom-left":case"left":x=offsetX;break}return[x,y]}return offset[1]!==INVALID_TEXT_OFFSET?fromTextOffset(anchor,offset[0],offset[1]):fromRadialOffset(anchor,offset[0])}function getTextVariableAnchorOffset(layer,feature,canonical){var _a;const layout=layer.layout;const variableAnchorOffset=(_a=layout.get("text-variable-anchor-offset"))===null||_a===void 0?void 0:_a.evaluate(feature,{},canonical);if(variableAnchorOffset){const sourceValues=variableAnchorOffset.values;const destValues=[];for(let i=0;i<sourceValues.length;i+=2){const anchor=destValues[i]=sourceValues[i];const offset=sourceValues[i+1].map((t=>t*ONE_EM));if(anchor.startsWith("top")){offset[1]-=baselineOffset}else if(anchor.startsWith("bottom")){offset[1]+=baselineOffset}destValues[i+1]=offset}return new VariableAnchorOffsetCollection(destValues)}const variableAnchor=layout.get("text-variable-anchor");if(variableAnchor){let textOffset;const unevaluatedLayout=layer._unevaluatedLayout;if(unevaluatedLayout.getValue("text-radial-offset")!==undefined){textOffset=[layout.get("text-radial-offset").evaluate(feature,{},canonical)*ONE_EM,INVALID_TEXT_OFFSET]}else{textOffset=layout.get("text-offset").evaluate(feature,{},canonical).map((t=>t*ONE_EM))}const anchorOffsets=[];for(const anchor of variableAnchor){anchorOffsets.push(anchor,evaluateVariableOffset(anchor,textOffset))}return new VariableAnchorOffsetCollection(anchorOffsets)}return null}function performSymbolLayout(args){args.bucket.createArrays();const tileSize=512*args.bucket.overscaling;args.bucket.tilePixelRatio=EXTENT/tileSize;args.bucket.compareText={};args.bucket.iconsNeedLinear=false;const layer=args.bucket.layers[0];const layout=layer.layout;const unevaluatedLayoutValues=layer._unevaluatedLayout._values;const sizes={layoutIconSize:unevaluatedLayoutValues["icon-size"].possiblyEvaluate(new EvaluationParameters(args.bucket.zoom+1),args.canonical),layoutTextSize:unevaluatedLayoutValues["text-size"].possiblyEvaluate(new EvaluationParameters(args.bucket.zoom+1),args.canonical),textMaxSize:unevaluatedLayoutValues["text-size"].possiblyEvaluate(new EvaluationParameters(18))};if(args.bucket.textSizeData.kind==="composite"){const{minZoom:minZoom,maxZoom:maxZoom}=args.bucket.textSizeData;sizes.compositeTextSizes=[unevaluatedLayoutValues["text-size"].possiblyEvaluate(new EvaluationParameters(minZoom),args.canonical),unevaluatedLayoutValues["text-size"].possiblyEvaluate(new EvaluationParameters(maxZoom),args.canonical)]}if(args.bucket.iconSizeData.kind==="composite"){const{minZoom:minZoom,maxZoom:maxZoom}=args.bucket.iconSizeData;sizes.compositeIconSizes=[unevaluatedLayoutValues["icon-size"].possiblyEvaluate(new EvaluationParameters(minZoom),args.canonical),unevaluatedLayoutValues["icon-size"].possiblyEvaluate(new EvaluationParameters(maxZoom),args.canonical)]}const lineHeight=layout.get("text-line-height")*ONE_EM;const textAlongLine=layout.get("text-rotation-alignment")!=="viewport"&&layout.get("symbol-placement")!=="point";const keepUpright=layout.get("text-keep-upright");const textSize=layout.get("text-size");for(const feature of args.bucket.features){const fontstack=layout.get("text-font").evaluate(feature,{},args.canonical).join(",");const layoutTextSizeThisZoom=textSize.evaluate(feature,{},args.canonical);const layoutTextSize=sizes.layoutTextSize.evaluate(feature,{},args.canonical);const layoutIconSize=sizes.layoutIconSize.evaluate(feature,{},args.canonical);const shapedTextOrientations={horizontal:{},vertical:undefined};const text=feature.text;let textOffset=[0,0];if(text){const unformattedText=text.toString();const spacing=layout.get("text-letter-spacing").evaluate(feature,{},args.canonical)*ONE_EM;const spacingIfAllowed=allowsLetterSpacing(unformattedText)?spacing:0;const textAnchor=layout.get("text-anchor").evaluate(feature,{},args.canonical);const variableAnchorOffset=getTextVariableAnchorOffset(layer,feature,args.canonical);if(!variableAnchorOffset){const radialOffset=layout.get("text-radial-offset").evaluate(feature,{},args.canonical);if(radialOffset){textOffset=evaluateVariableOffset(textAnchor,[radialOffset*ONE_EM,INVALID_TEXT_OFFSET])}else{textOffset=layout.get("text-offset").evaluate(feature,{},args.canonical).map((t=>t*ONE_EM))}}let textJustify=textAlongLine?"center":layout.get("text-justify").evaluate(feature,{},args.canonical);const symbolPlacement=layout.get("symbol-placement");const maxWidth=symbolPlacement==="point"?layout.get("text-max-width").evaluate(feature,{},args.canonical)*ONE_EM:0;const addVerticalShapingForPointLabelIfNeeded=()=>{if(args.bucket.allowVerticalPlacement&&allowsVerticalWritingMode(unformattedText)){shapedTextOrientations.vertical=shapeText(text,args.glyphMap,args.glyphPositions,args.imagePositions,fontstack,maxWidth,lineHeight,textAnchor,"left",spacingIfAllowed,textOffset,exports.WritingMode.vertical,true,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom)}};if(!textAlongLine&&variableAnchorOffset){const justifications=new Set;if(textJustify==="auto"){for(let i=0;i<variableAnchorOffset.values.length;i+=2){justifications.add(getAnchorJustification(variableAnchorOffset.values[i]))}}else{justifications.add(textJustify)}let singleLine=false;for(const justification of justifications){if(shapedTextOrientations.horizontal[justification])continue;if(singleLine){shapedTextOrientations.horizontal[justification]=shapedTextOrientations.horizontal[0]}else{const shaping=shapeText(text,args.glyphMap,args.glyphPositions,args.imagePositions,fontstack,maxWidth,lineHeight,"center",justification,spacingIfAllowed,textOffset,exports.WritingMode.horizontal,false,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom);if(shaping){shapedTextOrientations.horizontal[justification]=shaping;singleLine=shaping.positionedLines.length===1}}}addVerticalShapingForPointLabelIfNeeded()}else{if(textJustify==="auto"){textJustify=getAnchorJustification(textAnchor)}const shaping=shapeText(text,args.glyphMap,args.glyphPositions,args.imagePositions,fontstack,maxWidth,lineHeight,textAnchor,textJustify,spacingIfAllowed,textOffset,exports.WritingMode.horizontal,false,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom);if(shaping)shapedTextOrientations.horizontal[textJustify]=shaping;addVerticalShapingForPointLabelIfNeeded();if(allowsVerticalWritingMode(unformattedText)&&textAlongLine&&keepUpright){shapedTextOrientations.vertical=shapeText(text,args.glyphMap,args.glyphPositions,args.imagePositions,fontstack,maxWidth,lineHeight,textAnchor,textJustify,spacingIfAllowed,textOffset,exports.WritingMode.vertical,false,symbolPlacement,layoutTextSize,layoutTextSizeThisZoom)}}}let shapedIcon;let isSDFIcon=false;if(feature.icon&&feature.icon.name){const image=args.imageMap[feature.icon.name];if(image){shapedIcon=shapeIcon(args.imagePositions[feature.icon.name],layout.get("icon-offset").evaluate(feature,{},args.canonical),layout.get("icon-anchor").evaluate(feature,{},args.canonical));isSDFIcon=!!image.sdf;if(args.bucket.sdfIcons===undefined){args.bucket.sdfIcons=isSDFIcon}else if(args.bucket.sdfIcons!==isSDFIcon){warnOnce("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer")}if(image.pixelRatio!==args.bucket.pixelRatio){args.bucket.iconsNeedLinear=true}else if(layout.get("icon-rotate").constantOr(1)!==0){args.bucket.iconsNeedLinear=true}}}const shapedText=getDefaultHorizontalShaping(shapedTextOrientations.horizontal)||shapedTextOrientations.vertical;args.bucket.iconsInText=shapedText?shapedText.iconsInText:false;if(shapedText||shapedIcon){addFeature(args.bucket,feature,shapedTextOrientations,shapedIcon,args.imageMap,sizes,layoutTextSize,layoutIconSize,textOffset,isSDFIcon,args.canonical)}}if(args.showCollisionBoxes){args.bucket.generateCollisionDebugBuffers()}}function getAnchorJustification(anchor){switch(anchor){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function addFeature(bucket,feature,shapedTextOrientations,shapedIcon,imageMap,sizes,layoutTextSize,layoutIconSize,textOffset,isSDFIcon,canonical){let textMaxSize=sizes.textMaxSize.evaluate(feature,{});if(textMaxSize===undefined){textMaxSize=layoutTextSize}const layout=bucket.layers[0].layout;const iconOffset=layout.get("icon-offset").evaluate(feature,{},canonical);const defaultHorizontalShaping=getDefaultHorizontalShaping(shapedTextOrientations.horizontal);const glyphSize=24,fontScale=layoutTextSize/glyphSize,textBoxScale=bucket.tilePixelRatio*fontScale,textMaxBoxScale=bucket.tilePixelRatio*textMaxSize/glyphSize,iconBoxScale=bucket.tilePixelRatio*layoutIconSize,symbolMinDistance=bucket.tilePixelRatio*layout.get("symbol-spacing"),textPadding=layout.get("text-padding")*bucket.tilePixelRatio,iconPadding=getIconPadding(layout,feature,canonical,bucket.tilePixelRatio),textMaxAngle=layout.get("text-max-angle")/180*Math.PI,textAlongLine=layout.get("text-rotation-alignment")!=="viewport"&&layout.get("symbol-placement")!=="point",iconAlongLine=layout.get("icon-rotation-alignment")==="map"&&layout.get("symbol-placement")!=="point",symbolPlacement=layout.get("symbol-placement"),textRepeatDistance=symbolMinDistance/2;const iconTextFit=layout.get("icon-text-fit");let verticallyShapedIcon;if(shapedIcon&&iconTextFit!=="none"){if(bucket.allowVerticalPlacement&&shapedTextOrientations.vertical){verticallyShapedIcon=fitIconToText(shapedIcon,shapedTextOrientations.vertical,iconTextFit,layout.get("icon-text-fit-padding"),iconOffset,fontScale)}if(defaultHorizontalShaping){shapedIcon=fitIconToText(shapedIcon,defaultHorizontalShaping,iconTextFit,layout.get("icon-text-fit-padding"),iconOffset,fontScale)}}const addSymbolAtAnchor=(line,anchor)=>{if(anchor.x<0||anchor.x>=EXTENT||anchor.y<0||anchor.y>=EXTENT){return}addSymbol(bucket,anchor,line,shapedTextOrientations,shapedIcon,imageMap,verticallyShapedIcon,bucket.layers[0],bucket.collisionBoxArray,feature.index,feature.sourceLayerIndex,bucket.index,textBoxScale,[textPadding,textPadding,textPadding,textPadding],textAlongLine,textOffset,iconBoxScale,iconPadding,iconAlongLine,iconOffset,feature,sizes,isSDFIcon,canonical,layoutTextSize)};if(symbolPlacement==="line"){for(const line of clipLine(feature.geometry,0,0,EXTENT,EXTENT)){const anchors=getAnchors(line,symbolMinDistance,textMaxAngle,shapedTextOrientations.vertical||defaultHorizontalShaping,shapedIcon,glyphSize,textMaxBoxScale,bucket.overscaling,EXTENT);for(const anchor of anchors){const shapedText=defaultHorizontalShaping;if(!shapedText||!anchorIsTooClose(bucket,shapedText.text,textRepeatDistance,anchor)){addSymbolAtAnchor(line,anchor)}}}}else if(symbolPlacement==="line-center"){for(const line of feature.geometry){if(line.length>1){const anchor=getCenterAnchor(line,textMaxAngle,shapedTextOrientations.vertical||defaultHorizontalShaping,shapedIcon,glyphSize,textMaxBoxScale);if(anchor){addSymbolAtAnchor(line,anchor)}}}}else if(feature.type==="Polygon"){for(const polygon of classifyRings$1(feature.geometry,0)){const poi=findPoleOfInaccessibility(polygon,16);addSymbolAtAnchor(polygon[0],new Anchor(poi.x,poi.y,0))}}else if(feature.type==="LineString"){for(const line of feature.geometry){addSymbolAtAnchor(line,new Anchor(line[0].x,line[0].y,0))}}else if(feature.type==="Point"){for(const points of feature.geometry){for(const point of points){addSymbolAtAnchor([point],new Anchor(point.x,point.y,0))}}}}function addTextVariableAnchorOffsets(textAnchorOffsets,variableAnchorOffset){const startIndex=textAnchorOffsets.length;const values=variableAnchorOffset===null||variableAnchorOffset===void 0?void 0:variableAnchorOffset.values;if((values===null||values===void 0?void 0:values.length)>0){for(let i=0;i<values.length;i+=2){const anchor=exports.TextAnchorEnum[values[i]];const offset=values[i+1];textAnchorOffsets.emplaceBack(anchor,offset[0],offset[1])}}return[startIndex,textAnchorOffsets.length]}function addTextVertices(bucket,anchor,shapedText,imageMap,layer,textAlongLine,feature,textOffset,lineArray,writingMode,placementTypes,placedTextSymbolIndices,placedIconIndex,sizes,canonical){const glyphQuads=getGlyphQuads(anchor,shapedText,textOffset,layer,textAlongLine,feature,imageMap,bucket.allowVerticalPlacement);const sizeData=bucket.textSizeData;let textSizeData=null;if(sizeData.kind==="source"){textSizeData=[SIZE_PACK_FACTOR*layer.layout.get("text-size").evaluate(feature,{})];if(textSizeData[0]>MAX_PACKED_SIZE){warnOnce(`${bucket.layerIds[0]}: Value for "text-size" is >= ${MAX_GLYPH_ICON_SIZE}. Reduce your "text-size".`)}}else if(sizeData.kind==="composite"){textSizeData=[SIZE_PACK_FACTOR*sizes.compositeTextSizes[0].evaluate(feature,{},canonical),SIZE_PACK_FACTOR*sizes.compositeTextSizes[1].evaluate(feature,{},canonical)];if(textSizeData[0]>MAX_PACKED_SIZE||textSizeData[1]>MAX_PACKED_SIZE){warnOnce(`${bucket.layerIds[0]}: Value for "text-size" is >= ${MAX_GLYPH_ICON_SIZE}. Reduce your "text-size".`)}}bucket.addSymbols(bucket.text,glyphQuads,textSizeData,textOffset,textAlongLine,feature,writingMode,anchor,lineArray.lineStartIndex,lineArray.lineLength,placedIconIndex,canonical);for(const placementType of placementTypes){placedTextSymbolIndices[placementType]=bucket.text.placedSymbolArray.length-1}return glyphQuads.length*4}function getDefaultHorizontalShaping(horizontalShaping){for(const justification in horizontalShaping){return horizontalShaping[justification]}return null}function addSymbol(bucket,anchor,line,shapedTextOrientations,shapedIcon,imageMap,verticallyShapedIcon,layer,collisionBoxArray,featureIndex,sourceLayerIndex,bucketIndex,textBoxScale,textPadding,textAlongLine,textOffset,iconBoxScale,iconPadding,iconAlongLine,iconOffset,feature,sizes,isSDFIcon,canonical,layoutTextSize){const lineArray=bucket.addToLineVertexArray(anchor,line);let textCollisionFeature,iconCollisionFeature,verticalTextCollisionFeature,verticalIconCollisionFeature;let numIconVertices=0;let numVerticalIconVertices=0;let numHorizontalGlyphVertices=0;let numVerticalGlyphVertices=0;let placedIconSymbolIndex=-1;let verticalPlacedIconSymbolIndex=-1;const placedTextSymbolIndices={};let key=murmur3$1("");if(bucket.allowVerticalPlacement&&shapedTextOrientations.vertical){const textRotation=layer.layout.get("text-rotate").evaluate(feature,{},canonical);const verticalTextRotation=textRotation+90;const verticalShaping=shapedTextOrientations.vertical;verticalTextCollisionFeature=new CollisionFeature(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,verticalShaping,textBoxScale,textPadding,textAlongLine,verticalTextRotation);if(verticallyShapedIcon){verticalIconCollisionFeature=new CollisionFeature(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,verticallyShapedIcon,iconBoxScale,iconPadding,textAlongLine,verticalTextRotation)}}if(shapedIcon){const iconRotate=layer.layout.get("icon-rotate").evaluate(feature,{});const hasIconTextFit=layer.layout.get("icon-text-fit")!=="none";const iconQuads=getIconQuads(shapedIcon,iconRotate,isSDFIcon,hasIconTextFit);const verticalIconQuads=verticallyShapedIcon?getIconQuads(verticallyShapedIcon,iconRotate,isSDFIcon,hasIconTextFit):undefined;iconCollisionFeature=new CollisionFeature(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,shapedIcon,iconBoxScale,iconPadding,false,iconRotate);numIconVertices=iconQuads.length*4;const sizeData=bucket.iconSizeData;let iconSizeData=null;if(sizeData.kind==="source"){iconSizeData=[SIZE_PACK_FACTOR*layer.layout.get("icon-size").evaluate(feature,{})];if(iconSizeData[0]>MAX_PACKED_SIZE){warnOnce(`${bucket.layerIds[0]}: Value for "icon-size" is >= ${MAX_GLYPH_ICON_SIZE}. Reduce your "icon-size".`)}}else if(sizeData.kind==="composite"){iconSizeData=[SIZE_PACK_FACTOR*sizes.compositeIconSizes[0].evaluate(feature,{},canonical),SIZE_PACK_FACTOR*sizes.compositeIconSizes[1].evaluate(feature,{},canonical)];if(iconSizeData[0]>MAX_PACKED_SIZE||iconSizeData[1]>MAX_PACKED_SIZE){warnOnce(`${bucket.layerIds[0]}: Value for "icon-size" is >= ${MAX_GLYPH_ICON_SIZE}. Reduce your "icon-size".`)}}bucket.addSymbols(bucket.icon,iconQuads,iconSizeData,iconOffset,iconAlongLine,feature,exports.WritingMode.none,anchor,lineArray.lineStartIndex,lineArray.lineLength,-1,canonical);placedIconSymbolIndex=bucket.icon.placedSymbolArray.length-1;if(verticalIconQuads){numVerticalIconVertices=verticalIconQuads.length*4;bucket.addSymbols(bucket.icon,verticalIconQuads,iconSizeData,iconOffset,iconAlongLine,feature,exports.WritingMode.vertical,anchor,lineArray.lineStartIndex,lineArray.lineLength,-1,canonical);verticalPlacedIconSymbolIndex=bucket.icon.placedSymbolArray.length-1}}const justifications=Object.keys(shapedTextOrientations.horizontal);for(const justification of justifications){const shaping=shapedTextOrientations.horizontal[justification];if(!textCollisionFeature){key=murmur3$1(shaping.text);const textRotate=layer.layout.get("text-rotate").evaluate(feature,{},canonical);textCollisionFeature=new CollisionFeature(collisionBoxArray,anchor,featureIndex,sourceLayerIndex,bucketIndex,shaping,textBoxScale,textPadding,textAlongLine,textRotate)}const singleLine=shaping.positionedLines.length===1;numHorizontalGlyphVertices+=addTextVertices(bucket,anchor,shaping,imageMap,layer,textAlongLine,feature,textOffset,lineArray,shapedTextOrientations.vertical?exports.WritingMode.horizontal:exports.WritingMode.horizontalOnly,singleLine?justifications:[justification],placedTextSymbolIndices,placedIconSymbolIndex,sizes,canonical);if(singleLine){break}}if(shapedTextOrientations.vertical){numVerticalGlyphVertices+=addTextVertices(bucket,anchor,shapedTextOrientations.vertical,imageMap,layer,textAlongLine,feature,textOffset,lineArray,exports.WritingMode.vertical,["vertical"],placedTextSymbolIndices,verticalPlacedIconSymbolIndex,sizes,canonical)}const textBoxStartIndex=textCollisionFeature?textCollisionFeature.boxStartIndex:bucket.collisionBoxArray.length;const textBoxEndIndex=textCollisionFeature?textCollisionFeature.boxEndIndex:bucket.collisionBoxArray.length;const verticalTextBoxStartIndex=verticalTextCollisionFeature?verticalTextCollisionFeature.boxStartIndex:bucket.collisionBoxArray.length;const verticalTextBoxEndIndex=verticalTextCollisionFeature?verticalTextCollisionFeature.boxEndIndex:bucket.collisionBoxArray.length;const iconBoxStartIndex=iconCollisionFeature?iconCollisionFeature.boxStartIndex:bucket.collisionBoxArray.length;const iconBoxEndIndex=iconCollisionFeature?iconCollisionFeature.boxEndIndex:bucket.collisionBoxArray.length;const verticalIconBoxStartIndex=verticalIconCollisionFeature?verticalIconCollisionFeature.boxStartIndex:bucket.collisionBoxArray.length;const verticalIconBoxEndIndex=verticalIconCollisionFeature?verticalIconCollisionFeature.boxEndIndex:bucket.collisionBoxArray.length;let collisionCircleDiameter=-1;const getCollisionCircleHeight=(feature,prevHeight)=>{if(feature&&feature.circleDiameter)return Math.max(feature.circleDiameter,prevHeight);return prevHeight};collisionCircleDiameter=getCollisionCircleHeight(textCollisionFeature,collisionCircleDiameter);collisionCircleDiameter=getCollisionCircleHeight(verticalTextCollisionFeature,collisionCircleDiameter);collisionCircleDiameter=getCollisionCircleHeight(iconCollisionFeature,collisionCircleDiameter);collisionCircleDiameter=getCollisionCircleHeight(verticalIconCollisionFeature,collisionCircleDiameter);const useRuntimeCollisionCircles=collisionCircleDiameter>-1?1:0;if(useRuntimeCollisionCircles)collisionCircleDiameter*=layoutTextSize/ONE_EM;if(bucket.glyphOffsetArray.length>=SymbolBucket.MAX_GLYPHS)warnOnce("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907");if(feature.sortKey!==undefined){bucket.addToSortKeyRanges(bucket.symbolInstances.length,feature.sortKey)}const variableAnchorOffset=getTextVariableAnchorOffset(layer,feature,canonical);const[textAnchorOffsetStartIndex,textAnchorOffsetEndIndex]=addTextVariableAnchorOffsets(bucket.textAnchorOffsets,variableAnchorOffset);bucket.symbolInstances.emplaceBack(anchor.x,anchor.y,placedTextSymbolIndices.right>=0?placedTextSymbolIndices.right:-1,placedTextSymbolIndices.center>=0?placedTextSymbolIndices.center:-1,placedTextSymbolIndices.left>=0?placedTextSymbolIndices.left:-1,placedTextSymbolIndices.vertical||-1,placedIconSymbolIndex,verticalPlacedIconSymbolIndex,key,textBoxStartIndex,textBoxEndIndex,verticalTextBoxStartIndex,verticalTextBoxEndIndex,iconBoxStartIndex,iconBoxEndIndex,verticalIconBoxStartIndex,verticalIconBoxEndIndex,featureIndex,numHorizontalGlyphVertices,numVerticalGlyphVertices,numIconVertices,numVerticalIconVertices,useRuntimeCollisionCircles,0,textBoxScale,collisionCircleDiameter,textAnchorOffsetStartIndex,textAnchorOffsetEndIndex)}function anchorIsTooClose(bucket,text,repeatDistance,anchor){const compareText=bucket.compareText;if(!(text in compareText)){compareText[text]=[]}else{const otherAnchors=compareText[text];for(let k=otherAnchors.length-1;k>=0;k--){if(anchor.dist(otherAnchors[k])<repeatDistance){return true}}}compareText[text].push(anchor);return false}const ARRAY_TYPES=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];const VERSION=1;const HEADER_SIZE=8;class KDBush{static from(data){if(!(data instanceof ArrayBuffer)){throw new Error("Data must be an instance of ArrayBuffer.")}const[magic,versionAndType]=new Uint8Array(data,0,2);if(magic!==219){throw new Error("Data does not appear to be in a KDBush format.")}const version=versionAndType>>4;if(version!==VERSION){throw new Error(`Got v${version} data when expected v${VERSION}.`)}const ArrayType=ARRAY_TYPES[versionAndType&15];if(!ArrayType){throw new Error("Unrecognized array type.")}const[nodeSize]=new Uint16Array(data,2,1);const[numItems]=new Uint32Array(data,4,1);return new KDBush(numItems,nodeSize,ArrayType,data)}constructor(numItems,nodeSize=64,ArrayType=Float64Array,data){if(isNaN(numItems)||numItems<0)throw new Error(`Unpexpected numItems value: ${numItems}.`);this.numItems=+numItems;this.nodeSize=Math.min(Math.max(+nodeSize,2),65535);this.ArrayType=ArrayType;this.IndexArrayType=numItems<65536?Uint16Array:Uint32Array;const arrayTypeIndex=ARRAY_TYPES.indexOf(this.ArrayType);const coordsByteSize=numItems*2*this.ArrayType.BYTES_PER_ELEMENT;const idsByteSize=numItems*this.IndexArrayType.BYTES_PER_ELEMENT;const padCoords=(8-idsByteSize%8)%8;if(arrayTypeIndex<0){throw new Error(`Unexpected typed array class: ${ArrayType}.`)}if(data&&data instanceof ArrayBuffer){this.data=data;this.ids=new this.IndexArrayType(this.data,HEADER_SIZE,numItems);this.coords=new this.ArrayType(this.data,HEADER_SIZE+idsByteSize+padCoords,numItems*2);this._pos=numItems*2;this._finished=true}else{this.data=new ArrayBuffer(HEADER_SIZE+coordsByteSize+idsByteSize+padCoords);this.ids=new this.IndexArrayType(this.data,HEADER_SIZE,numItems);this.coords=new this.ArrayType(this.data,HEADER_SIZE+idsByteSize+padCoords,numItems*2);this._pos=0;this._finished=false;new Uint8Array(this.data,0,2).set([219,(VERSION<<4)+arrayTypeIndex]);new Uint16Array(this.data,2,1)[0]=nodeSize;new Uint32Array(this.data,4,1)[0]=numItems}}add(x,y){const index=this._pos>>1;this.ids[index]=index;this.coords[this._pos++]=x;this.coords[this._pos++]=y;return index}finish(){const numAdded=this._pos>>1;if(numAdded!==this.numItems){throw new Error(`Added ${numAdded} items when expected ${this.numItems}.`)}sort(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0);this._finished=true;return this}range(minX,minY,maxX,maxY){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:ids,coords:coords,nodeSize:nodeSize}=this;const stack=[0,ids.length-1,0];const result=[];while(stack.length){const axis=stack.pop()||0;const right=stack.pop()||0;const left=stack.pop()||0;if(right-left<=nodeSize){for(let i=left;i<=right;i++){const x=coords[2*i];const y=coords[2*i+1];if(x>=minX&&x<=maxX&&y>=minY&&y<=maxY)result.push(ids[i])}continue}const m=left+right>>1;const x=coords[2*m];const y=coords[2*m+1];if(x>=minX&&x<=maxX&&y>=minY&&y<=maxY)result.push(ids[m]);if(axis===0?minX<=x:minY<=y){stack.push(left);stack.push(m-1);stack.push(1-axis)}if(axis===0?maxX>=x:maxY>=y){stack.push(m+1);stack.push(right);stack.push(1-axis)}}return result}within(qx,qy,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:ids,coords:coords,nodeSize:nodeSize}=this;const stack=[0,ids.length-1,0];const result=[];const r2=r*r;while(stack.length){const axis=stack.pop()||0;const right=stack.pop()||0;const left=stack.pop()||0;if(right-left<=nodeSize){for(let i=left;i<=right;i++){if(sqDist(coords[2*i],coords[2*i+1],qx,qy)<=r2)result.push(ids[i])}continue}const m=left+right>>1;const x=coords[2*m];const y=coords[2*m+1];if(sqDist(x,y,qx,qy)<=r2)result.push(ids[m]);if(axis===0?qx-r<=x:qy-r<=y){stack.push(left);stack.push(m-1);stack.push(1-axis)}if(axis===0?qx+r>=x:qy+r>=y){stack.push(m+1);stack.push(right);stack.push(1-axis)}}return result}}function sort(ids,coords,nodeSize,left,right,axis){if(right-left<=nodeSize)return;const m=left+right>>1;select(ids,coords,m,left,right,axis);sort(ids,coords,nodeSize,left,m-1,1-axis);sort(ids,coords,nodeSize,m+1,right,1-axis)}function select(ids,coords,k,left,right,axis){while(right>left){if(right-left>600){const n=right-left+1;const m=k-left+1;const z=Math.log(n);const s=.5*Math.exp(2*z/3);const sd=.5*Math.sqrt(z*s*(n-s)/n)*(m-n/2<0?-1:1);const newLeft=Math.max(left,Math.floor(k-m*s/n+sd));const newRight=Math.min(right,Math.floor(k+(n-m)*s/n+sd));select(ids,coords,k,newLeft,newRight,axis)}const t=coords[2*k+axis];let i=left;let j=right;swapItem(ids,coords,left,k);if(coords[2*right+axis]>t)swapItem(ids,coords,left,right);while(i<j){swapItem(ids,coords,i,j);i++;j--;while(coords[2*i+axis]<t)i++;while(coords[2*j+axis]>t)j--}if(coords[2*left+axis]===t)swapItem(ids,coords,left,j);else{j++;swapItem(ids,coords,j,right)}if(j<=k)left=j+1;if(k<=j)right=j-1}}function swapItem(ids,coords,i,j){swap(ids,i,j);swap(coords,2*i,2*j);swap(coords,2*i+1,2*j+1)}function swap(arr,i,j){const tmp=arr[i];arr[i]=arr[j];arr[j]=tmp}function sqDist(ax,ay,bx,by){const dx=ax-bx;const dy=ay-by;return dx*dx+dy*dy}exports.PerformanceMarkers=void 0;(function(PerformanceMarkers){PerformanceMarkers["create"]="create";PerformanceMarkers["load"]="load";PerformanceMarkers["fullLoad"]="fullLoad"})(exports.PerformanceMarkers||(exports.PerformanceMarkers={}));let lastFrameTime=null;let frameTimes=[];const minFramerateTarget=60;const frameTimeTarget=1e3/minFramerateTarget;const loadTimeKey="loadTime";const fullLoadTimeKey="fullLoadTime";const PerformanceUtils={mark(marker){performance.mark(marker)},frame(timestamp){const currTimestamp=timestamp;if(lastFrameTime!=null){const frameTime=currTimestamp-lastFrameTime;frameTimes.push(frameTime)}lastFrameTime=currTimestamp},clearMetrics(){lastFrameTime=null;frameTimes=[];performance.clearMeasures(loadTimeKey);performance.clearMeasures(fullLoadTimeKey);for(const marker in exports.PerformanceMarkers){performance.clearMarks(exports.PerformanceMarkers[marker])}},getPerformanceMetrics(){performance.measure(loadTimeKey,exports.PerformanceMarkers.create,exports.PerformanceMarkers.load);performance.measure(fullLoadTimeKey,exports.PerformanceMarkers.create,exports.PerformanceMarkers.fullLoad);const loadTime=performance.getEntriesByName(loadTimeKey)[0].duration;const fullLoadTime=performance.getEntriesByName(fullLoadTimeKey)[0].duration;const totalFrames=frameTimes.length;const avgFrameTime=frameTimes.reduce(((prev,curr)=>prev+curr),0)/totalFrames/1e3;const fps=1/avgFrameTime;const droppedFrames=frameTimes.filter((frameTime=>frameTime>frameTimeTarget)).reduce(((acc,curr)=>acc+(curr-frameTimeTarget)/frameTimeTarget),0);const percentDroppedFrames=droppedFrames/(totalFrames+droppedFrames)*100;return{loadTime:loadTime,fullLoadTime:fullLoadTime,fps:fps,percentDroppedFrames:percentDroppedFrames,totalFrames:totalFrames}}};class RequestPerformance{constructor(request){this._marks={start:[request.url,"start"].join("#"),end:[request.url,"end"].join("#"),measure:request.url.toString()};performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let resourceTimingData=performance.getEntriesByName(this._marks.measure);if(resourceTimingData.length===0){performance.measure(this._marks.measure,this._marks.start,this._marks.end);resourceTimingData=performance.getEntriesByName(this._marks.measure);performance.clearMarks(this._marks.start);performance.clearMarks(this._marks.end);performance.clearMeasures(this._marks.measure)}return resourceTimingData}}var performance$1=performance;exports.AJAXError=AJAXError;exports.Actor=Actor;exports.AlphaImage=AlphaImage;exports.CanonicalTileID=CanonicalTileID;exports.CollisionBoxArray=CollisionBoxArray;exports.CollisionCircleLayoutArray=CollisionCircleLayoutArray;exports.Color=Color;exports.DEMData=DEMData;exports.DataConstantProperty=DataConstantProperty;exports.DictionaryCoder=DictionaryCoder;exports.EXTENT=EXTENT;exports.ErrorEvent=ErrorEvent;exports.EvaluationParameters=EvaluationParameters;exports.Event=Event;exports.Evented=Evented;exports.FeatureIndex=FeatureIndex;exports.FillBucket=FillBucket;exports.FillExtrusionBucket=FillExtrusionBucket;exports.GLOBAL_DISPATCHER_ID=GLOBAL_DISPATCHER_ID;exports.GeoJSONFeature=GeoJSONFeature;exports.ImageAtlas=ImageAtlas;exports.ImagePosition=ImagePosition;exports.KDBush=KDBush;exports.LineBucket=LineBucket;exports.LineStripIndexArray=LineStripIndexArray;exports.LngLat=LngLat;exports.MercatorCoordinate=MercatorCoordinate;exports.ONE_EM=ONE_EM;exports.OverscaledTileID=OverscaledTileID;exports.PerformanceUtils=PerformanceUtils;exports.Point=Point$2;exports.Pos3dArray=Pos3dArray;exports.PosArray=PosArray;exports.Properties=Properties;exports.Protobuf=Protobuf;exports.QuadTriangleArray=QuadTriangleArray;exports.RGBAImage=RGBAImage;exports.RasterBoundsArray=RasterBoundsArray;exports.RequestPerformance=RequestPerformance;exports.SegmentVector=SegmentVector;exports.SymbolBucket=SymbolBucket;exports.Transitionable=Transitionable;exports.TriangleIndexArray=TriangleIndexArray;exports.Uniform1f=Uniform1f;exports.Uniform1i=Uniform1i;exports.Uniform2f=Uniform2f;exports.Uniform3f=Uniform3f;exports.Uniform4f=Uniform4f;exports.UniformColor=UniformColor;exports.UniformMatrix4f=UniformMatrix4f;exports.UnwrappedTileID=UnwrappedTileID;exports.ValidationError=ValidationError;exports.ZoomHistory=ZoomHistory;exports.__awaiter=__awaiter;exports.add=add$4;exports.addDynamicAttributes=addDynamicAttributes;exports.addProtocol=addProtocol;exports.arrayBufferToImage=arrayBufferToImage;exports.arrayBufferToImageBitmap=arrayBufferToImageBitmap;exports.bezier=bezier$1;exports.clamp=clamp$1;exports.clipLine=clipLine;exports.clone=clone$5;exports.clone$1=clone$9;exports.clone$2=clone$4;exports.collisionCircleLayout=collisionCircleLayout;exports.config=config;exports.copy=copy$5;exports.create=create$5;exports.create$1=create$6;exports.create$2=create$8;exports.createAbortError=createAbortError;exports.createExpression=createExpression;exports.createFilter=createFilter;exports.createLayout=createLayout;exports.createStyleLayer=createStyleLayer;exports.cross=cross$2;exports.deepEqual=deepEqual$1;exports.defaultEasing=defaultEasing;exports.degreesToRadians=degreesToRadians;exports.derefLayers=derefLayers;exports.diffStyles=diffStyles;exports.dot=dot$5;exports.dot$1=dot$4;exports.earthRadius=earthRadius;exports.emitValidationErrors=emitValidationErrors;exports.emptyStyle=emptyStyle;exports.equals=equals$6;exports.evaluateSizeForFeature=evaluateSizeForFeature;exports.evaluateSizeForZoom=evaluateSizeForZoom;exports.extend=extend;exports.filterObject=filterObject;exports.findLineIntersection=findLineIntersection;exports.fromRotation=fromRotation$2;exports.fromScaling=fromScaling;exports.getAnchorAlignment=getAnchorAlignment;exports.getAnchorJustification=getAnchorJustification;exports.getArrayBuffer=getArrayBuffer;exports.getDefaultExportFromCjs=getDefaultExportFromCjs$1;exports.getImageData=getImageData;exports.getJSON=getJSON;exports.getOverlapMode=getOverlapMode;exports.getProtocol=getProtocol;exports.getReferrer=getReferrer;exports.getVideo=getVideo;exports.groupByLayout=groupByLayout;exports.identity=identity$2;exports.interpolate=interpolate;exports.invert=invert$2;exports.isAbortError=isAbortError;exports.isImageBitmap=isImageBitmap;exports.isOffscreenCanvasDistorted=isOffscreenCanvasDistorted;exports.isSafari=isSafari;exports.isWorker=isWorker;exports.keysDifference=keysDifference;exports.makeRequest=makeRequest;exports.mapObject=mapObject;exports.mercatorXfromLng=mercatorXfromLng;exports.mercatorYfromLat=mercatorYfromLat;exports.mercatorZfromAltitude=mercatorZfromAltitude;exports.mul=mul$5;exports.mul$1=mul$3;exports.multiply=multiply$5;exports.nextPowerOfTwo=nextPowerOfTwo;exports.normalize=normalize$4;exports.offscreenCanvasSupported=offscreenCanvasSupported;exports.ortho=ortho;exports.parseCacheControl=parseCacheControl;exports.parseGlyphPbf=parseGlyphPbf;exports.pbf=pbf;exports.performSymbolLayout=performSymbolLayout;exports.perspective=perspective;exports.pick=pick;exports.pointGeometry=pointGeometry;exports.polygonIntersectsPolygon=polygonIntersectsPolygon;exports.potpack=potpack;exports.readImageUsingVideoFrame=readImageUsingVideoFrame;exports.register=register;exports.removeProtocol=removeProtocol;exports.renderColorRamp=renderColorRamp;exports.rotate=rotate$4;exports.rotateX=rotateX$3;exports.rotateZ=rotateZ$3;exports.rtlWorkerPlugin=rtlWorkerPlugin;exports.sameOrigin=sameOrigin;exports.scale=scale$5;exports.scale$1=scale$4;exports.sphericalToCartesian=sphericalToCartesian;exports.sqrLen=sqrLen;exports.sub=sub$2;exports.toEvaluationFeature=toEvaluationFeature;exports.transformMat3=transformMat3$1;exports.transformMat4=transformMat4$1;exports.transformMat4$1=transformMat4;exports.translate=translate$1;exports.unicodeBlockLookup=unicodeBlockLookup;exports.uniqueId=uniqueId;exports.v8Spec=v8Spec;exports.validateCustomStyleLayer=validateCustomStyleLayer;exports.validateLight=validateLight;exports.validateStyle=validateStyle;exports.vectorTile=vectorTile;exports.warnOnce=warnOnce;exports.wrap=wrap}));define("worker",["./shared"],(function(performance){"use strict";class StyleLayerIndex{constructor(layerConfigs){this.keyCache={};if(layerConfigs){this.replace(layerConfigs)}}replace(layerConfigs){this._layerConfigs={};this._layers={};this.update(layerConfigs,[])}update(layerConfigs,removedIds){for(const layerConfig of layerConfigs){this._layerConfigs[layerConfig.id]=layerConfig;const layer=this._layers[layerConfig.id]=performance.createStyleLayer(layerConfig);layer._featureFilter=performance.createFilter(layer.filter);if(this.keyCache[layerConfig.id])delete this.keyCache[layerConfig.id]}for(const id of removedIds){delete this.keyCache[id];delete this._layerConfigs[id];delete this._layers[id]}this.familiesBySource={};const groups=performance.groupByLayout(Object.values(this._layerConfigs),this.keyCache);for(const layerConfigs of groups){const layers=layerConfigs.map((layerConfig=>this._layers[layerConfig.id]));const layer=layers[0];if(layer.visibility==="none"){continue}const sourceId=layer.source||"";let sourceGroup=this.familiesBySource[sourceId];if(!sourceGroup){sourceGroup=this.familiesBySource[sourceId]={}}const sourceLayerId=layer.sourceLayer||"_geojsonTileLayer";let sourceLayerFamilies=sourceGroup[sourceLayerId];if(!sourceLayerFamilies){sourceLayerFamilies=sourceGroup[sourceLayerId]=[]}sourceLayerFamilies.push(layers)}}}const padding=1;class GlyphAtlas{constructor(stacks){const positions={};const bins=[];for(const stack in stacks){const glyphs=stacks[stack];const stackPositions=positions[stack]={};for(const id in glyphs){const src=glyphs[+id];if(!src||src.bitmap.width===0||src.bitmap.height===0)continue;const bin={x:0,y:0,w:src.bitmap.width+2*padding,h:src.bitmap.height+2*padding};bins.push(bin);stackPositions[id]={rect:bin,metrics:src.metrics}}}const{w:w,h:h}=performance.potpack(bins);const image=new performance.AlphaImage({width:w||1,height:h||1});for(const stack in stacks){const glyphs=stacks[stack];for(const id in glyphs){const src=glyphs[+id];if(!src||src.bitmap.width===0||src.bitmap.height===0)continue;const bin=positions[stack][id].rect;performance.AlphaImage.copy(src.bitmap,image,{x:0,y:0},{x:bin.x+padding,y:bin.y+padding},src.bitmap)}}this.image=image;this.positions=positions}}performance.register("GlyphAtlas",GlyphAtlas);class WorkerTile{constructor(params){this.tileID=new performance.OverscaledTileID(params.tileID.overscaledZ,params.tileID.wrap,params.tileID.canonical.z,params.tileID.canonical.x,params.tileID.canonical.y);this.uid=params.uid;this.zoom=params.zoom;this.pixelRatio=params.pixelRatio;this.tileSize=params.tileSize;this.source=params.source;this.overscaling=this.tileID.overscaleFactor();this.showCollisionBoxes=params.showCollisionBoxes;this.collectResourceTiming=!!params.collectResourceTiming;this.returnDependencies=!!params.returnDependencies;this.promoteId=params.promoteId;this.inFlightDependencies=[]}parse(data,layerIndex,availableImages,actor){return performance.__awaiter(this,void 0,void 0,(function*(){this.status="parsing";this.data=data;this.collisionBoxArray=new performance.CollisionBoxArray;const sourceLayerCoder=new performance.DictionaryCoder(Object.keys(data.layers).sort());const featureIndex=new performance.FeatureIndex(this.tileID,this.promoteId);featureIndex.bucketLayerIDs=[];const buckets={};const options={featureIndex:featureIndex,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:availableImages};const layerFamilies=layerIndex.familiesBySource[this.source];for(const sourceLayerId in layerFamilies){const sourceLayer=data.layers[sourceLayerId];if(!sourceLayer){continue}if(sourceLayer.version===1){performance.warnOnce(`Vector tile source "${this.source}" layer "${sourceLayerId}" `+"does not use vector tile spec v2 and therefore may have some rendering errors.")}const sourceLayerIndex=sourceLayerCoder.encode(sourceLayerId);const features=[];for(let index=0;index<sourceLayer.length;index++){const feature=sourceLayer.feature(index);const id=featureIndex.getId(feature,sourceLayerId);features.push({feature:feature,id:id,index:index,sourceLayerIndex:sourceLayerIndex})}for(const family of layerFamilies[sourceLayerId]){const layer=family[0];if(layer.source!==this.source){performance.warnOnce(`layer.source = ${layer.source} does not equal this.source = ${this.source}`)}if(layer.minzoom&&this.zoom<Math.floor(layer.minzoom))continue;if(layer.maxzoom&&this.zoom>=layer.maxzoom)continue;if(layer.visibility==="none")continue;recalculateLayers(family,this.zoom,availableImages);const bucket=buckets[layer.id]=layer.createBucket({index:featureIndex.bucketLayerIDs.length,layers:family,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:sourceLayerIndex,sourceID:this.source});bucket.populate(features,options,this.tileID.canonical);featureIndex.bucketLayerIDs.push(family.map((l=>l.id)))}}const stacks=performance.mapObject(options.glyphDependencies,(glyphs=>Object.keys(glyphs).map(Number)));this.inFlightDependencies.forEach((request=>request===null||request===void 0?void 0:request.abort()));this.inFlightDependencies=[];let getGlyphsPromise=Promise.resolve({});if(Object.keys(stacks).length){const abortController=new AbortController;this.inFlightDependencies.push(abortController);getGlyphsPromise=actor.sendAsync({type:"getGlyphs",data:{stacks:stacks,source:this.source,tileID:this.tileID,type:"glyphs"}},abortController)}const icons=Object.keys(options.iconDependencies);let getIconsPromise=Promise.resolve({});if(icons.length){const abortController=new AbortController;this.inFlightDependencies.push(abortController);getIconsPromise=actor.sendAsync({type:"getImages",data:{icons:icons,source:this.source,tileID:this.tileID,type:"icons"}},abortController)}const patterns=Object.keys(options.patternDependencies);let getPatternsPromise=Promise.resolve({});if(patterns.length){const abortController=new AbortController;this.inFlightDependencies.push(abortController);getPatternsPromise=actor.sendAsync({type:"getImages",data:{icons:patterns,source:this.source,tileID:this.tileID,type:"patterns"}},abortController)}const[glyphMap,iconMap,patternMap]=yield Promise.all([getGlyphsPromise,getIconsPromise,getPatternsPromise]);const glyphAtlas=new GlyphAtlas(glyphMap);const imageAtlas=new performance.ImageAtlas(iconMap,patternMap);for(const key in buckets){const bucket=buckets[key];if(bucket instanceof performance.SymbolBucket){recalculateLayers(bucket.layers,this.zoom,availableImages);performance.performSymbolLayout({bucket:bucket,glyphMap:glyphMap,glyphPositions:glyphAtlas.positions,imageMap:iconMap,imagePositions:imageAtlas.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical})}else if(bucket.hasPattern&&(bucket instanceof performance.LineBucket||bucket instanceof performance.FillBucket||bucket instanceof performance.FillExtrusionBucket)){recalculateLayers(bucket.layers,this.zoom,availableImages);bucket.addFeatures(options,this.tileID.canonical,imageAtlas.patternPositions)}}this.status="done";return{buckets:Object.values(buckets).filter((b=>!b.isEmpty())),featureIndex:featureIndex,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:glyphAtlas.image,imageAtlas:imageAtlas,glyphMap:this.returnDependencies?glyphMap:null,iconMap:this.returnDependencies?iconMap:null,glyphPositions:this.returnDependencies?glyphAtlas.positions:null}}))}}function recalculateLayers(layers,zoom,availableImages){const parameters=new performance.EvaluationParameters(zoom);for(const layer of layers){layer.recalculate(parameters,availableImages)}}class VectorTileWorkerSource{constructor(actor,layerIndex,availableImages){this.actor=actor;this.layerIndex=layerIndex;this.availableImages=availableImages;this.fetching={};this.loading={};this.loaded={}}loadVectorTile(params,abortController){return performance.__awaiter(this,void 0,void 0,(function*(){const response=yield performance.getArrayBuffer(params.request,abortController);try{const vectorTile=new performance.vectorTile.VectorTile(new performance.Protobuf(response.data));return{vectorTile:vectorTile,rawData:response.data,cacheControl:response.cacheControl,expires:response.expires}}catch(ex){const bytes=new Uint8Array(response.data);const isGzipped=bytes[0]===31&&bytes[1]===139;let errorMessage=`Unable to parse the tile at ${params.request.url}, `;if(isGzipped){errorMessage+="please make sure the data is not gzipped and that you have configured the relevant header in the server"}else{errorMessage+=`got error: ${ex.messge}`}throw new Error(errorMessage)}}))}loadTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){const tileUid=params.uid;const perf=params&&params.request&&params.request.collectResourceTiming?new performance.RequestPerformance(params.request):false;const workerTile=new WorkerTile(params);this.loading[tileUid]=workerTile;const abortController=new AbortController;workerTile.abort=abortController;try{const response=yield this.loadVectorTile(params,abortController);delete this.loading[tileUid];if(!response){return null}const rawTileData=response.rawData;const cacheControl={};if(response.expires)cacheControl.expires=response.expires;if(response.cacheControl)cacheControl.cacheControl=response.cacheControl;const resourceTiming={};if(perf){const resourceTimingData=perf.finish();if(resourceTimingData)resourceTiming.resourceTiming=JSON.parse(JSON.stringify(resourceTimingData))}workerTile.vectorTile=response.vectorTile;const parsePromise=workerTile.parse(response.vectorTile,this.layerIndex,this.availableImages,this.actor);this.loaded[tileUid]=workerTile;this.fetching[tileUid]={rawTileData:rawTileData,cacheControl:cacheControl,resourceTiming:resourceTiming};try{const result=yield parsePromise;return performance.extend({rawTileData:rawTileData.slice(0)},result,cacheControl,resourceTiming)}finally{delete this.fetching[tileUid]}}catch(err){delete this.loading[tileUid];workerTile.status="done";this.loaded[tileUid]=workerTile;throw err}}))}reloadTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){const uid=params.uid;if(!this.loaded||!this.loaded[uid]){throw new Error("Should not be trying to reload a tile that was never loaded or has been removed")}const workerTile=this.loaded[uid];workerTile.showCollisionBoxes=params.showCollisionBoxes;if(workerTile.status==="parsing"){const result=yield workerTile.parse(workerTile.vectorTile,this.layerIndex,this.availableImages,this.actor);let parseResult;if(this.fetching[uid]){const{rawTileData:rawTileData,cacheControl:cacheControl,resourceTiming:resourceTiming}=this.fetching[uid];delete this.fetching[uid];parseResult=performance.extend({rawTileData:rawTileData.slice(0)},result,cacheControl,resourceTiming)}else{parseResult=result}return parseResult}if(workerTile.status==="done"&&workerTile.vectorTile){return workerTile.parse(workerTile.vectorTile,this.layerIndex,this.availableImages,this.actor)}}))}abortTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){const loading=this.loading;const uid=params.uid;if(loading&&loading[uid]&&loading[uid].abort){loading[uid].abort.abort();delete loading[uid]}}))}removeTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){if(this.loaded&&this.loaded[params.uid]){delete this.loaded[params.uid]}}))}}class RasterDEMTileWorkerSource{constructor(){this.loaded={}}loadTile(params){return performance.__awaiter(this,void 0,void 0,(function*(){const{uid:uid,encoding:encoding,rawImageData:rawImageData,redFactor:redFactor,greenFactor:greenFactor,blueFactor:blueFactor,baseShift:baseShift}=params;const width=rawImageData.width+2;const height=rawImageData.height+2;const imagePixels=performance.isImageBitmap(rawImageData)?new performance.RGBAImage({width:width,height:height},yield performance.getImageData(rawImageData,-1,-1,width,height)):rawImageData;const dem=new performance.DEMData(uid,imagePixels,encoding,redFactor,greenFactor,blueFactor,baseShift);this.loaded=this.loaded||{};this.loaded[uid]=dem;return dem}))}removeTile(params){const loaded=this.loaded,uid=params.uid;if(loaded&&loaded[uid]){delete loaded[uid]}}}var geojsonRewind=rewind$1;function rewind$1(gj,outer){var type=gj&&gj.type,i;if(type==="FeatureCollection"){for(i=0;i<gj.features.length;i++)rewind$1(gj.features[i],outer)}else if(type==="GeometryCollection"){for(i=0;i<gj.geometries.length;i++)rewind$1(gj.geometries[i],outer)}else if(type==="Feature"){rewind$1(gj.geometry,outer)}else if(type==="Polygon"){rewindRings(gj.coordinates,outer)}else if(type==="MultiPolygon"){for(i=0;i<gj.coordinates.length;i++)rewindRings(gj.coordinates[i],outer)}return gj}function rewindRings(rings,outer){if(rings.length===0)return;rewindRing(rings[0],outer);for(var i=1;i<rings.length;i++){rewindRing(rings[i],!outer)}}function rewindRing(ring,dir){var area=0,err=0;for(var i=0,len=ring.length,j=len-1;i<len;j=i++){var k=(ring[i][0]-ring[j][0])*(ring[j][1]+ring[i][1]);var m=area+k;err+=Math.abs(area)>=Math.abs(k)?area-m+k:k-m+area;area=m}if(area+err>=0!==!!dir)ring.reverse()}var rewind$2=performance.getDefaultExportFromCjs(geojsonRewind);const toGeoJSON=performance.vectorTile.VectorTileFeature.prototype.toGeoJSON;let FeatureWrapper$1=class FeatureWrapper{constructor(feature){this._feature=feature;this.extent=performance.EXTENT;this.type=feature.type;this.properties=feature.tags;if("id"in feature&&!isNaN(feature.id)){this.id=parseInt(feature.id,10)}}loadGeometry(){if(this._feature.type===1){const geometry=[];for(const point of this._feature.geometry){geometry.push([new performance.Point(point[0],point[1])])}return geometry}else{const geometry=[];for(const ring of this._feature.geometry){const newRing=[];for(const point of ring){newRing.push(new performance.Point(point[0],point[1]))}geometry.push(newRing)}return geometry}}toGeoJSON(x,y,z){return toGeoJSON.call(this,x,y,z)}};let GeoJSONWrapper$2=class GeoJSONWrapper{constructor(features){this.layers={_geojsonTileLayer:this};this.name="_geojsonTileLayer";this.extent=performance.EXTENT;this.length=features.length;this._features=features}feature(i){return new FeatureWrapper$1(this._features[i])}};var vtPbf$1={exports:{}};"use strict";var Point=performance.pointGeometry;var VectorTileFeature=performance.vectorTile.VectorTileFeature;var geojson_wrapper=GeoJSONWrapper$1;function GeoJSONWrapper$1(features,options){this.options=options||{};this.features=features;this.length=features.length}GeoJSONWrapper$1.prototype.feature=function(i){return new FeatureWrapper(this.features[i],this.options.extent)};function FeatureWrapper(feature,extent){this.id=typeof feature.id==="number"?feature.id:undefined;this.type=feature.type;this.rawGeometry=feature.type===1?[feature.geometry]:feature.geometry;this.properties=feature.tags;this.extent=extent||4096}FeatureWrapper.prototype.loadGeometry=function(){var rings=this.rawGeometry;this.geometry=[];for(var i=0;i<rings.length;i++){var ring=rings[i];var newRing=[];for(var j=0;j<ring.length;j++){newRing.push(new Point(ring[j][0],ring[j][1]))}this.geometry.push(newRing)}return this.geometry};FeatureWrapper.prototype.bbox=function(){if(!this.geometry)this.loadGeometry();var rings=this.geometry;var x1=Infinity;var x2=-Infinity;var y1=Infinity;var y2=-Infinity;for(var i=0;i<rings.length;i++){var ring=rings[i];for(var j=0;j<ring.length;j++){var coord=ring[j];x1=Math.min(x1,coord.x);x2=Math.max(x2,coord.x);y1=Math.min(y1,coord.y);y2=Math.max(y2,coord.y)}}return[x1,y1,x2,y2]};FeatureWrapper.prototype.toGeoJSON=VectorTileFeature.prototype.toGeoJSON;var geojson_wrapper$1=performance.getDefaultExportFromCjs(geojson_wrapper);var vtPbf=vtPbf$1.exports;var Pbf=performance.pbf;var GeoJSONWrapper=geojson_wrapper;vtPbf$1.exports=fromVectorTileJs;var fromVectorTileJs_1=vtPbf$1.exports.fromVectorTileJs=fromVectorTileJs;var fromGeojsonVt_1=vtPbf$1.exports.fromGeojsonVt=fromGeojsonVt;var GeoJSONWrapper_1=vtPbf$1.exports.GeoJSONWrapper=GeoJSONWrapper;function fromVectorTileJs(tile){var out=new Pbf;writeTile(tile,out);return out.finish()}function fromGeojsonVt(layers,options){options=options||{};var l={};for(var k in layers){l[k]=new GeoJSONWrapper(layers[k].features,options);l[k].name=k;l[k].version=options.version;l[k].extent=options.extent}return fromVectorTileJs({layers:l})}function writeTile(tile,pbf){for(var key in tile.layers){pbf.writeMessage(3,writeLayer,tile.layers[key])}}function writeLayer(layer,pbf){pbf.writeVarintField(15,layer.version||1);pbf.writeStringField(1,layer.name||"");pbf.writeVarintField(5,layer.extent||4096);var i;var context={keys:[],values:[],keycache:{},valuecache:{}};for(i=0;i<layer.length;i++){context.feature=layer.feature(i);pbf.writeMessage(2,writeFeature,context)}var keys=context.keys;for(i=0;i<keys.length;i++){pbf.writeStringField(3,keys[i])}var values=context.values;for(i=0;i<values.length;i++){pbf.writeMessage(4,writeValue,values[i])}}function writeFeature(context,pbf){var feature=context.feature;if(feature.id!==undefined){pbf.writeVarintField(1,feature.id)}pbf.writeMessage(2,writeProperties,context);pbf.writeVarintField(3,feature.type);pbf.writeMessage(4,writeGeometry,feature)}function writeProperties(context,pbf){var feature=context.feature;var keys=context.keys;var values=context.values;var keycache=context.keycache;var valuecache=context.valuecache;for(var key in feature.properties){var value=feature.properties[key];var keyIndex=keycache[key];if(value===null)continue;if(typeof keyIndex==="undefined"){keys.push(key);keyIndex=keys.length-1;keycache[key]=keyIndex}pbf.writeVarint(keyIndex);var type=typeof value;if(type!=="string"&&type!=="boolean"&&type!=="number"){value=JSON.stringify(value)}var valueKey=type+":"+value;var valueIndex=valuecache[valueKey];if(typeof valueIndex==="undefined"){values.push(value);valueIndex=values.length-1;valuecache[valueKey]=valueIndex}pbf.writeVarint(valueIndex)}}function command(cmd,length){return(length<<3)+(cmd&7)}function zigzag(num){return num<<1^num>>31}function writeGeometry(feature,pbf){var geometry=feature.loadGeometry();var type=feature.type;var x=0;var y=0;var rings=geometry.length;for(var r=0;r<rings;r++){var ring=geometry[r];var count=1;if(type===1){count=ring.length}pbf.writeVarint(command(1,count));var lineCount=type===3?ring.length-1:ring.length;for(var i=0;i<lineCount;i++){if(i===1&&type!==1){pbf.writeVarint(command(2,lineCount-1))}var dx=ring[i].x-x;var dy=ring[i].y-y;pbf.writeVarint(zigzag(dx));pbf.writeVarint(zigzag(dy));x+=dx;y+=dy}if(type===3){pbf.writeVarint(command(7,1))}}}function writeValue(value,pbf){var type=typeof value;if(type==="string"){pbf.writeStringField(1,value)}else if(type==="boolean"){pbf.writeBooleanField(7,value)}else if(type==="number"){if(value%1!==0){pbf.writeDoubleField(3,value)}else if(value<0){pbf.writeSVarintField(6,value)}else{pbf.writeVarintField(5,value)}}}var vtPbfExports=vtPbf$1.exports;var vtpbf=performance.getDefaultExportFromCjs(vtPbfExports);const defaultOptions={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:false,generateId:false,reduce:null,map:props=>props};const fround=Math.fround||(tmp=>x=>{tmp[0]=+x;return tmp[0]})(new Float32Array(1));const OFFSET_ZOOM=2;const OFFSET_ID=3;const OFFSET_PARENT=4;const OFFSET_NUM=5;const OFFSET_PROP=6;class Supercluster{constructor(options){this.options=Object.assign(Object.create(defaultOptions),options);this.trees=new Array(this.options.maxZoom+1);this.stride=this.options.reduce?7:6;this.clusterProps=[]}load(points){const{log:log,minZoom:minZoom,maxZoom:maxZoom}=this.options;if(log)console.time("total time");const timerId=`prepare ${points.length} points`;if(log)console.time(timerId);this.points=points;const data=[];for(let i=0;i<points.length;i++){const p=points[i];if(!p.geometry)continue;const[lng,lat]=p.geometry.coordinates;const x=fround(lngX(lng));const y=fround(latY(lat));data.push(x,y,Infinity,i,-1,1);if(this.options.reduce)data.push(0)}let tree=this.trees[maxZoom+1]=this._createTree(data);if(log)console.timeEnd(timerId);for(let z=maxZoom;z>=minZoom;z--){const now=+Date.now();tree=this.trees[z]=this._createTree(this._cluster(tree,z));if(log)console.log("z%d: %d clusters in %dms",z,tree.numItems,+Date.now()-now)}if(log)console.timeEnd("total time");return this}getClusters(bbox,zoom){let minLng=((bbox[0]+180)%360+360)%360-180;const minLat=Math.max(-90,Math.min(90,bbox[1]));let maxLng=bbox[2]===180?180:((bbox[2]+180)%360+360)%360-180;const maxLat=Math.max(-90,Math.min(90,bbox[3]));if(bbox[2]-bbox[0]>=360){minLng=-180;maxLng=180}else if(minLng>maxLng){const easternHem=this.getClusters([minLng,minLat,180,maxLat],zoom);const westernHem=this.getClusters([-180,minLat,maxLng,maxLat],zoom);return easternHem.concat(westernHem)}const tree=this.trees[this._limitZoom(zoom)];const ids=tree.range(lngX(minLng),latY(maxLat),lngX(maxLng),latY(minLat));const data=tree.data;const clusters=[];for(const id of ids){const k=this.stride*id;clusters.push(data[k+OFFSET_NUM]>1?getClusterJSON(data,k,this.clusterProps):this.points[data[k+OFFSET_ID]])}return clusters}getChildren(clusterId){const originId=this._getOriginId(clusterId);const originZoom=this._getOriginZoom(clusterId);const errorMsg="No cluster with the specified id.";const tree=this.trees[originZoom];if(!tree)throw new Error(errorMsg);const data=tree.data;if(originId*this.stride>=data.length)throw new Error(errorMsg);const r=this.options.radius/(this.options.extent*Math.pow(2,originZoom-1));const x=data[originId*this.stride];const y=data[originId*this.stride+1];const ids=tree.within(x,y,r);const children=[];for(const id of ids){const k=id*this.stride;if(data[k+OFFSET_PARENT]===clusterId){children.push(data[k+OFFSET_NUM]>1?getClusterJSON(data,k,this.clusterProps):this.points[data[k+OFFSET_ID]])}}if(children.length===0)throw new Error(errorMsg);return children}getLeaves(clusterId,limit,offset){limit=limit||10;offset=offset||0;const leaves=[];this._appendLeaves(leaves,clusterId,limit,offset,0);return leaves}getTile(z,x,y){const tree=this.trees[this._limitZoom(z)];const z2=Math.pow(2,z);const{extent:extent,radius:radius}=this.options;const p=radius/extent;const top=(y-p)/z2;const bottom=(y+1+p)/z2;const tile={features:[]};this._addTileFeatures(tree.range((x-p)/z2,top,(x+1+p)/z2,bottom),tree.data,x,y,z2,tile);if(x===0){this._addTileFeatures(tree.range(1-p/z2,top,1,bottom),tree.data,z2,y,z2,tile)}if(x===z2-1){this._addTileFeatures(tree.range(0,top,p/z2,bottom),tree.data,-1,y,z2,tile)}return tile.features.length?tile:null}getClusterExpansionZoom(clusterId){let expansionZoom=this._getOriginZoom(clusterId)-1;while(expansionZoom<=this.options.maxZoom){const children=this.getChildren(clusterId);expansionZoom++;if(children.length!==1)break;clusterId=children[0].properties.cluster_id}return expansionZoom}_appendLeaves(result,clusterId,limit,offset,skipped){const children=this.getChildren(clusterId);for(const child of children){const props=child.properties;if(props&&props.cluster){if(skipped+props.point_count<=offset){skipped+=props.point_count}else{skipped=this._appendLeaves(result,props.cluster_id,limit,offset,skipped)}}else if(skipped<offset){skipped++}else{result.push(child)}if(result.length===limit)break}return skipped}_createTree(data){const tree=new performance.KDBush(data.length/this.stride|0,this.options.nodeSize,Float32Array);for(let i=0;i<data.length;i+=this.stride)tree.add(data[i],data[i+1]);tree.finish();tree.data=data;return tree}_addTileFeatures(ids,data,x,y,z2,tile){for(const i of ids){const k=i*this.stride;const isCluster=data[k+OFFSET_NUM]>1;let tags,px,py;if(isCluster){tags=getClusterProperties(data,k,this.clusterProps);px=data[k];py=data[k+1]}else{const p=this.points[data[k+OFFSET_ID]];tags=p.properties;const[lng,lat]=p.geometry.coordinates;px=lngX(lng);py=latY(lat)}const f={type:1,geometry:[[Math.round(this.options.extent*(px*z2-x)),Math.round(this.options.extent*(py*z2-y))]],tags:tags};let id;if(isCluster||this.options.generateId){id=data[k+OFFSET_ID]}else{id=this.points[data[k+OFFSET_ID]].id}if(id!==undefined)f.id=id;tile.features.push(f)}}_limitZoom(z){return Math.max(this.options.minZoom,Math.min(Math.floor(+z),this.options.maxZoom+1))}_cluster(tree,zoom){const{radius:radius,extent:extent,reduce:reduce,minPoints:minPoints}=this.options;const r=radius/(extent*Math.pow(2,zoom));const data=tree.data;const nextData=[];const stride=this.stride;for(let i=0;i<data.length;i+=stride){if(data[i+OFFSET_ZOOM]<=zoom)continue;data[i+OFFSET_ZOOM]=zoom;const x=data[i];const y=data[i+1];const neighborIds=tree.within(data[i],data[i+1],r);const numPointsOrigin=data[i+OFFSET_NUM];let numPoints=numPointsOrigin;for(const neighborId of neighborIds){const k=neighborId*stride;if(data[k+OFFSET_ZOOM]>zoom)numPoints+=data[k+OFFSET_NUM]}if(numPoints>numPointsOrigin&&numPoints>=minPoints){let wx=x*numPointsOrigin;let wy=y*numPointsOrigin;let clusterProperties;let clusterPropIndex=-1;const id=((i/stride|0)<<5)+(zoom+1)+this.points.length;for(const neighborId of neighborIds){const k=neighborId*stride;if(data[k+OFFSET_ZOOM]<=zoom)continue;data[k+OFFSET_ZOOM]=zoom;const numPoints2=data[k+OFFSET_NUM];wx+=data[k]*numPoints2;wy+=data[k+1]*numPoints2;data[k+OFFSET_PARENT]=id;if(reduce){if(!clusterProperties){clusterProperties=this._map(data,i,true);clusterPropIndex=this.clusterProps.length;this.clusterProps.push(clusterProperties)}reduce(clusterProperties,this._map(data,k))}}data[i+OFFSET_PARENT]=id;nextData.push(wx/numPoints,wy/numPoints,Infinity,id,-1,numPoints);if(reduce)nextData.push(clusterPropIndex)}else{for(let j=0;j<stride;j++)nextData.push(data[i+j]);if(numPoints>1){for(const neighborId of neighborIds){const k=neighborId*stride;if(data[k+OFFSET_ZOOM]<=zoom)continue;data[k+OFFSET_ZOOM]=zoom;for(let j=0;j<stride;j++)nextData.push(data[k+j])}}}}return nextData}_getOriginId(clusterId){return clusterId-this.points.length>>5}_getOriginZoom(clusterId){return(clusterId-this.points.length)%32}_map(data,i,clone){if(data[i+OFFSET_NUM]>1){const props=this.clusterProps[data[i+OFFSET_PROP]];return clone?Object.assign({},props):props}const original=this.points[data[i+OFFSET_ID]].properties;const result=this.options.map(original);return clone&&result===original?Object.assign({},result):result}}function getClusterJSON(data,i,clusterProps){return{type:"Feature",id:data[i+OFFSET_ID],properties:getClusterProperties(data,i,clusterProps),geometry:{type:"Point",coordinates:[xLng(data[i]),yLat(data[i+1])]}}}function getClusterProperties(data,i,clusterProps){const count=data[i+OFFSET_NUM];const abbrev=count>=1e4?`${Math.round(count/1e3)}k`:count>=1e3?`${Math.round(count/100)/10}k`:count;const propIndex=data[i+OFFSET_PROP];const properties=propIndex===-1?{}:Object.assign({},clusterProps[propIndex]);return Object.assign(properties,{cluster:true,cluster_id:data[i+OFFSET_ID],point_count:count,point_count_abbreviated:abbrev})}function lngX(lng){return lng/360+.5}function latY(lat){const sin=Math.sin(lat*Math.PI/180);const y=.5-.25*Math.log((1+sin)/(1-sin))/Math.PI;return y<0?0:y>1?1:y}function xLng(x){return(x-.5)*360}function yLat(y){const y2=(180-y*360)*Math.PI/180;return 360*Math.atan(Math.exp(y2))/Math.PI-90}function simplify(coords,first,last,sqTolerance){var maxSqDist=sqTolerance;var mid=last-first>>1;var minPosToMid=last-first;var index;var ax=coords[first];var ay=coords[first+1];var bx=coords[last];var by=coords[last+1];for(var i=first+3;i<last;i+=3){var d=getSqSegDist(coords[i],coords[i+1],ax,ay,bx,by);if(d>maxSqDist){index=i;maxSqDist=d}else if(d===maxSqDist){var posToMid=Math.abs(i-mid);if(posToMid<minPosToMid){index=i;minPosToMid=posToMid}}}if(maxSqDist>sqTolerance){if(index-first>3)simplify(coords,first,index,sqTolerance);coords[index+2]=maxSqDist;if(last-index>3)simplify(coords,index,last,sqTolerance)}}function getSqSegDist(px,py,x,y,bx,by){var dx=bx-x;var dy=by-y;if(dx!==0||dy!==0){var t=((px-x)*dx+(py-y)*dy)/(dx*dx+dy*dy);if(t>1){x=bx;y=by}else if(t>0){x+=dx*t;y+=dy*t}}dx=px-x;dy=py-y;return dx*dx+dy*dy}function createFeature(id,type,geom,tags){var feature={id:typeof id==="undefined"?null:id,type:type,geometry:geom,tags:tags,minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};calcBBox(feature);return feature}function calcBBox(feature){var geom=feature.geometry;var type=feature.type;if(type==="Point"||type==="MultiPoint"||type==="LineString"){calcLineBBox(feature,geom)}else if(type==="Polygon"||type==="MultiLineString"){for(var i=0;i<geom.length;i++){calcLineBBox(feature,geom[i])}}else if(type==="MultiPolygon"){for(i=0;i<geom.length;i++){for(var j=0;j<geom[i].length;j++){calcLineBBox(feature,geom[i][j])}}}}function calcLineBBox(feature,geom){for(var i=0;i<geom.length;i+=3){feature.minX=Math.min(feature.minX,geom[i]);feature.minY=Math.min(feature.minY,geom[i+1]);feature.maxX=Math.max(feature.maxX,geom[i]);feature.maxY=Math.max(feature.maxY,geom[i+1])}}function convert(data,options){var features=[];if(data.type==="FeatureCollection"){for(var i=0;i<data.features.length;i++){convertFeature(features,data.features[i],options,i)}}else if(data.type==="Feature"){convertFeature(features,data,options)}else{convertFeature(features,{geometry:data},options)}return features}function convertFeature(features,geojson,options,index){if(!geojson.geometry)return;var coords=geojson.geometry.coordinates;var type=geojson.geometry.type;var tolerance=Math.pow(options.tolerance/((1<<options.maxZoom)*options.extent),2);var geometry=[];var id=geojson.id;if(options.promoteId){id=geojson.properties[options.promoteId]}else if(options.generateId){id=index||0}if(type==="Point"){convertPoint(coords,geometry)}else if(type==="MultiPoint"){for(var i=0;i<coords.length;i++){convertPoint(coords[i],geometry)}}else if(type==="LineString"){convertLine(coords,geometry,tolerance,false)}else if(type==="MultiLineString"){if(options.lineMetrics){for(i=0;i<coords.length;i++){geometry=[];convertLine(coords[i],geometry,tolerance,false);features.push(createFeature(id,"LineString",geometry,geojson.properties))}return}else{convertLines(coords,geometry,tolerance,false)}}else if(type==="Polygon"){convertLines(coords,geometry,tolerance,true)}else if(type==="MultiPolygon"){for(i=0;i<coords.length;i++){var polygon=[];convertLines(coords[i],polygon,tolerance,true);geometry.push(polygon)}}else if(type==="GeometryCollection"){for(i=0;i<geojson.geometry.geometries.length;i++){convertFeature(features,{id:id,geometry:geojson.geometry.geometries[i],properties:geojson.properties},options,index)}return}else{throw new Error("Input data is not a valid GeoJSON object.")}features.push(createFeature(id,type,geometry,geojson.properties))}function convertPoint(coords,out){out.push(projectX(coords[0]));out.push(projectY(coords[1]));out.push(0)}function convertLine(ring,out,tolerance,isPolygon){var x0,y0;var size=0;for(var j=0;j<ring.length;j++){var x=projectX(ring[j][0]);var y=projectY(ring[j][1]);out.push(x);out.push(y);out.push(0);if(j>0){if(isPolygon){size+=(x0*y-x*y0)/2}else{size+=Math.sqrt(Math.pow(x-x0,2)+Math.pow(y-y0,2))}}x0=x;y0=y}var last=out.length-3;out[2]=1;simplify(out,0,last,tolerance);out[last+2]=1;out.size=Math.abs(size);out.start=0;out.end=out.size}function convertLines(rings,out,tolerance,isPolygon){for(var i=0;i<rings.length;i++){var geom=[];convertLine(rings[i],geom,tolerance,isPolygon);out.push(geom)}}function projectX(x){return x/360+.5}function projectY(y){var sin=Math.sin(y*Math.PI/180);var y2=.5-.25*Math.log((1+sin)/(1-sin))/Math.PI;return y2<0?0:y2>1?1:y2}function clip(features,scale,k1,k2,axis,minAll,maxAll,options){k1/=scale;k2/=scale;if(minAll>=k1&&maxAll<k2)return features;else if(maxAll<k1||minAll>=k2)return null;var clipped=[];for(var i=0;i<features.length;i++){var feature=features[i];var geometry=feature.geometry;var type=feature.type;var min=axis===0?feature.minX:feature.minY;var max=axis===0?feature.maxX:feature.maxY;if(min>=k1&&max<k2){clipped.push(feature);continue}else if(max<k1||min>=k2){continue}var newGeometry=[];if(type==="Point"||type==="MultiPoint"){clipPoints(geometry,newGeometry,k1,k2,axis)}else if(type==="LineString"){clipLine(geometry,newGeometry,k1,k2,axis,false,options.lineMetrics)}else if(type==="MultiLineString"){clipLines(geometry,newGeometry,k1,k2,axis,false)}else if(type==="Polygon"){clipLines(geometry,newGeometry,k1,k2,axis,true)}else if(type==="MultiPolygon"){for(var j=0;j<geometry.length;j++){var polygon=[];clipLines(geometry[j],polygon,k1,k2,axis,true);if(polygon.length){newGeometry.push(polygon)}}}if(newGeometry.length){if(options.lineMetrics&&type==="LineString"){for(j=0;j<newGeometry.length;j++){clipped.push(createFeature(feature.id,type,newGeometry[j],feature.tags))}continue}if(type==="LineString"||type==="MultiLineString"){if(newGeometry.length===1){type="LineString";newGeometry=newGeometry[0]}else{type="MultiLineString"}}if(type==="Point"||type==="MultiPoint"){type=newGeometry.length===3?"Point":"MultiPoint"}clipped.push(createFeature(feature.id,type,newGeometry,feature.tags))}}return clipped.length?clipped:null}function clipPoints(geom,newGeom,k1,k2,axis){for(var i=0;i<geom.length;i+=3){var a=geom[i+axis];if(a>=k1&&a<=k2){newGeom.push(geom[i]);newGeom.push(geom[i+1]);newGeom.push(geom[i+2])}}}function clipLine(geom,newGeom,k1,k2,axis,isPolygon,trackMetrics){var slice=newSlice(geom);var intersect=axis===0?intersectX:intersectY;var len=geom.start;var segLen,t;for(var i=0;i<geom.length-3;i+=3){var ax=geom[i];var ay=geom[i+1];var az=geom[i+2];var bx=geom[i+3];var by=geom[i+4];var a=axis===0?ax:ay;var b=axis===0?bx:by;var exited=false;if(trackMetrics)segLen=Math.sqrt(Math.pow(ax-bx,2)+Math.pow(ay-by,2));if(a<k1){if(b>k1){t=intersect(slice,ax,ay,bx,by,k1);if(trackMetrics)slice.start=len+segLen*t}}else if(a>k2){if(b<k2){t=intersect(slice,ax,ay,bx,by,k2);if(trackMetrics)slice.start=len+segLen*t}}else{addPoint(slice,ax,ay,az)}if(b<k1&&a>=k1){t=intersect(slice,ax,ay,bx,by,k1);exited=true}if(b>k2&&a<=k2){t=intersect(slice,ax,ay,bx,by,k2);exited=true}if(!isPolygon&&exited){if(trackMetrics)slice.end=len+segLen*t;newGeom.push(slice);slice=newSlice(geom)}if(trackMetrics)len+=segLen}var last=geom.length-3;ax=geom[last];ay=geom[last+1];az=geom[last+2];a=axis===0?ax:ay;if(a>=k1&&a<=k2)addPoint(slice,ax,ay,az);last=slice.length-3;if(isPolygon&&last>=3&&(slice[last]!==slice[0]||slice[last+1]!==slice[1])){addPoint(slice,slice[0],slice[1],slice[2])}if(slice.length){newGeom.push(slice)}}function newSlice(line){var slice=[];slice.size=line.size;slice.start=line.start;slice.end=line.end;return slice}function clipLines(geom,newGeom,k1,k2,axis,isPolygon){for(var i=0;i<geom.length;i++){clipLine(geom[i],newGeom,k1,k2,axis,isPolygon,false)}}function addPoint(out,x,y,z){out.push(x);out.push(y);out.push(z)}function intersectX(out,ax,ay,bx,by,x){var t=(x-ax)/(bx-ax);out.push(x);out.push(ay+(by-ay)*t);out.push(1);return t}function intersectY(out,ax,ay,bx,by,y){var t=(y-ay)/(by-ay);out.push(ax+(bx-ax)*t);out.push(y);out.push(1);return t}function wrap(features,options){var buffer=options.buffer/options.extent;var merged=features;var left=clip(features,1,-1-buffer,buffer,0,-1,2,options);var right=clip(features,1,1-buffer,2+buffer,0,-1,2,options);if(left||right){merged=clip(features,1,-buffer,1+buffer,0,-1,2,options)||[];if(left)merged=shiftFeatureCoords(left,1).concat(merged);if(right)merged=merged.concat(shiftFeatureCoords(right,-1))}return merged}function shiftFeatureCoords(features,offset){var newFeatures=[];for(var i=0;i<features.length;i++){var feature=features[i],type=feature.type;var newGeometry;if(type==="Point"||type==="MultiPoint"||type==="LineString"){newGeometry=shiftCoords(feature.geometry,offset)}else if(type==="MultiLineString"||type==="Polygon"){newGeometry=[];for(var j=0;j<feature.geometry.length;j++){newGeometry.push(shiftCoords(feature.geometry[j],offset))}}else if(type==="MultiPolygon"){newGeometry=[];for(j=0;j<feature.geometry.length;j++){var newPolygon=[];for(var k=0;k<feature.geometry[j].length;k++){newPolygon.push(shiftCoords(feature.geometry[j][k],offset))}newGeometry.push(newPolygon)}}newFeatures.push(createFeature(feature.id,type,newGeometry,feature.tags))}return newFeatures}function shiftCoords(points,offset){var newPoints=[];newPoints.size=points.size;if(points.start!==undefined){newPoints.start=points.start;newPoints.end=points.end}for(var i=0;i<points.length;i+=3){newPoints.push(points[i]+offset,points[i+1],points[i+2])}return newPoints}function transformTile(tile,extent){if(tile.transformed)return tile;var z2=1<<tile.z,tx=tile.x,ty=tile.y,i,j,k;for(i=0;i<tile.features.length;i++){var feature=tile.features[i],geom=feature.geometry,type=feature.type;feature.geometry=[];if(type===1){for(j=0;j<geom.length;j+=2){feature.geometry.push(transformPoint(geom[j],geom[j+1],extent,z2,tx,ty))}}else{for(j=0;j<geom.length;j++){var ring=[];for(k=0;k<geom[j].length;k+=2){ring.push(transformPoint(geom[j][k],geom[j][k+1],extent,z2,tx,ty))}feature.geometry.push(ring)}}}tile.transformed=true;return tile}function transformPoint(x,y,extent,z2,tx,ty){return[Math.round(extent*(x*z2-tx)),Math.round(extent*(y*z2-ty))]}function createTile(features,z,tx,ty,options){var tolerance=z===options.maxZoom?0:options.tolerance/((1<<z)*options.extent);var tile={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:tx,y:ty,z:z,transformed:false,minX:2,minY:1,maxX:-1,maxY:0};for(var i=0;i<features.length;i++){tile.numFeatures++;addFeature(tile,features[i],tolerance,options);var minX=features[i].minX;var minY=features[i].minY;var maxX=features[i].maxX;var maxY=features[i].maxY;if(minX<tile.minX)tile.minX=minX;if(minY<tile.minY)tile.minY=minY;if(maxX>tile.maxX)tile.maxX=maxX;if(maxY>tile.maxY)tile.maxY=maxY}return tile}function addFeature(tile,feature,tolerance,options){var geom=feature.geometry,type=feature.type,simplified=[];if(type==="Point"||type==="MultiPoint"){for(var i=0;i<geom.length;i+=3){simplified.push(geom[i]);simplified.push(geom[i+1]);tile.numPoints++;tile.numSimplified++}}else if(type==="LineString"){addLine(simplified,geom,tile,tolerance,false,false)}else if(type==="MultiLineString"||type==="Polygon"){for(i=0;i<geom.length;i++){addLine(simplified,geom[i],tile,tolerance,type==="Polygon",i===0)}}else if(type==="MultiPolygon"){for(var k=0;k<geom.length;k++){var polygon=geom[k];for(i=0;i<polygon.length;i++){addLine(simplified,polygon[i],tile,tolerance,true,i===0)}}}if(simplified.length){var tags=feature.tags||null;if(type==="LineString"&&options.lineMetrics){tags={};for(var key in feature.tags)tags[key]=feature.tags[key];tags["mapbox_clip_start"]=geom.start/geom.size;tags["mapbox_clip_end"]=geom.end/geom.size}var tileFeature={geometry:simplified,type:type==="Polygon"||type==="MultiPolygon"?3:type==="LineString"||type==="MultiLineString"?2:1,tags:tags};if(feature.id!==null){tileFeature.id=feature.id}tile.features.push(tileFeature)}}function addLine(result,geom,tile,tolerance,isPolygon,isOuter){var sqTolerance=tolerance*tolerance;if(tolerance>0&&geom.size<(isPolygon?sqTolerance:tolerance)){tile.numPoints+=geom.length/3;return}var ring=[];for(var i=0;i<geom.length;i+=3){if(tolerance===0||geom[i+2]>sqTolerance){tile.numSimplified++;ring.push(geom[i]);ring.push(geom[i+1])}tile.numPoints++}if(isPolygon)rewind(ring,isOuter);result.push(ring)}function rewind(ring,clockwise){var area=0;for(var i=0,len=ring.length,j=len-2;i<len;j=i,i+=2){area+=(ring[i]-ring[j])*(ring[i+1]+ring[j+1])}if(area>0===clockwise){for(i=0,len=ring.length;i<len/2;i+=2){var x=ring[i];var y=ring[i+1];ring[i]=ring[len-2-i];ring[i+1]=ring[len-1-i];ring[len-2-i]=x;ring[len-1-i]=y}}}function geojsonvt(data,options){return new GeoJSONVT(data,options)}function GeoJSONVT(data,options){options=this.options=extend(Object.create(this.options),options);var debug=options.debug;if(debug)console.time("preprocess data");if(options.maxZoom<0||options.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(options.promoteId&&options.generateId)throw new Error("promoteId and generateId cannot be used together.");var features=convert(data,options);this.tiles={};this.tileCoords=[];if(debug){console.timeEnd("preprocess data");console.log("index: maxZoom: %d, maxPoints: %d",options.indexMaxZoom,options.indexMaxPoints);console.time("generate tiles");this.stats={};this.total=0}features=wrap(features,options);if(features.length)this.splitTile(features,0,0,0);if(debug){if(features.length)console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints);console.timeEnd("generate tiles");console.log("tiles generated:",this.total,JSON.stringify(this.stats))}}GeoJSONVT.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:false,promoteId:null,generateId:false,debug:0};GeoJSONVT.prototype.splitTile=function(features,z,x,y,cz,cx,cy){var stack=[features,z,x,y],options=this.options,debug=options.debug;while(stack.length){y=stack.pop();x=stack.pop();z=stack.pop();features=stack.pop();var z2=1<<z,id=toID(z,x,y),tile=this.tiles[id];if(!tile){if(debug>1)console.time("creation");tile=this.tiles[id]=createTile(features,z,x,y,options);this.tileCoords.push({z:z,x:x,y:y});if(debug){if(debug>1){console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",z,x,y,tile.numFeatures,tile.numPoints,tile.numSimplified);console.timeEnd("creation")}var key="z"+z;this.stats[key]=(this.stats[key]||0)+1;this.total++}}tile.source=features;if(!cz){if(z===options.indexMaxZoom||tile.numPoints<=options.indexMaxPoints)continue}else{if(z===options.maxZoom||z===cz)continue;var m=1<<cz-z;if(x!==Math.floor(cx/m)||y!==Math.floor(cy/m))continue}tile.source=null;if(features.length===0)continue;if(debug>1)console.time("clipping");var k1=.5*options.buffer/options.extent,k2=.5-k1,k3=.5+k1,k4=1+k1,tl,bl,tr,br,left,right;tl=bl=tr=br=null;left=clip(features,z2,x-k1,x+k3,0,tile.minX,tile.maxX,options);right=clip(features,z2,x+k2,x+k4,0,tile.minX,tile.maxX,options);features=null;if(left){tl=clip(left,z2,y-k1,y+k3,1,tile.minY,tile.maxY,options);bl=clip(left,z2,y+k2,y+k4,1,tile.minY,tile.maxY,options);left=null}if(right){tr=clip(right,z2,y-k1,y+k3,1,tile.minY,tile.maxY,options);br=clip(right,z2,y+k2,y+k4,1,tile.minY,tile.maxY,options);right=null}if(debug>1)console.timeEnd("clipping");stack.push(tl||[],z+1,x*2,y*2);stack.push(bl||[],z+1,x*2,y*2+1);stack.push(tr||[],z+1,x*2+1,y*2);stack.push(br||[],z+1,x*2+1,y*2+1)}};GeoJSONVT.prototype.getTile=function(z,x,y){var options=this.options,extent=options.extent,debug=options.debug;if(z<0||z>24)return null;var z2=1<<z;x=(x%z2+z2)%z2;var id=toID(z,x,y);if(this.tiles[id])return transformTile(this.tiles[id],extent);if(debug>1)console.log("drilling down to z%d-%d-%d",z,x,y);var z0=z,x0=x,y0=y,parent;while(!parent&&z0>0){z0--;x0=Math.floor(x0/2);y0=Math.floor(y0/2);parent=this.tiles[toID(z0,x0,y0)]}if(!parent||!parent.source)return null;if(debug>1)console.log("found parent tile z%d-%d-%d",z0,x0,y0);if(debug>1)console.time("drilling down");this.splitTile(parent.source,z0,x0,y0,z,x,y);if(debug>1)console.timeEnd("drilling down");return this.tiles[id]?transformTile(this.tiles[id],extent):null};function toID(z,x,y){return((1<<z)*y+x)*32+z}function extend(dest,src){for(var i in src)dest[i]=src[i];return dest}function getFeatureId(feature,promoteId){return promoteId?feature.properties[promoteId]:feature.id}function isUpdateableGeoJSON(data,promoteId){if(data==null){return true}if(data.type==="Feature"){return getFeatureId(data,promoteId)!=null}if(data.type==="FeatureCollection"){const seenIds=new Set;for(const feature of data.features){const id=getFeatureId(feature,promoteId);if(id==null){return false}if(seenIds.has(id)){return false}seenIds.add(id)}return true}return false}function toUpdateable(data,promoteId){const result=new Map;if(data==null){}else if(data.type==="Feature"){result.set(getFeatureId(data,promoteId),data)}else{for(const feature of data.features){result.set(getFeatureId(feature,promoteId),feature)}}return result}function applySourceDiff(updateable,diff,promoteId){var _a,_b,_c,_d;if(diff.removeAll){updateable.clear()}if(diff.remove){for(const id of diff.remove){updateable.delete(id)}}if(diff.add){for(const feature of diff.add){const id=getFeatureId(feature,promoteId);if(id!=null){updateable.set(id,feature)}}}if(diff.update){for(const update of diff.update){let feature=updateable.get(update.id);if(feature==null){continue}const cloneFeature=update.newGeometry||update.removeAllProperties;const cloneProperties=!update.removeAllProperties&&(((_a=update.removeProperties)===null||_a===void 0?void 0:_a.length)>0||((_b=update.addOrUpdateProperties)===null||_b===void 0?void 0:_b.length)>0);if(cloneFeature||cloneProperties){feature=Object.assign({},feature);updateable.set(update.id,feature);if(cloneProperties){feature.properties=Object.assign({},feature.properties)}}if(update.newGeometry){feature.geometry=update.newGeometry}if(update.removeAllProperties){feature.properties={}}else if(((_c=update.removeProperties)===null||_c===void 0?void 0:_c.length)>0){for(const prop of update.removeProperties){if(Object.prototype.hasOwnProperty.call(feature.properties,prop)){delete feature.properties[prop]}}}if(((_d=update.addOrUpdateProperties)===null||_d===void 0?void 0:_d.length)>0){for(const{key:key,value:value}of update.addOrUpdateProperties){feature.properties[key]=value}}}}}class GeoJSONWorkerSource extends VectorTileWorkerSource{constructor(){super(...arguments);this._dataUpdateable=new Map}loadVectorTile(params,_abortController){return performance.__awaiter(this,void 0,void 0,(function*(){const canonical=params.tileID.canonical;if(!this._geoJSONIndex){throw new Error("Unable to parse the data into a cluster or geojson")}const geoJSONTile=this._geoJSONIndex.getTile(canonical.z,canonical.x,canonical.y);if(!geoJSONTile){return null}const geojsonWrapper=new GeoJSONWrapper$2(geoJSONTile.features);let pbf=vtpbf(geojsonWrapper);if(pbf.byteOffset!==0||pbf.byteLength!==pbf.buffer.byteLength){pbf=new Uint8Array(pbf)}return{vectorTile:geojsonWrapper,rawData:pbf.buffer}}))}loadData(params){var _a;return performance.__awaiter(this,void 0,void 0,(function*(){(_a=this._pendingRequest)===null||_a===void 0?void 0:_a.abort();const perf=params&&params.request&&params.request.collectResourceTiming?new performance.RequestPerformance(params.request):false;this._pendingRequest=new AbortController;try{let data=yield this.loadGeoJSON(params,this._pendingRequest);delete this._pendingRequest;if(typeof data!=="object"){throw new Error(`Input data given to '${params.source}' is not a valid GeoJSON object.`)}rewind$2(data,true);if(params.filter){const compiled=performance.createExpression(params.filter,{type:"boolean","property-type":"data-driven",overridable:false,transition:false});if(compiled.result==="error")throw new Error(compiled.value.map((err=>`${err.key}: ${err.message}`)).join(", "));const features=data.features.filter((feature=>compiled.value.evaluate({zoom:0},feature)));data={type:"FeatureCollection",features:features}}this._geoJSONIndex=params.cluster?new Supercluster(getSuperclusterOptions(params)).load(data.features):geojsonvt(data,params.geojsonVtOptions);this.loaded={};const result={};if(perf){const resourceTimingData=perf.finish();if(resourceTimingData){result.resourceTiming={};result.resourceTiming[params.source]=JSON.parse(JSON.stringify(resourceTimingData))}}return result}catch(err){delete this._pendingRequest;if(performance.isAbortError(err)){return{abandoned:true}}throw err}}))}reloadTile(params){const loaded=this.loaded,uid=params.uid;if(loaded&&loaded[uid]){return super.reloadTile(params)}else{return this.loadTile(params)}}loadGeoJSON(params,abortController){return performance.__awaiter(this,void 0,void 0,(function*(){const{promoteId:promoteId}=params;if(params.request){const response=yield performance.getJSON(params.request,abortController);this._dataUpdateable=isUpdateableGeoJSON(response.data,promoteId)?toUpdateable(response.data,promoteId):undefined;return response.data}if(typeof params.data==="string"){try{const parsed=JSON.parse(params.data);this._dataUpdateable=isUpdateableGeoJSON(parsed,promoteId)?toUpdateable(parsed,promoteId):undefined;return parsed}catch(e){throw new Error(`Input data given to '${params.source}' is not a valid GeoJSON object.`)}}if(!params.dataDiff){throw new Error(`Input data given to '${params.source}' is not a valid GeoJSON object.`)}if(!this._dataUpdateable){throw new Error(`Cannot update existing geojson data in ${params.source}`)}applySourceDiff(this._dataUpdateable,params.dataDiff,promoteId);return{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}}))}removeSource(_params){return performance.__awaiter(this,void 0,void 0,(function*(){if(this._pendingRequest){this._pendingRequest.abort()}}))}getClusterExpansionZoom(params){return this._geoJSONIndex.getClusterExpansionZoom(params.clusterId)}getClusterChildren(params){return this._geoJSONIndex.getChildren(params.clusterId)}getClusterLeaves(params){return this._geoJSONIndex.getLeaves(params.clusterId,params.limit,params.offset)}}function getSuperclusterOptions({superclusterOptions:superclusterOptions,clusterProperties:clusterProperties}){if(!clusterProperties||!superclusterOptions)return superclusterOptions;const mapExpressions={};const reduceExpressions={};const globals={accumulated:null,zoom:0};const feature={properties:null};const propertyNames=Object.keys(clusterProperties);for(const key of propertyNames){const[operator,mapExpression]=clusterProperties[key];const mapExpressionParsed=performance.createExpression(mapExpression);const reduceExpressionParsed=performance.createExpression(typeof operator==="string"?[operator,["accumulated"],["get",key]]:operator);mapExpressions[key]=mapExpressionParsed.value;reduceExpressions[key]=reduceExpressionParsed.value}superclusterOptions.map=pointProperties=>{feature.properties=pointProperties;const properties={};for(const key of propertyNames){properties[key]=mapExpressions[key].evaluate(globals,feature)}return properties};superclusterOptions.reduce=(accumulated,clusterProperties)=>{feature.properties=clusterProperties;for(const key of propertyNames){globals.accumulated=accumulated[key];accumulated[key]=reduceExpressions[key].evaluate(globals,feature)}};return superclusterOptions}class Worker{constructor(self){this.self=self;this.actor=new performance.Actor(self);this.layerIndexes={};this.availableImages={};this.workerSources={};this.demWorkerSources={};this.externalWorkerSourceTypes={};this.self.registerWorkerSource=(name,WorkerSource)=>{if(this.externalWorkerSourceTypes[name]){throw new Error(`Worker source with name "${name}" already registered.`)}this.externalWorkerSourceTypes[name]=WorkerSource};this.self.addProtocol=performance.addProtocol;this.self.removeProtocol=performance.removeProtocol;this.self.registerRTLTextPlugin=rtlTextPlugin=>{if(performance.rtlWorkerPlugin.isParsed()){throw new Error("RTL text plugin already registered.")}performance.rtlWorkerPlugin.setMethods(rtlTextPlugin)};this.actor.registerMessageHandler("loadDEMTile",((mapId,params)=>this._getDEMWorkerSource(mapId,params.source).loadTile(params)));this.actor.registerMessageHandler("removeDEMTile",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this._getDEMWorkerSource(mapId,params.source).removeTile(params)}))));this.actor.registerMessageHandler("getClusterExpansionZoom",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){return this._getWorkerSource(mapId,params.type,params.source).getClusterExpansionZoom(params)}))));this.actor.registerMessageHandler("getClusterChildren",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){return this._getWorkerSource(mapId,params.type,params.source).getClusterChildren(params)}))));this.actor.registerMessageHandler("getClusterLeaves",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){return this._getWorkerSource(mapId,params.type,params.source).getClusterLeaves(params)}))));this.actor.registerMessageHandler("loadData",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).loadData(params)));this.actor.registerMessageHandler("loadTile",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).loadTile(params)));this.actor.registerMessageHandler("reloadTile",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).reloadTile(params)));this.actor.registerMessageHandler("abortTile",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).abortTile(params)));this.actor.registerMessageHandler("removeTile",((mapId,params)=>this._getWorkerSource(mapId,params.type,params.source).removeTile(params)));this.actor.registerMessageHandler("removeSource",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){if(!this.workerSources[mapId]||!this.workerSources[mapId][params.type]||!this.workerSources[mapId][params.type][params.source]){return}const worker=this.workerSources[mapId][params.type][params.source];delete this.workerSources[mapId][params.type][params.source];if(worker.removeSource!==undefined){worker.removeSource(params)}}))));this.actor.registerMessageHandler("setReferrer",((_mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this.referrer=params}))));this.actor.registerMessageHandler("syncRTLPluginState",((mapId,params)=>this._syncRTLPluginState(mapId,params)));this.actor.registerMessageHandler("importScript",((_mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this.self.importScripts(params)}))));this.actor.registerMessageHandler("setImages",((mapId,params)=>this._setImages(mapId,params)));this.actor.registerMessageHandler("updateLayers",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this._getLayerIndex(mapId).update(params.layers,params.removedIds)}))));this.actor.registerMessageHandler("setLayers",((mapId,params)=>performance.__awaiter(this,void 0,void 0,(function*(){this._getLayerIndex(mapId).replace(params)}))))}_setImages(mapId,images){return performance.__awaiter(this,void 0,void 0,(function*(){this.availableImages[mapId]=images;for(const workerSource in this.workerSources[mapId]){const ws=this.workerSources[mapId][workerSource];for(const source in ws){ws[source].availableImages=images}}}))}_syncRTLPluginState(map,state){return performance.__awaiter(this,void 0,void 0,(function*(){performance.rtlWorkerPlugin.setState(state);const pluginURL=performance.rtlWorkerPlugin.getPluginURL();if(state.pluginStatus==="loaded"&&!performance.rtlWorkerPlugin.isParsed()&&pluginURL!=null){this.self.importScripts(pluginURL);const complete=performance.rtlWorkerPlugin.isParsed();if(complete){return complete}throw new Error(`RTL Text Plugin failed to import scripts from ${pluginURL}`)}return false}))}_getAvailableImages(mapId){let availableImages=this.availableImages[mapId];if(!availableImages){availableImages=[]}return availableImages}_getLayerIndex(mapId){let layerIndexes=this.layerIndexes[mapId];if(!layerIndexes){layerIndexes=this.layerIndexes[mapId]=new StyleLayerIndex}return layerIndexes}_getWorkerSource(mapId,sourceType,sourceName){if(!this.workerSources[mapId])this.workerSources[mapId]={};if(!this.workerSources[mapId][sourceType])this.workerSources[mapId][sourceType]={};if(!this.workerSources[mapId][sourceType][sourceName]){const actor={sendAsync:(message,abortController)=>{message.targetMapId=mapId;return this.actor.sendAsync(message,abortController)}};switch(sourceType){case"vector":this.workerSources[mapId][sourceType][sourceName]=new VectorTileWorkerSource(actor,this._getLayerIndex(mapId),this._getAvailableImages(mapId));break;case"geojson":this.workerSources[mapId][sourceType][sourceName]=new GeoJSONWorkerSource(actor,this._getLayerIndex(mapId),this._getAvailableImages(mapId));break;default:this.workerSources[mapId][sourceType][sourceName]=new this.externalWorkerSourceTypes[sourceType](actor,this._getLayerIndex(mapId),this._getAvailableImages(mapId));break}}return this.workerSources[mapId][sourceType][sourceName]}_getDEMWorkerSource(mapId,sourceType){if(!this.demWorkerSources[mapId])this.demWorkerSources[mapId]={};if(!this.demWorkerSources[mapId][sourceType]){this.demWorkerSources[mapId][sourceType]=new RasterDEMTileWorkerSource}return this.demWorkerSources[mapId][sourceType]}}if(performance.isWorker(self)){self.worker=new Worker(self)}return Worker}));define("index",["exports","./shared"],(function(exports,performance$1){"use strict";var name="maplibre-gl";var description="BSD licensed community fork of mapbox-gl, a WebGL interactive maps library";var version$2="4.0.2";var main="dist/maplibre-gl.js";var style="dist/maplibre-gl.css";var license="BSD-3-Clause";var funding="https://github.com/maplibre/maplibre-gl-js?sponsor=1";var repository={type:"git",url:"git://github.com/maplibre/maplibre-gl-js.git"};var types="dist/maplibre-gl.d.ts";var type="module";var dependencies={"@mapbox/geojson-rewind":"^0.5.2","@mapbox/jsonlint-lines-primitives":"^2.0.2","@mapbox/point-geometry":"^0.1.0","@mapbox/tiny-sdf":"^2.0.6","@mapbox/unitbezier":"^0.0.1","@mapbox/vector-tile":"^1.3.1","@mapbox/whoots-js":"^3.1.0","@maplibre/maplibre-gl-style-spec":"^20.1.1","@types/geojson":"^7946.0.14","@types/geojson-vt":"3.2.5","@types/mapbox__point-geometry":"^0.1.4","@types/mapbox__vector-tile":"^1.3.4","@types/pbf":"^3.0.5","@types/supercluster":"^7.1.3",earcut:"^2.2.4","geojson-vt":"^3.2.1","gl-matrix":"^3.4.3","global-prefix":"^3.0.0",kdbush:"^4.0.2","murmurhash-js":"^1.0.0",pbf:"^3.2.1",potpack:"^2.0.0",quickselect:"^2.0.0",supercluster:"^8.0.1",tinyqueue:"^2.0.3","vt-pbf":"^3.1.3"};var devDependencies={"@mapbox/mapbox-gl-rtl-text":"^0.2.3","@mapbox/mvt-fixtures":"^3.10.0","@rollup/plugin-commonjs":"^25.0.7","@rollup/plugin-json":"^6.1.0","@rollup/plugin-node-resolve":"^15.2.3","@rollup/plugin-replace":"^5.0.5","@rollup/plugin-strip":"^3.0.4","@rollup/plugin-terser":"^0.4.4","@rollup/plugin-typescript":"^11.1.6","@types/benchmark":"^2.1.5","@types/cssnano":"^5.0.0","@types/d3":"^7.4.3","@types/diff":"^5.0.9","@types/earcut":"^2.1.4","@types/eslint":"^8.56.2","@types/gl":"^6.0.5","@types/glob":"^8.1.0","@types/jest":"^29.5.12","@types/jsdom":"^21.1.6","@types/minimist":"^1.2.5","@types/murmurhash-js":"^1.0.6","@types/nise":"^1.4.4","@types/node":"^20.11.19","@types/offscreencanvas":"^2019.7.3","@types/pixelmatch":"^5.2.6","@types/pngjs":"^6.0.4","@types/react":"^18.2.56","@types/react-dom":"^18.2.19","@types/request":"^2.48.12","@types/shuffle-seed":"^1.1.3","@types/window-or-global":"^1.0.6","@typescript-eslint/eslint-plugin":"^7.0.0","@typescript-eslint/parser":"^6.21.0",address:"^2.0.1",benchmark:"^2.1.4",canvas:"^2.11.2",cssnano:"^6.0.3",d3:"^7.8.5","d3-queue":"^3.0.7","devtools-protocol":"^0.0.1262051",diff:"^5.2.0","dts-bundle-generator":"^9.3.1",eslint:"^8.56.0","eslint-config-mourner":"^3.0.0","eslint-plugin-html":"^8.0.0","eslint-plugin-import":"^2.29.1","eslint-plugin-jest":"^27.9.0","eslint-plugin-react":"^7.33.2","eslint-plugin-tsdoc":"0.2.17",expect:"^29.7.0",glob:"^10.3.10","is-builtin-module":"^3.2.1",jest:"^29.7.0","jest-environment-jsdom":"^29.7.0","jest-monocart-coverage":"^1.0.2","jest-webgl-canvas-mock":"^2.5.3",jsdom:"^24.0.0","json-stringify-pretty-compact":"^4.0.0",minimist:"^1.2.8","mock-geolocation":"^1.0.11","monocart-coverage-reports":"^2.5.0",nise:"^5.1.9","npm-font-open-sans":"^1.1.0","npm-run-all":"^4.1.5","pdf-merger-js":"^5.1.1",pixelmatch:"^5.3.0",pngjs:"^7.0.0",postcss:"^8.4.35","postcss-cli":"^11.0.0","postcss-inline-svg":"^6.0.0","pretty-bytes":"^6.1.1",puppeteer:"^22.1.0",react:"^18.2.0","react-dom":"^18.2.0",rollup:"^4.12.0","rollup-plugin-sourcemaps":"^0.6.3",rw:"^1.3.3",semver:"^7.6.0","shuffle-seed":"^1.1.6","source-map-explorer":"^2.5.3",st:"^3.0.0",stylelint:"^16.2.1","stylelint-config-standard":"^36.0.0","ts-jest":"^29.1.2","ts-node":"^10.9.2",tslib:"^2.6.2",typedoc:"^0.25.8","typedoc-plugin-markdown":"^3.17.1","typedoc-plugin-missing-exports":"^2.2.0",typescript:"^5.3.3"};var overrides={"postcss-inline-svg":{"css-select":"^5.1.0","dom-serializer":"^2.0.0",htmlparser2:"^8.0.1","postcss-value-parser":"^4.2.0"}};var scripts={"generate-dist-package":"node --no-warnings --loader ts-node/esm build/generate-dist-package.js","generate-shaders":"node --no-warnings --loader ts-node/esm build/generate-shaders.ts","generate-struct-arrays":"node --no-warnings --loader ts-node/esm build/generate-struct-arrays.ts","generate-style-code":"node --no-warnings --loader ts-node/esm build/generate-style-code.ts","generate-typings":"dts-bundle-generator --export-referenced-types --umd-module-name=maplibregl -o ./dist/maplibre-gl.d.ts ./src/index.ts","generate-docs":"typedoc && node --no-warnings --loader ts-node/esm build/generate-docs.ts","generate-images":"node --no-warnings --loader ts-node/esm build/generate-doc-images.ts","build-dist":"npm run build-css && npm run generate-typings && npm run build-dev && npm run build-csp-dev && npm run build-prod && npm run build-csp","build-dev":"rollup --configPlugin @rollup/plugin-typescript -c --environment BUILD:dev","watch-dev":"rollup --configPlugin @rollup/plugin-typescript -c --environment BUILD:dev --watch","build-prod":"rollup --configPlugin @rollup/plugin-typescript -c --environment BUILD:production","build-csp":"rollup --configPlugin @rollup/plugin-typescript -c rollup.config.csp.ts","build-csp-dev":"rollup --configPlugin @rollup/plugin-typescript -c rollup.config.csp.ts --environment BUILD:dev","build-css":"postcss -o dist/maplibre-gl.css src/css/maplibre-gl.css","watch-css":"postcss --watch -o dist/maplibre-gl.css src/css/maplibre-gl.css","build-benchmarks":"npm run build-dev && rollup --configPlugin @rollup/plugin-typescript -c test/bench/rollup_config_benchmarks.ts","watch-benchmarks":"rollup --configPlugin @rollup/plugin-typescript -c test/bench/rollup_config_benchmarks.ts --watch","start-server":"st --no-cache -H 0.0.0.0 --port 9966 .","start-docs":"docker run --rm -it -p 8000:8000 -v ${PWD}:/docs squidfunk/mkdocs-material",start:"run-p watch-css watch-dev start-server","start-bench":"run-p watch-css watch-benchmarks start-server",lint:"eslint --cache --ext .ts,.tsx,.js,.html --ignore-path .gitignore .","lint-css":"stylelint src/css/maplibre-gl.css",test:"run-p lint lint-css test-render jest",jest:"jest","test-build":"jest --selectProjects=build --reporters=default","test-build-ci":"jest --selectProjects=build","test-integration":"jest --selectProjects=integration --reporters=default","test-integration-ci":"jest --selectProjects=integration","test-render":"node --no-warnings --loader ts-node/esm test/integration/render/run_render_tests.ts","test-unit":"jest --selectProjects=unit --reporters=default","test-unit-ci":"jest --coverage --selectProjects unit","test-watch-roots":"jest --watch",codegen:"run-p --print-label generate-dist-package generate-style-code generate-struct-arrays generate-shaders && npm run generate-typings",benchmark:"node --no-warnings --loader ts-node/esm test/bench/run-benchmarks.ts","gl-stats":"node --no-warnings --loader ts-node/esm test/bench/gl-stats.ts",prepare:"npm run codegen",typecheck:"tsc --noEmit && tsc --project tsconfig.dist.json",tsnode:"node --experimental-loader=ts-node/esm --no-warnings"};var files=["build/","dist/*","src/"];var engines={npm:">=8.1.0",node:">=16.14.0"};var packageJSON={name:name,description:description,version:version$2,main:main,style:style,license:license,funding:funding,repository:repository,types:types,type:type,dependencies:dependencies,devDependencies:devDependencies,overrides:overrides,scripts:scripts,files:files,engines:engines};const now=typeof performance!=="undefined"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date);let linkEl;let reducedMotionQuery;const browser={now:now,frameAsync(abortController){return new Promise(((resolve,reject)=>{const frame=requestAnimationFrame(resolve);abortController.signal.addEventListener("abort",(()=>{cancelAnimationFrame(frame);reject(performance$1.createAbortError())}))}))},getImageData(img,padding=0){const context=this.getImageCanvasContext(img);return context.getImageData(-padding,-padding,img.width+2*padding,img.height+2*padding)},getImageCanvasContext(img){const canvas=window.document.createElement("canvas");const context=canvas.getContext("2d",{willReadFrequently:true});if(!context){throw new Error("failed to create canvas 2d context")}canvas.width=img.width;canvas.height=img.height;context.drawImage(img,0,0,img.width,img.height);return context},resolveURL(path){if(!linkEl)linkEl=document.createElement("a");linkEl.href=path;return linkEl.href},hardwareConcurrency:typeof navigator!=="undefined"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){if(!matchMedia)return false;if(reducedMotionQuery==null){reducedMotionQuery=matchMedia("(prefers-reduced-motion: reduce)")}return reducedMotionQuery.matches}};class DOM{static testProp(props){if(!DOM.docStyle)return props[0];for(let i=0;i<props.length;i++){if(props[i]in DOM.docStyle){return props[i]}}return props[0]}static create(tagName,className,container){const el=window.document.createElement(tagName);if(className!==undefined)el.className=className;if(container)container.appendChild(el);return el}static createNS(namespaceURI,tagName){const el=window.document.createElementNS(namespaceURI,tagName);return el}static disableDrag(){if(DOM.docStyle&&DOM.selectProp){DOM.userSelect=DOM.docStyle[DOM.selectProp];DOM.docStyle[DOM.selectProp]="none"}}static enableDrag(){if(DOM.docStyle&&DOM.selectProp){DOM.docStyle[DOM.selectProp]=DOM.userSelect}}static setTransform(el,value){el.style[DOM.transformProp]=value}static addEventListener(target,type,callback,options={}){if("passive"in options){target.addEventListener(type,callback,options)}else{target.addEventListener(type,callback,options.capture)}}static removeEventListener(target,type,callback,options={}){if("passive"in options){target.removeEventListener(type,callback,options)}else{target.removeEventListener(type,callback,options.capture)}}static suppressClickInternal(e){e.preventDefault();e.stopPropagation();window.removeEventListener("click",DOM.suppressClickInternal,true)}static suppressClick(){window.addEventListener("click",DOM.suppressClickInternal,true);window.setTimeout((()=>{window.removeEventListener("click",DOM.suppressClickInternal,true)}),0)}static getScale(element){const rect=element.getBoundingClientRect();return{x:rect.width/element.offsetWidth||1,y:rect.height/element.offsetHeight||1,boundingClientRect:rect}}static getPoint(el,scale,e){const rect=scale.boundingClientRect;return new performance$1.Point((e.clientX-rect.left)/scale.x-el.clientLeft,(e.clientY-rect.top)/scale.y-el.clientTop)}static mousePos(el,e){const scale=DOM.getScale(el);return DOM.getPoint(el,scale,e)}static touchPos(el,touches){const points=[];const scale=DOM.getScale(el);for(let i=0;i<touches.length;i++){points.push(DOM.getPoint(el,scale,touches[i]))}return points}static mouseButton(e){return e.button}static remove(node){if(node.parentNode){node.parentNode.removeChild(node)}}}DOM.docStyle=typeof window!=="undefined"&&window.document&&window.document.documentElement.style;DOM.selectProp=DOM.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]);DOM.transformProp=DOM.testProp(["transform","WebkitTransform"]);const webpSupported={supported:false,testSupport:testSupport};let glForTesting;let webpCheckComplete=false;let webpImgTest;let webpImgTestOnloadComplete=false;if(typeof document!=="undefined"){webpImgTest=document.createElement("img");webpImgTest.onload=function(){if(glForTesting)testWebpTextureUpload(glForTesting);glForTesting=null;webpImgTestOnloadComplete=true};webpImgTest.onerror=function(){webpCheckComplete=true;glForTesting=null};webpImgTest.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="}function testSupport(gl){if(webpCheckComplete||!webpImgTest)return;if(webpImgTestOnloadComplete){testWebpTextureUpload(gl)}else{glForTesting=gl}}function testWebpTextureUpload(gl){const texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);try{gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,webpImgTest);if(gl.isContextLost())return;webpSupported.supported=true}catch(e){}gl.deleteTexture(texture);webpCheckComplete=true}var ImageRequest;(function(ImageRequest){let imageRequestQueue;let currentParallelImageRequests;let throttleControlCallbackHandleCounter;let throttleControlCallbacks;ImageRequest.resetRequestQueue=()=>{imageRequestQueue=[];currentParallelImageRequests=0;throttleControlCallbackHandleCounter=0;throttleControlCallbacks={}};ImageRequest.addThrottleControl=callback=>{const handle=throttleControlCallbackHandleCounter++;throttleControlCallbacks[handle]=callback;return handle};ImageRequest.removeThrottleControl=callbackHandle=>{delete throttleControlCallbacks[callbackHandle];processQueue()};const isThrottled=()=>{for(const key of Object.keys(throttleControlCallbacks)){if(throttleControlCallbacks[key]()){return true}}return false};ImageRequest.getImage=(requestParameters,abortController,supportImageRefresh=true)=>new Promise(((resolve,reject)=>{if(webpSupported.supported){if(!requestParameters.headers){requestParameters.headers={}}requestParameters.headers.accept="image/webp,*/*"}performance$1.extend(requestParameters,{type:"image"});const request={abortController:abortController,requestParameters:requestParameters,supportImageRefresh:supportImageRefresh,state:"queued",onError:error=>{reject(error)},onSuccess:response=>{resolve(response)}};imageRequestQueue.push(request);processQueue()}));const arrayBufferToCanvasImageSource=data=>{const imageBitmapSupported=typeof createImageBitmap==="function";if(imageBitmapSupported){return performance$1.arrayBufferToImageBitmap(data)}else{return performance$1.arrayBufferToImage(data)}};const doImageRequest=itemInQueue=>performance$1.__awaiter(this,void 0,void 0,(function*(){itemInQueue.state="running";const{requestParameters:requestParameters,supportImageRefresh:supportImageRefresh,onError:onError,onSuccess:onSuccess,abortController:abortController}=itemInQueue;const canUseHTMLImageElement=supportImageRefresh===false&&!performance$1.isWorker(self)&&!performance$1.getProtocol(requestParameters.url)&&(!requestParameters.headers||Object.keys(requestParameters.headers).reduce(((acc,item)=>acc&&item==="accept"),true));currentParallelImageRequests++;const getImagePromise=canUseHTMLImageElement?getImageUsingHtmlImage(requestParameters,abortController):performance$1.makeRequest(requestParameters,abortController);try{const response=yield getImagePromise;delete itemInQueue.abortController;itemInQueue.state="completed";if(response.data instanceof HTMLImageElement||performance$1.isImageBitmap(response.data)){onSuccess(response)}else if(response.data){const img=yield arrayBufferToCanvasImageSource(response.data);onSuccess({data:img,cacheControl:response.cacheControl,expires:response.expires})}}catch(err){delete itemInQueue.abortController;onError(err)}finally{currentParallelImageRequests--;processQueue()}}));const processQueue=()=>{const maxImageRequests=isThrottled()?performance$1.config.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:performance$1.config.MAX_PARALLEL_IMAGE_REQUESTS;for(let numImageRequests=currentParallelImageRequests;numImageRequests<maxImageRequests&&imageRequestQueue.length>0;numImageRequests++){const topItemInQueue=imageRequestQueue.shift();if(topItemInQueue.abortController.signal.aborted){numImageRequests--;continue}doImageRequest(topItemInQueue)}};const getImageUsingHtmlImage=(requestParameters,abortController)=>new Promise(((resolve,reject)=>{const image=new Image;const url=requestParameters.url;const credentials=requestParameters.credentials;if(credentials&&credentials==="include"){image.crossOrigin="use-credentials"}else if(credentials&&credentials==="same-origin"||!performance$1.sameOrigin(url)){image.crossOrigin="anonymous"}abortController.signal.addEventListener("abort",(()=>{image.src="";reject(performance$1.createAbortError())}));image.fetchPriority="high";image.onload=()=>{image.onerror=image.onload=null;resolve({data:image})};image.onerror=()=>{image.onerror=image.onload=null;if(abortController.signal.aborted){return}reject(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))};image.src=url}))})(ImageRequest||(ImageRequest={}));ImageRequest.resetRequestQueue();var ResourceType;(function(ResourceType){ResourceType["Glyphs"]="Glyphs";ResourceType["Image"]="Image";ResourceType["Source"]="Source";ResourceType["SpriteImage"]="SpriteImage";ResourceType["SpriteJSON"]="SpriteJSON";ResourceType["Style"]="Style";ResourceType["Tile"]="Tile";ResourceType["Unknown"]="Unknown"})(ResourceType||(ResourceType={}));class RequestManager{constructor(transformRequestFn){this._transformRequestFn=transformRequestFn}transformRequest(url,type){if(this._transformRequestFn){return this._transformRequestFn(url,type)||{url:url}}return{url:url}}normalizeSpriteURL(url,format,extension){const urlObject=parseUrl(url);urlObject.path+=`${format}${extension}`;return formatUrl(urlObject)}setTransformRequest(transformRequest){this._transformRequestFn=transformRequest}}const urlRe=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function parseUrl(url){const parts=url.match(urlRe);if(!parts){throw new Error(`Unable to parse URL "${url}"`)}return{protocol:parts[1],authority:parts[2],path:parts[3]||"/",params:parts[4]?parts[4].split("&"):[]}}function formatUrl(obj){const params=obj.params.length?`?${obj.params.join("&")}`:"";return`${obj.protocol}://${obj.authority}${obj.path}${params}`}function coerceSpriteToArray(sprite){const resultArray=[];if(typeof sprite==="string"){resultArray.push({id:"default",url:sprite})}else if(sprite&&sprite.length>0){const dedupArray=[];for(const{id:id,url:url}of sprite){const key=`${id}${url}`;if(dedupArray.indexOf(key)===-1){dedupArray.push(key);resultArray.push({id:id,url:url})}}}return resultArray}function loadSprite(originalSprite,requestManager,pixelRatio,abortController){return performance$1.__awaiter(this,void 0,void 0,(function*(){const spriteArray=coerceSpriteToArray(originalSprite);const format=pixelRatio>1?"@2x":"";const jsonsMap={};const imagesMap={};for(const{id:id,url:url}of spriteArray){const jsonRequestParameters=requestManager.transformRequest(requestManager.normalizeSpriteURL(url,format,".json"),ResourceType.SpriteJSON);jsonsMap[id]=performance$1.getJSON(jsonRequestParameters,abortController);const imageRequestParameters=requestManager.transformRequest(requestManager.normalizeSpriteURL(url,format,".png"),ResourceType.SpriteImage);imagesMap[id]=ImageRequest.getImage(imageRequestParameters,abortController)}yield Promise.all([...Object.values(jsonsMap),...Object.values(imagesMap)]);return doOnceCompleted(jsonsMap,imagesMap)}))}function doOnceCompleted(jsonsMap,imagesMap){return performance$1.__awaiter(this,void 0,void 0,(function*(){const result={};for(const spriteName in jsonsMap){result[spriteName]={};const context=browser.getImageCanvasContext((yield imagesMap[spriteName]).data);const json=(yield jsonsMap[spriteName]).data;for(const id in json){const{width:width,height:height,x:x,y:y,sdf:sdf,pixelRatio:pixelRatio,stretchX:stretchX,stretchY:stretchY,content:content}=json[id];const spriteData={width:width,height:height,x:x,y:y,context:context};result[spriteName][id]={data:null,pixelRatio:pixelRatio,sdf:sdf,stretchX:stretchX,stretchY:stretchY,content:content,spriteData:spriteData}}}return result}))}class Texture{constructor(context,image,format,options){this.context=context;this.format=format;this.texture=context.gl.createTexture();this.update(image,options)}update(image,options,position){const{width:width,height:height}=image;const resize=(!this.size||this.size[0]!==width||this.size[1]!==height)&&!position;const{context:context}=this;const{gl:gl}=context;this.useMipmap=Boolean(options&&options.useMipmap);gl.bindTexture(gl.TEXTURE_2D,this.texture);context.pixelStoreUnpackFlipY.set(false);context.pixelStoreUnpack.set(1);context.pixelStoreUnpackPremultiplyAlpha.set(this.format===gl.RGBA&&(!options||options.premultiply!==false));if(resize){this.size=[width,height];if(image instanceof HTMLImageElement||image instanceof HTMLCanvasElement||image instanceof HTMLVideoElement||image instanceof ImageData||performance$1.isImageBitmap(image)){gl.texImage2D(gl.TEXTURE_2D,0,this.format,this.format,gl.UNSIGNED_BYTE,image)}else{gl.texImage2D(gl.TEXTURE_2D,0,this.format,width,height,0,this.format,gl.UNSIGNED_BYTE,image.data)}}else{const{x:x,y:y}=position||{x:0,y:0};if(image instanceof HTMLImageElement||image instanceof HTMLCanvasElement||image instanceof HTMLVideoElement||image instanceof ImageData||performance$1.isImageBitmap(image)){gl.texSubImage2D(gl.TEXTURE_2D,0,x,y,gl.RGBA,gl.UNSIGNED_BYTE,image)}else{gl.texSubImage2D(gl.TEXTURE_2D,0,x,y,width,height,gl.RGBA,gl.UNSIGNED_BYTE,image.data)}}if(this.useMipmap&&this.isSizePowerOfTwo()){gl.generateMipmap(gl.TEXTURE_2D)}}bind(filter,wrap,minFilter){const{context:context}=this;const{gl:gl}=context;gl.bindTexture(gl.TEXTURE_2D,this.texture);if(minFilter===gl.LINEAR_MIPMAP_NEAREST&&!this.isSizePowerOfTwo()){minFilter=gl.LINEAR}if(filter!==this.filter){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,filter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,minFilter||filter);this.filter=filter}if(wrap!==this.wrap){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,wrap);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,wrap);this.wrap=wrap}}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1===0}destroy(){const{gl:gl}=this.context;gl.deleteTexture(this.texture);this.texture=null}}function renderStyleImage(image){const{userImage:userImage}=image;if(userImage&&userImage.render){const updated=userImage.render();if(updated){image.data.replace(new Uint8Array(userImage.data.buffer));return true}}return false}const padding=1;class ImageManager extends performance$1.Evented{constructor(){super();this.images={};this.updatedImages={};this.callbackDispatchedThisFrame={};this.loaded=false;this.requestors=[];this.patterns={};this.atlasImage=new performance$1.RGBAImage({width:1,height:1});this.dirty=true}isLoaded(){return this.loaded}setLoaded(loaded){if(this.loaded===loaded){return}this.loaded=loaded;if(loaded){for(const{ids:ids,promiseResolve:promiseResolve}of this.requestors){promiseResolve(this._getImagesForIds(ids))}this.requestors=[]}}getImage(id){const image=this.images[id];if(image&&!image.data&&image.spriteData){const spriteData=image.spriteData;image.data=new performance$1.RGBAImage({width:spriteData.width,height:spriteData.height},spriteData.context.getImageData(spriteData.x,spriteData.y,spriteData.width,spriteData.height).data);image.spriteData=null}return image}addImage(id,image){if(this.images[id])throw new Error(`Image id ${id} already exist, use updateImage instead`);if(this._validate(id,image)){this.images[id]=image}}_validate(id,image){let valid=true;const data=image.data||image.spriteData;if(!this._validateStretch(image.stretchX,data&&data.width)){this.fire(new performance$1.ErrorEvent(new Error(`Image "${id}" has invalid "stretchX" value`)));valid=false}if(!this._validateStretch(image.stretchY,data&&data.height)){this.fire(new performance$1.ErrorEvent(new Error(`Image "${id}" has invalid "stretchY" value`)));valid=false}if(!this._validateContent(image.content,image)){this.fire(new performance$1.ErrorEvent(new Error(`Image "${id}" has invalid "content" value`)));valid=false}return valid}_validateStretch(stretch,size){if(!stretch)return true;let last=0;for(const part of stretch){if(part[0]<last||part[1]<part[0]||size<part[1])return false;last=part[1]}return true}_validateContent(content,image){if(!content)return true;if(content.length!==4)return false;const spriteData=image.spriteData;const width=spriteData&&spriteData.width||image.data.width;const height=spriteData&&spriteData.height||image.data.height;if(content[0]<0||width<content[0])return false;if(content[1]<0||height<content[1])return false;if(content[2]<0||width<content[2])return false;if(content[3]<0||height<content[3])return false;if(content[2]<content[0])return false;if(content[3]<content[1])return false;return true}updateImage(id,image,validate=true){const oldImage=this.getImage(id);if(validate&&(oldImage.data.width!==image.data.width||oldImage.data.height!==image.data.height)){throw new Error(`size mismatch between old image (${oldImage.data.width}x${oldImage.data.height}) and new image (${image.data.width}x${image.data.height}).`)}image.version=oldImage.version+1;this.images[id]=image;this.updatedImages[id]=true}removeImage(id){const image=this.images[id];delete this.images[id];delete this.patterns[id];if(image.userImage&&image.userImage.onRemove){image.userImage.onRemove()}}listImages(){return Object.keys(this.images)}getImages(ids){return new Promise(((resolve,_reject)=>{let hasAllDependencies=true;if(!this.isLoaded()){for(const id of ids){if(!this.images[id]){hasAllDependencies=false}}}if(this.isLoaded()||hasAllDependencies){resolve(this._getImagesForIds(ids))}else{this.requestors.push({ids:ids,promiseResolve:resolve})}}))}_getImagesForIds(ids){const response={};for(const id of ids){let image=this.getImage(id);if(!image){this.fire(new performance$1.Event("styleimagemissing",{id:id}));image=this.getImage(id)}if(image){response[id]={data:image.data.clone(),pixelRatio:image.pixelRatio,sdf:image.sdf,version:image.version,stretchX:image.stretchX,stretchY:image.stretchY,content:image.content,hasRenderCallback:Boolean(image.userImage&&image.userImage.render)}}else{performance$1.warnOnce(`Image "${id}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}}return response}getPixelSize(){const{width:width,height:height}=this.atlasImage;return{width:width,height:height}}getPattern(id){const pattern=this.patterns[id];const image=this.getImage(id);if(!image){return null}if(pattern&&pattern.position.version===image.version){return pattern.position}if(!pattern){const w=image.data.width+padding*2;const h=image.data.height+padding*2;const bin={w:w,h:h,x:0,y:0};const position=new performance$1.ImagePosition(bin,image);this.patterns[id]={bin:bin,position:position}}else{pattern.position.version=image.version}this._updatePatternAtlas();return this.patterns[id].position}bind(context){const gl=context.gl;if(!this.atlasTexture){this.atlasTexture=new Texture(context,this.atlasImage,gl.RGBA)}else if(this.dirty){this.atlasTexture.update(this.atlasImage);this.dirty=false}this.atlasTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE)}_updatePatternAtlas(){const bins=[];for(const id in this.patterns){bins.push(this.patterns[id].bin)}const{w:w,h:h}=performance$1.potpack(bins);const dst=this.atlasImage;dst.resize({width:w||1,height:h||1});for(const id in this.patterns){const{bin:bin}=this.patterns[id];const x=bin.x+padding;const y=bin.y+padding;const src=this.getImage(id).data;const w=src.width;const h=src.height;performance$1.RGBAImage.copy(src,dst,{x:0,y:0},{x:x,y:y},{width:w,height:h});performance$1.RGBAImage.copy(src,dst,{x:0,y:h-1},{x:x,y:y-1},{width:w,height:1});performance$1.RGBAImage.copy(src,dst,{x:0,y:0},{x:x,y:y+h},{width:w,height:1});performance$1.RGBAImage.copy(src,dst,{x:w-1,y:0},{x:x-1,y:y},{width:1,height:h});performance$1.RGBAImage.copy(src,dst,{x:0,y:0},{x:x+w,y:y},{width:1,height:h})}this.dirty=true}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(ids){for(const id of ids){if(this.callbackDispatchedThisFrame[id])continue;this.callbackDispatchedThisFrame[id]=true;const image=this.getImage(id);if(!image)performance$1.warnOnce(`Image with ID: "${id}" was not found`);const updated=renderStyleImage(image);if(updated){this.updateImage(id,image)}}}}function loadGlyphRange(fontstack,range,urlTemplate,requestManager){return performance$1.__awaiter(this,void 0,void 0,(function*(){const begin=range*256;const end=begin+255;const request=requestManager.transformRequest(urlTemplate.replace("{fontstack}",fontstack).replace("{range}",`${begin}-${end}`),ResourceType.Glyphs);const response=yield performance$1.getArrayBuffer(request,new AbortController);if(!response||!response.data){throw new Error(`Could not load glyph range. range: ${range}, ${begin}-${end}`)}const glyphs={};for(const glyph of performance$1.parseGlyphPbf(response.data)){glyphs[glyph.id]=glyph}return glyphs}))}const INF=1e20;class TinySDF{constructor({fontSize:fontSize=24,buffer:buffer=3,radius:radius=8,cutoff:cutoff=.25,fontFamily:fontFamily="sans-serif",fontWeight:fontWeight="normal",fontStyle:fontStyle="normal"}={}){this.buffer=buffer;this.cutoff=cutoff;this.radius=radius;const size=this.size=fontSize+buffer*4;const canvas=this._createCanvas(size);const ctx=this.ctx=canvas.getContext("2d",{willReadFrequently:true});ctx.font=`${fontStyle} ${fontWeight} ${fontSize}px ${fontFamily}`;ctx.textBaseline="alphabetic";ctx.textAlign="left";ctx.fillStyle="black";this.gridOuter=new Float64Array(size*size);this.gridInner=new Float64Array(size*size);this.f=new Float64Array(size);this.z=new Float64Array(size+1);this.v=new Uint16Array(size)}_createCanvas(size){const canvas=document.createElement("canvas");canvas.width=canvas.height=size;return canvas}draw(char){const{width:glyphAdvance,actualBoundingBoxAscent:actualBoundingBoxAscent,actualBoundingBoxDescent:actualBoundingBoxDescent,actualBoundingBoxLeft:actualBoundingBoxLeft,actualBoundingBoxRight:actualBoundingBoxRight}=this.ctx.measureText(char);const glyphTop=Math.ceil(actualBoundingBoxAscent);const glyphLeft=0;const glyphWidth=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(actualBoundingBoxRight-actualBoundingBoxLeft)));const glyphHeight=Math.min(this.size-this.buffer,glyphTop+Math.ceil(actualBoundingBoxDescent));const width=glyphWidth+2*this.buffer;const height=glyphHeight+2*this.buffer;const len=Math.max(width*height,0);const data=new Uint8ClampedArray(len);const glyph={data:data,width:width,height:height,glyphWidth:glyphWidth,glyphHeight:glyphHeight,glyphTop:glyphTop,glyphLeft:glyphLeft,glyphAdvance:glyphAdvance};if(glyphWidth===0||glyphHeight===0)return glyph;const{ctx:ctx,buffer:buffer,gridInner:gridInner,gridOuter:gridOuter}=this;ctx.clearRect(buffer,buffer,glyphWidth,glyphHeight);ctx.fillText(char,buffer,buffer+glyphTop);const imgData=ctx.getImageData(buffer,buffer,glyphWidth,glyphHeight);gridOuter.fill(INF,0,len);gridInner.fill(0,0,len);for(let y=0;y<glyphHeight;y++){for(let x=0;x<glyphWidth;x++){const a=imgData.data[4*(y*glyphWidth+x)+3]/255;if(a===0)continue;const j=(y+buffer)*width+x+buffer;if(a===1){gridOuter[j]=0;gridInner[j]=INF}else{const d=.5-a;gridOuter[j]=d>0?d*d:0;gridInner[j]=d<0?d*d:0}}}edt(gridOuter,0,0,width,height,width,this.f,this.v,this.z);edt(gridInner,buffer,buffer,glyphWidth,glyphHeight,width,this.f,this.v,this.z);for(let i=0;i<len;i++){const d=Math.sqrt(gridOuter[i])-Math.sqrt(gridInner[i]);data[i]=Math.round(255-255*(d/this.radius+this.cutoff))}return glyph}}function edt(data,x0,y0,width,height,gridSize,f,v,z){for(let x=x0;x<x0+width;x++)edt1d(data,y0*gridSize+x,gridSize,height,f,v,z);for(let y=y0;y<y0+height;y++)edt1d(data,y*gridSize+x0,1,width,f,v,z)}function edt1d(grid,offset,stride,length,f,v,z){v[0]=0;z[0]=-INF;z[1]=INF;f[0]=grid[offset];for(let q=1,k=0,s=0;q<length;q++){f[q]=grid[offset+q*stride];const q2=q*q;do{const r=v[k];s=(f[q]-f[r]+q2-r*r)/(q-r)/2}while(s<=z[k]&&--k>-1);k++;v[k]=q;z[k]=s;z[k+1]=INF}for(let q=0,k=0;q<length;q++){while(z[k+1]<q)k++;const r=v[k];const qr=q-r;grid[offset+q*stride]=f[r]+qr*qr}}class GlyphManager{constructor(requestManager,localIdeographFontFamily){this.requestManager=requestManager;this.localIdeographFontFamily=localIdeographFontFamily;this.entries={}}setURL(url){this.url=url}getGlyphs(glyphs){return performance$1.__awaiter(this,void 0,void 0,(function*(){const glyphsPromises=[];for(const stack in glyphs){for(const id of glyphs[stack]){glyphsPromises.push(this._getAndCacheGlyphsPromise(stack,id))}}const updatedGlyphs=yield Promise.all(glyphsPromises);const result={};for(const{stack:stack,id:id,glyph:glyph}of updatedGlyphs){if(!result[stack]){result[stack]={}}result[stack][id]=glyph&&{id:glyph.id,bitmap:glyph.bitmap.clone(),metrics:glyph.metrics}}return result}))}_getAndCacheGlyphsPromise(stack,id){return performance$1.__awaiter(this,void 0,void 0,(function*(){let entry=this.entries[stack];if(!entry){entry=this.entries[stack]={glyphs:{},requests:{},ranges:{}}}let glyph=entry.glyphs[id];if(glyph!==undefined){return{stack:stack,id:id,glyph:glyph}}glyph=this._tinySDF(entry,stack,id);if(glyph){entry.glyphs[id]=glyph;return{stack:stack,id:id,glyph:glyph}}const range=Math.floor(id/256);if(range*256>65535){throw new Error("glyphs > 65535 not supported")}if(entry.ranges[range]){return{stack:stack,id:id,glyph:glyph}}if(!this.url){throw new Error("glyphsUrl is not set")}if(!entry.requests[range]){const promise=GlyphManager.loadGlyphRange(stack,range,this.url,this.requestManager);entry.requests[range]=promise}const response=yield entry.requests[range];for(const id in response){if(!this._doesCharSupportLocalGlyph(+id)){entry.glyphs[+id]=response[+id]}}entry.ranges[range]=true;return{stack:stack,id:id,glyph:response[id]||null}}))}_doesCharSupportLocalGlyph(id){return!!this.localIdeographFontFamily&&(performance$1.unicodeBlockLookup["CJK Unified Ideographs"](id)||performance$1.unicodeBlockLookup["Hangul Syllables"](id)||performance$1.unicodeBlockLookup["Hiragana"](id)||performance$1.unicodeBlockLookup["Katakana"](id))}_tinySDF(entry,stack,id){const fontFamily=this.localIdeographFontFamily;if(!fontFamily){return}if(!this._doesCharSupportLocalGlyph(id)){return}const textureScale=2;let tinySDF=entry.tinySDF;if(!tinySDF){let fontWeight="400";if(/bold/i.test(stack)){fontWeight="900"}else if(/medium/i.test(stack)){fontWeight="500"}else if(/light/i.test(stack)){fontWeight="200"}tinySDF=entry.tinySDF=new GlyphManager.TinySDF({fontSize:24*textureScale,buffer:3*textureScale,radius:8*textureScale,cutoff:.25,fontFamily:fontFamily,fontWeight:fontWeight})}const char=tinySDF.draw(String.fromCharCode(id));const topAdjustment=27.5;const leftAdjustment=.5;return{id:id,bitmap:new performance$1.AlphaImage({width:char.width||30*textureScale,height:char.height||30*textureScale},char.data),metrics:{width:char.glyphWidth/textureScale||24,height:char.glyphHeight/textureScale||24,left:char.glyphLeft/textureScale+leftAdjustment||0,top:char.glyphTop/textureScale-topAdjustment||-8,advance:char.glyphAdvance/textureScale||24,isDoubleResolution:true}}}}GlyphManager.loadGlyphRange=loadGlyphRange;GlyphManager.TinySDF=TinySDF;class LightPositionProperty{constructor(){this.specification=performance$1.v8Spec.light.position}possiblyEvaluate(value,parameters){return performance$1.sphericalToCartesian(value.expression.evaluate(parameters))}interpolate(a,b,t){return{x:performance$1.interpolate.number(a.x,b.x,t),y:performance$1.interpolate.number(a.y,b.y,t),z:performance$1.interpolate.number(a.z,b.z,t)}}}const TRANSITION_SUFFIX="-transition";let lightProperties;class Light extends performance$1.Evented{constructor(lightOptions){super();lightProperties=lightProperties||new performance$1.Properties({anchor:new performance$1.DataConstantProperty(performance$1.v8Spec.light.anchor),position:new LightPositionProperty,color:new performance$1.DataConstantProperty(performance$1.v8Spec.light.color),intensity:new performance$1.DataConstantProperty(performance$1.v8Spec.light.intensity)});this._transitionable=new performance$1.Transitionable(lightProperties);this.setLight(lightOptions);this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(light,options={}){if(this._validate(performance$1.validateLight,light,options)){return}for(const name in light){const value=light[name];if(name.endsWith(TRANSITION_SUFFIX)){this._transitionable.setTransition(name.slice(0,-TRANSITION_SUFFIX.length),value)}else{this._transitionable.setValue(name,value)}}}updateTransitions(parameters){this._transitioning=this._transitionable.transitioned(parameters,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(parameters){this.properties=this._transitioning.possiblyEvaluate(parameters)}_validate(validate,value,options){if(options&&options.validate===false){return false}return performance$1.emitValidationErrors(this,validate.call(performance$1.validateStyle,{value:value,style:{glyphs:true,sprite:true},styleSpec:performance$1.v8Spec}))}}class LineAtlas{constructor(width,height){this.width=width;this.height=height;this.nextRow=0;this.data=new Uint8Array(this.width*this.height);this.dashEntry={}}getDash(dasharray,round){const key=dasharray.join(",")+String(round);if(!this.dashEntry[key]){this.dashEntry[key]=this.addDash(dasharray,round)}return this.dashEntry[key]}getDashRanges(dasharray,lineAtlasWidth,stretch){const oddDashArray=dasharray.length%2===1;const ranges=[];let left=oddDashArray?-dasharray[dasharray.length-1]*stretch:0;let right=dasharray[0]*stretch;let isDash=true;ranges.push({left:left,right:right,isDash:isDash,zeroLength:dasharray[0]===0});let currentDashLength=dasharray[0];for(let i=1;i<dasharray.length;i++){isDash=!isDash;const dashLength=dasharray[i];left=currentDashLength*stretch;currentDashLength+=dashLength;right=currentDashLength*stretch;ranges.push({left:left,right:right,isDash:isDash,zeroLength:dashLength===0})}return ranges}addRoundDash(ranges,stretch,n){const halfStretch=stretch/2;for(let y=-n;y<=n;y++){const row=this.nextRow+n+y;const index=this.width*row;let currIndex=0;let range=ranges[currIndex];for(let x=0;x<this.width;x++){if(x/range.right>1){range=ranges[++currIndex]}const distLeft=Math.abs(x-range.left);const distRight=Math.abs(x-range.right);const minDist=Math.min(distLeft,distRight);let signedDistance;const distMiddle=y/n*(halfStretch+1);if(range.isDash){const distEdge=halfStretch-Math.abs(distMiddle);signedDistance=Math.sqrt(minDist*minDist+distEdge*distEdge)}else{signedDistance=halfStretch-Math.sqrt(minDist*minDist+distMiddle*distMiddle)}this.data[index+x]=Math.max(0,Math.min(255,signedDistance+128))}}}addRegularDash(ranges){for(let i=ranges.length-1;i>=0;--i){const part=ranges[i];const next=ranges[i+1];if(part.zeroLength){ranges.splice(i,1)}else if(next&&next.isDash===part.isDash){next.left=part.left;ranges.splice(i,1)}}const first=ranges[0];const last=ranges[ranges.length-1];if(first.isDash===last.isDash){first.left=last.left-this.width;last.right=first.right+this.width}const index=this.width*this.nextRow;let currIndex=0;let range=ranges[currIndex];for(let x=0;x<this.width;x++){if(x/range.right>1){range=ranges[++currIndex]}const distLeft=Math.abs(x-range.left);const distRight=Math.abs(x-range.right);const minDist=Math.min(distLeft,distRight);const signedDistance=range.isDash?minDist:-minDist;this.data[index+x]=Math.max(0,Math.min(255,signedDistance+128))}}addDash(dasharray,round){const n=round?7:0;const height=2*n+1;if(this.nextRow+height>this.height){performance$1.warnOnce("LineAtlas out of space");return null}let length=0;for(let i=0;i<dasharray.length;i++){length+=dasharray[i]}if(length!==0){const stretch=this.width/length;const ranges=this.getDashRanges(dasharray,this.width,stretch);if(round){this.addRoundDash(ranges,stretch,n)}else{this.addRegularDash(ranges)}}const dashEntry={y:(this.nextRow+n+.5)/this.height,height:2*n/this.height,width:length};this.nextRow+=height;this.dirty=true;return dashEntry}bind(context){const gl=context.gl;if(!this.texture){this.texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texImage2D(gl.TEXTURE_2D,0,gl.ALPHA,this.width,this.height,0,gl.ALPHA,gl.UNSIGNED_BYTE,this.data)}else{gl.bindTexture(gl.TEXTURE_2D,this.texture);if(this.dirty){this.dirty=false;gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,this.width,this.height,gl.ALPHA,gl.UNSIGNED_BYTE,this.data)}}}}function workerFactory(){return new Worker(performance$1.config.WORKER_URL)}const PRELOAD_POOL_ID="maplibre_preloaded_worker_pool";class WorkerPool{constructor(){this.active={}}acquire(mapId){if(!this.workers){this.workers=[];while(this.workers.length<WorkerPool.workerCount){this.workers.push(workerFactory())}}this.active[mapId]=true;return this.workers.slice()}release(mapId){delete this.active[mapId];if(this.numActive()===0){this.workers.forEach((w=>{w.terminate()}));this.workers=null}}isPreloaded(){return!!this.active[PRELOAD_POOL_ID]}numActive(){return Object.keys(this.active).length}}const availableLogicalProcessors=Math.floor(browser.hardwareConcurrency/2);WorkerPool.workerCount=performance$1.isSafari(globalThis)?Math.max(Math.min(availableLogicalProcessors,3),1):1;let globalWorkerPool;function getGlobalWorkerPool(){if(!globalWorkerPool){globalWorkerPool=new WorkerPool}return globalWorkerPool}function prewarm(){const workerPool=getGlobalWorkerPool();workerPool.acquire(PRELOAD_POOL_ID)}function clearPrewarmedResources(){const pool=globalWorkerPool;if(pool){if(pool.isPreloaded()&&pool.numActive()===1){pool.release(PRELOAD_POOL_ID);globalWorkerPool=null}else{console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()")}}}class Dispatcher{constructor(workerPool,mapId){this.workerPool=workerPool;this.actors=[];this.currentActor=0;this.id=mapId;const workers=this.workerPool.acquire(mapId);for(let i=0;i<workers.length;i++){const worker=workers[i];const actor=new performance$1.Actor(worker,mapId);actor.name=`Worker ${i}`;this.actors.push(actor)}if(!this.actors.length)throw new Error("No actors found")}broadcast(type,data){const promises=[];for(const actor of this.actors){promises.push(actor.sendAsync({type:type,data:data}))}return Promise.all(promises)}getActor(){this.currentActor=(this.currentActor+1)%this.actors.length;return this.actors[this.currentActor]}remove(mapRemoved=true){this.actors.forEach((actor=>{actor.remove()}));this.actors=[];if(mapRemoved)this.workerPool.release(this.id)}registerMessageHandler(type,handler){for(const actor of this.actors){actor.registerMessageHandler(type,handler)}}}let globalDispatcher;function getGlobalDispatcher(){if(!globalDispatcher){globalDispatcher=new Dispatcher(getGlobalWorkerPool(),performance$1.GLOBAL_DISPATCHER_ID);globalDispatcher.registerMessageHandler("getResource",((_mapId,params,abortController)=>performance$1.makeRequest(params,abortController)))}return globalDispatcher}function getPixelPosMatrix(transform,tileID){const t=performance$1.create();performance$1.translate(t,t,[1,1,0]);performance$1.scale(t,t,[transform.width*.5,transform.height*.5,1]);return performance$1.multiply(t,t,transform.calculatePosMatrix(tileID.toUnwrapped()))}function queryIncludes3DLayer(layers,styleLayers,sourceID){if(layers){for(const layerID of layers){const layer=styleLayers[layerID];if(layer&&layer.source===sourceID&&layer.type==="fill-extrusion"){return true}}}else{for(const key in styleLayers){const layer=styleLayers[key];if(layer.source===sourceID&&layer.type==="fill-extrusion"){return true}}}return false}function queryRenderedFeatures(sourceCache,styleLayers,serializedLayers,queryGeometry,params,transform){const has3DLayer=queryIncludes3DLayer(params&&params.layers,styleLayers,sourceCache.id);const maxPitchScaleFactor=transform.maxPitchScaleFactor();const tilesIn=sourceCache.tilesIn(queryGeometry,maxPitchScaleFactor,has3DLayer);tilesIn.sort(sortTilesIn);const renderedFeatureLayers=[];for(const tileIn of tilesIn){renderedFeatureLayers.push({wrappedTileID:tileIn.tileID.wrapped().key,queryResults:tileIn.tile.queryRenderedFeatures(styleLayers,serializedLayers,sourceCache._state,tileIn.queryGeometry,tileIn.cameraQueryGeometry,tileIn.scale,params,transform,maxPitchScaleFactor,getPixelPosMatrix(sourceCache.transform,tileIn.tileID))})}const result=mergeRenderedFeatureLayers(renderedFeatureLayers);for(const layerID in result){result[layerID].forEach((featureWrapper=>{const feature=featureWrapper.feature;const state=sourceCache.getFeatureState(feature.layer["source-layer"],feature.id);feature.source=feature.layer.source;if(feature.layer["source-layer"]){feature.sourceLayer=feature.layer["source-layer"]}feature.state=state}))}return result}function queryRenderedSymbols(styleLayers,serializedLayers,sourceCaches,queryGeometry,params,collisionIndex,retainedQueryData){const result={};const renderedSymbols=collisionIndex.queryRenderedSymbols(queryGeometry);const bucketQueryData=[];for(const bucketInstanceId of Object.keys(renderedSymbols).map(Number)){bucketQueryData.push(retainedQueryData[bucketInstanceId])}bucketQueryData.sort(sortTilesIn);for(const queryData of bucketQueryData){const bucketSymbols=queryData.featureIndex.lookupSymbolFeatures(renderedSymbols[queryData.bucketInstanceId],serializedLayers,queryData.bucketIndex,queryData.sourceLayerIndex,params.filter,params.layers,params.availableImages,styleLayers);for(const layerID in bucketSymbols){const resultFeatures=result[layerID]=result[layerID]||[];const layerSymbols=bucketSymbols[layerID];layerSymbols.sort(((a,b)=>{const featureSortOrder=queryData.featureSortOrder;if(featureSortOrder){const sortedA=featureSortOrder.indexOf(a.featureIndex);const sortedB=featureSortOrder.indexOf(b.featureIndex);return sortedB-sortedA}else{return b.featureIndex-a.featureIndex}}));for(const symbolFeature of layerSymbols){resultFeatures.push(symbolFeature)}}}for(const layerName in result){result[layerName].forEach((featureWrapper=>{const feature=featureWrapper.feature;const layer=styleLayers[layerName];const sourceCache=sourceCaches[layer.source];const state=sourceCache.getFeatureState(feature.layer["source-layer"],feature.id);feature.source=feature.layer.source;if(feature.layer["source-layer"]){feature.sourceLayer=feature.layer["source-layer"]}feature.state=state}))}return result}function querySourceFeatures(sourceCache,params){const tiles=sourceCache.getRenderableIds().map((id=>sourceCache.getTileByID(id)));const result=[];const dataTiles={};for(let i=0;i<tiles.length;i++){const tile=tiles[i];const dataID=tile.tileID.canonical.key;if(!dataTiles[dataID]){dataTiles[dataID]=true;tile.querySourceFeatures(result,params)}}return result}function sortTilesIn(a,b){const idA=a.tileID;const idB=b.tileID;return idA.overscaledZ-idB.overscaledZ||idA.canonical.y-idB.canonical.y||idA.wrap-idB.wrap||idA.canonical.x-idB.canonical.x}function mergeRenderedFeatureLayers(tiles){const result={};const wrappedIDLayerMap={};for(const tile of tiles){const queryResults=tile.queryResults;const wrappedID=tile.wrappedTileID;const wrappedIDLayers=wrappedIDLayerMap[wrappedID]=wrappedIDLayerMap[wrappedID]||{};for(const layerID in queryResults){const tileFeatures=queryResults[layerID];const wrappedIDFeatures=wrappedIDLayers[layerID]=wrappedIDLayers[layerID]||{};const resultFeatures=result[layerID]=result[layerID]||[];for(const tileFeature of tileFeatures){if(!wrappedIDFeatures[tileFeature.featureIndex]){wrappedIDFeatures[tileFeature.featureIndex]=true;resultFeatures.push(tileFeature)}}}}return result}function loadTileJson(options,requestManager,abortController){return performance$1.__awaiter(this,void 0,void 0,(function*(){let tileJSON=options;if(options.url){const response=yield performance$1.getJSON(requestManager.transformRequest(options.url,ResourceType.Source),abortController);tileJSON=response.data}else{yield browser.frameAsync(abortController)}if(!tileJSON){return null}const result=performance$1.pick(performance$1.extend(tileJSON,options),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);if("vector_layers"in tileJSON&&tileJSON.vector_layers){result.vectorLayerIds=tileJSON.vector_layers.map((layer=>layer.id))}return result}))}class LngLatBounds{constructor(sw,ne){if(!sw){}else if(ne){this.setSouthWest(sw).setNorthEast(ne)}else if(Array.isArray(sw)){if(sw.length===4){this.setSouthWest([sw[0],sw[1]]).setNorthEast([sw[2],sw[3]])}else{this.setSouthWest(sw[0]).setNorthEast(sw[1])}}}setNorthEast(ne){this._ne=ne instanceof performance$1.LngLat?new performance$1.LngLat(ne.lng,ne.lat):performance$1.LngLat.convert(ne);return this}setSouthWest(sw){this._sw=sw instanceof performance$1.LngLat?new performance$1.LngLat(sw.lng,sw.lat):performance$1.LngLat.convert(sw);return this}extend(obj){const sw=this._sw,ne=this._ne;let sw2,ne2;if(obj instanceof performance$1.LngLat){sw2=obj;ne2=obj}else if(obj instanceof LngLatBounds){sw2=obj._sw;ne2=obj._ne;if(!sw2||!ne2)return this}else{if(Array.isArray(obj)){if(obj.length===4||obj.every(Array.isArray)){const lngLatBoundsObj=obj;return this.extend(LngLatBounds.convert(lngLatBoundsObj))}else{const lngLatObj=obj;return this.extend(performance$1.LngLat.convert(lngLatObj))}}else if(obj&&("lng"in obj||"lon"in obj)&&"lat"in obj){return this.extend(performance$1.LngLat.convert(obj))}return this}if(!sw&&!ne){this._sw=new performance$1.LngLat(sw2.lng,sw2.lat);this._ne=new performance$1.LngLat(ne2.lng,ne2.lat)}else{sw.lng=Math.min(sw2.lng,sw.lng);sw.lat=Math.min(sw2.lat,sw.lat);ne.lng=Math.max(ne2.lng,ne.lng);ne.lat=Math.max(ne2.lat,ne.lat)}return this}getCenter(){return new performance$1.LngLat((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new performance$1.LngLat(this.getWest(),this.getNorth())}getSouthEast(){return new performance$1.LngLat(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(lnglat){const{lng:lng,lat:lat}=performance$1.LngLat.convert(lnglat);const containsLatitude=this._sw.lat<=lat&&lat<=this._ne.lat;let containsLongitude=this._sw.lng<=lng&&lng<=this._ne.lng;if(this._sw.lng>this._ne.lng){containsLongitude=this._sw.lng>=lng&&lng>=this._ne.lng}return containsLatitude&&containsLongitude}static convert(input){if(input instanceof LngLatBounds)return input;if(!input)return input;return new LngLatBounds(input)}static fromLngLat(center,radius=0){const earthCircumferenceInMetersAtEquator=40075017;const latAccuracy=360*radius/earthCircumferenceInMetersAtEquator,lngAccuracy=latAccuracy/Math.cos(Math.PI/180*center.lat);return new LngLatBounds(new performance$1.LngLat(center.lng-lngAccuracy,center.lat-latAccuracy),new performance$1.LngLat(center.lng+lngAccuracy,center.lat+latAccuracy))}}class TileBounds{constructor(bounds,minzoom,maxzoom){this.bounds=LngLatBounds.convert(this.validateBounds(bounds));this.minzoom=minzoom||0;this.maxzoom=maxzoom||24}validateBounds(bounds){if(!Array.isArray(bounds)||bounds.length!==4)return[-180,-90,180,90];return[Math.max(-180,bounds[0]),Math.max(-90,bounds[1]),Math.min(180,bounds[2]),Math.min(90,bounds[3])]}contains(tileID){const worldSize=Math.pow(2,tileID.z);const level={minX:Math.floor(performance$1.mercatorXfromLng(this.bounds.getWest())*worldSize),minY:Math.floor(performance$1.mercatorYfromLat(this.bounds.getNorth())*worldSize),maxX:Math.ceil(performance$1.mercatorXfromLng(this.bounds.getEast())*worldSize),maxY:Math.ceil(performance$1.mercatorYfromLat(this.bounds.getSouth())*worldSize)};const hit=tileID.x>=level.minX&&tileID.x<level.maxX&&tileID.y>=level.minY&&tileID.y<level.maxY;return hit}}class VectorTileSource extends performance$1.Evented{constructor(id,options,dispatcher,eventedParent){super();this.id=id;this.dispatcher=dispatcher;this.type="vector";this.minzoom=0;this.maxzoom=22;this.scheme="xyz";this.tileSize=512;this.reparseOverscaled=true;this.isTileClipped=true;this._loaded=false;performance$1.extend(this,performance$1.pick(options,["url","scheme","tileSize","promoteId"]));this._options=performance$1.extend({type:"vector"},options);this._collectResourceTiming=options.collectResourceTiming;if(this.tileSize!==512){throw new Error("vector tile sources must have a tileSize of 512")}this.setEventedParent(eventedParent)}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=false;this.fire(new performance$1.Event("dataloading",{dataType:"source"}));this._tileJSONRequest=new AbortController;try{const tileJSON=yield loadTileJson(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null;this._loaded=true;this.map.style.sourceCaches[this.id].clearTiles();if(tileJSON){performance$1.extend(this,tileJSON);if(tileJSON.bounds)this.tileBounds=new TileBounds(tileJSON.bounds,this.minzoom,this.maxzoom);this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"metadata"}));this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"content"}))}}catch(err){this._tileJSONRequest=null;this.fire(new performance$1.ErrorEvent(err))}}))}loaded(){return this._loaded}hasTile(tileID){return!this.tileBounds||this.tileBounds.contains(tileID.canonical)}onAdd(map){this.map=map;this.load()}setSourceProperty(callback){if(this._tileJSONRequest){this._tileJSONRequest.abort()}callback();this.load()}setTiles(tiles){this.setSourceProperty((()=>{this._options.tiles=tiles}));return this}setUrl(url){this.setSourceProperty((()=>{this.url=url;this._options.url=url}));return this}onRemove(){if(this._tileJSONRequest){this._tileJSONRequest.abort();this._tileJSONRequest=null}}serialize(){return performance$1.extend({},this._options)}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){const url=tile.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);const params={request:this.map._requestManager.transformRequest(url,ResourceType.Tile),uid:tile.uid,tileID:tile.tileID,zoom:tile.tileID.overscaledZ,tileSize:this.tileSize*tile.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};params.request.collectResourceTiming=this._collectResourceTiming;let messageType="reloadTile";if(!tile.actor||tile.state==="expired"){tile.actor=this.dispatcher.getActor();messageType="loadTile"}else if(tile.state==="loading"){return new Promise(((resolve,reject)=>{tile.reloadPromise={resolve:resolve,reject:reject}}))}tile.abortController=new AbortController;try{const data=yield tile.actor.sendAsync({type:messageType,data:params},tile.abortController);delete tile.abortController;if(tile.aborted){return}this._afterTileLoadWorkerResponse(tile,data)}catch(err){delete tile.abortController;if(tile.aborted){return}if(err&&err.status!==404){throw err}this._afterTileLoadWorkerResponse(tile,null)}}))}_afterTileLoadWorkerResponse(tile,data){if(data&&data.resourceTiming){tile.resourceTiming=data.resourceTiming}if(data&&this.map._refreshExpiredTiles){tile.setExpiryData(data)}tile.loadVectorData(data,this.map.painter);if(tile.reloadPromise){const reloadPromise=tile.reloadPromise;tile.reloadPromise=null;this.loadTile(tile).then(reloadPromise.resolve).catch(reloadPromise.reject)}}abortTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(tile.abortController){tile.abortController.abort();delete tile.abortController}if(tile.actor){yield tile.actor.sendAsync({type:"abortTile",data:{uid:tile.uid,type:this.type,source:this.id}})}}))}unloadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){tile.unloadVectorData();if(tile.actor){yield tile.actor.sendAsync({type:"removeTile",data:{uid:tile.uid,type:this.type,source:this.id}})}}))}hasTransition(){return false}}class RasterTileSource extends performance$1.Evented{constructor(id,options,dispatcher,eventedParent){super();this.id=id;this.dispatcher=dispatcher;this.setEventedParent(eventedParent);this.type="raster";this.minzoom=0;this.maxzoom=22;this.roundZoom=true;this.scheme="xyz";this.tileSize=512;this._loaded=false;this._options=performance$1.extend({type:"raster"},options);performance$1.extend(this,performance$1.pick(options,["url","scheme","tileSize"]))}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=false;this.fire(new performance$1.Event("dataloading",{dataType:"source"}));this._tileJSONRequest=new AbortController;try{const tileJSON=yield loadTileJson(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null;this._loaded=true;if(tileJSON){performance$1.extend(this,tileJSON);if(tileJSON.bounds)this.tileBounds=new TileBounds(tileJSON.bounds,this.minzoom,this.maxzoom);this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"metadata"}));this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"content"}))}}catch(err){this._tileJSONRequest=null;this.fire(new performance$1.ErrorEvent(err))}}))}loaded(){return this._loaded}onAdd(map){this.map=map;this.load()}onRemove(){if(this._tileJSONRequest){this._tileJSONRequest.abort();this._tileJSONRequest=null}}setSourceProperty(callback){if(this._tileJSONRequest){this._tileJSONRequest.abort();this._tileJSONRequest=null}callback();this.load()}setTiles(tiles){this.setSourceProperty((()=>{this._options.tiles=tiles}));return this}setUrl(url){this.setSourceProperty((()=>{this.url=url;this._options.url=url}));return this}serialize(){return performance$1.extend({},this._options)}hasTile(tileID){return!this.tileBounds||this.tileBounds.contains(tileID.canonical)}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){const url=tile.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);tile.abortController=new AbortController;try{const response=yield ImageRequest.getImage(this.map._requestManager.transformRequest(url,ResourceType.Tile),tile.abortController,this.map._refreshExpiredTiles);delete tile.abortController;if(tile.aborted){tile.state="unloaded";return}if(response&&response.data){if(this.map._refreshExpiredTiles&&response.cacheControl&&response.expires){tile.setExpiryData({cacheControl:response.cacheControl,expires:response.expires})}const context=this.map.painter.context;const gl=context.gl;const img=response.data;tile.texture=this.map.painter.getTileTexture(img.width);if(tile.texture){tile.texture.update(img,{useMipmap:true})}else{tile.texture=new Texture(context,img,gl.RGBA,{useMipmap:true});tile.texture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST);if(context.extTextureFilterAnisotropic){gl.texParameterf(gl.TEXTURE_2D,context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,context.extTextureFilterAnisotropicMax)}}tile.state="loaded"}}catch(err){delete tile.abortController;if(tile.aborted){tile.state="unloaded"}else if(err){tile.state="errored";throw err}}}))}abortTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(tile.abortController){tile.abortController.abort();delete tile.abortController}}))}unloadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(tile.texture){this.map.painter.saveTileTexture(tile.texture)}}))}hasTransition(){return false}}class RasterDEMTileSource extends RasterTileSource{constructor(id,options,dispatcher,eventedParent){super(id,options,dispatcher,eventedParent);this.type="raster-dem";this.maxzoom=22;this._options=performance$1.extend({type:"raster-dem"},options);this.encoding=options.encoding||"mapbox";this.redFactor=options.redFactor;this.greenFactor=options.greenFactor;this.blueFactor=options.blueFactor;this.baseShift=options.baseShift}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){const url=tile.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);const request=this.map._requestManager.transformRequest(url,ResourceType.Tile);tile.neighboringTiles=this._getNeighboringTiles(tile.tileID);tile.abortController=new AbortController;try{const response=yield ImageRequest.getImage(request,tile.abortController,this.map._refreshExpiredTiles);delete tile.abortController;if(tile.aborted){tile.state="unloaded";return}if(response&&response.data){const img=response.data;if(this.map._refreshExpiredTiles&&response.cacheControl&&response.expires){tile.setExpiryData({cacheControl:response.cacheControl,expires:response.expires})}const transfer=performance$1.isImageBitmap(img)&&performance$1.offscreenCanvasSupported();const rawImageData=transfer?img:yield this.readImageNow(img);const params={type:this.type,uid:tile.uid,source:this.id,rawImageData:rawImageData,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!tile.actor||tile.state==="expired"){tile.actor=this.dispatcher.getActor();const data=yield tile.actor.sendAsync({type:"loadDEMTile",data:params});tile.dem=data;tile.needsHillshadePrepare=true;tile.needsTerrainPrepare=true;tile.state="loaded"}}}catch(err){delete tile.abortController;if(tile.aborted){tile.state="unloaded"}else if(err){tile.state="errored";throw err}}}))}readImageNow(img){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(typeof VideoFrame!=="undefined"&&performance$1.isOffscreenCanvasDistorted()){const width=img.width+2;const height=img.height+2;try{return new performance$1.RGBAImage({width:width,height:height},yield performance$1.readImageUsingVideoFrame(img,-1,-1,width,height))}catch(e){}}return browser.getImageData(img,1)}))}_getNeighboringTiles(tileID){const canonical=tileID.canonical;const dim=Math.pow(2,canonical.z);const px=(canonical.x-1+dim)%dim;const pxw=canonical.x===0?tileID.wrap-1:tileID.wrap;const nx=(canonical.x+1+dim)%dim;const nxw=canonical.x+1===dim?tileID.wrap+1:tileID.wrap;const neighboringTiles={};neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,pxw,canonical.z,px,canonical.y).key]={backfilled:false};neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,nxw,canonical.z,nx,canonical.y).key]={backfilled:false};if(canonical.y>0){neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,pxw,canonical.z,px,canonical.y-1).key]={backfilled:false};neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,tileID.wrap,canonical.z,canonical.x,canonical.y-1).key]={backfilled:false};neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,nxw,canonical.z,nx,canonical.y-1).key]={backfilled:false}}if(canonical.y+1<dim){neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,pxw,canonical.z,px,canonical.y+1).key]={backfilled:false};neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,tileID.wrap,canonical.z,canonical.x,canonical.y+1).key]={backfilled:false};neighboringTiles[new performance$1.OverscaledTileID(tileID.overscaledZ,nxw,canonical.z,nx,canonical.y+1).key]={backfilled:false}}return neighboringTiles}unloadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(tile.demTexture)this.map.painter.saveTileTexture(tile.demTexture);if(tile.fbo){tile.fbo.destroy();delete tile.fbo}if(tile.dem)delete tile.dem;delete tile.neighboringTiles;tile.state="unloaded";if(tile.actor){yield tile.actor.sendAsync({type:"removeDEMTile",data:{type:this.type,uid:tile.uid,source:this.id}})}}))}}class GeoJSONSource extends performance$1.Evented{constructor(id,options,dispatcher,eventedParent){super();this.id=id;this.type="geojson";this.minzoom=0;this.maxzoom=18;this.tileSize=512;this.isTileClipped=true;this.reparseOverscaled=true;this._removed=false;this._pendingLoads=0;this.actor=dispatcher.getActor();this.setEventedParent(eventedParent);this._data=options.data;this._options=performance$1.extend({},options);this._collectResourceTiming=options.collectResourceTiming;if(options.maxzoom!==undefined)this.maxzoom=options.maxzoom;if(options.type)this.type=options.type;if(options.attribution)this.attribution=options.attribution;this.promoteId=options.promoteId;const scale=performance$1.EXTENT/this.tileSize;this.workerOptions=performance$1.extend({source:this.id,cluster:options.cluster||false,geojsonVtOptions:{buffer:(options.buffer!==undefined?options.buffer:128)*scale,tolerance:(options.tolerance!==undefined?options.tolerance:.375)*scale,extent:performance$1.EXTENT,maxZoom:this.maxzoom,lineMetrics:options.lineMetrics||false,generateId:options.generateId||false},superclusterOptions:{maxZoom:options.clusterMaxZoom!==undefined?options.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,options.clusterMinPoints||2),extent:performance$1.EXTENT,radius:(options.clusterRadius||50)*scale,log:false,generateId:options.generateId||false},clusterProperties:options.clusterProperties,filter:options.filter},options.workerOptions);if(typeof this.promoteId==="string"){this.workerOptions.promoteId=this.promoteId}}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){yield this._updateWorkerData()}))}onAdd(map){this.map=map;this.load()}setData(data){this._data=data;this._updateWorkerData();return this}updateData(diff){this._updateWorkerData(diff);return this}setClusterOptions(options){this.workerOptions.cluster=options.cluster;if(options){if(options.clusterRadius!==undefined)this.workerOptions.superclusterOptions.radius=options.clusterRadius;if(options.clusterMaxZoom!==undefined)this.workerOptions.superclusterOptions.maxZoom=options.clusterMaxZoom}this._updateWorkerData();return this}getClusterExpansionZoom(clusterId){return this.actor.sendAsync({type:"getClusterExpansionZoom",data:{type:this.type,clusterId:clusterId,source:this.id}})}getClusterChildren(clusterId){return this.actor.sendAsync({type:"getClusterChildren",data:{type:this.type,clusterId:clusterId,source:this.id}})}getClusterLeaves(clusterId,limit,offset){return this.actor.sendAsync({type:"getClusterLeaves",data:{type:this.type,source:this.id,clusterId:clusterId,limit:limit,offset:offset}})}_updateWorkerData(diff){return performance$1.__awaiter(this,void 0,void 0,(function*(){const options=performance$1.extend({type:this.type},this.workerOptions);if(diff){options.dataDiff=diff}else if(typeof this._data==="string"){options.request=this.map._requestManager.transformRequest(browser.resolveURL(this._data),ResourceType.Source);options.request.collectResourceTiming=this._collectResourceTiming}else{options.data=JSON.stringify(this._data)}this._pendingLoads++;this.fire(new performance$1.Event("dataloading",{dataType:"source"}));try{const result=yield this.actor.sendAsync({type:"loadData",data:options});this._pendingLoads--;if(this._removed||result.abandoned){this.fire(new performance$1.Event("dataabort",{dataType:"source"}));return}let resourceTiming=null;if(result.resourceTiming&&result.resourceTiming[this.id]){resourceTiming=result.resourceTiming[this.id].slice(0)}const data={dataType:"source"};if(this._collectResourceTiming&&resourceTiming&&resourceTiming.length>0){performance$1.extend(data,{resourceTiming:resourceTiming})}this.fire(new performance$1.Event("data",Object.assign(Object.assign({},data),{sourceDataType:"metadata"})));this.fire(new performance$1.Event("data",Object.assign(Object.assign({},data),{sourceDataType:"content"})))}catch(err){this._pendingLoads--;if(this._removed){this.fire(new performance$1.Event("dataabort",{dataType:"source"}));return}this.fire(new performance$1.ErrorEvent(err))}}))}loaded(){return this._pendingLoads===0}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){const message=!tile.actor?"loadTile":"reloadTile";tile.actor=this.actor;const params={type:this.type,uid:tile.uid,tileID:tile.tileID,zoom:tile.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId};tile.abortController=new AbortController;const data=yield this.actor.sendAsync({type:message,data:params},tile.abortController);delete tile.abortController;tile.unloadVectorData();if(!tile.aborted){tile.loadVectorData(data,this.map.painter,message==="reloadTile")}}))}abortTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(tile.abortController){tile.abortController.abort();delete tile.abortController}tile.aborted=true}))}unloadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){tile.unloadVectorData();yield this.actor.sendAsync({type:"removeTile",data:{uid:tile.uid,type:this.type,source:this.id}})}))}onRemove(){this._removed=true;this.actor.sendAsync({type:"removeSource",data:{type:this.type,source:this.id}})}serialize(){return performance$1.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return false}}var rasterBoundsAttributes=performance$1.createLayout([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class ImageSource extends performance$1.Evented{constructor(id,options,dispatcher,eventedParent){super();this.id=id;this.dispatcher=dispatcher;this.coordinates=options.coordinates;this.type="image";this.minzoom=0;this.maxzoom=22;this.tileSize=512;this.tiles={};this._loaded=false;this.setEventedParent(eventedParent);this.options=options}load(newCoordinates){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=false;this.fire(new performance$1.Event("dataloading",{dataType:"source"}));this.url=this.options.url;this._request=new AbortController;try{const image=yield ImageRequest.getImage(this.map._requestManager.transformRequest(this.url,ResourceType.Image),this._request);this._request=null;this._loaded=true;if(image&&image.data){this.image=image.data;if(newCoordinates){this.coordinates=newCoordinates}this._finishLoading()}}catch(err){this._request=null;this.fire(new performance$1.ErrorEvent(err))}}))}loaded(){return this._loaded}updateImage(options){if(!options.url){return this}if(this._request){this._request.abort();this._request=null}this.options.url=options.url;this.load(options.coordinates).finally((()=>{this.texture=null}));return this}_finishLoading(){if(this.map){this.setCoordinates(this.coordinates);this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"metadata"}))}}onAdd(map){this.map=map;this.load()}onRemove(){if(this._request){this._request.abort();this._request=null}}setCoordinates(coordinates){this.coordinates=coordinates;const cornerCoords=coordinates.map(performance$1.MercatorCoordinate.fromLngLat);this.tileID=getCoordinatesCenterTileID(cornerCoords);this.minzoom=this.maxzoom=this.tileID.z;const tileCoords=cornerCoords.map((coord=>this.tileID.getTilePoint(coord)._round()));this._boundsArray=new performance$1.RasterBoundsArray;this._boundsArray.emplaceBack(tileCoords[0].x,tileCoords[0].y,0,0);this._boundsArray.emplaceBack(tileCoords[1].x,tileCoords[1].y,performance$1.EXTENT,0);this._boundsArray.emplaceBack(tileCoords[3].x,tileCoords[3].y,0,performance$1.EXTENT);this._boundsArray.emplaceBack(tileCoords[2].x,tileCoords[2].y,performance$1.EXTENT,performance$1.EXTENT);if(this.boundsBuffer){this.boundsBuffer.destroy();delete this.boundsBuffer}this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"content"}));return this}prepare(){if(Object.keys(this.tiles).length===0||!this.image){return}const context=this.map.painter.context;const gl=context.gl;if(!this.boundsBuffer){this.boundsBuffer=context.createVertexBuffer(this._boundsArray,rasterBoundsAttributes.members)}if(!this.boundsSegments){this.boundsSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2)}if(!this.texture){this.texture=new Texture(context,this.image,gl.RGBA);this.texture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE)}let newTilesLoaded=false;for(const w in this.tiles){const tile=this.tiles[w];if(tile.state!=="loaded"){tile.state="loaded";tile.texture=this.texture;newTilesLoaded=true}}if(newTilesLoaded){this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}}loadTile(tile){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(this.tileID&&this.tileID.equals(tile.tileID.canonical)){this.tiles[String(tile.tileID.wrap)]=tile;tile.buckets={}}else{tile.state="errored"}}))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return false}}function getCoordinatesCenterTileID(coords){let minX=Infinity;let minY=Infinity;let maxX=-Infinity;let maxY=-Infinity;for(const coord of coords){minX=Math.min(minX,coord.x);minY=Math.min(minY,coord.y);maxX=Math.max(maxX,coord.x);maxY=Math.max(maxY,coord.y)}const dx=maxX-minX;const dy=maxY-minY;const dMax=Math.max(dx,dy);const zoom=Math.max(0,Math.floor(-Math.log(dMax)/Math.LN2));const tilesAtZoom=Math.pow(2,zoom);return new performance$1.CanonicalTileID(zoom,Math.floor((minX+maxX)/2*tilesAtZoom),Math.floor((minY+maxY)/2*tilesAtZoom))}class VideoSource extends ImageSource{constructor(id,options,dispatcher,eventedParent){super(id,options,dispatcher,eventedParent);this.roundZoom=true;this.type="video";this.options=options}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=false;const options=this.options;this.urls=[];for(const url of options.urls){this.urls.push(this.map._requestManager.transformRequest(url,ResourceType.Source).url)}try{const video=yield performance$1.getVideo(this.urls);this._loaded=true;if(!video){return}this.video=video;this.video.loop=true;this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()}));if(this.map){this.video.play()}this._finishLoading()}catch(err){this.fire(new performance$1.ErrorEvent(err))}}))}pause(){if(this.video){this.video.pause()}}play(){if(this.video){this.video.play()}}seek(seconds){if(this.video){const seekableRange=this.video.seekable;if(seconds<seekableRange.start(0)||seconds>seekableRange.end(0)){this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${seekableRange.start(0)} and ${seekableRange.end(0)}-second mark.`)))}else this.video.currentTime=seconds}}getVideo(){return this.video}onAdd(map){if(this.map)return;this.map=map;this.load();if(this.video){this.video.play();this.setCoordinates(this.coordinates)}}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2){return}const context=this.map.painter.context;const gl=context.gl;if(!this.boundsBuffer){this.boundsBuffer=context.createVertexBuffer(this._boundsArray,rasterBoundsAttributes.members)}if(!this.boundsSegments){this.boundsSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2)}if(!this.texture){this.texture=new Texture(context,this.video,gl.RGBA);this.texture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE)}else if(!this.video.paused){this.texture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,gl.RGBA,gl.UNSIGNED_BYTE,this.video)}let newTilesLoaded=false;for(const w in this.tiles){const tile=this.tiles[w];if(tile.state!=="loaded"){tile.state="loaded";tile.texture=this.texture;newTilesLoaded=true}}if(newTilesLoaded){this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class CanvasSource extends ImageSource{constructor(id,options,dispatcher,eventedParent){super(id,options,dispatcher,eventedParent);if(!options.coordinates){this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'missing required property "coordinates"')))}else if(!Array.isArray(options.coordinates)||options.coordinates.length!==4||options.coordinates.some((c=>!Array.isArray(c)||c.length!==2||c.some((l=>typeof l!=="number"))))){this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs')))}if(options.animate&&typeof options.animate!=="boolean"){this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'optional "animate" property must be a boolean value')))}if(!options.canvas){this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'missing required property "canvas"')))}else if(typeof options.canvas!=="string"&&!(options.canvas instanceof HTMLCanvasElement)){this.fire(new performance$1.ErrorEvent(new performance$1.ValidationError(`sources.${id}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance')))}this.options=options;this.animate=options.animate!==undefined?options.animate:true}load(){return performance$1.__awaiter(this,void 0,void 0,(function*(){this._loaded=true;if(!this.canvas){this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)}this.width=this.canvas.width;this.height=this.canvas.height;if(this._hasInvalidDimensions()){this.fire(new performance$1.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero.")));return}this.play=function(){this._playing=true;this.map.triggerRepaint()};this.pause=function(){if(this._playing){this.prepare();this._playing=false}};this._finishLoading()}))}getCanvas(){return this.canvas}onAdd(map){this.map=map;this.load();if(this.canvas){if(this.animate)this.play()}}onRemove(){this.pause()}prepare(){let resize=false;if(this.canvas.width!==this.width){this.width=this.canvas.width;resize=true}if(this.canvas.height!==this.height){this.height=this.canvas.height;resize=true}if(this._hasInvalidDimensions())return;if(Object.keys(this.tiles).length===0)return;const context=this.map.painter.context;const gl=context.gl;if(!this.boundsBuffer){this.boundsBuffer=context.createVertexBuffer(this._boundsArray,rasterBoundsAttributes.members)}if(!this.boundsSegments){this.boundsSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2)}if(!this.texture){this.texture=new Texture(context,this.canvas,gl.RGBA,{premultiply:true})}else if(resize||this._playing){this.texture.update(this.canvas,{premultiply:true})}let newTilesLoaded=false;for(const w in this.tiles){const tile=this.tiles[w];if(tile.state!=="loaded"){tile.state="loaded";tile.texture=this.texture;newTilesLoaded=true}}if(newTilesLoaded){this.fire(new performance$1.Event("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const x of[this.canvas.width,this.canvas.height]){if(isNaN(x)||x<=0)return true}return false}}const registeredSources={};const create=(id,specification,dispatcher,eventedParent)=>{const Class=getSourceType(specification.type);const source=new Class(id,specification,dispatcher,eventedParent);if(source.id!==id){throw new Error(`Expected Source id to be ${id} instead of ${source.id}`)}return source};const getSourceType=name=>{switch(name){case"geojson":return GeoJSONSource;case"image":return ImageSource;case"raster":return RasterTileSource;case"raster-dem":return RasterDEMTileSource;case"vector":return VectorTileSource;case"video":return VideoSource;case"canvas":return CanvasSource}return registeredSources[name]};const setSourceType=(name,type)=>{registeredSources[name]=type};const addSourceType=(name,SourceType)=>performance$1.__awaiter(void 0,void 0,void 0,(function*(){if(getSourceType(name)){throw new Error(`A source type called "${name}" already exists.`)}setSourceType(name,SourceType)}));function deserialize(input,style){const output={};if(!style)return output;for(const bucket of input){const layers=bucket.layerIds.map((id=>style.getLayer(id))).filter(Boolean);if(layers.length===0){continue}bucket.layers=layers;if(bucket.stateDependentLayerIds){bucket.stateDependentLayers=bucket.stateDependentLayerIds.map((lId=>layers.filter((l=>l.id===lId))[0]))}for(const layer of layers){output[layer.id]=bucket}}return output}class RTLMainThreadPlugin extends performance$1.Evented{constructor(){super(...arguments);this.pluginStatus="unavailable";this.pluginURL=null;this.dispatcher=getGlobalDispatcher();this.queue=[]}_sendPluginStateToWorker(){return performance$1.__awaiter(this,void 0,void 0,(function*(){yield this.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL});this.fire(new performance$1.Event("pluginStateChange",{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}))}))}getRTLTextPluginStatus(){return this.pluginStatus}clearRTLTextPlugin(){this.pluginStatus="unavailable";this.pluginURL=null}setRTLTextPlugin(url,deferred=false){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(this.pluginStatus==="deferred"||this.pluginStatus==="loading"||this.pluginStatus==="loaded"){throw new Error("setRTLTextPlugin cannot be called multiple times.")}this.pluginURL=browser.resolveURL(url);this.pluginStatus="deferred";yield this._sendPluginStateToWorker();if(!deferred){yield this._downloadRTLTextPlugin()}}))}_downloadRTLTextPlugin(){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(this.pluginStatus!=="deferred"||!this.pluginURL){throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified")}try{this.pluginStatus="loading";yield this._sendPluginStateToWorker();yield performance$1.getArrayBuffer({url:this.pluginURL},new AbortController);this.pluginStatus="loaded"}catch(_a){this.pluginStatus="error"}yield this._sendPluginStateToWorker()}))}lazyLoadRTLTextPlugin(){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(this.pluginStatus==="deferred"){yield this._downloadRTLTextPlugin()}}))}}let rtlMainThreadPlugin=null;function rtlMainThreadPluginFactory(){if(!rtlMainThreadPlugin){rtlMainThreadPlugin=new RTLMainThreadPlugin}return rtlMainThreadPlugin}const CLOCK_SKEW_RETRY_TIMEOUT=3e4;class Tile{constructor(tileID,size){this.timeAdded=0;this.fadeEndTime=0;this.tileID=tileID;this.uid=performance$1.uniqueId();this.uses=0;this.tileSize=size;this.buckets={};this.expirationTime=null;this.queryPadding=0;this.hasSymbolBuckets=false;this.hasRTLText=false;this.dependencies={};this.rtt=[];this.rttCoords={};this.expiredRequestCount=0;this.state="loading"}registerFadeDuration(duration){const fadeEndTime=duration+this.timeAdded;if(fadeEndTime<this.fadeEndTime){return}this.fadeEndTime=fadeEndTime}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(painter){if(this.demTexture)painter.saveTileTexture(this.demTexture);this.demTexture=null}loadVectorData(data,painter,justReloaded){if(this.hasData()){this.unloadVectorData()}this.state="loaded";if(!data){this.collisionBoxArray=new performance$1.CollisionBoxArray;return}if(data.featureIndex){this.latestFeatureIndex=data.featureIndex;if(data.rawTileData){this.latestRawTileData=data.rawTileData;this.latestFeatureIndex.rawTileData=data.rawTileData}else if(this.latestRawTileData){this.latestFeatureIndex.rawTileData=this.latestRawTileData}}this.collisionBoxArray=data.collisionBoxArray;this.buckets=deserialize(data.buckets,painter.style);this.hasSymbolBuckets=false;for(const id in this.buckets){const bucket=this.buckets[id];if(bucket instanceof performance$1.SymbolBucket){this.hasSymbolBuckets=true;if(justReloaded){bucket.justReloaded=true}else{break}}}this.hasRTLText=false;if(this.hasSymbolBuckets){for(const id in this.buckets){const bucket=this.buckets[id];if(bucket instanceof performance$1.SymbolBucket){if(bucket.hasRTLText){this.hasRTLText=true;rtlMainThreadPluginFactory().lazyLoadRTLTextPlugin();break}}}}this.queryPadding=0;for(const id in this.buckets){const bucket=this.buckets[id];this.queryPadding=Math.max(this.queryPadding,painter.style.getLayer(id).queryRadius(bucket))}if(data.imageAtlas){this.imageAtlas=data.imageAtlas}if(data.glyphAtlasImage){this.glyphAtlasImage=data.glyphAtlasImage}}unloadVectorData(){for(const id in this.buckets){this.buckets[id].destroy()}this.buckets={};if(this.imageAtlasTexture){this.imageAtlasTexture.destroy()}if(this.imageAtlas){this.imageAtlas=null}if(this.glyphAtlasTexture){this.glyphAtlasTexture.destroy()}this.latestFeatureIndex=null;this.state="unloaded"}getBucket(layer){return this.buckets[layer.id]}upload(context){for(const id in this.buckets){const bucket=this.buckets[id];if(bucket.uploadPending()){bucket.upload(context)}}const gl=context.gl;if(this.imageAtlas&&!this.imageAtlas.uploaded){this.imageAtlasTexture=new Texture(context,this.imageAtlas.image,gl.RGBA);this.imageAtlas.uploaded=true}if(this.glyphAtlasImage){this.glyphAtlasTexture=new Texture(context,this.glyphAtlasImage,gl.ALPHA);this.glyphAtlasImage=null}}prepare(imageManager){if(this.imageAtlas){this.imageAtlas.patchUpdatedImages(imageManager,this.imageAtlasTexture)}}queryRenderedFeatures(layers,serializedLayers,sourceFeatureState,queryGeometry,cameraQueryGeometry,scale,params,transform,maxPitchScaleFactor,pixelPosMatrix){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return{};return this.latestFeatureIndex.query({queryGeometry:queryGeometry,cameraQueryGeometry:cameraQueryGeometry,scale:scale,tileSize:this.tileSize,pixelPosMatrix:pixelPosMatrix,transform:transform,params:params,queryPadding:this.queryPadding*maxPitchScaleFactor},layers,serializedLayers,sourceFeatureState)}querySourceFeatures(result,params){const featureIndex=this.latestFeatureIndex;if(!featureIndex||!featureIndex.rawTileData)return;const vtLayers=featureIndex.loadVTLayers();const sourceLayer=params&&params.sourceLayer?params.sourceLayer:"";const layer=vtLayers._geojsonTileLayer||vtLayers[sourceLayer];if(!layer)return;const filter=performance$1.createFilter(params&&params.filter);const{z:z,x:x,y:y}=this.tileID.canonical;const coord={z:z,x:x,y:y};for(let i=0;i<layer.length;i++){const feature=layer.feature(i);if(filter.needGeometry){const evaluationFeature=performance$1.toEvaluationFeature(feature,true);if(!filter.filter(new performance$1.EvaluationParameters(this.tileID.overscaledZ),evaluationFeature,this.tileID.canonical))continue}else if(!filter.filter(new performance$1.EvaluationParameters(this.tileID.overscaledZ),feature)){continue}const id=featureIndex.getId(feature,sourceLayer);const geojsonFeature=new performance$1.GeoJSONFeature(feature,z,x,y,id);geojsonFeature.tile=coord;result.push(geojsonFeature)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(data){const prior=this.expirationTime;if(data.cacheControl){const parsedCC=performance$1.parseCacheControl(data.cacheControl);if(parsedCC["max-age"])this.expirationTime=Date.now()+parsedCC["max-age"]*1e3}else if(data.expires){this.expirationTime=new Date(data.expires).getTime()}if(this.expirationTime){const now=Date.now();let isExpired=false;if(this.expirationTime>now){isExpired=false}else if(!prior){isExpired=true}else if(this.expirationTime<prior){isExpired=true}else{const delta=this.expirationTime-prior;if(!delta){isExpired=true}else{this.expirationTime=now+Math.max(delta,CLOCK_SKEW_RETRY_TIMEOUT)}}if(isExpired){this.expiredRequestCount++;this.state="expired"}else{this.expiredRequestCount=0}}}getExpiryTimeout(){if(this.expirationTime){if(this.expiredRequestCount){return 1e3*(1<<Math.min(this.expiredRequestCount-1,31))}else{return Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}}}setFeatureState(states,painter){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(states).length===0){return}const vtLayers=this.latestFeatureIndex.loadVTLayers();for(const id in this.buckets){if(!painter.style.hasLayer(id))continue;const bucket=this.buckets[id];const sourceLayerId=bucket.layers[0]["sourceLayer"]||"_geojsonTileLayer";const sourceLayer=vtLayers[sourceLayerId];const sourceLayerStates=states[sourceLayerId];if(!sourceLayer||!sourceLayerStates||Object.keys(sourceLayerStates).length===0)continue;bucket.update(sourceLayerStates,sourceLayer,this.imageAtlas&&this.imageAtlas.patternPositions||{});const layer=painter&&painter.style&&painter.style.getLayer(id);if(layer){this.queryPadding=Math.max(this.queryPadding,layer.queryRadius(bucket))}}}holdingForFade(){return this.symbolFadeHoldUntil!==undefined}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<browser.now()}clearFadeHold(){this.symbolFadeHoldUntil=undefined}setHoldDuration(duration){this.symbolFadeHoldUntil=browser.now()+duration}setDependencies(namespace,dependencies){const index={};for(const dep of dependencies){index[dep]=true}this.dependencies[namespace]=index}hasDependency(namespaces,keys){for(const namespace of namespaces){const dependencies=this.dependencies[namespace];if(dependencies){for(const key of keys){if(dependencies[key]){return true}}}}return false}}class TileCache{constructor(max,onRemove){this.max=max;this.onRemove=onRemove;this.reset()}reset(){for(const key in this.data){for(const removedData of this.data[key]){if(removedData.timeout)clearTimeout(removedData.timeout);this.onRemove(removedData.value)}}this.data={};this.order=[];return this}add(tileID,data,expiryTimeout){const key=tileID.wrapped().key;if(this.data[key]===undefined){this.data[key]=[]}const dataWrapper={value:data,timeout:undefined};if(expiryTimeout!==undefined){dataWrapper.timeout=setTimeout((()=>{this.remove(tileID,dataWrapper)}),expiryTimeout)}this.data[key].push(dataWrapper);this.order.push(key);if(this.order.length>this.max){const removedData=this._getAndRemoveByKey(this.order[0]);if(removedData)this.onRemove(removedData)}return this}has(tileID){return tileID.wrapped().key in this.data}getAndRemove(tileID){if(!this.has(tileID)){return null}return this._getAndRemoveByKey(tileID.wrapped().key)}_getAndRemoveByKey(key){const data=this.data[key].shift();if(data.timeout)clearTimeout(data.timeout);if(this.data[key].length===0){delete this.data[key]}this.order.splice(this.order.indexOf(key),1);return data.value}getByKey(key){const data=this.data[key];return data?data[0].value:null}get(tileID){if(!this.has(tileID)){return null}const data=this.data[tileID.wrapped().key][0];return data.value}remove(tileID,value){if(!this.has(tileID)){return this}const key=tileID.wrapped().key;const dataIndex=value===undefined?0:this.data[key].indexOf(value);const data=this.data[key][dataIndex];this.data[key].splice(dataIndex,1);if(data.timeout)clearTimeout(data.timeout);if(this.data[key].length===0){delete this.data[key]}this.onRemove(data.value);this.order.splice(this.order.indexOf(key),1);return this}setMaxSize(max){this.max=max;while(this.order.length>this.max){const removedData=this._getAndRemoveByKey(this.order[0]);if(removedData)this.onRemove(removedData)}return this}filter(filterFn){const removed=[];for(const key in this.data){for(const entry of this.data[key]){if(!filterFn(entry.value)){removed.push(entry)}}}for(const r of removed){this.remove(r.value.tileID,r)}}}class SourceFeatureState{constructor(){this.state={};this.stateChanges={};this.deletedStates={}}updateState(sourceLayer,featureId,newState){const feature=String(featureId);this.stateChanges[sourceLayer]=this.stateChanges[sourceLayer]||{};this.stateChanges[sourceLayer][feature]=this.stateChanges[sourceLayer][feature]||{};performance$1.extend(this.stateChanges[sourceLayer][feature],newState);if(this.deletedStates[sourceLayer]===null){this.deletedStates[sourceLayer]={};for(const ft in this.state[sourceLayer]){if(ft!==feature)this.deletedStates[sourceLayer][ft]=null}}else{const featureDeletionQueued=this.deletedStates[sourceLayer]&&this.deletedStates[sourceLayer][feature]===null;if(featureDeletionQueued){this.deletedStates[sourceLayer][feature]={};for(const prop in this.state[sourceLayer][feature]){if(!newState[prop])this.deletedStates[sourceLayer][feature][prop]=null}}else{for(const key in newState){const deletionInQueue=this.deletedStates[sourceLayer]&&this.deletedStates[sourceLayer][feature]&&this.deletedStates[sourceLayer][feature][key]===null;if(deletionInQueue)delete this.deletedStates[sourceLayer][feature][key]}}}}removeFeatureState(sourceLayer,featureId,key){const sourceLayerDeleted=this.deletedStates[sourceLayer]===null;if(sourceLayerDeleted)return;const feature=String(featureId);this.deletedStates[sourceLayer]=this.deletedStates[sourceLayer]||{};if(key&&featureId!==undefined){if(this.deletedStates[sourceLayer][feature]!==null){this.deletedStates[sourceLayer][feature]=this.deletedStates[sourceLayer][feature]||{};this.deletedStates[sourceLayer][feature][key]=null}}else if(featureId!==undefined){const updateInQueue=this.stateChanges[sourceLayer]&&this.stateChanges[sourceLayer][feature];if(updateInQueue){this.deletedStates[sourceLayer][feature]={};for(key in this.stateChanges[sourceLayer][feature])this.deletedStates[sourceLayer][feature][key]=null}else{this.deletedStates[sourceLayer][feature]=null}}else{this.deletedStates[sourceLayer]=null}}getState(sourceLayer,featureId){const feature=String(featureId);const base=this.state[sourceLayer]||{};const changes=this.stateChanges[sourceLayer]||{};const reconciledState=performance$1.extend({},base[feature],changes[feature]);if(this.deletedStates[sourceLayer]===null)return{};else if(this.deletedStates[sourceLayer]){const featureDeletions=this.deletedStates[sourceLayer][featureId];if(featureDeletions===null)return{};for(const prop in featureDeletions)delete reconciledState[prop]}return reconciledState}initializeTileState(tile,painter){tile.setFeatureState(this.state,painter)}coalesceChanges(tiles,painter){const featuresChanged={};for(const sourceLayer in this.stateChanges){this.state[sourceLayer]=this.state[sourceLayer]||{};const layerStates={};for(const feature in this.stateChanges[sourceLayer]){if(!this.state[sourceLayer][feature])this.state[sourceLayer][feature]={};performance$1.extend(this.state[sourceLayer][feature],this.stateChanges[sourceLayer][feature]);layerStates[feature]=this.state[sourceLayer][feature]}featuresChanged[sourceLayer]=layerStates}for(const sourceLayer in this.deletedStates){this.state[sourceLayer]=this.state[sourceLayer]||{};const layerStates={};if(this.deletedStates[sourceLayer]===null){for(const ft in this.state[sourceLayer]){layerStates[ft]={};this.state[sourceLayer][ft]={}}}else{for(const feature in this.deletedStates[sourceLayer]){const deleteWholeFeatureState=this.deletedStates[sourceLayer][feature]===null;if(deleteWholeFeatureState)this.state[sourceLayer][feature]={};else{for(const key of Object.keys(this.deletedStates[sourceLayer][feature])){delete this.state[sourceLayer][feature][key]}}layerStates[feature]=this.state[sourceLayer][feature]}}featuresChanged[sourceLayer]=featuresChanged[sourceLayer]||{};performance$1.extend(featuresChanged[sourceLayer],layerStates)}this.stateChanges={};this.deletedStates={};if(Object.keys(featuresChanged).length===0)return;for(const id in tiles){const tile=tiles[id];tile.setFeatureState(featuresChanged,painter)}}}class SourceCache extends performance$1.Evented{constructor(id,options,dispatcher){super();this.id=id;this.dispatcher=dispatcher;this.on("data",(e=>{if(e.dataType==="source"&&e.sourceDataType==="metadata")this._sourceLoaded=true;if(this._sourceLoaded&&!this._paused&&e.dataType==="source"&&e.sourceDataType==="content"){this.reload();if(this.transform){this.update(this.transform,this.terrain)}this._didEmitContent=true}}));this.on("dataloading",(()=>{this._sourceErrored=false}));this.on("error",(()=>{this._sourceErrored=this._source.loaded()}));this._source=create(id,options,dispatcher,this);this._tiles={};this._cache=new TileCache(0,(tile=>this._unloadTile(tile)));this._timers={};this._cacheTimers={};this._maxTileCacheSize=null;this._maxTileCacheZoomLevels=null;this._loadedParentTiles={};this._coveredTiles={};this._state=new SourceFeatureState;this._didEmitContent=false;this._updated=false}onAdd(map){this.map=map;this._maxTileCacheSize=map?map._maxTileCacheSize:null;this._maxTileCacheZoomLevels=map?map._maxTileCacheZoomLevels:null;if(this._source&&this._source.onAdd){this._source.onAdd(map)}}onRemove(map){this.clearTiles();if(this._source&&this._source.onRemove){this._source.onRemove(map)}}loaded(){if(this._sourceErrored){return true}if(!this._sourceLoaded){return false}if(!this._source.loaded()){return false}if((this.used!==undefined||this.usedForTerrain!==undefined)&&!this.used&&!this.usedForTerrain){return true}if(!this._updated){return false}for(const t in this._tiles){const tile=this._tiles[t];if(tile.state!=="loaded"&&tile.state!=="errored")return false}return true}getSource(){return this._source}pause(){this._paused=true}resume(){if(!this._paused)return;const shouldReload=this._shouldReloadOnResume;this._paused=false;this._shouldReloadOnResume=false;if(shouldReload)this.reload();if(this.transform)this.update(this.transform,this.terrain)}_loadTile(tile,id,state){return performance$1.__awaiter(this,void 0,void 0,(function*(){try{yield this._source.loadTile(tile);this._tileLoaded(tile,id,state)}catch(err){tile.state="errored";if(err.status!==404){this._source.fire(new performance$1.ErrorEvent(err,{tile:tile}))}else{this.update(this.transform,this.terrain)}}}))}_unloadTile(tile){if(this._source.unloadTile)this._source.unloadTile(tile)}_abortTile(tile){if(this._source.abortTile)this._source.abortTile(tile);this._source.fire(new performance$1.Event("dataabort",{tile:tile,coord:tile.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(context){if(this._source.prepare){this._source.prepare()}this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const i in this._tiles){const tile=this._tiles[i];tile.upload(context);tile.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map((tile=>tile.tileID)).sort(compareTileId).map((id=>id.key))}getRenderableIds(symbolLayer){const renderables=[];for(const id in this._tiles){if(this._isIdRenderable(id,symbolLayer))renderables.push(this._tiles[id])}if(symbolLayer){return renderables.sort(((a_,b_)=>{const a=a_.tileID;const b=b_.tileID;const rotatedA=new performance$1.Point(a.canonical.x,a.canonical.y)._rotate(this.transform.angle);const rotatedB=new performance$1.Point(b.canonical.x,b.canonical.y)._rotate(this.transform.angle);return a.overscaledZ-b.overscaledZ||rotatedB.y-rotatedA.y||rotatedB.x-rotatedA.x})).map((tile=>tile.tileID.key))}return renderables.map((tile=>tile.tileID)).sort(compareTileId).map((id=>id.key))}hasRenderableParent(tileID){const parentTile=this.findLoadedParent(tileID,0);if(parentTile){return this._isIdRenderable(parentTile.tileID.key)}return false}_isIdRenderable(id,symbolLayer){return this._tiles[id]&&this._tiles[id].hasData()&&!this._coveredTiles[id]&&(symbolLayer||!this._tiles[id].holdingForFade())}reload(){if(this._paused){this._shouldReloadOnResume=true;return}this._cache.reset();for(const i in this._tiles){if(this._tiles[i].state!=="errored")this._reloadTile(i,"reloading")}}_reloadTile(id,state){return performance$1.__awaiter(this,void 0,void 0,(function*(){const tile=this._tiles[id];if(!tile)return;if(tile.state!=="loading"){tile.state=state}yield this._loadTile(tile,id,state)}))}_tileLoaded(tile,id,previousState){tile.timeAdded=browser.now();if(previousState==="expired")tile.refreshedUponExpiration=true;this._setTileReloadTimer(id,tile);if(this.getSource().type==="raster-dem"&&tile.dem)this._backfillDEM(tile);this._state.initializeTileState(tile,this.map?this.map.painter:null);if(!tile.aborted){this._source.fire(new performance$1.Event("data",{dataType:"source",tile:tile,coord:tile.tileID}))}}_backfillDEM(tile){const renderables=this.getRenderableIds();for(let i=0;i<renderables.length;i++){const borderId=renderables[i];if(tile.neighboringTiles&&tile.neighboringTiles[borderId]){const borderTile=this.getTileByID(borderId);fillBorder(tile,borderTile);fillBorder(borderTile,tile)}}function fillBorder(tile,borderTile){tile.needsHillshadePrepare=true;tile.needsTerrainPrepare=true;let dx=borderTile.tileID.canonical.x-tile.tileID.canonical.x;const dy=borderTile.tileID.canonical.y-tile.tileID.canonical.y;const dim=Math.pow(2,tile.tileID.canonical.z);const borderId=borderTile.tileID.key;if(dx===0&&dy===0)return;if(Math.abs(dy)>1){return}if(Math.abs(dx)>1){if(Math.abs(dx+dim)===1){dx+=dim}else if(Math.abs(dx-dim)===1){dx-=dim}}if(!borderTile.dem||!tile.dem)return;tile.dem.backfillBorder(borderTile.dem,dx,dy);if(tile.neighboringTiles&&tile.neighboringTiles[borderId])tile.neighboringTiles[borderId].backfilled=true}}getTile(tileID){return this.getTileByID(tileID.key)}getTileByID(id){return this._tiles[id]}_retainLoadedChildren(idealTiles,zoom,maxCoveringZoom,retain){for(const id in this._tiles){let tile=this._tiles[id];if(retain[id]||!tile.hasData()||tile.tileID.overscaledZ<=zoom||tile.tileID.overscaledZ>maxCoveringZoom)continue;let topmostLoadedID=tile.tileID;while(tile&&tile.tileID.overscaledZ>zoom+1){const parentID=tile.tileID.scaledTo(tile.tileID.overscaledZ-1);tile=this._tiles[parentID.key];if(tile&&tile.hasData()){topmostLoadedID=parentID}}let tileID=topmostLoadedID;while(tileID.overscaledZ>zoom){tileID=tileID.scaledTo(tileID.overscaledZ-1);if(idealTiles[tileID.key]){retain[topmostLoadedID.key]=topmostLoadedID;break}}}}findLoadedParent(tileID,minCoveringZoom){if(tileID.key in this._loadedParentTiles){const parent=this._loadedParentTiles[tileID.key];if(parent&&parent.tileID.overscaledZ>=minCoveringZoom){return parent}else{return null}}for(let z=tileID.overscaledZ-1;z>=minCoveringZoom;z--){const parentTileID=tileID.scaledTo(z);const tile=this._getLoadedTile(parentTileID);if(tile){return tile}}}_getLoadedTile(tileID){const tile=this._tiles[tileID.key];if(tile&&tile.hasData()){return tile}const cachedTile=this._cache.getByKey(tileID.wrapped().key);return cachedTile}updateCacheSize(transform){const widthInTiles=Math.ceil(transform.width/this._source.tileSize)+1;const heightInTiles=Math.ceil(transform.height/this._source.tileSize)+1;const approxTilesInView=widthInTiles*heightInTiles;const commonZoomRange=this._maxTileCacheZoomLevels===null?performance$1.config.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels;const viewDependentMaxSize=Math.floor(approxTilesInView*commonZoomRange);const maxSize=typeof this._maxTileCacheSize==="number"?Math.min(this._maxTileCacheSize,viewDependentMaxSize):viewDependentMaxSize;this._cache.setMaxSize(maxSize)}handleWrapJump(lng){const prevLng=this._prevLng===undefined?lng:this._prevLng;const lngDifference=lng-prevLng;const worldDifference=lngDifference/360;const wrapDelta=Math.round(worldDifference);this._prevLng=lng;if(wrapDelta){const tiles={};for(const key in this._tiles){const tile=this._tiles[key];tile.tileID=tile.tileID.unwrapTo(tile.tileID.wrap+wrapDelta);tiles[tile.tileID.key]=tile}this._tiles=tiles;for(const id in this._timers){clearTimeout(this._timers[id]);delete this._timers[id]}for(const id in this._tiles){const tile=this._tiles[id];this._setTileReloadTimer(id,tile)}}}update(transform,terrain){this.transform=transform;this.terrain=terrain;if(!this._sourceLoaded||this._paused){return}this.updateCacheSize(transform);this.handleWrapJump(this.transform.center.lng);this._coveredTiles={};let idealTileIDs;if(!this.used&&!this.usedForTerrain){idealTileIDs=[]}else if(this._source.tileID){idealTileIDs=transform.getVisibleUnwrappedCoordinates(this._source.tileID).map((unwrapped=>new performance$1.OverscaledTileID(unwrapped.canonical.z,unwrapped.wrap,unwrapped.canonical.z,unwrapped.canonical.x,unwrapped.canonical.y)))}else{idealTileIDs=transform.coveringTiles({tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this.usedForTerrain?false:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:terrain});if(this._source.hasTile){idealTileIDs=idealTileIDs.filter((coord=>this._source.hasTile(coord)))}}const zoom=transform.coveringZoomLevel(this._source);const minCoveringZoom=Math.max(zoom-SourceCache.maxOverzooming,this._source.minzoom);const maxCoveringZoom=Math.max(zoom+SourceCache.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const parents={};for(const tileID of idealTileIDs){if(tileID.canonical.z>this._source.minzoom){const parent=tileID.scaledTo(tileID.canonical.z-1);parents[parent.key]=parent;const parent2=tileID.scaledTo(Math.max(this._source.minzoom,Math.min(tileID.canonical.z,5)));parents[parent2.key]=parent2}}idealTileIDs=idealTileIDs.concat(Object.values(parents))}const noPendingDataEmissions=idealTileIDs.length===0&&!this._updated&&this._didEmitContent;this._updated=true;if(noPendingDataEmissions){this.fire(new performance$1.Event("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}))}const retain=this._updateRetainedTiles(idealTileIDs,zoom);if(isRasterType(this._source.type)){const parentsForFading={};const fadingTiles={};const ids=Object.keys(retain);const now=browser.now();for(const id of ids){const tileID=retain[id];const tile=this._tiles[id];if(!tile||tile.fadeEndTime!==0&&tile.fadeEndTime<=now){continue}const parentTile=this.findLoadedParent(tileID,minCoveringZoom);if(parentTile){this._addTile(parentTile.tileID);parentsForFading[parentTile.tileID.key]=parentTile.tileID}fadingTiles[id]=tileID}this._retainLoadedChildren(fadingTiles,zoom,maxCoveringZoom,retain);for(const id in parentsForFading){if(!retain[id]){this._coveredTiles[id]=true;retain[id]=parentsForFading[id]}}if(terrain){const idealRasterTileIDs={};const missingTileIDs={};for(const tileID of idealTileIDs){if(this._tiles[tileID.key].hasData())idealRasterTileIDs[tileID.key]=tileID;else missingTileIDs[tileID.key]=tileID}for(const key in missingTileIDs){const children=missingTileIDs[key].children(this._source.maxzoom);if(this._tiles[children[0].key]&&this._tiles[children[1].key]&&this._tiles[children[2].key]&&this._tiles[children[3].key]){idealRasterTileIDs[children[0].key]=retain[children[0].key]=children[0];idealRasterTileIDs[children[1].key]=retain[children[1].key]=children[1];idealRasterTileIDs[children[2].key]=retain[children[2].key]=children[2];idealRasterTileIDs[children[3].key]=retain[children[3].key]=children[3];delete missingTileIDs[key]}}for(const key in missingTileIDs){const parent=this.findLoadedParent(missingTileIDs[key],this._source.minzoom);if(parent){idealRasterTileIDs[parent.tileID.key]=retain[parent.tileID.key]=parent.tileID;for(const key in idealRasterTileIDs){if(idealRasterTileIDs[key].isChildOf(parent.tileID))delete idealRasterTileIDs[key]}}}for(const key in this._tiles){if(!idealRasterTileIDs[key])this._coveredTiles[key]=true}}}for(const retainedId in retain){this._tiles[retainedId].clearFadeHold()}const remove=performance$1.keysDifference(this._tiles,retain);for(const tileID of remove){const tile=this._tiles[tileID];if(tile.hasSymbolBuckets&&!tile.holdingForFade()){tile.setHoldDuration(this.map._fadeDuration)}else if(!tile.hasSymbolBuckets||tile.symbolFadeFinished()){this._removeTile(tileID)}}this._updateLoadedParentTileCache()}releaseSymbolFadeTiles(){for(const id in this._tiles){if(this._tiles[id].holdingForFade()){this._removeTile(id)}}}_updateRetainedTiles(idealTileIDs,zoom){const retain={};const checked={};const minCoveringZoom=Math.max(zoom-SourceCache.maxOverzooming,this._source.minzoom);const maxCoveringZoom=Math.max(zoom+SourceCache.maxUnderzooming,this._source.minzoom);const missingTiles={};for(const tileID of idealTileIDs){const tile=this._addTile(tileID);retain[tileID.key]=tileID;if(tile.hasData())continue;if(zoom<this._source.maxzoom){missingTiles[tileID.key]=tileID}}this._retainLoadedChildren(missingTiles,zoom,maxCoveringZoom,retain);for(const tileID of idealTileIDs){let tile=this._tiles[tileID.key];if(tile.hasData())continue;if(zoom+1>this._source.maxzoom){const childCoord=tileID.children(this._source.maxzoom)[0];const childTile=this.getTile(childCoord);if(!!childTile&&childTile.hasData()){retain[childCoord.key]=childCoord;continue}}else{const children=tileID.children(this._source.maxzoom);if(retain[children[0].key]&&retain[children[1].key]&&retain[children[2].key]&&retain[children[3].key])continue}let parentWasRequested=tile.wasRequested();for(let overscaledZ=tileID.overscaledZ-1;overscaledZ>=minCoveringZoom;--overscaledZ){const parentId=tileID.scaledTo(overscaledZ);if(checked[parentId.key])break;checked[parentId.key]=true;tile=this.getTile(parentId);if(!tile&&parentWasRequested){tile=this._addTile(parentId)}if(tile){const hasData=tile.hasData();if(parentWasRequested||hasData){retain[parentId.key]=parentId}parentWasRequested=tile.wasRequested();if(hasData)break}}}return retain}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const tileKey in this._tiles){const path=[];let parentTile;let currentId=this._tiles[tileKey].tileID;while(currentId.overscaledZ>0){if(currentId.key in this._loadedParentTiles){parentTile=this._loadedParentTiles[currentId.key];break}path.push(currentId.key);const parentId=currentId.scaledTo(currentId.overscaledZ-1);parentTile=this._getLoadedTile(parentId);if(parentTile){break}currentId=parentId}for(const key of path){this._loadedParentTiles[key]=parentTile}}}_addTile(tileID){let tile=this._tiles[tileID.key];if(tile)return tile;tile=this._cache.getAndRemove(tileID);if(tile){this._setTileReloadTimer(tileID.key,tile);tile.tileID=tileID;this._state.initializeTileState(tile,this.map?this.map.painter:null);if(this._cacheTimers[tileID.key]){clearTimeout(this._cacheTimers[tileID.key]);delete this._cacheTimers[tileID.key];this._setTileReloadTimer(tileID.key,tile)}}const cached=tile;if(!tile){tile=new Tile(tileID,this._source.tileSize*tileID.overscaleFactor());this._loadTile(tile,tileID.key,tile.state)}tile.uses++;this._tiles[tileID.key]=tile;if(!cached){this._source.fire(new performance$1.Event("dataloading",{tile:tile,coord:tile.tileID,dataType:"source"}))}return tile}_setTileReloadTimer(id,tile){if(id in this._timers){clearTimeout(this._timers[id]);delete this._timers[id]}const expiryTimeout=tile.getExpiryTimeout();if(expiryTimeout){this._timers[id]=setTimeout((()=>{this._reloadTile(id,"expired");delete this._timers[id]}),expiryTimeout)}}_removeTile(id){const tile=this._tiles[id];if(!tile)return;tile.uses--;delete this._tiles[id];if(this._timers[id]){clearTimeout(this._timers[id]);delete this._timers[id]}if(tile.uses>0)return;if(tile.hasData()&&tile.state!=="reloading"){this._cache.add(tile.tileID,tile,tile.getExpiryTimeout())}else{tile.aborted=true;this._abortTile(tile);this._unloadTile(tile)}}clearTiles(){this._shouldReloadOnResume=false;this._paused=false;for(const id in this._tiles)this._removeTile(id);this._cache.reset()}tilesIn(pointQueryGeometry,maxPitchScaleFactor,has3DLayer){const tileResults=[];const transform=this.transform;if(!transform)return tileResults;const cameraPointQueryGeometry=has3DLayer?transform.getCameraQueryGeometry(pointQueryGeometry):pointQueryGeometry;const queryGeometry=pointQueryGeometry.map((p=>transform.pointCoordinate(p,this.terrain)));const cameraQueryGeometry=cameraPointQueryGeometry.map((p=>transform.pointCoordinate(p,this.terrain)));const ids=this.getIds();let minX=Infinity;let minY=Infinity;let maxX=-Infinity;let maxY=-Infinity;for(const p of cameraQueryGeometry){minX=Math.min(minX,p.x);minY=Math.min(minY,p.y);maxX=Math.max(maxX,p.x);maxY=Math.max(maxY,p.y)}for(let i=0;i<ids.length;i++){const tile=this._tiles[ids[i]];if(tile.holdingForFade()){continue}const tileID=tile.tileID;const scale=Math.pow(2,transform.zoom-tile.tileID.overscaledZ);const queryPadding=maxPitchScaleFactor*tile.queryPadding*performance$1.EXTENT/tile.tileSize/scale;const tileSpaceBounds=[tileID.getTilePoint(new performance$1.MercatorCoordinate(minX,minY)),tileID.getTilePoint(new performance$1.MercatorCoordinate(maxX,maxY))];if(tileSpaceBounds[0].x-queryPadding<performance$1.EXTENT&&tileSpaceBounds[0].y-queryPadding<performance$1.EXTENT&&tileSpaceBounds[1].x+queryPadding>=0&&tileSpaceBounds[1].y+queryPadding>=0){const tileSpaceQueryGeometry=queryGeometry.map((c=>tileID.getTilePoint(c)));const tileSpaceCameraQueryGeometry=cameraQueryGeometry.map((c=>tileID.getTilePoint(c)));tileResults.push({tile:tile,tileID:tileID,queryGeometry:tileSpaceQueryGeometry,cameraQueryGeometry:tileSpaceCameraQueryGeometry,scale:scale})}}return tileResults}getVisibleCoordinates(symbolLayer){const coords=this.getRenderableIds(symbolLayer).map((id=>this._tiles[id].tileID));for(const coord of coords){coord.posMatrix=this.transform.calculatePosMatrix(coord.toUnwrapped())}return coords}hasTransition(){if(this._source.hasTransition()){return true}if(isRasterType(this._source.type)){const now=browser.now();for(const id in this._tiles){const tile=this._tiles[id];if(tile.fadeEndTime>=now){return true}}}return false}setFeatureState(sourceLayer,featureId,state){sourceLayer=sourceLayer||"_geojsonTileLayer";this._state.updateState(sourceLayer,featureId,state)}removeFeatureState(sourceLayer,featureId,key){sourceLayer=sourceLayer||"_geojsonTileLayer";this._state.removeFeatureState(sourceLayer,featureId,key)}getFeatureState(sourceLayer,featureId){sourceLayer=sourceLayer||"_geojsonTileLayer";return this._state.getState(sourceLayer,featureId)}setDependencies(tileKey,namespace,dependencies){const tile=this._tiles[tileKey];if(tile){tile.setDependencies(namespace,dependencies)}}reloadTilesForDependencies(namespaces,keys){for(const id in this._tiles){const tile=this._tiles[id];if(tile.hasDependency(namespaces,keys)){this._reloadTile(id,"reloading")}}this._cache.filter((tile=>!tile.hasDependency(namespaces,keys)))}}SourceCache.maxOverzooming=10;SourceCache.maxUnderzooming=3;function compareTileId(a,b){const aWrap=Math.abs(a.wrap*2)-+(a.wrap<0);const bWrap=Math.abs(b.wrap*2)-+(b.wrap<0);return a.overscaledZ-b.overscaledZ||bWrap-aWrap||b.canonical.y-a.canonical.y||b.canonical.x-a.canonical.x}function isRasterType(type){return type==="raster"||type==="image"||type==="video"}class PathInterpolator{constructor(points_,padding_){this.reset(points_,padding_)}reset(points_,padding_){this.points=points_||[];this._distances=[0];for(let i=1;i<this.points.length;i++){this._distances[i]=this._distances[i-1]+this.points[i].dist(this.points[i-1])}this.length=this._distances[this._distances.length-1];this.padding=Math.min(padding_||0,this.length*.5);this.paddedLength=this.length-this.padding*2}lerp(t){if(this.points.length===1){return this.points[0]}t=performance$1.clamp(t,0,1);let currentIndex=1;let distOfCurrentIdx=this._distances[currentIndex];const distToTarget=t*this.paddedLength+this.padding;while(distOfCurrentIdx<distToTarget&&currentIndex<this._distances.length){distOfCurrentIdx=this._distances[++currentIndex]}const idxOfPrevPoint=currentIndex-1;const distOfPrevIdx=this._distances[idxOfPrevPoint];const segmentLength=distOfCurrentIdx-distOfPrevIdx;const segmentT=segmentLength>0?(distToTarget-distOfPrevIdx)/segmentLength:0;return this.points[idxOfPrevPoint].mult(1-segmentT).add(this.points[currentIndex].mult(segmentT))}}function overlapAllowed(overlapA,overlapB){let allowed=true;if(overlapA==="always"){}else if(overlapA==="never"||overlapB==="never"){allowed=false}return allowed}class GridIndex{constructor(width,height,cellSize){const boxCells=this.boxCells=[];const circleCells=this.circleCells=[];this.xCellCount=Math.ceil(width/cellSize);this.yCellCount=Math.ceil(height/cellSize);for(let i=0;i<this.xCellCount*this.yCellCount;i++){boxCells.push([]);circleCells.push([])}this.circleKeys=[];this.boxKeys=[];this.bboxes=[];this.circles=[];this.width=width;this.height=height;this.xScale=this.xCellCount/width;this.yScale=this.yCellCount/height;this.boxUid=0;this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(key,x1,y1,x2,y2){this._forEachCell(x1,y1,x2,y2,this._insertBoxCell,this.boxUid++);this.boxKeys.push(key);this.bboxes.push(x1);this.bboxes.push(y1);this.bboxes.push(x2);this.bboxes.push(y2)}insertCircle(key,x,y,radius){this._forEachCell(x-radius,y-radius,x+radius,y+radius,this._insertCircleCell,this.circleUid++);this.circleKeys.push(key);this.circles.push(x);this.circles.push(y);this.circles.push(radius)}_insertBoxCell(x1,y1,x2,y2,cellIndex,uid){this.boxCells[cellIndex].push(uid)}_insertCircleCell(x1,y1,x2,y2,cellIndex,uid){this.circleCells[cellIndex].push(uid)}_query(x1,y1,x2,y2,hitTest,overlapMode,predicate){if(x2<0||x1>this.width||y2<0||y1>this.height){return[]}const result=[];if(x1<=0&&y1<=0&&this.width<=x2&&this.height<=y2){if(hitTest){return[{key:null,x1:x1,y1:y1,x2:x2,y2:y2}]}for(let boxUid=0;boxUid<this.boxKeys.length;boxUid++){result.push({key:this.boxKeys[boxUid],x1:this.bboxes[boxUid*4],y1:this.bboxes[boxUid*4+1],x2:this.bboxes[boxUid*4+2],y2:this.bboxes[boxUid*4+3]})}for(let circleUid=0;circleUid<this.circleKeys.length;circleUid++){const x=this.circles[circleUid*3];const y=this.circles[circleUid*3+1];const radius=this.circles[circleUid*3+2];result.push({key:this.circleKeys[circleUid],x1:x-radius,y1:y-radius,x2:x+radius,y2:y+radius})}}else{const queryArgs={hitTest:hitTest,overlapMode:overlapMode,seenUids:{box:{},circle:{}}};this._forEachCell(x1,y1,x2,y2,this._queryCell,result,queryArgs,predicate)}return result}query(x1,y1,x2,y2){return this._query(x1,y1,x2,y2,false,null)}hitTest(x1,y1,x2,y2,overlapMode,predicate){return this._query(x1,y1,x2,y2,true,overlapMode,predicate).length>0}hitTestCircle(x,y,radius,overlapMode,predicate){const x1=x-radius;const x2=x+radius;const y1=y-radius;const y2=y+radius;if(x2<0||x1>this.width||y2<0||y1>this.height){return false}const result=[];const queryArgs={hitTest:true,overlapMode:overlapMode,circle:{x:x,y:y,radius:radius},seenUids:{box:{},circle:{}}};this._forEachCell(x1,y1,x2,y2,this._queryCellCircle,result,queryArgs,predicate);return result.length>0}_queryCell(x1,y1,x2,y2,cellIndex,result,queryArgs,predicate){const{seenUids:seenUids,hitTest:hitTest,overlapMode:overlapMode}=queryArgs;const boxCell=this.boxCells[cellIndex];if(boxCell!==null){const bboxes=this.bboxes;for(const boxUid of boxCell){if(!seenUids.box[boxUid]){seenUids.box[boxUid]=true;const offset=boxUid*4;const key=this.boxKeys[boxUid];if(x1<=bboxes[offset+2]&&y1<=bboxes[offset+3]&&x2>=bboxes[offset+0]&&y2>=bboxes[offset+1]&&(!predicate||predicate(key))){if(!hitTest||!overlapAllowed(overlapMode,key.overlapMode)){result.push({key:key,x1:bboxes[offset],y1:bboxes[offset+1],x2:bboxes[offset+2],y2:bboxes[offset+3]});if(hitTest){return true}}}}}}const circleCell=this.circleCells[cellIndex];if(circleCell!==null){const circles=this.circles;for(const circleUid of circleCell){if(!seenUids.circle[circleUid]){seenUids.circle[circleUid]=true;const offset=circleUid*3;const key=this.circleKeys[circleUid];if(this._circleAndRectCollide(circles[offset],circles[offset+1],circles[offset+2],x1,y1,x2,y2)&&(!predicate||predicate(key))){if(!hitTest||!overlapAllowed(overlapMode,key.overlapMode)){const x=circles[offset];const y=circles[offset+1];const radius=circles[offset+2];result.push({key:key,x1:x-radius,y1:y-radius,x2:x+radius,y2:y+radius});if(hitTest){return true}}}}}}return false}_queryCellCircle(x1,y1,x2,y2,cellIndex,result,queryArgs,predicate){const{circle:circle,seenUids:seenUids,overlapMode:overlapMode}=queryArgs;const boxCell=this.boxCells[cellIndex];if(boxCell!==null){const bboxes=this.bboxes;for(const boxUid of boxCell){if(!seenUids.box[boxUid]){seenUids.box[boxUid]=true;const offset=boxUid*4;const key=this.boxKeys[boxUid];if(this._circleAndRectCollide(circle.x,circle.y,circle.radius,bboxes[offset+0],bboxes[offset+1],bboxes[offset+2],bboxes[offset+3])&&(!predicate||predicate(key))&&!overlapAllowed(overlapMode,key.overlapMode)){result.push(true);return true}}}}const circleCell=this.circleCells[cellIndex];if(circleCell!==null){const circles=this.circles;for(const circleUid of circleCell){if(!seenUids.circle[circleUid]){seenUids.circle[circleUid]=true;const offset=circleUid*3;const key=this.circleKeys[circleUid];if(this._circlesCollide(circles[offset],circles[offset+1],circles[offset+2],circle.x,circle.y,circle.radius)&&(!predicate||predicate(key))&&!overlapAllowed(overlapMode,key.overlapMode)){result.push(true);return true}}}}}_forEachCell(x1,y1,x2,y2,fn,arg1,arg2,predicate){const cx1=this._convertToXCellCoord(x1);const cy1=this._convertToYCellCoord(y1);const cx2=this._convertToXCellCoord(x2);const cy2=this._convertToYCellCoord(y2);for(let x=cx1;x<=cx2;x++){for(let y=cy1;y<=cy2;y++){const cellIndex=this.xCellCount*y+x;if(fn.call(this,x1,y1,x2,y2,cellIndex,arg1,arg2,predicate))return}}}_convertToXCellCoord(x){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(x*this.xScale)))}_convertToYCellCoord(y){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(y*this.yScale)))}_circlesCollide(x1,y1,r1,x2,y2,r2){const dx=x2-x1;const dy=y2-y1;const bothRadii=r1+r2;return bothRadii*bothRadii>dx*dx+dy*dy}_circleAndRectCollide(circleX,circleY,radius,x1,y1,x2,y2){const halfRectWidth=(x2-x1)/2;const distX=Math.abs(circleX-(x1+halfRectWidth));if(distX>halfRectWidth+radius){return false}const halfRectHeight=(y2-y1)/2;const distY=Math.abs(circleY-(y1+halfRectHeight));if(distY>halfRectHeight+radius){return false}if(distX<=halfRectWidth||distY<=halfRectHeight){return true}const dx=distX-halfRectWidth;const dy=distY-halfRectHeight;return dx*dx+dy*dy<=radius*radius}}function getLabelPlaneMatrix(posMatrix,pitchWithMap,rotateWithMap,transform,pixelsToTileUnits){const m=performance$1.create();if(pitchWithMap){performance$1.scale(m,m,[1/pixelsToTileUnits,1/pixelsToTileUnits,1]);if(!rotateWithMap){performance$1.rotateZ(m,m,transform.angle)}}else{performance$1.multiply(m,transform.labelPlaneMatrix,posMatrix)}return m}function getGlCoordMatrix(posMatrix,pitchWithMap,rotateWithMap,transform,pixelsToTileUnits){if(pitchWithMap){const m=performance$1.clone(posMatrix);performance$1.scale(m,m,[pixelsToTileUnits,pixelsToTileUnits,1]);if(!rotateWithMap){performance$1.rotateZ(m,m,-transform.angle)}return m}else{return transform.glCoordMatrix}}function project(point,matrix,getElevation){let pos;if(getElevation){pos=[point.x,point.y,getElevation(point.x,point.y),1];performance$1.transformMat4(pos,pos,matrix)}else{pos=[point.x,point.y,0,1];xyTransformMat4(pos,pos,matrix)}const w=pos[3];return{point:new performance$1.Point(pos[0]/w,pos[1]/w),signedDistanceFromCamera:w}}function getPerspectiveRatio(cameraToCenterDistance,signedDistanceFromCamera){return.5+.5*(cameraToCenterDistance/signedDistanceFromCamera)}function isVisible(anchorPos,clippingBuffer){const x=anchorPos[0]/anchorPos[3];const y=anchorPos[1]/anchorPos[3];const inPaddedViewport=x>=-clippingBuffer[0]&&x<=clippingBuffer[0]&&y>=-clippingBuffer[1]&&y<=clippingBuffer[1];return inPaddedViewport}function updateLineLabels(bucket,posMatrix,painter,isText,labelPlaneMatrix,glCoordMatrix,pitchWithMap,keepUpright,rotateToLine,getElevation){const sizeData=isText?bucket.textSizeData:bucket.iconSizeData;const partiallyEvaluatedSize=performance$1.evaluateSizeForZoom(sizeData,painter.transform.zoom);const clippingBuffer=[256/painter.width*2+1,256/painter.height*2+1];const dynamicLayoutVertexArray=isText?bucket.text.dynamicLayoutVertexArray:bucket.icon.dynamicLayoutVertexArray;dynamicLayoutVertexArray.clear();const lineVertexArray=bucket.lineVertexArray;const placedSymbols=isText?bucket.text.placedSymbolArray:bucket.icon.placedSymbolArray;const aspectRatio=painter.transform.width/painter.transform.height;let useVertical=false;for(let s=0;s<placedSymbols.length;s++){const symbol=placedSymbols.get(s);if(symbol.hidden||symbol.writingMode===performance$1.WritingMode.vertical&&!useVertical){hideGlyphs(symbol.numGlyphs,dynamicLayoutVertexArray);continue}useVertical=false;let anchorPos;if(getElevation){anchorPos=[symbol.anchorX,symbol.anchorY,getElevation(symbol.anchorX,symbol.anchorY),1];performance$1.transformMat4(anchorPos,anchorPos,posMatrix)}else{anchorPos=[symbol.anchorX,symbol.anchorY,0,1];xyTransformMat4(anchorPos,anchorPos,posMatrix)}if(!isVisible(anchorPos,clippingBuffer)){hideGlyphs(symbol.numGlyphs,dynamicLayoutVertexArray);continue}const cameraToAnchorDistance=anchorPos[3];const perspectiveRatio=getPerspectiveRatio(painter.transform.cameraToCenterDistance,cameraToAnchorDistance);const fontSize=performance$1.evaluateSizeForFeature(sizeData,partiallyEvaluatedSize,symbol);const pitchScaledFontSize=pitchWithMap?fontSize/perspectiveRatio:fontSize*perspectiveRatio;const tileAnchorPoint=new performance$1.Point(symbol.anchorX,symbol.anchorY);const anchorPoint=project(tileAnchorPoint,labelPlaneMatrix,getElevation).point;const projectionCache={projections:{},offsets:{}};const placeUnflipped=placeGlyphsAlongLine(symbol,pitchScaledFontSize,false,keepUpright,posMatrix,labelPlaneMatrix,glCoordMatrix,bucket.glyphOffsetArray,lineVertexArray,dynamicLayoutVertexArray,anchorPoint,tileAnchorPoint,projectionCache,aspectRatio,rotateToLine,getElevation);useVertical=placeUnflipped.useVertical;if(placeUnflipped.notEnoughRoom||useVertical||placeUnflipped.needsFlipping&&placeGlyphsAlongLine(symbol,pitchScaledFontSize,true,keepUpright,posMatrix,labelPlaneMatrix,glCoordMatrix,bucket.glyphOffsetArray,lineVertexArray,dynamicLayoutVertexArray,anchorPoint,tileAnchorPoint,projectionCache,aspectRatio,rotateToLine,getElevation).notEnoughRoom){hideGlyphs(symbol.numGlyphs,dynamicLayoutVertexArray)}}if(isText){bucket.text.dynamicLayoutVertexBuffer.updateData(dynamicLayoutVertexArray)}else{bucket.icon.dynamicLayoutVertexBuffer.updateData(dynamicLayoutVertexArray)}}function placeFirstAndLastGlyph(fontScale,glyphOffsetArray,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation){const glyphEndIndex=symbol.glyphStartIndex+symbol.numGlyphs;const lineStartIndex=symbol.lineStartIndex;const lineEndIndex=symbol.lineStartIndex+symbol.lineLength;const firstGlyphOffset=glyphOffsetArray.getoffsetX(symbol.glyphStartIndex);const lastGlyphOffset=glyphOffsetArray.getoffsetX(glyphEndIndex-1);const firstPlacedGlyph=placeGlyphAlongLine(fontScale*firstGlyphOffset,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol.segment,lineStartIndex,lineEndIndex,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation);if(!firstPlacedGlyph)return null;const lastPlacedGlyph=placeGlyphAlongLine(fontScale*lastGlyphOffset,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol.segment,lineStartIndex,lineEndIndex,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation);if(!lastPlacedGlyph)return null;return{first:firstPlacedGlyph,last:lastPlacedGlyph}}function requiresOrientationChange(writingMode,firstPoint,lastPoint,aspectRatio){if(writingMode===performance$1.WritingMode.horizontal){const rise=Math.abs(lastPoint.y-firstPoint.y);const run=Math.abs(lastPoint.x-firstPoint.x)*aspectRatio;if(rise>run){return{useVertical:true}}}if(writingMode===performance$1.WritingMode.vertical?firstPoint.y<lastPoint.y:firstPoint.x>lastPoint.x){return{needsFlipping:true}}return null}function placeGlyphsAlongLine(symbol,fontSize,flip,keepUpright,posMatrix,labelPlaneMatrix,glCoordMatrix,glyphOffsetArray,lineVertexArray,dynamicLayoutVertexArray,anchorPoint,tileAnchorPoint,projectionCache,aspectRatio,rotateToLine,getElevation){const fontScale=fontSize/24;const lineOffsetX=symbol.lineOffsetX*fontScale;const lineOffsetY=symbol.lineOffsetY*fontScale;let placedGlyphs;if(symbol.numGlyphs>1){const glyphEndIndex=symbol.glyphStartIndex+symbol.numGlyphs;const lineStartIndex=symbol.lineStartIndex;const lineEndIndex=symbol.lineStartIndex+symbol.lineLength;const firstAndLastGlyph=placeFirstAndLastGlyph(fontScale,glyphOffsetArray,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation);if(!firstAndLastGlyph){return{notEnoughRoom:true}}const firstPoint=project(firstAndLastGlyph.first.point,glCoordMatrix,getElevation).point;const lastPoint=project(firstAndLastGlyph.last.point,glCoordMatrix,getElevation).point;if(keepUpright&&!flip){const orientationChange=requiresOrientationChange(symbol.writingMode,firstPoint,lastPoint,aspectRatio);if(orientationChange){return orientationChange}}placedGlyphs=[firstAndLastGlyph.first];for(let glyphIndex=symbol.glyphStartIndex+1;glyphIndex<glyphEndIndex-1;glyphIndex++){placedGlyphs.push(placeGlyphAlongLine(fontScale*glyphOffsetArray.getoffsetX(glyphIndex),lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol.segment,lineStartIndex,lineEndIndex,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation))}placedGlyphs.push(firstAndLastGlyph.last)}else{if(keepUpright&&!flip){const a=project(tileAnchorPoint,posMatrix,getElevation).point;const tileVertexIndex=symbol.lineStartIndex+symbol.segment+1;const tileSegmentEnd=new performance$1.Point(lineVertexArray.getx(tileVertexIndex),lineVertexArray.gety(tileVertexIndex));const projectedVertex=project(tileSegmentEnd,posMatrix,getElevation);const b=projectedVertex.signedDistanceFromCamera>0?projectedVertex.point:projectTruncatedLineSegment(tileAnchorPoint,tileSegmentEnd,a,1,posMatrix,getElevation);const orientationChange=requiresOrientationChange(symbol.writingMode,a,b,aspectRatio);if(orientationChange){return orientationChange}}const singleGlyph=placeGlyphAlongLine(fontScale*glyphOffsetArray.getoffsetX(symbol.glyphStartIndex),lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,symbol.segment,symbol.lineStartIndex,symbol.lineStartIndex+symbol.lineLength,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation);if(!singleGlyph)return{notEnoughRoom:true};placedGlyphs=[singleGlyph]}for(const glyph of placedGlyphs){performance$1.addDynamicAttributes(dynamicLayoutVertexArray,glyph.point,glyph.angle)}return{}}function projectTruncatedLineSegment(previousTilePoint,currentTilePoint,previousProjectedPoint,minimumLength,projectionMatrix,getElevation){const projectedUnitVertex=project(previousTilePoint.add(previousTilePoint.sub(currentTilePoint)._unit()),projectionMatrix,getElevation).point;const projectedUnitSegment=previousProjectedPoint.sub(projectedUnitVertex);return previousProjectedPoint.add(projectedUnitSegment._mult(minimumLength/projectedUnitSegment.mag()))}function projectVertexToViewport(index,projectionArgs){const{projectionCache:projectionCache,lineVertexArray:lineVertexArray,labelPlaneMatrix:labelPlaneMatrix,tileAnchorPoint:tileAnchorPoint,distanceFromAnchor:distanceFromAnchor,getElevation:getElevation,previousVertex:previousVertex,direction:direction,absOffsetX:absOffsetX}=projectionArgs;if(projectionCache.projections[index]){return projectionCache.projections[index]}const currentVertex=new performance$1.Point(lineVertexArray.getx(index),lineVertexArray.gety(index));const projection=project(currentVertex,labelPlaneMatrix,getElevation);if(projection.signedDistanceFromCamera>0){projectionCache.projections[index]=projection.point;return projection.point}const previousLineVertexIndex=index-direction;const previousTilePoint=distanceFromAnchor===0?tileAnchorPoint:new performance$1.Point(lineVertexArray.getx(previousLineVertexIndex),lineVertexArray.gety(previousLineVertexIndex));return projectTruncatedLineSegment(previousTilePoint,currentVertex,previousVertex,absOffsetX-distanceFromAnchor+1,labelPlaneMatrix,getElevation)}function transformToOffsetNormal(segmentVector,offset,direction){return segmentVector._unit()._perp()._mult(offset*direction)}function findOffsetIntersectionPoint(index,prevToCurrentOffsetNormal,currentVertex,lineStartIndex,lineEndIndex,offsetPreviousVertex,lineOffsetY,projectionArgs){const{projectionCache:projectionCache,direction:direction}=projectionArgs;if(projectionCache.offsets[index]){return projectionCache.offsets[index]}const offsetCurrentVertex=currentVertex.add(prevToCurrentOffsetNormal);if(index+direction<lineStartIndex||index+direction>=lineEndIndex){projectionCache.offsets[index]=offsetCurrentVertex;return offsetCurrentVertex}const nextVertex=projectVertexToViewport(index+direction,projectionArgs);const currentToNextOffsetNormal=transformToOffsetNormal(nextVertex.sub(currentVertex),lineOffsetY,direction);const offsetNextSegmentBegin=currentVertex.add(currentToNextOffsetNormal);const offsetNextSegmentEnd=nextVertex.add(currentToNextOffsetNormal);projectionCache.offsets[index]=performance$1.findLineIntersection(offsetPreviousVertex,offsetCurrentVertex,offsetNextSegmentBegin,offsetNextSegmentEnd)||offsetCurrentVertex;return projectionCache.offsets[index]}function placeGlyphAlongLine(offsetX,lineOffsetX,lineOffsetY,flip,anchorPoint,tileAnchorPoint,anchorSegment,lineStartIndex,lineEndIndex,lineVertexArray,labelPlaneMatrix,projectionCache,rotateToLine,getElevation){const combinedOffsetX=flip?offsetX-lineOffsetX:offsetX+lineOffsetX;let direction=combinedOffsetX>0?1:-1;let angle=0;if(flip){direction*=-1;angle=Math.PI}if(direction<0)angle+=Math.PI;let currentIndex=direction>0?lineStartIndex+anchorSegment:lineStartIndex+anchorSegment+1;let currentVertex=anchorPoint;let previousVertex=anchorPoint;let offsetIntersectionPoint;let offsetPreviousVertex;let distanceFromAnchor=0;let currentSegmentDistance=0;const absOffsetX=Math.abs(combinedOffsetX);const pathVertices=[];let currentLineSegment;while(distanceFromAnchor+currentSegmentDistance<=absOffsetX){currentIndex+=direction;if(currentIndex<lineStartIndex||currentIndex>=lineEndIndex)return null;distanceFromAnchor+=currentSegmentDistance;previousVertex=currentVertex;offsetPreviousVertex=offsetIntersectionPoint;const projectionArgs={projectionCache:projectionCache,lineVertexArray:lineVertexArray,labelPlaneMatrix:labelPlaneMatrix,tileAnchorPoint:tileAnchorPoint,distanceFromAnchor:distanceFromAnchor,getElevation:getElevation,previousVertex:previousVertex,direction:direction,absOffsetX:absOffsetX};currentVertex=projectVertexToViewport(currentIndex,projectionArgs);if(lineOffsetY===0){pathVertices.push(previousVertex);currentLineSegment=currentVertex.sub(previousVertex)}else{let prevToCurrentOffsetNormal;const prevToCurrent=currentVertex.sub(previousVertex);if(prevToCurrent.mag()===0){const nextVertex=projectVertexToViewport(currentIndex+direction,projectionArgs);prevToCurrentOffsetNormal=transformToOffsetNormal(nextVertex.sub(currentVertex),lineOffsetY,direction)}else{prevToCurrentOffsetNormal=transformToOffsetNormal(prevToCurrent,lineOffsetY,direction)}if(!offsetPreviousVertex)offsetPreviousVertex=previousVertex.add(prevToCurrentOffsetNormal);offsetIntersectionPoint=findOffsetIntersectionPoint(currentIndex,prevToCurrentOffsetNormal,currentVertex,lineStartIndex,lineEndIndex,offsetPreviousVertex,lineOffsetY,projectionArgs);pathVertices.push(offsetPreviousVertex);currentLineSegment=offsetIntersectionPoint.sub(offsetPreviousVertex)}currentSegmentDistance=currentLineSegment.mag()}const segmentInterpolationT=(absOffsetX-distanceFromAnchor)/currentSegmentDistance;const p=currentLineSegment._mult(segmentInterpolationT)._add(offsetPreviousVertex||previousVertex);const segmentAngle=angle+Math.atan2(currentVertex.y-previousVertex.y,currentVertex.x-previousVertex.x);pathVertices.push(p);return{point:p,angle:rotateToLine?segmentAngle:0,path:pathVertices}}const hiddenGlyphAttributes=new Float32Array([-Infinity,-Infinity,0,-Infinity,-Infinity,0,-Infinity,-Infinity,0,-Infinity,-Infinity,0]);function hideGlyphs(num,dynamicLayoutVertexArray){for(let i=0;i<num;i++){const offset=dynamicLayoutVertexArray.length;dynamicLayoutVertexArray.resize(offset+4);dynamicLayoutVertexArray.float32.set(hiddenGlyphAttributes,offset*3)}}function xyTransformMat4(out,a,m){const x=a[0],y=a[1];out[0]=m[0]*x+m[4]*y+m[12];out[1]=m[1]*x+m[5]*y+m[13];out[3]=m[3]*x+m[7]*y+m[15];return out}const viewportPadding=100;class CollisionIndex{constructor(transform,grid=new GridIndex(transform.width+2*viewportPadding,transform.height+2*viewportPadding,25),ignoredGrid=new GridIndex(transform.width+2*viewportPadding,transform.height+2*viewportPadding,25)){this.transform=transform;this.grid=grid;this.ignoredGrid=ignoredGrid;this.pitchfactor=Math.cos(transform._pitch)*transform.cameraToCenterDistance;this.screenRightBoundary=transform.width+viewportPadding;this.screenBottomBoundary=transform.height+viewportPadding;this.gridRightBoundary=transform.width+2*viewportPadding;this.gridBottomBoundary=transform.height+2*viewportPadding;this.perspectiveRatioCutoff=.6}placeCollisionBox(collisionBox,overlapMode,textPixelRatio,posMatrix,collisionGroupPredicate,getElevation){const projectedPoint=this.projectAndGetPerspectiveRatio(posMatrix,collisionBox.anchorPointX,collisionBox.anchorPointY,getElevation);const tileToViewport=textPixelRatio*projectedPoint.perspectiveRatio;const tlX=collisionBox.x1*tileToViewport+projectedPoint.point.x;const tlY=collisionBox.y1*tileToViewport+projectedPoint.point.y;const brX=collisionBox.x2*tileToViewport+projectedPoint.point.x;const brY=collisionBox.y2*tileToViewport+projectedPoint.point.y;if(!this.isInsideGrid(tlX,tlY,brX,brY)||overlapMode!=="always"&&this.grid.hitTest(tlX,tlY,brX,brY,overlapMode,collisionGroupPredicate)||projectedPoint.perspectiveRatio<this.perspectiveRatioCutoff){return{box:[],offscreen:false}}return{box:[tlX,tlY,brX,brY],offscreen:this.isOffscreen(tlX,tlY,brX,brY)}}placeCollisionCircles(overlapMode,symbol,lineVertexArray,glyphOffsetArray,fontSize,posMatrix,labelPlaneMatrix,labelToScreenMatrix,showCollisionCircles,pitchWithMap,collisionGroupPredicate,circlePixelDiameter,textPixelPadding,getElevation){const placedCollisionCircles=[];const tileUnitAnchorPoint=new performance$1.Point(symbol.anchorX,symbol.anchorY);const screenAnchorPoint=project(tileUnitAnchorPoint,posMatrix,getElevation);const perspectiveRatio=getPerspectiveRatio(this.transform.cameraToCenterDistance,screenAnchorPoint.signedDistanceFromCamera);const labelPlaneFontSize=pitchWithMap?fontSize/perspectiveRatio:fontSize*perspectiveRatio;const labelPlaneFontScale=labelPlaneFontSize/performance$1.ONE_EM;const labelPlaneAnchorPoint=project(tileUnitAnchorPoint,labelPlaneMatrix,getElevation).point;const projectionCache={projections:{},offsets:{}};const lineOffsetX=symbol.lineOffsetX*labelPlaneFontScale;const lineOffsetY=symbol.lineOffsetY*labelPlaneFontScale;const firstAndLastGlyph=placeFirstAndLastGlyph(labelPlaneFontScale,glyphOffsetArray,lineOffsetX,lineOffsetY,false,labelPlaneAnchorPoint,tileUnitAnchorPoint,symbol,lineVertexArray,labelPlaneMatrix,projectionCache,false,getElevation);let collisionDetected=false;let inGrid=false;let entirelyOffscreen=true;if(firstAndLastGlyph){const radius=circlePixelDiameter*.5*perspectiveRatio+textPixelPadding;const screenPlaneMin=new performance$1.Point(-viewportPadding,-viewportPadding);const screenPlaneMax=new performance$1.Point(this.screenRightBoundary,this.screenBottomBoundary);const interpolator=new PathInterpolator;const first=firstAndLastGlyph.first;const last=firstAndLastGlyph.last;let projectedPath=[];for(let i=first.path.length-1;i>=1;i--){projectedPath.push(first.path[i])}for(let i=1;i<last.path.length;i++){projectedPath.push(last.path[i])}const circleDist=radius*2.5;if(labelToScreenMatrix){const screenSpacePath=projectedPath.map((p=>project(p,labelToScreenMatrix,getElevation)));if(screenSpacePath.some((point=>point.signedDistanceFromCamera<=0))){projectedPath=[]}else{projectedPath=screenSpacePath.map((p=>p.point))}}let segments=[];if(projectedPath.length>0){const minPoint=projectedPath[0].clone();const maxPoint=projectedPath[0].clone();for(let i=1;i<projectedPath.length;i++){minPoint.x=Math.min(minPoint.x,projectedPath[i].x);minPoint.y=Math.min(minPoint.y,projectedPath[i].y);maxPoint.x=Math.max(maxPoint.x,projectedPath[i].x);maxPoint.y=Math.max(maxPoint.y,projectedPath[i].y)}if(minPoint.x>=screenPlaneMin.x&&maxPoint.x<=screenPlaneMax.x&&minPoint.y>=screenPlaneMin.y&&maxPoint.y<=screenPlaneMax.y){segments=[projectedPath]}else if(maxPoint.x<screenPlaneMin.x||minPoint.x>screenPlaneMax.x||maxPoint.y<screenPlaneMin.y||minPoint.y>screenPlaneMax.y){segments=[]}else{segments=performance$1.clipLine([projectedPath],screenPlaneMin.x,screenPlaneMin.y,screenPlaneMax.x,screenPlaneMax.y)}}for(const seg of segments){interpolator.reset(seg,radius*.25);let numCircles=0;if(interpolator.length<=.5*radius){numCircles=1}else{numCircles=Math.ceil(interpolator.paddedLength/circleDist)+1}for(let i=0;i<numCircles;i++){const t=i/Math.max(numCircles-1,1);const circlePosition=interpolator.lerp(t);const centerX=circlePosition.x+viewportPadding;const centerY=circlePosition.y+viewportPadding;placedCollisionCircles.push(centerX,centerY,radius,0);const x1=centerX-radius;const y1=centerY-radius;const x2=centerX+radius;const y2=centerY+radius;entirelyOffscreen=entirelyOffscreen&&this.isOffscreen(x1,y1,x2,y2);inGrid=inGrid||this.isInsideGrid(x1,y1,x2,y2);if(overlapMode!=="always"&&this.grid.hitTestCircle(centerX,centerY,radius,overlapMode,collisionGroupPredicate)){collisionDetected=true;if(!showCollisionCircles){return{circles:[],offscreen:false,collisionDetected:collisionDetected}}}}}}return{circles:!showCollisionCircles&&collisionDetected||!inGrid||perspectiveRatio<this.perspectiveRatioCutoff?[]:placedCollisionCircles,offscreen:entirelyOffscreen,collisionDetected:collisionDetected}}queryRenderedSymbols(viewportQueryGeometry){if(viewportQueryGeometry.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0){return{}}const query=[];let minX=Infinity;let minY=Infinity;let maxX=-Infinity;let maxY=-Infinity;for(const point of viewportQueryGeometry){const gridPoint=new performance$1.Point(point.x+viewportPadding,point.y+viewportPadding);minX=Math.min(minX,gridPoint.x);minY=Math.min(minY,gridPoint.y);maxX=Math.max(maxX,gridPoint.x);maxY=Math.max(maxY,gridPoint.y);query.push(gridPoint)}const features=this.grid.query(minX,minY,maxX,maxY).concat(this.ignoredGrid.query(minX,minY,maxX,maxY));const seenFeatures={};const result={};for(const feature of features){const featureKey=feature.key;if(seenFeatures[featureKey.bucketInstanceId]===undefined){seenFeatures[featureKey.bucketInstanceId]={}}if(seenFeatures[featureKey.bucketInstanceId][featureKey.featureIndex]){continue}const bbox=[new performance$1.Point(feature.x1,feature.y1),new performance$1.Point(feature.x2,feature.y1),new performance$1.Point(feature.x2,feature.y2),new performance$1.Point(feature.x1,feature.y2)];if(!performance$1.polygonIntersectsPolygon(query,bbox)){continue}seenFeatures[featureKey.bucketInstanceId][featureKey.featureIndex]=true;if(result[featureKey.bucketInstanceId]===undefined){result[featureKey.bucketInstanceId]=[]}result[featureKey.bucketInstanceId].push(featureKey.featureIndex)}return result}insertCollisionBox(collisionBox,overlapMode,ignorePlacement,bucketInstanceId,featureIndex,collisionGroupID){const grid=ignorePlacement?this.ignoredGrid:this.grid;const key={bucketInstanceId:bucketInstanceId,featureIndex:featureIndex,collisionGroupID:collisionGroupID,overlapMode:overlapMode};grid.insert(key,collisionBox[0],collisionBox[1],collisionBox[2],collisionBox[3])}insertCollisionCircles(collisionCircles,overlapMode,ignorePlacement,bucketInstanceId,featureIndex,collisionGroupID){const grid=ignorePlacement?this.ignoredGrid:this.grid;const key={bucketInstanceId:bucketInstanceId,featureIndex:featureIndex,collisionGroupID:collisionGroupID,overlapMode:overlapMode};for(let k=0;k<collisionCircles.length;k+=4){grid.insertCircle(key,collisionCircles[k],collisionCircles[k+1],collisionCircles[k+2])}}projectAndGetPerspectiveRatio(posMatrix,x,y,getElevation){let p;if(getElevation){p=[x,y,getElevation(x,y),1];performance$1.transformMat4(p,p,posMatrix)}else{p=[x,y,0,1];xyTransformMat4(p,p,posMatrix)}const a=new performance$1.Point((p[0]/p[3]+1)/2*this.transform.width+viewportPadding,(-p[1]/p[3]+1)/2*this.transform.height+viewportPadding);return{point:a,perspectiveRatio:.5+.5*(this.transform.cameraToCenterDistance/p[3])}}isOffscreen(x1,y1,x2,y2){return x2<viewportPadding||x1>=this.screenRightBoundary||y2<viewportPadding||y1>this.screenBottomBoundary}isInsideGrid(x1,y1,x2,y2){return x2>=0&&x1<this.gridRightBoundary&&y2>=0&&y1<this.gridBottomBoundary}getViewportMatrix(){const m=performance$1.identity([]);performance$1.translate(m,m,[-viewportPadding,-viewportPadding,0]);return m}}function pixelsToTileUnits(tile,pixelValue,z){return pixelValue*(performance$1.EXTENT/(tile.tileSize*Math.pow(2,z-tile.tileID.overscaledZ)))}class OpacityState{constructor(prevState,increment,placed,skipFade){if(prevState){this.opacity=Math.max(0,Math.min(1,prevState.opacity+(prevState.placed?increment:-increment)))}else{this.opacity=skipFade&&placed?1:0}this.placed=placed}isHidden(){return this.opacity===0&&!this.placed}}class JointOpacityState{constructor(prevState,increment,placedText,placedIcon,skipFade){this.text=new OpacityState(prevState?prevState.text:null,increment,placedText,skipFade);this.icon=new OpacityState(prevState?prevState.icon:null,increment,placedIcon,skipFade)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class JointPlacement{constructor(text,icon,skipFade){this.text=text;this.icon=icon;this.skipFade=skipFade}}class CollisionCircleArray{constructor(){this.invProjMatrix=performance$1.create();this.viewportMatrix=performance$1.create();this.circles=[]}}class RetainedQueryData{constructor(bucketInstanceId,featureIndex,sourceLayerIndex,bucketIndex,tileID){this.bucketInstanceId=bucketInstanceId;this.featureIndex=featureIndex;this.sourceLayerIndex=sourceLayerIndex;this.bucketIndex=bucketIndex;this.tileID=tileID}}class CollisionGroups{constructor(crossSourceCollisions){this.crossSourceCollisions=crossSourceCollisions;this.maxGroupID=0;this.collisionGroups={}}get(sourceID){if(!this.crossSourceCollisions){if(!this.collisionGroups[sourceID]){const nextGroupID=++this.maxGroupID;this.collisionGroups[sourceID]={ID:nextGroupID,predicate:key=>key.collisionGroupID===nextGroupID}}return this.collisionGroups[sourceID]}else{return{ID:0,predicate:null}}}}function calculateVariableLayoutShift(anchor,width,height,textOffset,textBoxScale){const{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}=performance$1.getAnchorAlignment(anchor);const shiftX=-(horizontalAlign-.5)*width;const shiftY=-(verticalAlign-.5)*height;return new performance$1.Point(shiftX+textOffset[0]*textBoxScale,shiftY+textOffset[1]*textBoxScale)}function shiftVariableCollisionBox(collisionBox,shiftX,shiftY,rotateWithMap,pitchWithMap,angle){const{x1:x1,x2:x2,y1:y1,y2:y2,anchorPointX:anchorPointX,anchorPointY:anchorPointY}=collisionBox;const rotatedOffset=new performance$1.Point(shiftX,shiftY);if(rotateWithMap){rotatedOffset._rotate(pitchWithMap?angle:-angle)}return{x1:x1+rotatedOffset.x,y1:y1+rotatedOffset.y,x2:x2+rotatedOffset.x,y2:y2+rotatedOffset.y,anchorPointX:anchorPointX,anchorPointY:anchorPointY}}class Placement{constructor(transform,terrain,fadeDuration,crossSourceCollisions,prevPlacement){this.transform=transform.clone();this.terrain=terrain;this.collisionIndex=new CollisionIndex(this.transform);this.placements={};this.opacities={};this.variableOffsets={};this.stale=false;this.commitTime=0;this.fadeDuration=fadeDuration;this.retainedQueryData={};this.collisionGroups=new CollisionGroups(crossSourceCollisions);this.collisionCircleArrays={};this.prevPlacement=prevPlacement;if(prevPlacement){prevPlacement.prevPlacement=undefined}this.placedOrientations={}}getBucketParts(results,styleLayer,tile,sortAcrossTiles){const symbolBucket=tile.getBucket(styleLayer);const bucketFeatureIndex=tile.latestFeatureIndex;if(!symbolBucket||!bucketFeatureIndex||styleLayer.id!==symbolBucket.layerIds[0])return;const collisionBoxArray=tile.collisionBoxArray;const layout=symbolBucket.layers[0].layout;const scale=Math.pow(2,this.transform.zoom-tile.tileID.overscaledZ);const textPixelRatio=tile.tileSize/performance$1.EXTENT;const posMatrix=this.transform.calculatePosMatrix(tile.tileID.toUnwrapped());const pitchWithMap=layout.get("text-pitch-alignment")==="map";const rotateWithMap=layout.get("text-rotation-alignment")==="map";const pixelsToTiles=pixelsToTileUnits(tile,1,this.transform.zoom);const textLabelPlaneMatrix=getLabelPlaneMatrix(posMatrix,pitchWithMap,rotateWithMap,this.transform,pixelsToTiles);let labelToScreenMatrix=null;if(pitchWithMap){const glMatrix=getGlCoordMatrix(posMatrix,pitchWithMap,rotateWithMap,this.transform,pixelsToTiles);labelToScreenMatrix=performance$1.multiply([],this.transform.labelPlaneMatrix,glMatrix)}this.retainedQueryData[symbolBucket.bucketInstanceId]=new RetainedQueryData(symbolBucket.bucketInstanceId,bucketFeatureIndex,symbolBucket.sourceLayerIndex,symbolBucket.index,tile.tileID);const parameters={bucket:symbolBucket,layout:layout,posMatrix:posMatrix,textLabelPlaneMatrix:textLabelPlaneMatrix,labelToScreenMatrix:labelToScreenMatrix,scale:scale,textPixelRatio:textPixelRatio,holdingForFade:tile.holdingForFade(),collisionBoxArray:collisionBoxArray,partiallyEvaluatedTextSize:performance$1.evaluateSizeForZoom(symbolBucket.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(symbolBucket.sourceID)};if(sortAcrossTiles){for(const range of symbolBucket.sortKeyRanges){const{sortKey:sortKey,symbolInstanceStart:symbolInstanceStart,symbolInstanceEnd:symbolInstanceEnd}=range;results.push({sortKey:sortKey,symbolInstanceStart:symbolInstanceStart,symbolInstanceEnd:symbolInstanceEnd,parameters:parameters})}}else{results.push({symbolInstanceStart:0,symbolInstanceEnd:symbolBucket.symbolInstances.length,parameters:parameters})}}attemptAnchorPlacement(textAnchorOffset,textBox,width,height,textBoxScale,rotateWithMap,pitchWithMap,textPixelRatio,posMatrix,collisionGroup,textOverlapMode,symbolInstance,bucket,orientation,iconBox,getElevation){const anchor=performance$1.TextAnchorEnum[textAnchorOffset.textAnchor];const textOffset=[textAnchorOffset.textOffset0,textAnchorOffset.textOffset1];const shift=calculateVariableLayoutShift(anchor,width,height,textOffset,textBoxScale);const placedGlyphBoxes=this.collisionIndex.placeCollisionBox(shiftVariableCollisionBox(textBox,shift.x,shift.y,rotateWithMap,pitchWithMap,this.transform.angle),textOverlapMode,textPixelRatio,posMatrix,collisionGroup.predicate,getElevation);if(iconBox){const placedIconBoxes=this.collisionIndex.placeCollisionBox(shiftVariableCollisionBox(iconBox,shift.x,shift.y,rotateWithMap,pitchWithMap,this.transform.angle),textOverlapMode,textPixelRatio,posMatrix,collisionGroup.predicate,getElevation);if(placedIconBoxes.box.length===0)return}if(placedGlyphBoxes.box.length>0){let prevAnchor;if(this.prevPlacement&&this.prevPlacement.variableOffsets[symbolInstance.crossTileID]&&this.prevPlacement.placements[symbolInstance.crossTileID]&&this.prevPlacement.placements[symbolInstance.crossTileID].text){prevAnchor=this.prevPlacement.variableOffsets[symbolInstance.crossTileID].anchor}if(symbolInstance.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");this.variableOffsets[symbolInstance.crossTileID]={textOffset:textOffset,width:width,height:height,anchor:anchor,textBoxScale:textBoxScale,prevAnchor:prevAnchor};this.markUsedJustification(bucket,anchor,symbolInstance,orientation);if(bucket.allowVerticalPlacement){this.markUsedOrientation(bucket,orientation,symbolInstance);this.placedOrientations[symbolInstance.crossTileID]=orientation}return{shift:shift,placedGlyphBoxes:placedGlyphBoxes}}}placeLayerBucketPart(bucketPart,seenCrossTileIDs,showCollisionBoxes){const{bucket:bucket,layout:layout,posMatrix:posMatrix,textLabelPlaneMatrix:textLabelPlaneMatrix,labelToScreenMatrix:labelToScreenMatrix,textPixelRatio:textPixelRatio,holdingForFade:holdingForFade,collisionBoxArray:collisionBoxArray,partiallyEvaluatedTextSize:partiallyEvaluatedTextSize,collisionGroup:collisionGroup}=bucketPart.parameters;const textOptional=layout.get("text-optional");const iconOptional=layout.get("icon-optional");const textOverlapMode=performance$1.getOverlapMode(layout,"text-overlap","text-allow-overlap");const textAlwaysOverlap=textOverlapMode==="always";const iconOverlapMode=performance$1.getOverlapMode(layout,"icon-overlap","icon-allow-overlap");const iconAlwaysOverlap=iconOverlapMode==="always";const rotateWithMap=layout.get("text-rotation-alignment")==="map";const pitchWithMap=layout.get("text-pitch-alignment")==="map";const hasIconTextFit=layout.get("icon-text-fit")!=="none";const zOrderByViewportY=layout.get("symbol-z-order")==="viewport-y";const alwaysShowText=textAlwaysOverlap&&(iconAlwaysOverlap||!bucket.hasIconData()||iconOptional);const alwaysShowIcon=iconAlwaysOverlap&&(textAlwaysOverlap||!bucket.hasTextData()||textOptional);if(!bucket.collisionArrays&&collisionBoxArray){bucket.deserializeCollisionBoxes(collisionBoxArray)}const tileID=this.retainedQueryData[bucket.bucketInstanceId].tileID;const getElevation=this.terrain?(x,y)=>this.terrain.getElevation(tileID,x,y):null;const placeSymbol=(symbolInstance,collisionArrays)=>{var _a,_b;if(seenCrossTileIDs[symbolInstance.crossTileID])return;if(holdingForFade){this.placements[symbolInstance.crossTileID]=new JointPlacement(false,false,false);return}let placeText=false;let placeIcon=false;let offscreen=true;let shift=null;let placed={box:null,offscreen:null};let placedVerticalText={box:null,offscreen:null};let placedGlyphBoxes=null;let placedGlyphCircles=null;let placedIconBoxes=null;let textFeatureIndex=0;let verticalTextFeatureIndex=0;let iconFeatureIndex=0;if(collisionArrays.textFeatureIndex){textFeatureIndex=collisionArrays.textFeatureIndex}else if(symbolInstance.useRuntimeCollisionCircles){textFeatureIndex=symbolInstance.featureIndex}if(collisionArrays.verticalTextFeatureIndex){verticalTextFeatureIndex=collisionArrays.verticalTextFeatureIndex}const textBox=collisionArrays.textBox;if(textBox){const updatePreviousOrientationIfNotPlaced=isPlaced=>{let previousOrientation=performance$1.WritingMode.horizontal;if(bucket.allowVerticalPlacement&&!isPlaced&&this.prevPlacement){const prevPlacedOrientation=this.prevPlacement.placedOrientations[symbolInstance.crossTileID];if(prevPlacedOrientation){this.placedOrientations[symbolInstance.crossTileID]=prevPlacedOrientation;previousOrientation=prevPlacedOrientation;this.markUsedOrientation(bucket,previousOrientation,symbolInstance)}}return previousOrientation};const placeTextForPlacementModes=(placeHorizontalFn,placeVerticalFn)=>{if(bucket.allowVerticalPlacement&&symbolInstance.numVerticalGlyphVertices>0&&collisionArrays.verticalTextBox){for(const placementMode of bucket.writingModes){if(placementMode===performance$1.WritingMode.vertical){placed=placeVerticalFn();placedVerticalText=placed}else{placed=placeHorizontalFn()}if(placed&&placed.box&&placed.box.length)break}}else{placed=placeHorizontalFn()}};const textAnchorOffsetStart=symbolInstance.textAnchorOffsetStartIndex;const textAnchorOffsetEnd=symbolInstance.textAnchorOffsetEndIndex;if(textAnchorOffsetEnd===textAnchorOffsetStart){const placeBox=(collisionTextBox,orientation)=>{const placedFeature=this.collisionIndex.placeCollisionBox(collisionTextBox,textOverlapMode,textPixelRatio,posMatrix,collisionGroup.predicate,getElevation);if(placedFeature&&placedFeature.box&&placedFeature.box.length){this.markUsedOrientation(bucket,orientation,symbolInstance);this.placedOrientations[symbolInstance.crossTileID]=orientation}return placedFeature};const placeHorizontal=()=>placeBox(textBox,performance$1.WritingMode.horizontal);const placeVertical=()=>{const verticalTextBox=collisionArrays.verticalTextBox;if(bucket.allowVerticalPlacement&&symbolInstance.numVerticalGlyphVertices>0&&verticalTextBox){return placeBox(verticalTextBox,performance$1.WritingMode.vertical)}return{box:null,offscreen:null}};placeTextForPlacementModes(placeHorizontal,placeVertical);updatePreviousOrientationIfNotPlaced(placed&&placed.box&&placed.box.length)}else{let prevAnchor=performance$1.TextAnchorEnum[(_b=(_a=this.prevPlacement)===null||_a===void 0?void 0:_a.variableOffsets[symbolInstance.crossTileID])===null||_b===void 0?void 0:_b.anchor];const placeBoxForVariableAnchors=(collisionTextBox,collisionIconBox,orientation)=>{const width=collisionTextBox.x2-collisionTextBox.x1;const height=collisionTextBox.y2-collisionTextBox.y1;const textBoxScale=symbolInstance.textBoxScale;const variableIconBox=hasIconTextFit&&iconOverlapMode==="never"?collisionIconBox:null;let placedBox={box:[],offscreen:false};let placementPasses=textOverlapMode==="never"?1:2;let overlapMode="never";if(prevAnchor){placementPasses++}for(let pass=0;pass<placementPasses;pass++){for(let i=textAnchorOffsetStart;i<textAnchorOffsetEnd;i++){const textAnchorOffset=bucket.textAnchorOffsets.get(i);if(prevAnchor&&textAnchorOffset.textAnchor!==prevAnchor){continue}const result=this.attemptAnchorPlacement(textAnchorOffset,collisionTextBox,width,height,textBoxScale,rotateWithMap,pitchWithMap,textPixelRatio,posMatrix,collisionGroup,overlapMode,symbolInstance,bucket,orientation,variableIconBox,getElevation);if(result){placedBox=result.placedGlyphBoxes;if(placedBox&&placedBox.box&&placedBox.box.length){placeText=true;shift=result.shift;return placedBox}}}if(prevAnchor){prevAnchor=null}else{overlapMode=textOverlapMode}}return placedBox};const placeHorizontal=()=>placeBoxForVariableAnchors(textBox,collisionArrays.iconBox,performance$1.WritingMode.horizontal);const placeVertical=()=>{const verticalTextBox=collisionArrays.verticalTextBox;const wasPlaced=placed&&placed.box&&placed.box.length;if(bucket.allowVerticalPlacement&&!wasPlaced&&symbolInstance.numVerticalGlyphVertices>0&&verticalTextBox){return placeBoxForVariableAnchors(verticalTextBox,collisionArrays.verticalIconBox,performance$1.WritingMode.vertical)}return{box:null,offscreen:null}};placeTextForPlacementModes(placeHorizontal,placeVertical);if(placed){placeText=placed.box;offscreen=placed.offscreen}const prevOrientation=updatePreviousOrientationIfNotPlaced(placed&&placed.box);if(!placeText&&this.prevPlacement){const prevOffset=this.prevPlacement.variableOffsets[symbolInstance.crossTileID];if(prevOffset){this.variableOffsets[symbolInstance.crossTileID]=prevOffset;this.markUsedJustification(bucket,prevOffset.anchor,symbolInstance,prevOrientation)}}}}placedGlyphBoxes=placed;placeText=placedGlyphBoxes&&placedGlyphBoxes.box&&placedGlyphBoxes.box.length>0;offscreen=placedGlyphBoxes&&placedGlyphBoxes.offscreen;if(symbolInstance.useRuntimeCollisionCircles){const placedSymbol=bucket.text.placedSymbolArray.get(symbolInstance.centerJustifiedTextSymbolIndex);const fontSize=performance$1.evaluateSizeForFeature(bucket.textSizeData,partiallyEvaluatedTextSize,placedSymbol);const textPixelPadding=layout.get("text-padding");const circlePixelDiameter=symbolInstance.collisionCircleDiameter;placedGlyphCircles=this.collisionIndex.placeCollisionCircles(textOverlapMode,placedSymbol,bucket.lineVertexArray,bucket.glyphOffsetArray,fontSize,posMatrix,textLabelPlaneMatrix,labelToScreenMatrix,showCollisionBoxes,pitchWithMap,collisionGroup.predicate,circlePixelDiameter,textPixelPadding,getElevation);if(placedGlyphCircles.circles.length&&placedGlyphCircles.collisionDetected&&!showCollisionBoxes){performance$1.warnOnce("Collisions detected, but collision boxes are not shown")}placeText=textAlwaysOverlap||placedGlyphCircles.circles.length>0&&!placedGlyphCircles.collisionDetected;offscreen=offscreen&&placedGlyphCircles.offscreen}if(collisionArrays.iconFeatureIndex){iconFeatureIndex=collisionArrays.iconFeatureIndex}if(collisionArrays.iconBox){const placeIconFeature=iconBox=>{const shiftedIconBox=hasIconTextFit&&shift?shiftVariableCollisionBox(iconBox,shift.x,shift.y,rotateWithMap,pitchWithMap,this.transform.angle):iconBox;return this.collisionIndex.placeCollisionBox(shiftedIconBox,iconOverlapMode,textPixelRatio,posMatrix,collisionGroup.predicate,getElevation)};if(placedVerticalText&&placedVerticalText.box&&placedVerticalText.box.length&&collisionArrays.verticalIconBox){placedIconBoxes=placeIconFeature(collisionArrays.verticalIconBox);placeIcon=placedIconBoxes.box.length>0}else{placedIconBoxes=placeIconFeature(collisionArrays.iconBox);placeIcon=placedIconBoxes.box.length>0}offscreen=offscreen&&placedIconBoxes.offscreen}const iconWithoutText=textOptional||symbolInstance.numHorizontalGlyphVertices===0&&symbolInstance.numVerticalGlyphVertices===0;const textWithoutIcon=iconOptional||symbolInstance.numIconVertices===0;if(!iconWithoutText&&!textWithoutIcon){placeIcon=placeText=placeIcon&&placeText}else if(!textWithoutIcon){placeText=placeIcon&&placeText}else if(!iconWithoutText){placeIcon=placeIcon&&placeText}if(placeText&&placedGlyphBoxes&&placedGlyphBoxes.box){if(placedVerticalText&&placedVerticalText.box&&verticalTextFeatureIndex){this.collisionIndex.insertCollisionBox(placedGlyphBoxes.box,textOverlapMode,layout.get("text-ignore-placement"),bucket.bucketInstanceId,verticalTextFeatureIndex,collisionGroup.ID)}else{this.collisionIndex.insertCollisionBox(placedGlyphBoxes.box,textOverlapMode,layout.get("text-ignore-placement"),bucket.bucketInstanceId,textFeatureIndex,collisionGroup.ID)}}if(placeIcon&&placedIconBoxes){this.collisionIndex.insertCollisionBox(placedIconBoxes.box,iconOverlapMode,layout.get("icon-ignore-placement"),bucket.bucketInstanceId,iconFeatureIndex,collisionGroup.ID)}if(placedGlyphCircles){if(placeText){this.collisionIndex.insertCollisionCircles(placedGlyphCircles.circles,textOverlapMode,layout.get("text-ignore-placement"),bucket.bucketInstanceId,textFeatureIndex,collisionGroup.ID)}if(showCollisionBoxes){const id=bucket.bucketInstanceId;let circleArray=this.collisionCircleArrays[id];if(circleArray===undefined)circleArray=this.collisionCircleArrays[id]=new CollisionCircleArray;for(let i=0;i<placedGlyphCircles.circles.length;i+=4){circleArray.circles.push(placedGlyphCircles.circles[i+0]);circleArray.circles.push(placedGlyphCircles.circles[i+1]);circleArray.circles.push(placedGlyphCircles.circles[i+2]);circleArray.circles.push(placedGlyphCircles.collisionDetected?1:0)}}}if(symbolInstance.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(bucket.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[symbolInstance.crossTileID]=new JointPlacement(placeText||alwaysShowText,placeIcon||alwaysShowIcon,offscreen||bucket.justReloaded);seenCrossTileIDs[symbolInstance.crossTileID]=true};if(zOrderByViewportY){if(bucketPart.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const symbolIndexes=bucket.getSortedSymbolIndexes(this.transform.angle);for(let i=symbolIndexes.length-1;i>=0;--i){const symbolIndex=symbolIndexes[i];placeSymbol(bucket.symbolInstances.get(symbolIndex),bucket.collisionArrays[symbolIndex])}}else{for(let i=bucketPart.symbolInstanceStart;i<bucketPart.symbolInstanceEnd;i++){placeSymbol(bucket.symbolInstances.get(i),bucket.collisionArrays[i])}}if(showCollisionBoxes&&bucket.bucketInstanceId in this.collisionCircleArrays){const circleArray=this.collisionCircleArrays[bucket.bucketInstanceId];performance$1.invert(circleArray.invProjMatrix,posMatrix);circleArray.viewportMatrix=this.collisionIndex.getViewportMatrix()}bucket.justReloaded=false}markUsedJustification(bucket,placedAnchor,symbolInstance,orientation){const justifications={left:symbolInstance.leftJustifiedTextSymbolIndex,center:symbolInstance.centerJustifiedTextSymbolIndex,right:symbolInstance.rightJustifiedTextSymbolIndex};let autoIndex;if(orientation===performance$1.WritingMode.vertical){autoIndex=symbolInstance.verticalPlacedTextSymbolIndex}else{autoIndex=justifications[performance$1.getAnchorJustification(placedAnchor)]}const indexes=[symbolInstance.leftJustifiedTextSymbolIndex,symbolInstance.centerJustifiedTextSymbolIndex,symbolInstance.rightJustifiedTextSymbolIndex,symbolInstance.verticalPlacedTextSymbolIndex];for(const index of indexes){if(index>=0){if(autoIndex>=0&&index!==autoIndex){bucket.text.placedSymbolArray.get(index).crossTileID=0}else{bucket.text.placedSymbolArray.get(index).crossTileID=symbolInstance.crossTileID}}}}markUsedOrientation(bucket,orientation,symbolInstance){const horizontal=orientation===performance$1.WritingMode.horizontal||orientation===performance$1.WritingMode.horizontalOnly?orientation:0;const vertical=orientation===performance$1.WritingMode.vertical?orientation:0;const horizontalIndexes=[symbolInstance.leftJustifiedTextSymbolIndex,symbolInstance.centerJustifiedTextSymbolIndex,symbolInstance.rightJustifiedTextSymbolIndex];for(const index of horizontalIndexes){bucket.text.placedSymbolArray.get(index).placedOrientation=horizontal}if(symbolInstance.verticalPlacedTextSymbolIndex){bucket.text.placedSymbolArray.get(symbolInstance.verticalPlacedTextSymbolIndex).placedOrientation=vertical}}commit(now){this.commitTime=now;this.zoomAtLastRecencyCheck=this.transform.zoom;const prevPlacement=this.prevPlacement;let placementChanged=false;this.prevZoomAdjustment=prevPlacement?prevPlacement.zoomAdjustment(this.transform.zoom):0;const increment=prevPlacement?prevPlacement.symbolFadeChange(now):1;const prevOpacities=prevPlacement?prevPlacement.opacities:{};const prevOffsets=prevPlacement?prevPlacement.variableOffsets:{};const prevOrientations=prevPlacement?prevPlacement.placedOrientations:{};for(const crossTileID in this.placements){const jointPlacement=this.placements[crossTileID];const prevOpacity=prevOpacities[crossTileID];if(prevOpacity){this.opacities[crossTileID]=new JointOpacityState(prevOpacity,increment,jointPlacement.text,jointPlacement.icon);placementChanged=placementChanged||jointPlacement.text!==prevOpacity.text.placed||jointPlacement.icon!==prevOpacity.icon.placed}else{this.opacities[crossTileID]=new JointOpacityState(null,increment,jointPlacement.text,jointPlacement.icon,jointPlacement.skipFade);placementChanged=placementChanged||jointPlacement.text||jointPlacement.icon}}for(const crossTileID in prevOpacities){const prevOpacity=prevOpacities[crossTileID];if(!this.opacities[crossTileID]){const jointOpacity=new JointOpacityState(prevOpacity,increment,false,false);if(!jointOpacity.isHidden()){this.opacities[crossTileID]=jointOpacity;placementChanged=placementChanged||prevOpacity.text.placed||prevOpacity.icon.placed}}}for(const crossTileID in prevOffsets){if(!this.variableOffsets[crossTileID]&&this.opacities[crossTileID]&&!this.opacities[crossTileID].isHidden()){this.variableOffsets[crossTileID]=prevOffsets[crossTileID]}}for(const crossTileID in prevOrientations){if(!this.placedOrientations[crossTileID]&&this.opacities[crossTileID]&&!this.opacities[crossTileID].isHidden()){this.placedOrientations[crossTileID]=prevOrientations[crossTileID]}}if(prevPlacement&&prevPlacement.lastPlacementChangeTime===undefined){throw new Error("Last placement time for previous placement is not defined")}if(placementChanged){this.lastPlacementChangeTime=now}else if(typeof this.lastPlacementChangeTime!=="number"){this.lastPlacementChangeTime=prevPlacement?prevPlacement.lastPlacementChangeTime:now}}updateLayerOpacities(styleLayer,tiles){const seenCrossTileIDs={};for(const tile of tiles){const symbolBucket=tile.getBucket(styleLayer);if(symbolBucket&&tile.latestFeatureIndex&&styleLayer.id===symbolBucket.layerIds[0]){this.updateBucketOpacities(symbolBucket,seenCrossTileIDs,tile.collisionBoxArray)}}}updateBucketOpacities(bucket,seenCrossTileIDs,collisionBoxArray){if(bucket.hasTextData()){bucket.text.opacityVertexArray.clear();bucket.text.hasVisibleVertices=false}if(bucket.hasIconData()){bucket.icon.opacityVertexArray.clear();bucket.icon.hasVisibleVertices=false}if(bucket.hasIconCollisionBoxData())bucket.iconCollisionBox.collisionVertexArray.clear();if(bucket.hasTextCollisionBoxData())bucket.textCollisionBox.collisionVertexArray.clear();const layer=bucket.layers[0];const layout=layer.layout;const duplicateOpacityState=new JointOpacityState(null,0,false,false,true);const textAllowOverlap=layout.get("text-allow-overlap");const iconAllowOverlap=layout.get("icon-allow-overlap");const hasVariablePlacement=layer._unevaluatedLayout.hasValue("text-variable-anchor")||layer._unevaluatedLayout.hasValue("text-variable-anchor-offset");const rotateWithMap=layout.get("text-rotation-alignment")==="map";const pitchWithMap=layout.get("text-pitch-alignment")==="map";const hasIconTextFit=layout.get("icon-text-fit")!=="none";const defaultOpacityState=new JointOpacityState(null,0,textAllowOverlap&&(iconAllowOverlap||!bucket.hasIconData()||layout.get("icon-optional")),iconAllowOverlap&&(textAllowOverlap||!bucket.hasTextData()||layout.get("text-optional")),true);if(!bucket.collisionArrays&&collisionBoxArray&&(bucket.hasIconCollisionBoxData()||bucket.hasTextCollisionBoxData())){bucket.deserializeCollisionBoxes(collisionBoxArray)}const addOpacities=(iconOrText,numVertices,opacity)=>{for(let i=0;i<numVertices/4;i++){iconOrText.opacityVertexArray.emplaceBack(opacity)}iconOrText.hasVisibleVertices=iconOrText.hasVisibleVertices||opacity!==PACKED_HIDDEN_OPACITY};for(let s=0;s<bucket.symbolInstances.length;s++){const symbolInstance=bucket.symbolInstances.get(s);const{numHorizontalGlyphVertices:numHorizontalGlyphVertices,numVerticalGlyphVertices:numVerticalGlyphVertices,crossTileID:crossTileID}=symbolInstance;const isDuplicate=seenCrossTileIDs[crossTileID];let opacityState=this.opacities[crossTileID];if(isDuplicate){opacityState=duplicateOpacityState}else if(!opacityState){opacityState=defaultOpacityState;this.opacities[crossTileID]=opacityState}seenCrossTileIDs[crossTileID]=true;const hasText=numHorizontalGlyphVertices>0||numVerticalGlyphVertices>0;const hasIcon=symbolInstance.numIconVertices>0;const placedOrientation=this.placedOrientations[symbolInstance.crossTileID];const horizontalHidden=placedOrientation===performance$1.WritingMode.vertical;const verticalHidden=placedOrientation===performance$1.WritingMode.horizontal||placedOrientation===performance$1.WritingMode.horizontalOnly;if(hasText){const packedOpacity=packOpacity(opacityState.text);const horizontalOpacity=horizontalHidden?PACKED_HIDDEN_OPACITY:packedOpacity;addOpacities(bucket.text,numHorizontalGlyphVertices,horizontalOpacity);const verticalOpacity=verticalHidden?PACKED_HIDDEN_OPACITY:packedOpacity;addOpacities(bucket.text,numVerticalGlyphVertices,verticalOpacity);const symbolHidden=opacityState.text.isHidden();[symbolInstance.rightJustifiedTextSymbolIndex,symbolInstance.centerJustifiedTextSymbolIndex,symbolInstance.leftJustifiedTextSymbolIndex].forEach((index=>{if(index>=0){bucket.text.placedSymbolArray.get(index).hidden=symbolHidden||horizontalHidden?1:0}}));if(symbolInstance.verticalPlacedTextSymbolIndex>=0){bucket.text.placedSymbolArray.get(symbolInstance.verticalPlacedTextSymbolIndex).hidden=symbolHidden||verticalHidden?1:0}const prevOffset=this.variableOffsets[symbolInstance.crossTileID];if(prevOffset){this.markUsedJustification(bucket,prevOffset.anchor,symbolInstance,placedOrientation)}const prevOrientation=this.placedOrientations[symbolInstance.crossTileID];if(prevOrientation){this.markUsedJustification(bucket,"left",symbolInstance,prevOrientation);this.markUsedOrientation(bucket,prevOrientation,symbolInstance)}}if(hasIcon){const packedOpacity=packOpacity(opacityState.icon);const useHorizontal=!(hasIconTextFit&&symbolInstance.verticalPlacedIconSymbolIndex&&horizontalHidden);if(symbolInstance.placedIconSymbolIndex>=0){const horizontalOpacity=useHorizontal?packedOpacity:PACKED_HIDDEN_OPACITY;addOpacities(bucket.icon,symbolInstance.numIconVertices,horizontalOpacity);bucket.icon.placedSymbolArray.get(symbolInstance.placedIconSymbolIndex).hidden=opacityState.icon.isHidden()}if(symbolInstance.verticalPlacedIconSymbolIndex>=0){const verticalOpacity=!useHorizontal?packedOpacity:PACKED_HIDDEN_OPACITY;addOpacities(bucket.icon,symbolInstance.numVerticalIconVertices,verticalOpacity);bucket.icon.placedSymbolArray.get(symbolInstance.verticalPlacedIconSymbolIndex).hidden=opacityState.icon.isHidden()}}if(bucket.hasIconCollisionBoxData()||bucket.hasTextCollisionBoxData()){const collisionArrays=bucket.collisionArrays[s];if(collisionArrays){let shift=new performance$1.Point(0,0);if(collisionArrays.textBox||collisionArrays.verticalTextBox){let used=true;if(hasVariablePlacement){const variableOffset=this.variableOffsets[crossTileID];if(variableOffset){shift=calculateVariableLayoutShift(variableOffset.anchor,variableOffset.width,variableOffset.height,variableOffset.textOffset,variableOffset.textBoxScale);if(rotateWithMap){shift._rotate(pitchWithMap?this.transform.angle:-this.transform.angle)}}else{used=false}}if(collisionArrays.textBox){updateCollisionVertices(bucket.textCollisionBox.collisionVertexArray,opacityState.text.placed,!used||horizontalHidden,shift.x,shift.y)}if(collisionArrays.verticalTextBox){updateCollisionVertices(bucket.textCollisionBox.collisionVertexArray,opacityState.text.placed,!used||verticalHidden,shift.x,shift.y)}}const verticalIconUsed=Boolean(!verticalHidden&&collisionArrays.verticalIconBox);if(collisionArrays.iconBox){updateCollisionVertices(bucket.iconCollisionBox.collisionVertexArray,opacityState.icon.placed,verticalIconUsed,hasIconTextFit?shift.x:0,hasIconTextFit?shift.y:0)}if(collisionArrays.verticalIconBox){updateCollisionVertices(bucket.iconCollisionBox.collisionVertexArray,opacityState.icon.placed,!verticalIconUsed,hasIconTextFit?shift.x:0,hasIconTextFit?shift.y:0)}}}}bucket.sortFeatures(this.transform.angle);if(this.retainedQueryData[bucket.bucketInstanceId]){this.retainedQueryData[bucket.bucketInstanceId].featureSortOrder=bucket.featureSortOrder}if(bucket.hasTextData()&&bucket.text.opacityVertexBuffer){bucket.text.opacityVertexBuffer.updateData(bucket.text.opacityVertexArray)}if(bucket.hasIconData()&&bucket.icon.opacityVertexBuffer){bucket.icon.opacityVertexBuffer.updateData(bucket.icon.opacityVertexArray)}if(bucket.hasIconCollisionBoxData()&&bucket.iconCollisionBox.collisionVertexBuffer){bucket.iconCollisionBox.collisionVertexBuffer.updateData(bucket.iconCollisionBox.collisionVertexArray)}if(bucket.hasTextCollisionBoxData()&&bucket.textCollisionBox.collisionVertexBuffer){bucket.textCollisionBox.collisionVertexBuffer.updateData(bucket.textCollisionBox.collisionVertexArray)}if(bucket.text.opacityVertexArray.length!==bucket.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${bucket.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${bucket.text.layoutVertexArray.length}) / 4`);if(bucket.icon.opacityVertexArray.length!==bucket.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${bucket.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${bucket.icon.layoutVertexArray.length}) / 4`);if(bucket.bucketInstanceId in this.collisionCircleArrays){const instance=this.collisionCircleArrays[bucket.bucketInstanceId];bucket.placementInvProjMatrix=instance.invProjMatrix;bucket.placementViewportMatrix=instance.viewportMatrix;bucket.collisionCircleArray=instance.circles;delete this.collisionCircleArrays[bucket.bucketInstanceId]}}symbolFadeChange(now){return this.fadeDuration===0?1:(now-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(zoom){return Math.max(0,(this.transform.zoom-zoom)/1.5)}hasTransitions(now){return this.stale||now-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(now,zoom){const durationAdjustment=this.zoomAtLastRecencyCheck===zoom?1-this.zoomAdjustment(zoom):1;this.zoomAtLastRecencyCheck=zoom;return this.commitTime+this.fadeDuration*durationAdjustment>now}setStale(){this.stale=true}}function updateCollisionVertices(collisionVertexArray,placed,notUsed,shiftX,shiftY){collisionVertexArray.emplaceBack(placed?1:0,notUsed?1:0,shiftX||0,shiftY||0);collisionVertexArray.emplaceBack(placed?1:0,notUsed?1:0,shiftX||0,shiftY||0);collisionVertexArray.emplaceBack(placed?1:0,notUsed?1:0,shiftX||0,shiftY||0);collisionVertexArray.emplaceBack(placed?1:0,notUsed?1:0,shiftX||0,shiftY||0)}const shift25=Math.pow(2,25);const shift24=Math.pow(2,24);const shift17=Math.pow(2,17);const shift16=Math.pow(2,16);const shift9=Math.pow(2,9);const shift8=Math.pow(2,8);const shift1=Math.pow(2,1);function packOpacity(opacityState){if(opacityState.opacity===0&&!opacityState.placed){return 0}else if(opacityState.opacity===1&&opacityState.placed){return 4294967295}const targetBit=opacityState.placed?1:0;const opacityBits=Math.floor(opacityState.opacity*127);return opacityBits*shift25+targetBit*shift24+opacityBits*shift17+targetBit*shift16+opacityBits*shift9+targetBit*shift8+opacityBits*shift1+targetBit}const PACKED_HIDDEN_OPACITY=0;class LayerPlacement{constructor(styleLayer){this._sortAcrossTiles=styleLayer.layout.get("symbol-z-order")!=="viewport-y"&&!styleLayer.layout.get("symbol-sort-key").isConstant();this._currentTileIndex=0;this._currentPartIndex=0;this._seenCrossTileIDs={};this._bucketParts=[]}continuePlacement(tiles,placement,showCollisionBoxes,styleLayer,shouldPausePlacement){const bucketParts=this._bucketParts;while(this._currentTileIndex<tiles.length){const tile=tiles[this._currentTileIndex];placement.getBucketParts(bucketParts,styleLayer,tile,this._sortAcrossTiles);this._currentTileIndex++;if(shouldPausePlacement()){return true}}if(this._sortAcrossTiles){this._sortAcrossTiles=false;bucketParts.sort(((a,b)=>a.sortKey-b.sortKey))}while(this._currentPartIndex<bucketParts.length){const bucketPart=bucketParts[this._currentPartIndex];placement.placeLayerBucketPart(bucketPart,this._seenCrossTileIDs,showCollisionBoxes);this._currentPartIndex++;if(shouldPausePlacement()){return true}}return false}}class PauseablePlacement{constructor(transform,terrain,order,forceFullPlacement,showCollisionBoxes,fadeDuration,crossSourceCollisions,prevPlacement){this.placement=new Placement(transform,terrain,fadeDuration,crossSourceCollisions,prevPlacement);this._currentPlacementIndex=order.length-1;this._forceFullPlacement=forceFullPlacement;this._showCollisionBoxes=showCollisionBoxes;this._done=false}isDone(){return this._done}continuePlacement(order,layers,layerTiles){const startTime=browser.now();const shouldPausePlacement=()=>this._forceFullPlacement?false:browser.now()-startTime>2;while(this._currentPlacementIndex>=0){const layerId=order[this._currentPlacementIndex];const layer=layers[layerId];const placementZoom=this.placement.collisionIndex.transform.zoom;if(layer.type==="symbol"&&(!layer.minzoom||layer.minzoom<=placementZoom)&&(!layer.maxzoom||layer.maxzoom>placementZoom)){if(!this._inProgressLayer){this._inProgressLayer=new LayerPlacement(layer)}const pausePlacement=this._inProgressLayer.continuePlacement(layerTiles[layer.source],this.placement,this._showCollisionBoxes,layer,shouldPausePlacement);if(pausePlacement){return}delete this._inProgressLayer}this._currentPlacementIndex--}this._done=true}commit(now){this.placement.commit(now);return this.placement}}const roundingFactor=512/performance$1.EXTENT/2;const KDBUSH_THRESHHOLD=128;class TileLayerIndex{constructor(tileID,symbolInstances,bucketInstanceId){this.tileID=tileID;this.bucketInstanceId=bucketInstanceId;this._symbolsByKey={};const symbolInstancesByKey=new Map;for(let i=0;i<symbolInstances.length;i++){const symbolInstance=symbolInstances.get(i);const key=symbolInstance.key;const instances=symbolInstancesByKey.get(key);if(instances){instances.push(symbolInstance)}else{symbolInstancesByKey.set(key,[symbolInstance])}}for(const[key,symbols]of symbolInstancesByKey){const positions=symbols.map((symbolInstance=>({x:Math.floor(symbolInstance.anchorX*roundingFactor),y:Math.floor(symbolInstance.anchorY*roundingFactor)})));const crossTileIDs=symbols.map((v=>v.crossTileID));const entry={positions:positions,crossTileIDs:crossTileIDs};if(entry.positions.length>KDBUSH_THRESHHOLD){const index=new performance$1.KDBush(entry.positions.length,16,Uint16Array);for(const{x:x,y:y}of entry.positions)index.add(x,y);index.finish();delete entry.positions;entry.index=index}this._symbolsByKey[key]=entry}}getScaledCoordinates(symbolInstance,childTileID){const{x:localX,y:localY,z:localZ}=this.tileID.canonical;const{x:x,y:y,z:z}=childTileID.canonical;const zDifference=z-localZ;const scale=roundingFactor/Math.pow(2,zDifference);const xWorld=(x*performance$1.EXTENT+symbolInstance.anchorX)*scale;const yWorld=(y*performance$1.EXTENT+symbolInstance.anchorY)*scale;const xOffset=localX*performance$1.EXTENT*roundingFactor;const yOffset=localY*performance$1.EXTENT*roundingFactor;const result={x:Math.floor(xWorld-xOffset),y:Math.floor(yWorld-yOffset)};return result}findMatches(symbolInstances,newTileID,zoomCrossTileIDs){const tolerance=this.tileID.canonical.z<newTileID.canonical.z?1:Math.pow(2,this.tileID.canonical.z-newTileID.canonical.z);for(let i=0;i<symbolInstances.length;i++){const symbolInstance=symbolInstances.get(i);if(symbolInstance.crossTileID){continue}const entry=this._symbolsByKey[symbolInstance.key];if(!entry){continue}const scaledSymbolCoord=this.getScaledCoordinates(symbolInstance,newTileID);if(entry.index){const indexes=entry.index.range(scaledSymbolCoord.x-tolerance,scaledSymbolCoord.y-tolerance,scaledSymbolCoord.x+tolerance,scaledSymbolCoord.y+tolerance).sort();for(const i of indexes){const crossTileID=entry.crossTileIDs[i];if(!zoomCrossTileIDs[crossTileID]){zoomCrossTileIDs[crossTileID]=true;symbolInstance.crossTileID=crossTileID;break}}}else if(entry.positions){for(let i=0;i<entry.positions.length;i++){const thisTileSymbol=entry.positions[i];const crossTileID=entry.crossTileIDs[i];if(Math.abs(thisTileSymbol.x-scaledSymbolCoord.x)<=tolerance&&Math.abs(thisTileSymbol.y-scaledSymbolCoord.y)<=tolerance&&!zoomCrossTileIDs[crossTileID]){zoomCrossTileIDs[crossTileID]=true;symbolInstance.crossTileID=crossTileID;break}}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map((({crossTileIDs:crossTileIDs})=>crossTileIDs))}}class CrossTileIDs{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class CrossTileSymbolLayerIndex{constructor(){this.indexes={};this.usedCrossTileIDs={};this.lng=0}handleWrapJump(lng){const wrapDelta=Math.round((lng-this.lng)/360);if(wrapDelta!==0){for(const zoom in this.indexes){const zoomIndexes=this.indexes[zoom];const newZoomIndex={};for(const key in zoomIndexes){const index=zoomIndexes[key];index.tileID=index.tileID.unwrapTo(index.tileID.wrap+wrapDelta);newZoomIndex[index.tileID.key]=index}this.indexes[zoom]=newZoomIndex}}this.lng=lng}addBucket(tileID,bucket,crossTileIDs){if(this.indexes[tileID.overscaledZ]&&this.indexes[tileID.overscaledZ][tileID.key]){if(this.indexes[tileID.overscaledZ][tileID.key].bucketInstanceId===bucket.bucketInstanceId){return false}else{this.removeBucketCrossTileIDs(tileID.overscaledZ,this.indexes[tileID.overscaledZ][tileID.key])}}for(let i=0;i<bucket.symbolInstances.length;i++){const symbolInstance=bucket.symbolInstances.get(i);symbolInstance.crossTileID=0}if(!this.usedCrossTileIDs[tileID.overscaledZ]){this.usedCrossTileIDs[tileID.overscaledZ]={}}const zoomCrossTileIDs=this.usedCrossTileIDs[tileID.overscaledZ];for(const zoom in this.indexes){const zoomIndexes=this.indexes[zoom];if(Number(zoom)>tileID.overscaledZ){for(const id in zoomIndexes){const childIndex=zoomIndexes[id];if(childIndex.tileID.isChildOf(tileID)){childIndex.findMatches(bucket.symbolInstances,tileID,zoomCrossTileIDs)}}}else{const parentCoord=tileID.scaledTo(Number(zoom));const parentIndex=zoomIndexes[parentCoord.key];if(parentIndex){parentIndex.findMatches(bucket.symbolInstances,tileID,zoomCrossTileIDs)}}}for(let i=0;i<bucket.symbolInstances.length;i++){const symbolInstance=bucket.symbolInstances.get(i);if(!symbolInstance.crossTileID){symbolInstance.crossTileID=crossTileIDs.generate();zoomCrossTileIDs[symbolInstance.crossTileID]=true}}if(this.indexes[tileID.overscaledZ]===undefined){this.indexes[tileID.overscaledZ]={}}this.indexes[tileID.overscaledZ][tileID.key]=new TileLayerIndex(tileID,bucket.symbolInstances,bucket.bucketInstanceId);return true}removeBucketCrossTileIDs(zoom,removedBucket){for(const crossTileIDs of removedBucket.getCrossTileIDsLists()){for(const crossTileID of crossTileIDs){delete this.usedCrossTileIDs[zoom][crossTileID]}}}removeStaleBuckets(currentIDs){let tilesChanged=false;for(const z in this.indexes){const zoomIndexes=this.indexes[z];for(const tileKey in zoomIndexes){if(!currentIDs[zoomIndexes[tileKey].bucketInstanceId]){this.removeBucketCrossTileIDs(z,zoomIndexes[tileKey]);delete zoomIndexes[tileKey];tilesChanged=true}}}return tilesChanged}}class CrossTileSymbolIndex{constructor(){this.layerIndexes={};this.crossTileIDs=new CrossTileIDs;this.maxBucketInstanceId=0;this.bucketsInCurrentPlacement={}}addLayer(styleLayer,tiles,lng){let layerIndex=this.layerIndexes[styleLayer.id];if(layerIndex===undefined){layerIndex=this.layerIndexes[styleLayer.id]=new CrossTileSymbolLayerIndex}let symbolBucketsChanged=false;const currentBucketIDs={};layerIndex.handleWrapJump(lng);for(const tile of tiles){const symbolBucket=tile.getBucket(styleLayer);if(!symbolBucket||styleLayer.id!==symbolBucket.layerIds[0])continue;if(!symbolBucket.bucketInstanceId){symbolBucket.bucketInstanceId=++this.maxBucketInstanceId}if(layerIndex.addBucket(tile.tileID,symbolBucket,this.crossTileIDs)){symbolBucketsChanged=true}currentBucketIDs[symbolBucket.bucketInstanceId]=true}if(layerIndex.removeStaleBuckets(currentBucketIDs)){symbolBucketsChanged=true}return symbolBucketsChanged}pruneUnusedLayers(usedLayers){const usedLayerMap={};usedLayers.forEach((usedLayer=>{usedLayerMap[usedLayer]=true}));for(const layerId in this.layerIndexes){if(!usedLayerMap[layerId]){delete this.layerIndexes[layerId]}}}}const emitValidationErrors=(evented,errors)=>performance$1.emitValidationErrors(evented,errors&&errors.filter((error=>error.identifier!=="source.canvas")));const empty=performance$1.emptyStyle();class Style extends performance$1.Evented{constructor(map,options={}){super();this._rtlTextPluginStateChange=()=>{for(const id in this.sourceCaches){const sourceType=this.sourceCaches[id].getSource().type;if(sourceType==="vector"||sourceType==="geojson"){this.sourceCaches[id].reload()}}};this.map=map;this.dispatcher=new Dispatcher(getGlobalWorkerPool(),map._getMapId());this.dispatcher.registerMessageHandler("getGlyphs",((mapId,params)=>this.getGlyphs(mapId,params)));this.dispatcher.registerMessageHandler("getImages",((mapId,params)=>this.getImages(mapId,params)));this.imageManager=new ImageManager;this.imageManager.setEventedParent(this);this.glyphManager=new GlyphManager(map._requestManager,options.localIdeographFontFamily);this.lineAtlas=new LineAtlas(256,512);this.crossTileSymbolIndex=new CrossTileSymbolIndex;this._spritesImagesIds={};this._layers={};this._order=[];this.sourceCaches={};this.zoomHistory=new performance$1.ZoomHistory;this._loaded=false;this._availableImages=[];this._resetUpdates();this.dispatcher.broadcast("setReferrer",performance$1.getReferrer());rtlMainThreadPluginFactory().on("pluginStateChange",this._rtlTextPluginStateChange);this.on("data",(event=>{if(event.dataType!=="source"||event.sourceDataType!=="metadata"){return}const sourceCache=this.sourceCaches[event.sourceId];if(!sourceCache){return}const source=sourceCache.getSource();if(!source||!source.vectorLayerIds){return}for(const layerId in this._layers){const layer=this._layers[layerId];if(layer.source===source.id){this._validateLayer(layer)}}}))}loadURL(url,options={},previousStyle){this.fire(new performance$1.Event("dataloading",{dataType:"style"}));options.validate=typeof options.validate==="boolean"?options.validate:true;const request=this.map._requestManager.transformRequest(url,ResourceType.Style);this._loadStyleRequest=new AbortController;performance$1.getJSON(request,this._loadStyleRequest).then((response=>{this._loadStyleRequest=null;this._load(response.data,options,previousStyle)})).catch((error=>{this._loadStyleRequest=null;if(error){this.fire(new performance$1.ErrorEvent(error))}}))}loadJSON(json,options={},previousStyle){this.fire(new performance$1.Event("dataloading",{dataType:"style"}));this._frameRequest=new AbortController;browser.frameAsync(this._frameRequest).then((()=>{this._frameRequest=null;options.validate=options.validate!==false;this._load(json,options,previousStyle)})).catch((()=>{}))}loadEmpty(){this.fire(new performance$1.Event("dataloading",{dataType:"style"}));this._load(empty,{validate:false})}_load(json,options,previousStyle){var _a;const nextState=options.transformStyle?options.transformStyle(previousStyle,json):json;if(options.validate&&emitValidationErrors(this,performance$1.validateStyle(nextState))){return}this._loaded=true;this.stylesheet=nextState;for(const id in nextState.sources){this.addSource(id,nextState.sources[id],{validate:false})}if(nextState.sprite){this._loadSprite(nextState.sprite)}else{this.imageManager.setLoaded(true)}this.glyphManager.setURL(nextState.glyphs);this._createLayers();this.light=new Light(this.stylesheet.light);this.map.setTerrain((_a=this.stylesheet.terrain)!==null&&_a!==void 0?_a:null);this.fire(new performance$1.Event("data",{dataType:"style"}));this.fire(new performance$1.Event("style.load"))}_createLayers(){const dereferencedLayers=performance$1.derefLayers(this.stylesheet.layers);this.dispatcher.broadcast("setLayers",dereferencedLayers);this._order=dereferencedLayers.map((layer=>layer.id));this._layers={};this._serializedLayers=null;for(const layer of dereferencedLayers){const styledLayer=performance$1.createStyleLayer(layer);styledLayer.setEventedParent(this,{layer:{id:layer.id}});this._layers[layer.id]=styledLayer}}_loadSprite(sprite,isUpdate=false,completion=undefined){this.imageManager.setLoaded(false);this._spriteRequest=new AbortController;let err;loadSprite(sprite,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then((images=>{this._spriteRequest=null;if(images){for(const spriteId in images){this._spritesImagesIds[spriteId]=[];const imagesToRemove=this._spritesImagesIds[spriteId]?this._spritesImagesIds[spriteId].filter((id=>!(id in images))):[];for(const id of imagesToRemove){this.imageManager.removeImage(id);this._changedImages[id]=true}for(const id in images[spriteId]){const imageId=spriteId==="default"?id:`${spriteId}:${id}`;this._spritesImagesIds[spriteId].push(imageId);if(imageId in this.imageManager.images){this.imageManager.updateImage(imageId,images[spriteId][id],false)}else{this.imageManager.addImage(imageId,images[spriteId][id])}if(isUpdate){this._changedImages[imageId]=true}}}}})).catch((error=>{this._spriteRequest=null;err=error;this.fire(new performance$1.ErrorEvent(err))})).finally((()=>{this.imageManager.setLoaded(true);this._availableImages=this.imageManager.listImages();if(isUpdate){this._changed=true}this.dispatcher.broadcast("setImages",this._availableImages);this.fire(new performance$1.Event("data",{dataType:"style"}));if(completion){completion(err)}}))}_unloadSprite(){for(const id of Object.values(this._spritesImagesIds).flat()){this.imageManager.removeImage(id);this._changedImages[id]=true}this._spritesImagesIds={};this._availableImages=this.imageManager.listImages();this._changed=true;this.dispatcher.broadcast("setImages",this._availableImages);this.fire(new performance$1.Event("data",{dataType:"style"}))}_validateLayer(layer){const sourceCache=this.sourceCaches[layer.source];if(!sourceCache){return}const sourceLayer=layer.sourceLayer;if(!sourceLayer){return}const source=sourceCache.getSource();if(source.type==="geojson"||source.vectorLayerIds&&source.vectorLayerIds.indexOf(sourceLayer)===-1){this.fire(new performance$1.ErrorEvent(new Error(`Source layer "${sourceLayer}" `+`does not exist on source "${source.id}" `+`as specified by style layer "${layer.id}".`)))}}loaded(){if(!this._loaded)return false;if(Object.keys(this._updatedSources).length)return false;for(const id in this.sourceCaches)if(!this.sourceCaches[id].loaded())return false;if(!this.imageManager.isLoaded())return false;return true}_serializeByIds(ids){const serializedLayersDictionary=this._serializedAllLayers();if(!ids||ids.length===0){return Object.values(serializedLayersDictionary)}const serializedLayers=[];for(const id of ids){if(serializedLayersDictionary[id]){serializedLayers.push(serializedLayersDictionary[id])}}return serializedLayers}_serializedAllLayers(){let serializedLayers=this._serializedLayers;if(serializedLayers){return serializedLayers}serializedLayers=this._serializedLayers={};const allLayerIds=Object.keys(this._layers);for(const layerId of allLayerIds){const layer=this._layers[layerId];if(layer.type!=="custom"){serializedLayers[layerId]=layer.serialize()}}return serializedLayers}hasTransitions(){if(this.light&&this.light.hasTransition()){return true}for(const id in this.sourceCaches){if(this.sourceCaches[id].hasTransition()){return true}}for(const id in this._layers){if(this._layers[id].hasTransition()){return true}}return false}_checkLoaded(){if(!this._loaded){throw new Error("Style is not done loading.")}}update(parameters){if(!this._loaded){return}const changed=this._changed;if(this._changed){const updatedIds=Object.keys(this._updatedLayers);const removedIds=Object.keys(this._removedLayers);if(updatedIds.length||removedIds.length){this._updateWorkerLayers(updatedIds,removedIds)}for(const id in this._updatedSources){const action=this._updatedSources[id];if(action==="reload"){this._reloadSource(id)}else if(action==="clear"){this._clearSource(id)}else{throw new Error(`Invalid action ${action}`)}}this._updateTilesForChangedImages();this._updateTilesForChangedGlyphs();for(const id in this._updatedPaintProps){this._layers[id].updateTransitions(parameters)}this.light.updateTransitions(parameters);this._resetUpdates()}const sourcesUsedBefore={};for(const sourceId in this.sourceCaches){const sourceCache=this.sourceCaches[sourceId];sourcesUsedBefore[sourceId]=sourceCache.used;sourceCache.used=false}for(const layerId of this._order){const layer=this._layers[layerId];layer.recalculate(parameters,this._availableImages);if(!layer.isHidden(parameters.zoom)&&layer.source){this.sourceCaches[layer.source].used=true}}for(const sourceId in sourcesUsedBefore){const sourceCache=this.sourceCaches[sourceId];if(sourcesUsedBefore[sourceId]!==sourceCache.used){sourceCache.fire(new performance$1.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:sourceId}))}}this.light.recalculate(parameters);this.z=parameters.zoom;if(changed){this.fire(new performance$1.Event("data",{dataType:"style"}))}}_updateTilesForChangedImages(){const changedImages=Object.keys(this._changedImages);if(changedImages.length){for(const name in this.sourceCaches){this.sourceCaches[name].reloadTilesForDependencies(["icons","patterns"],changedImages)}this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const name in this.sourceCaches){this.sourceCaches[name].reloadTilesForDependencies(["glyphs"],[""])}this._glyphsDidChange=false}}_updateWorkerLayers(updatedIds,removedIds){this.dispatcher.broadcast("updateLayers",{layers:this._serializeByIds(updatedIds),removedIds:removedIds})}_resetUpdates(){this._changed=false;this._updatedLayers={};this._removedLayers={};this._updatedSources={};this._updatedPaintProps={};this._changedImages={};this._glyphsDidChange=false}setState(nextState,options={}){var _a;this._checkLoaded();const serializedStyle=this.serialize();nextState=options.transformStyle?options.transformStyle(serializedStyle,nextState):nextState;const validate=(_a=options.validate)!==null&&_a!==void 0?_a:true;if(validate&&emitValidationErrors(this,performance$1.validateStyle(nextState)))return false;nextState=performance$1.clone$1(nextState);nextState.layers=performance$1.derefLayers(nextState.layers);const changes=performance$1.diffStyles(serializedStyle,nextState);const operations=this._getOperationsToPerform(changes);if(operations.unimplemented.length>0){throw new Error(`Unimplemented: ${operations.unimplemented.join(", ")}.`)}if(operations.operations.length===0){return false}for(const styleChangeOperation of operations.operations){styleChangeOperation()}this.stylesheet=nextState;this._serializedLayers=null;return true}_getOperationsToPerform(diff){const operations=[];const unimplemented=[];for(const op of diff){switch(op.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":continue;case"addLayer":operations.push((()=>this.addLayer.apply(this,op.args)));break;case"removeLayer":operations.push((()=>this.removeLayer.apply(this,op.args)));break;case"setPaintProperty":operations.push((()=>this.setPaintProperty.apply(this,op.args)));break;case"setLayoutProperty":operations.push((()=>this.setLayoutProperty.apply(this,op.args)));break;case"setFilter":operations.push((()=>this.setFilter.apply(this,op.args)));break;case"addSource":operations.push((()=>this.addSource.apply(this,op.args)));break;case"removeSource":operations.push((()=>this.removeSource.apply(this,op.args)));break;case"setLayerZoomRange":operations.push((()=>this.setLayerZoomRange.apply(this,op.args)));break;case"setLight":operations.push((()=>this.setLight.apply(this,op.args)));break;case"setGeoJSONSourceData":operations.push((()=>this.setGeoJSONSourceData.apply(this,op.args)));break;case"setGlyphs":operations.push((()=>this.setGlyphs.apply(this,op.args)));break;case"setSprite":operations.push((()=>this.setSprite.apply(this,op.args)));break;case"setTerrain":operations.push((()=>this.map.setTerrain.apply(this,op.args)));break;case"setTransition":operations.push((()=>{}));break;default:unimplemented.push(op.command);break}}return{operations:operations,unimplemented:unimplemented}}addImage(id,image){if(this.getImage(id)){return this.fire(new performance$1.ErrorEvent(new Error(`An image named "${id}" already exists.`)))}this.imageManager.addImage(id,image);this._afterImageUpdated(id)}updateImage(id,image){this.imageManager.updateImage(id,image)}getImage(id){return this.imageManager.getImage(id)}removeImage(id){if(!this.getImage(id)){return this.fire(new performance$1.ErrorEvent(new Error(`An image named "${id}" does not exist.`)))}this.imageManager.removeImage(id);this._afterImageUpdated(id)}_afterImageUpdated(id){this._availableImages=this.imageManager.listImages();this._changedImages[id]=true;this._changed=true;this.dispatcher.broadcast("setImages",this._availableImages);this.fire(new performance$1.Event("data",{dataType:"style"}))}listImages(){this._checkLoaded();return this.imageManager.listImages()}addSource(id,source,options={}){this._checkLoaded();if(this.sourceCaches[id]!==undefined){throw new Error(`Source "${id}" already exists.`)}if(!source.type){throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(source).join(", ")}.`)}const builtIns=["vector","raster","geojson","video","image"];const shouldValidate=builtIns.indexOf(source.type)>=0;if(shouldValidate&&this._validate(performance$1.validateStyle.source,`sources.${id}`,source,null,options))return;if(this.map&&this.map._collectResourceTiming)source.collectResourceTiming=true;const sourceCache=this.sourceCaches[id]=new SourceCache(id,source,this.dispatcher);sourceCache.style=this;sourceCache.setEventedParent(this,(()=>({isSourceLoaded:sourceCache.loaded(),source:sourceCache.serialize(),sourceId:id})));sourceCache.onAdd(this.map);this._changed=true}removeSource(id){this._checkLoaded();if(this.sourceCaches[id]===undefined){throw new Error("There is no source with this ID")}for(const layerId in this._layers){if(this._layers[layerId].source===id){return this.fire(new performance$1.ErrorEvent(new Error(`Source "${id}" cannot be removed while layer "${layerId}" is using it.`)))}}const sourceCache=this.sourceCaches[id];delete this.sourceCaches[id];delete this._updatedSources[id];sourceCache.fire(new performance$1.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:id}));sourceCache.setEventedParent(null);sourceCache.onRemove(this.map);this._changed=true}setGeoJSONSourceData(id,data){this._checkLoaded();if(this.sourceCaches[id]===undefined)throw new Error(`There is no source with this ID=${id}`);const geojsonSource=this.sourceCaches[id].getSource();if(geojsonSource.type!=="geojson")throw new Error(`geojsonSource.type is ${geojsonSource.type}, which is !== 'geojson`);geojsonSource.setData(data);this._changed=true}getSource(id){return this.sourceCaches[id]&&this.sourceCaches[id].getSource()}addLayer(layerObject,before,options={}){this._checkLoaded();const id=layerObject.id;if(this.getLayer(id)){this.fire(new performance$1.ErrorEvent(new Error(`Layer "${id}" already exists on this map.`)));return}let layer;if(layerObject.type==="custom"){if(emitValidationErrors(this,performance$1.validateCustomStyleLayer(layerObject)))return;layer=performance$1.createStyleLayer(layerObject)}else{if("source"in layerObject&&typeof layerObject.source==="object"){this.addSource(id,layerObject.source);layerObject=performance$1.clone$1(layerObject);layerObject=performance$1.extend(layerObject,{source:id})}if(this._validate(performance$1.validateStyle.layer,`layers.${id}`,layerObject,{arrayIndex:-1},options))return;layer=performance$1.createStyleLayer(layerObject);this._validateLayer(layer);layer.setEventedParent(this,{layer:{id:id}})}const index=before?this._order.indexOf(before):this._order.length;if(before&&index===-1){this.fire(new performance$1.ErrorEvent(new Error(`Cannot add layer "${id}" before non-existing layer "${before}".`)));return}this._order.splice(index,0,id);this._layerOrderChanged=true;this._layers[id]=layer;if(this._removedLayers[id]&&layer.source&&layer.type!=="custom"){const removed=this._removedLayers[id];delete this._removedLayers[id];if(removed.type!==layer.type){this._updatedSources[layer.source]="clear"}else{this._updatedSources[layer.source]="reload";this.sourceCaches[layer.source].pause()}}this._updateLayer(layer);if(layer.onAdd){layer.onAdd(this.map)}}moveLayer(id,before){this._checkLoaded();this._changed=true;const layer=this._layers[id];if(!layer){this.fire(new performance$1.ErrorEvent(new Error(`The layer '${id}' does not exist in the map's style and cannot be moved.`)));return}if(id===before){return}const index=this._order.indexOf(id);this._order.splice(index,1);const newIndex=before?this._order.indexOf(before):this._order.length;if(before&&newIndex===-1){this.fire(new performance$1.ErrorEvent(new Error(`Cannot move layer "${id}" before non-existing layer "${before}".`)));return}this._order.splice(newIndex,0,id);this._layerOrderChanged=true}removeLayer(id){this._checkLoaded();const layer=this._layers[id];if(!layer){this.fire(new performance$1.ErrorEvent(new Error(`Cannot remove non-existing layer "${id}".`)));return}layer.setEventedParent(null);const index=this._order.indexOf(id);this._order.splice(index,1);this._layerOrderChanged=true;this._changed=true;this._removedLayers[id]=layer;delete this._layers[id];if(this._serializedLayers){delete this._serializedLayers[id]}delete this._updatedLayers[id];delete this._updatedPaintProps[id];if(layer.onRemove){layer.onRemove(this.map)}}getLayer(id){return this._layers[id]}getLayersOrder(){return[...this._order]}hasLayer(id){return id in this._layers}setLayerZoomRange(layerId,minzoom,maxzoom){this._checkLoaded();const layer=this.getLayer(layerId);if(!layer){this.fire(new performance$1.ErrorEvent(new Error(`Cannot set the zoom range of non-existing layer "${layerId}".`)));return}if(layer.minzoom===minzoom&&layer.maxzoom===maxzoom)return;if(minzoom!=null){layer.minzoom=minzoom}if(maxzoom!=null){layer.maxzoom=maxzoom}this._updateLayer(layer)}setFilter(layerId,filter,options={}){this._checkLoaded();const layer=this.getLayer(layerId);if(!layer){this.fire(new performance$1.ErrorEvent(new Error(`Cannot filter non-existing layer "${layerId}".`)));return}if(performance$1.deepEqual(layer.filter,filter)){return}if(filter===null||filter===undefined){layer.filter=undefined;this._updateLayer(layer);return}if(this._validate(performance$1.validateStyle.filter,`layers.${layer.id}.filter`,filter,null,options)){return}layer.filter=performance$1.clone$1(filter);this._updateLayer(layer)}getFilter(layer){return performance$1.clone$1(this.getLayer(layer).filter)}setLayoutProperty(layerId,name,value,options={}){this._checkLoaded();const layer=this.getLayer(layerId);if(!layer){this.fire(new performance$1.ErrorEvent(new Error(`Cannot style non-existing layer "${layerId}".`)));return}if(performance$1.deepEqual(layer.getLayoutProperty(name),value))return;layer.setLayoutProperty(name,value,options);this._updateLayer(layer)}getLayoutProperty(layerId,name){const layer=this.getLayer(layerId);if(!layer){this.fire(new performance$1.ErrorEvent(new Error(`Cannot get style of non-existing layer "${layerId}".`)));return}return layer.getLayoutProperty(name)}setPaintProperty(layerId,name,value,options={}){this._checkLoaded();const layer=this.getLayer(layerId);if(!layer){this.fire(new performance$1.ErrorEvent(new Error(`Cannot style non-existing layer "${layerId}".`)));return}if(performance$1.deepEqual(layer.getPaintProperty(name),value))return;const requiresRelayout=layer.setPaintProperty(name,value,options);if(requiresRelayout){this._updateLayer(layer)}this._changed=true;this._updatedPaintProps[layerId]=true}getPaintProperty(layer,name){return this.getLayer(layer).getPaintProperty(name)}setFeatureState(target,state){this._checkLoaded();const sourceId=target.source;const sourceLayer=target.sourceLayer;const sourceCache=this.sourceCaches[sourceId];if(sourceCache===undefined){this.fire(new performance$1.ErrorEvent(new Error(`The source '${sourceId}' does not exist in the map's style.`)));return}const sourceType=sourceCache.getSource().type;if(sourceType==="geojson"&&sourceLayer){this.fire(new performance$1.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));return}if(sourceType==="vector"&&!sourceLayer){this.fire(new performance$1.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));return}if(target.id===undefined){this.fire(new performance$1.ErrorEvent(new Error("The feature id parameter must be provided.")))}sourceCache.setFeatureState(sourceLayer,target.id,state)}removeFeatureState(target,key){this._checkLoaded();const sourceId=target.source;const sourceCache=this.sourceCaches[sourceId];if(sourceCache===undefined){this.fire(new performance$1.ErrorEvent(new Error(`The source '${sourceId}' does not exist in the map's style.`)));return}const sourceType=sourceCache.getSource().type;const sourceLayer=sourceType==="vector"?target.sourceLayer:undefined;if(sourceType==="vector"&&!sourceLayer){this.fire(new performance$1.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));return}if(key&&(typeof target.id!=="string"&&typeof target.id!=="number")){this.fire(new performance$1.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));return}sourceCache.removeFeatureState(sourceLayer,target.id,key)}getFeatureState(target){this._checkLoaded();const sourceId=target.source;const sourceLayer=target.sourceLayer;const sourceCache=this.sourceCaches[sourceId];if(sourceCache===undefined){this.fire(new performance$1.ErrorEvent(new Error(`The source '${sourceId}' does not exist in the map's style.`)));return}const sourceType=sourceCache.getSource().type;if(sourceType==="vector"&&!sourceLayer){this.fire(new performance$1.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));return}if(target.id===undefined){this.fire(new performance$1.ErrorEvent(new Error("The feature id parameter must be provided.")))}return sourceCache.getFeatureState(sourceLayer,target.id)}getTransition(){return performance$1.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const sources=performance$1.mapObject(this.sourceCaches,(source=>source.serialize()));const layers=this._serializeByIds(this._order);const terrain=this.map.getTerrain()||undefined;const myStyleSheet=this.stylesheet;return performance$1.filterObject({version:myStyleSheet.version,name:myStyleSheet.name,metadata:myStyleSheet.metadata,light:myStyleSheet.light,center:myStyleSheet.center,zoom:myStyleSheet.zoom,bearing:myStyleSheet.bearing,pitch:myStyleSheet.pitch,sprite:myStyleSheet.sprite,glyphs:myStyleSheet.glyphs,transition:myStyleSheet.transition,sources:sources,layers:layers,terrain:terrain},(value=>value!==undefined))}_updateLayer(layer){this._updatedLayers[layer.id]=true;if(layer.source&&!this._updatedSources[layer.source]&&this.sourceCaches[layer.source].getSource().type!=="raster"){this._updatedSources[layer.source]="reload";this.sourceCaches[layer.source].pause()}this._serializedLayers=null;this._changed=true}_flattenAndSortRenderedFeatures(sourceResults){const isLayer3D=layerId=>this._layers[layerId].type==="fill-extrusion";const layerIndex={};const features3D=[];for(let l=this._order.length-1;l>=0;l--){const layerId=this._order[l];if(isLayer3D(layerId)){layerIndex[layerId]=l;for(const sourceResult of sourceResults){const layerFeatures=sourceResult[layerId];if(layerFeatures){for(const featureWrapper of layerFeatures){features3D.push(featureWrapper)}}}}}features3D.sort(((a,b)=>b.intersectionZ-a.intersectionZ));const features=[];for(let l=this._order.length-1;l>=0;l--){const layerId=this._order[l];if(isLayer3D(layerId)){for(let i=features3D.length-1;i>=0;i--){const topmost3D=features3D[i].feature;if(layerIndex[topmost3D.layer.id]<l)break;features.push(topmost3D);features3D.pop()}}else{for(const sourceResult of sourceResults){const layerFeatures=sourceResult[layerId];if(layerFeatures){for(const featureWrapper of layerFeatures){features.push(featureWrapper.feature)}}}}}return features}queryRenderedFeatures(queryGeometry,params,transform){if(params&&params.filter){this._validate(performance$1.validateStyle.filter,"queryRenderedFeatures.filter",params.filter,null,params)}const includedSources={};if(params&&params.layers){if(!Array.isArray(params.layers)){this.fire(new performance$1.ErrorEvent(new Error("parameters.layers must be an Array.")));return[]}for(const layerId of params.layers){const layer=this._layers[layerId];if(!layer){this.fire(new performance$1.ErrorEvent(new Error(`The layer '${layerId}' does not exist in the map's style and cannot be queried for features.`)));return[]}includedSources[layer.source]=true}}const sourceResults=[];params.availableImages=this._availableImages;const serializedLayers=this._serializedAllLayers();for(const id in this.sourceCaches){if(params.layers&&!includedSources[id])continue;sourceResults.push(queryRenderedFeatures(this.sourceCaches[id],this._layers,serializedLayers,queryGeometry,params,transform))}if(this.placement){sourceResults.push(queryRenderedSymbols(this._layers,serializedLayers,this.sourceCaches,queryGeometry,params,this.placement.collisionIndex,this.placement.retainedQueryData))}return this._flattenAndSortRenderedFeatures(sourceResults)}querySourceFeatures(sourceID,params){if(params&&params.filter){this._validate(performance$1.validateStyle.filter,"querySourceFeatures.filter",params.filter,null,params)}const sourceCache=this.sourceCaches[sourceID];return sourceCache?querySourceFeatures(sourceCache,params):[]}getLight(){return this.light.getLight()}setLight(lightOptions,options={}){this._checkLoaded();const light=this.light.getLight();let _update=false;for(const key in lightOptions){if(!performance$1.deepEqual(lightOptions[key],light[key])){_update=true;break}}if(!_update)return;const parameters={now:browser.now(),transition:performance$1.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(lightOptions,options);this.light.updateTransitions(parameters)}_validate(validate,key,value,props,options={}){if(options&&options.validate===false){return false}return emitValidationErrors(this,validate.call(performance$1.validateStyle,performance$1.extend({key:key,style:this.serialize(),value:value,styleSpec:performance$1.v8Spec},props)))}_remove(mapRemoved=true){if(this._frameRequest){this._frameRequest.abort();this._frameRequest=null}if(this._loadStyleRequest){this._loadStyleRequest.abort();this._loadStyleRequest=null}if(this._spriteRequest){this._spriteRequest.abort();this._spriteRequest=null}rtlMainThreadPluginFactory().off("pluginStateChange",this._rtlTextPluginStateChange);for(const layerId in this._layers){const layer=this._layers[layerId];layer.setEventedParent(null)}for(const id in this.sourceCaches){const sourceCache=this.sourceCaches[id];sourceCache.setEventedParent(null);sourceCache.onRemove(this.map)}this.imageManager.setEventedParent(null);this.setEventedParent(null);this.dispatcher.remove(mapRemoved)}_clearSource(id){this.sourceCaches[id].clearTiles()}_reloadSource(id){this.sourceCaches[id].resume();this.sourceCaches[id].reload()}_updateSources(transform){for(const id in this.sourceCaches){this.sourceCaches[id].update(transform,this.map.terrain)}}_generateCollisionBoxes(){for(const id in this.sourceCaches){this._reloadSource(id)}}_updatePlacement(transform,showCollisionBoxes,fadeDuration,crossSourceCollisions,forceFullPlacement=false){let symbolBucketsChanged=false;let placementCommitted=false;const layerTiles={};for(const layerID of this._order){const styleLayer=this._layers[layerID];if(styleLayer.type!=="symbol")continue;if(!layerTiles[styleLayer.source]){const sourceCache=this.sourceCaches[styleLayer.source];layerTiles[styleLayer.source]=sourceCache.getRenderableIds(true).map((id=>sourceCache.getTileByID(id))).sort(((a,b)=>b.tileID.overscaledZ-a.tileID.overscaledZ||(a.tileID.isLessThan(b.tileID)?-1:1)))}const layerBucketsChanged=this.crossTileSymbolIndex.addLayer(styleLayer,layerTiles[styleLayer.source],transform.center.lng);symbolBucketsChanged=symbolBucketsChanged||layerBucketsChanged}this.crossTileSymbolIndex.pruneUnusedLayers(this._order);forceFullPlacement=forceFullPlacement||this._layerOrderChanged||fadeDuration===0;if(forceFullPlacement||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(browser.now(),transform.zoom)){this.pauseablePlacement=new PauseablePlacement(transform,this.map.terrain,this._order,forceFullPlacement,showCollisionBoxes,fadeDuration,crossSourceCollisions,this.placement);this._layerOrderChanged=false}if(this.pauseablePlacement.isDone()){this.placement.setStale()}else{this.pauseablePlacement.continuePlacement(this._order,this._layers,layerTiles);if(this.pauseablePlacement.isDone()){this.placement=this.pauseablePlacement.commit(browser.now());placementCommitted=true}if(symbolBucketsChanged){this.pauseablePlacement.placement.setStale()}}if(placementCommitted||symbolBucketsChanged){for(const layerID of this._order){const styleLayer=this._layers[layerID];if(styleLayer.type!=="symbol")continue;this.placement.updateLayerOpacities(styleLayer,layerTiles[styleLayer.source])}}const needsRerender=!this.pauseablePlacement.isDone()||this.placement.hasTransitions(browser.now());return needsRerender}_releaseSymbolFadeTiles(){for(const id in this.sourceCaches){this.sourceCaches[id].releaseSymbolFadeTiles()}}getImages(mapId,params){return performance$1.__awaiter(this,void 0,void 0,(function*(){const images=yield this.imageManager.getImages(params.icons);this._updateTilesForChangedImages();const sourceCache=this.sourceCaches[params.source];if(sourceCache){sourceCache.setDependencies(params.tileID.key,params.type,params.icons)}return images}))}getGlyphs(mapId,params){return performance$1.__awaiter(this,void 0,void 0,(function*(){const glypgs=yield this.glyphManager.getGlyphs(params.stacks);const sourceCache=this.sourceCaches[params.source];if(sourceCache){sourceCache.setDependencies(params.tileID.key,params.type,[""])}return glypgs}))}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(glyphsUrl,options={}){this._checkLoaded();if(glyphsUrl&&this._validate(performance$1.validateStyle.glyphs,"glyphs",glyphsUrl,null,options)){return}this._glyphsDidChange=true;this.stylesheet.glyphs=glyphsUrl;this.glyphManager.entries={};this.glyphManager.setURL(glyphsUrl)}addSprite(id,url,options={},completion){this._checkLoaded();const spriteToAdd=[{id:id,url:url}];const updatedSprite=[...coerceSpriteToArray(this.stylesheet.sprite),...spriteToAdd];if(this._validate(performance$1.validateStyle.sprite,"sprite",updatedSprite,null,options))return;this.stylesheet.sprite=updatedSprite;this._loadSprite(spriteToAdd,true,completion)}removeSprite(id){this._checkLoaded();const internalSpriteRepresentation=coerceSpriteToArray(this.stylesheet.sprite);if(!internalSpriteRepresentation.find((sprite=>sprite.id===id))){this.fire(new performance$1.ErrorEvent(new Error(`Sprite "${id}" doesn't exists on this map.`)));return}if(this._spritesImagesIds[id]){for(const imageId of this._spritesImagesIds[id]){this.imageManager.removeImage(imageId);this._changedImages[imageId]=true}}internalSpriteRepresentation.splice(internalSpriteRepresentation.findIndex((sprite=>sprite.id===id)),1);this.stylesheet.sprite=internalSpriteRepresentation.length>0?internalSpriteRepresentation:undefined;delete this._spritesImagesIds[id];this._availableImages=this.imageManager.listImages();this._changed=true;this.dispatcher.broadcast("setImages",this._availableImages);this.fire(new performance$1.Event("data",{dataType:"style"}))}getSprite(){return coerceSpriteToArray(this.stylesheet.sprite)}setSprite(sprite,options={},completion){this._checkLoaded();if(sprite&&this._validate(performance$1.validateStyle.sprite,"sprite",sprite,null,options)){return}this.stylesheet.sprite=sprite;if(sprite){this._loadSprite(sprite,true,completion)}else{this._unloadSprite();if(completion){completion(null)}}}}var posAttributes=performance$1.createLayout([{name:"a_pos",type:"Int16",components:2}]);var preludeFrag="#ifdef GL_ES\nprecision mediump float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif\n";var preludeVert="#ifdef GL_ES\nprecision highp float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}\n#ifdef TERRAIN3D\nuniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;\n#endif\nconst highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {\n#ifdef TERRAIN3D\nhighp float d=unpack(texture2D(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));\n#else\nreturn 1.0;\n#endif\n}float calculate_visibility(vec4 pos) {\n#ifdef TERRAIN3D\nvec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;\n#else\nreturn 1.0;\n#endif\n}float ele(vec2 pos) {\n#ifdef TERRAIN3D\nvec4 rgb=(texture2D(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;\n#else\nreturn 0.0;\n#endif\n}float get_elevation(vec2 pos) {\n#ifdef TERRAIN3D\nvec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;\n#else\nreturn 0.0;\n#endif\n}";var backgroundFrag="uniform vec4 u_color;uniform float u_opacity;void main() {gl_FragColor=u_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var backgroundVert="attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}";var backgroundPatternFrag="uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_mix)*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var backgroundPatternVert="uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}";var circleFrag="varying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));gl_FragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var circleVert="uniform mat4 u_matrix;uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;varying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);float ele=get_elevation(circle_center);v_visibility=calculate_visibility(u_matrix*vec4(circle_center,ele,1.0));if (u_pitch_with_map) {vec2 corner_position=circle_center;if (u_scale_with_map) {corner_position+=extrude*(radius+stroke_width)*u_extrude_scale;} else {vec4 projected_center=u_matrix*vec4(circle_center,0,1);corner_position+=extrude*(radius+stroke_width)*u_extrude_scale*(projected_center.w/u_camera_to_center_distance);}gl_Position=u_matrix*vec4(corner_position,ele,1);} else {gl_Position=u_matrix*vec4(circle_center,ele,1);if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);}";var clippingMaskFrag="void main() {gl_FragColor=vec4(1.0);}";var clippingMaskVert="attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}";var heatmapFrag="uniform highp float u_intensity;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var heatmapVert="uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec4 pos=vec4(floor(a_pos*0.5)+extrude,0,1);gl_Position=u_matrix*pos;}";var heatmapTextureFrag="uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(0.0);\n#endif\n}";var heatmapTextureVert="uniform mat4 u_matrix;uniform vec2 u_world;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}";var collisionBoxFrag="varying float v_placed;varying float v_notUsed;void main() {float alpha=0.5;gl_FragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {gl_FragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {gl_FragColor*=.1;}}";var collisionBoxVert="attribute vec2 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_anchor_pos,0,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);gl_Position=u_matrix*vec4(a_pos,get_elevation(a_pos),1.0);gl_Position.xy+=(a_extrude+a_shift)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}";var collisionCircleFrag="varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}";var collisionCircleVert="attribute vec2 a_pos;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}";var debugFrag="uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}";var debugVert="attribute vec2 a_pos;varying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,get_elevation(a_pos),1);}";var fillFrag="#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_FragColor=color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var fillVert="attribute vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);}";var fillOutlineFrag="varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=outline_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var fillOutlineVert="attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}";var fillOutlinePatternFrag="uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);gl_FragColor=mix(color1,color2,u_fade)*alpha*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var fillOutlinePatternVert="uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;}";var fillPatternFrag="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);gl_FragColor=mix(color1,color2,u_fade)*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var fillPatternVert="uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}";var fillExtrusionFrag="varying vec4 v_color;void main() {gl_FragColor=v_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var fillExtrusionVert="uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec2 a_pos;attribute vec4 a_normal_ed;\n#ifdef TERRAIN3D\nattribute vec2 a_centroid;\n#endif\nvarying vec4 v_color;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\nvec3 normal=a_normal_ed.xyz;\n#ifdef TERRAIN3D\nfloat height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);\n#else\nfloat height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;\n#endif\nbase=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);gl_Position=u_matrix*vec4(a_pos,t > 0.0 ? height : base,1);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal/16384.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}";var fillExtrusionPatternFrag="uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);gl_FragColor=mixedColor*v_lighting;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var fillExtrusionPatternVert="uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec2 a_pos;attribute vec4 a_normal_ed;\n#ifdef TERRAIN3D\nattribute vec2 a_centroid;\n#endif\nvarying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;\n#ifdef TERRAIN3D\nfloat height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);\n#else\nfloat height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;\n#endif\nbase=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float z=t > 0.0 ? height : base;gl_Position=u_matrix*vec4(a_pos,z,1);vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0\n? a_pos\n: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}";var hillshadePrepareFrag="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var hillshadePrepareVert="uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}";var hillshadeFrag="uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;\n#define PI 3.141592653589793\nvoid main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var hillshadeVert="uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;}";var lineFrag="uniform lowp float u_device_pixel_ratio;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var lineVert="\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp float v_linesofar;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_width2=vec2(outset,inset);}";var lineGradientFrag="uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec2 v_uv;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture2D(u_image,v_uv);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var lineGradientVert="\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_uv_x;attribute float a_split_index;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec2 v_uv;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_width2=vec2(outset,inset);}";var linePatternFrag="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);gl_FragColor=color*alpha*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var linePatternVert="\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\nattribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}";var lineSDFFrag="uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture2D(u_image,v_tex_a).a;float sdfdist_b=texture2D(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);gl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var lineSDFVert="\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\nattribute vec2 a_pos_normal;attribute vec4 a_data;uniform mat4 u_matrix;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;varying vec2 v_normal;varying vec2 v_width2;varying vec2 v_tex_a;varying vec2 v_tex_b;varying float v_gamma_scale;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist/u_ratio,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2/u_ratio,0.0,1.0)+projected_extrude;\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}";var rasterFrag="uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);gl_FragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var rasterVert="uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos0=(((a_texture_pos/8192.0)-0.5)/u_buffer_scale )+0.5;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}";var symbolIconFrag="uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nlowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var symbolIconVert="const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0),z,1.0);v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}";var symbolSDFFrag="#define SDF_PX 8.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var symbolSDFVert="const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec4 a_pixeloffset;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}";var symbolTextAndIconFrag="#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}";var symbolTextAndIconVert="const float PI=3.141592653589793;attribute vec4 a_pos_offset;attribute vec4 a_data;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec4 projectedPoint=u_matrix*vec4(a_pos,ele,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),ele,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,ele,1.0);float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;gl_Position=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale),z,1.0);float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}";var terrainDepthFrag="varying float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {gl_FragColor=pack(v_depth);}";var terrainCoordsFrag="precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;varying vec2 v_texture_pos;void main() {vec4 rgba=texture2D(u_texture,v_texture_pos);gl_FragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}";var terrainFrag="uniform sampler2D u_texture;varying vec2 v_texture_pos;void main() {gl_FragColor=texture2D(u_texture,v_texture_pos);}";var terrainVert="attribute vec3 a_pos3d;uniform mat4 u_matrix;uniform float u_ele_delta;varying vec2 v_texture_pos;varying float v_depth;void main() {float extent=8192.0;float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/extent;gl_Position=u_matrix*vec4(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta,1.0);v_depth=gl_Position.z/gl_Position.w;}";const shaders={prelude:compile(preludeFrag,preludeVert),background:compile(backgroundFrag,backgroundVert),backgroundPattern:compile(backgroundPatternFrag,backgroundPatternVert),circle:compile(circleFrag,circleVert),clippingMask:compile(clippingMaskFrag,clippingMaskVert),heatmap:compile(heatmapFrag,heatmapVert),heatmapTexture:compile(heatmapTextureFrag,heatmapTextureVert),collisionBox:compile(collisionBoxFrag,collisionBoxVert),collisionCircle:compile(collisionCircleFrag,collisionCircleVert),debug:compile(debugFrag,debugVert),fill:compile(fillFrag,fillVert),fillOutline:compile(fillOutlineFrag,fillOutlineVert),fillOutlinePattern:compile(fillOutlinePatternFrag,fillOutlinePatternVert),fillPattern:compile(fillPatternFrag,fillPatternVert),fillExtrusion:compile(fillExtrusionFrag,fillExtrusionVert),fillExtrusionPattern:compile(fillExtrusionPatternFrag,fillExtrusionPatternVert),hillshadePrepare:compile(hillshadePrepareFrag,hillshadePrepareVert),hillshade:compile(hillshadeFrag,hillshadeVert),line:compile(lineFrag,lineVert),lineGradient:compile(lineGradientFrag,lineGradientVert),linePattern:compile(linePatternFrag,linePatternVert),lineSDF:compile(lineSDFFrag,lineSDFVert),raster:compile(rasterFrag,rasterVert),symbolIcon:compile(symbolIconFrag,symbolIconVert),symbolSDF:compile(symbolSDFFrag,symbolSDFVert),symbolTextAndIcon:compile(symbolTextAndIconFrag,symbolTextAndIconVert),terrain:compile(terrainFrag,terrainVert),terrainDepth:compile(terrainDepthFrag,terrainVert),terrainCoords:compile(terrainCoordsFrag,terrainVert)};function compile(fragmentSource,vertexSource){const re=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g;const staticAttributes=vertexSource.match(/attribute ([\w]+) ([\w]+)/g);const fragmentUniforms=fragmentSource.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g);const vertexUniforms=vertexSource.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g);const staticUniforms=vertexUniforms?vertexUniforms.concat(fragmentUniforms):fragmentUniforms;const fragmentPragmas={};fragmentSource=fragmentSource.replace(re,((match,operation,precision,type,name)=>{fragmentPragmas[name]=true;if(operation==="define"){return`\n#ifndef HAS_UNIFORM_u_${name}\nvarying ${precision} ${type} ${name};\n#else\nuniform ${precision} ${type} u_${name};\n#endif\n`}else{return`\n#ifdef HAS_UNIFORM_u_${name}\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`}}));vertexSource=vertexSource.replace(re,((match,operation,precision,type,name)=>{const attrType=type==="float"?"vec2":"vec4";const unpackType=name.match(/color/)?"color":attrType;if(fragmentPragmas[name]){if(operation==="define"){return`\n#ifndef HAS_UNIFORM_u_${name}\nuniform lowp float u_${name}_t;\nattribute ${precision} ${attrType} a_${name};\nvarying ${precision} ${type} ${name};\n#else\nuniform ${precision} ${type} u_${name};\n#endif\n`}else{if(unpackType==="vec4"){return`\n#ifndef HAS_UNIFORM_u_${name}\n    ${name} = a_${name};\n#else\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`}else{return`\n#ifndef HAS_UNIFORM_u_${name}\n    ${name} = unpack_mix_${unpackType}(a_${name}, u_${name}_t);\n#else\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`}}}else{if(operation==="define"){return`\n#ifndef HAS_UNIFORM_u_${name}\nuniform lowp float u_${name}_t;\nattribute ${precision} ${attrType} a_${name};\n#else\nuniform ${precision} ${type} u_${name};\n#endif\n`}else{if(unpackType==="vec4"){return`\n#ifndef HAS_UNIFORM_u_${name}\n    ${precision} ${type} ${name} = a_${name};\n#else\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`}else{return`\n#ifndef HAS_UNIFORM_u_${name}\n    ${precision} ${type} ${name} = unpack_mix_${unpackType}(a_${name}, u_${name}_t);\n#else\n    ${precision} ${type} ${name} = u_${name};\n#endif\n`}}}}));return{fragmentSource:fragmentSource,vertexSource:vertexSource,staticAttributes:staticAttributes,staticUniforms:staticUniforms}}class VertexArrayObject{constructor(){this.boundProgram=null;this.boundLayoutVertexBuffer=null;this.boundPaintVertexBuffers=[];this.boundIndexBuffer=null;this.boundVertexOffset=null;this.boundDynamicVertexBuffer=null;this.vao=null}bind(context,program,layoutVertexBuffer,paintVertexBuffers,indexBuffer,vertexOffset,dynamicVertexBuffer,dynamicVertexBuffer2,dynamicVertexBuffer3){this.context=context;let paintBuffersDiffer=this.boundPaintVertexBuffers.length!==paintVertexBuffers.length;for(let i=0;!paintBuffersDiffer&&i<paintVertexBuffers.length;i++){if(this.boundPaintVertexBuffers[i]!==paintVertexBuffers[i]){paintBuffersDiffer=true}}const isFreshBindRequired=!this.vao||this.boundProgram!==program||this.boundLayoutVertexBuffer!==layoutVertexBuffer||paintBuffersDiffer||this.boundIndexBuffer!==indexBuffer||this.boundVertexOffset!==vertexOffset||this.boundDynamicVertexBuffer!==dynamicVertexBuffer||this.boundDynamicVertexBuffer2!==dynamicVertexBuffer2||this.boundDynamicVertexBuffer3!==dynamicVertexBuffer3;if(isFreshBindRequired){this.freshBind(program,layoutVertexBuffer,paintVertexBuffers,indexBuffer,vertexOffset,dynamicVertexBuffer,dynamicVertexBuffer2,dynamicVertexBuffer3)}else{context.bindVertexArray.set(this.vao);if(dynamicVertexBuffer){dynamicVertexBuffer.bind()}if(indexBuffer&&indexBuffer.dynamicDraw){indexBuffer.bind()}if(dynamicVertexBuffer2){dynamicVertexBuffer2.bind()}if(dynamicVertexBuffer3){dynamicVertexBuffer3.bind()}}}freshBind(program,layoutVertexBuffer,paintVertexBuffers,indexBuffer,vertexOffset,dynamicVertexBuffer,dynamicVertexBuffer2,dynamicVertexBuffer3){const numNextAttributes=program.numAttributes;const context=this.context;const gl=context.gl;if(this.vao)this.destroy();this.vao=context.createVertexArray();context.bindVertexArray.set(this.vao);this.boundProgram=program;this.boundLayoutVertexBuffer=layoutVertexBuffer;this.boundPaintVertexBuffers=paintVertexBuffers;this.boundIndexBuffer=indexBuffer;this.boundVertexOffset=vertexOffset;this.boundDynamicVertexBuffer=dynamicVertexBuffer;this.boundDynamicVertexBuffer2=dynamicVertexBuffer2;this.boundDynamicVertexBuffer3=dynamicVertexBuffer3;layoutVertexBuffer.enableAttributes(gl,program);for(const vertexBuffer of paintVertexBuffers){vertexBuffer.enableAttributes(gl,program)}if(dynamicVertexBuffer){dynamicVertexBuffer.enableAttributes(gl,program)}if(dynamicVertexBuffer2){dynamicVertexBuffer2.enableAttributes(gl,program)}if(dynamicVertexBuffer3){dynamicVertexBuffer3.enableAttributes(gl,program)}layoutVertexBuffer.bind();layoutVertexBuffer.setVertexAttribPointers(gl,program,vertexOffset);for(const vertexBuffer of paintVertexBuffers){vertexBuffer.bind();vertexBuffer.setVertexAttribPointers(gl,program,vertexOffset)}if(dynamicVertexBuffer){dynamicVertexBuffer.bind();dynamicVertexBuffer.setVertexAttribPointers(gl,program,vertexOffset)}if(indexBuffer){indexBuffer.bind()}if(dynamicVertexBuffer2){dynamicVertexBuffer2.bind();dynamicVertexBuffer2.setVertexAttribPointers(gl,program,vertexOffset)}if(dynamicVertexBuffer3){dynamicVertexBuffer3.bind();dynamicVertexBuffer3.setVertexAttribPointers(gl,program,vertexOffset)}context.currentNumAttributes=numNextAttributes}destroy(){if(this.vao){this.context.deleteVertexArray(this.vao);this.vao=null}}}const terrainPreludeUniforms=(context,locations)=>({u_depth:new performance$1.Uniform1i(context,locations.u_depth),u_terrain:new performance$1.Uniform1i(context,locations.u_terrain),u_terrain_dim:new performance$1.Uniform1f(context,locations.u_terrain_dim),u_terrain_matrix:new performance$1.UniformMatrix4f(context,locations.u_terrain_matrix),u_terrain_unpack:new performance$1.Uniform4f(context,locations.u_terrain_unpack),u_terrain_exaggeration:new performance$1.Uniform1f(context,locations.u_terrain_exaggeration)});const terrainUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_texture:new performance$1.Uniform1i(context,locations.u_texture),u_ele_delta:new performance$1.Uniform1f(context,locations.u_ele_delta)});const terrainDepthUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_ele_delta:new performance$1.Uniform1f(context,locations.u_ele_delta)});const terrainCoordsUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_texture:new performance$1.Uniform1i(context,locations.u_texture),u_terrain_coords_id:new performance$1.Uniform1f(context,locations.u_terrain_coords_id),u_ele_delta:new performance$1.Uniform1f(context,locations.u_ele_delta)});const terrainUniformValues=(matrix,eleDelta)=>({u_matrix:matrix,u_texture:0,u_ele_delta:eleDelta});const terrainDepthUniformValues=(matrix,eleDelta)=>({u_matrix:matrix,u_ele_delta:eleDelta});const terrainCoordsUniformValues=(matrix,coordsId,eleDelta)=>({u_matrix:matrix,u_terrain_coords_id:coordsId/255,u_texture:0,u_ele_delta:eleDelta});function getTokenizedAttributesAndUniforms(array){const result=[];for(let i=0;i<array.length;i++){if(array[i]===null)continue;const token=array[i].split(" ");result.push(token.pop())}return result}class Program{constructor(context,source,configuration,fixedUniforms,showOverdrawInspector,terrain){const gl=context.gl;this.program=gl.createProgram();const staticAttrInfo=getTokenizedAttributesAndUniforms(source.staticAttributes);const dynamicAttrInfo=configuration?configuration.getBinderAttributes():[];const allAttrInfo=staticAttrInfo.concat(dynamicAttrInfo);const preludeUniformsInfo=shaders.prelude.staticUniforms?getTokenizedAttributesAndUniforms(shaders.prelude.staticUniforms):[];const staticUniformsInfo=source.staticUniforms?getTokenizedAttributesAndUniforms(source.staticUniforms):[];const dynamicUniformsInfo=configuration?configuration.getBinderUniforms():[];const uniformList=preludeUniformsInfo.concat(staticUniformsInfo).concat(dynamicUniformsInfo);const allUniformsInfo=[];for(const uniform of uniformList){if(allUniformsInfo.indexOf(uniform)<0)allUniformsInfo.push(uniform)}const defines=configuration?configuration.defines():[];if(showOverdrawInspector){defines.push("#define OVERDRAW_INSPECTOR;")}if(terrain){defines.push("#define TERRAIN3D;")}const fragmentSource=defines.concat(shaders.prelude.fragmentSource,source.fragmentSource).join("\n");const vertexSource=defines.concat(shaders.prelude.vertexSource,source.vertexSource).join("\n");const fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);if(gl.isContextLost()){this.failedToCreate=true;return}gl.shaderSource(fragmentShader,fragmentSource);gl.compileShader(fragmentShader);if(!gl.getShaderParameter(fragmentShader,gl.COMPILE_STATUS)){throw new Error(`Could not compile fragment shader: ${gl.getShaderInfoLog(fragmentShader)}`)}gl.attachShader(this.program,fragmentShader);const vertexShader=gl.createShader(gl.VERTEX_SHADER);if(gl.isContextLost()){this.failedToCreate=true;return}gl.shaderSource(vertexShader,vertexSource);gl.compileShader(vertexShader);if(!gl.getShaderParameter(vertexShader,gl.COMPILE_STATUS)){throw new Error(`Could not compile vertex shader: ${gl.getShaderInfoLog(vertexShader)}`)}gl.attachShader(this.program,vertexShader);this.attributes={};const uniformLocations={};this.numAttributes=allAttrInfo.length;for(let i=0;i<this.numAttributes;i++){if(allAttrInfo[i]){gl.bindAttribLocation(this.program,i,allAttrInfo[i]);this.attributes[allAttrInfo[i]]=i}}gl.linkProgram(this.program);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS)){throw new Error(`Program failed to link: ${gl.getProgramInfoLog(this.program)}`)}gl.deleteShader(vertexShader);gl.deleteShader(fragmentShader);for(let it=0;it<allUniformsInfo.length;it++){const uniform=allUniformsInfo[it];if(uniform&&!uniformLocations[uniform]){const uniformLocation=gl.getUniformLocation(this.program,uniform);if(uniformLocation){uniformLocations[uniform]=uniformLocation}}}this.fixedUniforms=fixedUniforms(context,uniformLocations);this.terrainUniforms=terrainPreludeUniforms(context,uniformLocations);this.binderUniforms=configuration?configuration.getUniforms(context,uniformLocations):[]}draw(context,drawMode,depthMode,stencilMode,colorMode,cullFaceMode,uniformValues,terrain,layerID,layoutVertexBuffer,indexBuffer,segments,currentProperties,zoom,configuration,dynamicLayoutBuffer,dynamicLayoutBuffer2,dynamicLayoutBuffer3){const gl=context.gl;if(this.failedToCreate)return;context.program.set(this.program);context.setDepthMode(depthMode);context.setStencilMode(stencilMode);context.setColorMode(colorMode);context.setCullFace(cullFaceMode);if(terrain){context.activeTexture.set(gl.TEXTURE2);gl.bindTexture(gl.TEXTURE_2D,terrain.depthTexture);context.activeTexture.set(gl.TEXTURE3);gl.bindTexture(gl.TEXTURE_2D,terrain.texture);for(const name in this.terrainUniforms){this.terrainUniforms[name].set(terrain[name])}}for(const name in this.fixedUniforms){this.fixedUniforms[name].set(uniformValues[name])}if(configuration){configuration.setUniforms(context,this.binderUniforms,currentProperties,{zoom:zoom})}let primitiveSize=0;switch(drawMode){case gl.LINES:primitiveSize=2;break;case gl.TRIANGLES:primitiveSize=3;break;case gl.LINE_STRIP:primitiveSize=1;break}for(const segment of segments.get()){const vaos=segment.vaos||(segment.vaos={});const vao=vaos[layerID]||(vaos[layerID]=new VertexArrayObject);vao.bind(context,this,layoutVertexBuffer,configuration?configuration.getPaintVertexBuffers():[],indexBuffer,segment.vertexOffset,dynamicLayoutBuffer,dynamicLayoutBuffer2,dynamicLayoutBuffer3);gl.drawElements(drawMode,segment.primitiveLength*primitiveSize,gl.UNSIGNED_SHORT,segment.primitiveOffset*primitiveSize*2)}}}function patternUniformValues(crossfade,painter,tile){const tileRatio=1/pixelsToTileUnits(tile,1,painter.transform.tileZoom);const numTiles=Math.pow(2,tile.tileID.overscaledZ);const tileSizeAtNearestZoom=tile.tileSize*Math.pow(2,painter.transform.tileZoom)/numTiles;const pixelX=tileSizeAtNearestZoom*(tile.tileID.canonical.x+tile.tileID.wrap*numTiles);const pixelY=tileSizeAtNearestZoom*tile.tileID.canonical.y;return{u_image:0,u_texsize:tile.imageAtlasTexture.size,u_scale:[tileRatio,crossfade.fromScale,crossfade.toScale],u_fade:crossfade.t,u_pixel_coord_upper:[pixelX>>16,pixelY>>16],u_pixel_coord_lower:[pixelX&65535,pixelY&65535]}}function bgPatternUniformValues(image,crossfade,painter,tile){const imagePosA=painter.imageManager.getPattern(image.from.toString());const imagePosB=painter.imageManager.getPattern(image.to.toString());const{width:width,height:height}=painter.imageManager.getPixelSize();const numTiles=Math.pow(2,tile.tileID.overscaledZ);const tileSizeAtNearestZoom=tile.tileSize*Math.pow(2,painter.transform.tileZoom)/numTiles;const pixelX=tileSizeAtNearestZoom*(tile.tileID.canonical.x+tile.tileID.wrap*numTiles);const pixelY=tileSizeAtNearestZoom*tile.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:imagePosA.tl,u_pattern_br_a:imagePosA.br,u_pattern_tl_b:imagePosB.tl,u_pattern_br_b:imagePosB.br,u_texsize:[width,height],u_mix:crossfade.t,u_pattern_size_a:imagePosA.displaySize,u_pattern_size_b:imagePosB.displaySize,u_scale_a:crossfade.fromScale,u_scale_b:crossfade.toScale,u_tile_units_to_pixels:1/pixelsToTileUnits(tile,1,painter.transform.tileZoom),u_pixel_coord_upper:[pixelX>>16,pixelY>>16],u_pixel_coord_lower:[pixelX&65535,pixelY&65535]}}const fillExtrusionUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_lightpos:new performance$1.Uniform3f(context,locations.u_lightpos),u_lightintensity:new performance$1.Uniform1f(context,locations.u_lightintensity),u_lightcolor:new performance$1.Uniform3f(context,locations.u_lightcolor),u_vertical_gradient:new performance$1.Uniform1f(context,locations.u_vertical_gradient),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity)});const fillExtrusionPatternUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_lightpos:new performance$1.Uniform3f(context,locations.u_lightpos),u_lightintensity:new performance$1.Uniform1f(context,locations.u_lightintensity),u_lightcolor:new performance$1.Uniform3f(context,locations.u_lightcolor),u_vertical_gradient:new performance$1.Uniform1f(context,locations.u_vertical_gradient),u_height_factor:new performance$1.Uniform1f(context,locations.u_height_factor),u_image:new performance$1.Uniform1i(context,locations.u_image),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_pixel_coord_upper:new performance$1.Uniform2f(context,locations.u_pixel_coord_upper),u_pixel_coord_lower:new performance$1.Uniform2f(context,locations.u_pixel_coord_lower),u_scale:new performance$1.Uniform3f(context,locations.u_scale),u_fade:new performance$1.Uniform1f(context,locations.u_fade),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity)});const fillExtrusionUniformValues=(matrix,painter,shouldUseVerticalGradient,opacity)=>{const light=painter.style.light;const _lp=light.properties.get("position");const lightPos=[_lp.x,_lp.y,_lp.z];const lightMat=performance$1.create$1();if(light.properties.get("anchor")==="viewport"){performance$1.fromRotation(lightMat,-painter.transform.angle)}performance$1.transformMat3(lightPos,lightPos,lightMat);const lightColor=light.properties.get("color");return{u_matrix:matrix,u_lightpos:lightPos,u_lightintensity:light.properties.get("intensity"),u_lightcolor:[lightColor.r,lightColor.g,lightColor.b],u_vertical_gradient:+shouldUseVerticalGradient,u_opacity:opacity}};const fillExtrusionPatternUniformValues=(matrix,painter,shouldUseVerticalGradient,opacity,coord,crossfade,tile)=>performance$1.extend(fillExtrusionUniformValues(matrix,painter,shouldUseVerticalGradient,opacity),patternUniformValues(crossfade,painter,tile),{u_height_factor:-Math.pow(2,coord.overscaledZ)/tile.tileSize/8});const fillUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix)});const fillPatternUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_image:new performance$1.Uniform1i(context,locations.u_image),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_pixel_coord_upper:new performance$1.Uniform2f(context,locations.u_pixel_coord_upper),u_pixel_coord_lower:new performance$1.Uniform2f(context,locations.u_pixel_coord_lower),u_scale:new performance$1.Uniform3f(context,locations.u_scale),u_fade:new performance$1.Uniform1f(context,locations.u_fade)});const fillOutlineUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_world:new performance$1.Uniform2f(context,locations.u_world)});const fillOutlinePatternUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_world:new performance$1.Uniform2f(context,locations.u_world),u_image:new performance$1.Uniform1i(context,locations.u_image),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_pixel_coord_upper:new performance$1.Uniform2f(context,locations.u_pixel_coord_upper),u_pixel_coord_lower:new performance$1.Uniform2f(context,locations.u_pixel_coord_lower),u_scale:new performance$1.Uniform3f(context,locations.u_scale),u_fade:new performance$1.Uniform1f(context,locations.u_fade)});const fillUniformValues=matrix=>({u_matrix:matrix});const fillPatternUniformValues=(matrix,painter,crossfade,tile)=>performance$1.extend(fillUniformValues(matrix),patternUniformValues(crossfade,painter,tile));const fillOutlineUniformValues=(matrix,drawingBufferSize)=>({u_matrix:matrix,u_world:drawingBufferSize});const fillOutlinePatternUniformValues=(matrix,painter,crossfade,tile,drawingBufferSize)=>performance$1.extend(fillPatternUniformValues(matrix,painter,crossfade,tile),{u_world:drawingBufferSize});const circleUniforms=(context,locations)=>({u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_scale_with_map:new performance$1.Uniform1i(context,locations.u_scale_with_map),u_pitch_with_map:new performance$1.Uniform1i(context,locations.u_pitch_with_map),u_extrude_scale:new performance$1.Uniform2f(context,locations.u_extrude_scale),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix)});const circleUniformValues=(painter,coord,tile,layer)=>{const transform=painter.transform;let pitchWithMap,extrudeScale;if(layer.paint.get("circle-pitch-alignment")==="map"){const pixelRatio=pixelsToTileUnits(tile,1,transform.zoom);pitchWithMap=true;extrudeScale=[pixelRatio,pixelRatio]}else{pitchWithMap=false;extrudeScale=transform.pixelsToGLUnits}return{u_camera_to_center_distance:transform.cameraToCenterDistance,u_scale_with_map:+(layer.paint.get("circle-pitch-scale")==="map"),u_matrix:painter.translatePosMatrix(coord.posMatrix,tile,layer.paint.get("circle-translate"),layer.paint.get("circle-translate-anchor")),u_pitch_with_map:+pitchWithMap,u_device_pixel_ratio:painter.pixelRatio,u_extrude_scale:extrudeScale}};const collisionUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_pixels_to_tile_units:new performance$1.Uniform1f(context,locations.u_pixels_to_tile_units),u_extrude_scale:new performance$1.Uniform2f(context,locations.u_extrude_scale),u_overscale_factor:new performance$1.Uniform1f(context,locations.u_overscale_factor)});const collisionCircleUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_inv_matrix:new performance$1.UniformMatrix4f(context,locations.u_inv_matrix),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_viewport_size:new performance$1.Uniform2f(context,locations.u_viewport_size)});const collisionUniformValues=(matrix,transform,tile)=>{const pixelRatio=pixelsToTileUnits(tile,1,transform.zoom);const scale=Math.pow(2,transform.zoom-tile.tileID.overscaledZ);const overscaleFactor=tile.tileID.overscaleFactor();return{u_matrix:matrix,u_camera_to_center_distance:transform.cameraToCenterDistance,u_pixels_to_tile_units:pixelRatio,u_extrude_scale:[transform.pixelsToGLUnits[0]/(pixelRatio*scale),transform.pixelsToGLUnits[1]/(pixelRatio*scale)],u_overscale_factor:overscaleFactor}};const collisionCircleUniformValues=(matrix,invMatrix,transform)=>({u_matrix:matrix,u_inv_matrix:invMatrix,u_camera_to_center_distance:transform.cameraToCenterDistance,u_viewport_size:[transform.width,transform.height]});const debugUniforms=(context,locations)=>({u_color:new performance$1.UniformColor(context,locations.u_color),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_overlay:new performance$1.Uniform1i(context,locations.u_overlay),u_overlay_scale:new performance$1.Uniform1f(context,locations.u_overlay_scale)});const debugUniformValues=(matrix,color,scaleRatio=1)=>({u_matrix:matrix,u_color:color,u_overlay:0,u_overlay_scale:scaleRatio});const clippingMaskUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix)});const clippingMaskUniformValues=matrix=>({u_matrix:matrix});const heatmapUniforms=(context,locations)=>({u_extrude_scale:new performance$1.Uniform1f(context,locations.u_extrude_scale),u_intensity:new performance$1.Uniform1f(context,locations.u_intensity),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix)});const heatmapTextureUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_world:new performance$1.Uniform2f(context,locations.u_world),u_image:new performance$1.Uniform1i(context,locations.u_image),u_color_ramp:new performance$1.Uniform1i(context,locations.u_color_ramp),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity)});const heatmapUniformValues=(matrix,tile,zoom,intensity)=>({u_matrix:matrix,u_extrude_scale:pixelsToTileUnits(tile,1,zoom),u_intensity:intensity});const heatmapTextureUniformValues=(painter,layer,textureUnit,colorRampUnit)=>{const matrix=performance$1.create();performance$1.ortho(matrix,0,painter.width,painter.height,0,0,1);const gl=painter.context.gl;return{u_matrix:matrix,u_world:[gl.drawingBufferWidth,gl.drawingBufferHeight],u_image:textureUnit,u_color_ramp:colorRampUnit,u_opacity:layer.paint.get("heatmap-opacity")}};const hillshadeUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_image:new performance$1.Uniform1i(context,locations.u_image),u_latrange:new performance$1.Uniform2f(context,locations.u_latrange),u_light:new performance$1.Uniform2f(context,locations.u_light),u_shadow:new performance$1.UniformColor(context,locations.u_shadow),u_highlight:new performance$1.UniformColor(context,locations.u_highlight),u_accent:new performance$1.UniformColor(context,locations.u_accent)});const hillshadePrepareUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_image:new performance$1.Uniform1i(context,locations.u_image),u_dimension:new performance$1.Uniform2f(context,locations.u_dimension),u_zoom:new performance$1.Uniform1f(context,locations.u_zoom),u_unpack:new performance$1.Uniform4f(context,locations.u_unpack)});const hillshadeUniformValues=(painter,tile,layer,coord)=>{const shadow=layer.paint.get("hillshade-shadow-color");const highlight=layer.paint.get("hillshade-highlight-color");const accent=layer.paint.get("hillshade-accent-color");let azimuthal=layer.paint.get("hillshade-illumination-direction")*(Math.PI/180);if(layer.paint.get("hillshade-illumination-anchor")==="viewport"){azimuthal-=painter.transform.angle}const align=!painter.options.moving;return{u_matrix:coord?coord.posMatrix:painter.transform.calculatePosMatrix(tile.tileID.toUnwrapped(),align),u_image:0,u_latrange:getTileLatRange(painter,tile.tileID),u_light:[layer.paint.get("hillshade-exaggeration"),azimuthal],u_shadow:shadow,u_highlight:highlight,u_accent:accent}};const hillshadeUniformPrepareValues=(tileID,dem)=>{const stride=dem.stride;const matrix=performance$1.create();performance$1.ortho(matrix,0,performance$1.EXTENT,-performance$1.EXTENT,0,0,1);performance$1.translate(matrix,matrix,[0,-performance$1.EXTENT,0]);return{u_matrix:matrix,u_image:1,u_dimension:[stride,stride],u_zoom:tileID.overscaledZ,u_unpack:dem.getUnpackVector()}};function getTileLatRange(painter,tileID){const tilesAtZoom=Math.pow(2,tileID.canonical.z);const y=tileID.canonical.y;return[new performance$1.MercatorCoordinate(0,y/tilesAtZoom).toLngLat().lat,new performance$1.MercatorCoordinate(0,(y+1)/tilesAtZoom).toLngLat().lat]}const lineUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_ratio:new performance$1.Uniform1f(context,locations.u_ratio),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_units_to_pixels:new performance$1.Uniform2f(context,locations.u_units_to_pixels)});const lineGradientUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_ratio:new performance$1.Uniform1f(context,locations.u_ratio),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_units_to_pixels:new performance$1.Uniform2f(context,locations.u_units_to_pixels),u_image:new performance$1.Uniform1i(context,locations.u_image),u_image_height:new performance$1.Uniform1f(context,locations.u_image_height)});const linePatternUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_ratio:new performance$1.Uniform1f(context,locations.u_ratio),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_image:new performance$1.Uniform1i(context,locations.u_image),u_units_to_pixels:new performance$1.Uniform2f(context,locations.u_units_to_pixels),u_scale:new performance$1.Uniform3f(context,locations.u_scale),u_fade:new performance$1.Uniform1f(context,locations.u_fade)});const lineSDFUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_ratio:new performance$1.Uniform1f(context,locations.u_ratio),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_units_to_pixels:new performance$1.Uniform2f(context,locations.u_units_to_pixels),u_patternscale_a:new performance$1.Uniform2f(context,locations.u_patternscale_a),u_patternscale_b:new performance$1.Uniform2f(context,locations.u_patternscale_b),u_sdfgamma:new performance$1.Uniform1f(context,locations.u_sdfgamma),u_image:new performance$1.Uniform1i(context,locations.u_image),u_tex_y_a:new performance$1.Uniform1f(context,locations.u_tex_y_a),u_tex_y_b:new performance$1.Uniform1f(context,locations.u_tex_y_b),u_mix:new performance$1.Uniform1f(context,locations.u_mix)});const lineUniformValues=(painter,tile,layer,coord)=>{const transform=painter.transform;return{u_matrix:calculateMatrix(painter,tile,layer,coord),u_ratio:1/pixelsToTileUnits(tile,1,transform.zoom),u_device_pixel_ratio:painter.pixelRatio,u_units_to_pixels:[1/transform.pixelsToGLUnits[0],1/transform.pixelsToGLUnits[1]]}};const lineGradientUniformValues=(painter,tile,layer,imageHeight,coord)=>performance$1.extend(lineUniformValues(painter,tile,layer,coord),{u_image:0,u_image_height:imageHeight});const linePatternUniformValues=(painter,tile,layer,crossfade,coord)=>{const transform=painter.transform;const tileZoomRatio=calculateTileRatio(tile,transform);return{u_matrix:calculateMatrix(painter,tile,layer,coord),u_texsize:tile.imageAtlasTexture.size,u_ratio:1/pixelsToTileUnits(tile,1,transform.zoom),u_device_pixel_ratio:painter.pixelRatio,u_image:0,u_scale:[tileZoomRatio,crossfade.fromScale,crossfade.toScale],u_fade:crossfade.t,u_units_to_pixels:[1/transform.pixelsToGLUnits[0],1/transform.pixelsToGLUnits[1]]}};const lineSDFUniformValues=(painter,tile,layer,dasharray,crossfade,coord)=>{const transform=painter.transform;const lineAtlas=painter.lineAtlas;const tileRatio=calculateTileRatio(tile,transform);const round=layer.layout.get("line-cap")==="round";const posA=lineAtlas.getDash(dasharray.from,round);const posB=lineAtlas.getDash(dasharray.to,round);const widthA=posA.width*crossfade.fromScale;const widthB=posB.width*crossfade.toScale;return performance$1.extend(lineUniformValues(painter,tile,layer,coord),{u_patternscale_a:[tileRatio/widthA,-posA.height/2],u_patternscale_b:[tileRatio/widthB,-posB.height/2],u_sdfgamma:lineAtlas.width/(Math.min(widthA,widthB)*256*painter.pixelRatio)/2,u_image:0,u_tex_y_a:posA.y,u_tex_y_b:posB.y,u_mix:crossfade.t})};function calculateTileRatio(tile,transform){return 1/pixelsToTileUnits(tile,1,transform.tileZoom)}function calculateMatrix(painter,tile,layer,coord){return painter.translatePosMatrix(coord?coord.posMatrix:tile.tileID.posMatrix,tile,layer.paint.get("line-translate"),layer.paint.get("line-translate-anchor"))}const rasterUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_tl_parent:new performance$1.Uniform2f(context,locations.u_tl_parent),u_scale_parent:new performance$1.Uniform1f(context,locations.u_scale_parent),u_buffer_scale:new performance$1.Uniform1f(context,locations.u_buffer_scale),u_fade_t:new performance$1.Uniform1f(context,locations.u_fade_t),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity),u_image0:new performance$1.Uniform1i(context,locations.u_image0),u_image1:new performance$1.Uniform1i(context,locations.u_image1),u_brightness_low:new performance$1.Uniform1f(context,locations.u_brightness_low),u_brightness_high:new performance$1.Uniform1f(context,locations.u_brightness_high),u_saturation_factor:new performance$1.Uniform1f(context,locations.u_saturation_factor),u_contrast_factor:new performance$1.Uniform1f(context,locations.u_contrast_factor),u_spin_weights:new performance$1.Uniform3f(context,locations.u_spin_weights)});const rasterUniformValues=(matrix,parentTL,parentScaleBy,fade,layer)=>({u_matrix:matrix,u_tl_parent:parentTL,u_scale_parent:parentScaleBy,u_buffer_scale:1,u_fade_t:fade.mix,u_opacity:fade.opacity*layer.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:layer.paint.get("raster-brightness-min"),u_brightness_high:layer.paint.get("raster-brightness-max"),u_saturation_factor:saturationFactor(layer.paint.get("raster-saturation")),u_contrast_factor:contrastFactor(layer.paint.get("raster-contrast")),u_spin_weights:spinWeights(layer.paint.get("raster-hue-rotate"))});function spinWeights(angle){angle*=Math.PI/180;const s=Math.sin(angle);const c=Math.cos(angle);return[(2*c+1)/3,(-Math.sqrt(3)*s-c+1)/3,(Math.sqrt(3)*s-c+1)/3]}function contrastFactor(contrast){return contrast>0?1/(1-contrast):1+contrast}function saturationFactor(saturation){return saturation>0?1-1/(1.001-saturation):-saturation}const symbolIconUniforms=(context,locations)=>({u_is_size_zoom_constant:new performance$1.Uniform1i(context,locations.u_is_size_zoom_constant),u_is_size_feature_constant:new performance$1.Uniform1i(context,locations.u_is_size_feature_constant),u_size_t:new performance$1.Uniform1f(context,locations.u_size_t),u_size:new performance$1.Uniform1f(context,locations.u_size),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_pitch:new performance$1.Uniform1f(context,locations.u_pitch),u_rotate_symbol:new performance$1.Uniform1i(context,locations.u_rotate_symbol),u_aspect_ratio:new performance$1.Uniform1f(context,locations.u_aspect_ratio),u_fade_change:new performance$1.Uniform1f(context,locations.u_fade_change),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_label_plane_matrix:new performance$1.UniformMatrix4f(context,locations.u_label_plane_matrix),u_coord_matrix:new performance$1.UniformMatrix4f(context,locations.u_coord_matrix),u_is_text:new performance$1.Uniform1i(context,locations.u_is_text),u_pitch_with_map:new performance$1.Uniform1i(context,locations.u_pitch_with_map),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_texture:new performance$1.Uniform1i(context,locations.u_texture)});const symbolSDFUniforms=(context,locations)=>({u_is_size_zoom_constant:new performance$1.Uniform1i(context,locations.u_is_size_zoom_constant),u_is_size_feature_constant:new performance$1.Uniform1i(context,locations.u_is_size_feature_constant),u_size_t:new performance$1.Uniform1f(context,locations.u_size_t),u_size:new performance$1.Uniform1f(context,locations.u_size),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_pitch:new performance$1.Uniform1f(context,locations.u_pitch),u_rotate_symbol:new performance$1.Uniform1i(context,locations.u_rotate_symbol),u_aspect_ratio:new performance$1.Uniform1f(context,locations.u_aspect_ratio),u_fade_change:new performance$1.Uniform1f(context,locations.u_fade_change),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_label_plane_matrix:new performance$1.UniformMatrix4f(context,locations.u_label_plane_matrix),u_coord_matrix:new performance$1.UniformMatrix4f(context,locations.u_coord_matrix),u_is_text:new performance$1.Uniform1i(context,locations.u_is_text),u_pitch_with_map:new performance$1.Uniform1i(context,locations.u_pitch_with_map),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_texture:new performance$1.Uniform1i(context,locations.u_texture),u_gamma_scale:new performance$1.Uniform1f(context,locations.u_gamma_scale),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_is_halo:new performance$1.Uniform1i(context,locations.u_is_halo)});const symbolTextAndIconUniforms=(context,locations)=>({u_is_size_zoom_constant:new performance$1.Uniform1i(context,locations.u_is_size_zoom_constant),u_is_size_feature_constant:new performance$1.Uniform1i(context,locations.u_is_size_feature_constant),u_size_t:new performance$1.Uniform1f(context,locations.u_size_t),u_size:new performance$1.Uniform1f(context,locations.u_size),u_camera_to_center_distance:new performance$1.Uniform1f(context,locations.u_camera_to_center_distance),u_pitch:new performance$1.Uniform1f(context,locations.u_pitch),u_rotate_symbol:new performance$1.Uniform1i(context,locations.u_rotate_symbol),u_aspect_ratio:new performance$1.Uniform1f(context,locations.u_aspect_ratio),u_fade_change:new performance$1.Uniform1f(context,locations.u_fade_change),u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_label_plane_matrix:new performance$1.UniformMatrix4f(context,locations.u_label_plane_matrix),u_coord_matrix:new performance$1.UniformMatrix4f(context,locations.u_coord_matrix),u_is_text:new performance$1.Uniform1i(context,locations.u_is_text),u_pitch_with_map:new performance$1.Uniform1i(context,locations.u_pitch_with_map),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_texsize_icon:new performance$1.Uniform2f(context,locations.u_texsize_icon),u_texture:new performance$1.Uniform1i(context,locations.u_texture),u_texture_icon:new performance$1.Uniform1i(context,locations.u_texture_icon),u_gamma_scale:new performance$1.Uniform1f(context,locations.u_gamma_scale),u_device_pixel_ratio:new performance$1.Uniform1f(context,locations.u_device_pixel_ratio),u_is_halo:new performance$1.Uniform1i(context,locations.u_is_halo)});const symbolIconUniformValues=(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,isText,texSize)=>{const transform=painter.transform;return{u_is_size_zoom_constant:+(functionType==="constant"||functionType==="source"),u_is_size_feature_constant:+(functionType==="constant"||functionType==="camera"),u_size_t:size?size.uSizeT:0,u_size:size?size.uSize:0,u_camera_to_center_distance:transform.cameraToCenterDistance,u_pitch:transform.pitch/360*2*Math.PI,u_rotate_symbol:+rotateInShader,u_aspect_ratio:transform.width/transform.height,u_fade_change:painter.options.fadeDuration?painter.symbolFadeChange:1,u_matrix:matrix,u_label_plane_matrix:labelPlaneMatrix,u_coord_matrix:glCoordMatrix,u_is_text:+isText,u_pitch_with_map:+pitchWithMap,u_texsize:texSize,u_texture:0}};const symbolSDFUniformValues=(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,isText,texSize,isHalo)=>{const transform=painter.transform;return performance$1.extend(symbolIconUniformValues(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,isText,texSize),{u_gamma_scale:pitchWithMap?Math.cos(transform._pitch)*transform.cameraToCenterDistance:1,u_device_pixel_ratio:painter.pixelRatio,u_is_halo:+isHalo})};const symbolTextAndIconUniformValues=(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,texSizeSDF,texSizeIcon)=>performance$1.extend(symbolSDFUniformValues(functionType,size,rotateInShader,pitchWithMap,painter,matrix,labelPlaneMatrix,glCoordMatrix,true,texSizeSDF,true),{u_texsize_icon:texSizeIcon,u_texture_icon:1});const backgroundUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity),u_color:new performance$1.UniformColor(context,locations.u_color)});const backgroundPatternUniforms=(context,locations)=>({u_matrix:new performance$1.UniformMatrix4f(context,locations.u_matrix),u_opacity:new performance$1.Uniform1f(context,locations.u_opacity),u_image:new performance$1.Uniform1i(context,locations.u_image),u_pattern_tl_a:new performance$1.Uniform2f(context,locations.u_pattern_tl_a),u_pattern_br_a:new performance$1.Uniform2f(context,locations.u_pattern_br_a),u_pattern_tl_b:new performance$1.Uniform2f(context,locations.u_pattern_tl_b),u_pattern_br_b:new performance$1.Uniform2f(context,locations.u_pattern_br_b),u_texsize:new performance$1.Uniform2f(context,locations.u_texsize),u_mix:new performance$1.Uniform1f(context,locations.u_mix),u_pattern_size_a:new performance$1.Uniform2f(context,locations.u_pattern_size_a),u_pattern_size_b:new performance$1.Uniform2f(context,locations.u_pattern_size_b),u_scale_a:new performance$1.Uniform1f(context,locations.u_scale_a),u_scale_b:new performance$1.Uniform1f(context,locations.u_scale_b),u_pixel_coord_upper:new performance$1.Uniform2f(context,locations.u_pixel_coord_upper),u_pixel_coord_lower:new performance$1.Uniform2f(context,locations.u_pixel_coord_lower),u_tile_units_to_pixels:new performance$1.Uniform1f(context,locations.u_tile_units_to_pixels)});const backgroundUniformValues=(matrix,opacity,color)=>({u_matrix:matrix,u_opacity:opacity,u_color:color});const backgroundPatternUniformValues=(matrix,opacity,painter,image,tile,crossfade)=>performance$1.extend(bgPatternUniformValues(image,crossfade,painter,tile),{u_matrix:matrix,u_opacity:opacity});const programUniforms={fillExtrusion:fillExtrusionUniforms,fillExtrusionPattern:fillExtrusionPatternUniforms,fill:fillUniforms,fillPattern:fillPatternUniforms,fillOutline:fillOutlineUniforms,fillOutlinePattern:fillOutlinePatternUniforms,circle:circleUniforms,collisionBox:collisionUniforms,collisionCircle:collisionCircleUniforms,debug:debugUniforms,clippingMask:clippingMaskUniforms,heatmap:heatmapUniforms,heatmapTexture:heatmapTextureUniforms,hillshade:hillshadeUniforms,hillshadePrepare:hillshadePrepareUniforms,line:lineUniforms,lineGradient:lineGradientUniforms,linePattern:linePatternUniforms,lineSDF:lineSDFUniforms,raster:rasterUniforms,symbolIcon:symbolIconUniforms,symbolSDF:symbolSDFUniforms,symbolTextAndIcon:symbolTextAndIconUniforms,background:backgroundUniforms,backgroundPattern:backgroundPatternUniforms,terrain:terrainUniforms,terrainDepth:terrainDepthUniforms,terrainCoords:terrainCoordsUniforms};class IndexBuffer{constructor(context,array,dynamicDraw){this.context=context;const gl=context.gl;this.buffer=gl.createBuffer();this.dynamicDraw=Boolean(dynamicDraw);this.context.unbindVAO();context.bindElementBuffer.set(this.buffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,array.arrayBuffer,this.dynamicDraw?gl.DYNAMIC_DRAW:gl.STATIC_DRAW);if(!this.dynamicDraw){delete array.arrayBuffer}}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(array){const gl=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO();this.bind();gl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER,0,array.arrayBuffer)}destroy(){const gl=this.context.gl;if(this.buffer){gl.deleteBuffer(this.buffer);delete this.buffer}}}const AttributeType={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class VertexBuffer{constructor(context,array,attributes,dynamicDraw){this.length=array.length;this.attributes=attributes;this.itemSize=array.bytesPerElement;this.dynamicDraw=dynamicDraw;this.context=context;const gl=context.gl;this.buffer=gl.createBuffer();context.bindVertexBuffer.set(this.buffer);gl.bufferData(gl.ARRAY_BUFFER,array.arrayBuffer,this.dynamicDraw?gl.DYNAMIC_DRAW:gl.STATIC_DRAW);if(!this.dynamicDraw){delete array.arrayBuffer}}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(array){if(array.length!==this.length)throw new Error(`Length of new data is ${array.length}, which doesn't match current length of ${this.length}`);const gl=this.context.gl;this.bind();gl.bufferSubData(gl.ARRAY_BUFFER,0,array.arrayBuffer)}enableAttributes(gl,program){for(let j=0;j<this.attributes.length;j++){const member=this.attributes[j];const attribIndex=program.attributes[member.name];if(attribIndex!==undefined){gl.enableVertexAttribArray(attribIndex)}}}setVertexAttribPointers(gl,program,vertexOffset){for(let j=0;j<this.attributes.length;j++){const member=this.attributes[j];const attribIndex=program.attributes[member.name];if(attribIndex!==undefined){gl.vertexAttribPointer(attribIndex,member.components,gl[AttributeType[member.type]],false,this.itemSize,member.offset+this.itemSize*(vertexOffset||0))}}}destroy(){const gl=this.context.gl;if(this.buffer){gl.deleteBuffer(this.buffer);delete this.buffer}}}const cache=new WeakMap;function isWebGL2(gl){var _a;if(cache.has(gl)){return cache.get(gl)}else{const value=(_a=gl.getParameter(gl.VERSION))===null||_a===void 0?void 0:_a.startsWith("WebGL 2.0");cache.set(gl,value);return value}}class BaseValue{constructor(context){this.gl=context.gl;this.default=this.getDefault();this.current=this.default;this.dirty=false}get(){return this.current}set(value){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class ClearColor extends BaseValue{getDefault(){return performance$1.Color.transparent}set(v){const c=this.current;if(v.r===c.r&&v.g===c.g&&v.b===c.b&&v.a===c.a&&!this.dirty)return;this.gl.clearColor(v.r,v.g,v.b,v.a);this.current=v;this.dirty=false}}class ClearDepth extends BaseValue{getDefault(){return 1}set(v){if(v===this.current&&!this.dirty)return;this.gl.clearDepth(v);this.current=v;this.dirty=false}}class ClearStencil extends BaseValue{getDefault(){return 0}set(v){if(v===this.current&&!this.dirty)return;this.gl.clearStencil(v);this.current=v;this.dirty=false}}class ColorMask extends BaseValue{getDefault(){return[true,true,true,true]}set(v){const c=this.current;if(v[0]===c[0]&&v[1]===c[1]&&v[2]===c[2]&&v[3]===c[3]&&!this.dirty)return;this.gl.colorMask(v[0],v[1],v[2],v[3]);this.current=v;this.dirty=false}}class DepthMask extends BaseValue{getDefault(){return true}set(v){if(v===this.current&&!this.dirty)return;this.gl.depthMask(v);this.current=v;this.dirty=false}}class StencilMask extends BaseValue{getDefault(){return 255}set(v){if(v===this.current&&!this.dirty)return;this.gl.stencilMask(v);this.current=v;this.dirty=false}}class StencilFunc extends BaseValue{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(v){const c=this.current;if(v.func===c.func&&v.ref===c.ref&&v.mask===c.mask&&!this.dirty)return;this.gl.stencilFunc(v.func,v.ref,v.mask);this.current=v;this.dirty=false}}class StencilOp extends BaseValue{getDefault(){const gl=this.gl;return[gl.KEEP,gl.KEEP,gl.KEEP]}set(v){const c=this.current;if(v[0]===c[0]&&v[1]===c[1]&&v[2]===c[2]&&!this.dirty)return;this.gl.stencilOp(v[0],v[1],v[2]);this.current=v;this.dirty=false}}class StencilTest extends BaseValue{getDefault(){return false}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;if(v){gl.enable(gl.STENCIL_TEST)}else{gl.disable(gl.STENCIL_TEST)}this.current=v;this.dirty=false}}class DepthRange extends BaseValue{getDefault(){return[0,1]}set(v){const c=this.current;if(v[0]===c[0]&&v[1]===c[1]&&!this.dirty)return;this.gl.depthRange(v[0],v[1]);this.current=v;this.dirty=false}}class DepthTest extends BaseValue{getDefault(){return false}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;if(v){gl.enable(gl.DEPTH_TEST)}else{gl.disable(gl.DEPTH_TEST)}this.current=v;this.dirty=false}}class DepthFunc extends BaseValue{getDefault(){return this.gl.LESS}set(v){if(v===this.current&&!this.dirty)return;this.gl.depthFunc(v);this.current=v;this.dirty=false}}class Blend extends BaseValue{getDefault(){return false}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;if(v){gl.enable(gl.BLEND)}else{gl.disable(gl.BLEND)}this.current=v;this.dirty=false}}class BlendFunc extends BaseValue{getDefault(){const gl=this.gl;return[gl.ONE,gl.ZERO]}set(v){const c=this.current;if(v[0]===c[0]&&v[1]===c[1]&&!this.dirty)return;this.gl.blendFunc(v[0],v[1]);this.current=v;this.dirty=false}}class BlendColor extends BaseValue{getDefault(){return performance$1.Color.transparent}set(v){const c=this.current;if(v.r===c.r&&v.g===c.g&&v.b===c.b&&v.a===c.a&&!this.dirty)return;this.gl.blendColor(v.r,v.g,v.b,v.a);this.current=v;this.dirty=false}}class BlendEquation extends BaseValue{getDefault(){return this.gl.FUNC_ADD}set(v){if(v===this.current&&!this.dirty)return;this.gl.blendEquation(v);this.current=v;this.dirty=false}}class CullFace extends BaseValue{getDefault(){return false}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;if(v){gl.enable(gl.CULL_FACE)}else{gl.disable(gl.CULL_FACE)}this.current=v;this.dirty=false}}class CullFaceSide extends BaseValue{getDefault(){return this.gl.BACK}set(v){if(v===this.current&&!this.dirty)return;this.gl.cullFace(v);this.current=v;this.dirty=false}}class FrontFace extends BaseValue{getDefault(){return this.gl.CCW}set(v){if(v===this.current&&!this.dirty)return;this.gl.frontFace(v);this.current=v;this.dirty=false}}class ProgramValue extends BaseValue{getDefault(){return null}set(v){if(v===this.current&&!this.dirty)return;this.gl.useProgram(v);this.current=v;this.dirty=false}}class ActiveTextureUnit extends BaseValue{getDefault(){return this.gl.TEXTURE0}set(v){if(v===this.current&&!this.dirty)return;this.gl.activeTexture(v);this.current=v;this.dirty=false}}class Viewport extends BaseValue{getDefault(){const gl=this.gl;return[0,0,gl.drawingBufferWidth,gl.drawingBufferHeight]}set(v){const c=this.current;if(v[0]===c[0]&&v[1]===c[1]&&v[2]===c[2]&&v[3]===c[3]&&!this.dirty)return;this.gl.viewport(v[0],v[1],v[2],v[3]);this.current=v;this.dirty=false}}class BindFramebuffer extends BaseValue{getDefault(){return null}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,v);this.current=v;this.dirty=false}}class BindRenderbuffer extends BaseValue{getDefault(){return null}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.bindRenderbuffer(gl.RENDERBUFFER,v);this.current=v;this.dirty=false}}class BindTexture extends BaseValue{getDefault(){return null}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.bindTexture(gl.TEXTURE_2D,v);this.current=v;this.dirty=false}}class BindVertexBuffer extends BaseValue{getDefault(){return null}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.bindBuffer(gl.ARRAY_BUFFER,v);this.current=v;this.dirty=false}}class BindElementBuffer extends BaseValue{getDefault(){return null}set(v){const gl=this.gl;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,v);this.current=v;this.dirty=false}}class BindVertexArray extends BaseValue{getDefault(){return null}set(v){var _a;if(v===this.current&&!this.dirty)return;const gl=this.gl;if(isWebGL2(gl)){gl.bindVertexArray(v)}else{(_a=gl.getExtension("OES_vertex_array_object"))===null||_a===void 0?void 0:_a.bindVertexArrayOES(v)}this.current=v;this.dirty=false}}class PixelStoreUnpack extends BaseValue{getDefault(){return 4}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.pixelStorei(gl.UNPACK_ALIGNMENT,v);this.current=v;this.dirty=false}}class PixelStoreUnpackPremultiplyAlpha extends BaseValue{getDefault(){return false}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,v);this.current=v;this.dirty=false}}class PixelStoreUnpackFlipY extends BaseValue{getDefault(){return false}set(v){if(v===this.current&&!this.dirty)return;const gl=this.gl;gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,v);this.current=v;this.dirty=false}}class FramebufferAttachment extends BaseValue{constructor(context,parent){super(context);this.context=context;this.parent=parent}getDefault(){return null}}class ColorAttachment extends FramebufferAttachment{setDirty(){this.dirty=true}set(v){if(v===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const gl=this.gl;gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,v,0);this.current=v;this.dirty=false}}class DepthAttachment extends FramebufferAttachment{set(v){if(v===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const gl=this.gl;gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,v);this.current=v;this.dirty=false}}class DepthStencilAttachment extends FramebufferAttachment{set(v){if(v===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const gl=this.gl;gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,v);this.current=v;this.dirty=false}}class Framebuffer{constructor(context,width,height,hasDepth,hasStencil){this.context=context;this.width=width;this.height=height;const gl=context.gl;const fbo=this.framebuffer=gl.createFramebuffer();this.colorAttachment=new ColorAttachment(context,fbo);if(hasDepth){this.depthAttachment=hasStencil?new DepthStencilAttachment(context,fbo):new DepthAttachment(context,fbo)}else if(hasStencil){throw new Error("Stencil cannot be set without depth")}if(gl.checkFramebufferStatus(gl.FRAMEBUFFER)!==gl.FRAMEBUFFER_COMPLETE){throw new Error("Framebuffer is not complete")}}destroy(){const gl=this.context.gl;const texture=this.colorAttachment.get();if(texture)gl.deleteTexture(texture);if(this.depthAttachment){const renderbuffer=this.depthAttachment.get();if(renderbuffer)gl.deleteRenderbuffer(renderbuffer)}gl.deleteFramebuffer(this.framebuffer)}}const ZERO=0;const ONE=1;const ONE_MINUS_SRC_ALPHA=771;class ColorMode{constructor(blendFunction,blendColor,mask){this.blendFunction=blendFunction;this.blendColor=blendColor;this.mask=mask}}ColorMode.Replace=[ONE,ZERO];ColorMode.disabled=new ColorMode(ColorMode.Replace,performance$1.Color.transparent,[false,false,false,false]);ColorMode.unblended=new ColorMode(ColorMode.Replace,performance$1.Color.transparent,[true,true,true,true]);ColorMode.alphaBlended=new ColorMode([ONE,ONE_MINUS_SRC_ALPHA],performance$1.Color.transparent,[true,true,true,true]);class Context{constructor(gl){var _a,_b;this.gl=gl;this.clearColor=new ClearColor(this);this.clearDepth=new ClearDepth(this);this.clearStencil=new ClearStencil(this);this.colorMask=new ColorMask(this);this.depthMask=new DepthMask(this);this.stencilMask=new StencilMask(this);this.stencilFunc=new StencilFunc(this);this.stencilOp=new StencilOp(this);this.stencilTest=new StencilTest(this);this.depthRange=new DepthRange(this);this.depthTest=new DepthTest(this);this.depthFunc=new DepthFunc(this);this.blend=new Blend(this);this.blendFunc=new BlendFunc(this);this.blendColor=new BlendColor(this);this.blendEquation=new BlendEquation(this);this.cullFace=new CullFace(this);this.cullFaceSide=new CullFaceSide(this);this.frontFace=new FrontFace(this);this.program=new ProgramValue(this);this.activeTexture=new ActiveTextureUnit(this);this.viewport=new Viewport(this);this.bindFramebuffer=new BindFramebuffer(this);this.bindRenderbuffer=new BindRenderbuffer(this);this.bindTexture=new BindTexture(this);this.bindVertexBuffer=new BindVertexBuffer(this);this.bindElementBuffer=new BindElementBuffer(this);this.bindVertexArray=new BindVertexArray(this);this.pixelStoreUnpack=new PixelStoreUnpack(this);this.pixelStoreUnpackPremultiplyAlpha=new PixelStoreUnpackPremultiplyAlpha(this);this.pixelStoreUnpackFlipY=new PixelStoreUnpackFlipY(this);this.extTextureFilterAnisotropic=gl.getExtension("EXT_texture_filter_anisotropic")||gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");if(this.extTextureFilterAnisotropic){this.extTextureFilterAnisotropicMax=gl.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}this.maxTextureSize=gl.getParameter(gl.MAX_TEXTURE_SIZE);if(isWebGL2(gl)){this.HALF_FLOAT=gl.HALF_FLOAT;const extColorBufferHalfFloat=gl.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(_a=gl.RGBA16F)!==null&&_a!==void 0?_a:extColorBufferHalfFloat===null||extColorBufferHalfFloat===void 0?void 0:extColorBufferHalfFloat.RGBA16F_EXT;this.RGB16F=(_b=gl.RGB16F)!==null&&_b!==void 0?_b:extColorBufferHalfFloat===null||extColorBufferHalfFloat===void 0?void 0:extColorBufferHalfFloat.RGB16F_EXT;gl.getExtension("EXT_color_buffer_float")}else{gl.getExtension("EXT_color_buffer_half_float");gl.getExtension("OES_texture_half_float_linear");const extTextureHalfFloat=gl.getExtension("OES_texture_half_float");this.HALF_FLOAT=extTextureHalfFloat===null||extTextureHalfFloat===void 0?void 0:extTextureHalfFloat.HALF_FLOAT_OES}}setDefault(){this.unbindVAO();this.clearColor.setDefault();this.clearDepth.setDefault();this.clearStencil.setDefault();this.colorMask.setDefault();this.depthMask.setDefault();this.stencilMask.setDefault();this.stencilFunc.setDefault();this.stencilOp.setDefault();this.stencilTest.setDefault();this.depthRange.setDefault();this.depthTest.setDefault();this.depthFunc.setDefault();this.blend.setDefault();this.blendFunc.setDefault();this.blendColor.setDefault();this.blendEquation.setDefault();this.cullFace.setDefault();this.cullFaceSide.setDefault();this.frontFace.setDefault();this.program.setDefault();this.activeTexture.setDefault();this.bindFramebuffer.setDefault();this.pixelStoreUnpack.setDefault();this.pixelStoreUnpackPremultiplyAlpha.setDefault();this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=true;this.clearDepth.dirty=true;this.clearStencil.dirty=true;this.colorMask.dirty=true;this.depthMask.dirty=true;this.stencilMask.dirty=true;this.stencilFunc.dirty=true;this.stencilOp.dirty=true;this.stencilTest.dirty=true;this.depthRange.dirty=true;this.depthTest.dirty=true;this.depthFunc.dirty=true;this.blend.dirty=true;this.blendFunc.dirty=true;this.blendColor.dirty=true;this.blendEquation.dirty=true;this.cullFace.dirty=true;this.cullFaceSide.dirty=true;this.frontFace.dirty=true;this.program.dirty=true;this.activeTexture.dirty=true;this.viewport.dirty=true;this.bindFramebuffer.dirty=true;this.bindRenderbuffer.dirty=true;this.bindTexture.dirty=true;this.bindVertexBuffer.dirty=true;this.bindElementBuffer.dirty=true;this.bindVertexArray.dirty=true;this.pixelStoreUnpack.dirty=true;this.pixelStoreUnpackPremultiplyAlpha.dirty=true;this.pixelStoreUnpackFlipY.dirty=true}createIndexBuffer(array,dynamicDraw){return new IndexBuffer(this,array,dynamicDraw)}createVertexBuffer(array,attributes,dynamicDraw){return new VertexBuffer(this,array,attributes,dynamicDraw)}createRenderbuffer(storageFormat,width,height){const gl=this.gl;const rbo=gl.createRenderbuffer();this.bindRenderbuffer.set(rbo);gl.renderbufferStorage(gl.RENDERBUFFER,storageFormat,width,height);this.bindRenderbuffer.set(null);return rbo}createFramebuffer(width,height,hasDepth,hasStencil){return new Framebuffer(this,width,height,hasDepth,hasStencil)}clear({color:color,depth:depth,stencil:stencil}){const gl=this.gl;let mask=0;if(color){mask|=gl.COLOR_BUFFER_BIT;this.clearColor.set(color);this.colorMask.set([true,true,true,true])}if(typeof depth!=="undefined"){mask|=gl.DEPTH_BUFFER_BIT;this.depthRange.set([0,1]);this.clearDepth.set(depth);this.depthMask.set(true)}if(typeof stencil!=="undefined"){mask|=gl.STENCIL_BUFFER_BIT;this.clearStencil.set(stencil);this.stencilMask.set(255)}gl.clear(mask)}setCullFace(cullFaceMode){if(cullFaceMode.enable===false){this.cullFace.set(false)}else{this.cullFace.set(true);this.cullFaceSide.set(cullFaceMode.mode);this.frontFace.set(cullFaceMode.frontFace)}}setDepthMode(depthMode){if(depthMode.func===this.gl.ALWAYS&&!depthMode.mask){this.depthTest.set(false)}else{this.depthTest.set(true);this.depthFunc.set(depthMode.func);this.depthMask.set(depthMode.mask);this.depthRange.set(depthMode.range)}}setStencilMode(stencilMode){if(stencilMode.test.func===this.gl.ALWAYS&&!stencilMode.mask){this.stencilTest.set(false)}else{this.stencilTest.set(true);this.stencilMask.set(stencilMode.mask);this.stencilOp.set([stencilMode.fail,stencilMode.depthFail,stencilMode.pass]);this.stencilFunc.set({func:stencilMode.test.func,ref:stencilMode.ref,mask:stencilMode.test.mask})}}setColorMode(colorMode){if(performance$1.deepEqual(colorMode.blendFunction,ColorMode.Replace)){this.blend.set(false)}else{this.blend.set(true);this.blendFunc.set(colorMode.blendFunction);this.blendColor.set(colorMode.blendColor)}this.colorMask.set(colorMode.mask)}createVertexArray(){var _a;if(isWebGL2(this.gl))return this.gl.createVertexArray();return(_a=this.gl.getExtension("OES_vertex_array_object"))===null||_a===void 0?void 0:_a.createVertexArrayOES()}deleteVertexArray(x){var _a;if(isWebGL2(this.gl))return this.gl.deleteVertexArray(x);return(_a=this.gl.getExtension("OES_vertex_array_object"))===null||_a===void 0?void 0:_a.deleteVertexArrayOES(x)}unbindVAO(){this.bindVertexArray.set(null)}}const ALWAYS$1=519;class DepthMode{constructor(depthFunc,depthMask,depthRange){this.func=depthFunc;this.mask=depthMask;this.range=depthRange}}DepthMode.ReadOnly=false;DepthMode.ReadWrite=true;DepthMode.disabled=new DepthMode(ALWAYS$1,DepthMode.ReadOnly,[0,1]);const ALWAYS=519;const KEEP=7680;class StencilMode{constructor(test,ref,mask,fail,depthFail,pass){this.test=test;this.ref=ref;this.mask=mask;this.fail=fail;this.depthFail=depthFail;this.pass=pass}}StencilMode.disabled=new StencilMode({func:ALWAYS,mask:0},0,0,KEEP,KEEP,KEEP);const BACK=1029;const CCW=2305;class CullFaceMode{constructor(enable,mode,frontFace){this.enable=enable;this.mode=mode;this.frontFace=frontFace}}CullFaceMode.disabled=new CullFaceMode(false,BACK,CCW);CullFaceMode.backCCW=new CullFaceMode(true,BACK,CCW);let quadTriangles;function drawCollisionDebug(painter,sourceCache,layer,coords,translate,translateAnchor,isText){const context=painter.context;const gl=context.gl;const program=painter.useProgram("collisionBox");const tileBatches=[];let circleCount=0;let circleOffset=0;for(let i=0;i<coords.length;i++){const coord=coords[i];const tile=sourceCache.getTile(coord);const bucket=tile.getBucket(layer);if(!bucket)continue;let posMatrix=coord.posMatrix;if(translate[0]!==0||translate[1]!==0){posMatrix=painter.translatePosMatrix(coord.posMatrix,tile,translate,translateAnchor)}const buffers=isText?bucket.textCollisionBox:bucket.iconCollisionBox;const circleArray=bucket.collisionCircleArray;if(circleArray.length>0){const invTransform=performance$1.create();const transform=posMatrix;performance$1.mul(invTransform,bucket.placementInvProjMatrix,painter.transform.glCoordMatrix);performance$1.mul(invTransform,invTransform,bucket.placementViewportMatrix);tileBatches.push({circleArray:circleArray,circleOffset:circleOffset,transform:transform,invTransform:invTransform,coord:coord});circleCount+=circleArray.length/4;circleOffset=circleCount}if(!buffers)continue;program.draw(context,gl.LINES,DepthMode.disabled,StencilMode.disabled,painter.colorModeForRenderPass(),CullFaceMode.disabled,collisionUniformValues(posMatrix,painter.transform,tile),painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord),layer.id,buffers.layoutVertexBuffer,buffers.indexBuffer,buffers.segments,null,painter.transform.zoom,null,null,buffers.collisionVertexBuffer)}if(!isText||!tileBatches.length){return}const circleProgram=painter.useProgram("collisionCircle");const vertexData=new performance$1.CollisionCircleLayoutArray;vertexData.resize(circleCount*4);vertexData._trim();let vertexOffset=0;for(const batch of tileBatches){for(let i=0;i<batch.circleArray.length/4;i++){const circleIdx=i*4;const x=batch.circleArray[circleIdx+0];const y=batch.circleArray[circleIdx+1];const radius=batch.circleArray[circleIdx+2];const collision=batch.circleArray[circleIdx+3];vertexData.emplace(vertexOffset++,x,y,radius,collision,0);vertexData.emplace(vertexOffset++,x,y,radius,collision,1);vertexData.emplace(vertexOffset++,x,y,radius,collision,2);vertexData.emplace(vertexOffset++,x,y,radius,collision,3)}}if(!quadTriangles||quadTriangles.length<circleCount*2){quadTriangles=createQuadTriangles(circleCount)}const indexBuffer=context.createIndexBuffer(quadTriangles,true);const vertexBuffer=context.createVertexBuffer(vertexData,performance$1.collisionCircleLayout.members,true);for(const batch of tileBatches){const uniforms=collisionCircleUniformValues(batch.transform,batch.invTransform,painter.transform);circleProgram.draw(context,gl.TRIANGLES,DepthMode.disabled,StencilMode.disabled,painter.colorModeForRenderPass(),CullFaceMode.disabled,uniforms,painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(batch.coord),layer.id,vertexBuffer,indexBuffer,performance$1.SegmentVector.simpleSegment(0,batch.circleOffset*2,batch.circleArray.length,batch.circleArray.length/2),null,painter.transform.zoom,null,null,null)}vertexBuffer.destroy();indexBuffer.destroy()}function createQuadTriangles(quadCount){const triCount=quadCount*2;const array=new performance$1.QuadTriangleArray;array.resize(triCount);array._trim();for(let i=0;i<triCount;i++){const idx=i*6;array.uint16[idx+0]=i*4+0;array.uint16[idx+1]=i*4+1;array.uint16[idx+2]=i*4+2;array.uint16[idx+3]=i*4+2;array.uint16[idx+4]=i*4+3;array.uint16[idx+5]=i*4+0}return array}const identityMat4=performance$1.identity(new Float32Array(16));function drawSymbols(painter,sourceCache,layer,coords,variableOffsets){if(painter.renderPass!=="translucent")return;const stencilMode=StencilMode.disabled;const colorMode=painter.colorModeForRenderPass();const hasVariablePlacement=layer._unevaluatedLayout.hasValue("text-variable-anchor")||layer._unevaluatedLayout.hasValue("text-variable-anchor-offset");if(hasVariablePlacement){updateVariableAnchors(coords,painter,layer,sourceCache,layer.layout.get("text-rotation-alignment"),layer.layout.get("text-pitch-alignment"),variableOffsets)}if(layer.paint.get("icon-opacity").constantOr(1)!==0){drawLayerSymbols(painter,sourceCache,layer,coords,false,layer.paint.get("icon-translate"),layer.paint.get("icon-translate-anchor"),layer.layout.get("icon-rotation-alignment"),layer.layout.get("icon-pitch-alignment"),layer.layout.get("icon-keep-upright"),stencilMode,colorMode)}if(layer.paint.get("text-opacity").constantOr(1)!==0){drawLayerSymbols(painter,sourceCache,layer,coords,true,layer.paint.get("text-translate"),layer.paint.get("text-translate-anchor"),layer.layout.get("text-rotation-alignment"),layer.layout.get("text-pitch-alignment"),layer.layout.get("text-keep-upright"),stencilMode,colorMode)}if(sourceCache.map.showCollisionBoxes){drawCollisionDebug(painter,sourceCache,layer,coords,layer.paint.get("text-translate"),layer.paint.get("text-translate-anchor"),true);drawCollisionDebug(painter,sourceCache,layer,coords,layer.paint.get("icon-translate"),layer.paint.get("icon-translate-anchor"),false)}}function calculateVariableRenderShift(anchor,width,height,textOffset,textBoxScale,renderTextSize){const{horizontalAlign:horizontalAlign,verticalAlign:verticalAlign}=performance$1.getAnchorAlignment(anchor);const shiftX=-(horizontalAlign-.5)*width;const shiftY=-(verticalAlign-.5)*height;return new performance$1.Point((shiftX/textBoxScale+textOffset[0])*renderTextSize,(shiftY/textBoxScale+textOffset[1])*renderTextSize)}function updateVariableAnchors(coords,painter,layer,sourceCache,rotationAlignment,pitchAlignment,variableOffsets){const tr=painter.transform;const rotateWithMap=rotationAlignment==="map";const pitchWithMap=pitchAlignment==="map";for(const coord of coords){const tile=sourceCache.getTile(coord);const bucket=tile.getBucket(layer);if(!bucket||!bucket.text||!bucket.text.segments.get().length)continue;const sizeData=bucket.textSizeData;const size=performance$1.evaluateSizeForZoom(sizeData,tr.zoom);const pixelToTileScale=pixelsToTileUnits(tile,1,painter.transform.zoom);const labelPlaneMatrix=getLabelPlaneMatrix(coord.posMatrix,pitchWithMap,rotateWithMap,painter.transform,pixelToTileScale);const updateTextFitIcon=layer.layout.get("icon-text-fit")!=="none"&&bucket.hasIconData();if(size){const tileScale=Math.pow(2,tr.zoom-tile.tileID.overscaledZ);const getElevation=painter.style.map.terrain?(x,y)=>painter.style.map.terrain.getElevation(coord,x,y):null;updateVariableAnchorsForBucket(bucket,rotateWithMap,pitchWithMap,variableOffsets,tr,labelPlaneMatrix,coord.posMatrix,tileScale,size,updateTextFitIcon,getElevation)}}}function updateVariableAnchorsForBucket(bucket,rotateWithMap,pitchWithMap,variableOffsets,transform,labelPlaneMatrix,posMatrix,tileScale,size,updateTextFitIcon,getElevation){const placedSymbols=bucket.text.placedSymbolArray;const dynamicTextLayoutVertexArray=bucket.text.dynamicLayoutVertexArray;const dynamicIconLayoutVertexArray=bucket.icon.dynamicLayoutVertexArray;const placedTextShifts={};dynamicTextLayoutVertexArray.clear();for(let s=0;s<placedSymbols.length;s++){const symbol=placedSymbols.get(s);const skipOrientation=bucket.allowVerticalPlacement&&!symbol.placedOrientation;const variableOffset=!symbol.hidden&&symbol.crossTileID&&!skipOrientation?variableOffsets[symbol.crossTileID]:null;if(!variableOffset){hideGlyphs(symbol.numGlyphs,dynamicTextLayoutVertexArray)}else{const tileAnchor=new performance$1.Point(symbol.anchorX,symbol.anchorY);const projectedAnchor=project(tileAnchor,pitchWithMap?posMatrix:labelPlaneMatrix,getElevation);const perspectiveRatio=getPerspectiveRatio(transform.cameraToCenterDistance,projectedAnchor.signedDistanceFromCamera);let renderTextSize=performance$1.evaluateSizeForFeature(bucket.textSizeData,size,symbol)*perspectiveRatio/performance$1.ONE_EM;if(pitchWithMap){renderTextSize*=bucket.tilePixelRatio/tileScale}const{width:width,height:height,anchor:anchor,textOffset:textOffset,textBoxScale:textBoxScale}=variableOffset;const shift=calculateVariableRenderShift(anchor,width,height,textOffset,textBoxScale,renderTextSize);const shiftedAnchor=pitchWithMap?project(tileAnchor.add(shift),labelPlaneMatrix,getElevation).point:projectedAnchor.point.add(rotateWithMap?shift.rotate(-transform.angle):shift);const angle=bucket.allowVerticalPlacement&&symbol.placedOrientation===performance$1.WritingMode.vertical?Math.PI/2:0;for(let g=0;g<symbol.numGlyphs;g++){performance$1.addDynamicAttributes(dynamicTextLayoutVertexArray,shiftedAnchor,angle)}if(updateTextFitIcon&&symbol.associatedIconIndex>=0){placedTextShifts[symbol.associatedIconIndex]={shiftedAnchor:shiftedAnchor,angle:angle}}}}if(updateTextFitIcon){dynamicIconLayoutVertexArray.clear();const placedIcons=bucket.icon.placedSymbolArray;for(let i=0;i<placedIcons.length;i++){const placedIcon=placedIcons.get(i);if(placedIcon.hidden){hideGlyphs(placedIcon.numGlyphs,dynamicIconLayoutVertexArray)}else{const shift=placedTextShifts[i];if(!shift){hideGlyphs(placedIcon.numGlyphs,dynamicIconLayoutVertexArray)}else{for(let g=0;g<placedIcon.numGlyphs;g++){performance$1.addDynamicAttributes(dynamicIconLayoutVertexArray,shift.shiftedAnchor,shift.angle)}}}}bucket.icon.dynamicLayoutVertexBuffer.updateData(dynamicIconLayoutVertexArray)}bucket.text.dynamicLayoutVertexBuffer.updateData(dynamicTextLayoutVertexArray)}function getSymbolProgramName(isSDF,isText,bucket){if(bucket.iconsInText&&isText){return"symbolTextAndIcon"}else if(isSDF){return"symbolSDF"}else{return"symbolIcon"}}function drawLayerSymbols(painter,sourceCache,layer,coords,isText,translate,translateAnchor,rotationAlignment,pitchAlignment,keepUpright,stencilMode,colorMode){const context=painter.context;const gl=context.gl;const tr=painter.transform;const rotateWithMap=rotationAlignment==="map";const pitchWithMap=pitchAlignment==="map";const alongLine=rotationAlignment!=="viewport"&&layer.layout.get("symbol-placement")!=="point";const rotateInShader=rotateWithMap&&!pitchWithMap&&!alongLine;const hasSortKey=!layer.layout.get("symbol-sort-key").isConstant();let sortFeaturesByKey=false;const depthMode=painter.depthModeForSublayer(0,DepthMode.ReadOnly);const hasVariablePlacement=layer._unevaluatedLayout.hasValue("text-variable-anchor")||layer._unevaluatedLayout.hasValue("text-variable-anchor-offset");const tileRenderState=[];for(const coord of coords){const tile=sourceCache.getTile(coord);const bucket=tile.getBucket(layer);if(!bucket)continue;const buffers=isText?bucket.text:bucket.icon;if(!buffers||!buffers.segments.get().length||!buffers.hasVisibleVertices)continue;const programConfiguration=buffers.programConfigurations.get(layer.id);const isSDF=isText||bucket.sdfIcons;const sizeData=isText?bucket.textSizeData:bucket.iconSizeData;const transformed=pitchWithMap||tr.pitch!==0;const program=painter.useProgram(getSymbolProgramName(isSDF,isText,bucket),programConfiguration);const size=performance$1.evaluateSizeForZoom(sizeData,tr.zoom);const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);let texSize;let texSizeIcon=[0,0];let atlasTexture;let atlasInterpolation;let atlasTextureIcon=null;let atlasInterpolationIcon;if(isText){atlasTexture=tile.glyphAtlasTexture;atlasInterpolation=gl.LINEAR;texSize=tile.glyphAtlasTexture.size;if(bucket.iconsInText){texSizeIcon=tile.imageAtlasTexture.size;atlasTextureIcon=tile.imageAtlasTexture;const zoomDependentSize=sizeData.kind==="composite"||sizeData.kind==="camera";atlasInterpolationIcon=transformed||painter.options.rotating||painter.options.zooming||zoomDependentSize?gl.LINEAR:gl.NEAREST}}else{const iconScaled=layer.layout.get("icon-size").constantOr(0)!==1||bucket.iconsNeedLinear;atlasTexture=tile.imageAtlasTexture;atlasInterpolation=isSDF||painter.options.rotating||painter.options.zooming||iconScaled||transformed?gl.LINEAR:gl.NEAREST;texSize=tile.imageAtlasTexture.size}const s=pixelsToTileUnits(tile,1,painter.transform.zoom);const labelPlaneMatrix=getLabelPlaneMatrix(coord.posMatrix,pitchWithMap,rotateWithMap,painter.transform,s);const glCoordMatrix=getGlCoordMatrix(coord.posMatrix,pitchWithMap,rotateWithMap,painter.transform,s);const hasVariableAnchors=hasVariablePlacement&&bucket.hasTextData();const updateTextFitIcon=layer.layout.get("icon-text-fit")!=="none"&&hasVariableAnchors&&bucket.hasIconData();if(alongLine){const getElevation=painter.style.map.terrain?(x,y)=>painter.style.map.terrain.getElevation(coord,x,y):null;const rotateToLine=layer.layout.get("text-rotation-alignment")==="map";updateLineLabels(bucket,coord.posMatrix,painter,isText,labelPlaneMatrix,glCoordMatrix,pitchWithMap,keepUpright,rotateToLine,getElevation)}const matrix=painter.translatePosMatrix(coord.posMatrix,tile,translate,translateAnchor),uLabelPlaneMatrix=alongLine||isText&&hasVariablePlacement||updateTextFitIcon?identityMat4:labelPlaneMatrix,uglCoordMatrix=painter.translatePosMatrix(glCoordMatrix,tile,translate,translateAnchor,true);const hasHalo=isSDF&&layer.paint.get(isText?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let uniformValues;if(isSDF){if(!bucket.iconsInText){uniformValues=symbolSDFUniformValues(sizeData.kind,size,rotateInShader,pitchWithMap,painter,matrix,uLabelPlaneMatrix,uglCoordMatrix,isText,texSize,true)}else{uniformValues=symbolTextAndIconUniformValues(sizeData.kind,size,rotateInShader,pitchWithMap,painter,matrix,uLabelPlaneMatrix,uglCoordMatrix,texSize,texSizeIcon)}}else{uniformValues=symbolIconUniformValues(sizeData.kind,size,rotateInShader,pitchWithMap,painter,matrix,uLabelPlaneMatrix,uglCoordMatrix,isText,texSize)}const state={program:program,buffers:buffers,uniformValues:uniformValues,atlasTexture:atlasTexture,atlasTextureIcon:atlasTextureIcon,atlasInterpolation:atlasInterpolation,atlasInterpolationIcon:atlasInterpolationIcon,isSDF:isSDF,hasHalo:hasHalo};if(hasSortKey&&bucket.canOverlap){sortFeaturesByKey=true;const oldSegments=buffers.segments.get();for(const segment of oldSegments){tileRenderState.push({segments:new performance$1.SegmentVector([segment]),sortKey:segment.sortKey,state:state,terrainData:terrainData})}}else{tileRenderState.push({segments:buffers.segments,sortKey:0,state:state,terrainData:terrainData})}}if(sortFeaturesByKey){tileRenderState.sort(((a,b)=>a.sortKey-b.sortKey))}for(const segmentState of tileRenderState){const state=segmentState.state;context.activeTexture.set(gl.TEXTURE0);state.atlasTexture.bind(state.atlasInterpolation,gl.CLAMP_TO_EDGE);if(state.atlasTextureIcon){context.activeTexture.set(gl.TEXTURE1);if(state.atlasTextureIcon){state.atlasTextureIcon.bind(state.atlasInterpolationIcon,gl.CLAMP_TO_EDGE)}}if(state.isSDF){const uniformValues=state.uniformValues;if(state.hasHalo){uniformValues["u_is_halo"]=1;drawSymbolElements(state.buffers,segmentState.segments,layer,painter,state.program,depthMode,stencilMode,colorMode,uniformValues,segmentState.terrainData)}uniformValues["u_is_halo"]=0}drawSymbolElements(state.buffers,segmentState.segments,layer,painter,state.program,depthMode,stencilMode,colorMode,state.uniformValues,segmentState.terrainData)}}function drawSymbolElements(buffers,segments,layer,painter,program,depthMode,stencilMode,colorMode,uniformValues,terrainData){const context=painter.context;const gl=context.gl;program.draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,buffers.layoutVertexBuffer,buffers.indexBuffer,segments,layer.paint,painter.transform.zoom,buffers.programConfigurations.get(layer.id),buffers.dynamicLayoutVertexBuffer,buffers.opacityVertexBuffer)}function drawCircles(painter,sourceCache,layer,coords){if(painter.renderPass!=="translucent")return;const opacity=layer.paint.get("circle-opacity");const strokeWidth=layer.paint.get("circle-stroke-width");const strokeOpacity=layer.paint.get("circle-stroke-opacity");const sortFeaturesByKey=!layer.layout.get("circle-sort-key").isConstant();if(opacity.constantOr(1)===0&&(strokeWidth.constantOr(1)===0||strokeOpacity.constantOr(1)===0)){return}const context=painter.context;const gl=context.gl;const depthMode=painter.depthModeForSublayer(0,DepthMode.ReadOnly);const stencilMode=StencilMode.disabled;const colorMode=painter.colorModeForRenderPass();const segmentsRenderStates=[];for(let i=0;i<coords.length;i++){const coord=coords[i];const tile=sourceCache.getTile(coord);const bucket=tile.getBucket(layer);if(!bucket)continue;const programConfiguration=bucket.programConfigurations.get(layer.id);const program=painter.useProgram("circle",programConfiguration);const layoutVertexBuffer=bucket.layoutVertexBuffer;const indexBuffer=bucket.indexBuffer;const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);const uniformValues=circleUniformValues(painter,coord,tile,layer);const state={programConfiguration:programConfiguration,program:program,layoutVertexBuffer:layoutVertexBuffer,indexBuffer:indexBuffer,uniformValues:uniformValues,terrainData:terrainData};if(sortFeaturesByKey){const oldSegments=bucket.segments.get();for(const segment of oldSegments){segmentsRenderStates.push({segments:new performance$1.SegmentVector([segment]),sortKey:segment.sortKey,state:state})}}else{segmentsRenderStates.push({segments:bucket.segments,sortKey:0,state:state})}}if(sortFeaturesByKey){segmentsRenderStates.sort(((a,b)=>a.sortKey-b.sortKey))}for(const segmentsState of segmentsRenderStates){const{programConfiguration:programConfiguration,program:program,layoutVertexBuffer:layoutVertexBuffer,indexBuffer:indexBuffer,uniformValues:uniformValues,terrainData:terrainData}=segmentsState.state;const segments=segmentsState.segments;program.draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,layoutVertexBuffer,indexBuffer,segments,layer.paint,painter.transform.zoom,programConfiguration)}}function drawHeatmap(painter,sourceCache,layer,coords){if(layer.paint.get("heatmap-opacity")===0){return}if(painter.renderPass==="offscreen"){const context=painter.context;const gl=context.gl;const stencilMode=StencilMode.disabled;const colorMode=new ColorMode([gl.ONE,gl.ONE],performance$1.Color.transparent,[true,true,true,true]);bindFramebuffer(context,painter,layer);context.clear({color:performance$1.Color.transparent});for(let i=0;i<coords.length;i++){const coord=coords[i];if(sourceCache.hasRenderableParent(coord))continue;const tile=sourceCache.getTile(coord);const bucket=tile.getBucket(layer);if(!bucket)continue;const programConfiguration=bucket.programConfigurations.get(layer.id);const program=painter.useProgram("heatmap",programConfiguration);const{zoom:zoom}=painter.transform;program.draw(context,gl.TRIANGLES,DepthMode.disabled,stencilMode,colorMode,CullFaceMode.disabled,heatmapUniformValues(coord.posMatrix,tile,zoom,layer.paint.get("heatmap-intensity")),null,layer.id,bucket.layoutVertexBuffer,bucket.indexBuffer,bucket.segments,layer.paint,painter.transform.zoom,programConfiguration)}context.viewport.set([0,0,painter.width,painter.height])}else if(painter.renderPass==="translucent"){painter.context.setColorMode(painter.colorModeForRenderPass());renderTextureToMap(painter,layer)}}function bindFramebuffer(context,painter,layer){const gl=context.gl;context.activeTexture.set(gl.TEXTURE1);context.viewport.set([0,0,painter.width/4,painter.height/4]);let fbo=layer.heatmapFbo;if(!fbo){const texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);fbo=layer.heatmapFbo=context.createFramebuffer(painter.width/4,painter.height/4,false,false);bindTextureToFramebuffer(context,painter,texture,fbo)}else{gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());context.bindFramebuffer.set(fbo.framebuffer)}}function bindTextureToFramebuffer(context,painter,texture,fbo){var _a,_b;const gl=context.gl;const numType=(_a=context.HALF_FLOAT)!==null&&_a!==void 0?_a:gl.UNSIGNED_BYTE;const internalFormat=(_b=context.RGBA16F)!==null&&_b!==void 0?_b:gl.RGBA;gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,painter.width/4,painter.height/4,0,gl.RGBA,numType,null);fbo.colorAttachment.set(texture)}function renderTextureToMap(painter,layer){const context=painter.context;const gl=context.gl;const fbo=layer.heatmapFbo;if(!fbo)return;context.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());context.activeTexture.set(gl.TEXTURE1);let colorRampTexture=layer.colorRampTexture;if(!colorRampTexture){colorRampTexture=layer.colorRampTexture=new Texture(context,layer.colorRamp,gl.RGBA)}colorRampTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);painter.useProgram("heatmapTexture").draw(context,gl.TRIANGLES,DepthMode.disabled,StencilMode.disabled,painter.colorModeForRenderPass(),CullFaceMode.disabled,heatmapTextureUniformValues(painter,layer,0,1),null,layer.id,painter.viewportBuffer,painter.quadTriangleIndexBuffer,painter.viewportSegments,layer.paint,painter.transform.zoom)}function drawLine(painter,sourceCache,layer,coords){if(painter.renderPass!=="translucent")return;const opacity=layer.paint.get("line-opacity");const width=layer.paint.get("line-width");if(opacity.constantOr(1)===0||width.constantOr(1)===0)return;const depthMode=painter.depthModeForSublayer(0,DepthMode.ReadOnly);const colorMode=painter.colorModeForRenderPass();const dasharray=layer.paint.get("line-dasharray");const patternProperty=layer.paint.get("line-pattern");const image=patternProperty.constantOr(1);const gradient=layer.paint.get("line-gradient");const crossfade=layer.getCrossfadeParameters();const programId=image?"linePattern":dasharray?"lineSDF":gradient?"lineGradient":"line";const context=painter.context;const gl=context.gl;let firstTile=true;for(const coord of coords){const tile=sourceCache.getTile(coord);if(image&&!tile.patternsLoaded())continue;const bucket=tile.getBucket(layer);if(!bucket)continue;const programConfiguration=bucket.programConfigurations.get(layer.id);const prevProgram=painter.context.program.get();const program=painter.useProgram(programId,programConfiguration);const programChanged=firstTile||program.program!==prevProgram;const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);const constantPattern=patternProperty.constantOr(null);if(constantPattern&&tile.imageAtlas){const atlas=tile.imageAtlas;const posTo=atlas.patternPositions[constantPattern.to.toString()];const posFrom=atlas.patternPositions[constantPattern.from.toString()];if(posTo&&posFrom)programConfiguration.setConstantPatternPositions(posTo,posFrom)}const terrainCoord=terrainData?coord:null;const uniformValues=image?linePatternUniformValues(painter,tile,layer,crossfade,terrainCoord):dasharray?lineSDFUniformValues(painter,tile,layer,dasharray,crossfade,terrainCoord):gradient?lineGradientUniformValues(painter,tile,layer,bucket.lineClipsArray.length,terrainCoord):lineUniformValues(painter,tile,layer,terrainCoord);if(image){context.activeTexture.set(gl.TEXTURE0);tile.imageAtlasTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);programConfiguration.updatePaintBuffers(crossfade)}else if(dasharray&&(programChanged||painter.lineAtlas.dirty)){context.activeTexture.set(gl.TEXTURE0);painter.lineAtlas.bind(context)}else if(gradient){const layerGradient=bucket.gradients[layer.id];let gradientTexture=layerGradient.texture;if(layer.gradientVersion!==layerGradient.version){let textureResolution=256;if(layer.stepInterpolant){const sourceMaxZoom=sourceCache.getSource().maxzoom;const potentialOverzoom=coord.canonical.z===sourceMaxZoom?Math.ceil(1<<painter.transform.maxZoom-coord.canonical.z):1;const lineLength=bucket.maxLineLength/performance$1.EXTENT;const maxTilePixelSize=1024;const maxTextureCoverage=lineLength*maxTilePixelSize*potentialOverzoom;textureResolution=performance$1.clamp(performance$1.nextPowerOfTwo(maxTextureCoverage),256,context.maxTextureSize)}layerGradient.gradient=performance$1.renderColorRamp({expression:layer.gradientExpression(),evaluationKey:"lineProgress",resolution:textureResolution,image:layerGradient.gradient||undefined,clips:bucket.lineClipsArray});if(layerGradient.texture){layerGradient.texture.update(layerGradient.gradient)}else{layerGradient.texture=new Texture(context,layerGradient.gradient,gl.RGBA)}layerGradient.version=layer.gradientVersion;gradientTexture=layerGradient.texture}context.activeTexture.set(gl.TEXTURE0);gradientTexture.bind(layer.stepInterpolant?gl.NEAREST:gl.LINEAR,gl.CLAMP_TO_EDGE)}program.draw(context,gl.TRIANGLES,depthMode,painter.stencilModeForClipping(coord),colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,bucket.layoutVertexBuffer,bucket.indexBuffer,bucket.segments,layer.paint,painter.transform.zoom,programConfiguration,bucket.layoutVertexBuffer2);firstTile=false}}function updatePatternPositionsInProgram(programConfiguration,propertyName,constantPattern,tile,layer){if(!constantPattern||!tile||!tile.imageAtlas){return}const patternPositions=tile.imageAtlas.patternPositions;let posTo=patternPositions[constantPattern.to.toString()];let posFrom=patternPositions[constantPattern.from.toString()];if(!posTo&&posFrom)posTo=posFrom;if(!posFrom&&posTo)posFrom=posTo;if(!posTo||!posFrom){const transitioned=layer.getPaintProperty(propertyName);posTo=patternPositions[transitioned];posFrom=patternPositions[transitioned]}if(posTo&&posFrom){programConfiguration.setConstantPatternPositions(posTo,posFrom)}}function drawFill(painter,sourceCache,layer,coords){const color=layer.paint.get("fill-color");const opacity=layer.paint.get("fill-opacity");if(opacity.constantOr(1)===0){return}const colorMode=painter.colorModeForRenderPass();const pattern=layer.paint.get("fill-pattern");const pass=painter.opaquePassEnabledForLayer()&&(!pattern.constantOr(1)&&color.constantOr(performance$1.Color.transparent).a===1&&opacity.constantOr(0)===1)?"opaque":"translucent";if(painter.renderPass===pass){const depthMode=painter.depthModeForSublayer(1,painter.renderPass==="opaque"?DepthMode.ReadWrite:DepthMode.ReadOnly);drawFillTiles(painter,sourceCache,layer,coords,depthMode,colorMode,false)}if(painter.renderPass==="translucent"&&layer.paint.get("fill-antialias")){const depthMode=painter.depthModeForSublayer(layer.getPaintProperty("fill-outline-color")?2:0,DepthMode.ReadOnly);drawFillTiles(painter,sourceCache,layer,coords,depthMode,colorMode,true)}}function drawFillTiles(painter,sourceCache,layer,coords,depthMode,colorMode,isOutline){const gl=painter.context.gl;const fillPropertyName="fill-pattern";const patternProperty=layer.paint.get(fillPropertyName);const image=patternProperty&&patternProperty.constantOr(1);const crossfade=layer.getCrossfadeParameters();let drawMode,programName,uniformValues,indexBuffer,segments;if(!isOutline){programName=image?"fillPattern":"fill";drawMode=gl.TRIANGLES}else{programName=image&&!layer.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline";drawMode=gl.LINES}const constantPattern=patternProperty.constantOr(null);for(const coord of coords){const tile=sourceCache.getTile(coord);if(image&&!tile.patternsLoaded())continue;const bucket=tile.getBucket(layer);if(!bucket)continue;const programConfiguration=bucket.programConfigurations.get(layer.id);const program=painter.useProgram(programName,programConfiguration);const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);if(image){painter.context.activeTexture.set(gl.TEXTURE0);tile.imageAtlasTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);programConfiguration.updatePaintBuffers(crossfade)}updatePatternPositionsInProgram(programConfiguration,fillPropertyName,constantPattern,tile,layer);const terrainCoord=terrainData?coord:null;const posMatrix=terrainCoord?terrainCoord.posMatrix:coord.posMatrix;const tileMatrix=painter.translatePosMatrix(posMatrix,tile,layer.paint.get("fill-translate"),layer.paint.get("fill-translate-anchor"));if(!isOutline){indexBuffer=bucket.indexBuffer;segments=bucket.segments;uniformValues=image?fillPatternUniformValues(tileMatrix,painter,crossfade,tile):fillUniformValues(tileMatrix)}else{indexBuffer=bucket.indexBuffer2;segments=bucket.segments2;const drawingBufferSize=[gl.drawingBufferWidth,gl.drawingBufferHeight];uniformValues=programName==="fillOutlinePattern"&&image?fillOutlinePatternUniformValues(tileMatrix,painter,crossfade,tile,drawingBufferSize):fillOutlineUniformValues(tileMatrix,drawingBufferSize)}program.draw(painter.context,drawMode,depthMode,painter.stencilModeForClipping(coord),colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,bucket.layoutVertexBuffer,indexBuffer,segments,layer.paint,painter.transform.zoom,programConfiguration)}}function drawFillExtrusion(painter,source,layer,coords){const opacity=layer.paint.get("fill-extrusion-opacity");if(opacity===0){return}if(painter.renderPass==="translucent"){const depthMode=new DepthMode(painter.context.gl.LEQUAL,DepthMode.ReadWrite,painter.depthRangeFor3D);if(opacity===1&&!layer.paint.get("fill-extrusion-pattern").constantOr(1)){const colorMode=painter.colorModeForRenderPass();drawExtrusionTiles(painter,source,layer,coords,depthMode,StencilMode.disabled,colorMode)}else{drawExtrusionTiles(painter,source,layer,coords,depthMode,StencilMode.disabled,ColorMode.disabled);drawExtrusionTiles(painter,source,layer,coords,depthMode,painter.stencilModeFor3D(),painter.colorModeForRenderPass())}}}function drawExtrusionTiles(painter,source,layer,coords,depthMode,stencilMode,colorMode){const context=painter.context;const gl=context.gl;const fillPropertyName="fill-extrusion-pattern";const patternProperty=layer.paint.get(fillPropertyName);const image=patternProperty.constantOr(1);const crossfade=layer.getCrossfadeParameters();const opacity=layer.paint.get("fill-extrusion-opacity");const constantPattern=patternProperty.constantOr(null);for(const coord of coords){const tile=source.getTile(coord);const bucket=tile.getBucket(layer);if(!bucket)continue;const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);const programConfiguration=bucket.programConfigurations.get(layer.id);const program=painter.useProgram(image?"fillExtrusionPattern":"fillExtrusion",programConfiguration);if(image){painter.context.activeTexture.set(gl.TEXTURE0);tile.imageAtlasTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);programConfiguration.updatePaintBuffers(crossfade)}updatePatternPositionsInProgram(programConfiguration,fillPropertyName,constantPattern,tile,layer);const matrix=painter.translatePosMatrix(coord.posMatrix,tile,layer.paint.get("fill-extrusion-translate"),layer.paint.get("fill-extrusion-translate-anchor"));const shouldUseVerticalGradient=layer.paint.get("fill-extrusion-vertical-gradient");const uniformValues=image?fillExtrusionPatternUniformValues(matrix,painter,shouldUseVerticalGradient,opacity,coord,crossfade,tile):fillExtrusionUniformValues(matrix,painter,shouldUseVerticalGradient,opacity);program.draw(context,context.gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.backCCW,uniformValues,terrainData,layer.id,bucket.layoutVertexBuffer,bucket.indexBuffer,bucket.segments,layer.paint,painter.transform.zoom,programConfiguration,painter.style.map.terrain&&bucket.centroidVertexBuffer)}}function drawHillshade(painter,sourceCache,layer,tileIDs){if(painter.renderPass!=="offscreen"&&painter.renderPass!=="translucent")return;const context=painter.context;const depthMode=painter.depthModeForSublayer(0,DepthMode.ReadOnly);const colorMode=painter.colorModeForRenderPass();const[stencilModes,coords]=painter.renderPass==="translucent"?painter.stencilConfigForOverlap(tileIDs):[{},tileIDs];for(const coord of coords){const tile=sourceCache.getTile(coord);if(typeof tile.needsHillshadePrepare!=="undefined"&&tile.needsHillshadePrepare&&painter.renderPass==="offscreen"){prepareHillshade(painter,tile,layer,depthMode,StencilMode.disabled,colorMode)}else if(painter.renderPass==="translucent"){renderHillshade(painter,coord,tile,layer,depthMode,stencilModes[coord.overscaledZ],colorMode)}}context.viewport.set([0,0,painter.width,painter.height])}function renderHillshade(painter,coord,tile,layer,depthMode,stencilMode,colorMode){const context=painter.context;const gl=context.gl;const fbo=tile.fbo;if(!fbo)return;const program=painter.useProgram("hillshade");const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);context.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,fbo.colorAttachment.get());const terrainCoord=terrainData?coord:null;program.draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,hillshadeUniformValues(painter,tile,layer,terrainCoord),terrainData,layer.id,painter.rasterBoundsBuffer,painter.quadTriangleIndexBuffer,painter.rasterBoundsSegments)}function prepareHillshade(painter,tile,layer,depthMode,stencilMode,colorMode){const context=painter.context;const gl=context.gl;const dem=tile.dem;if(dem&&dem.data){const tileSize=dem.dim;const textureStride=dem.stride;const pixelData=dem.getPixels();context.activeTexture.set(gl.TEXTURE1);context.pixelStoreUnpackPremultiplyAlpha.set(false);tile.demTexture=tile.demTexture||painter.getTileTexture(textureStride);if(tile.demTexture){const demTexture=tile.demTexture;demTexture.update(pixelData,{premultiply:false});demTexture.bind(gl.NEAREST,gl.CLAMP_TO_EDGE)}else{tile.demTexture=new Texture(context,pixelData,gl.RGBA,{premultiply:false});tile.demTexture.bind(gl.NEAREST,gl.CLAMP_TO_EDGE)}context.activeTexture.set(gl.TEXTURE0);let fbo=tile.fbo;if(!fbo){const renderTexture=new Texture(context,{width:tileSize,height:tileSize,data:null},gl.RGBA);renderTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE);fbo=tile.fbo=context.createFramebuffer(tileSize,tileSize,true,false);fbo.colorAttachment.set(renderTexture.texture)}context.bindFramebuffer.set(fbo.framebuffer);context.viewport.set([0,0,tileSize,tileSize]);painter.useProgram("hillshadePrepare").draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,hillshadeUniformPrepareValues(tile.tileID,dem),null,layer.id,painter.rasterBoundsBuffer,painter.quadTriangleIndexBuffer,painter.rasterBoundsSegments);tile.needsHillshadePrepare=false}}function drawRaster(painter,sourceCache,layer,tileIDs){if(painter.renderPass!=="translucent")return;if(layer.paint.get("raster-opacity")===0)return;if(!tileIDs.length)return;const context=painter.context;const gl=context.gl;const source=sourceCache.getSource();const program=painter.useProgram("raster");const colorMode=painter.colorModeForRenderPass();const[stencilModes,coords]=source instanceof ImageSource?[{},tileIDs]:painter.stencilConfigForOverlap(tileIDs);const minTileZ=coords[coords.length-1].overscaledZ;const align=!painter.options.moving;for(const coord of coords){const depthMode=painter.depthModeForSublayer(coord.overscaledZ-minTileZ,layer.paint.get("raster-opacity")===1?DepthMode.ReadWrite:DepthMode.ReadOnly,gl.LESS);const tile=sourceCache.getTile(coord);tile.registerFadeDuration(layer.paint.get("raster-fade-duration"));const parentTile=sourceCache.findLoadedParent(coord,0),fade=getFadeValues(tile,parentTile,sourceCache,layer,painter.transform,painter.style.map.terrain);let parentScaleBy,parentTL;const textureFilter=layer.paint.get("raster-resampling")==="nearest"?gl.NEAREST:gl.LINEAR;context.activeTexture.set(gl.TEXTURE0);tile.texture.bind(textureFilter,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST);context.activeTexture.set(gl.TEXTURE1);if(parentTile){parentTile.texture.bind(textureFilter,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST);parentScaleBy=Math.pow(2,parentTile.tileID.overscaledZ-tile.tileID.overscaledZ);parentTL=[tile.tileID.canonical.x*parentScaleBy%1,tile.tileID.canonical.y*parentScaleBy%1]}else{tile.texture.bind(textureFilter,gl.CLAMP_TO_EDGE,gl.LINEAR_MIPMAP_NEAREST)}const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);const terrainCoord=terrainData?coord:null;const posMatrix=terrainCoord?terrainCoord.posMatrix:painter.transform.calculatePosMatrix(coord.toUnwrapped(),align);const uniformValues=rasterUniformValues(posMatrix,parentTL||[0,0],parentScaleBy||1,fade,layer);if(source instanceof ImageSource){program.draw(context,gl.TRIANGLES,depthMode,StencilMode.disabled,colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,source.boundsBuffer,painter.quadTriangleIndexBuffer,source.boundsSegments)}else{program.draw(context,gl.TRIANGLES,depthMode,stencilModes[coord.overscaledZ],colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,painter.rasterBoundsBuffer,painter.quadTriangleIndexBuffer,painter.rasterBoundsSegments)}}}function getFadeValues(tile,parentTile,sourceCache,layer,transform,terrain){const fadeDuration=layer.paint.get("raster-fade-duration");if(!terrain&&fadeDuration>0){const now=browser.now();const sinceTile=(now-tile.timeAdded)/fadeDuration;const sinceParent=parentTile?(now-parentTile.timeAdded)/fadeDuration:-1;const source=sourceCache.getSource();const idealZ=transform.coveringZoomLevel({tileSize:source.tileSize,roundZoom:source.roundZoom});const fadeIn=!parentTile||Math.abs(parentTile.tileID.overscaledZ-idealZ)>Math.abs(tile.tileID.overscaledZ-idealZ);const childOpacity=fadeIn&&tile.refreshedUponExpiration?1:performance$1.clamp(fadeIn?sinceTile:1-sinceParent,0,1);if(tile.refreshedUponExpiration&&sinceTile>=1)tile.refreshedUponExpiration=false;if(parentTile){return{opacity:1,mix:1-childOpacity}}else{return{opacity:childOpacity,mix:0}}}else{return{opacity:1,mix:0}}}function drawBackground(painter,sourceCache,layer,coords){const color=layer.paint.get("background-color");const opacity=layer.paint.get("background-opacity");if(opacity===0)return;const context=painter.context;const gl=context.gl;const transform=painter.transform;const tileSize=transform.tileSize;const image=layer.paint.get("background-pattern");if(painter.isPatternMissing(image))return;const pass=!image&&color.a===1&&opacity===1&&painter.opaquePassEnabledForLayer()?"opaque":"translucent";if(painter.renderPass!==pass)return;const stencilMode=StencilMode.disabled;const depthMode=painter.depthModeForSublayer(0,pass==="opaque"?DepthMode.ReadWrite:DepthMode.ReadOnly);const colorMode=painter.colorModeForRenderPass();const program=painter.useProgram(image?"backgroundPattern":"background");const tileIDs=coords?coords:transform.coveringTiles({tileSize:tileSize,terrain:painter.style.map.terrain});if(image){context.activeTexture.set(gl.TEXTURE0);painter.imageManager.bind(painter.context)}const crossfade=layer.getCrossfadeParameters();for(const tileID of tileIDs){const matrix=coords?tileID.posMatrix:painter.transform.calculatePosMatrix(tileID.toUnwrapped());const uniformValues=image?backgroundPatternUniformValues(matrix,opacity,painter,image,{tileID:tileID,tileSize:tileSize},crossfade):backgroundUniformValues(matrix,opacity,color);const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(tileID);program.draw(context,gl.TRIANGLES,depthMode,stencilMode,colorMode,CullFaceMode.disabled,uniformValues,terrainData,layer.id,painter.tileExtentBuffer,painter.quadTriangleIndexBuffer,painter.tileExtentSegments)}}const topColor=new performance$1.Color(1,0,0,1);const btmColor=new performance$1.Color(0,1,0,1);const leftColor=new performance$1.Color(0,0,1,1);const rightColor=new performance$1.Color(1,0,1,1);const centerColor=new performance$1.Color(0,1,1,1);function drawDebugPadding(painter){const padding=painter.transform.padding;const lineWidth=3;drawHorizontalLine(painter,painter.transform.height-(padding.top||0),lineWidth,topColor);drawHorizontalLine(painter,padding.bottom||0,lineWidth,btmColor);drawVerticalLine(painter,padding.left||0,lineWidth,leftColor);drawVerticalLine(painter,painter.transform.width-(padding.right||0),lineWidth,rightColor);const center=painter.transform.centerPoint;drawCrosshair(painter,center.x,painter.transform.height-center.y,centerColor)}function drawCrosshair(painter,x,y,color){const size=20;const lineWidth=2;drawDebugSSRect(painter,x-lineWidth/2,y-size/2,lineWidth,size,color);drawDebugSSRect(painter,x-size/2,y-lineWidth/2,size,lineWidth,color)}function drawHorizontalLine(painter,y,lineWidth,color){drawDebugSSRect(painter,0,y+lineWidth/2,painter.transform.width,lineWidth,color)}function drawVerticalLine(painter,x,lineWidth,color){drawDebugSSRect(painter,x-lineWidth/2,0,lineWidth,painter.transform.height,color)}function drawDebugSSRect(painter,x,y,width,height,color){const context=painter.context;const gl=context.gl;gl.enable(gl.SCISSOR_TEST);gl.scissor(x*painter.pixelRatio,y*painter.pixelRatio,width*painter.pixelRatio,height*painter.pixelRatio);context.clear({color:color});gl.disable(gl.SCISSOR_TEST)}function drawDebug(painter,sourceCache,coords){for(let i=0;i<coords.length;i++){drawDebugTile(painter,sourceCache,coords[i])}}function drawDebugTile(painter,sourceCache,coord){const context=painter.context;const gl=context.gl;const posMatrix=coord.posMatrix;const program=painter.useProgram("debug");const depthMode=DepthMode.disabled;const stencilMode=StencilMode.disabled;const colorMode=painter.colorModeForRenderPass();const id="$debug";const terrainData=painter.style.map.terrain&&painter.style.map.terrain.getTerrainData(coord);context.activeTexture.set(gl.TEXTURE0);const tileRawData=sourceCache.getTileByID(coord.key).latestRawTileData;const tileByteLength=tileRawData&&tileRawData.byteLength||0;const tileSizeKb=Math.floor(tileByteLength/1024);const tileSize=sourceCache.getTile(coord).tileSize;const scaleRatio=512/Math.min(tileSize,512)*(coord.overscaledZ/painter.transform.zoom)*.5;let tileIdText=coord.canonical.toString();if(coord.overscaledZ!==coord.canonical.z){tileIdText+=` => ${coord.overscaledZ}`}const tileLabel=`${tileIdText} ${tileSizeKb}kB`;drawTextToOverlay(painter,tileLabel);program.draw(context,gl.TRIANGLES,depthMode,stencilMode,ColorMode.alphaBlended,CullFaceMode.disabled,debugUniformValues(posMatrix,performance$1.Color.transparent,scaleRatio),null,id,painter.debugBuffer,painter.quadTriangleIndexBuffer,painter.debugSegments);program.draw(context,gl.LINE_STRIP,depthMode,stencilMode,colorMode,CullFaceMode.disabled,debugUniformValues(posMatrix,performance$1.Color.red),terrainData,id,painter.debugBuffer,painter.tileBorderIndexBuffer,painter.debugSegments)}function drawTextToOverlay(painter,text){painter.initDebugOverlayCanvas();const canvas=painter.debugOverlayCanvas;const gl=painter.context.gl;const ctx2d=painter.debugOverlayCanvas.getContext("2d");ctx2d.clearRect(0,0,canvas.width,canvas.height);ctx2d.shadowColor="white";ctx2d.shadowBlur=2;ctx2d.lineWidth=1.5;ctx2d.strokeStyle="white";ctx2d.textBaseline="top";ctx2d.font=`bold ${36}px Open Sans, sans-serif`;ctx2d.fillText(text,5,5);ctx2d.strokeText(text,5,5);painter.debugOverlayTexture.update(canvas);painter.debugOverlayTexture.bind(gl.LINEAR,gl.CLAMP_TO_EDGE)}function selectDebugSource(style,zoom){let selectedSource=null;const layers=Object.values(style._layers);const sources=layers.flatMap((layer=>{if(layer.source&&!layer.isHidden(zoom)){const sourceCache=style.sourceCaches[layer.source];return[sourceCache]}else{return[]}}));const vectorSources=sources.filter((source=>source.getSource().type==="vector"));const otherSources=sources.filter((source=>source.getSource().type!=="vector"));const considerSource=source=>{if(!selectedSource||selectedSource.getSource().maxzoom<source.getSource().maxzoom){selectedSource=source}};vectorSources.forEach((source=>considerSource(source)));if(!selectedSource){otherSources.forEach((source=>considerSource(source)))}return selectedSource}function drawCustom(painter,sourceCache,layer){const context=painter.context;const implementation=layer.implementation;if(painter.renderPass==="offscreen"){const prerender=implementation.prerender;if(prerender){painter.setCustomLayerDefaults();context.setColorMode(painter.colorModeForRenderPass());prerender.call(implementation,context.gl,painter.transform.customLayerMatrix());context.setDirty();painter.setBaseState()}}else if(painter.renderPass==="translucent"){painter.setCustomLayerDefaults();context.setColorMode(painter.colorModeForRenderPass());context.setStencilMode(StencilMode.disabled);const depthMode=implementation.renderingMode==="3d"?new DepthMode(painter.context.gl.LEQUAL,DepthMode.ReadWrite,painter.depthRangeFor3D):painter.depthModeForSublayer(0,DepthMode.ReadOnly);context.setDepthMode(depthMode);implementation.render(context.gl,painter.transform.customLayerMatrix());context.setDirty();painter.setBaseState();context.bindFramebuffer.set(null)}}function drawDepth(painter,terrain){const context=painter.context;const gl=context.gl;const colorMode=ColorMode.unblended;const depthMode=new DepthMode(gl.LEQUAL,DepthMode.ReadWrite,[0,1]);const mesh=terrain.getTerrainMesh();const tiles=terrain.sourceCache.getRenderableTiles();const program=painter.useProgram("terrainDepth");context.bindFramebuffer.set(terrain.getFramebuffer("depth").framebuffer);context.viewport.set([0,0,painter.width/devicePixelRatio,painter.height/devicePixelRatio]);context.clear({color:performance$1.Color.transparent,depth:1});for(const tile of tiles){const terrainData=terrain.getTerrainData(tile.tileID);const posMatrix=painter.transform.calculatePosMatrix(tile.tileID.toUnwrapped());const uniformValues=terrainDepthUniformValues(posMatrix,terrain.getMeshFrameDelta(painter.transform.zoom));program.draw(context,gl.TRIANGLES,depthMode,StencilMode.disabled,colorMode,CullFaceMode.backCCW,uniformValues,terrainData,"terrain",mesh.vertexBuffer,mesh.indexBuffer,mesh.segments)}context.bindFramebuffer.set(null);context.viewport.set([0,0,painter.width,painter.height])}function drawCoords(painter,terrain){const context=painter.context;const gl=context.gl;const colorMode=ColorMode.unblended;const depthMode=new DepthMode(gl.LEQUAL,DepthMode.ReadWrite,[0,1]);const mesh=terrain.getTerrainMesh();const coords=terrain.getCoordsTexture();const tiles=terrain.sourceCache.getRenderableTiles();const program=painter.useProgram("terrainCoords");context.bindFramebuffer.set(terrain.getFramebuffer("coords").framebuffer);context.viewport.set([0,0,painter.width/devicePixelRatio,painter.height/devicePixelRatio]);context.clear({color:performance$1.Color.transparent,depth:1});terrain.coordsIndex=[];for(const tile of tiles){const terrainData=terrain.getTerrainData(tile.tileID);context.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,coords.texture);const posMatrix=painter.transform.calculatePosMatrix(tile.tileID.toUnwrapped());const uniformValues=terrainCoordsUniformValues(posMatrix,255-terrain.coordsIndex.length,terrain.getMeshFrameDelta(painter.transform.zoom));program.draw(context,gl.TRIANGLES,depthMode,StencilMode.disabled,colorMode,CullFaceMode.backCCW,uniformValues,terrainData,"terrain",mesh.vertexBuffer,mesh.indexBuffer,mesh.segments);terrain.coordsIndex.push(tile.tileID.key)}context.bindFramebuffer.set(null);context.viewport.set([0,0,painter.width,painter.height])}function drawTerrain(painter,terrain,tiles){const context=painter.context;const gl=context.gl;const colorMode=painter.colorModeForRenderPass();const depthMode=new DepthMode(gl.LEQUAL,DepthMode.ReadWrite,painter.depthRangeFor3D);const program=painter.useProgram("terrain");const mesh=terrain.getTerrainMesh();context.bindFramebuffer.set(null);context.viewport.set([0,0,painter.width,painter.height]);for(const tile of tiles){const texture=painter.renderToTexture.getTexture(tile);const terrainData=terrain.getTerrainData(tile.tileID);context.activeTexture.set(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture.texture);const posMatrix=painter.transform.calculatePosMatrix(tile.tileID.toUnwrapped());const uniformValues=terrainUniformValues(posMatrix,terrain.getMeshFrameDelta(painter.transform.zoom));program.draw(context,gl.TRIANGLES,depthMode,StencilMode.disabled,colorMode,CullFaceMode.backCCW,uniformValues,terrainData,"terrain",mesh.vertexBuffer,mesh.indexBuffer,mesh.segments)}}class Painter{constructor(gl,transform){this.context=new Context(gl);this.transform=transform;this._tileTextures={};this.terrainFacilitator={dirty:true,matrix:performance$1.create(),renderTime:0};this.setup();this.numSublayers=SourceCache.maxUnderzooming+SourceCache.maxOverzooming+1;this.depthEpsilon=1/Math.pow(2,16);this.crossTileSymbolIndex=new CrossTileSymbolIndex}resize(width,height,pixelRatio){this.width=Math.floor(width*pixelRatio);this.height=Math.floor(height*pixelRatio);this.pixelRatio=pixelRatio;this.context.viewport.set([0,0,this.width,this.height]);if(this.style){for(const layerId of this.style._order){this.style._layers[layerId].resize()}}}setup(){const context=this.context;const tileExtentArray=new performance$1.PosArray;tileExtentArray.emplaceBack(0,0);tileExtentArray.emplaceBack(performance$1.EXTENT,0);tileExtentArray.emplaceBack(0,performance$1.EXTENT);tileExtentArray.emplaceBack(performance$1.EXTENT,performance$1.EXTENT);this.tileExtentBuffer=context.createVertexBuffer(tileExtentArray,posAttributes.members);this.tileExtentSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2);const debugArray=new performance$1.PosArray;debugArray.emplaceBack(0,0);debugArray.emplaceBack(performance$1.EXTENT,0);debugArray.emplaceBack(0,performance$1.EXTENT);debugArray.emplaceBack(performance$1.EXTENT,performance$1.EXTENT);this.debugBuffer=context.createVertexBuffer(debugArray,posAttributes.members);this.debugSegments=performance$1.SegmentVector.simpleSegment(0,0,4,5);const rasterBoundsArray=new performance$1.RasterBoundsArray;rasterBoundsArray.emplaceBack(0,0,0,0);rasterBoundsArray.emplaceBack(performance$1.EXTENT,0,performance$1.EXTENT,0);rasterBoundsArray.emplaceBack(0,performance$1.EXTENT,0,performance$1.EXTENT);rasterBoundsArray.emplaceBack(performance$1.EXTENT,performance$1.EXTENT,performance$1.EXTENT,performance$1.EXTENT);this.rasterBoundsBuffer=context.createVertexBuffer(rasterBoundsArray,rasterBoundsAttributes.members);this.rasterBoundsSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2);const viewportArray=new performance$1.PosArray;viewportArray.emplaceBack(0,0);viewportArray.emplaceBack(1,0);viewportArray.emplaceBack(0,1);viewportArray.emplaceBack(1,1);this.viewportBuffer=context.createVertexBuffer(viewportArray,posAttributes.members);this.viewportSegments=performance$1.SegmentVector.simpleSegment(0,0,4,2);const tileLineStripIndices=new performance$1.LineStripIndexArray;tileLineStripIndices.emplaceBack(0);tileLineStripIndices.emplaceBack(1);tileLineStripIndices.emplaceBack(3);tileLineStripIndices.emplaceBack(2);tileLineStripIndices.emplaceBack(0);this.tileBorderIndexBuffer=context.createIndexBuffer(tileLineStripIndices);const quadTriangleIndices=new performance$1.TriangleIndexArray;quadTriangleIndices.emplaceBack(0,1,2);quadTriangleIndices.emplaceBack(2,1,3);this.quadTriangleIndexBuffer=context.createIndexBuffer(quadTriangleIndices);const gl=this.context.gl;this.stencilClearMode=new StencilMode({func:gl.ALWAYS,mask:0},0,255,gl.ZERO,gl.ZERO,gl.ZERO)}clearStencil(){const context=this.context;const gl=context.gl;this.nextStencilID=1;this.currentStencilSource=undefined;const matrix=performance$1.create();performance$1.ortho(matrix,0,this.width,this.height,0,0,1);performance$1.scale(matrix,matrix,[gl.drawingBufferWidth,gl.drawingBufferHeight,0]);this.useProgram("clippingMask").draw(context,gl.TRIANGLES,DepthMode.disabled,this.stencilClearMode,ColorMode.disabled,CullFaceMode.disabled,clippingMaskUniformValues(matrix),null,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(layer,tileIDs){if(this.currentStencilSource===layer.source||!layer.isTileClipped()||!tileIDs||!tileIDs.length)return;this.currentStencilSource=layer.source;const context=this.context;const gl=context.gl;if(this.nextStencilID+tileIDs.length>256){this.clearStencil()}context.setColorMode(ColorMode.disabled);context.setDepthMode(DepthMode.disabled);const program=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const tileID of tileIDs){const id=this._tileClippingMaskIDs[tileID.key]=this.nextStencilID++;const terrainData=this.style.map.terrain&&this.style.map.terrain.getTerrainData(tileID);program.draw(context,gl.TRIANGLES,DepthMode.disabled,new StencilMode({func:gl.ALWAYS,mask:0},id,255,gl.KEEP,gl.KEEP,gl.REPLACE),ColorMode.disabled,CullFaceMode.disabled,clippingMaskUniformValues(tileID.posMatrix),terrainData,"$clipping",this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}}stencilModeFor3D(){this.currentStencilSource=undefined;if(this.nextStencilID+1>256){this.clearStencil()}const id=this.nextStencilID++;const gl=this.context.gl;return new StencilMode({func:gl.NOTEQUAL,mask:255},id,255,gl.KEEP,gl.KEEP,gl.REPLACE)}stencilModeForClipping(tileID){const gl=this.context.gl;return new StencilMode({func:gl.EQUAL,mask:255},this._tileClippingMaskIDs[tileID.key],0,gl.KEEP,gl.KEEP,gl.REPLACE)}stencilConfigForOverlap(tileIDs){const gl=this.context.gl;const coords=tileIDs.sort(((a,b)=>b.overscaledZ-a.overscaledZ));const minTileZ=coords[coords.length-1].overscaledZ;const stencilValues=coords[0].overscaledZ-minTileZ+1;if(stencilValues>1){this.currentStencilSource=undefined;if(this.nextStencilID+stencilValues>256){this.clearStencil()}const zToStencilMode={};for(let i=0;i<stencilValues;i++){zToStencilMode[i+minTileZ]=new StencilMode({func:gl.GEQUAL,mask:255},i+this.nextStencilID,255,gl.KEEP,gl.KEEP,gl.REPLACE)}this.nextStencilID+=stencilValues;return[zToStencilMode,coords]}return[{[minTileZ]:StencilMode.disabled},coords]}colorModeForRenderPass(){const gl=this.context.gl;if(this._showOverdrawInspector){const numOverdrawSteps=8;const a=1/numOverdrawSteps;return new ColorMode([gl.CONSTANT_COLOR,gl.ONE],new performance$1.Color(a,a,a,0),[true,true,true,true])}else if(this.renderPass==="opaque"){return ColorMode.unblended}else{return ColorMode.alphaBlended}}depthModeForSublayer(n,mask,func){if(!this.opaquePassEnabledForLayer())return DepthMode.disabled;const depth=1-((1+this.currentLayer)*this.numSublayers+n)*this.depthEpsilon;return new DepthMode(func||this.context.gl.LEQUAL,mask,[depth,depth])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(style,options){this.style=style;this.options=options;this.lineAtlas=style.lineAtlas;this.imageManager=style.imageManager;this.glyphManager=style.glyphManager;this.symbolFadeChange=style.placement.symbolFadeChange(browser.now());this.imageManager.beginFrame();const layerIds=this.style._order;const sourceCaches=this.style.sourceCaches;const coordsAscending={};const coordsDescending={};const coordsDescendingSymbol={};for(const id in sourceCaches){const sourceCache=sourceCaches[id];if(sourceCache.used){sourceCache.prepare(this.context)}coordsAscending[id]=sourceCache.getVisibleCoordinates();coordsDescending[id]=coordsAscending[id].slice().reverse();coordsDescendingSymbol[id]=sourceCache.getVisibleCoordinates(true).reverse()}this.opaquePassCutoff=Infinity;for(let i=0;i<layerIds.length;i++){const layerId=layerIds[i];if(this.style._layers[layerId].is3D()){this.opaquePassCutoff=i;break}}if(this.renderToTexture){this.renderToTexture.prepareForRender(this.style,this.transform.zoom);this.opaquePassCutoff=0;const newTiles=this.style.map.terrain.sourceCache.tilesAfterTime(this.terrainFacilitator.renderTime);if(this.terrainFacilitator.dirty||!performance$1.equals(this.terrainFacilitator.matrix,this.transform.projMatrix)||newTiles.length){performance$1.copy(this.terrainFacilitator.matrix,this.transform.projMatrix);this.terrainFacilitator.renderTime=Date.now();this.terrainFacilitator.dirty=false;drawDepth(this,this.style.map.terrain);drawCoords(this,this.style.map.terrain)}}this.renderPass="offscreen";for(const layerId of layerIds){const layer=this.style._layers[layerId];if(!layer.hasOffscreenPass()||layer.isHidden(this.transform.zoom))continue;const coords=coordsDescending[layer.source];if(layer.type!=="custom"&&!coords.length)continue;this.renderLayer(this,sourceCaches[layer.source],layer,coords)}this.context.bindFramebuffer.set(null);this.context.clear({color:options.showOverdrawInspector?performance$1.Color.black:performance$1.Color.transparent,depth:1});this.clearStencil();this._showOverdrawInspector=options.showOverdrawInspector;this.depthRangeFor3D=[0,1-(style._order.length+2)*this.numSublayers*this.depthEpsilon];if(!this.renderToTexture){this.renderPass="opaque";for(this.currentLayer=layerIds.length-1;this.currentLayer>=0;this.currentLayer--){const layer=this.style._layers[layerIds[this.currentLayer]];const sourceCache=sourceCaches[layer.source];const coords=coordsAscending[layer.source];this._renderTileClippingMasks(layer,coords);this.renderLayer(this,sourceCache,layer,coords)}}this.renderPass="translucent";for(this.currentLayer=0;this.currentLayer<layerIds.length;this.currentLayer++){const layer=this.style._layers[layerIds[this.currentLayer]];const sourceCache=sourceCaches[layer.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(layer))continue;const coords=(layer.type==="symbol"?coordsDescendingSymbol:coordsDescending)[layer.source];this._renderTileClippingMasks(layer,coordsAscending[layer.source]);this.renderLayer(this,sourceCache,layer,coords)}if(this.options.showTileBoundaries){const selectedSource=selectDebugSource(this.style,this.transform.zoom);if(selectedSource){drawDebug(this,selectedSource,selectedSource.getVisibleCoordinates())}}if(this.options.showPadding){drawDebugPadding(this)}this.context.setDefault()}renderLayer(painter,sourceCache,layer,coords){if(layer.isHidden(this.transform.zoom))return;if(layer.type!=="background"&&layer.type!=="custom"&&!(coords||[]).length)return;this.id=layer.id;switch(layer.type){case"symbol":drawSymbols(painter,sourceCache,layer,coords,this.style.placement.variableOffsets);break;case"circle":drawCircles(painter,sourceCache,layer,coords);break;case"heatmap":drawHeatmap(painter,sourceCache,layer,coords);break;case"line":drawLine(painter,sourceCache,layer,coords);break;case"fill":drawFill(painter,sourceCache,layer,coords);break;case"fill-extrusion":drawFillExtrusion(painter,sourceCache,layer,coords);break;case"hillshade":drawHillshade(painter,sourceCache,layer,coords);break;case"raster":drawRaster(painter,sourceCache,layer,coords);break;case"background":drawBackground(painter,sourceCache,layer,coords);break;case"custom":drawCustom(painter,sourceCache,layer);break}}translatePosMatrix(matrix,tile,translate,translateAnchor,inViewportPixelUnitsUnits){if(!translate[0]&&!translate[1])return matrix;const angle=inViewportPixelUnitsUnits?translateAnchor==="map"?this.transform.angle:0:translateAnchor==="viewport"?-this.transform.angle:0;if(angle){const sinA=Math.sin(angle);const cosA=Math.cos(angle);translate=[translate[0]*cosA-translate[1]*sinA,translate[0]*sinA+translate[1]*cosA]}const translation=[inViewportPixelUnitsUnits?translate[0]:pixelsToTileUnits(tile,translate[0],this.transform.zoom),inViewportPixelUnitsUnits?translate[1]:pixelsToTileUnits(tile,translate[1],this.transform.zoom),0];const translatedMatrix=new Float32Array(16);performance$1.translate(translatedMatrix,matrix,translation);return translatedMatrix}saveTileTexture(texture){const textures=this._tileTextures[texture.size[0]];if(!textures){this._tileTextures[texture.size[0]]=[texture]}else{textures.push(texture)}}getTileTexture(size){const textures=this._tileTextures[size];return textures&&textures.length>0?textures.pop():null}isPatternMissing(image){if(!image)return false;if(!image.from||!image.to)return true;const imagePosA=this.imageManager.getPattern(image.from.toString());const imagePosB=this.imageManager.getPattern(image.to.toString());return!imagePosA||!imagePosB}useProgram(name,programConfiguration){this.cache=this.cache||{};const key=name+(programConfiguration?programConfiguration.cacheKey:"")+(this._showOverdrawInspector?"/overdraw":"")+(this.style.map.terrain?"/terrain":"");if(!this.cache[key]){this.cache[key]=new Program(this.context,shaders[name],programConfiguration,programUniforms[name],this._showOverdrawInspector,this.style.map.terrain)}return this.cache[key]}setCustomLayerDefaults(){this.context.unbindVAO();this.context.cullFace.setDefault();this.context.activeTexture.setDefault();this.context.pixelStoreUnpack.setDefault();this.context.pixelStoreUnpackPremultiplyAlpha.setDefault();this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const gl=this.context.gl;this.context.cullFace.set(false);this.context.viewport.set([0,0,this.width,this.height]);this.context.blendEquation.set(gl.FUNC_ADD)}initDebugOverlayCanvas(){if(this.debugOverlayCanvas==null){this.debugOverlayCanvas=document.createElement("canvas");this.debugOverlayCanvas.width=512;this.debugOverlayCanvas.height=512;const gl=this.context.gl;this.debugOverlayTexture=new Texture(this.context,this.debugOverlayCanvas,gl.RGBA)}}destroy(){if(this.debugOverlayTexture){this.debugOverlayTexture.destroy()}}overLimit(){const{drawingBufferWidth:drawingBufferWidth,drawingBufferHeight:drawingBufferHeight}=this.context.gl;return this.width!==drawingBufferWidth||this.height!==drawingBufferHeight}}class Frustum{constructor(points,planes){this.points=points;this.planes=planes}static fromInvProjectionMatrix(invProj,worldSize,zoom){const clipSpaceCorners=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]];const scale=Math.pow(2,zoom);const frustumCoords=clipSpaceCorners.map((v=>{v=performance$1.transformMat4([],v,invProj);const s=1/v[3]/worldSize*scale;return performance$1.mul$1(v,v,[s,s,1/v[3],s])}));const frustumPlanePointIndices=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]];const frustumPlanes=frustumPlanePointIndices.map((p=>{const a=performance$1.sub([],frustumCoords[p[0]],frustumCoords[p[1]]);const b=performance$1.sub([],frustumCoords[p[2]],frustumCoords[p[1]]);const n=performance$1.normalize([],performance$1.cross([],a,b));const d=-performance$1.dot(n,frustumCoords[p[1]]);return n.concat(d)}));return new Frustum(frustumCoords,frustumPlanes)}}class Aabb{constructor(min_,max_){this.min=min_;this.max=max_;this.center=performance$1.scale$1([],performance$1.add([],this.min,this.max),.5)}quadrant(index){const split=[index%2===0,index<2];const qMin=performance$1.clone$2(this.min);const qMax=performance$1.clone$2(this.max);for(let axis=0;axis<split.length;axis++){qMin[axis]=split[axis]?this.min[axis]:this.center[axis];qMax[axis]=split[axis]?this.center[axis]:this.max[axis]}qMax[2]=this.max[2];return new Aabb(qMin,qMax)}distanceX(point){const pointOnAabb=Math.max(Math.min(this.max[0],point[0]),this.min[0]);return pointOnAabb-point[0]}distanceY(point){const pointOnAabb=Math.max(Math.min(this.max[1],point[1]),this.min[1]);return pointOnAabb-point[1]}intersects(frustum){const aabbPoints=[[this.min[0],this.min[1],this.min[2],1],[this.max[0],this.min[1],this.min[2],1],[this.max[0],this.max[1],this.min[2],1],[this.min[0],this.max[1],this.min[2],1],[this.min[0],this.min[1],this.max[2],1],[this.max[0],this.min[1],this.max[2],1],[this.max[0],this.max[1],this.max[2],1],[this.min[0],this.max[1],this.max[2],1]];let fullyInside=true;for(let p=0;p<frustum.planes.length;p++){const plane=frustum.planes[p];let pointsInside=0;for(let i=0;i<aabbPoints.length;i++){if(performance$1.dot$1(plane,aabbPoints[i])>=0){pointsInside++}}if(pointsInside===0)return 0;if(pointsInside!==aabbPoints.length)fullyInside=false}if(fullyInside)return 2;for(let axis=0;axis<3;axis++){let projMin=Number.MAX_VALUE;let projMax=-Number.MAX_VALUE;for(let p=0;p<frustum.points.length;p++){const projectedPoint=frustum.points[p][axis]-this.min[axis];projMin=Math.min(projMin,projectedPoint);projMax=Math.max(projMax,projectedPoint)}if(projMax<0||projMin>this.max[axis]-this.min[axis])return 0}return 1}}class EdgeInsets{constructor(top=0,bottom=0,left=0,right=0){if(isNaN(top)||top<0||isNaN(bottom)||bottom<0||isNaN(left)||left<0||isNaN(right)||right<0){throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers")}this.top=top;this.bottom=bottom;this.left=left;this.right=right}interpolate(start,target,t){if(target.top!=null&&start.top!=null)this.top=performance$1.interpolate.number(start.top,target.top,t);if(target.bottom!=null&&start.bottom!=null)this.bottom=performance$1.interpolate.number(start.bottom,target.bottom,t);if(target.left!=null&&start.left!=null)this.left=performance$1.interpolate.number(start.left,target.left,t);if(target.right!=null&&start.right!=null)this.right=performance$1.interpolate.number(start.right,target.right,t);return this}getCenter(width,height){const x=performance$1.clamp((this.left+width-this.right)/2,0,width);const y=performance$1.clamp((this.top+height-this.bottom)/2,0,height);return new performance$1.Point(x,y)}equals(other){return this.top===other.top&&this.bottom===other.bottom&&this.left===other.left&&this.right===other.right}clone(){return new EdgeInsets(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}class Transform{constructor(minZoom,maxZoom,minPitch,maxPitch,renderWorldCopies){this.tileSize=512;this.maxValidLatitude=85.051129;this._renderWorldCopies=renderWorldCopies===undefined?true:!!renderWorldCopies;this._minZoom=minZoom||0;this._maxZoom=maxZoom||22;this._minPitch=minPitch===undefined||minPitch===null?0:minPitch;this._maxPitch=maxPitch===undefined||maxPitch===null?60:maxPitch;this.setMaxBounds();this.width=0;this.height=0;this._center=new performance$1.LngLat(0,0);this._elevation=0;this.zoom=0;this.angle=0;this._fov=.6435011087932844;this._pitch=0;this._unmodified=true;this._edgeInsets=new EdgeInsets;this._posMatrixCache={};this._alignedPosMatrixCache={};this.minElevationForCurrentTile=0}clone(){const clone=new Transform(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);clone.apply(this);return clone}apply(that){this.tileSize=that.tileSize;this.latRange=that.latRange;this.width=that.width;this.height=that.height;this._center=that._center;this._elevation=that._elevation;this.minElevationForCurrentTile=that.minElevationForCurrentTile;this.zoom=that.zoom;this.angle=that.angle;this._fov=that._fov;this._pitch=that._pitch;this._unmodified=that._unmodified;this._edgeInsets=that._edgeInsets.clone();this._calcMatrices()}get minZoom(){return this._minZoom}set minZoom(zoom){if(this._minZoom===zoom)return;this._minZoom=zoom;this.zoom=Math.max(this.zoom,zoom)}get maxZoom(){return this._maxZoom}set maxZoom(zoom){if(this._maxZoom===zoom)return;this._maxZoom=zoom;this.zoom=Math.min(this.zoom,zoom)}get minPitch(){return this._minPitch}set minPitch(pitch){if(this._minPitch===pitch)return;this._minPitch=pitch;this.pitch=Math.max(this.pitch,pitch)}get maxPitch(){return this._maxPitch}set maxPitch(pitch){if(this._maxPitch===pitch)return;this._maxPitch=pitch;this.pitch=Math.min(this.pitch,pitch)}get renderWorldCopies(){return this._renderWorldCopies}set renderWorldCopies(renderWorldCopies){if(renderWorldCopies===undefined){renderWorldCopies=true}else if(renderWorldCopies===null){renderWorldCopies=false}this._renderWorldCopies=renderWorldCopies}get worldSize(){return this.tileSize*this.scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new performance$1.Point(this.width,this.height)}get bearing(){return-this.angle/Math.PI*180}set bearing(bearing){const b=-performance$1.wrap(bearing,-180,180)*Math.PI/180;if(this.angle===b)return;this._unmodified=false;this.angle=b;this._calcMatrices();this.rotationMatrix=performance$1.create$2();performance$1.rotate(this.rotationMatrix,this.rotationMatrix,this.angle)}get pitch(){return this._pitch/Math.PI*180}set pitch(pitch){const p=performance$1.clamp(pitch,this.minPitch,this.maxPitch)/180*Math.PI;if(this._pitch===p)return;this._unmodified=false;this._pitch=p;this._calcMatrices()}get fov(){return this._fov/Math.PI*180}set fov(fov){fov=Math.max(.01,Math.min(60,fov));if(this._fov===fov)return;this._unmodified=false;this._fov=fov/180*Math.PI;this._calcMatrices()}get zoom(){return this._zoom}set zoom(zoom){const constrainedZoom=Math.min(Math.max(zoom,this.minZoom),this.maxZoom);if(this._zoom===constrainedZoom)return;this._unmodified=false;this._zoom=constrainedZoom;this.tileZoom=Math.max(0,Math.floor(constrainedZoom));this.scale=this.zoomScale(constrainedZoom);this._constrain();this._calcMatrices()}get center(){return this._center}set center(center){if(center.lat===this._center.lat&&center.lng===this._center.lng)return;this._unmodified=false;this._center=center;this._constrain();this._calcMatrices()}get elevation(){return this._elevation}set elevation(elevation){if(elevation===this._elevation)return;this._elevation=elevation;this._constrain();this._calcMatrices()}get padding(){return this._edgeInsets.toJSON()}set padding(padding){if(this._edgeInsets.equals(padding))return;this._unmodified=false;this._edgeInsets.interpolate(this._edgeInsets,padding,1);this._calcMatrices()}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}isPaddingEqual(padding){return this._edgeInsets.equals(padding)}interpolatePadding(start,target,t){this._unmodified=false;this._edgeInsets.interpolate(start,target,t);this._constrain();this._calcMatrices()}coveringZoomLevel(options){const z=(options.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/options.tileSize));return Math.max(0,z)}getVisibleUnwrappedCoordinates(tileID){const result=[new performance$1.UnwrappedTileID(0,tileID)];if(this._renderWorldCopies){const utl=this.pointCoordinate(new performance$1.Point(0,0));const utr=this.pointCoordinate(new performance$1.Point(this.width,0));const ubl=this.pointCoordinate(new performance$1.Point(this.width,this.height));const ubr=this.pointCoordinate(new performance$1.Point(0,this.height));const w0=Math.floor(Math.min(utl.x,utr.x,ubl.x,ubr.x));const w1=Math.floor(Math.max(utl.x,utr.x,ubl.x,ubr.x));const extraWorldCopy=1;for(let w=w0-extraWorldCopy;w<=w1+extraWorldCopy;w++){if(w===0)continue;result.push(new performance$1.UnwrappedTileID(w,tileID))}}return result}coveringTiles(options){var _a,_b;let z=this.coveringZoomLevel(options);const actualZ=z;if(options.minzoom!==undefined&&z<options.minzoom)return[];if(options.maxzoom!==undefined&&z>options.maxzoom)z=options.maxzoom;const cameraCoord=this.pointCoordinate(this.getCameraPoint());const centerCoord=performance$1.MercatorCoordinate.fromLngLat(this.center);const numTiles=Math.pow(2,z);const cameraPoint=[numTiles*cameraCoord.x,numTiles*cameraCoord.y,0];const centerPoint=[numTiles*centerCoord.x,numTiles*centerCoord.y,0];const cameraFrustum=Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,z);let minZoom=options.minzoom||0;if(!options.terrain&&this.pitch<=60&&this._edgeInsets.top<.1)minZoom=z;const radiusOfMaxLvlLodInTiles=options.terrain?2/Math.min(this.tileSize,options.tileSize)*this.tileSize:3;const newRootTile=wrap=>({aabb:new Aabb([wrap*numTiles,0,0],[(wrap+1)*numTiles,numTiles,0]),zoom:0,x:0,y:0,wrap:wrap,fullyVisible:false});const stack=[];const result=[];const maxZoom=z;const overscaledZ=options.reparseOverscaled?actualZ:z;if(this._renderWorldCopies){for(let i=1;i<=3;i++){stack.push(newRootTile(-i));stack.push(newRootTile(i))}}stack.push(newRootTile(0));while(stack.length>0){const it=stack.pop();const x=it.x;const y=it.y;let fullyVisible=it.fullyVisible;if(!fullyVisible){const intersectResult=it.aabb.intersects(cameraFrustum);if(intersectResult===0)continue;fullyVisible=intersectResult===2}const refPoint=options.terrain?cameraPoint:centerPoint;const distanceX=it.aabb.distanceX(refPoint);const distanceY=it.aabb.distanceY(refPoint);const longestDim=Math.max(Math.abs(distanceX),Math.abs(distanceY));const distToSplit=radiusOfMaxLvlLodInTiles+(1<<maxZoom-it.zoom)-2;if(it.zoom===maxZoom||longestDim>distToSplit&&it.zoom>=minZoom){const dz=maxZoom-it.zoom,dx=cameraPoint[0]-.5-(x<<dz),dy=cameraPoint[1]-.5-(y<<dz);result.push({tileID:new performance$1.OverscaledTileID(it.zoom===maxZoom?overscaledZ:it.zoom,it.wrap,it.zoom,x,y),distanceSq:performance$1.sqrLen([centerPoint[0]-.5-x,centerPoint[1]-.5-y]),tileDistanceToCamera:Math.sqrt(dx*dx+dy*dy)});continue}for(let i=0;i<4;i++){const childX=(x<<1)+i%2;const childY=(y<<1)+(i>>1);const childZ=it.zoom+1;let quadrant=it.aabb.quadrant(i);if(options.terrain){const tileID=new performance$1.OverscaledTileID(childZ,it.wrap,childZ,childX,childY);const minMax=options.terrain.getMinMaxElevation(tileID);const minElevation=(_a=minMax.minElevation)!==null&&_a!==void 0?_a:this.elevation;const maxElevation=(_b=minMax.maxElevation)!==null&&_b!==void 0?_b:this.elevation;quadrant=new Aabb([quadrant.min[0],quadrant.min[1],minElevation],[quadrant.max[0],quadrant.max[1],maxElevation])}stack.push({aabb:quadrant,zoom:childZ,x:childX,y:childY,wrap:it.wrap,fullyVisible:fullyVisible})}}return result.sort(((a,b)=>a.distanceSq-b.distanceSq)).map((a=>a.tileID))}resize(width,height){this.width=width;this.height=height;this.pixelsToGLUnits=[2/width,-2/height];this._constrain();this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(zoom){return Math.pow(2,zoom)}scaleZoom(scale){return Math.log(scale)/Math.LN2}project(lnglat){const lat=performance$1.clamp(lnglat.lat,-this.maxValidLatitude,this.maxValidLatitude);return new performance$1.Point(performance$1.mercatorXfromLng(lnglat.lng)*this.worldSize,performance$1.mercatorYfromLat(lat)*this.worldSize)}unproject(point){return new performance$1.MercatorCoordinate(point.x/this.worldSize,point.y/this.worldSize).toLngLat()}get point(){return this.project(this.center)}getCameraPosition(){const lngLat=this.pointLocation(this.getCameraPoint());const altitude=Math.cos(this._pitch)*this.cameraToCenterDistance/this._pixelPerMeter;return{lngLat:lngLat,altitude:altitude+this.elevation}}recalculateZoom(terrain){const center=this.pointLocation(this.centerPoint,terrain);const elevation=terrain.getElevationForLngLatZoom(center,this.tileZoom);const deltaElevation=this.elevation-elevation;if(!deltaElevation)return;const cameraPosition=this.getCameraPosition();const camera=performance$1.MercatorCoordinate.fromLngLat(cameraPosition.lngLat,cameraPosition.altitude);const target=performance$1.MercatorCoordinate.fromLngLat(center,elevation);const dx=camera.x-target.x,dy=camera.y-target.y,dz=camera.z-target.z;const distance=Math.sqrt(dx*dx+dy*dy+dz*dz);const zoom=this.scaleZoom(this.cameraToCenterDistance/distance/this.tileSize);this._elevation=elevation;this._center=center;this.zoom=zoom}setLocationAtPoint(lnglat,point){const a=this.pointCoordinate(point);const b=this.pointCoordinate(this.centerPoint);const loc=this.locationCoordinate(lnglat);const newCenter=new performance$1.MercatorCoordinate(loc.x-(a.x-b.x),loc.y-(a.y-b.y));this.center=this.coordinateLocation(newCenter);if(this._renderWorldCopies){this.center=this.center.wrap()}}locationPoint(lnglat,terrain){return terrain?this.coordinatePoint(this.locationCoordinate(lnglat),terrain.getElevationForLngLatZoom(lnglat,this.tileZoom),this.pixelMatrix3D):this.coordinatePoint(this.locationCoordinate(lnglat))}pointLocation(p,terrain){return this.coordinateLocation(this.pointCoordinate(p,terrain))}locationCoordinate(lnglat){return performance$1.MercatorCoordinate.fromLngLat(lnglat)}coordinateLocation(coord){return coord&&coord.toLngLat()}pointCoordinate(p,terrain){if(terrain){const coordinate=terrain.pointCoordinate(p);if(coordinate!=null){return coordinate}}const targetZ=0;const coord0=[p.x,p.y,0,1];const coord1=[p.x,p.y,1,1];performance$1.transformMat4(coord0,coord0,this.pixelMatrixInverse);performance$1.transformMat4(coord1,coord1,this.pixelMatrixInverse);const w0=coord0[3];const w1=coord1[3];const x0=coord0[0]/w0;const x1=coord1[0]/w1;const y0=coord0[1]/w0;const y1=coord1[1]/w1;const z0=coord0[2]/w0;const z1=coord1[2]/w1;const t=z0===z1?0:(targetZ-z0)/(z1-z0);return new performance$1.MercatorCoordinate(performance$1.interpolate.number(x0,x1,t)/this.worldSize,performance$1.interpolate.number(y0,y1,t)/this.worldSize)}coordinatePoint(coord,elevation=0,pixelMatrix=this.pixelMatrix){const p=[coord.x*this.worldSize,coord.y*this.worldSize,elevation,1];performance$1.transformMat4(p,p,pixelMatrix);return new performance$1.Point(p[0]/p[3],p[1]/p[3])}getBounds(){const top=Math.max(0,this.height/2-this.getHorizon());return(new LngLatBounds).extend(this.pointLocation(new performance$1.Point(0,top))).extend(this.pointLocation(new performance$1.Point(this.width,top))).extend(this.pointLocation(new performance$1.Point(this.width,this.height))).extend(this.pointLocation(new performance$1.Point(0,this.height)))}getMaxBounds(){if(!this.latRange||this.latRange.length!==2||!this.lngRange||this.lngRange.length!==2)return null;return new LngLatBounds([this.lngRange[0],this.latRange[0]],[this.lngRange[1],this.latRange[1]])}getHorizon(){return Math.tan(Math.PI/2-this._pitch)*this.cameraToCenterDistance*.85}setMaxBounds(bounds){if(bounds){this.lngRange=[bounds.getWest(),bounds.getEast()];this.latRange=[bounds.getSouth(),bounds.getNorth()];this._constrain()}else{this.lngRange=null;this.latRange=[-this.maxValidLatitude,this.maxValidLatitude]}}calculatePosMatrix(unwrappedTileID,aligned=false){const posMatrixKey=unwrappedTileID.key;const cache=aligned?this._alignedPosMatrixCache:this._posMatrixCache;if(cache[posMatrixKey]){return cache[posMatrixKey]}const canonical=unwrappedTileID.canonical;const scale=this.worldSize/this.zoomScale(canonical.z);const unwrappedX=canonical.x+Math.pow(2,canonical.z)*unwrappedTileID.wrap;const posMatrix=performance$1.identity(new Float64Array(16));performance$1.translate(posMatrix,posMatrix,[unwrappedX*scale,canonical.y*scale,0]);performance$1.scale(posMatrix,posMatrix,[scale/performance$1.EXTENT,scale/performance$1.EXTENT,1]);performance$1.multiply(posMatrix,aligned?this.alignedProjMatrix:this.projMatrix,posMatrix);cache[posMatrixKey]=new Float32Array(posMatrix);return cache[posMatrixKey]}customLayerMatrix(){return this.mercatorMatrix.slice()}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=true;let minY=-90;let maxY=90;let minX=-180;let maxX=180;let sy,sx,x2,y2;const size=this.size,unmodified=this._unmodified;if(this.latRange){const latRange=this.latRange;minY=performance$1.mercatorYfromLat(latRange[1])*this.worldSize;maxY=performance$1.mercatorYfromLat(latRange[0])*this.worldSize;sy=maxY-minY<size.y?size.y/(maxY-minY):0}if(this.lngRange){const lngRange=this.lngRange;minX=performance$1.wrap(performance$1.mercatorXfromLng(lngRange[0])*this.worldSize,0,this.worldSize);maxX=performance$1.wrap(performance$1.mercatorXfromLng(lngRange[1])*this.worldSize,0,this.worldSize);if(maxX<minX)maxX+=this.worldSize;sx=maxX-minX<size.x?size.x/(maxX-minX):0}const point=this.point;const s=Math.max(sx||0,sy||0);if(s){this.center=this.unproject(new performance$1.Point(sx?(maxX+minX)/2:point.x,sy?(maxY+minY)/2:point.y));this.zoom+=this.scaleZoom(s);this._unmodified=unmodified;this._constraining=false;return}if(this.latRange){const y=point.y,h2=size.y/2;if(y-h2<minY)y2=minY+h2;if(y+h2>maxY)y2=maxY-h2}if(this.lngRange){const centerX=(minX+maxX)/2;const x=performance$1.wrap(point.x,centerX-this.worldSize/2,centerX+this.worldSize/2);const w2=size.x/2;if(x-w2<minX)x2=minX+w2;if(x+w2>maxX)x2=maxX-w2}if(x2!==undefined||y2!==undefined){this.center=this.unproject(new performance$1.Point(x2!==undefined?x2:point.x,y2!==undefined?y2:point.y)).wrap()}this._unmodified=unmodified;this._constraining=false}_calcMatrices(){if(!this.height)return;const halfFov=this._fov/2;const offset=this.centerOffset;const x=this.point.x,y=this.point.y;this.cameraToCenterDistance=.5/Math.tan(halfFov)*this.height;this._pixelPerMeter=performance$1.mercatorZfromAltitude(1,this.center.lat)*this.worldSize;let m=performance$1.identity(new Float64Array(16));performance$1.scale(m,m,[this.width/2,-this.height/2,1]);performance$1.translate(m,m,[1,-1,0]);this.labelPlaneMatrix=m;m=performance$1.identity(new Float64Array(16));performance$1.scale(m,m,[1,-1,1]);performance$1.translate(m,m,[-1,-1,0]);performance$1.scale(m,m,[2/this.width,2/this.height,1]);this.glCoordMatrix=m;const cameraToSeaLevelDistance=this.cameraToCenterDistance+this._elevation*this._pixelPerMeter/Math.cos(this._pitch);const minElevation=Math.min(this.elevation,this.minElevationForCurrentTile);const cameraToLowestPointDistance=cameraToSeaLevelDistance-minElevation*this._pixelPerMeter/Math.cos(this._pitch);const lowestPlane=minElevation<0?cameraToLowestPointDistance:cameraToSeaLevelDistance;const groundAngle=Math.PI/2+this._pitch;const fovAboveCenter=this._fov*(.5+offset.y/this.height);const topHalfSurfaceDistance=Math.sin(fovAboveCenter)*lowestPlane/Math.sin(performance$1.clamp(Math.PI-groundAngle-fovAboveCenter,.01,Math.PI-.01));const horizon=this.getHorizon();const horizonAngle=Math.atan(horizon/this.cameraToCenterDistance);const fovCenterToHorizon=2*horizonAngle*(.5+offset.y/(horizon*2));const topHalfSurfaceDistanceHorizon=Math.sin(fovCenterToHorizon)*lowestPlane/Math.sin(performance$1.clamp(Math.PI-groundAngle-fovCenterToHorizon,.01,Math.PI-.01));const topHalfMinDistance=Math.min(topHalfSurfaceDistance,topHalfSurfaceDistanceHorizon);const farZ=(Math.cos(Math.PI/2-this._pitch)*topHalfMinDistance+lowestPlane)*1.01;const nearZ=this.height/50;m=new Float64Array(16);performance$1.perspective(m,this._fov,this.width/this.height,nearZ,farZ);m[8]=-offset.x*2/this.width;m[9]=offset.y*2/this.height;performance$1.scale(m,m,[1,-1,1]);performance$1.translate(m,m,[0,0,-this.cameraToCenterDistance]);performance$1.rotateX(m,m,this._pitch);performance$1.rotateZ(m,m,this.angle);performance$1.translate(m,m,[-x,-y,0]);this.mercatorMatrix=performance$1.scale([],m,[this.worldSize,this.worldSize,this.worldSize]);performance$1.scale(m,m,[1,1,this._pixelPerMeter]);this.pixelMatrix=performance$1.multiply(new Float64Array(16),this.labelPlaneMatrix,m);performance$1.translate(m,m,[0,0,-this.elevation]);this.projMatrix=m;this.invProjMatrix=performance$1.invert([],m);this.pixelMatrix3D=performance$1.multiply(new Float64Array(16),this.labelPlaneMatrix,m);const xShift=this.width%2/2,yShift=this.height%2/2,angleCos=Math.cos(this.angle),angleSin=Math.sin(this.angle),dx=x-Math.round(x)+angleCos*xShift+angleSin*yShift,dy=y-Math.round(y)+angleCos*yShift+angleSin*xShift;const alignedM=new Float64Array(m);performance$1.translate(alignedM,alignedM,[dx>.5?dx-1:dx,dy>.5?dy-1:dy,0]);this.alignedProjMatrix=alignedM;m=performance$1.invert(new Float64Array(16),this.pixelMatrix);if(!m)throw new Error("failed to invert matrix");this.pixelMatrixInverse=m;this._posMatrixCache={};this._alignedPosMatrixCache={}}maxPitchScaleFactor(){if(!this.pixelMatrixInverse)return 1;const coord=this.pointCoordinate(new performance$1.Point(0,0));const p=[coord.x*this.worldSize,coord.y*this.worldSize,0,1];const topPoint=performance$1.transformMat4(p,p,this.pixelMatrix);return topPoint[3]/this.cameraToCenterDistance}getCameraPoint(){const pitch=this._pitch;const yOffset=Math.tan(pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new performance$1.Point(0,yOffset))}getCameraQueryGeometry(queryGeometry){const c=this.getCameraPoint();if(queryGeometry.length===1){return[queryGeometry[0],c]}else{let minX=c.x;let minY=c.y;let maxX=c.x;let maxY=c.y;for(const p of queryGeometry){minX=Math.min(minX,p.x);minY=Math.min(minY,p.y);maxX=Math.max(maxX,p.x);maxY=Math.max(maxY,p.y)}return[new performance$1.Point(minX,minY),new performance$1.Point(maxX,minY),new performance$1.Point(maxX,maxY),new performance$1.Point(minX,maxY),new performance$1.Point(minX,minY)]}}lngLatToCameraDepth(lngLat,elevation){const coord=this.locationCoordinate(lngLat);const p=[coord.x*this.worldSize,coord.y*this.worldSize,elevation,1];performance$1.transformMat4(p,p,this.projMatrix);return p[2]/p[3]}}function throttle(fn,time){let pending=false;let timerId=null;let lastCallContext=null;let lastCallArgs;const later=()=>{timerId=null;if(pending){fn.apply(lastCallContext,lastCallArgs);timerId=setTimeout(later,time);pending=false}};return(...args)=>{pending=true;lastCallContext=this;lastCallArgs=args;if(!timerId){later()}return timerId}}class Hash{constructor(hashName){this._getCurrentHash=()=>{const hash=window.location.hash.replace("#","");if(this._hashName){let keyval;hash.split("&").map((part=>part.split("="))).forEach((part=>{if(part[0]===this._hashName){keyval=part}}));return(keyval?keyval[1]||"":"").split("/")}return hash.split("/")};this._onHashChange=()=>{const loc=this._getCurrentHash();if(loc.length>=3&&!loc.some((v=>isNaN(v)))){const bearing=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(loc[3]||0):this._map.getBearing();this._map.jumpTo({center:[+loc[2],+loc[1]],zoom:+loc[0],bearing:bearing,pitch:+(loc[4]||0)});return true}return false};this._updateHashUnthrottled=()=>{const location=window.location.href.replace(/(#.+)?$/,this.getHashString());try{window.history.replaceState(window.history.state,null,location)}catch(SecurityError){}};this._updateHash=throttle(this._updateHashUnthrottled,30*1e3/100);this._hashName=hashName&&encodeURIComponent(hashName)}addTo(map){this._map=map;addEventListener("hashchange",this._onHashChange,false);this._map.on("moveend",this._updateHash);return this}remove(){removeEventListener("hashchange",this._onHashChange,false);this._map.off("moveend",this._updateHash);clearTimeout(this._updateHash());delete this._map;return this}getHashString(mapFeedback){const center=this._map.getCenter(),zoom=Math.round(this._map.getZoom()*100)/100,precision=Math.ceil((zoom*Math.LN2+Math.log(512/360/.5))/Math.LN10),m=Math.pow(10,precision),lng=Math.round(center.lng*m)/m,lat=Math.round(center.lat*m)/m,bearing=this._map.getBearing(),pitch=this._map.getPitch();let hash="";if(mapFeedback){hash+=`/${lng}/${lat}/${zoom}`}else{hash+=`${zoom}/${lat}/${lng}`}if(bearing||pitch)hash+=`/${Math.round(bearing*10)/10}`;if(pitch)hash+=`/${Math.round(pitch)}`;if(this._hashName){const hashName=this._hashName;let found=false;const parts=window.location.hash.slice(1).split("&").map((part=>{const key=part.split("=")[0];if(key===hashName){found=true;return`${key}=${hash}`}return part})).filter((a=>a));if(!found){parts.push(`${hashName}=${hash}`)}return`#${parts.join("&")}`}return`#${hash}`}}const defaultInertiaOptions={linearity:.3,easing:performance$1.bezier(0,0,.3,1)};const defaultPanInertiaOptions=performance$1.extend({deceleration:2500,maxSpeed:1400},defaultInertiaOptions);const defaultZoomInertiaOptions=performance$1.extend({deceleration:20,maxSpeed:1400},defaultInertiaOptions);const defaultBearingInertiaOptions=performance$1.extend({deceleration:1e3,maxSpeed:360},defaultInertiaOptions);const defaultPitchInertiaOptions=performance$1.extend({deceleration:1e3,maxSpeed:90},defaultInertiaOptions);class HandlerInertia{constructor(map){this._map=map;this.clear()}clear(){this._inertiaBuffer=[]}record(settings){this._drainInertiaBuffer();this._inertiaBuffer.push({time:browser.now(),settings:settings})}_drainInertiaBuffer(){const inertia=this._inertiaBuffer,now=browser.now(),cutoff=160;while(inertia.length>0&&now-inertia[0].time>cutoff)inertia.shift()}_onMoveEnd(panInertiaOptions){this._drainInertiaBuffer();if(this._inertiaBuffer.length<2){return}const deltas={zoom:0,bearing:0,pitch:0,pan:new performance$1.Point(0,0),pinchAround:undefined,around:undefined};for(const{settings:settings}of this._inertiaBuffer){deltas.zoom+=settings.zoomDelta||0;deltas.bearing+=settings.bearingDelta||0;deltas.pitch+=settings.pitchDelta||0;if(settings.panDelta)deltas.pan._add(settings.panDelta);if(settings.around)deltas.around=settings.around;if(settings.pinchAround)deltas.pinchAround=settings.pinchAround}const lastEntry=this._inertiaBuffer[this._inertiaBuffer.length-1];const duration=lastEntry.time-this._inertiaBuffer[0].time;const easeOptions={};if(deltas.pan.mag()){const result=calculateEasing(deltas.pan.mag(),duration,performance$1.extend({},defaultPanInertiaOptions,panInertiaOptions||{}));easeOptions.offset=deltas.pan.mult(result.amount/deltas.pan.mag());easeOptions.center=this._map.transform.center;extendDuration(easeOptions,result)}if(deltas.zoom){const result=calculateEasing(deltas.zoom,duration,defaultZoomInertiaOptions);easeOptions.zoom=this._map.transform.zoom+result.amount;extendDuration(easeOptions,result)}if(deltas.bearing){const result=calculateEasing(deltas.bearing,duration,defaultBearingInertiaOptions);easeOptions.bearing=this._map.transform.bearing+performance$1.clamp(result.amount,-179,179);extendDuration(easeOptions,result)}if(deltas.pitch){const result=calculateEasing(deltas.pitch,duration,defaultPitchInertiaOptions);easeOptions.pitch=this._map.transform.pitch+result.amount;extendDuration(easeOptions,result)}if(easeOptions.zoom||easeOptions.bearing){const last=deltas.pinchAround===undefined?deltas.around:deltas.pinchAround;easeOptions.around=last?this._map.unproject(last):this._map.getCenter()}this.clear();return performance$1.extend(easeOptions,{noMoveStart:true})}}function extendDuration(easeOptions,result){if(!easeOptions.duration||easeOptions.duration<result.duration){easeOptions.duration=result.duration;easeOptions.easing=result.easing}}function calculateEasing(amount,inertiaDuration,inertiaOptions){const{maxSpeed:maxSpeed,linearity:linearity,deceleration:deceleration}=inertiaOptions;const speed=performance$1.clamp(amount*linearity/(inertiaDuration/1e3),-maxSpeed,maxSpeed);const duration=Math.abs(speed)/(deceleration*linearity);return{easing:inertiaOptions.easing,duration:duration*1e3,amount:speed*(duration/2)}}class MapMouseEvent extends performance$1.Event{preventDefault(){this._defaultPrevented=true}get defaultPrevented(){return this._defaultPrevented}constructor(type,map,originalEvent,data={}){const point=DOM.mousePos(map.getCanvas(),originalEvent);const lngLat=map.unproject(point);super(type,performance$1.extend({point:point,lngLat:lngLat,originalEvent:originalEvent},data));this._defaultPrevented=false;this.target=map}}class MapTouchEvent extends performance$1.Event{preventDefault(){this._defaultPrevented=true}get defaultPrevented(){return this._defaultPrevented}constructor(type,map,originalEvent){const touches=type==="touchend"?originalEvent.changedTouches:originalEvent.touches;const points=DOM.touchPos(map.getCanvasContainer(),touches);const lngLats=points.map((t=>map.unproject(t)));const point=points.reduce(((prev,curr,i,arr)=>prev.add(curr.div(arr.length))),new performance$1.Point(0,0));const lngLat=map.unproject(point);super(type,{points:points,point:point,lngLats:lngLats,lngLat:lngLat,originalEvent:originalEvent});this._defaultPrevented=false}}class MapWheelEvent extends performance$1.Event{preventDefault(){this._defaultPrevented=true}get defaultPrevented(){return this._defaultPrevented}constructor(type,map,originalEvent){super(type,{originalEvent:originalEvent});this._defaultPrevented=false}}class MapEventHandler{constructor(map,options){this._map=map;this._clickTolerance=options.clickTolerance}reset(){delete this._mousedownPos}wheel(e){return this._firePreventable(new MapWheelEvent(e.type,this._map,e))}mousedown(e,point){this._mousedownPos=point;return this._firePreventable(new MapMouseEvent(e.type,this._map,e))}mouseup(e){this._map.fire(new MapMouseEvent(e.type,this._map,e))}click(e,point){if(this._mousedownPos&&this._mousedownPos.dist(point)>=this._clickTolerance)return;this._map.fire(new MapMouseEvent(e.type,this._map,e))}dblclick(e){return this._firePreventable(new MapMouseEvent(e.type,this._map,e))}mouseover(e){this._map.fire(new MapMouseEvent(e.type,this._map,e))}mouseout(e){this._map.fire(new MapMouseEvent(e.type,this._map,e))}touchstart(e){return this._firePreventable(new MapTouchEvent(e.type,this._map,e))}touchmove(e){this._map.fire(new MapTouchEvent(e.type,this._map,e))}touchend(e){this._map.fire(new MapTouchEvent(e.type,this._map,e))}touchcancel(e){this._map.fire(new MapTouchEvent(e.type,this._map,e))}_firePreventable(mapEvent){this._map.fire(mapEvent);if(mapEvent.defaultPrevented){return{}}}isEnabled(){return true}isActive(){return false}enable(){}disable(){}}class BlockableMapEventHandler{constructor(map){this._map=map}reset(){this._delayContextMenu=false;this._ignoreContextMenu=true;delete this._contextMenuEvent}mousemove(e){this._map.fire(new MapMouseEvent(e.type,this._map,e))}mousedown(){this._delayContextMenu=true;this._ignoreContextMenu=false}mouseup(){this._delayContextMenu=false;if(this._contextMenuEvent){this._map.fire(new MapMouseEvent("contextmenu",this._map,this._contextMenuEvent));delete this._contextMenuEvent}}contextmenu(e){if(this._delayContextMenu){this._contextMenuEvent=e}else if(!this._ignoreContextMenu){this._map.fire(new MapMouseEvent(e.type,this._map,e))}if(this._map.listens("contextmenu")){e.preventDefault()}}isEnabled(){return true}isActive(){return false}enable(){}disable(){}}class TransformProvider{constructor(map){this._map=map}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(point){return this.transform.pointLocation(performance$1.Point.convert(point),this._map.terrain)}}class BoxZoomHandler{constructor(map,options){this._map=map;this._tr=new TransformProvider(map);this._el=map.getCanvasContainer();this._container=map.getContainer();this._clickTolerance=options.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){if(this.isEnabled())return;this._enabled=true}disable(){if(!this.isEnabled())return;this._enabled=false}mousedown(e,point){if(!this.isEnabled())return;if(!(e.shiftKey&&e.button===0))return;DOM.disableDrag();this._startPos=this._lastPos=point;this._active=true}mousemoveWindow(e,point){if(!this._active)return;const pos=point;if(this._lastPos.equals(pos)||!this._box&&pos.dist(this._startPos)<this._clickTolerance){return}const p0=this._startPos;this._lastPos=pos;if(!this._box){this._box=DOM.create("div","maplibregl-boxzoom",this._container);this._container.classList.add("maplibregl-crosshair");this._fireEvent("boxzoomstart",e)}const minX=Math.min(p0.x,pos.x),maxX=Math.max(p0.x,pos.x),minY=Math.min(p0.y,pos.y),maxY=Math.max(p0.y,pos.y);DOM.setTransform(this._box,`translate(${minX}px,${minY}px)`);this._box.style.width=`${maxX-minX}px`;this._box.style.height=`${maxY-minY}px`}mouseupWindow(e,point){if(!this._active)return;if(e.button!==0)return;const p0=this._startPos,p1=point;this.reset();DOM.suppressClick();if(p0.x===p1.x&&p0.y===p1.y){this._fireEvent("boxzoomcancel",e)}else{this._map.fire(new performance$1.Event("boxzoomend",{originalEvent:e}));return{cameraAnimation:map=>map.fitScreenCoordinates(p0,p1,this._tr.bearing,{linear:true})}}}keydown(e){if(!this._active)return;if(e.keyCode===27){this.reset();this._fireEvent("boxzoomcancel",e)}}reset(){this._active=false;this._container.classList.remove("maplibregl-crosshair");if(this._box){DOM.remove(this._box);this._box=null}DOM.enableDrag();delete this._startPos;delete this._lastPos}_fireEvent(type,e){return this._map.fire(new performance$1.Event(type,{originalEvent:e}))}}function indexTouches(touches,points){if(touches.length!==points.length)throw new Error(`The number of touches and points are not equal - touches ${touches.length}, points ${points.length}`);const obj={};for(let i=0;i<touches.length;i++){obj[touches[i].identifier]=points[i]}return obj}function getCentroid(points){const sum=new performance$1.Point(0,0);for(const point of points){sum._add(point)}return sum.div(points.length)}const MAX_TAP_INTERVAL=500;const MAX_TOUCH_TIME=500;const MAX_DIST=30;class SingleTapRecognizer{constructor(options){this.reset();this.numTouches=options.numTouches}reset(){delete this.centroid;delete this.startTime;delete this.touches;this.aborted=false}touchstart(e,points,mapTouches){if(this.centroid||mapTouches.length>this.numTouches){this.aborted=true}if(this.aborted){return}if(this.startTime===undefined){this.startTime=e.timeStamp}if(mapTouches.length===this.numTouches){this.centroid=getCentroid(points);this.touches=indexTouches(mapTouches,points)}}touchmove(e,points,mapTouches){if(this.aborted||!this.centroid)return;const newTouches=indexTouches(mapTouches,points);for(const id in this.touches){const prevPos=this.touches[id];const pos=newTouches[id];if(!pos||pos.dist(prevPos)>MAX_DIST){this.aborted=true}}}touchend(e,points,mapTouches){if(!this.centroid||e.timeStamp-this.startTime>MAX_TOUCH_TIME){this.aborted=true}if(mapTouches.length===0){const centroid=!this.aborted&&this.centroid;this.reset();if(centroid)return centroid}}}class TapRecognizer{constructor(options){this.singleTap=new SingleTapRecognizer(options);this.numTaps=options.numTaps;this.reset()}reset(){this.lastTime=Infinity;delete this.lastTap;this.count=0;this.singleTap.reset()}touchstart(e,points,mapTouches){this.singleTap.touchstart(e,points,mapTouches)}touchmove(e,points,mapTouches){this.singleTap.touchmove(e,points,mapTouches)}touchend(e,points,mapTouches){const tap=this.singleTap.touchend(e,points,mapTouches);if(tap){const soonEnough=e.timeStamp-this.lastTime<MAX_TAP_INTERVAL;const closeEnough=!this.lastTap||this.lastTap.dist(tap)<MAX_DIST;if(!soonEnough||!closeEnough){this.reset()}this.count++;this.lastTime=e.timeStamp;this.lastTap=tap;if(this.count===this.numTaps){this.reset();return tap}}}}class TapZoomHandler{constructor(map){this._tr=new TransformProvider(map);this._zoomIn=new TapRecognizer({numTouches:1,numTaps:2});this._zoomOut=new TapRecognizer({numTouches:2,numTaps:1});this.reset()}reset(){this._active=false;this._zoomIn.reset();this._zoomOut.reset()}touchstart(e,points,mapTouches){this._zoomIn.touchstart(e,points,mapTouches);this._zoomOut.touchstart(e,points,mapTouches)}touchmove(e,points,mapTouches){this._zoomIn.touchmove(e,points,mapTouches);this._zoomOut.touchmove(e,points,mapTouches)}touchend(e,points,mapTouches){const zoomInPoint=this._zoomIn.touchend(e,points,mapTouches);const zoomOutPoint=this._zoomOut.touchend(e,points,mapTouches);const tr=this._tr;if(zoomInPoint){this._active=true;e.preventDefault();setTimeout((()=>this.reset()),0);return{cameraAnimation:map=>map.easeTo({duration:300,zoom:tr.zoom+1,around:tr.unproject(zoomInPoint)},{originalEvent:e})}}else if(zoomOutPoint){this._active=true;e.preventDefault();setTimeout((()=>this.reset()),0);return{cameraAnimation:map=>map.easeTo({duration:300,zoom:tr.zoom-1,around:tr.unproject(zoomOutPoint)},{originalEvent:e})}}}touchcancel(){this.reset()}enable(){this._enabled=true}disable(){this._enabled=false;this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class DragHandler{constructor(options){this._enabled=!!options.enable;this._moveStateManager=options.moveStateManager;this._clickTolerance=options.clickTolerance||1;this._moveFunction=options.move;this._activateOnStart=!!options.activateOnStart;options.assignEvents(this);this.reset()}reset(e){this._active=false;this._moved=false;delete this._lastPoint;this._moveStateManager.endMove(e)}_move(...params){const move=this._moveFunction(...params);if(move.bearingDelta||move.pitchDelta||move.around||move.panDelta){this._active=true;return move}}dragStart(e,point){if(!this.isEnabled()||this._lastPoint)return;if(!this._moveStateManager.isValidStartEvent(e))return;this._moveStateManager.startMove(e);this._lastPoint=point["length"]?point[0]:point;if(this._activateOnStart&&this._lastPoint)this._active=true}dragMove(e,point){if(!this.isEnabled())return;const lastPoint=this._lastPoint;if(!lastPoint)return;e.preventDefault();if(!this._moveStateManager.isValidMoveEvent(e)){this.reset(e);return}const movePoint=point["length"]?point[0]:point;if(!this._moved&&movePoint.dist(lastPoint)<this._clickTolerance)return;this._moved=true;this._lastPoint=movePoint;return this._move(lastPoint,movePoint)}dragEnd(e){if(!this.isEnabled()||!this._lastPoint)return;if(!this._moveStateManager.isValidEndEvent(e))return;if(this._moved)DOM.suppressClick();this.reset(e)}enable(){this._enabled=true}disable(){this._enabled=false;this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const LEFT_BUTTON$1=0;const RIGHT_BUTTON$1=2;const BUTTONS_FLAGS={[LEFT_BUTTON$1]:1,[RIGHT_BUTTON$1]:2};function buttonNoLongerPressed(e,button){const flag=BUTTONS_FLAGS[button];return e.buttons===undefined||(e.buttons&flag)!==flag}class MouseMoveStateManager{constructor(options){this._correctEvent=options.checkCorrectEvent}startMove(e){const eventButton=DOM.mouseButton(e);this._eventButton=eventButton}endMove(_e){delete this._eventButton}isValidStartEvent(e){return this._correctEvent(e)}isValidMoveEvent(e){return!buttonNoLongerPressed(e,this._eventButton)}isValidEndEvent(e){const eventButton=DOM.mouseButton(e);return eventButton===this._eventButton}}class OneFingerTouchMoveStateManager{constructor(){this._firstTouch=undefined}_isOneFingerTouch(e){return e.targetTouches.length===1}_isSameTouchEvent(e){return e.targetTouches[0].identifier===this._firstTouch}startMove(e){const firstTouch=e.targetTouches[0].identifier;this._firstTouch=firstTouch}endMove(_e){delete this._firstTouch}isValidStartEvent(e){return this._isOneFingerTouch(e)}isValidMoveEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}isValidEndEvent(e){return this._isOneFingerTouch(e)&&this._isSameTouchEvent(e)}}const LEFT_BUTTON=0;const RIGHT_BUTTON=2;const assignEvents$1=handler=>{handler.mousedown=handler.dragStart;handler.mousemoveWindow=handler.dragMove;handler.mouseup=handler.dragEnd;handler.contextmenu=function(e){e.preventDefault()}};const generateMousePanHandler=({enable:enable,clickTolerance:clickTolerance})=>{const mouseMoveStateManager=new MouseMoveStateManager({checkCorrectEvent:e=>DOM.mouseButton(e)===LEFT_BUTTON&&!e.ctrlKey});return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({around:point,panDelta:point.sub(lastPoint)}),activateOnStart:true,moveStateManager:mouseMoveStateManager,enable:enable,assignEvents:assignEvents$1})};const generateMouseRotationHandler=({enable:enable,clickTolerance:clickTolerance,bearingDegreesPerPixelMoved:bearingDegreesPerPixelMoved=.8})=>{const mouseMoveStateManager=new MouseMoveStateManager({checkCorrectEvent:e=>DOM.mouseButton(e)===LEFT_BUTTON&&e.ctrlKey||DOM.mouseButton(e)===RIGHT_BUTTON});return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({bearingDelta:(point.x-lastPoint.x)*bearingDegreesPerPixelMoved}),moveStateManager:mouseMoveStateManager,enable:enable,assignEvents:assignEvents$1})};const generateMousePitchHandler=({enable:enable,clickTolerance:clickTolerance,pitchDegreesPerPixelMoved:pitchDegreesPerPixelMoved=-.5})=>{const mouseMoveStateManager=new MouseMoveStateManager({checkCorrectEvent:e=>DOM.mouseButton(e)===LEFT_BUTTON&&e.ctrlKey||DOM.mouseButton(e)===RIGHT_BUTTON});return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({pitchDelta:(point.y-lastPoint.y)*pitchDegreesPerPixelMoved}),moveStateManager:mouseMoveStateManager,enable:enable,assignEvents:assignEvents$1})};class TouchPanHandler{constructor(options,map){this._clickTolerance=options.clickTolerance||1;this._map=map;this.reset()}reset(){this._active=false;this._touches={};this._sum=new performance$1.Point(0,0)}minTouchs(){return this._map.cooperativeGestures.isEnabled()?2:1}touchstart(e,points,mapTouches){return this._calculateTransform(e,points,mapTouches)}touchmove(e,points,mapTouches){if(!this._active||mapTouches.length<this.minTouchs())return;e.preventDefault();return this._calculateTransform(e,points,mapTouches)}touchend(e,points,mapTouches){this._calculateTransform(e,points,mapTouches);if(this._active&&mapTouches.length<this.minTouchs()){this.reset()}}touchcancel(){this.reset()}_calculateTransform(e,points,mapTouches){if(mapTouches.length>0)this._active=true;const touches=indexTouches(mapTouches,points);const touchPointSum=new performance$1.Point(0,0);const touchDeltaSum=new performance$1.Point(0,0);let touchDeltaCount=0;for(const identifier in touches){const point=touches[identifier];const prevPoint=this._touches[identifier];if(prevPoint){touchPointSum._add(point);touchDeltaSum._add(point.sub(prevPoint));touchDeltaCount++;touches[identifier]=point}}this._touches=touches;if(touchDeltaCount<this.minTouchs()||!touchDeltaSum.mag())return;const panDelta=touchDeltaSum.div(touchDeltaCount);this._sum._add(panDelta);if(this._sum.mag()<this._clickTolerance)return;const around=touchPointSum.div(touchDeltaCount);return{around:around,panDelta:panDelta}}enable(){this._enabled=true}disable(){this._enabled=false;this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class TwoFingersTouchHandler{constructor(){this.reset()}reset(){this._active=false;delete this._firstTwoTouches}touchstart(e,points,mapTouches){if(this._firstTwoTouches||mapTouches.length<2)return;this._firstTwoTouches=[mapTouches[0].identifier,mapTouches[1].identifier];this._start([points[0],points[1]])}touchmove(e,points,mapTouches){if(!this._firstTwoTouches)return;e.preventDefault();const[idA,idB]=this._firstTwoTouches;const a=getTouchById(mapTouches,points,idA);const b=getTouchById(mapTouches,points,idB);if(!a||!b)return;const pinchAround=this._aroundCenter?null:a.add(b).div(2);return this._move([a,b],pinchAround,e)}touchend(e,points,mapTouches){if(!this._firstTwoTouches)return;const[idA,idB]=this._firstTwoTouches;const a=getTouchById(mapTouches,points,idA);const b=getTouchById(mapTouches,points,idB);if(a&&b)return;if(this._active)DOM.suppressClick();this.reset()}touchcancel(){this.reset()}enable(options){this._enabled=true;this._aroundCenter=!!options&&options.around==="center"}disable(){this._enabled=false;this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function getTouchById(mapTouches,points,identifier){for(let i=0;i<mapTouches.length;i++){if(mapTouches[i].identifier===identifier)return points[i]}return undefined}const ZOOM_THRESHOLD=.1;function getZoomDelta(distance,lastDistance){return Math.log(distance/lastDistance)/Math.LN2}class TwoFingersTouchZoomHandler extends TwoFingersTouchHandler{reset(){super.reset();delete this._distance;delete this._startDistance}_start(points){this._startDistance=this._distance=points[0].dist(points[1])}_move(points,pinchAround){const lastDistance=this._distance;this._distance=points[0].dist(points[1]);if(!this._active&&Math.abs(getZoomDelta(this._distance,this._startDistance))<ZOOM_THRESHOLD)return;this._active=true;return{zoomDelta:getZoomDelta(this._distance,lastDistance),pinchAround:pinchAround}}}const ROTATION_THRESHOLD=25;function getBearingDelta(a,b){return a.angleWith(b)*180/Math.PI}class TwoFingersTouchRotateHandler extends TwoFingersTouchHandler{reset(){super.reset();delete this._minDiameter;delete this._startVector;delete this._vector}_start(points){this._startVector=this._vector=points[0].sub(points[1]);this._minDiameter=points[0].dist(points[1])}_move(points,pinchAround,_e){const lastVector=this._vector;this._vector=points[0].sub(points[1]);if(!this._active&&this._isBelowThreshold(this._vector))return;this._active=true;return{bearingDelta:getBearingDelta(this._vector,lastVector),pinchAround:pinchAround}}_isBelowThreshold(vector){this._minDiameter=Math.min(this._minDiameter,vector.mag());const circumference=Math.PI*this._minDiameter;const threshold=ROTATION_THRESHOLD/circumference*360;const bearingDeltaSinceStart=getBearingDelta(vector,this._startVector);return Math.abs(bearingDeltaSinceStart)<threshold}}function isVertical(vector){return Math.abs(vector.y)>Math.abs(vector.x)}const ALLOWED_SINGLE_TOUCH_TIME=100;class TwoFingersTouchPitchHandler extends TwoFingersTouchHandler{constructor(map){super();this._currentTouchCount=0;this._map=map}reset(){super.reset();this._valid=undefined;delete this._firstMove;delete this._lastPoints}touchstart(e,points,mapTouches){super.touchstart(e,points,mapTouches);this._currentTouchCount=mapTouches.length}_start(points){this._lastPoints=points;if(isVertical(points[0].sub(points[1]))){this._valid=false}}_move(points,center,e){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3){return}const vectorA=points[0].sub(this._lastPoints[0]);const vectorB=points[1].sub(this._lastPoints[1]);this._valid=this.gestureBeginsVertically(vectorA,vectorB,e.timeStamp);if(!this._valid)return;this._lastPoints=points;this._active=true;const yDeltaAverage=(vectorA.y+vectorB.y)/2;const degreesPerPixelMoved=-.5;return{pitchDelta:yDeltaAverage*degreesPerPixelMoved}}gestureBeginsVertically(vectorA,vectorB,timeStamp){if(this._valid!==undefined)return this._valid;const threshold=2;const movedA=vectorA.mag()>=threshold;const movedB=vectorB.mag()>=threshold;if(!movedA&&!movedB)return;if(!movedA||!movedB){if(this._firstMove===undefined){this._firstMove=timeStamp}if(timeStamp-this._firstMove<ALLOWED_SINGLE_TOUCH_TIME){return undefined}else{return false}}const isSameDirection=vectorA.y>0===vectorB.y>0;return isVertical(vectorA)&&isVertical(vectorB)&&isSameDirection}}const defaultOptions$5={panStep:100,bearingStep:15,pitchStep:10};class KeyboardHandler{constructor(map){this._tr=new TransformProvider(map);const stepOptions=defaultOptions$5;this._panStep=stepOptions.panStep;this._bearingStep=stepOptions.bearingStep;this._pitchStep=stepOptions.pitchStep;this._rotationDisabled=false}reset(){this._active=false}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let zoomDir=0;let bearingDir=0;let pitchDir=0;let xDir=0;let yDir=0;switch(e.keyCode){case 61:case 107:case 171:case 187:zoomDir=1;break;case 189:case 109:case 173:zoomDir=-1;break;case 37:if(e.shiftKey){bearingDir=-1}else{e.preventDefault();xDir=-1}break;case 39:if(e.shiftKey){bearingDir=1}else{e.preventDefault();xDir=1}break;case 38:if(e.shiftKey){pitchDir=1}else{e.preventDefault();yDir=-1}break;case 40:if(e.shiftKey){pitchDir=-1}else{e.preventDefault();yDir=1}break;default:return}if(this._rotationDisabled){bearingDir=0;pitchDir=0}return{cameraAnimation:map=>{const tr=this._tr;map.easeTo({duration:300,easeId:"keyboardHandler",easing:easeOut,zoom:zoomDir?Math.round(tr.zoom)+zoomDir*(e.shiftKey?2:1):tr.zoom,bearing:tr.bearing+bearingDir*this._bearingStep,pitch:tr.pitch+pitchDir*this._pitchStep,offset:[-xDir*this._panStep,-yDir*this._panStep],center:tr.center},{originalEvent:e})}}}enable(){this._enabled=true}disable(){this._enabled=false;this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=true}enableRotation(){this._rotationDisabled=false}}function easeOut(t){return t*(2-t)}const wheelZoomDelta=4.000244140625;const defaultZoomRate=1/100;const wheelZoomRate=1/450;const maxScalePerFrame=2;class ScrollZoomHandler{constructor(map,triggerRenderFrame){this._onTimeout=initialEvent=>{this._type="wheel";this._delta-=this._lastValue;if(!this._active){this._start(initialEvent)}};this._map=map;this._tr=new TransformProvider(map);this._triggerRenderFrame=triggerRenderFrame;this._delta=0;this._defaultZoomRate=defaultZoomRate;this._wheelZoomRate=wheelZoomRate}setZoomRate(zoomRate){this._defaultZoomRate=zoomRate}setWheelZoomRate(wheelZoomRate){this._wheelZoomRate=wheelZoomRate}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==undefined}isZooming(){return!!this._zooming}enable(options){if(this.isEnabled())return;this._enabled=true;this._aroundCenter=!!options&&options.around==="center"}disable(){if(!this.isEnabled())return;this._enabled=false}wheel(e){if(!this.isEnabled())return;if(this._map.cooperativeGestures.isEnabled()&&!e[this._map.cooperativeGestures._bypassKey]){return}let value=e.deltaMode===WheelEvent.DOM_DELTA_LINE?e.deltaY*40:e.deltaY;const now=browser.now(),timeDelta=now-(this._lastWheelEventTime||0);this._lastWheelEventTime=now;if(value!==0&&value%wheelZoomDelta===0){this._type="wheel"}else if(value!==0&&Math.abs(value)<4){this._type="trackpad"}else if(timeDelta>400){this._type=null;this._lastValue=value;this._timeout=setTimeout(this._onTimeout,40,e)}else if(!this._type){this._type=Math.abs(timeDelta*value)<200?"trackpad":"wheel";if(this._timeout){clearTimeout(this._timeout);this._timeout=null;value+=this._lastValue}}if(e.shiftKey&&value)value=value/4;if(this._type){this._lastWheelEvent=e;this._delta-=value;if(!this._active){this._start(e)}}e.preventDefault()}_start(e){if(!this._delta)return;if(this._frameId){this._frameId=null}this._active=true;if(!this.isZooming()){this._zooming=true}if(this._finishTimeout){clearTimeout(this._finishTimeout);delete this._finishTimeout}const pos=DOM.mousePos(this._map.getCanvas(),e);const tr=this._tr;if(pos.y>tr.transform.height/2-tr.transform.getHorizon()){this._around=performance$1.LngLat.convert(this._aroundCenter?tr.center:tr.unproject(pos))}else{this._around=performance$1.LngLat.convert(tr.center)}this._aroundPoint=tr.transform.locationPoint(this._around);if(!this._frameId){this._frameId=true;this._triggerRenderFrame()}}renderFrame(){if(!this._frameId)return;this._frameId=null;if(!this.isActive())return;const tr=this._tr.transform;if(this._delta!==0){const zoomRate=this._type==="wheel"&&Math.abs(this._delta)>wheelZoomDelta?this._wheelZoomRate:this._defaultZoomRate;let scale=maxScalePerFrame/(1+Math.exp(-Math.abs(this._delta*zoomRate)));if(this._delta<0&&scale!==0){scale=1/scale}const fromScale=typeof this._targetZoom==="number"?tr.zoomScale(this._targetZoom):tr.scale;this._targetZoom=Math.min(tr.maxZoom,Math.max(tr.minZoom,tr.scaleZoom(fromScale*scale)));if(this._type==="wheel"){this._startZoom=tr.zoom;this._easing=this._smoothOutEasing(200)}this._delta=0}const targetZoom=typeof this._targetZoom==="number"?this._targetZoom:tr.zoom;const startZoom=this._startZoom;const easing=this._easing;let finished=false;let zoom;if(this._type==="wheel"&&startZoom&&easing){const t=Math.min((browser.now()-this._lastWheelEventTime)/200,1);const k=easing(t);zoom=performance$1.interpolate.number(startZoom,targetZoom,k);if(t<1){if(!this._frameId){this._frameId=true}}else{finished=true}}else{zoom=targetZoom;finished=true}this._active=true;if(finished){this._active=false;this._finishTimeout=setTimeout((()=>{this._zooming=false;this._triggerRenderFrame();delete this._targetZoom;delete this._finishTimeout}),200)}return{noInertia:true,needsRenderFrame:!finished,zoomDelta:zoom-tr.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(duration){let easing=performance$1.defaultEasing;if(this._prevEase){const currentEase=this._prevEase;const t=(browser.now()-currentEase.start)/currentEase.duration;const speed=currentEase.easing(t+.01)-currentEase.easing(t);const x=.27/Math.sqrt(speed*speed+1e-4)*.01;const y=Math.sqrt(.27*.27-x*x);easing=performance$1.bezier(x,y,.25,1)}this._prevEase={start:browser.now(),duration:duration,easing:easing};return easing}reset(){this._active=false;this._zooming=false;delete this._targetZoom;if(this._finishTimeout){clearTimeout(this._finishTimeout);delete this._finishTimeout}}}class DoubleClickZoomHandler{constructor(clickZoom,TapZoom){this._clickZoom=clickZoom;this._tapZoom=TapZoom}enable(){this._clickZoom.enable();this._tapZoom.enable()}disable(){this._clickZoom.disable();this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class ClickZoomHandler{constructor(map){this._tr=new TransformProvider(map);this.reset()}reset(){this._active=false}dblclick(e,point){e.preventDefault();return{cameraAnimation:map=>{map.easeTo({duration:300,zoom:this._tr.zoom+(e.shiftKey?-1:1),around:this._tr.unproject(point)},{originalEvent:e})}}}enable(){this._enabled=true}disable(){this._enabled=false;this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class TapDragZoomHandler{constructor(){this._tap=new TapRecognizer({numTouches:1,numTaps:1});this.reset()}reset(){this._active=false;delete this._swipePoint;delete this._swipeTouch;delete this._tapTime;delete this._tapPoint;this._tap.reset()}touchstart(e,points,mapTouches){if(this._swipePoint)return;if(!this._tapTime){this._tap.touchstart(e,points,mapTouches)}else{const swipePoint=points[0];const soonEnough=e.timeStamp-this._tapTime<MAX_TAP_INTERVAL;const closeEnough=this._tapPoint.dist(swipePoint)<MAX_DIST;if(!soonEnough||!closeEnough){this.reset()}else if(mapTouches.length>0){this._swipePoint=swipePoint;this._swipeTouch=mapTouches[0].identifier}}}touchmove(e,points,mapTouches){if(!this._tapTime){this._tap.touchmove(e,points,mapTouches)}else if(this._swipePoint){if(mapTouches[0].identifier!==this._swipeTouch){return}const newSwipePoint=points[0];const dist=newSwipePoint.y-this._swipePoint.y;this._swipePoint=newSwipePoint;e.preventDefault();this._active=true;return{zoomDelta:dist/128}}}touchend(e,points,mapTouches){if(!this._tapTime){const point=this._tap.touchend(e,points,mapTouches);if(point){this._tapTime=e.timeStamp;this._tapPoint=point}}else if(this._swipePoint){if(mapTouches.length===0){this.reset()}}}touchcancel(){this.reset()}enable(){this._enabled=true}disable(){this._enabled=false;this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class DragPanHandler{constructor(el,mousePan,touchPan){this._el=el;this._mousePan=mousePan;this._touchPan=touchPan}enable(options){this._inertiaOptions=options||{};this._mousePan.enable();this._touchPan.enable();this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable();this._touchPan.disable();this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class DragRotateHandler{constructor(options,mouseRotate,mousePitch){this._pitchWithRotate=options.pitchWithRotate;this._mouseRotate=mouseRotate;this._mousePitch=mousePitch}enable(){this._mouseRotate.enable();if(this._pitchWithRotate)this._mousePitch.enable()}disable(){this._mouseRotate.disable();this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class TwoFingersTouchZoomRotateHandler{constructor(el,touchZoom,touchRotate,tapDragZoom){this._el=el;this._touchZoom=touchZoom;this._touchRotate=touchRotate;this._tapDragZoom=tapDragZoom;this._rotationDisabled=false;this._enabled=true}enable(options){this._touchZoom.enable(options);if(!this._rotationDisabled)this._touchRotate.enable(options);this._tapDragZoom.enable();this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable();this._touchRotate.disable();this._tapDragZoom.disable();this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=true;this._touchRotate.disable()}enableRotation(){this._rotationDisabled=false;if(this._touchZoom.isEnabled())this._touchRotate.enable()}}class CooperativeGesturesHandler{constructor(map,options){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey";this._map=map;this._options=options;this._enabled=false}isActive(){return false}reset(){}_setupUI(){if(this._container)return;const mapCanvasContainer=this._map.getCanvasContainer();mapCanvasContainer.classList.add("maplibregl-cooperative-gestures");this._container=DOM.create("div","maplibregl-cooperative-gesture-screen",mapCanvasContainer);let desktopMessage=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");if(this._bypassKey==="metaKey"){desktopMessage=this._map._getUIString("CooperativeGesturesHandler.MacHelpText")}const mobileMessage=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText");const desktopDiv=document.createElement("div");desktopDiv.className="maplibregl-desktop-message";desktopDiv.textContent=desktopMessage;this._container.appendChild(desktopDiv);const mobileDiv=document.createElement("div");mobileDiv.className="maplibregl-mobile-message";mobileDiv.textContent=mobileMessage;this._container.appendChild(mobileDiv);this._container.setAttribute("aria-hidden","true")}_destoryUI(){if(this._container){DOM.remove(this._container);const mapCanvasContainer=this._map.getCanvasContainer();mapCanvasContainer.classList.remove("maplibregl-cooperative-gestures")}delete this._container}enable(){this._setupUI();this._enabled=true}disable(){this._enabled=false;this._destoryUI()}isEnabled(){return this._enabled}touchmove(e){this._onCooperativeGesture(e.touches.length===1)}wheel(e){if(!this._map.scrollZoom.isEnabled()){return}this._onCooperativeGesture(!e[this._bypassKey])}_onCooperativeGesture(showNotification){if(!this._enabled||!showNotification)return;this._container.classList.add("maplibregl-show");setTimeout((()=>{this._container.classList.remove("maplibregl-show")}),100)}}const isMoving=p=>p.zoom||p.drag||p.pitch||p.rotate;class RenderFrameEvent extends performance$1.Event{}function hasChange(result){return result.panDelta&&result.panDelta.mag()||result.zoomDelta||result.bearingDelta||result.pitchDelta}class HandlerManager{constructor(map,options){this.handleWindowEvent=e=>{this.handleEvent(e,`${e.type}Window`)};this.handleEvent=(e,eventName)=>{if(e.type==="blur"){this.stop(true);return}this._updatingCamera=true;const inputEvent=e.type==="renderFrame"?undefined:e;const mergedHandlerResult={needsRenderFrame:false};const eventsInProgress={};const activeHandlers={};const eventTouches=e.touches;const mapTouches=eventTouches?this._getMapTouches(eventTouches):undefined;const points=mapTouches?DOM.touchPos(this._map.getCanvas(),mapTouches):DOM.mousePos(this._map.getCanvas(),e);for(const{handlerName:handlerName,handler:handler,allowed:allowed}of this._handlers){if(!handler.isEnabled())continue;let data;if(this._blockedByActive(activeHandlers,allowed,handlerName)){handler.reset()}else{if(handler[eventName||e.type]){data=handler[eventName||e.type](e,points,mapTouches);this.mergeHandlerResult(mergedHandlerResult,eventsInProgress,data,handlerName,inputEvent);if(data&&data.needsRenderFrame){this._triggerRenderFrame()}}}if(data||handler.isActive()){activeHandlers[handlerName]=handler}}const deactivatedHandlers={};for(const name in this._previousActiveHandlers){if(!activeHandlers[name]){deactivatedHandlers[name]=inputEvent}}this._previousActiveHandlers=activeHandlers;if(Object.keys(deactivatedHandlers).length||hasChange(mergedHandlerResult)){this._changes.push([mergedHandlerResult,eventsInProgress,deactivatedHandlers]);this._triggerRenderFrame()}if(Object.keys(activeHandlers).length||hasChange(mergedHandlerResult)){this._map._stop(true)}this._updatingCamera=false;const{cameraAnimation:cameraAnimation}=mergedHandlerResult;if(cameraAnimation){this._inertia.clear();this._fireEvents({},{},true);this._changes=[];cameraAnimation(this._map)}};this._map=map;this._el=this._map.getCanvasContainer();this._handlers=[];this._handlersById={};this._changes=[];this._inertia=new HandlerInertia(map);this._bearingSnap=options.bearingSnap;this._previousActiveHandlers={};this._eventsInProgress={};this._addDefaultHandlers(options);const el=this._el;this._listeners=[[el,"touchstart",{passive:true}],[el,"touchmove",{passive:false}],[el,"touchend",undefined],[el,"touchcancel",undefined],[el,"mousedown",undefined],[el,"mousemove",undefined],[el,"mouseup",undefined],[document,"mousemove",{capture:true}],[document,"mouseup",undefined],[el,"mouseover",undefined],[el,"mouseout",undefined],[el,"dblclick",undefined],[el,"click",undefined],[el,"keydown",{capture:false}],[el,"keyup",undefined],[el,"wheel",{passive:false}],[el,"contextmenu",undefined],[window,"blur",undefined]];for(const[target,type,listenerOptions]of this._listeners){DOM.addEventListener(target,type,target===document?this.handleWindowEvent:this.handleEvent,listenerOptions)}}destroy(){for(const[target,type,listenerOptions]of this._listeners){DOM.removeEventListener(target,type,target===document?this.handleWindowEvent:this.handleEvent,listenerOptions)}}_addDefaultHandlers(options){const map=this._map;const el=map.getCanvasContainer();this._add("mapEvent",new MapEventHandler(map,options));const boxZoom=map.boxZoom=new BoxZoomHandler(map,options);this._add("boxZoom",boxZoom);if(options.interactive&&options.boxZoom){boxZoom.enable()}const cooperativeGestures=map.cooperativeGestures=new CooperativeGesturesHandler(map,options.cooperativeGestures);this._add("cooperativeGestures",cooperativeGestures);if(options.cooperativeGestures){cooperativeGestures.enable()}const tapZoom=new TapZoomHandler(map);const clickZoom=new ClickZoomHandler(map);map.doubleClickZoom=new DoubleClickZoomHandler(clickZoom,tapZoom);this._add("tapZoom",tapZoom);this._add("clickZoom",clickZoom);if(options.interactive&&options.doubleClickZoom){map.doubleClickZoom.enable()}const tapDragZoom=new TapDragZoomHandler;this._add("tapDragZoom",tapDragZoom);const touchPitch=map.touchPitch=new TwoFingersTouchPitchHandler(map);this._add("touchPitch",touchPitch);if(options.interactive&&options.touchPitch){map.touchPitch.enable(options.touchPitch)}const mouseRotate=generateMouseRotationHandler(options);const mousePitch=generateMousePitchHandler(options);map.dragRotate=new DragRotateHandler(options,mouseRotate,mousePitch);this._add("mouseRotate",mouseRotate,["mousePitch"]);this._add("mousePitch",mousePitch,["mouseRotate"]);if(options.interactive&&options.dragRotate){map.dragRotate.enable()}const mousePan=generateMousePanHandler(options);const touchPan=new TouchPanHandler(options,map);map.dragPan=new DragPanHandler(el,mousePan,touchPan);this._add("mousePan",mousePan);this._add("touchPan",touchPan,["touchZoom","touchRotate"]);if(options.interactive&&options.dragPan){map.dragPan.enable(options.dragPan)}const touchRotate=new TwoFingersTouchRotateHandler;const touchZoom=new TwoFingersTouchZoomHandler;map.touchZoomRotate=new TwoFingersTouchZoomRotateHandler(el,touchZoom,touchRotate,tapDragZoom);this._add("touchRotate",touchRotate,["touchPan","touchZoom"]);this._add("touchZoom",touchZoom,["touchPan","touchRotate"]);if(options.interactive&&options.touchZoomRotate){map.touchZoomRotate.enable(options.touchZoomRotate)}const scrollZoom=map.scrollZoom=new ScrollZoomHandler(map,(()=>this._triggerRenderFrame()));this._add("scrollZoom",scrollZoom,["mousePan"]);if(options.interactive&&options.scrollZoom){map.scrollZoom.enable(options.scrollZoom)}const keyboard=map.keyboard=new KeyboardHandler(map);this._add("keyboard",keyboard);if(options.interactive&&options.keyboard){map.keyboard.enable()}this._add("blockableMapEvent",new BlockableMapEventHandler(map))}_add(handlerName,handler,allowed){this._handlers.push({handlerName:handlerName,handler:handler,allowed:allowed});this._handlersById[handlerName]=handler}stop(allowEndAnimation){if(this._updatingCamera)return;for(const{handler:handler}of this._handlers){handler.reset()}this._inertia.clear();this._fireEvents({},{},allowEndAnimation);this._changes=[]}isActive(){for(const{handler:handler}of this._handlers){if(handler.isActive())return true}return false}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return Boolean(isMoving(this._eventsInProgress))||this.isZooming()}_blockedByActive(activeHandlers,allowed,myName){for(const name in activeHandlers){if(name===myName)continue;if(!allowed||allowed.indexOf(name)<0){return true}}return false}_getMapTouches(touches){const mapTouches=[];for(const t of touches){const target=t.target;if(this._el.contains(target)){mapTouches.push(t)}}return mapTouches}mergeHandlerResult(mergedHandlerResult,eventsInProgress,handlerResult,name,e){if(!handlerResult)return;performance$1.extend(mergedHandlerResult,handlerResult);const eventData={handlerName:name,originalEvent:handlerResult.originalEvent||e};if(handlerResult.zoomDelta!==undefined){eventsInProgress.zoom=eventData}if(handlerResult.panDelta!==undefined){eventsInProgress.drag=eventData}if(handlerResult.pitchDelta!==undefined){eventsInProgress.pitch=eventData}if(handlerResult.bearingDelta!==undefined){eventsInProgress.rotate=eventData}}_applyChanges(){const combined={};const combinedEventsInProgress={};const combinedDeactivatedHandlers={};for(const[change,eventsInProgress,deactivatedHandlers]of this._changes){if(change.panDelta)combined.panDelta=(combined.panDelta||new performance$1.Point(0,0))._add(change.panDelta);if(change.zoomDelta)combined.zoomDelta=(combined.zoomDelta||0)+change.zoomDelta;if(change.bearingDelta)combined.bearingDelta=(combined.bearingDelta||0)+change.bearingDelta;if(change.pitchDelta)combined.pitchDelta=(combined.pitchDelta||0)+change.pitchDelta;if(change.around!==undefined)combined.around=change.around;if(change.pinchAround!==undefined)combined.pinchAround=change.pinchAround;if(change.noInertia)combined.noInertia=change.noInertia;performance$1.extend(combinedEventsInProgress,eventsInProgress);performance$1.extend(combinedDeactivatedHandlers,deactivatedHandlers)}this._updateMapTransform(combined,combinedEventsInProgress,combinedDeactivatedHandlers);this._changes=[]}_updateMapTransform(combinedResult,combinedEventsInProgress,deactivatedHandlers){const map=this._map;const tr=map._getTransformForUpdate();const terrain=map.terrain;if(!hasChange(combinedResult)&&!(terrain&&this._terrainMovement)){return this._fireEvents(combinedEventsInProgress,deactivatedHandlers,true)}let{panDelta:panDelta,zoomDelta:zoomDelta,bearingDelta:bearingDelta,pitchDelta:pitchDelta,around:around,pinchAround:pinchAround}=combinedResult;if(pinchAround!==undefined){around=pinchAround}map._stop(true);around=around||map.transform.centerPoint;const loc=tr.pointLocation(panDelta?around.sub(panDelta):around);if(bearingDelta)tr.bearing+=bearingDelta;if(pitchDelta)tr.pitch+=pitchDelta;if(zoomDelta)tr.zoom+=zoomDelta;if(!terrain){tr.setLocationAtPoint(loc,around)}else{if(!this._terrainMovement&&(combinedEventsInProgress.drag||combinedEventsInProgress.zoom)){this._terrainMovement=true;this._map._elevationFreeze=true;tr.setLocationAtPoint(loc,around);this._map.once("moveend",(()=>{this._map._elevationFreeze=false;this._terrainMovement=false;tr.recalculateZoom(map.terrain)}))}else if(combinedEventsInProgress.drag&&this._terrainMovement){tr.center=tr.pointLocation(tr.centerPoint.sub(panDelta))}else{tr.setLocationAtPoint(loc,around)}}map._applyUpdatedTransform(tr);this._map._update();if(!combinedResult.noInertia)this._inertia.record(combinedResult);this._fireEvents(combinedEventsInProgress,deactivatedHandlers,true)}_fireEvents(newEventsInProgress,deactivatedHandlers,allowEndAnimation){const wasMoving=isMoving(this._eventsInProgress);const nowMoving=isMoving(newEventsInProgress);const startEvents={};for(const eventName in newEventsInProgress){const{originalEvent:originalEvent}=newEventsInProgress[eventName];if(!this._eventsInProgress[eventName]){startEvents[`${eventName}start`]=originalEvent}this._eventsInProgress[eventName]=newEventsInProgress[eventName]}if(!wasMoving&&nowMoving){this._fireEvent("movestart",nowMoving.originalEvent)}for(const name in startEvents){this._fireEvent(name,startEvents[name])}if(nowMoving){this._fireEvent("move",nowMoving.originalEvent)}for(const eventName in newEventsInProgress){const{originalEvent:originalEvent}=newEventsInProgress[eventName];this._fireEvent(eventName,originalEvent)}const endEvents={};let originalEndEvent;for(const eventName in this._eventsInProgress){const{handlerName:handlerName,originalEvent:originalEvent}=this._eventsInProgress[eventName];if(!this._handlersById[handlerName].isActive()){delete this._eventsInProgress[eventName];originalEndEvent=deactivatedHandlers[handlerName]||originalEvent;endEvents[`${eventName}end`]=originalEndEvent}}for(const name in endEvents){this._fireEvent(name,endEvents[name])}const stillMoving=isMoving(this._eventsInProgress);if(allowEndAnimation&&(wasMoving||nowMoving)&&!stillMoving){this._updatingCamera=true;const inertialEase=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions);const shouldSnapToNorth=bearing=>bearing!==0&&-this._bearingSnap<bearing&&bearing<this._bearingSnap;if(inertialEase&&(inertialEase.essential||!browser.prefersReducedMotion)){if(shouldSnapToNorth(inertialEase.bearing||this._map.getBearing())){inertialEase.bearing=0}inertialEase.freezeElevation=true;this._map.easeTo(inertialEase,{originalEvent:originalEndEvent})}else{this._map.fire(new performance$1.Event("moveend",{originalEvent:originalEndEvent}));if(shouldSnapToNorth(this._map.getBearing())){this._map.resetNorth()}}this._updatingCamera=false}}_fireEvent(type,e){this._map.fire(new performance$1.Event(type,e?{originalEvent:e}:{}))}_requestFrame(){this._map.triggerRepaint();return this._map._renderTaskQueue.add((timeStamp=>{delete this._frameId;this.handleEvent(new RenderFrameEvent("renderFrame",{timeStamp:timeStamp}));this._applyChanges()}))}_triggerRenderFrame(){if(this._frameId===undefined){this._frameId=this._requestFrame()}}}class Camera extends performance$1.Evented{constructor(transform,options){super();this._renderFrameCallback=()=>{const t=Math.min((browser.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(t));if(t<1&&this._easeFrameId){this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback)}else{this.stop()}};this._moving=false;this._zooming=false;this.transform=transform;this._bearingSnap=options.bearingSnap;this.on("moveend",(()=>{delete this._requestedCameraState}))}getCenter(){return new performance$1.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(center,eventData){return this.jumpTo({center:center},eventData)}panBy(offset,options,eventData){offset=performance$1.Point.convert(offset).mult(-1);return this.panTo(this.transform.center,performance$1.extend({offset:offset},options),eventData)}panTo(lnglat,options,eventData){return this.easeTo(performance$1.extend({center:lnglat},options),eventData)}getZoom(){return this.transform.zoom}setZoom(zoom,eventData){this.jumpTo({zoom:zoom},eventData);return this}zoomTo(zoom,options,eventData){return this.easeTo(performance$1.extend({zoom:zoom},options),eventData)}zoomIn(options,eventData){this.zoomTo(this.getZoom()+1,options,eventData);return this}zoomOut(options,eventData){this.zoomTo(this.getZoom()-1,options,eventData);return this}getBearing(){return this.transform.bearing}setBearing(bearing,eventData){this.jumpTo({bearing:bearing},eventData);return this}getPadding(){return this.transform.padding}setPadding(padding,eventData){this.jumpTo({padding:padding},eventData);return this}rotateTo(bearing,options,eventData){return this.easeTo(performance$1.extend({bearing:bearing},options),eventData)}resetNorth(options,eventData){this.rotateTo(0,performance$1.extend({duration:1e3},options),eventData);return this}resetNorthPitch(options,eventData){this.easeTo(performance$1.extend({bearing:0,pitch:0,duration:1e3},options),eventData);return this}snapToNorth(options,eventData){if(Math.abs(this.getBearing())<this._bearingSnap){return this.resetNorth(options,eventData)}return this}getPitch(){return this.transform.pitch}setPitch(pitch,eventData){this.jumpTo({pitch:pitch},eventData);return this}cameraForBounds(bounds,options){bounds=LngLatBounds.convert(bounds);const bearing=options&&options.bearing||0;return this._cameraForBoxAndBearing(bounds.getNorthWest(),bounds.getSouthEast(),bearing,options)}_cameraForBoxAndBearing(p0,p1,bearing,options){const defaultPadding={top:0,bottom:0,right:0,left:0};options=performance$1.extend({padding:defaultPadding,offset:[0,0],maxZoom:this.transform.maxZoom},options);if(typeof options.padding==="number"){const p=options.padding;options.padding={top:p,bottom:p,right:p,left:p}}options.padding=performance$1.extend(defaultPadding,options.padding);const tr=this.transform;const edgePadding=tr.padding;const bounds=new LngLatBounds(p0,p1);const nwWorld=tr.project(bounds.getNorthWest());const neWorld=tr.project(bounds.getNorthEast());const seWorld=tr.project(bounds.getSouthEast());const swWorld=tr.project(bounds.getSouthWest());const bearingRadians=performance$1.degreesToRadians(-bearing);const nwRotatedWorld=nwWorld.rotate(bearingRadians);const neRotatedWorld=neWorld.rotate(bearingRadians);const seRotatedWorld=seWorld.rotate(bearingRadians);const swRotatedWorld=swWorld.rotate(bearingRadians);const upperRight=new performance$1.Point(Math.max(nwRotatedWorld.x,neRotatedWorld.x,swRotatedWorld.x,seRotatedWorld.x),Math.max(nwRotatedWorld.y,neRotatedWorld.y,swRotatedWorld.y,seRotatedWorld.y));const lowerLeft=new performance$1.Point(Math.min(nwRotatedWorld.x,neRotatedWorld.x,swRotatedWorld.x,seRotatedWorld.x),Math.min(nwRotatedWorld.y,neRotatedWorld.y,swRotatedWorld.y,seRotatedWorld.y));const size=upperRight.sub(lowerLeft);const scaleX=(tr.width-(edgePadding.left+edgePadding.right+options.padding.left+options.padding.right))/size.x;const scaleY=(tr.height-(edgePadding.top+edgePadding.bottom+options.padding.top+options.padding.bottom))/size.y;if(scaleY<0||scaleX<0){performance$1.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");return undefined}const zoom=Math.min(tr.scaleZoom(tr.scale*Math.min(scaleX,scaleY)),options.maxZoom);const offset=performance$1.Point.convert(options.offset);const paddingOffsetX=(options.padding.left-options.padding.right)/2;const paddingOffsetY=(options.padding.top-options.padding.bottom)/2;const paddingOffset=new performance$1.Point(paddingOffsetX,paddingOffsetY);const rotatedPaddingOffset=paddingOffset.rotate(performance$1.degreesToRadians(bearing));const offsetAtInitialZoom=offset.add(rotatedPaddingOffset);const offsetAtFinalZoom=offsetAtInitialZoom.mult(tr.scale/tr.zoomScale(zoom));const center=tr.unproject(nwWorld.add(seWorld).div(2).sub(offsetAtFinalZoom));return{center:center,zoom:zoom,bearing:bearing}}fitBounds(bounds,options,eventData){return this._fitInternal(this.cameraForBounds(bounds,options),options,eventData)}fitScreenCoordinates(p0,p1,bearing,options,eventData){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.pointLocation(performance$1.Point.convert(p0)),this.transform.pointLocation(performance$1.Point.convert(p1)),bearing,options),options,eventData)}_fitInternal(calculatedOptions,options,eventData){if(!calculatedOptions)return this;options=performance$1.extend(calculatedOptions,options);delete options.padding;return options.linear?this.easeTo(options,eventData):this.flyTo(options,eventData)}jumpTo(options,eventData){this.stop();const tr=this._getTransformForUpdate();let zoomChanged=false,bearingChanged=false,pitchChanged=false;if("zoom"in options&&tr.zoom!==+options.zoom){zoomChanged=true;tr.zoom=+options.zoom}if(options.center!==undefined){tr.center=performance$1.LngLat.convert(options.center)}if("bearing"in options&&tr.bearing!==+options.bearing){bearingChanged=true;tr.bearing=+options.bearing}if("pitch"in options&&tr.pitch!==+options.pitch){pitchChanged=true;tr.pitch=+options.pitch}if(options.padding!=null&&!tr.isPaddingEqual(options.padding)){tr.padding=options.padding}this._applyUpdatedTransform(tr);this.fire(new performance$1.Event("movestart",eventData)).fire(new performance$1.Event("move",eventData));if(zoomChanged){this.fire(new performance$1.Event("zoomstart",eventData)).fire(new performance$1.Event("zoom",eventData)).fire(new performance$1.Event("zoomend",eventData))}if(bearingChanged){this.fire(new performance$1.Event("rotatestart",eventData)).fire(new performance$1.Event("rotate",eventData)).fire(new performance$1.Event("rotateend",eventData))}if(pitchChanged){this.fire(new performance$1.Event("pitchstart",eventData)).fire(new performance$1.Event("pitch",eventData)).fire(new performance$1.Event("pitchend",eventData))}return this.fire(new performance$1.Event("moveend",eventData))}calculateCameraOptionsFromTo(from,altitudeFrom,to,altitudeTo=0){const fromMerc=performance$1.MercatorCoordinate.fromLngLat(from,altitudeFrom);const toMerc=performance$1.MercatorCoordinate.fromLngLat(to,altitudeTo);const dx=toMerc.x-fromMerc.x;const dy=toMerc.y-fromMerc.y;const dz=toMerc.z-fromMerc.z;const distance3D=Math.hypot(dx,dy,dz);if(distance3D===0)throw new Error("Can't calculate camera options with same From and To");const groundDistance=Math.hypot(dx,dy);const zoom=this.transform.scaleZoom(this.transform.cameraToCenterDistance/distance3D/this.transform.tileSize);const bearing=Math.atan2(dx,-dy)*180/Math.PI;let pitch=Math.acos(groundDistance/distance3D)*180/Math.PI;pitch=dz<0?90-pitch:90+pitch;return{center:toMerc.toLngLat(),zoom:zoom,pitch:pitch,bearing:bearing}}easeTo(options,eventData){this._stop(false,options.easeId);options=performance$1.extend({offset:[0,0],duration:500,easing:performance$1.defaultEasing},options);if(options.animate===false||!options.essential&&browser.prefersReducedMotion)options.duration=0;const tr=this._getTransformForUpdate(),startZoom=this.getZoom(),startBearing=this.getBearing(),startPitch=this.getPitch(),startPadding=this.getPadding(),zoom="zoom"in options?+options.zoom:startZoom,bearing="bearing"in options?this._normalizeBearing(options.bearing,startBearing):startBearing,pitch="pitch"in options?+options.pitch:startPitch,padding="padding"in options?options.padding:tr.padding;const offsetAsPoint=performance$1.Point.convert(options.offset);let pointAtOffset=tr.centerPoint.add(offsetAsPoint);const locationAtOffset=tr.pointLocation(pointAtOffset);const center=performance$1.LngLat.convert(options.center||locationAtOffset);this._normalizeCenter(center);const from=tr.project(locationAtOffset);const delta=tr.project(center).sub(from);const finalScale=tr.zoomScale(zoom-startZoom);let around,aroundPoint;if(options.around){around=performance$1.LngLat.convert(options.around);aroundPoint=tr.locationPoint(around)}const currently={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};this._zooming=this._zooming||zoom!==startZoom;this._rotating=this._rotating||startBearing!==bearing;this._pitching=this._pitching||pitch!==startPitch;this._padding=!tr.isPaddingEqual(padding);this._easeId=options.easeId;this._prepareEase(eventData,options.noMoveStart,currently);if(this.terrain)this._prepareElevation(center);this._ease((k=>{if(this._zooming){tr.zoom=performance$1.interpolate.number(startZoom,zoom,k)}if(this._rotating){tr.bearing=performance$1.interpolate.number(startBearing,bearing,k)}if(this._pitching){tr.pitch=performance$1.interpolate.number(startPitch,pitch,k)}if(this._padding){tr.interpolatePadding(startPadding,padding,k);pointAtOffset=tr.centerPoint.add(offsetAsPoint)}if(this.terrain&&!options.freezeElevation)this._updateElevation(k);if(around){tr.setLocationAtPoint(around,aroundPoint)}else{const scale=tr.zoomScale(tr.zoom-startZoom);const base=zoom>startZoom?Math.min(2,finalScale):Math.max(.5,finalScale);const speedup=Math.pow(base,1-k);const newCenter=tr.unproject(from.add(delta.mult(k*speedup)).mult(scale));tr.setLocationAtPoint(tr.renderWorldCopies?newCenter.wrap():newCenter,pointAtOffset)}this._applyUpdatedTransform(tr);this._fireMoveEvents(eventData)}),(interruptingEaseId=>{if(this.terrain)this._finalizeElevation();this._afterEase(eventData,interruptingEaseId)}),options);return this}_prepareEase(eventData,noMoveStart,currently={}){this._moving=true;if(!noMoveStart&&!currently.moving){this.fire(new performance$1.Event("movestart",eventData))}if(this._zooming&&!currently.zooming){this.fire(new performance$1.Event("zoomstart",eventData))}if(this._rotating&&!currently.rotating){this.fire(new performance$1.Event("rotatestart",eventData))}if(this._pitching&&!currently.pitching){this.fire(new performance$1.Event("pitchstart",eventData))}}_prepareElevation(center){this._elevationCenter=center;this._elevationStart=this.transform.elevation;this._elevationTarget=this.terrain.getElevationForLngLatZoom(center,this.transform.tileZoom);this._elevationFreeze=true}_updateElevation(k){this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);const elevation=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(k<1&&elevation!==this._elevationTarget){const pitch1=this._elevationTarget-this._elevationStart;const pitch2=(elevation-(pitch1*k+this._elevationStart))/(1-k);this._elevationStart+=k*(pitch1-pitch2);this._elevationTarget=elevation}this.transform.elevation=performance$1.interpolate.number(this._elevationStart,this._elevationTarget,k)}_finalizeElevation(){this._elevationFreeze=false;this.transform.recalculateZoom(this.terrain)}_getTransformForUpdate(){if(!this.transformCameraUpdate)return this.transform;if(!this._requestedCameraState){this._requestedCameraState=this.transform.clone()}return this._requestedCameraState}_applyUpdatedTransform(tr){if(!this.transformCameraUpdate)return;const nextTransform=tr.clone();const{center:center,zoom:zoom,pitch:pitch,bearing:bearing,elevation:elevation}=this.transformCameraUpdate(nextTransform);if(center)nextTransform.center=center;if(zoom!==undefined)nextTransform.zoom=zoom;if(pitch!==undefined)nextTransform.pitch=pitch;if(bearing!==undefined)nextTransform.bearing=bearing;if(elevation!==undefined)nextTransform.elevation=elevation;this.transform.apply(nextTransform)}_fireMoveEvents(eventData){this.fire(new performance$1.Event("move",eventData));if(this._zooming){this.fire(new performance$1.Event("zoom",eventData))}if(this._rotating){this.fire(new performance$1.Event("rotate",eventData))}if(this._pitching){this.fire(new performance$1.Event("pitch",eventData))}}_afterEase(eventData,easeId){if(this._easeId&&easeId&&this._easeId===easeId){return}delete this._easeId;const wasZooming=this._zooming;const wasRotating=this._rotating;const wasPitching=this._pitching;this._moving=false;this._zooming=false;this._rotating=false;this._pitching=false;this._padding=false;if(wasZooming){this.fire(new performance$1.Event("zoomend",eventData))}if(wasRotating){this.fire(new performance$1.Event("rotateend",eventData))}if(wasPitching){this.fire(new performance$1.Event("pitchend",eventData))}this.fire(new performance$1.Event("moveend",eventData))}flyTo(options,eventData){if(!options.essential&&browser.prefersReducedMotion){const coercedOptions=performance$1.pick(options,["center","zoom","bearing","pitch","around"]);return this.jumpTo(coercedOptions,eventData)}this.stop();options=performance$1.extend({offset:[0,0],speed:1.2,curve:1.42,easing:performance$1.defaultEasing},options);const tr=this._getTransformForUpdate(),startZoom=this.getZoom(),startBearing=this.getBearing(),startPitch=this.getPitch(),startPadding=this.getPadding();const zoom="zoom"in options?performance$1.clamp(+options.zoom,tr.minZoom,tr.maxZoom):startZoom;const bearing="bearing"in options?this._normalizeBearing(options.bearing,startBearing):startBearing;const pitch="pitch"in options?+options.pitch:startPitch;const padding="padding"in options?options.padding:tr.padding;const scale=tr.zoomScale(zoom-startZoom);const offsetAsPoint=performance$1.Point.convert(options.offset);let pointAtOffset=tr.centerPoint.add(offsetAsPoint);const locationAtOffset=tr.pointLocation(pointAtOffset);const center=performance$1.LngLat.convert(options.center||locationAtOffset);this._normalizeCenter(center);const from=tr.project(locationAtOffset);const delta=tr.project(center).sub(from);let rho=options.curve;const w0=Math.max(tr.width,tr.height),w1=w0/scale,u1=delta.mag();if("minZoom"in options){const minZoom=performance$1.clamp(Math.min(options.minZoom,startZoom,zoom),tr.minZoom,tr.maxZoom);const wMax=w0/tr.zoomScale(minZoom-startZoom);rho=Math.sqrt(wMax/u1*2)}const rho2=rho*rho;function zoomOutFactor(descent){const b=(w1*w1-w0*w0+(descent?-1:1)*rho2*rho2*u1*u1)/(2*(descent?w1:w0)*rho2*u1);return Math.log(Math.sqrt(b*b+1)-b)}function sinh(n){return(Math.exp(n)-Math.exp(-n))/2}function cosh(n){return(Math.exp(n)+Math.exp(-n))/2}function tanh(n){return sinh(n)/cosh(n)}const r0=zoomOutFactor(false);let w=function(s){return cosh(r0)/cosh(r0+rho*s)};let u=function(s){return w0*((cosh(r0)*tanh(r0+rho*s)-sinh(r0))/rho2)/u1};let S=(zoomOutFactor(true)-r0)/rho;if(Math.abs(u1)<1e-6||!isFinite(S)){if(Math.abs(w0-w1)<1e-6)return this.easeTo(options,eventData);const k=w1<w0?-1:1;S=Math.abs(Math.log(w1/w0))/rho;u=function(){return 0};w=function(s){return Math.exp(k*rho*s)}}if("duration"in options){options.duration=+options.duration}else{const V="screenSpeed"in options?+options.screenSpeed/rho:+options.speed;options.duration=1e3*S/V}if(options.maxDuration&&options.duration>options.maxDuration){options.duration=0}this._zooming=true;this._rotating=startBearing!==bearing;this._pitching=pitch!==startPitch;this._padding=!tr.isPaddingEqual(padding);this._prepareEase(eventData,false);if(this.terrain)this._prepareElevation(center);this._ease((k=>{const s=k*S;const scale=1/w(s);tr.zoom=k===1?zoom:startZoom+tr.scaleZoom(scale);if(this._rotating){tr.bearing=performance$1.interpolate.number(startBearing,bearing,k)}if(this._pitching){tr.pitch=performance$1.interpolate.number(startPitch,pitch,k)}if(this._padding){tr.interpolatePadding(startPadding,padding,k);pointAtOffset=tr.centerPoint.add(offsetAsPoint)}if(this.terrain&&!options.freezeElevation)this._updateElevation(k);const newCenter=k===1?center:tr.unproject(from.add(delta.mult(u(s))).mult(scale));tr.setLocationAtPoint(tr.renderWorldCopies?newCenter.wrap():newCenter,pointAtOffset);this._applyUpdatedTransform(tr);this._fireMoveEvents(eventData)}),(()=>{if(this.terrain)this._finalizeElevation();this._afterEase(eventData)}),options);return this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(allowGestures,easeId){if(this._easeFrameId){this._cancelRenderFrame(this._easeFrameId);delete this._easeFrameId;delete this._onEaseFrame}if(this._onEaseEnd){const onEaseEnd=this._onEaseEnd;delete this._onEaseEnd;onEaseEnd.call(this,easeId)}if(!allowGestures){const handlers=this.handlers;if(handlers)handlers.stop(false)}return this}_ease(frame,finish,options){if(options.animate===false||options.duration===0){frame(1);finish()}else{this._easeStart=browser.now();this._easeOptions=options;this._onEaseFrame=frame;this._onEaseEnd=finish;this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback)}}_normalizeBearing(bearing,currentBearing){bearing=performance$1.wrap(bearing,-180,180);const diff=Math.abs(bearing-currentBearing);if(Math.abs(bearing-360-currentBearing)<diff)bearing-=360;if(Math.abs(bearing+360-currentBearing)<diff)bearing+=360;return bearing}_normalizeCenter(center){const tr=this.transform;if(!tr.renderWorldCopies||tr.lngRange)return;const delta=center.lng-tr.center.lng;center.lng+=delta>180?-360:delta<-180?360:0}queryTerrainElevation(lngLatLike){if(!this.terrain){return null}const elevation=this.terrain.getElevationForLngLatZoom(performance$1.LngLat.convert(lngLatLike),this.transform.tileZoom);return elevation-this.transform.elevation}}const defaultAtributionControlOptions={compact:true,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class AttributionControl{constructor(options=defaultAtributionControlOptions){this._toggleAttribution=()=>{if(this._container.classList.contains("maplibregl-compact")){if(this._container.classList.contains("maplibregl-compact-show")){this._container.setAttribute("open","");this._container.classList.remove("maplibregl-compact-show")}else{this._container.classList.add("maplibregl-compact-show");this._container.removeAttribute("open")}}};this._updateData=e=>{if(e&&(e.sourceDataType==="metadata"||e.sourceDataType==="visibility"||e.dataType==="style"||e.type==="terrain")){this._updateAttributions()}};this._updateCompact=()=>{if(this._map.getCanvasContainer().offsetWidth<=640||this._compact){if(this._compact===false){this._container.setAttribute("open","")}else if(!this._container.classList.contains("maplibregl-compact")&&!this._container.classList.contains("maplibregl-attrib-empty")){this._container.setAttribute("open","");this._container.classList.add("maplibregl-compact","maplibregl-compact-show")}}else{this._container.setAttribute("open","");if(this._container.classList.contains("maplibregl-compact")){this._container.classList.remove("maplibregl-compact","maplibregl-compact-show")}}};this._updateCompactMinimize=()=>{if(this._container.classList.contains("maplibregl-compact")){if(this._container.classList.contains("maplibregl-compact-show")){this._container.classList.remove("maplibregl-compact-show")}}};this.options=options}getDefaultPosition(){return"bottom-right"}onAdd(map){this._map=map;this._compact=this.options.compact;this._container=DOM.create("details","maplibregl-ctrl maplibregl-ctrl-attrib");this._compactButton=DOM.create("summary","maplibregl-ctrl-attrib-button",this._container);this._compactButton.addEventListener("click",this._toggleAttribution);this._setElementTitle(this._compactButton,"ToggleAttribution");this._innerContainer=DOM.create("div","maplibregl-ctrl-attrib-inner",this._container);this._updateAttributions();this._updateCompact();this._map.on("styledata",this._updateData);this._map.on("sourcedata",this._updateData);this._map.on("terrain",this._updateData);this._map.on("resize",this._updateCompact);this._map.on("drag",this._updateCompactMinimize);return this._container}onRemove(){DOM.remove(this._container);this._map.off("styledata",this._updateData);this._map.off("sourcedata",this._updateData);this._map.off("terrain",this._updateData);this._map.off("resize",this._updateCompact);this._map.off("drag",this._updateCompactMinimize);this._map=undefined;this._compact=undefined;this._attribHTML=undefined}_setElementTitle(element,title){const str=this._map._getUIString(`AttributionControl.${title}`);element.title=str;element.setAttribute("aria-label",str)}_updateAttributions(){if(!this._map.style)return;let attributions=[];if(this.options.customAttribution){if(Array.isArray(this.options.customAttribution)){attributions=attributions.concat(this.options.customAttribution.map((attribution=>{if(typeof attribution!=="string")return"";return attribution})))}else if(typeof this.options.customAttribution==="string"){attributions.push(this.options.customAttribution)}}if(this._map.style.stylesheet){const stylesheet=this._map.style.stylesheet;this.styleOwner=stylesheet.owner;this.styleId=stylesheet.id}const sourceCaches=this._map.style.sourceCaches;for(const id in sourceCaches){const sourceCache=sourceCaches[id];if(sourceCache.used||sourceCache.usedForTerrain){const source=sourceCache.getSource();if(source.attribution&&attributions.indexOf(source.attribution)<0){attributions.push(source.attribution)}}}attributions=attributions.filter((e=>String(e).trim()));attributions.sort(((a,b)=>a.length-b.length));attributions=attributions.filter(((attrib,i)=>{for(let j=i+1;j<attributions.length;j++){if(attributions[j].indexOf(attrib)>=0){return false}}return true}));const attribHTML=attributions.join(" | ");if(attribHTML===this._attribHTML)return;this._attribHTML=attribHTML;if(attributions.length){this._innerContainer.innerHTML=attribHTML;this._container.classList.remove("maplibregl-attrib-empty")}else{this._container.classList.add("maplibregl-attrib-empty")}this._updateCompact();this._editLink=null}}class LogoControl{constructor(options={}){this._updateCompact=()=>{const containerChildren=this._container.children;if(containerChildren.length){const anchor=containerChildren[0];if(this._map.getCanvasContainer().offsetWidth<=640||this._compact){if(this._compact!==false){anchor.classList.add("maplibregl-compact")}}else{anchor.classList.remove("maplibregl-compact")}}};this.options=options}getDefaultPosition(){return"bottom-left"}onAdd(map){this._map=map;this._compact=this.options&&this.options.compact;this._container=DOM.create("div","maplibregl-ctrl");const anchor=DOM.create("a","maplibregl-ctrl-logo");anchor.target="_blank";anchor.rel="noopener nofollow";anchor.href="https://maplibre.org/";anchor.setAttribute("aria-label",this._map._getUIString("LogoControl.Title"));anchor.setAttribute("rel","noopener nofollow");this._container.appendChild(anchor);this._container.style.display="block";this._map.on("resize",this._updateCompact);this._updateCompact();return this._container}onRemove(){DOM.remove(this._container);this._map.off("resize",this._updateCompact);this._map=undefined;this._compact=undefined}}class TaskQueue{constructor(){this._queue=[];this._id=0;this._cleared=false;this._currentlyRunning=false}add(callback){const id=++this._id;const queue=this._queue;queue.push({callback:callback,id:id,cancelled:false});return id}remove(id){const running=this._currentlyRunning;const queue=running?this._queue.concat(running):this._queue;for(const task of queue){if(task.id===id){task.cancelled=true;return}}}run(timeStamp=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const queue=this._currentlyRunning=this._queue;this._queue=[];for(const task of queue){if(task.cancelled)continue;task.callback(timeStamp);if(this._cleared)break}this._cleared=false;this._currentlyRunning=false}clear(){if(this._currentlyRunning){this._cleared=true}this._queue=[]}}var pos3dAttributes=performance$1.createLayout([{name:"a_pos3d",type:"Int16",components:3}]);class TerrainSourceCache extends performance$1.Evented{constructor(sourceCache){super();this.sourceCache=sourceCache;this._tiles={};this._renderableTilesKeys=[];this._sourceTileCache={};this.minzoom=0;this.maxzoom=22;this.tileSize=512;this.deltaZoom=1;sourceCache.usedForTerrain=true;sourceCache.tileSize=this.tileSize*2**this.deltaZoom}destruct(){this.sourceCache.usedForTerrain=false;this.sourceCache.tileSize=null}update(transform,terrain){this.sourceCache.update(transform,terrain);this._renderableTilesKeys=[];const keys={};for(const tileID of transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:false,terrain:terrain})){keys[tileID.key]=true;this._renderableTilesKeys.push(tileID.key);if(!this._tiles[tileID.key]){tileID.posMatrix=new Float64Array(16);performance$1.ortho(tileID.posMatrix,0,performance$1.EXTENT,0,performance$1.EXTENT,0,1);this._tiles[tileID.key]=new Tile(tileID,this.tileSize)}}for(const key in this._tiles){if(!keys[key])delete this._tiles[key]}}freeRtt(tileID){for(const key in this._tiles){const tile=this._tiles[key];if(!tileID||tile.tileID.equals(tileID)||tile.tileID.isChildOf(tileID)||tileID.isChildOf(tile.tileID))tile.rtt=[]}}getRenderableTiles(){return this._renderableTilesKeys.map((key=>this.getTileByID(key)))}getTileByID(id){return this._tiles[id]}getTerrainCoords(tileID){const coords={};for(const key of this._renderableTilesKeys){const _tileID=this._tiles[key].tileID;if(_tileID.canonical.equals(tileID.canonical)){const coord=tileID.clone();coord.posMatrix=new Float64Array(16);performance$1.ortho(coord.posMatrix,0,performance$1.EXTENT,0,performance$1.EXTENT,0,1);coords[key]=coord}else if(_tileID.canonical.isChildOf(tileID.canonical)){const coord=tileID.clone();coord.posMatrix=new Float64Array(16);const dz=_tileID.canonical.z-tileID.canonical.z;const dx=_tileID.canonical.x-(_tileID.canonical.x>>dz<<dz);const dy=_tileID.canonical.y-(_tileID.canonical.y>>dz<<dz);const size=performance$1.EXTENT>>dz;performance$1.ortho(coord.posMatrix,0,size,0,size,0,1);performance$1.translate(coord.posMatrix,coord.posMatrix,[-dx*size,-dy*size,0]);coords[key]=coord}else if(tileID.canonical.isChildOf(_tileID.canonical)){const coord=tileID.clone();coord.posMatrix=new Float64Array(16);const dz=tileID.canonical.z-_tileID.canonical.z;const dx=tileID.canonical.x-(tileID.canonical.x>>dz<<dz);const dy=tileID.canonical.y-(tileID.canonical.y>>dz<<dz);const size=performance$1.EXTENT>>dz;performance$1.ortho(coord.posMatrix,0,performance$1.EXTENT,0,performance$1.EXTENT,0,1);performance$1.translate(coord.posMatrix,coord.posMatrix,[dx*size,dy*size,0]);performance$1.scale(coord.posMatrix,coord.posMatrix,[1/2**dz,1/2**dz,0]);coords[key]=coord}}return coords}getSourceTile(tileID,searchForDEM){const source=this.sourceCache._source;let z=tileID.overscaledZ-this.deltaZoom;if(z>source.maxzoom)z=source.maxzoom;if(z<source.minzoom)return null;if(!this._sourceTileCache[tileID.key])this._sourceTileCache[tileID.key]=tileID.scaledTo(z).key;let tile=this.sourceCache.getTileByID(this._sourceTileCache[tileID.key]);if(!(tile&&tile.dem)&&searchForDEM)while(z>=source.minzoom&&!(tile&&tile.dem))tile=this.sourceCache.getTileByID(tileID.scaledTo(z--).key);return tile}tilesAfterTime(time=Date.now()){return Object.values(this._tiles).filter((t=>t.timeAdded>=time))}}class Terrain{constructor(painter,sourceCache,options){this.painter=painter;this.sourceCache=new TerrainSourceCache(sourceCache);this.options=options;this.exaggeration=typeof options.exaggeration==="number"?options.exaggeration:1;this.qualityFactor=2;this.meshSize=128;this._demMatrixCache={};this.coordsIndex=[];this._coordsTextureSize=1024}getDEMElevation(tileID,x,y,extent=performance$1.EXTENT){var _a;if(!(x>=0&&x<extent&&y>=0&&y<extent))return 0;const terrain=this.getTerrainData(tileID);const dem=(_a=terrain.tile)===null||_a===void 0?void 0:_a.dem;if(!dem)return 0;const pos=performance$1.transformMat4$1([],[x/extent*performance$1.EXTENT,y/extent*performance$1.EXTENT],terrain.u_terrain_matrix);const coord=[pos[0]*dem.dim,pos[1]*dem.dim];const cx=Math.floor(coord[0]),cy=Math.floor(coord[1]),tx=coord[0]-cx,ty=coord[1]-cy;return dem.get(cx,cy)*(1-tx)*(1-ty)+dem.get(cx+1,cy)*tx*(1-ty)+dem.get(cx,cy+1)*(1-tx)*ty+dem.get(cx+1,cy+1)*tx*ty}getElevationForLngLatZoom(lnglat,zoom){const{tileID:tileID,mercatorX:mercatorX,mercatorY:mercatorY}=this._getOverscaledTileIDFromLngLatZoom(lnglat,zoom);return this.getElevation(tileID,mercatorX%performance$1.EXTENT,mercatorY%performance$1.EXTENT,performance$1.EXTENT)}getElevation(tileID,x,y,extent=performance$1.EXTENT){return this.getDEMElevation(tileID,x,y,extent)*this.exaggeration}getTerrainData(tileID){if(!this._emptyDemTexture){const context=this.painter.context;const image=new performance$1.RGBAImage({width:1,height:1},new Uint8Array(1*4));this._emptyDepthTexture=new Texture(context,image,context.gl.RGBA,{premultiply:false});this._emptyDemUnpack=[0,0,0,0];this._emptyDemTexture=new Texture(context,new performance$1.RGBAImage({width:1,height:1}),context.gl.RGBA,{premultiply:false});this._emptyDemTexture.bind(context.gl.NEAREST,context.gl.CLAMP_TO_EDGE);this._emptyDemMatrix=performance$1.identity([])}const sourceTile=this.sourceCache.getSourceTile(tileID,true);if(sourceTile&&sourceTile.dem&&(!sourceTile.demTexture||sourceTile.needsTerrainPrepare)){const context=this.painter.context;sourceTile.demTexture=this.painter.getTileTexture(sourceTile.dem.stride);if(sourceTile.demTexture)sourceTile.demTexture.update(sourceTile.dem.getPixels(),{premultiply:false});else sourceTile.demTexture=new Texture(context,sourceTile.dem.getPixels(),context.gl.RGBA,{premultiply:false});sourceTile.demTexture.bind(context.gl.NEAREST,context.gl.CLAMP_TO_EDGE);sourceTile.needsTerrainPrepare=false}const matrixKey=sourceTile&&sourceTile+sourceTile.tileID.key+tileID.key;if(matrixKey&&!this._demMatrixCache[matrixKey]){const maxzoom=this.sourceCache.sourceCache._source.maxzoom;let dz=tileID.canonical.z-sourceTile.tileID.canonical.z;if(tileID.overscaledZ>tileID.canonical.z){if(tileID.canonical.z>=maxzoom)dz=tileID.canonical.z-maxzoom;else performance$1.warnOnce("cannot calculate elevation if elevation maxzoom > source.maxzoom")}const dx=tileID.canonical.x-(tileID.canonical.x>>dz<<dz);const dy=tileID.canonical.y-(tileID.canonical.y>>dz<<dz);const demMatrix=performance$1.fromScaling(new Float64Array(16),[1/(performance$1.EXTENT<<dz),1/(performance$1.EXTENT<<dz),0]);performance$1.translate(demMatrix,demMatrix,[dx*performance$1.EXTENT,dy*performance$1.EXTENT,0]);this._demMatrixCache[tileID.key]={matrix:demMatrix,coord:tileID}}return{u_depth:2,u_terrain:3,u_terrain_dim:sourceTile&&sourceTile.dem&&sourceTile.dem.dim||1,u_terrain_matrix:matrixKey?this._demMatrixCache[tileID.key].matrix:this._emptyDemMatrix,u_terrain_unpack:sourceTile&&sourceTile.dem&&sourceTile.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(sourceTile&&sourceTile.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:sourceTile}}getFramebuffer(texture){const painter=this.painter;const width=painter.width/devicePixelRatio;const height=painter.height/devicePixelRatio;if(this._fbo&&(this._fbo.width!==width||this._fbo.height!==height)){this._fbo.destroy();this._fboCoordsTexture.destroy();this._fboDepthTexture.destroy();delete this._fbo;delete this._fboDepthTexture;delete this._fboCoordsTexture}if(!this._fboCoordsTexture){this._fboCoordsTexture=new Texture(painter.context,{width:width,height:height,data:null},painter.context.gl.RGBA,{premultiply:false});this._fboCoordsTexture.bind(painter.context.gl.NEAREST,painter.context.gl.CLAMP_TO_EDGE)}if(!this._fboDepthTexture){this._fboDepthTexture=new Texture(painter.context,{width:width,height:height,data:null},painter.context.gl.RGBA,{premultiply:false});this._fboDepthTexture.bind(painter.context.gl.NEAREST,painter.context.gl.CLAMP_TO_EDGE)}if(!this._fbo){this._fbo=painter.context.createFramebuffer(width,height,true,false);this._fbo.depthAttachment.set(painter.context.createRenderbuffer(painter.context.gl.DEPTH_COMPONENT16,width,height))}this._fbo.colorAttachment.set(texture==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture);return this._fbo}getCoordsTexture(){const context=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const data=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let y=0,i=0;y<this._coordsTextureSize;y++)for(let x=0;x<this._coordsTextureSize;x++,i+=4){data[i+0]=x&255;data[i+1]=y&255;data[i+2]=x>>8<<4|y>>8;data[i+3]=0}const image=new performance$1.RGBAImage({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(data.buffer));const texture=new Texture(context,image,context.gl.RGBA,{premultiply:false});texture.bind(context.gl.NEAREST,context.gl.CLAMP_TO_EDGE);this._coordsTexture=texture;return texture}pointCoordinate(p){const rgba=new Uint8Array(4);const context=this.painter.context,gl=context.gl;context.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer);gl.readPixels(p.x,this.painter.height/devicePixelRatio-p.y-1,1,1,gl.RGBA,gl.UNSIGNED_BYTE,rgba);context.bindFramebuffer.set(null);const x=rgba[0]+(rgba[2]>>4<<8);const y=rgba[1]+((rgba[2]&15)<<8);const tileID=this.coordsIndex[255-rgba[3]];const tile=tileID&&this.sourceCache.getTileByID(tileID);if(!tile)return null;const coordsSize=this._coordsTextureSize;const worldSize=(1<<tile.tileID.canonical.z)*coordsSize;return new performance$1.MercatorCoordinate((tile.tileID.canonical.x*coordsSize+x)/worldSize+tile.tileID.wrap,(tile.tileID.canonical.y*coordsSize+y)/worldSize,this.getElevation(tile.tileID,x,y,coordsSize))}depthAtPoint(p){const rgba=new Uint8Array(4);const context=this.painter.context,gl=context.gl;context.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer);gl.readPixels(p.x,this.painter.height/devicePixelRatio-p.y-1,1,1,gl.RGBA,gl.UNSIGNED_BYTE,rgba);context.bindFramebuffer.set(null);const depthValue=(rgba[0]/(256*256*256)+rgba[1]/(256*256)+rgba[2]/256+rgba[3])/256;return depthValue}getTerrainMesh(){if(this._mesh)return this._mesh;const context=this.painter.context;const vertexArray=new performance$1.Pos3dArray;const indexArray=new performance$1.TriangleIndexArray;const meshSize=this.meshSize;const delta=performance$1.EXTENT/meshSize;const meshSize2=meshSize*meshSize;for(let y=0;y<=meshSize;y++)for(let x=0;x<=meshSize;x++)vertexArray.emplaceBack(x*delta,y*delta,0);for(let y=0;y<meshSize2;y+=meshSize+1)for(let x=0;x<meshSize;x++){indexArray.emplaceBack(x+y,meshSize+x+y+1,meshSize+x+y+2);indexArray.emplaceBack(x+y,meshSize+x+y+2,x+y+1)}const offsetTop=vertexArray.length,offsetBottom=offsetTop+(meshSize+1)*2;for(const y of[0,1])for(let x=0;x<=meshSize;x++)for(const z of[0,1])vertexArray.emplaceBack(x*delta,y*performance$1.EXTENT,z);for(let x=0;x<meshSize*2;x+=2){indexArray.emplaceBack(offsetBottom+x,offsetBottom+x+1,offsetBottom+x+3);indexArray.emplaceBack(offsetBottom+x,offsetBottom+x+3,offsetBottom+x+2);indexArray.emplaceBack(offsetTop+x,offsetTop+x+3,offsetTop+x+1);indexArray.emplaceBack(offsetTop+x,offsetTop+x+2,offsetTop+x+3)}const offsetLeft=vertexArray.length,offsetRight=offsetLeft+(meshSize+1)*2;for(const x of[0,1])for(let y=0;y<=meshSize;y++)for(const z of[0,1])vertexArray.emplaceBack(x*performance$1.EXTENT,y*delta,z);for(let y=0;y<meshSize*2;y+=2){indexArray.emplaceBack(offsetLeft+y,offsetLeft+y+1,offsetLeft+y+3);indexArray.emplaceBack(offsetLeft+y,offsetLeft+y+3,offsetLeft+y+2);indexArray.emplaceBack(offsetRight+y,offsetRight+y+3,offsetRight+y+1);indexArray.emplaceBack(offsetRight+y,offsetRight+y+2,offsetRight+y+3)}this._mesh={indexBuffer:context.createIndexBuffer(indexArray),vertexBuffer:context.createVertexBuffer(vertexArray,pos3dAttributes.members),segments:performance$1.SegmentVector.simpleSegment(0,0,vertexArray.length,indexArray.length)};return this._mesh}getMeshFrameDelta(zoom){return 2*Math.PI*performance$1.earthRadius/Math.pow(2,zoom)/5}getMinTileElevationForLngLatZoom(lnglat,zoom){var _a;const{tileID:tileID}=this._getOverscaledTileIDFromLngLatZoom(lnglat,zoom);return(_a=this.getMinMaxElevation(tileID).minElevation)!==null&&_a!==void 0?_a:0}getMinMaxElevation(tileID){const tile=this.getTerrainData(tileID).tile;const minMax={minElevation:null,maxElevation:null};if(tile&&tile.dem){minMax.minElevation=tile.dem.min*this.exaggeration;minMax.maxElevation=tile.dem.max*this.exaggeration}return minMax}_getOverscaledTileIDFromLngLatZoom(lnglat,zoom){const mercatorCoordinate=performance$1.MercatorCoordinate.fromLngLat(lnglat.wrap());const worldSize=(1<<zoom)*performance$1.EXTENT;const mercatorX=mercatorCoordinate.x*worldSize;const mercatorY=mercatorCoordinate.y*worldSize;const tileX=Math.floor(mercatorX/performance$1.EXTENT),tileY=Math.floor(mercatorY/performance$1.EXTENT);const tileID=new performance$1.OverscaledTileID(zoom,0,zoom,tileX,tileY);return{tileID:tileID,mercatorX:mercatorX,mercatorY:mercatorY}}}class RenderPool{constructor(_context,_size,_tileSize){this._context=_context;this._size=_size;this._tileSize=_tileSize;this._objects=[];this._recentlyUsed=[];this._stamp=0}destruct(){for(const obj of this._objects){obj.texture.destroy();obj.fbo.destroy()}}_createObject(id){const fbo=this._context.createFramebuffer(this._tileSize,this._tileSize,true,true);const texture=new Texture(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);texture.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE);fbo.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize));fbo.colorAttachment.set(texture.texture);return{id:id,fbo:fbo,texture:texture,stamp:-1,inUse:false}}getObjectForId(id){return this._objects[id]}useObject(obj){obj.inUse=true;this._recentlyUsed=this._recentlyUsed.filter((id=>obj.id!==id));this._recentlyUsed.push(obj.id)}stampObject(obj){obj.stamp=++this._stamp}getOrCreateFreeObject(){for(const id of this._recentlyUsed){if(!this._objects[id].inUse)return this._objects[id]}if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const obj=this._createObject(this._objects.length);this._objects.push(obj);return obj}freeObject(obj){obj.inUse=false}freeAllObjects(){for(const obj of this._objects)this.freeObject(obj)}isFull(){if(this._objects.length<this._size){return false}return this._objects.some((o=>!o.inUse))===false}}const LAYERS={background:true,fill:true,line:true,raster:true,hillshade:true};class RenderToTexture{constructor(painter,terrain){this.painter=painter;this.terrain=terrain;this.pool=new RenderPool(painter.context,30,terrain.sourceCache.tileSize*terrain.qualityFactor)}destruct(){this.pool.destruct()}getTexture(tile){return this.pool.getObjectForId(tile.rtt[this._stacks.length-1].id).texture}prepareForRender(style,zoom){this._stacks=[];this._prevType=null;this._rttTiles=[];this._renderableTiles=this.terrain.sourceCache.getRenderableTiles();this._renderableLayerIds=style._order.filter((id=>!style._layers[id].isHidden(zoom)));this._coordsDescendingInv={};for(const id in style.sourceCaches){this._coordsDescendingInv[id]={};const tileIDs=style.sourceCaches[id].getVisibleCoordinates();for(const tileID of tileIDs){const keys=this.terrain.sourceCache.getTerrainCoords(tileID);for(const key in keys){if(!this._coordsDescendingInv[id][key])this._coordsDescendingInv[id][key]=[];this._coordsDescendingInv[id][key].push(keys[key])}}}this._coordsDescendingInvStr={};for(const id of style._order){const layer=style._layers[id],source=layer.source;if(LAYERS[layer.type]){if(!this._coordsDescendingInvStr[source]){this._coordsDescendingInvStr[source]={};for(const key in this._coordsDescendingInv[source])this._coordsDescendingInvStr[source][key]=this._coordsDescendingInv[source][key].map((c=>c.key)).sort().join()}}}for(const tile of this._renderableTiles){for(const source in this._coordsDescendingInvStr){const coords=this._coordsDescendingInvStr[source][tile.tileID.key];if(coords&&coords!==tile.rttCoords[source])tile.rtt=[]}}}renderLayer(layer){if(layer.isHidden(this.painter.transform.zoom))return false;const type=layer.type;const painter=this.painter;const isLastLayer=this._renderableLayerIds[this._renderableLayerIds.length-1]===layer.id;if(LAYERS[type]){if(!this._prevType||!LAYERS[this._prevType])this._stacks.push([]);this._prevType=type;this._stacks[this._stacks.length-1].push(layer.id);if(!isLastLayer)return true}if(LAYERS[this._prevType]||LAYERS[type]&&isLastLayer){this._prevType=type;const stack=this._stacks.length-1,layers=this._stacks[stack]||[];for(const tile of this._renderableTiles){if(this.pool.isFull()){drawTerrain(this.painter,this.terrain,this._rttTiles);this._rttTiles=[];this.pool.freeAllObjects()}this._rttTiles.push(tile);if(tile.rtt[stack]){const obj=this.pool.getObjectForId(tile.rtt[stack].id);if(obj.stamp===tile.rtt[stack].stamp){this.pool.useObject(obj);continue}}const obj=this.pool.getOrCreateFreeObject();this.pool.useObject(obj);this.pool.stampObject(obj);tile.rtt[stack]={id:obj.id,stamp:obj.stamp};painter.context.bindFramebuffer.set(obj.fbo.framebuffer);painter.context.clear({color:performance$1.Color.transparent,stencil:0});painter.currentStencilSource=undefined;for(let l=0;l<layers.length;l++){const layer=painter.style._layers[layers[l]];const coords=layer.source?this._coordsDescendingInv[layer.source][tile.tileID.key]:[tile.tileID];painter.context.viewport.set([0,0,obj.fbo.width,obj.fbo.height]);painter._renderTileClippingMasks(layer,coords);painter.renderLayer(painter,painter.style.sourceCaches[layer.source],layer,coords);if(layer.source)tile.rttCoords[layer.source]=this._coordsDescendingInvStr[layer.source][tile.tileID.key]}}drawTerrain(this.painter,this.terrain,this._rttTiles);this._rttTiles=[];this.pool.freeAllObjects();return LAYERS[type]}return false}}const defaultLocale={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use â + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"};const version$1=packageJSON.version;const defaultMinZoom=-2;const defaultMaxZoom=22;const defaultMinPitch=0;const defaultMaxPitch=60;const maxPitchThreshold=85;const defaultOptions$4={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:defaultMinZoom,maxZoom:defaultMaxZoom,minPitch:defaultMinPitch,maxPitch:defaultMaxPitch,interactive:true,scrollZoom:true,boxZoom:true,dragRotate:true,dragPan:true,keyboard:true,doubleClickZoom:true,touchZoomRotate:true,touchPitch:true,cooperativeGestures:false,bearingSnap:7,clickTolerance:3,pitchWithRotate:true,hash:false,attributionControl:defaultAtributionControlOptions,maplibreLogo:false,failIfMajorPerformanceCaveat:false,preserveDrawingBuffer:false,trackResize:true,renderWorldCopies:true,refreshExpiredTiles:true,maxTileCacheSize:null,maxTileCacheZoomLevels:performance$1.config.MAX_TILE_CACHE_ZOOM_LEVELS,localIdeographFontFamily:"sans-serif",transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:true,validateStyle:true,maxCanvasSize:[4096,4096]};let Map$1=class Map extends Camera{constructor(options){performance$1.PerformanceUtils.mark(performance$1.PerformanceMarkers.create);options=performance$1.extend({},defaultOptions$4,options);if(options.minZoom!=null&&options.maxZoom!=null&&options.minZoom>options.maxZoom){throw new Error("maxZoom must be greater than or equal to minZoom")}if(options.minPitch!=null&&options.maxPitch!=null&&options.minPitch>options.maxPitch){throw new Error("maxPitch must be greater than or equal to minPitch")}if(options.minPitch!=null&&options.minPitch<defaultMinPitch){throw new Error(`minPitch must be greater than or equal to ${defaultMinPitch}`)}if(options.maxPitch!=null&&options.maxPitch>maxPitchThreshold){throw new Error(`maxPitch must be less than or equal to ${maxPitchThreshold}`)}const transform=new Transform(options.minZoom,options.maxZoom,options.minPitch,options.maxPitch,options.renderWorldCopies);super(transform,{bearingSnap:options.bearingSnap});this._contextLost=event=>{event.preventDefault();if(this._frameRequest){this._frameRequest.abort();this._frameRequest=null}this.fire(new performance$1.Event("webglcontextlost",{originalEvent:event}))};this._contextRestored=event=>{this._setupPainter();this.resize();this._update();this.fire(new performance$1.Event("webglcontextrestored",{originalEvent:event}))};this._onMapScroll=event=>{if(event.target!==this._container)return;this._container.scrollTop=0;this._container.scrollLeft=0;return false};this._onWindowOnline=()=>{this._update()};this._interactive=options.interactive;this._maxTileCacheSize=options.maxTileCacheSize;this._maxTileCacheZoomLevels=options.maxTileCacheZoomLevels;this._failIfMajorPerformanceCaveat=options.failIfMajorPerformanceCaveat;this._preserveDrawingBuffer=options.preserveDrawingBuffer;this._antialias=options.antialias;this._trackResize=options.trackResize;this._bearingSnap=options.bearingSnap;this._refreshExpiredTiles=options.refreshExpiredTiles;this._fadeDuration=options.fadeDuration;this._crossSourceCollisions=options.crossSourceCollisions;this._crossFadingFactor=1;this._collectResourceTiming=options.collectResourceTiming;this._renderTaskQueue=new TaskQueue;this._controls=[];this._mapId=performance$1.uniqueId();this._locale=performance$1.extend({},defaultLocale,options.locale);this._clickTolerance=options.clickTolerance;this._overridePixelRatio=options.pixelRatio;this._maxCanvasSize=options.maxCanvasSize;this.transformCameraUpdate=options.transformCameraUpdate;this._imageQueueHandle=ImageRequest.addThrottleControl((()=>this.isMoving()));this._requestManager=new RequestManager(options.transformRequest);if(typeof options.container==="string"){this._container=document.getElementById(options.container);if(!this._container){throw new Error(`Container '${options.container}' not found.`)}}else if(options.container instanceof HTMLElement){this._container=options.container}else{throw new Error("Invalid type: 'container' must be a String or HTMLElement.")}if(options.maxBounds){this.setMaxBounds(options.maxBounds)}this._setupContainer();this._setupPainter();this.on("move",(()=>this._update(false)));this.on("moveend",(()=>this._update(false)));this.on("zoom",(()=>this._update(true)));this.on("terrain",(()=>{this.painter.terrainFacilitator.dirty=true;this._update(true)}));this.once("idle",(()=>{this._idleTriggered=true}));if(typeof window!=="undefined"){addEventListener("online",this._onWindowOnline,false);let initialResizeEventCaptured=false;const throttledResizeCallback=throttle((entries=>{if(this._trackResize&&!this._removed){this.resize(entries)._update()}}),50);this._resizeObserver=new ResizeObserver((entries=>{if(!initialResizeEventCaptured){initialResizeEventCaptured=true;return}throttledResizeCallback(entries)}));this._resizeObserver.observe(this._container)}this.handlers=new HandlerManager(this,options);const hashName=typeof options.hash==="string"&&options.hash||undefined;this._hash=options.hash&&new Hash(hashName).addTo(this);if(!this._hash||!this._hash._onHashChange()){this.jumpTo({center:options.center,zoom:options.zoom,bearing:options.bearing,pitch:options.pitch});if(options.bounds){this.resize();this.fitBounds(options.bounds,performance$1.extend({},options.fitBoundsOptions,{duration:0}))}}this.resize();this._localIdeographFontFamily=options.localIdeographFontFamily;this._validateStyle=options.validateStyle;if(options.style)this.setStyle(options.style,{localIdeographFontFamily:options.localIdeographFontFamily});if(options.attributionControl)this.addControl(new AttributionControl(typeof options.attributionControl==="boolean"?undefined:options.attributionControl));if(options.maplibreLogo)this.addControl(new LogoControl,options.logoPosition);this.on("style.load",(()=>{if(this.transform.unmodified){this.jumpTo(this.style.stylesheet)}}));this.on("data",(event=>{this._update(event.dataType==="style");this.fire(new performance$1.Event(`${event.dataType}data`,event))}));this.on("dataloading",(event=>{this.fire(new performance$1.Event(`${event.dataType}dataloading`,event))}));this.on("dataabort",(event=>{this.fire(new performance$1.Event("sourcedataabort",event))}))}_getMapId(){return this._mapId}addControl(control,position){if(position===undefined){if(control.getDefaultPosition){position=control.getDefaultPosition()}else{position="top-right"}}if(!control||!control.onAdd){return this.fire(new performance$1.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")))}const controlElement=control.onAdd(this);this._controls.push(control);const positionContainer=this._controlPositions[position];if(position.indexOf("bottom")!==-1){positionContainer.insertBefore(controlElement,positionContainer.firstChild)}else{positionContainer.appendChild(controlElement)}return this}removeControl(control){if(!control||!control.onRemove){return this.fire(new performance$1.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")))}const ci=this._controls.indexOf(control);if(ci>-1)this._controls.splice(ci,1);control.onRemove(this);return this}hasControl(control){return this._controls.indexOf(control)>-1}calculateCameraOptionsFromTo(from,altitudeFrom,to,altitudeTo){if(altitudeTo==null&&this.terrain){altitudeTo=this.terrain.getElevationForLngLatZoom(to,this.transform.tileZoom)}return super.calculateCameraOptionsFromTo(from,altitudeFrom,to,altitudeTo)}resize(eventData){var _a;const dimensions=this._containerDimensions();const width=dimensions[0];const height=dimensions[1];const clampedPixelRatio=this._getClampedPixelRatio(width,height);this._resizeCanvas(width,height,clampedPixelRatio);this.painter.resize(width,height,clampedPixelRatio);if(this.painter.overLimit()){const gl=this.painter.context.gl;this._maxCanvasSize=[gl.drawingBufferWidth,gl.drawingBufferHeight];const clampedPixelRatio=this._getClampedPixelRatio(width,height);this._resizeCanvas(width,height,clampedPixelRatio);this.painter.resize(width,height,clampedPixelRatio)}this.transform.resize(width,height);(_a=this._requestedCameraState)===null||_a===void 0?void 0:_a.resize(width,height);const fireMoving=!this._moving;if(fireMoving){this.stop();this.fire(new performance$1.Event("movestart",eventData)).fire(new performance$1.Event("move",eventData))}this.fire(new performance$1.Event("resize",eventData));if(fireMoving)this.fire(new performance$1.Event("moveend",eventData));return this}_getClampedPixelRatio(width,height){const{0:maxCanvasWidth,1:maxCanvasHeight}=this._maxCanvasSize;const pixelRatio=this.getPixelRatio();const canvasWidth=width*pixelRatio;const canvasHeight=height*pixelRatio;const widthScaleFactor=canvasWidth>maxCanvasWidth?maxCanvasWidth/canvasWidth:1;const heightScaleFactor=canvasHeight>maxCanvasHeight?maxCanvasHeight/canvasHeight:1;return Math.min(widthScaleFactor,heightScaleFactor)*pixelRatio}getPixelRatio(){var _a;return(_a=this._overridePixelRatio)!==null&&_a!==void 0?_a:devicePixelRatio}setPixelRatio(pixelRatio){this._overridePixelRatio=pixelRatio;this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(bounds){this.transform.setMaxBounds(LngLatBounds.convert(bounds));return this._update()}setMinZoom(minZoom){minZoom=minZoom===null||minZoom===undefined?defaultMinZoom:minZoom;if(minZoom>=defaultMinZoom&&minZoom<=this.transform.maxZoom){this.transform.minZoom=minZoom;this._update();if(this.getZoom()<minZoom)this.setZoom(minZoom);return this}else throw new Error(`minZoom must be between ${defaultMinZoom} and the current maxZoom, inclusive`)}getMinZoom(){return this.transform.minZoom}setMaxZoom(maxZoom){maxZoom=maxZoom===null||maxZoom===undefined?defaultMaxZoom:maxZoom;if(maxZoom>=this.transform.minZoom){this.transform.maxZoom=maxZoom;this._update();if(this.getZoom()>maxZoom)this.setZoom(maxZoom);return this}else throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(minPitch){minPitch=minPitch===null||minPitch===undefined?defaultMinPitch:minPitch;if(minPitch<defaultMinPitch){throw new Error(`minPitch must be greater than or equal to ${defaultMinPitch}`)}if(minPitch>=defaultMinPitch&&minPitch<=this.transform.maxPitch){this.transform.minPitch=minPitch;this._update();if(this.getPitch()<minPitch)this.setPitch(minPitch);return this}else throw new Error(`minPitch must be between ${defaultMinPitch} and the current maxPitch, inclusive`)}getMinPitch(){return this.transform.minPitch}setMaxPitch(maxPitch){maxPitch=maxPitch===null||maxPitch===undefined?defaultMaxPitch:maxPitch;if(maxPitch>maxPitchThreshold){throw new Error(`maxPitch must be less than or equal to ${maxPitchThreshold}`)}if(maxPitch>=this.transform.minPitch){this.transform.maxPitch=maxPitch;this._update();if(this.getPitch()>maxPitch)this.setPitch(maxPitch);return this}else throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(renderWorldCopies){this.transform.renderWorldCopies=renderWorldCopies;return this._update()}project(lnglat){return this.transform.locationPoint(performance$1.LngLat.convert(lnglat),this.style&&this.terrain)}unproject(point){return this.transform.pointLocation(performance$1.Point.convert(point),this.terrain)}isMoving(){var _a;return this._moving||((_a=this.handlers)===null||_a===void 0?void 0:_a.isMoving())}isZooming(){var _a;return this._zooming||((_a=this.handlers)===null||_a===void 0?void 0:_a.isZooming())}isRotating(){var _a;return this._rotating||((_a=this.handlers)===null||_a===void 0?void 0:_a.isRotating())}_createDelegatedListener(type,layerId,listener){if(type==="mouseenter"||type==="mouseover"){let mousein=false;const mousemove=e=>{const features=this.getLayer(layerId)?this.queryRenderedFeatures(e.point,{layers:[layerId]}):[];if(!features.length){mousein=false}else if(!mousein){mousein=true;listener.call(this,new MapMouseEvent(type,this,e.originalEvent,{features:features}))}};const mouseout=()=>{mousein=false};return{layer:layerId,listener:listener,delegates:{mousemove:mousemove,mouseout:mouseout}}}else if(type==="mouseleave"||type==="mouseout"){let mousein=false;const mousemove=e=>{const features=this.getLayer(layerId)?this.queryRenderedFeatures(e.point,{layers:[layerId]}):[];if(features.length){mousein=true}else if(mousein){mousein=false;listener.call(this,new MapMouseEvent(type,this,e.originalEvent))}};const mouseout=e=>{if(mousein){mousein=false;listener.call(this,new MapMouseEvent(type,this,e.originalEvent))}};return{layer:layerId,listener:listener,delegates:{mousemove:mousemove,mouseout:mouseout}}}else{const delegate=e=>{const features=this.getLayer(layerId)?this.queryRenderedFeatures(e.point,{layers:[layerId]}):[];if(features.length){e.features=features;listener.call(this,e);delete e.features}};return{layer:layerId,listener:listener,delegates:{[type]:delegate}}}}on(type,layerIdOrListener,listener){if(listener===undefined){return super.on(type,layerIdOrListener)}const delegatedListener=this._createDelegatedListener(type,layerIdOrListener,listener);this._delegatedListeners=this._delegatedListeners||{};this._delegatedListeners[type]=this._delegatedListeners[type]||[];this._delegatedListeners[type].push(delegatedListener);for(const event in delegatedListener.delegates){this.on(event,delegatedListener.delegates[event])}return this}once(type,layerIdOrListener,listener){if(listener===undefined){return super.once(type,layerIdOrListener)}const delegatedListener=this._createDelegatedListener(type,layerIdOrListener,listener);for(const event in delegatedListener.delegates){this.once(event,delegatedListener.delegates[event])}return this}off(type,layerIdOrListener,listener){if(listener===undefined){return super.off(type,layerIdOrListener)}const removeDelegatedListener=delegatedListeners=>{const listeners=delegatedListeners[type];for(let i=0;i<listeners.length;i++){const delegatedListener=listeners[i];if(delegatedListener.layer===layerIdOrListener&&delegatedListener.listener===listener){for(const event in delegatedListener.delegates){this.off(event,delegatedListener.delegates[event])}listeners.splice(i,1);return this}}};if(this._delegatedListeners&&this._delegatedListeners[type]){removeDelegatedListener(this._delegatedListeners)}return this}queryRenderedFeatures(geometryOrOptions,options){if(!this.style){return[]}let queryGeometry;const isGeometry=geometryOrOptions instanceof performance$1.Point||Array.isArray(geometryOrOptions);const geometry=isGeometry?geometryOrOptions:[[0,0],[this.transform.width,this.transform.height]];options=options||(isGeometry?{}:geometryOrOptions)||{};if(geometry instanceof performance$1.Point||typeof geometry[0]==="number"){queryGeometry=[performance$1.Point.convert(geometry)]}else{const tl=performance$1.Point.convert(geometry[0]);const br=performance$1.Point.convert(geometry[1]);queryGeometry=[tl,new performance$1.Point(br.x,tl.y),br,new performance$1.Point(tl.x,br.y),tl]}return this.style.queryRenderedFeatures(queryGeometry,options,this.transform)}querySourceFeatures(sourceId,parameters){return this.style.querySourceFeatures(sourceId,parameters)}setStyle(style,options){options=performance$1.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},options);if(options.diff!==false&&options.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&style){this._diffStyle(style,options);return this}else{this._localIdeographFontFamily=options.localIdeographFontFamily;return this._updateStyle(style,options)}}setTransformRequest(transformRequest){this._requestManager.setTransformRequest(transformRequest);return this}_getUIString(key){const str=this._locale[key];if(str==null){throw new Error(`Missing UI string '${key}'`)}return str}_updateStyle(style,options){if(options.transformStyle&&this.style&&!this.style._loaded){this.style.once("style.load",(()=>this._updateStyle(style,options)));return}const previousStyle=this.style&&options.transformStyle?this.style.serialize():undefined;if(this.style){this.style.setEventedParent(null);this.style._remove(!style)}if(!style){delete this.style;return this}else{this.style=new Style(this,options||{})}this.style.setEventedParent(this,{style:this.style});if(typeof style==="string"){this.style.loadURL(style,options,previousStyle)}else{this.style.loadJSON(style,options,previousStyle)}return this}_lazyInitEmptyStyle(){if(!this.style){this.style=new Style(this,{});this.style.setEventedParent(this,{style:this.style});this.style.loadEmpty()}}_diffStyle(style,options){if(typeof style==="string"){const url=style;const request=this._requestManager.transformRequest(url,ResourceType.Style);performance$1.getJSON(request,new AbortController).then((response=>{this._updateDiff(response.data,options)})).catch((error=>{if(error){this.fire(new performance$1.ErrorEvent(error))}}))}else if(typeof style==="object"){this._updateDiff(style,options)}}_updateDiff(style,options){try{if(this.style.setState(style,options)){this._update(true)}}catch(e){performance$1.warnOnce(`Unable to perform style diff: ${e.message||e.error||e}.  Rebuilding the style from scratch.`);this._updateStyle(style,options)}}getStyle(){if(this.style){return this.style.serialize()}}isStyleLoaded(){if(!this.style)return performance$1.warnOnce("There is no style added to the map.");return this.style.loaded()}addSource(id,source){this._lazyInitEmptyStyle();this.style.addSource(id,source);return this._update(true)}isSourceLoaded(id){const source=this.style&&this.style.sourceCaches[id];if(source===undefined){this.fire(new performance$1.ErrorEvent(new Error(`There is no source with ID '${id}'`)));return}return source.loaded()}setTerrain(options){this.style._checkLoaded();if(this._terrainDataCallback)this.style.off("data",this._terrainDataCallback);if(!options){if(this.terrain)this.terrain.sourceCache.destruct();this.terrain=null;if(this.painter.renderToTexture)this.painter.renderToTexture.destruct();this.painter.renderToTexture=null;this.transform.minElevationForCurrentTile=0;this.transform.elevation=0}else{const sourceCache=this.style.sourceCaches[options.source];if(!sourceCache)throw new Error(`cannot load terrain, because there exists no source with ID: ${options.source}`);if(this.terrain===null)sourceCache.reload();for(const index in this.style._layers){const thisLayer=this.style._layers[index];if(thisLayer.type==="hillshade"&&thisLayer.source===options.source){performance$1.warnOnce("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}}this.terrain=new Terrain(this.painter,sourceCache,options);this.painter.renderToTexture=new RenderToTexture(this.painter,this.terrain);this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom);this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom);this._terrainDataCallback=e=>{if(e.dataType==="style"){this.terrain.sourceCache.freeRtt()}else if(e.dataType==="source"&&e.tile){if(e.sourceId===options.source&&!this._elevationFreeze){this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom);this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)}this.terrain.sourceCache.freeRtt(e.tile.tileID)}};this.style.on("data",this._terrainDataCallback)}this.fire(new performance$1.Event("terrain",{terrain:options}));return this}getTerrain(){var _a,_b;return(_b=(_a=this.terrain)===null||_a===void 0?void 0:_a.options)!==null&&_b!==void 0?_b:null}areTilesLoaded(){const sources=this.style&&this.style.sourceCaches;for(const id in sources){const source=sources[id];const tiles=source._tiles;for(const t in tiles){const tile=tiles[t];if(!(tile.state==="loaded"||tile.state==="errored"))return false}}return true}removeSource(id){this.style.removeSource(id);return this._update(true)}getSource(id){return this.style.getSource(id)}addImage(id,image,options={}){const{pixelRatio:pixelRatio=1,sdf:sdf=false,stretchX:stretchX,stretchY:stretchY,content:content}=options;this._lazyInitEmptyStyle();const version=0;if(image instanceof HTMLImageElement||performance$1.isImageBitmap(image)){const{width:width,height:height,data:data}=browser.getImageData(image);this.style.addImage(id,{data:new performance$1.RGBAImage({width:width,height:height},data),pixelRatio:pixelRatio,stretchX:stretchX,stretchY:stretchY,content:content,sdf:sdf,version:version})}else if(image.width===undefined||image.height===undefined){return this.fire(new performance$1.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, "+"or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}else{const{width:width,height:height,data:data}=image;const userImage=image;this.style.addImage(id,{data:new performance$1.RGBAImage({width:width,height:height},new Uint8Array(data)),pixelRatio:pixelRatio,stretchX:stretchX,stretchY:stretchY,content:content,sdf:sdf,version:version,userImage:userImage});if(userImage.onAdd){userImage.onAdd(this,id)}return this}}updateImage(id,image){const existingImage=this.style.getImage(id);if(!existingImage){return this.fire(new performance$1.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")))}const imageData=image instanceof HTMLImageElement||performance$1.isImageBitmap(image)?browser.getImageData(image):image;const{width:width,height:height,data:data}=imageData;if(width===undefined||height===undefined){return this.fire(new performance$1.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, "+"or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}if(width!==existingImage.data.width||height!==existingImage.data.height){return this.fire(new performance$1.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image")))}const copy=!(image instanceof HTMLImageElement||performance$1.isImageBitmap(image));existingImage.data.replace(data,copy);this.style.updateImage(id,existingImage);return this}getImage(id){return this.style.getImage(id)}hasImage(id){if(!id){this.fire(new performance$1.ErrorEvent(new Error("Missing required image id")));return false}return!!this.style.getImage(id)}removeImage(id){this.style.removeImage(id)}loadImage(url){return ImageRequest.getImage(this._requestManager.transformRequest(url,ResourceType.Image),new AbortController)}listImages(){return this.style.listImages()}addLayer(layer,beforeId){this._lazyInitEmptyStyle();this.style.addLayer(layer,beforeId);return this._update(true)}moveLayer(id,beforeId){this.style.moveLayer(id,beforeId);return this._update(true)}removeLayer(id){this.style.removeLayer(id);return this._update(true)}getLayer(id){return this.style.getLayer(id)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(layerId,minzoom,maxzoom){this.style.setLayerZoomRange(layerId,minzoom,maxzoom);return this._update(true)}setFilter(layerId,filter,options={}){this.style.setFilter(layerId,filter,options);return this._update(true)}getFilter(layerId){return this.style.getFilter(layerId)}setPaintProperty(layerId,name,value,options={}){this.style.setPaintProperty(layerId,name,value,options);return this._update(true)}getPaintProperty(layerId,name){return this.style.getPaintProperty(layerId,name)}setLayoutProperty(layerId,name,value,options={}){this.style.setLayoutProperty(layerId,name,value,options);return this._update(true)}getLayoutProperty(layerId,name){return this.style.getLayoutProperty(layerId,name)}setGlyphs(glyphsUrl,options={}){this._lazyInitEmptyStyle();this.style.setGlyphs(glyphsUrl,options);return this._update(true)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(id,url,options={}){this._lazyInitEmptyStyle();this.style.addSprite(id,url,options,(err=>{if(!err){this._update(true)}}));return this}removeSprite(id){this._lazyInitEmptyStyle();this.style.removeSprite(id);return this._update(true)}getSprite(){return this.style.getSprite()}setSprite(spriteUrl,options={}){this._lazyInitEmptyStyle();this.style.setSprite(spriteUrl,options,(err=>{if(!err){this._update(true)}}));return this}setLight(light,options={}){this._lazyInitEmptyStyle();this.style.setLight(light,options);return this._update(true)}getLight(){return this.style.getLight()}setFeatureState(feature,state){this.style.setFeatureState(feature,state);return this._update()}removeFeatureState(target,key){this.style.removeFeatureState(target,key);return this._update()}getFeatureState(feature){return this.style.getFeatureState(feature)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let width=0;let height=0;if(this._container){width=this._container.clientWidth||400;height=this._container.clientHeight||300}return[width,height]}_setupContainer(){const container=this._container;container.classList.add("maplibregl-map");const canvasContainer=this._canvasContainer=DOM.create("div","maplibregl-canvas-container",container);if(this._interactive){canvasContainer.classList.add("maplibregl-interactive")}this._canvas=DOM.create("canvas","maplibregl-canvas",canvasContainer);this._canvas.addEventListener("webglcontextlost",this._contextLost,false);this._canvas.addEventListener("webglcontextrestored",this._contextRestored,false);this._canvas.setAttribute("tabindex","0");this._canvas.setAttribute("aria-label","Map");this._canvas.setAttribute("role","region");const dimensions=this._containerDimensions();const clampedPixelRatio=this._getClampedPixelRatio(dimensions[0],dimensions[1]);this._resizeCanvas(dimensions[0],dimensions[1],clampedPixelRatio);const controlContainer=this._controlContainer=DOM.create("div","maplibregl-control-container",container);const positions=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((positionName=>{positions[positionName]=DOM.create("div",`maplibregl-ctrl-${positionName} `,controlContainer)}));this._container.addEventListener("scroll",this._onMapScroll,false)}_resizeCanvas(width,height,pixelRatio){this._canvas.width=Math.floor(pixelRatio*width);this._canvas.height=Math.floor(pixelRatio*height);this._canvas.style.width=`${width}px`;this._canvas.style.height=`${height}px`}_setupPainter(){const attributes={alpha:true,stencil:true,depth:true,failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||false};let webglcontextcreationerrorDetailObject=null;this._canvas.addEventListener("webglcontextcreationerror",(args=>{webglcontextcreationerrorDetailObject={requestedAttributes:attributes};if(args){webglcontextcreationerrorDetailObject.statusMessage=args.statusMessage;webglcontextcreationerrorDetailObject.type=args.type}}),{once:true});const gl=this._canvas.getContext("webgl2",attributes)||this._canvas.getContext("webgl",attributes);if(!gl){const msg="Failed to initialize WebGL";if(webglcontextcreationerrorDetailObject){webglcontextcreationerrorDetailObject.message=msg;throw new Error(JSON.stringify(webglcontextcreationerrorDetailObject))}else{throw new Error(msg)}}this.painter=new Painter(gl,this.transform);webpSupported.testSupport(gl)}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(updateStyle){if(!this.style||!this.style._loaded)return this;this._styleDirty=this._styleDirty||updateStyle;this._sourcesDirty=true;this.triggerRepaint();return this}_requestRenderFrame(callback){this._update();return this._renderTaskQueue.add(callback)}_cancelRenderFrame(id){this._renderTaskQueue.remove(id)}_render(paintStartTimeStamp){const fadeDuration=this._idleTriggered?this._fadeDuration:0;this.painter.context.setDirty();this.painter.setBaseState();this._renderTaskQueue.run(paintStartTimeStamp);if(this._removed)return;let crossFading=false;if(this.style&&this._styleDirty){this._styleDirty=false;const zoom=this.transform.zoom;const now=browser.now();this.style.zoomHistory.update(zoom,now);const parameters=new performance$1.EvaluationParameters(zoom,{now:now,fadeDuration:fadeDuration,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()});const factor=parameters.crossFadingFactor();if(factor!==1||factor!==this._crossFadingFactor){crossFading=true;this._crossFadingFactor=factor}this.style.update(parameters)}if(this.style&&this._sourcesDirty){this._sourcesDirty=false;this.style._updateSources(this.transform)}if(this.terrain){this.terrain.sourceCache.update(this.transform,this.terrain);this.transform.minElevationForCurrentTile=this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom);if(!this._elevationFreeze){this.transform.elevation=this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)}}else{this.transform.minElevationForCurrentTile=0;this.transform.elevation=0}this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,fadeDuration,this._crossSourceCollisions);this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:fadeDuration,showPadding:this.showPadding});this.fire(new performance$1.Event("render"));if(this.loaded()&&!this._loaded){this._loaded=true;performance$1.PerformanceUtils.mark(performance$1.PerformanceMarkers.load);this.fire(new performance$1.Event("load"))}if(this.style&&(this.style.hasTransitions()||crossFading)){this._styleDirty=true}if(this.style&&!this._placementDirty){this.style._releaseSymbolFadeTiles()}const somethingDirty=this._sourcesDirty||this._styleDirty||this._placementDirty;if(somethingDirty||this._repaint){this.triggerRepaint()}else if(!this.isMoving()&&this.loaded()){this.fire(new performance$1.Event("idle"))}if(this._loaded&&!this._fullyLoaded&&!somethingDirty){this._fullyLoaded=true;performance$1.PerformanceUtils.mark(performance$1.PerformanceMarkers.fullLoad)}return this}redraw(){if(this.style){if(this._frameRequest){this._frameRequest.abort();this._frameRequest=null}this._render(0)}return this}remove(){var _a;if(this._hash)this._hash.remove();for(const control of this._controls)control.onRemove(this);this._controls=[];if(this._frameRequest){this._frameRequest.abort();this._frameRequest=null}this._renderTaskQueue.clear();this.painter.destroy();this.handlers.destroy();delete this.handlers;this.setStyle(null);if(typeof window!=="undefined"){removeEventListener("online",this._onWindowOnline,false)}ImageRequest.removeThrottleControl(this._imageQueueHandle);(_a=this._resizeObserver)===null||_a===void 0?void 0:_a.disconnect();const extension=this.painter.context.gl.getExtension("WEBGL_lose_context");if(extension)extension.loseContext();this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,false);this._canvas.removeEventListener("webglcontextlost",this._contextLost,false);DOM.remove(this._canvasContainer);DOM.remove(this._controlContainer);this._container.classList.remove("maplibregl-map");performance$1.PerformanceUtils.clearMetrics();this._removed=true;this.fire(new performance$1.Event("remove"))}triggerRepaint(){if(this.style&&!this._frameRequest){this._frameRequest=new AbortController;browser.frameAsync(this._frameRequest).then((paintStartTimeStamp=>{performance$1.PerformanceUtils.frame(paintStartTimeStamp);this._frameRequest=null;this._render(paintStartTimeStamp)})).catch((()=>{}))}}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(value){if(this._showTileBoundaries===value)return;this._showTileBoundaries=value;this._update()}get showPadding(){return!!this._showPadding}set showPadding(value){if(this._showPadding===value)return;this._showPadding=value;this._update()}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(value){if(this._showCollisionBoxes===value)return;this._showCollisionBoxes=value;if(value){this.style._generateCollisionBoxes()}else{this._update()}}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(value){if(this._showOverdrawInspector===value)return;this._showOverdrawInspector=value;this._update()}get repaint(){return!!this._repaint}set repaint(value){if(this._repaint!==value){this._repaint=value;this.triggerRepaint()}}get vertices(){return!!this._vertices}set vertices(value){this._vertices=value;this._update()}get version(){return version$1}getCameraTargetElevation(){return this.transform.elevation}};const assignEvents=handler=>{handler.touchstart=handler.dragStart;handler.touchmoveWindow=handler.dragMove;handler.touchend=handler.dragEnd};const generateOneFingerTouchRotationHandler=({enable:enable,clickTolerance:clickTolerance,bearingDegreesPerPixelMoved:bearingDegreesPerPixelMoved=.8})=>{const touchMoveStateManager=new OneFingerTouchMoveStateManager;return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({bearingDelta:(point.x-lastPoint.x)*bearingDegreesPerPixelMoved}),moveStateManager:touchMoveStateManager,enable:enable,assignEvents:assignEvents})};const generateOneFingerTouchPitchHandler=({enable:enable,clickTolerance:clickTolerance,pitchDegreesPerPixelMoved:pitchDegreesPerPixelMoved=-.5})=>{const touchMoveStateManager=new OneFingerTouchMoveStateManager;return new DragHandler({clickTolerance:clickTolerance,move:(lastPoint,point)=>({pitchDelta:(point.y-lastPoint.y)*pitchDegreesPerPixelMoved}),moveStateManager:touchMoveStateManager,enable:enable,assignEvents:assignEvents})};const defaultOptions$3={showCompass:true,showZoom:true,visualizePitch:false};class NavigationControl{constructor(options){this._updateZoomButtons=()=>{const zoom=this._map.getZoom();const isMax=zoom===this._map.getMaxZoom();const isMin=zoom===this._map.getMinZoom();this._zoomInButton.disabled=isMax;this._zoomOutButton.disabled=isMin;this._zoomInButton.setAttribute("aria-disabled",isMax.toString());this._zoomOutButton.setAttribute("aria-disabled",isMin.toString())};this._rotateCompassArrow=()=>{const rotate=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._compassIcon.style.transform=rotate};this._setButtonTitle=(button,title)=>{const str=this._map._getUIString(`NavigationControl.${title}`);button.title=str;button.setAttribute("aria-label",str)};this.options=performance$1.extend({},defaultOptions$3,options);this._container=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-group");this._container.addEventListener("contextmenu",(e=>e.preventDefault()));if(this.options.showZoom){this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",(e=>this._map.zoomIn({},{originalEvent:e})));DOM.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true");this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",(e=>this._map.zoomOut({},{originalEvent:e})));DOM.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")}if(this.options.showCompass){this._compass=this._createButton("maplibregl-ctrl-compass",(e=>{if(this.options.visualizePitch){this._map.resetNorthPitch({},{originalEvent:e})}else{this._map.resetNorth({},{originalEvent:e})}}));this._compassIcon=DOM.create("span","maplibregl-ctrl-icon",this._compass);this._compassIcon.setAttribute("aria-hidden","true")}}onAdd(map){this._map=map;if(this.options.showZoom){this._setButtonTitle(this._zoomInButton,"ZoomIn");this._setButtonTitle(this._zoomOutButton,"ZoomOut");this._map.on("zoom",this._updateZoomButtons);this._updateZoomButtons()}if(this.options.showCompass){this._setButtonTitle(this._compass,"ResetBearing");if(this.options.visualizePitch){this._map.on("pitch",this._rotateCompassArrow)}this._map.on("rotate",this._rotateCompassArrow);this._rotateCompassArrow();this._handler=new MouseRotateWrapper(this._map,this._compass,this.options.visualizePitch)}return this._container}onRemove(){DOM.remove(this._container);if(this.options.showZoom){this._map.off("zoom",this._updateZoomButtons)}if(this.options.showCompass){if(this.options.visualizePitch){this._map.off("pitch",this._rotateCompassArrow)}this._map.off("rotate",this._rotateCompassArrow);this._handler.off();delete this._handler}delete this._map}_createButton(className,fn){const a=DOM.create("button",className,this._container);a.type="button";a.addEventListener("click",fn);return a}}class MouseRotateWrapper{constructor(map,element,pitch=false){this.mousedown=e=>{this.startMouse(performance$1.extend({},e,{ctrlKey:true,preventDefault:()=>e.preventDefault()}),DOM.mousePos(this.element,e));DOM.addEventListener(window,"mousemove",this.mousemove);DOM.addEventListener(window,"mouseup",this.mouseup)};this.mousemove=e=>{this.moveMouse(e,DOM.mousePos(this.element,e))};this.mouseup=e=>{this.mouseRotate.dragEnd(e);if(this.mousePitch)this.mousePitch.dragEnd(e);this.offTemp()};this.touchstart=e=>{if(e.targetTouches.length!==1){this.reset()}else{this._startPos=this._lastPos=DOM.touchPos(this.element,e.targetTouches)[0];this.startTouch(e,this._startPos);DOM.addEventListener(window,"touchmove",this.touchmove,{passive:false});DOM.addEventListener(window,"touchend",this.touchend)}};this.touchmove=e=>{if(e.targetTouches.length!==1){this.reset()}else{this._lastPos=DOM.touchPos(this.element,e.targetTouches)[0];this.moveTouch(e,this._lastPos)}};this.touchend=e=>{if(e.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance){this.element.click()}delete this._startPos;delete this._lastPos;this.offTemp()};this.reset=()=>{this.mouseRotate.reset();if(this.mousePitch)this.mousePitch.reset();this.touchRotate.reset();if(this.touchPitch)this.touchPitch.reset();delete this._startPos;delete this._lastPos;this.offTemp()};this._clickTolerance=10;const mapRotateTolerance=map.dragRotate._mouseRotate.getClickTolerance();const mapPitchTolerance=map.dragRotate._mousePitch.getClickTolerance();this.element=element;this.mouseRotate=generateMouseRotationHandler({clickTolerance:mapRotateTolerance,enable:true});this.touchRotate=generateOneFingerTouchRotationHandler({clickTolerance:mapRotateTolerance,enable:true});this.map=map;if(pitch){this.mousePitch=generateMousePitchHandler({clickTolerance:mapPitchTolerance,enable:true});this.touchPitch=generateOneFingerTouchPitchHandler({clickTolerance:mapPitchTolerance,enable:true})}DOM.addEventListener(element,"mousedown",this.mousedown);DOM.addEventListener(element,"touchstart",this.touchstart,{passive:false});DOM.addEventListener(element,"touchcancel",this.reset)}startMouse(e,point){this.mouseRotate.dragStart(e,point);if(this.mousePitch)this.mousePitch.dragStart(e,point);DOM.disableDrag()}startTouch(e,point){this.touchRotate.dragStart(e,point);if(this.touchPitch)this.touchPitch.dragStart(e,point);DOM.disableDrag()}moveMouse(e,point){const map=this.map;const{bearingDelta:bearingDelta}=this.mouseRotate.dragMove(e,point)||{};if(bearingDelta)map.setBearing(map.getBearing()+bearingDelta);if(this.mousePitch){const{pitchDelta:pitchDelta}=this.mousePitch.dragMove(e,point)||{};if(pitchDelta)map.setPitch(map.getPitch()+pitchDelta)}}moveTouch(e,point){const map=this.map;const{bearingDelta:bearingDelta}=this.touchRotate.dragMove(e,point)||{};if(bearingDelta)map.setBearing(map.getBearing()+bearingDelta);if(this.touchPitch){const{pitchDelta:pitchDelta}=this.touchPitch.dragMove(e,point)||{};if(pitchDelta)map.setPitch(map.getPitch()+pitchDelta)}}off(){const element=this.element;DOM.removeEventListener(element,"mousedown",this.mousedown);DOM.removeEventListener(element,"touchstart",this.touchstart,{passive:false});DOM.removeEventListener(window,"touchmove",this.touchmove,{passive:false});DOM.removeEventListener(window,"touchend",this.touchend);DOM.removeEventListener(element,"touchcancel",this.reset);this.offTemp()}offTemp(){DOM.enableDrag();DOM.removeEventListener(window,"mousemove",this.mousemove);DOM.removeEventListener(window,"mouseup",this.mouseup);DOM.removeEventListener(window,"touchmove",this.touchmove,{passive:false});DOM.removeEventListener(window,"touchend",this.touchend)}}let supportsGeolocation;function checkGeolocationSupport(forceRecalculation=false){return performance$1.__awaiter(this,void 0,void 0,(function*(){if(supportsGeolocation!==undefined&&!forceRecalculation){return supportsGeolocation}if(window.navigator.permissions===undefined){supportsGeolocation=!!window.navigator.geolocation;return supportsGeolocation}try{const permissions=yield window.navigator.permissions.query({name:"geolocation"});supportsGeolocation=permissions.state!=="denied"}catch(_a){supportsGeolocation=!!window.navigator.geolocation}return supportsGeolocation}))}function smartWrap(lngLat,priorPos,transform){const originalLngLat=new performance$1.LngLat(lngLat.lng,lngLat.lat);lngLat=new performance$1.LngLat(lngLat.lng,lngLat.lat);if(priorPos){const left=new performance$1.LngLat(lngLat.lng-360,lngLat.lat);const right=new performance$1.LngLat(lngLat.lng+360,lngLat.lat);const delta=transform.locationPoint(lngLat).distSqr(priorPos);if(transform.locationPoint(left).distSqr(priorPos)<delta){lngLat=left}else if(transform.locationPoint(right).distSqr(priorPos)<delta){lngLat=right}}while(Math.abs(lngLat.lng-transform.center.lng)>180){const pos=transform.locationPoint(lngLat);if(pos.x>=0&&pos.y>=0&&pos.x<=transform.width&&pos.y<=transform.height){break}if(lngLat.lng>transform.center.lng){lngLat.lng-=360}else{lngLat.lng+=360}}if(lngLat.lng!==originalLngLat.lng&&transform.locationPoint(lngLat).y>transform.height/2-transform.getHorizon()){return lngLat}return originalLngLat}const anchorTranslate={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function applyAnchorClass(element,anchor,prefix){const classList=element.classList;for(const key in anchorTranslate){classList.remove(`maplibregl-${prefix}-anchor-${key}`)}classList.add(`maplibregl-${prefix}-anchor-${anchor}`)}class Marker extends performance$1.Evented{constructor(options){super();this._onKeyPress=e=>{const code=e.code;const legacyCode=e.charCode||e.keyCode;if(code==="Space"||code==="Enter"||legacyCode===32||legacyCode===13){this.togglePopup()}};this._onMapClick=e=>{const targetElement=e.originalEvent.target;const element=this._element;if(this._popup&&(targetElement===element||element.contains(targetElement))){this.togglePopup()}};this._update=e=>{if(!this._map)return;const isFullyLoaded=this._map.loaded()&&!this._map.isMoving();if((e===null||e===void 0?void 0:e.type)==="terrain"||(e===null||e===void 0?void 0:e.type)==="render"&&!isFullyLoaded){this._map.once("render",this._update)}if(this._map.transform.renderWorldCopies){this._lngLat=smartWrap(this._lngLat,this._flatPos,this._map.transform)}this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset);if(this._map.terrain){this._flatPos=this._map.transform.locationPoint(this._lngLat)._add(this._offset)}let rotation="";if(this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"){rotation=`rotateZ(${this._rotation}deg)`}else if(this._rotationAlignment==="map"){rotation=`rotateZ(${this._rotation-this._map.getBearing()}deg)`}let pitch="";if(this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"){pitch="rotateX(0deg)"}else if(this._pitchAlignment==="map"){pitch=`rotateX(${this._map.getPitch()}deg)`}if(!e||e.type==="moveend"){this._pos=this._pos.round()}DOM.setTransform(this._element,`${anchorTranslate[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${pitch} ${rotation}`);browser.frameAsync(new AbortController).then((()=>{this._updateOpacity(e&&e.type==="moveend")})).catch((()=>{}))};this._onMove=e=>{if(!this._isDragging){const clickTolerance=this._clickTolerance||this._map._clickTolerance;this._isDragging=e.point.dist(this._pointerdownPos)>=clickTolerance}if(!this._isDragging)return;this._pos=e.point.sub(this._positionDelta);this._lngLat=this._map.unproject(this._pos);this.setLngLat(this._lngLat);this._element.style.pointerEvents="none";if(this._state==="pending"){this._state="active";this.fire(new performance$1.Event("dragstart"))}this.fire(new performance$1.Event("drag"))};this._onUp=()=>{this._element.style.pointerEvents="auto";this._positionDelta=null;this._pointerdownPos=null;this._isDragging=false;this._map.off("mousemove",this._onMove);this._map.off("touchmove",this._onMove);if(this._state==="active"){this.fire(new performance$1.Event("dragend"))}this._state="inactive"};this._addDragHandler=e=>{if(this._element.contains(e.originalEvent.target)){e.preventDefault();this._positionDelta=e.point.sub(this._pos).add(this._offset);this._pointerdownPos=e.point;this._state="pending";this._map.on("mousemove",this._onMove);this._map.on("touchmove",this._onMove);this._map.once("mouseup",this._onUp);this._map.once("touchend",this._onUp)}};this._anchor=options&&options.anchor||"center";this._color=options&&options.color||"#3FB1CE";this._scale=options&&options.scale||1;this._draggable=options&&options.draggable||false;this._clickTolerance=options&&options.clickTolerance||0;this._isDragging=false;this._state="inactive";this._rotation=options&&options.rotation||0;this._rotationAlignment=options&&options.rotationAlignment||"auto";this._pitchAlignment=options&&options.pitchAlignment&&options.pitchAlignment!=="auto"?options.pitchAlignment:this._rotationAlignment;this.setOpacity();this.setOpacity(options===null||options===void 0?void 0:options.opacity,options===null||options===void 0?void 0:options.opacityWhenCovered);if(!options||!options.element){this._defaultMarker=true;this._element=DOM.create("div");this._element.setAttribute("aria-label","Map marker");const svg=DOM.createNS("http://www.w3.org/2000/svg","svg");const defaultHeight=41;const defaultWidth=27;svg.setAttributeNS(null,"display","block");svg.setAttributeNS(null,"height",`${defaultHeight}px`);svg.setAttributeNS(null,"width",`${defaultWidth}px`);svg.setAttributeNS(null,"viewBox",`0 0 ${defaultWidth} ${defaultHeight}`);const markerLarge=DOM.createNS("http://www.w3.org/2000/svg","g");markerLarge.setAttributeNS(null,"stroke","none");markerLarge.setAttributeNS(null,"stroke-width","1");markerLarge.setAttributeNS(null,"fill","none");markerLarge.setAttributeNS(null,"fill-rule","evenodd");const page1=DOM.createNS("http://www.w3.org/2000/svg","g");page1.setAttributeNS(null,"fill-rule","nonzero");const shadow=DOM.createNS("http://www.w3.org/2000/svg","g");shadow.setAttributeNS(null,"transform","translate(3.0, 29.0)");shadow.setAttributeNS(null,"fill","#000000");const ellipses=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const data of ellipses){const ellipse=DOM.createNS("http://www.w3.org/2000/svg","ellipse");ellipse.setAttributeNS(null,"opacity","0.04");ellipse.setAttributeNS(null,"cx","10.5");ellipse.setAttributeNS(null,"cy","5.80029008");ellipse.setAttributeNS(null,"rx",data["rx"]);ellipse.setAttributeNS(null,"ry",data["ry"]);shadow.appendChild(ellipse)}const background=DOM.createNS("http://www.w3.org/2000/svg","g");background.setAttributeNS(null,"fill",this._color);const bgPath=DOM.createNS("http://www.w3.org/2000/svg","path");bgPath.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z");background.appendChild(bgPath);const border=DOM.createNS("http://www.w3.org/2000/svg","g");border.setAttributeNS(null,"opacity","0.25");border.setAttributeNS(null,"fill","#000000");const borderPath=DOM.createNS("http://www.w3.org/2000/svg","path");borderPath.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z");border.appendChild(borderPath);const maki=DOM.createNS("http://www.w3.org/2000/svg","g");maki.setAttributeNS(null,"transform","translate(6.0, 7.0)");maki.setAttributeNS(null,"fill","#FFFFFF");const circleContainer=DOM.createNS("http://www.w3.org/2000/svg","g");circleContainer.setAttributeNS(null,"transform","translate(8.0, 8.0)");const circle1=DOM.createNS("http://www.w3.org/2000/svg","circle");circle1.setAttributeNS(null,"fill","#000000");circle1.setAttributeNS(null,"opacity","0.25");circle1.setAttributeNS(null,"cx","5.5");circle1.setAttributeNS(null,"cy","5.5");circle1.setAttributeNS(null,"r","5.4999962");const circle2=DOM.createNS("http://www.w3.org/2000/svg","circle");circle2.setAttributeNS(null,"fill","#FFFFFF");circle2.setAttributeNS(null,"cx","5.5");circle2.setAttributeNS(null,"cy","5.5");circle2.setAttributeNS(null,"r","5.4999962");circleContainer.appendChild(circle1);circleContainer.appendChild(circle2);page1.appendChild(shadow);page1.appendChild(background);page1.appendChild(border);page1.appendChild(maki);page1.appendChild(circleContainer);svg.appendChild(page1);svg.setAttributeNS(null,"height",`${defaultHeight*this._scale}px`);svg.setAttributeNS(null,"width",`${defaultWidth*this._scale}px`);this._element.appendChild(svg);this._offset=performance$1.Point.convert(options&&options.offset||[0,-14])}else{this._element=options.element;this._offset=performance$1.Point.convert(options&&options.offset||[0,0])}this._element.classList.add("maplibregl-marker");this._element.addEventListener("dragstart",(e=>{e.preventDefault()}));this._element.addEventListener("mousedown",(e=>{e.preventDefault()}));applyAnchorClass(this._element,this._anchor,"marker");if(options&&options.className){for(const name of options.className.split(" ")){this._element.classList.add(name)}}this._popup=null}addTo(map){this.remove();this._map=map;map.getCanvasContainer().appendChild(this._element);map.on("move",this._update);map.on("moveend",this._update);map.on("terrain",this._update);this.setDraggable(this._draggable);this._update();this._map.on("click",this._onMapClick);return this}remove(){if(this._opacityTimeout){clearTimeout(this._opacityTimeout);delete this._opacityTimeout}if(this._map){this._map.off("click",this._onMapClick);this._map.off("move",this._update);this._map.off("moveend",this._update);this._map.off("mousedown",this._addDragHandler);this._map.off("touchstart",this._addDragHandler);this._map.off("mouseup",this._onUp);this._map.off("touchend",this._onUp);this._map.off("mousemove",this._onMove);this._map.off("touchmove",this._onMove);delete this._map}DOM.remove(this._element);if(this._popup)this._popup.remove();return this}getLngLat(){return this._lngLat}setLngLat(lnglat){this._lngLat=performance$1.LngLat.convert(lnglat);this._pos=null;if(this._popup)this._popup.setLngLat(this._lngLat);this._update();return this}getElement(){return this._element}setPopup(popup){if(this._popup){this._popup.remove();this._popup=null;this._element.removeEventListener("keypress",this._onKeyPress);if(!this._originalTabIndex){this._element.removeAttribute("tabindex")}}if(popup){if(!("offset"in popup.options)){const markerHeight=41-5.8/2;const markerRadius=13.5;const linearOffset=Math.abs(markerRadius)/Math.SQRT2;popup.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-markerHeight],"bottom-left":[linearOffset,(markerHeight-markerRadius+linearOffset)*-1],"bottom-right":[-linearOffset,(markerHeight-markerRadius+linearOffset)*-1],left:[markerRadius,(markerHeight-markerRadius)*-1],right:[-markerRadius,(markerHeight-markerRadius)*-1]}:this._offset}this._popup=popup;if(this._lngLat)this._popup.setLngLat(this._lngLat);this._originalTabIndex=this._element.getAttribute("tabindex");if(!this._originalTabIndex){this._element.setAttribute("tabindex","0")}this._element.addEventListener("keypress",this._onKeyPress)}return this}getPopup(){return this._popup}togglePopup(){const popup=this._popup;if(!popup)return this;else if(popup.isOpen())popup.remove();else popup.addTo(this._map);return this}_updateOpacity(force=false){var _a;const terrain=(_a=this._map)===null||_a===void 0?void 0:_a.terrain;if(!terrain){if(this._element.style.opacity!==this._opacity){this._element.style.opacity=this._opacity}return}if(force){this._opacityTimeout=null}else{if(this._opacityTimeout){return}this._opacityTimeout=setTimeout((()=>{this._opacityTimeout=null}),100)}const map=this._map;const terrainDistance=map.terrain.depthAtPoint(this._pos);const elevation=map.terrain.getElevationForLngLatZoom(this._lngLat,map.transform.tileZoom);const markerDistance=map.transform.lngLatToCameraDepth(this._lngLat,elevation);const forgiveness=.006;if(markerDistance-terrainDistance<forgiveness){this._element.style.opacity=this._opacity;return}const metersToCenter=-this._offset.y/map.transform._pixelPerMeter;const elevationToCenter=Math.sin(map.getPitch()*Math.PI/180)*metersToCenter;const terrainDistanceCenter=map.terrain.depthAtPoint(new performance$1.Point(this._pos.x,this._pos.y-this._offset.y));const markerDistanceCenter=map.transform.lngLatToCameraDepth(this._lngLat,elevation+elevationToCenter);const centerIsInvisible=markerDistanceCenter-terrainDistanceCenter>forgiveness;this._element.style.opacity=centerIsInvisible?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(offset){this._offset=performance$1.Point.convert(offset);this._update();return this}addClassName(className){this._element.classList.add(className)}removeClassName(className){this._element.classList.remove(className)}toggleClassName(className){return this._element.classList.toggle(className)}setDraggable(shouldBeDraggable){this._draggable=!!shouldBeDraggable;if(this._map){if(shouldBeDraggable){this._map.on("mousedown",this._addDragHandler);this._map.on("touchstart",this._addDragHandler)}else{this._map.off("mousedown",this._addDragHandler);this._map.off("touchstart",this._addDragHandler)}}return this}isDraggable(){return this._draggable}setRotation(rotation){this._rotation=rotation||0;this._update();return this}getRotation(){return this._rotation}setRotationAlignment(alignment){this._rotationAlignment=alignment||"auto";this._update();return this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(alignment){this._pitchAlignment=alignment&&alignment!=="auto"?alignment:this._rotationAlignment;this._update();return this}getPitchAlignment(){return this._pitchAlignment}setOpacity(opacity,opacityWhenCovered){if(opacity===undefined&&opacityWhenCovered===undefined){this._opacity="1";this._opacityWhenCovered="0.2"}if(opacity!==undefined){this._opacity=opacity}if(opacityWhenCovered!==undefined){this._opacityWhenCovered=opacityWhenCovered}if(this._map){this._updateOpacity(true)}return this}}const defaultOptions$2={positionOptions:{enableHighAccuracy:false,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:false,showAccuracyCircle:true,showUserLocation:true};let numberOfWatches=0;let noTimeout=false;class GeolocateControl extends performance$1.Evented{constructor(options){super();this._onSuccess=position=>{if(!this._map){return}if(this._isOutOfMapMaxBounds(position)){this._setErrorState();this.fire(new performance$1.Event("outofmaxbounds",position));this._updateMarker();this._finish();return}if(this.options.trackUserLocation){this._lastKnownPosition=position;switch(this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK";this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error");this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND";this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error");this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}if(this.options.showUserLocation&&this._watchState!=="OFF"){this._updateMarker(position)}if(!this.options.trackUserLocation||this._watchState==="ACTIVE_LOCK"){this._updateCamera(position)}if(this.options.showUserLocation){this._dotElement.classList.remove("maplibregl-user-location-dot-stale")}this.fire(new performance$1.Event("geolocate",position));this._finish()};this._updateCamera=position=>{const center=new performance$1.LngLat(position.coords.longitude,position.coords.latitude);const radius=position.coords.accuracy;const bearing=this._map.getBearing();const options=performance$1.extend({bearing:bearing},this.options.fitBoundsOptions);const newBounds=LngLatBounds.fromLngLat(center,radius);this._map.fitBounds(newBounds,options,{geolocateSource:true})};this._updateMarker=position=>{if(position){const center=new performance$1.LngLat(position.coords.longitude,position.coords.latitude);this._accuracyCircleMarker.setLngLat(center).addTo(this._map);this._userLocationDotMarker.setLngLat(center).addTo(this._map);this._accuracy=position.coords.accuracy;if(this.options.showUserLocation&&this.options.showAccuracyCircle){this._updateCircleRadius()}}else{this._userLocationDotMarker.remove();this._accuracyCircleMarker.remove()}};this._onZoom=()=>{if(this.options.showUserLocation&&this.options.showAccuracyCircle){this._updateCircleRadius()}};this._onError=error=>{if(!this._map){return}if(this.options.trackUserLocation){if(error.code===1){this._watchState="OFF";this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error");this._geolocateButton.disabled=true;const title=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=title;this._geolocateButton.setAttribute("aria-label",title);if(this._geolocationWatchID!==undefined){this._clearWatch()}}else if(error.code===3&&noTimeout){return}else{this._setErrorState()}}if(this._watchState!=="OFF"&&this.options.showUserLocation){this._dotElement.classList.add("maplibregl-user-location-dot-stale")}this.fire(new performance$1.Event("error",error));this._finish()};this._finish=()=>{if(this._timeoutId){clearTimeout(this._timeoutId)}this._timeoutId=undefined};this._setupUI=supported=>{if(!this._map){return}this._container.addEventListener("contextmenu",(e=>e.preventDefault()));this._geolocateButton=DOM.create("button","maplibregl-ctrl-geolocate",this._container);DOM.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true");this._geolocateButton.type="button";if(supported===false){performance$1.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const title=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=true;this._geolocateButton.title=title;this._geolocateButton.setAttribute("aria-label",title)}else{const title=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.title=title;this._geolocateButton.setAttribute("aria-label",title)}if(this.options.trackUserLocation){this._geolocateButton.setAttribute("aria-pressed","false");this._watchState="OFF"}if(this.options.showUserLocation){this._dotElement=DOM.create("div","maplibregl-user-location-dot");this._userLocationDotMarker=new Marker({element:this._dotElement});this._circleElement=DOM.create("div","maplibregl-user-location-accuracy-circle");this._accuracyCircleMarker=new Marker({element:this._circleElement,pitchAlignment:"map"});if(this.options.trackUserLocation)this._watchState="OFF";this._map.on("zoom",this._onZoom)}this._geolocateButton.addEventListener("click",(()=>this.trigger()));this._setup=true;if(this.options.trackUserLocation){this._map.on("movestart",(event=>{const fromResize=event.originalEvent&&event.originalEvent.type==="resize";if(!event.geolocateSource&&this._watchState==="ACTIVE_LOCK"&&!fromResize){this._watchState="BACKGROUND";this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active");this.fire(new performance$1.Event("trackuserlocationend"))}}))}};this.options=performance$1.extend({},defaultOptions$2,options)}onAdd(map){this._map=map;this._container=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-group");checkGeolocationSupport().then((supported=>this._setupUI(supported)));return this._container}onRemove(){if(this._geolocationWatchID!==undefined){window.navigator.geolocation.clearWatch(this._geolocationWatchID);this._geolocationWatchID=undefined}if(this.options.showUserLocation&&this._userLocationDotMarker){this._userLocationDotMarker.remove()}if(this.options.showAccuracyCircle&&this._accuracyCircleMarker){this._accuracyCircleMarker.remove()}DOM.remove(this._container);this._map.off("zoom",this._onZoom);this._map=undefined;numberOfWatches=0;noTimeout=false}_isOutOfMapMaxBounds(position){const bounds=this._map.getMaxBounds();const coordinates=position.coords;return bounds&&(coordinates.longitude<bounds.getWest()||coordinates.longitude>bounds.getEast()||coordinates.latitude<bounds.getSouth()||coordinates.latitude>bounds.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR";this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active");this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR";this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active");this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR";this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background");this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error");this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const bounds=this._map.getBounds();const southEastPoint=bounds.getSouthEast();const northEastPoint=bounds.getNorthEast();const mapHeightInMeters=southEastPoint.distanceTo(northEastPoint);const mapHeightInPixels=this._map._container.clientHeight;const circleDiameter=Math.ceil(2*(this._accuracy/(mapHeightInMeters/mapHeightInPixels)));this._circleElement.style.width=`${circleDiameter}px`;this._circleElement.style.height=`${circleDiameter}px`}trigger(){if(!this._setup){performance$1.warnOnce("Geolocate control triggered before added to a map");return false}if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE";this.fire(new performance$1.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":numberOfWatches--;noTimeout=false;this._watchState="OFF";this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background");this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error");this.fire(new performance$1.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK";this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background");if(this._lastKnownPosition)this._updateCamera(this._lastKnownPosition);this.fire(new performance$1.Event("trackuserlocationstart"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==undefined){this._clearWatch()}else if(this._geolocationWatchID===undefined){this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");this._geolocateButton.setAttribute("aria-pressed","true");numberOfWatches++;let positionOptions;if(numberOfWatches>1){positionOptions={maximumAge:6e5,timeout:0};noTimeout=true}else{positionOptions=this.options.positionOptions;noTimeout=false}this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,positionOptions)}}else{window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions);this._timeoutId=setTimeout(this._finish,1e4)}return true}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID);this._geolocationWatchID=undefined;this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting");this._geolocateButton.setAttribute("aria-pressed","false");if(this.options.showUserLocation){this._updateMarker(null)}}}const defaultOptions$1={maxWidth:100,unit:"metric"};class ScaleControl{constructor(options){this._onMove=()=>{updateScale(this._map,this._container,this.options)};this.setUnit=unit=>{this.options.unit=unit;updateScale(this._map,this._container,this.options)};this.options=performance$1.extend({},defaultOptions$1,options)}getDefaultPosition(){return"bottom-left"}onAdd(map){this._map=map;this._container=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-scale",map.getContainer());this._map.on("move",this._onMove);this._onMove();return this._container}onRemove(){DOM.remove(this._container);this._map.off("move",this._onMove);this._map=undefined}}function updateScale(map,container,options){const maxWidth=options&&options.maxWidth||100;const y=map._container.clientHeight/2;const left=map.unproject([0,y]);const right=map.unproject([maxWidth,y]);const maxMeters=left.distanceTo(right);if(options&&options.unit==="imperial"){const maxFeet=3.2808*maxMeters;if(maxFeet>5280){const maxMiles=maxFeet/5280;setScale(container,maxWidth,maxMiles,map._getUIString("ScaleControl.Miles"))}else{setScale(container,maxWidth,maxFeet,map._getUIString("ScaleControl.Feet"))}}else if(options&&options.unit==="nautical"){const maxNauticals=maxMeters/1852;setScale(container,maxWidth,maxNauticals,map._getUIString("ScaleControl.NauticalMiles"))}else if(maxMeters>=1e3){setScale(container,maxWidth,maxMeters/1e3,map._getUIString("ScaleControl.Kilometers"))}else{setScale(container,maxWidth,maxMeters,map._getUIString("ScaleControl.Meters"))}}function setScale(container,maxWidth,maxDistance,unit){const distance=getRoundNum(maxDistance);const ratio=distance/maxDistance;container.style.width=`${maxWidth*ratio}px`;container.innerHTML=`${distance}&nbsp;${unit}`}function getDecimalRoundNum(d){const multiplier=Math.pow(10,Math.ceil(-Math.log(d)/Math.LN10));return Math.round(d*multiplier)/multiplier}function getRoundNum(num){const pow10=Math.pow(10,`${Math.floor(num)}`.length-1);let d=num/pow10;d=d>=10?10:d>=5?5:d>=3?3:d>=2?2:d>=1?1:getDecimalRoundNum(d);return pow10*d}class FullscreenControl extends performance$1.Evented{constructor(options={}){super();this._onFullscreenChange=()=>{const fullscreenElement=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;if(fullscreenElement===this._container!==this._fullscreen){this._handleFullscreenChange()}};this._onClickFullscreen=()=>{if(this._isFullscreen()){this._exitFullscreen()}else{this._requestFullscreen()}};this._fullscreen=false;if(options&&options.container){if(options.container instanceof HTMLElement){this._container=options.container}else{performance$1.warnOnce("Full screen control 'container' must be a DOM element.")}}if("onfullscreenchange"in document){this._fullscreenchange="fullscreenchange"}else if("onmozfullscreenchange"in document){this._fullscreenchange="mozfullscreenchange"}else if("onwebkitfullscreenchange"in document){this._fullscreenchange="webkitfullscreenchange"}else if("onmsfullscreenchange"in document){this._fullscreenchange="MSFullscreenChange"}}onAdd(map){this._map=map;if(!this._container)this._container=this._map.getContainer();this._controlContainer=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-group");this._setupUI();return this._controlContainer}onRemove(){DOM.remove(this._controlContainer);this._map=null;window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const button=this._fullscreenButton=DOM.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);DOM.create("span","maplibregl-ctrl-icon",button).setAttribute("aria-hidden","true");button.type="button";this._updateTitle();this._fullscreenButton.addEventListener("click",this._onClickFullscreen);window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const title=this._getTitle();this._fullscreenButton.setAttribute("aria-label",title);this._fullscreenButton.title=title}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen;this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink");this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen");this._updateTitle();if(this._fullscreen){this.fire(new performance$1.Event("fullscreenstart"));this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled();this._map.cooperativeGestures.disable()}else{this.fire(new performance$1.Event("fullscreenend"));if(this._prevCooperativeGesturesEnabled){this._map.cooperativeGestures.enable()}}}_exitFullscreen(){if(window.document.exitFullscreen){window.document.exitFullscreen()}else if(window.document.mozCancelFullScreen){window.document.mozCancelFullScreen()}else if(window.document.msExitFullscreen){window.document.msExitFullscreen()}else if(window.document.webkitCancelFullScreen){window.document.webkitCancelFullScreen()}else{this._togglePseudoFullScreen()}}_requestFullscreen(){if(this._container.requestFullscreen){this._container.requestFullscreen()}else if(this._container.mozRequestFullScreen){this._container.mozRequestFullScreen()}else if(this._container.msRequestFullscreen){this._container.msRequestFullscreen()}else if(this._container.webkitRequestFullscreen){this._container.webkitRequestFullscreen()}else{this._togglePseudoFullScreen()}}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen");this._handleFullscreenChange();this._map.resize()}}class TerrainControl{constructor(options){this._toggleTerrain=()=>{if(this._map.getTerrain()){this._map.setTerrain(null)}else{this._map.setTerrain(this.options)}this._updateTerrainIcon()};this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain");this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled");if(this._map.terrain){this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled");this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")}else{this._terrainButton.classList.add("maplibregl-ctrl-terrain");this._terrainButton.title=this._map._getUIString("TerrainControl.Enable")}};this.options=options}onAdd(map){this._map=map;this._container=DOM.create("div","maplibregl-ctrl maplibregl-ctrl-group");this._terrainButton=DOM.create("button","maplibregl-ctrl-terrain",this._container);DOM.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true");this._terrainButton.type="button";this._terrainButton.addEventListener("click",this._toggleTerrain);this._updateTerrainIcon();this._map.on("terrain",this._updateTerrainIcon);return this._container}onRemove(){DOM.remove(this._container);this._map.off("terrain",this._updateTerrainIcon);this._map=undefined}}const defaultOptions={closeButton:true,closeOnClick:true,focusAfterOpen:true,className:"",maxWidth:"240px"};const focusQuerySelector=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");class Popup extends performance$1.Evented{constructor(options){super();this.remove=()=>{if(this._content){DOM.remove(this._content)}if(this._container){DOM.remove(this._container);delete this._container}if(this._map){this._map.off("move",this._update);this._map.off("move",this._onClose);this._map.off("click",this._onClose);this._map.off("remove",this.remove);this._map.off("mousemove",this._onMouseMove);this._map.off("mouseup",this._onMouseUp);this._map.off("drag",this._onDrag);this._map._canvasContainer.classList.remove("maplibregl-track-pointer");delete this._map}this.fire(new performance$1.Event("close"));return this};this._onMouseUp=event=>{this._update(event.point)};this._onMouseMove=event=>{this._update(event.point)};this._onDrag=event=>{this._update(event.point)};this._update=cursor=>{const hasPosition=this._lngLat||this._trackPointer;if(!this._map||!hasPosition||!this._content){return}if(!this._container){this._container=DOM.create("div","maplibregl-popup",this._map.getContainer());this._tip=DOM.create("div","maplibregl-popup-tip",this._container);this._container.appendChild(this._content);if(this.options.className){for(const name of this.options.className.split(" ")){this._container.classList.add(name)}}if(this._trackPointer){this._container.classList.add("maplibregl-popup-track-pointer")}}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth){this._container.style.maxWidth=this.options.maxWidth}if(this._map.transform.renderWorldCopies&&!this._trackPointer){this._lngLat=smartWrap(this._lngLat,this._flatPos,this._map.transform)}if(this._trackPointer&&!cursor)return;const pos=this._flatPos=this._pos=this._trackPointer&&cursor?cursor:this._map.project(this._lngLat);if(this._map.terrain){this._flatPos=this._trackPointer&&cursor?cursor:this._map.transform.locationPoint(this._lngLat)}let anchor=this.options.anchor;const offset=normalizeOffset(this.options.offset);if(!anchor){const width=this._container.offsetWidth;const height=this._container.offsetHeight;let anchorComponents;if(pos.y+offset.bottom.y<height){anchorComponents=["top"]}else if(pos.y>this._map.transform.height-height){anchorComponents=["bottom"]}else{anchorComponents=[]}if(pos.x<width/2){anchorComponents.push("left")}else if(pos.x>this._map.transform.width-width/2){anchorComponents.push("right")}if(anchorComponents.length===0){anchor="bottom"}else{anchor=anchorComponents.join("-")}}const offsetedPos=pos.add(offset[anchor]).round();DOM.setTransform(this._container,`${anchorTranslate[anchor]} translate(${offsetedPos.x}px,${offsetedPos.y}px)`);applyAnchorClass(this._container,anchor,"popup")};this._onClose=()=>{this.remove()};this.options=performance$1.extend(Object.create(defaultOptions),options)}addTo(map){if(this._map)this.remove();this._map=map;if(this.options.closeOnClick){this._map.on("click",this._onClose)}if(this.options.closeOnMove){this._map.on("move",this._onClose)}this._map.on("remove",this.remove);this._update();this._focusFirstElement();if(this._trackPointer){this._map.on("mousemove",this._onMouseMove);this._map.on("mouseup",this._onMouseUp);if(this._container){this._container.classList.add("maplibregl-popup-track-pointer")}this._map._canvasContainer.classList.add("maplibregl-track-pointer")}else{this._map.on("move",this._update)}this.fire(new performance$1.Event("open"));return this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(lnglat){this._lngLat=performance$1.LngLat.convert(lnglat);this._pos=null;this._trackPointer=false;this._update();if(this._map){this._map.on("move",this._update);this._map.off("mousemove",this._onMouseMove);if(this._container){this._container.classList.remove("maplibregl-popup-track-pointer")}this._map._canvasContainer.classList.remove("maplibregl-track-pointer")}return this}trackPointer(){this._trackPointer=true;this._pos=null;this._update();if(this._map){this._map.off("move",this._update);this._map.on("mousemove",this._onMouseMove);this._map.on("drag",this._onDrag);if(this._container){this._container.classList.add("maplibregl-popup-track-pointer")}this._map._canvasContainer.classList.add("maplibregl-track-pointer")}return this}getElement(){return this._container}setText(text){return this.setDOMContent(document.createTextNode(text))}setHTML(html){const frag=document.createDocumentFragment();const temp=document.createElement("body");let child;temp.innerHTML=html;while(true){child=temp.firstChild;if(!child)break;frag.appendChild(child)}return this.setDOMContent(frag)}getMaxWidth(){var _a;return(_a=this._container)===null||_a===void 0?void 0:_a.style.maxWidth}setMaxWidth(maxWidth){this.options.maxWidth=maxWidth;this._update();return this}setDOMContent(htmlNode){if(this._content){while(this._content.hasChildNodes()){if(this._content.firstChild){this._content.removeChild(this._content.firstChild)}}}else{this._content=DOM.create("div","maplibregl-popup-content",this._container)}this._content.appendChild(htmlNode);this._createCloseButton();this._update();this._focusFirstElement();return this}addClassName(className){if(this._container){this._container.classList.add(className)}}removeClassName(className){if(this._container){this._container.classList.remove(className)}}setOffset(offset){this.options.offset=offset;this._update();return this}toggleClassName(className){if(this._container){return this._container.classList.toggle(className)}}_createCloseButton(){if(this.options.closeButton){this._closeButton=DOM.create("button","maplibregl-popup-close-button",this._content);this._closeButton.type="button";this._closeButton.setAttribute("aria-label","Close popup");this._closeButton.innerHTML="&#215;";this._closeButton.addEventListener("click",this._onClose)}}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const firstFocusable=this._container.querySelector(focusQuerySelector);if(firstFocusable)firstFocusable.focus()}}function normalizeOffset(offset){if(!offset){return normalizeOffset(new performance$1.Point(0,0))}else if(typeof offset==="number"){const cornerOffset=Math.round(Math.abs(offset)/Math.SQRT2);return{center:new performance$1.Point(0,0),top:new performance$1.Point(0,offset),"top-left":new performance$1.Point(cornerOffset,cornerOffset),"top-right":new performance$1.Point(-cornerOffset,cornerOffset),bottom:new performance$1.Point(0,-offset),"bottom-left":new performance$1.Point(cornerOffset,-cornerOffset),"bottom-right":new performance$1.Point(-cornerOffset,-cornerOffset),left:new performance$1.Point(offset,0),right:new performance$1.Point(-offset,0)}}else if(offset instanceof performance$1.Point||Array.isArray(offset)){const convertedOffset=performance$1.Point.convert(offset);return{center:convertedOffset,top:convertedOffset,"top-left":convertedOffset,"top-right":convertedOffset,bottom:convertedOffset,"bottom-left":convertedOffset,"bottom-right":convertedOffset,left:convertedOffset,right:convertedOffset}}else{return{center:performance$1.Point.convert(offset["center"]||[0,0]),top:performance$1.Point.convert(offset["top"]||[0,0]),"top-left":performance$1.Point.convert(offset["top-left"]||[0,0]),"top-right":performance$1.Point.convert(offset["top-right"]||[0,0]),bottom:performance$1.Point.convert(offset["bottom"]||[0,0]),"bottom-left":performance$1.Point.convert(offset["bottom-left"]||[0,0]),"bottom-right":performance$1.Point.convert(offset["bottom-right"]||[0,0]),left:performance$1.Point.convert(offset["left"]||[0,0]),right:performance$1.Point.convert(offset["right"]||[0,0])}}}const version=packageJSON.version;function setRTLTextPlugin(pluginURL,lazy){return rtlMainThreadPluginFactory().setRTLTextPlugin(pluginURL,lazy)}function getRTLTextPluginStatus(){return rtlMainThreadPluginFactory().getRTLTextPluginStatus()}function getVersion(){return version}function getWorkerCount(){return WorkerPool.workerCount}function setWorkerCount(count){WorkerPool.workerCount=count}function getMaxParallelImageRequests(){return performance$1.config.MAX_PARALLEL_IMAGE_REQUESTS}function setMaxParallelImageRequests(numRequests){performance$1.config.MAX_PARALLEL_IMAGE_REQUESTS=numRequests}function getWorkerUrl(){return performance$1.config.WORKER_URL}function setWorkerUrl(value){performance$1.config.WORKER_URL=value}function importScriptInWorkers(workerUrl){return getGlobalDispatcher().broadcast("importScript",workerUrl)}exports.AJAXError=performance$1.AJAXError;exports.Evented=performance$1.Evented;exports.LngLat=performance$1.LngLat;exports.MercatorCoordinate=performance$1.MercatorCoordinate;exports.Point=performance$1.Point;exports.addProtocol=performance$1.addProtocol;exports.config=performance$1.config;exports.removeProtocol=performance$1.removeProtocol;exports.AttributionControl=AttributionControl;exports.BoxZoomHandler=BoxZoomHandler;exports.CanvasSource=CanvasSource;exports.CooperativeGesturesHandler=CooperativeGesturesHandler;exports.DoubleClickZoomHandler=DoubleClickZoomHandler;exports.DragPanHandler=DragPanHandler;exports.DragRotateHandler=DragRotateHandler;exports.EdgeInsets=EdgeInsets;exports.FullscreenControl=FullscreenControl;exports.GeoJSONSource=GeoJSONSource;exports.GeolocateControl=GeolocateControl;exports.Hash=Hash;exports.ImageSource=ImageSource;exports.KeyboardHandler=KeyboardHandler;exports.LngLatBounds=LngLatBounds;exports.LogoControl=LogoControl;exports.Map=Map$1;exports.MapMouseEvent=MapMouseEvent;exports.MapTouchEvent=MapTouchEvent;exports.MapWheelEvent=MapWheelEvent;exports.Marker=Marker;exports.NavigationControl=NavigationControl;exports.Popup=Popup;exports.RasterDEMTileSource=RasterDEMTileSource;exports.RasterTileSource=RasterTileSource;exports.ScaleControl=ScaleControl;exports.ScrollZoomHandler=ScrollZoomHandler;exports.Style=Style;exports.TerrainControl=TerrainControl;exports.TwoFingersTouchPitchHandler=TwoFingersTouchPitchHandler;exports.TwoFingersTouchRotateHandler=TwoFingersTouchRotateHandler;exports.TwoFingersTouchZoomHandler=TwoFingersTouchZoomHandler;exports.TwoFingersTouchZoomRotateHandler=TwoFingersTouchZoomRotateHandler;exports.VectorTileSource=VectorTileSource;exports.VideoSource=VideoSource;exports.addSourceType=addSourceType;exports.clearPrewarmedResources=clearPrewarmedResources;exports.getMaxParallelImageRequests=getMaxParallelImageRequests;exports.getRTLTextPluginStatus=getRTLTextPluginStatus;exports.getVersion=getVersion;exports.getWorkerCount=getWorkerCount;exports.getWorkerUrl=getWorkerUrl;exports.importScriptInWorkers=importScriptInWorkers;exports.prewarm=prewarm;exports.setMaxParallelImageRequests=setMaxParallelImageRequests;exports.setRTLTextPlugin=setRTLTextPlugin;exports.setWorkerCount=setWorkerCount;exports.setWorkerUrl=setWorkerUrl}));var maplibregl$1=maplibregl;return maplibregl$1}));
//# sourceMappingURL=imerss-viz-lib.js.map